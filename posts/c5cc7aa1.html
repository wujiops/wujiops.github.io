<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ansible, Linux Python Shell Devops Kubernetes Hadoop">
    <meta name="description" content="ä»»ä½•å€¼çš„æ‹¥æœ‰çš„éƒ½æ˜¯å€¼å¾—ç­‰å¾…çš„">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>ansible | æ³¢äºšæ–¯</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">æ³¢äºšæ–¯</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/project" class="waves-effect waves-light">
      
      <i class="fas fa-folder-tree" style="zoom: 0.6;"></i>
      
      <span>é¡¹ç›®</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">æ³¢äºšæ–¯</div>
        <div class="logo-desc">
            
            ä»»ä½•å€¼çš„æ‹¥æœ‰çš„éƒ½æ˜¯å€¼å¾—ç­‰å¾…çš„
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
      
        <a href="/" class="waves-effect waves-light">
            
                <i class="fa-fw fas fa-home"></i>
            
            é¦–é¡µ
        </a>
          
        </li>
        
        <li class="m-nav-item">
      
        <a href="/tags" class="waves-effect waves-light">
            
                <i class="fa-fw fas fa-tags"></i>
            
            æ ‡ç­¾
        </a>
          
        </li>
        
        <li class="m-nav-item">
      
        <a href="/categories" class="waves-effect waves-light">
            
                <i class="fa-fw fas fa-bookmark"></i>
            
            åˆ†ç±»
        </a>
          
        </li>
        
        <li class="m-nav-item">
      
        <a href="/project" class="waves-effect waves-light">
            
                <i class="fa-fw fas fa-folder-tree"></i>
            
            é¡¹ç›®
        </a>
          
        </li>
        

    </ul>
</div>


        </div>

    </nav>
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"3F6WTHxhAYXUUJoc",ck:"3F6WTHxhAYXUUJoc",autoTrack:true,hashMode:true})</script>
</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('è¯·è¾“å…¥è®¿é—®æœ¬æ–‡ç« çš„å¯†ç ')).toString(CryptoJS.enc.Hex)) {
                alert('å¯†ç é”™è¯¯ï¼Œå°†è¿”å›ä¸»é¡µï¼');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpeg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ansible</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #3C8FFF;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #3C8FFF;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ansible/">
                                <span class="chip bg-color">ansible</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Server/" class="post-category">
                                Server
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2022-10-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2023-08-15
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    10.1k
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="ansibleç®€ä»‹"><a href="#ansibleç®€ä»‹" class="headerlink" title="ansibleç®€ä»‹"></a>ansibleç®€ä»‹</h1><h2 id="è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯"><a href="#è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯" class="headerlink" title="è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯"></a>è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</h2><blockquote>
<p>æ–‡ä»¶ä¼ è¾“<br>å‘½ä»¤æ‰§è¡Œ</p>
<blockquote>
<p>åº”ç”¨éƒ¨ç½²<br>é…ç½®ç®¡ç†<br>ä»»åŠ¡æµç¼–æ’</p>
</blockquote>
</blockquote>
<h2 id="å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·"><a href="#å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·" class="headerlink" title="å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·"></a>å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·</h2><ol>
<li><p>ansibleï¼šåŸºäºpythonå¼€å‘ï¼Œagentlessä¸€èˆ¬ä¸éœ€è¦ä»£ç†ï¼Œéœ€è¦sshè¿æ¥åŸºäºkeyéªŒè¯æ˜¯åŸºæœ¬ï¼Œä¸­å°å‹åº”ç”¨ç¯å¢ƒï¼ˆä¸»æœºæ•°é‡ &lt; 300 å°ï¼‰</p>
</li>
<li><p>saltstackï¼šåŸºäºpythonå¼€å‘ï¼Œä¸€èˆ¬éœ€éƒ¨ç½²agentï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜</p>
</li>
<li><p>puppetï¼šåŸºäºrubyå¼€å‘ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œé…ç½®å¤æ‚ï¼Œé€‚åˆå¤§å‹ç¯å¢ƒ</p>
</li>
<li><p>fabricã€chefã€cfengineã€funcç­‰</p>
</li>
</ol>
<h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><blockquote>
<p>æ¨¡å—åŒ–ï¼šè°ƒç”¨ç‰¹å®šçš„æ¨¡å—ï¼Œå®Œæˆç‰¹å®šä»»åŠ¡<br>æœ‰Paramikoï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³é”®æ¨¡å—<br>æ”¯æŒè‡ªå®šä¹‰æ¨¡å—<br>åŸºäºPythonè¯­è¨€å®ç°<br>éƒ¨ç½²ç®€å•ï¼ŒåŸºäºpythonå’ŒSSHï¼ˆé»˜è®¤å·²å®‰è£…ï¼‰ï¼Œagentless<br>å®‰å…¨ï¼ŒåŸºäºOpenSSH<br>æ”¯æŒplaybookç¼–æ’ä»»åŠ¡<br>å¹‚ç­‰æ€§ï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ1éå’Œæ‰§è¡Œnéæ•ˆæœä¸€æ ·ï¼Œä¸å› é‡å¤æ‰§è¡Œå¸¦æ¥æ„å¤–æƒ…å†µ<br>æ— éœ€ä»£ç†ä¸ä¾èµ–PKIï¼ˆæ— éœ€sslï¼‰<br>å¯ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€å†™æ¨¡å—<br>YAMLæ ¼å¼ï¼Œç¼–æ’ä»»åŠ¡ï¼Œæ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„<br>è¾ƒå¼ºå¤§çš„å¤šå±‚è§£å†³æ–¹æ¡ˆ</p>
</blockquote>
<h2 id="ansible-playbookï¼ˆå‰§æœ¬ï¼‰æ‰§è¡Œè¿‡ç¨‹ï¼š"><a href="#ansible-playbookï¼ˆå‰§æœ¬ï¼‰æ‰§è¡Œè¿‡ç¨‹ï¼š" class="headerlink" title="ansible-playbookï¼ˆå‰§æœ¬ï¼‰æ‰§è¡Œè¿‡ç¨‹ï¼š"></a>ansible-playbookï¼ˆå‰§æœ¬ï¼‰æ‰§è¡Œè¿‡ç¨‹ï¼š</h2><ol>
<li><p>å°†å·²æœ‰ç¼–æ’å¥½çš„ä»»åŠ¡é›†å†™å…¥ansible-playbook</p>
</li>
<li><p>é€šè¿‡ansible-playbookå‘½ä»¤åˆ†æ‹†ä»»åŠ¡é›†è‡³é€æ¡ansibleå‘½ä»¤ï¼ŒæŒ‰é¢„å®šè§„åˆ™é€æ¡æ‰§è¡Œ</p>
</li>
</ol>
<h2 id="Ansibleä¸»è¦æ“ä½œå¯¹è±¡ï¼š"><a href="#Ansibleä¸»è¦æ“ä½œå¯¹è±¡ï¼š" class="headerlink" title="Ansibleä¸»è¦æ“ä½œå¯¹è±¡ï¼š"></a>Ansibleä¸»è¦æ“ä½œå¯¹è±¡ï¼š</h2><ol>
<li><p>hostsä¸»æœº</p>
</li>
<li><p>NETWORKINGç½‘ç»œè®¾å¤‡</p>
</li>
</ol>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol>
<li><p>æ‰§è¡Œansibleçš„ä¸»æœºä¸€èˆ¬ç§°ä¸ºä¸»æ§ç«¯ï¼Œä¸­æ§ï¼Œmasteræˆ–å ¡å’æœº</p>
</li>
<li><p>ä¸»æ§ç«¯Pythonç‰ˆæœ¬éœ€è¦2.6æˆ–ä»¥ä¸Š</p>
</li>
<li><p>è¢«æ§ç«¯Pythonç‰ˆæœ¬å°äº2.4éœ€è¦å®‰è£…python-simplejson</p>
</li>
<li><p>è¢«æ§ç«¯å¦‚å¼€å¯SELinuxéœ€è¦å®‰è£…libselinux-python</p>
</li>
<li><p>windowsä¸èƒ½åšä¸ºä¸»æ§ç«¯</p>
</li>
</ol>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># rpmåŒ…å®‰è£…:EPELæº</span>
yum <span class="token function">install</span> ansible <span class="token parameter variable">-y</span>

<span class="token comment"># ç¼–è¯‘å®‰è£…:</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> python-jinja2 PyYAML python-paramiko python-babel python-crypto
<span class="token function">tar</span> xf ansible-1.5.4.tar.gz
<span class="token builtin class-name">cd</span> ansible-1.5.4
python setup.py build
python setup.py <span class="token function">install</span>
<span class="token function">mkdir</span> /etc/ansible
cp-r examples/* /etc/ansible

<span class="token comment"># Gitæ–¹å¼:</span>
<span class="token function">git</span> clone git://github.com/ansible/ansible.git <span class="token parameter variable">--recursive</span>
<span class="token builtin class-name">cd</span> ./ansible
<span class="token builtin class-name">source</span> ./hacking/env-setup

<span class="token comment"># pipå®‰è£…:pipæ˜¯å®‰è£…PythonåŒ…çš„ç®¡ç†å™¨ï¼Œç±»ä¼¼yum</span>
yum <span class="token function">install</span> python-pip python-devel
yum <span class="token function">install</span> gcc glibc-devel zibl-devel rpm-bulid openssl-devel
pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip
pip <span class="token function">install</span> ansible <span class="token parameter variable">--upgrade</span>
<span class="token comment"># ç¡®è®¤å®‰è£…:</span>
ansible <span class="token parameter variable">--version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ç›¸å…³æ–‡ä»¶"><a href="#ç›¸å…³æ–‡ä»¶" class="headerlink" title="ç›¸å…³æ–‡ä»¶"></a>ç›¸å…³æ–‡ä»¶</h2><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg   # ä¸»é…ç½®æ–‡ä»¶ï¼Œé…ç½®ansibleå·¥ä½œç‰¹æ€§
&#x2F;etc&#x2F;ansible&#x2F;hosts   # ä¸»æœºæ¸…å•
&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;   # å­˜æ”¾è§’è‰²çš„ç›®å½•<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="ç¨‹åº"><a href="#ç¨‹åº" class="headerlink" title="ç¨‹åº"></a>ç¨‹åº</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;usr&#x2F;bin&#x2F;ansible   # ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·
&#x2F;usr&#x2F;bin&#x2F;ansible-doc   # æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·
&#x2F;usr&#x2F;bin&#x2F;ansible-galaxy   # ä¸‹è½½&#x2F;ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å°
&#x2F;usr&#x2F;bin&#x2F;ansible-playbook   # å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·
&#x2F;usr&#x2F;bin&#x2F;ansible-pull   # è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·
&#x2F;usr&#x2F;bin&#x2F;ansible-vault   # æ–‡ä»¶åŠ å¯†å·¥å…·
&#x2F;usr&#x2F;bin&#x2F;ansible-console   # åŸºäºconsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ä¸»æœºæ¸…å•inventory"><a href="#ä¸»æœºæ¸…å•inventory" class="headerlink" title="ä¸»æœºæ¸…å•inventory"></a>ä¸»æœºæ¸…å•inventory</h2><p>Inventoryä¸»æœºæ¸…å•</p>
<p>ansibleçš„ä¸»è¦åŠŸç”¨åœ¨äºæ‰¹é‡ä¸»æœºæ“ä½œï¼Œä¸ºäº†ä¾¿æ·åœ°ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†ä¸»æœºï¼Œå¯ä»¥åœ¨inventory fileä¸­å°†å…¶åˆ†ç»„å‘½å</p>
<p>é»˜è®¤çš„inventory fileä¸º <code>/etc/ansible/hosts</code> </p>
<p>inventory fileå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡ <code>Dynamic Inventory</code> æ¥åŠ¨æ€ç”Ÿæˆ</p>
<h3 id="etc-ansible-hostsæ–‡ä»¶æ ¼å¼"><a href="#etc-ansible-hostsæ–‡ä»¶æ ¼å¼" class="headerlink" title="/etc/ansible/hostsæ–‡ä»¶æ ¼å¼"></a>/etc/ansible/hostsæ–‡ä»¶æ ¼å¼</h3><p>inventoryæ–‡ä»¶éµå¾ªINIæ–‡ä»¶é£æ ¼ï¼Œä¸­æ‹¬å·ä¸­çš„å­—ç¬¦ä¸ºç»„åã€‚å¯ä»¥å°†åŒä¸€ä¸ªä¸»æœºåŒæ—¶å½’å¹¶åˆ°å¤šä¸ªä¸åŒçš„ç»„ä¸­ï¼›æ­¤å¤–ï¼Œå½“å¦‚è‹¥ç›®æ ‡ä¸»æœºä½¿ç”¨äº†éé»˜è®¤çš„SSHç«¯å£ï¼Œè¿˜å¯ä»¥åœ¨ä¸»æœºåç§°ä¹‹åä½¿ç”¨å†’å·åŠ ç«¯å£å·æ¥æ ‡æ˜</p>
<pre class="line-numbers language-hosts" data-language="hosts"><code class="language-hosts">ntp.magedu.com

[webservers]
www1.magedu.com:2222
www2.magedu.com

[dbservers]
db1.magedu.com
db2.magedu.com
db3.magedu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœä¸»æœºåç§°éµå¾ªç›¸ä¼¼çš„å‘½åæ¨¡å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ—è¡¨çš„æ–¹å¼æ ‡è¯†å„ä¸»æœº</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-hosts" data-language="hosts"><code class="language-hosts">[webservers]
www[01:100].example.com

[dbservers]
db-[a:f].example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ansibleé…ç½®æ–‡ä»¶"><a href="#ansibleé…ç½®æ–‡ä»¶" class="headerlink" title="ansibleé…ç½®æ–‡ä»¶"></a>ansibleé…ç½®æ–‡ä»¶</h2><p>Ansibleé…ç½®æ–‡ä»¶<code>/etc/ansible/ansible.cfg</code> ï¼ˆä¸€èˆ¬ä¿æŒé»˜è®¤ï¼‰</p>
<pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">[defaults]
#inventory &#x3D; &#x2F;etc&#x2F;ansible&#x2F;hosts   # ä¸»æœºåˆ—è¡¨é…ç½®æ–‡ä»¶
#library &#x3D; &#x2F;usr&#x2F;share&#x2F;my_modules&#x2F;   # åº“æ–‡ä»¶å­˜æ”¾ç›®å½•
#remote_tmp &#x3D; $HOME&#x2F;.ansible&#x2F;tmp   # ä¸´æ—¶pyå‘½ä»¤æ–‡ä»¶å­˜æ”¾åœ¨è¿œç¨‹ä¸»æœºç›®å½•
#local_tmp&#x3D; $HOME&#x2F;.ansible&#x2F;tmp   # æœ¬æœºçš„ä¸´æ—¶å‘½ä»¤æ‰§è¡Œç›®å½•
#forks&#x3D; 5   # é»˜è®¤å¹¶å‘æ•°
#sudo_user&#x3D; root   # é»˜è®¤sudoç”¨æˆ·
#ask_sudo_pass &#x3D; True   # æ¯æ¬¡æ‰§è¡Œansibleå‘½ä»¤æ˜¯å¦è¯¢é—®sshå¯†ç 
#ask_pass&#x3D; True
#remote_port&#x3D; 22
#host_key_checking &#x3D; False   # æ£€æŸ¥å¯¹åº”æœåŠ¡å™¨çš„host_keyï¼Œé¦–æ¬¡è¿æ¥ä¸å¿…è¾“å…¥yes&#x2F;no
#log_path&#x3D;&#x2F;var&#x2F;log&#x2F;ansible.log   # æ—¥å¿—æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Ansibleç³»åˆ—å‘½ä»¤"><a href="#Ansibleç³»åˆ—å‘½ä»¤" class="headerlink" title="Ansibleç³»åˆ—å‘½ä»¤"></a>Ansibleç³»åˆ—å‘½ä»¤</h2><p><code>ansible</code>ã€<code>ansible-doc</code>ã€<code>ansible-playbook</code>ã€<code>ansible-vault</code>ã€<code>ansible-console</code>ã€<code>ansible-galaxy</code>ã€<code>ansible-pull</code></p>
<p><code>ansible-doc</code>ï¼šæ˜¾ç¤ºæ¨¡å—å¸®åŠ©</p>
<p><code>ansible-doc [options] [module...]</code></p>
<p><code>-a</code>&emsp;# æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—çš„æ–‡æ¡£</p>
<p><code>-l</code>, <code>--list</code>&emsp;# åˆ—å‡ºå¯ç”¨æ¨¡å—</p>
<p><code>-s</code>, <code>--snippet</code>&emsp;# æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ</p>
<p>ç¤ºä¾‹ï¼š</p>
<p><code>ansible-doc -l</code>   # åˆ—å‡ºæ‰€æœ‰æ¨¡å—</p>
<p><code>ansible-doc ping</code>   # æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•</p>
<p><code>ansible-doc -s ping</code>   # æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•</p>
<p>ansibleé€šè¿‡sshå®ç°é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€ä»»åŠ¡æ‰§è¡Œç­‰åŠŸèƒ½ï¼Œå»ºè®®é…ç½®ansibleç«¯èƒ½åŸºäºå¯†é’¥è®¤è¯çš„æ–¹å¼è”ç³»å„è¢«ç®¡ç†èŠ‚ç‚¹</p>
<p><code>ansible &lt;host-pattern&gt; [-m module_name] [-a args]</code></p>
<p><code>--version</code>   # æ˜¾ç¤ºç‰ˆæœ¬</p>
<p><code>-m module</code>   # æŒ‡å®šæ¨¡å—ï¼Œé»˜è®¤ä¸ºcommand</p>
<p><code>-v</code>   # è¯¦ç»†è¿‡ç¨‹<code>-vv</code> <code>-vvv</code>æ›´è¯¦ç»†</p>
<p><code>--list</code>,<code> --list-hosts</code>   # æ˜¾ç¤ºä¸»æœºåˆ—è¡¨</p>
<p><code>-k</code>, <code>--ask-pass</code>   # æç¤ºè¾“å…¥sshè¿æ¥å¯†ç ï¼Œé»˜è®¤KeyéªŒè¯</p>
<p><code>-K</code>, <code>--ask-become-pass</code>   # æç¤ºè¾“å…¥sudoæ—¶çš„å£ä»¤</p>
<p><code>-C</code>ï¼Œ<code>--check</code>   # æ£€æŸ¥ï¼Œå¹¶ä¸æ‰§è¡Œ</p>
<p><code>-T</code>ï¼Œ<code>--timeout=TIMEOUT</code>   # æ‰§è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤10s</p>
<p><code>-u</code>ï¼Œ<code>--user=REMOTE_USER</code>   # æ‰§è¡Œè¿œç¨‹æ‰§è¡Œçš„ç”¨æˆ·</p>
<p><code>-b</code>,  <code>--become</code>   # ä»£æ›¿æ—§ç‰ˆçš„sudoåˆ‡æ¢</p>
<h1 id="ansibleçš„host-pattern"><a href="#ansibleçš„host-pattern" class="headerlink" title="ansibleçš„host-pattern"></a>ansibleçš„host-pattern</h1><p>åŒ¹é…ä¸»æœºçš„åˆ—è¡¨</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># allï¼šè¡¨ç¤ºæ‰€æœ‰inventoryä¸­çš„æ‰€æœ‰ä¸»æœº</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">ping</span>

<span class="token comment"># *ï¼šé€šé…ç¬¦</span>
ansible <span class="token string">"*"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token number">192.168</span>.182.* <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token string">"*cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>

<span class="token comment"># æˆ–å…³ç³»</span>
ansible <span class="token string">"ab:cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token string">"192.168.182.130:192.168.182.131"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>

<span class="token comment"># é€»è¾‘ä¸</span>
ansible <span class="token string">"ab:&amp;bcd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
<span class="token comment"># åœ¨abç»„å¹¶ä¸”åœ¨bcdç»„ä¸­çš„ä¸»æœº</span>

<span class="token comment"># é€»è¾‘é</span>
ansible <span class="token string">'ab:!bcd'</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
<span class="token comment"># åœ¨abç»„ï¼Œä½†ä¸åœ¨bcdç»„ä¸­çš„ä¸»æœºï¼Œæ³¨æ„æ˜¯å•å¼•å·</span>

<span class="token comment"># ç»¼åˆé€»è¾‘</span>
ansible <span class="token string">'ab:cd:&amp;bcd:!cd'</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>

<span class="token comment"># æ­£åˆ™è¡¨è¾¾å¼</span>
ansible <span class="token string">"ab:&amp;cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span> 
ansible <span class="token string">"~(b|c)d"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"><a href="#ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"></a>ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</h1><ol>
<li><p>åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶é»˜è®¤ <code>/etc/ansible/ansible.cfg</code> </p>
</li>
<li><p>åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚  <code>command</code> </p>
</li>
<li><p>é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨çš„å¯¹åº”æ‰§è¡Œç”¨æˆ·<code>$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶</code></p>
</li>
<li><p>ç»™æ–‡ä»¶+xæ‰§è¡Œ</p>
</li>
<li><p>æ‰§è¡Œå¹¶è¿”å›ç»“æœ</p>
</li>
<li><p>åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œ<code>sleep 0</code>é€€å‡º</p>
</li>
</ol>
<p>æ‰§è¡ŒçŠ¶æ€ï¼ˆåœ¨ansible.cfgé…ç½®æ–‡ä»¶ä¸­[colors]å¯ä»¥æ›´æ”¹ï¼‰ï¼š</p>
<blockquote>
<p><font color=Green>ç»¿è‰²</font>ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”ä¸éœ€è¦åšæ”¹å˜çš„æ“ä½œ<br><font color=Yellow>é»„è‰²</font>ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”å¯¹ç›®æ ‡ä¸»æœºåšå˜æ›´<br><font color=Red>çº¢è‰²</font>ï¼šæ‰§è¡Œå¤±è´¥</p>
</blockquote>
<h1 id="ansibleä½¿ç”¨ç¤ºä¾‹"><a href="#ansibleä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ansibleä½¿ç”¨ç¤ºä¾‹"></a>ansibleä½¿ç”¨ç¤ºä¾‹</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä»¥wangç”¨æˆ·æ‰§è¡Œpingå­˜æ´»æ£€æµ‹</span>
ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-k</span>
<span class="token comment"># ä»¥wang sudoè‡³rootæ‰§è¡Œpingå­˜æ´»æ£€æµ‹</span>
ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span>
<span class="token comment"># ä»¥wang sudoè‡³mageç”¨æˆ·æ‰§è¡Œpingå­˜æ´»æ£€æµ‹</span>
ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span> --become-user mage
<span class="token comment"># ä»¥wang sudoè‡³rootç”¨æˆ·æ‰§è¡Œls</span>
ansible all <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-u</span> wang --become-user<span class="token operator">=</span>root <span class="token parameter variable">-a</span> <span class="token string">'ls /root'</span> <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span> <span class="token parameter variable">-K</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ansibleå¸¸ç”¨æ¨¡å—"><a href="#ansibleå¸¸ç”¨æ¨¡å—" class="headerlink" title="ansibleå¸¸ç”¨æ¨¡å—"></a>ansibleå¸¸ç”¨æ¨¡å—</h2><ol>
<li>commandï¼šåœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œé»˜è®¤æ¨¡å—ï¼Œå¯å¿½ç•¥-mé€‰é¡¹</li>
</ol>
<p><code>ansible ab -m command -a &#39;service vsftpd start&#39;</code> </p>
<p><code>ansible ab -m command -a &#39;echo magedu | passwd --stdin wang&#39;</code> ä¸æˆåŠŸ</p>
<p>æ­¤å‘½ä»¤ä¸æ”¯æŒ<code>$VARNAME</code> <code>&lt;</code> <code>&gt;</code> <code>|</code> <code>;</code> <code>&amp;</code>ç­‰ï¼Œç”¨shellæ¨¡å—å®ç°</p>
<ol start="2">
<li>Shellï¼šå’Œcommandç›¸ä¼¼ï¼Œç”¨shellæ‰§è¡Œå‘½ä»¤</li>
</ol>
<p><code>ansible ab -m shell -a &#39; &#39;</code> </p>
<p>è°ƒç”¨bashæ‰§è¡Œå‘½ä»¤ç±»ä¼¼<code>cat /tmp/stanley.md | awk -F&#39;|&#39; &#39;iprint $1,$2&#125;&#39; &amp;&gt; /tmp/example.txt</code>è¿™äº›å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨shellä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œè§£å†³åŠæ³•ï¼šå†™åˆ°è„šæœ¬æ—¶ï¼Œcopyåˆ°è¿œç¨‹ï¼Œæ‰§è¡Œï¼Œå†æŠŠéœ€è¦çš„ç»“æœæ‹‰å›æ‰§è¡Œå‘½ä»¤çš„æœºå™¨</p>
<ol start="3">
<li>Script: è¿è¡Œè„šæœ¬</li>
</ol>
<p><code>-a &quot;/PATH/TO/SCRIPT_FILE&quot;</code> </p>
<p><code>snsible abc -m script -a f1.sh</code> </p>
<ol start="4">
<li>Copyï¼šä»æœåŠ¡å™¨å¤åˆ¶æ–‡ä»¶åˆ°å®¢æˆ·ç«¯,</li>
</ol>
<p><code>ansible bcd -m copy -a &quot;src=/root/host.sh dest=/data/host.sh owner=wang mode=600 backup=yes&quot;</code></p>
<p>å¦‚ç›®æ ‡å­˜åœ¨ï¼Œé»˜è®¤è¦†ç›–ï¼Œæ­¤å¤„æŒ‡å®šå…ˆå¤‡ä»½(æ³¨æ„ï¼šæ–‡ä»¶æœªæ›´æ”¹åˆ™ä¸ä¼šå¤‡ä»½)</p>
<p><code>ansible 192.168.182.128 -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/f1.txt&quot;</code>åˆ©ç”¨å†…å®¹ï¼Œç›´æ¥ç”Ÿæˆç›®æ ‡æ–‡ä»¶</p>
<ol start="5">
<li>Fetchï¼šä»å®¢æˆ·ç«¯å–æ–‡ä»¶è‡³æœåŠ¡å™¨ç«¯ï¼Œcopyç›¸åï¼Œç›®å½•å¯å…ˆtar</li>
</ol>
<p><code>ansible ab -m fetch -a &#39;src=/root/a.sh dest=/data/scripts&#39;</code></p>
<p><code>ansible bcd -m shell -a &#39;tar JPcf /var/log/log.txz /var/log/*.log&#39;</code></p>
<p><code>ansible bcd -m fetch -a &#39;src=/var/log/log.txz dest=/data&#39;</code></p>
<ol start="6">
<li>Fileï¼šè®¾ç½®æ–‡ä»¶å±æ€§</li>
</ol>
<p><code>ansible bcd -m file -a &quot;path=/root/a.sh owner=wang mode=755&quot;</code></p>
<p><code>ansible bcd -m file -a &#39;src=/etc/fstab dest=/data/fstab state=link&#39;</code></p>
<ol start="7">
<li>Hostnameï¼šç®¡ç†ä¸»æœºå</li>
</ol>
<p><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></p>
<p><code>ansible 192.168.182.128 -m hostname -a &#39;name=node128&#39;</code></p>
<ol start="8">
<li>Cronï¼šè®¡åˆ’ä»»åŠ¡</li>
</ol>
<p>æ”¯æŒæ—¶é—´ï¼š<code>minute </code>, <code>hour</code> , <code>day </code>, <code>month</code> , <code>weekday</code></p>
<p><code>ansible bcd -m cron -a &#39;minute=* weekday=2,4,6 job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>åˆ›å»ºä»»åŠ¡</p>
<p><code>ansible bcd -m cron -a &#39;disabled=true job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>æ³¨é‡Šä»»åŠ¡</p>
<p><code>ansible bcd -m cron -a &#39;disabled=false job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>å–æ¶ˆæ³¨é‡Šä»»åŠ¡ï¼Œtrueã€falseå¯ä»¥è¢«yesã€noæ›¿æ¢</p>
<p><code>ansible bcd -m cron -a &#39;job=&quot;/usr/bin/wall PC warning&quot; name=waring state=absent&#39;</code>åˆ é™¤ä»»åŠ¡</p>
<ol start="9">
<li>Yumï¼šç®¡ç†åŒ…</li>
</ol>
<p><code>ansible all -m yum -a &#39;name=httpd state=latest&#39;</code>å®‰è£…(<code>state=latest</code>å¯çœ)</p>
<p><code>ansible bcd -m yum -a &#39;name=httpd,nginx&#39;</code>å®‰è£…å¤šä¸ª</p>
<p><code>ansible all -m yum -a &#39;name=httpd state=removed&#39;</code>åˆ é™¤</p>
<p><code>ansible all -m yum -a &#39;name=httpd state=absent&#39;</code>åˆ é™¤</p>
<p>å®‰è£…æœ¬åœ°åŒ…ï¼Œå…ˆcopyå†å®‰è£…ï¼Œå¿½ç•¥keyæ£€æŸ¥<code>disable_gpg_check=yes</code></p>
<p><code>ansible bcd -m copy -a &#39;src=/data/vsftpd-3.0.2-22.el8.x86_64.rpm dest/=root/&#39;</code></p>
<p><code>ansible bcd -m yum -a &#39;name=/root/vsftpd-3.0.2-22.el8.x86_64.rpm&#39;</code></p>
<p><code>ansible bcd -m yum -a &#39;name=/root/vsftpd-3.0.2-22.el8.x86_64.rpm disable_gpg_check=yes&#39;</code></p>
<p>æ¸…é™¤ç¼“å­˜å®‰è£…åŒ…</p>
<p><code>ansible bcd -m yum -a &#39;name=dstat update_cache=yes&#39;</code> <code>update_cache=yes</code>ç­‰åŒäº<code>yum clean all</code></p>
<ol start="10">
<li>Serviceï¼šç®¡ç†æœåŠ¡</li>
</ol>
<p><code>ansible bcd -m service -a &#39;name=httpd state=started enabled=yes&#39;</code> <code>enable=yes</code>è®¾ç½®å¼€æœºè‡ªå¯</p>
<p><code>ansible bcd -m service -a &#39;name=httpd state=stopped&#39;</code></p>
<p><code>ansible bcd -m service -a &#39;name=httpd state=started&#39;</code></p>
<p><code>ansible bcd -m service -a &#39;name=httpd state=reloaded&#39;</code></p>
<p><code>ansible bcd -m service -a &#39;name=httpd state=restarted&#39;</code></p>
<ol start="11">
<li>Userï¼šç®¡ç†ç”¨æˆ·</li>
</ol>
<p><code>ansible cd -m user -a &#39;name=nginx shell=/sbin/nologin system=yes home=/var/nginx groups=root,bin uid=80 comment=&quot;nginx service&quot;&#39;</code></p>
<p><code>ansible cd -a &#39;getent passwd nginx&#39;</code></p>
<p><code>ansible cd -m user -a &#39;name=nginx remove=yes state=absent&#39;</code> åˆ é™¤ç”¨æˆ·åŠå®¶ç›®å½•ç­‰æ•°æ®</p>
<p><code>ansible cd -a &#39;getent passwd nginx&#39;</code></p>
<ol start="12">
<li>Groupï¼šç®¡ç†ç»„</li>
</ol>
<p><code>ansible cd -m group -a &#39;name=nginx system=yes gid=80&#39;</code></p>
<p><code>ansible cd -a &#39;getent group nginx&#39;</code></p>
<p><code>ansible cd -m group -a &#39;name=nginx state=absent&#39;</code></p>
<p><code>ansible cd -a &#39;getent group nginx&#39;</code></p>
<p>ansible-galaxy</p>
<p>è¿æ¥<a target="_blank" rel="noopener" href="https://galaxy.ansible.comä¸‹è½½ç›¸åº”çš„roles/">https://galaxy.ansible.comä¸‹è½½ç›¸åº”çš„roles</a></p>
<p><a target="_blank" rel="noopener" href="https://galaxy.ansible.com/search?deprecated=false&amp;keywords=&amp;order_by=-relevance%E6%9F%A5%E6%89%BE%E5%8C%85%E5%9C%B0%E5%9D%80%E3%80%82">https://galaxy.ansible.com/search?deprecated=false&amp;keywords=&amp;order_by=-relevanceæŸ¥æ‰¾åŒ…åœ°å€ã€‚</a></p>
<p><code>ansible-galaxy install geerlingguy.nginx</code> å®‰è£…åˆ«äººçš„galaxy</p>
<p><code>ansible-galaxy list</code> åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„</p>
<p><code>ansible-galaxy list geerlingguy.nginx</code> æŸ¥çœ‹å·²å®‰è£…<code>geerlingguy.nginx</code>çš„ç‰ˆæœ¬</p>
<p><code>cd  /root/.ansible/roles/</code> å®‰è£…åä¼šæç¤ºå®‰è£…çš„ç›®å½•</p>
<p><code>tree .</code> æŸ¥çœ‹ç»“æ„</p>
<p><code>cp geerlingguy.nginx wang.nginx -rp</code> å¤åˆ¶ä¸€ä»½ ä¿®ä¿®æ”¹æ”¹ å½“è‡ªå·±çš„ğŸ˜‹</p>
<p><code>ansible-galaxy list</code> åˆ—å‡ºå·²å®‰è£…çš„å¯ä»¥çœ‹åˆ°å¤šäº†ä¸€ä¸ª<code>wang.nginx</code></p>
<p>åˆ é™¤galaxyï¼Œå¯ä»¥ç›´æ¥åˆ é™¤æ–‡ä»¶å¤¹<code>geerlingguy.nginx</code> <code>wang.nginx</code></p>
<p><code>ansible-galaxy remove geerlingguy.nginx</code> å‘½ä»¤åˆ é™¤</p>
<p><code>ansible-galaxy list</code> åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„</p>
<p><code>rm -fr wang.nginx/</code> ç›´æ¥åˆ é™¤æ–‡ä»¶å¤¹</p>
<p><code>ansible-galaxy list</code> åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„</p>
<h2 id="ansible-pull"><a href="#ansible-pull" class="headerlink" title="ansible-pull"></a>ansible-pull</h2><p>æ¨é€å‘½ä»¤è‡³è¿œç¨‹ï¼Œæ•ˆç‡æ— é™æå‡ï¼Œå¯¹è¿ç»´è¦æ±‚è¾ƒé«˜</p>
<h2 id="Ansible-playbook"><a href="#Ansible-playbook" class="headerlink" title="Ansible-playbook"></a>Ansible-playbook</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#hello world yml file</span>
<span class="token comment">#abcd is 192.168.182.1&#123;28,31&#125;</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> cd
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello world
      <span class="token key atrule">command</span><span class="token punctuation">:</span> /usr/bin/wall hello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook hello.yml</code> æ‰§è¡Œç»“æœå¯ä»¥æ‰“å¼€cã€dæœºå™¨çš„ç»ˆç«¯æŸ¥çœ‹ï¼Œxshellç­‰ã€‚</p>
<h2 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible-vault"></a>Ansible-vault</h2><p>åŠŸèƒ½ï¼šç®¡ç†åŠ å¯†è§£å¯†ymlæ–‡ä»¶</p>
<p><code>ansible-vault [create|decrypt|edit|encrypt|rekey|view]</code></p>
<p><code>ansible-vault encrypt hello.yml</code>   # åŠ å¯†</p>
<p><code>ansible-vault decrypt hello.yml</code>   # è§£å¯†</p>
<p><code>ansible-vault view hello.yml</code>   # æŸ¥çœ‹</p>
<p><code>ansible-vault edit hello.yml</code>   # ç¼–è¾‘åŠ å¯†æ–‡ä»¶</p>
<p><code>ansible-vault rekey hello.yml</code>   # ä¿®æ”¹å£ä»¤</p>
<p><code>ansible-vault create new.yml</code>   # åˆ›å»ºå¸¦å£ä»¤çš„æ–°æ–‡ä»¶</p>
<h2 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h2><p>2.0+æ–°å¢ï¼Œå¯äº¤äº’æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒtab</p>
<p><code>root@test(2)[f:10]$</code></p>
<p><code>æ‰§è¡Œç”¨æˆ·@å½“å‰æ“ä½œçš„ä¸»æœºç»„(å½“å‰ç»„çš„ä¸»æœºæ•°é‡)[f:å¹¶å‘æ•°]$</code></p>
<p>è®¾ç½®å¹¶å‘æ•°: <code>forks n</code> ä¾‹å¦‚ï¼š <code>forks 10</code></p>
<p>åˆ‡æ¢ç»„: <code>cd ä¸»æœºç»„</code> ä¾‹å¦‚: <code>cd web</code></p>
<p>åˆ—å‡ºå½“å‰ç»„ä¸»æœºåˆ—è¡¨ï¼š<code>list</code></p>
<p>åˆ—å‡ºæ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼š<code>?</code> æˆ– <code>help</code></p>
<p>ç¤ºä¾‹:</p>
<p><code>root@all (4)[f:5]$ list</code></p>
<p><code>root@all (4)[f:5]$ cd cd</code></p>
<p><code>root@cd (2)[f:5]$ list</code></p>
<p><code>root@cd (2)[f:5]$ yum name=httpd state=present</code></p>
<p><code>root@cd (2)[f:5]$ service name=httpd state=started</code></p>
<h1 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h1><p>playbookæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªâ€playâ€ç»„æˆçš„åˆ—è¡¨</p>
<p>playçš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†äº‹å…ˆå½’å¹¶ä¸ºä¸€ç»„çš„ä¸»æœºè£…æ‰®æˆäº‹å…ˆé€šè¿‡ansibleä¸­çš„taskå®šä¹‰å¥½çš„è§’è‰²ã€‚ä»æ ¹æœ¬ä¸Šæ¥è®²ï¼Œæ‰€è°“taskæ— éæ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmoduleã€‚å°†å¤šä¸ªplayç»„ç»‡åœ¨ä¸€ä¸ªplaybookä¸­ï¼Œå³å¯ä»¥è®©å®ƒä»¬è”åŒèµ·æ¥æŒ‰äº‹å…ˆç¼–æ’çš„æœºåˆ¶åŒå”±ä¸€å°å¤§æˆ</p>
<p>Playbooké‡‡ç”¨YAMLè¯­è¨€ç¼–å†™</p>
<h2 id="YAMLä»‹ç»"><a href="#YAMLä»‹ç»" class="headerlink" title="YAMLä»‹ç»"></a>YAMLä»‹ç»</h2><p>YAMLæ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜çš„ç”¨æ¥è¡¨è¾¾èµ„æ–™åºåˆ—çš„æ ¼å¼ã€‚YAMLå‚è€ƒäº†å…¶ä»–å¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬:XMLã€Cè¯­è¨€ã€Pythonã€Perlä»¥åŠç”µå­é‚®ä»¶æ ¼å¼RFC2822ç­‰ã€‚Clark Evansåœ¨2001å¹´åœ¨é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€ï¼Œå¦å¤–Ingy dÃ¶t Netä¸Oren Ben-Kikiä¹Ÿæ˜¯è¿™è¯­è¨€çš„å…±åŒè®¾è®¡è€…</p>
<p>YAML Ainâ€™t Markup Languageï¼Œå³YAMLä¸æ˜¯XMLã€‚ä¸è¿‡ï¼Œåœ¨å¼€å‘çš„è¿™ç§è¯­è¨€æ—¶ï¼ŒYAMLçš„æ„æ€å…¶å®æ˜¯:â€Yet Another Markup Languageâ€(ä»æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼‰</p>
<h3 id="ç‰¹æ€§-1"><a href="#ç‰¹æ€§-1" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h3><blockquote>
<p>YAMLçš„å¯è¯»æ€§å¥½<br>YAMLå’Œè„šæœ¬è¯­è¨€çš„äº¤äº’æ€§å¥½<br>YAMLä½¿ç”¨å®ç°è¯­è¨€çš„æ•°æ®ç±»å‹<br>YAMLæœ‰ä¸€ä¸ªä¸€è‡´çš„ä¿¡æ¯æ¨¡å‹<br>YAMLæ˜“äºå®ç°<br>YAMLå¯ä»¥åŸºäºæµæ¥å¤„ç†<br>YAMLè¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ‰©å±•æ€§å¥½</p>
</blockquote>
<p>æ›´å¤šçš„å†…å®¹åŠè§„èŒƒå‚è§<a target="_blank" rel="noopener" href="http://www.yaml.org/">http://www.yaml.org</a></p>
<h3 id="YAMLè¯­æ³•ç®€ä»‹"><a href="#YAMLè¯­æ³•ç®€ä»‹" class="headerlink" title="YAMLè¯­æ³•ç®€ä»‹"></a>YAMLè¯­æ³•ç®€ä»‹</h3><p>åœ¨å•ä¸€æ¡£æ¡ˆä¸­ï¼Œå¯ç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å·<code>---</code>åŒºåˆ†å¤šä¸ªæ¡£æ¡ˆã€‚å¦å¤–ï¼Œè¿˜æœ‰é€‰æ‹©æ€§çš„è¿ç»­ä¸‰ä¸ªç‚¹å·<code>...</code>ç”¨æ¥è¡¨ç¤ºæ¡£æ¡ˆç»“å°¾</p>
<p>æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™Playbookçš„å†…å®¹ï¼Œä¸€èˆ¬å»ºè®®å†™æ˜è¯¥Playbookçš„åŠŸèƒ½</p>
<p>ä½¿ç”¨<code>#</code>å·æ³¨é‡Šä»£ç </p>
<p>ç¼©è¿›å¿…é¡»æ˜¯ç»Ÿä¸€çš„ï¼Œä¸èƒ½ç©ºæ ¼å’Œtabæ··ç”¨</p>
<p>ç¼©è¿›çš„çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œæ¥å®ç°çš„</p>
<p>YAMLæ–‡ä»¶å†…å®¹å’ŒLinuxç³»ç»Ÿå¤§å°å†™åˆ¤æ–­æ–¹å¼ä¿æŒä¸€è‡´ï¼Œæ˜¯åŒºåˆ«å¤§å°å†™çš„ï¼Œk/vçš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿ</p>
<p>k/vçš„å€¼å¯åŒè¡Œå†™ä¹Ÿå¯æ¢è¡Œå†™ã€‚åŒè¡Œä½¿ç”¨<code>:</code>åˆ†éš”</p>
<p>vå¯æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯æ˜¯å¦ä¸€ä¸ªåˆ—è¡¨</p>
<p>ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€æœ€å°‘å…ƒç´ éœ€åŒ…æ‹¬<code>name: task</code></p>
<p>ä¸€ä¸ªnameåªèƒ½åŒ…æ‹¬ä¸€ä¸ªtask</p>
<p>YAMLæ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸ºymlæˆ–yaml</p>
<h3 id="Listï¼šåˆ—è¡¨ï¼Œå…¶æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨-æ‰“å¤´"><a href="#Listï¼šåˆ—è¡¨ï¼Œå…¶æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨-æ‰“å¤´" class="headerlink" title="Listï¼šåˆ—è¡¨ï¼Œå…¶æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨-æ‰“å¤´"></a>Listï¼šåˆ—è¡¨ï¼Œå…¶æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨<code>-</code>æ‰“å¤´</h3><p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#A list of tasty fruits</span>
<span class="token punctuation">-</span> Apple
<span class="token punctuation">-</span> Orange
<span class="token punctuation">-</span> Strawberry
<span class="token punctuation">-</span> Mango<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Dictionaryï¼šå­—å…¸ï¼Œé€šå¸¸ç”±å¤šä¸ªkeyä¸valueæ„æˆ"><a href="#Dictionaryï¼šå­—å…¸ï¼Œé€šå¸¸ç”±å¤šä¸ªkeyä¸valueæ„æˆ" class="headerlink" title="Dictionaryï¼šå­—å…¸ï¼Œé€šå¸¸ç”±å¤šä¸ªkeyä¸valueæ„æˆ"></a>Dictionaryï¼šå­—å…¸ï¼Œé€šå¸¸ç”±å¤šä¸ªkeyä¸valueæ„æˆ</h3><p>ç¤ºä¾‹:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># An employee record</span>

<span class="token key atrule">name</span><span class="token punctuation">:</span> Example Developer
<span class="token key atrule">job</span><span class="token punctuation">:</span> Developer
<span class="token key atrule">skill</span><span class="token punctuation">:</span> Elite<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¹Ÿå¯ä»¥å°†<code>key:value</code>æ”¾ç½®äº<code>&#123;&#125;</code>ä¸­è¿›è¡Œè¡¨ç¤ºï¼Œç”¨<code>,</code>åˆ†éš”å¤šä¸ª<code>key:value</code></p>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># An employee record</span>
<span class="token punctuation">&#123;</span><span class="token key atrule">name</span><span class="token punctuation">:</span> Example Developer<span class="token punctuation">,</span> <span class="token key atrule">job</span><span class="token punctuation">:</span> Developer<span class="token punctuation">,</span> skill<span class="token punctuation">:</span>Elite<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>YAMLçš„è¯­æ³•å’Œå…¶ä»–é«˜é˜¶è¯­è¨€ç±»ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥ç®€å•è¡¨è¾¾æ¸…å•ã€æ•£åˆ—è¡¨ã€æ ‡é‡ç­‰æ•°æ®ç»“æ„ã€‚å…¶ç»“æ„(Structure )é€šè¿‡ç©ºæ ¼æ¥å±•ç¤ºï¼Œåºåˆ—(Sequence )é‡Œçš„é¡¹ç”¨<code>-</code>æ¥ä»£è¡¨ï¼ŒMapé‡Œçš„é”®å€¼å¯¹ç”¨<code>:</code>åˆ†éš”</p>
<p>ç¤ºä¾‹</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> John Smith
<span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">41</span>
<span class="token key atrule">gender</span><span class="token punctuation">:</span> Male
<span class="token key atrule">spouse</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> Jane Smith
  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">37</span>
  <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female
<span class="token key atrule">children</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jimmy Smith
    <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">17</span>
    <span class="token key atrule">gender</span><span class="token punctuation">:</span> Male
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jenny Smith
    <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">13</span>
    <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Playbookæ ¸å¿ƒå…ƒç´ "><a href="#Playbookæ ¸å¿ƒå…ƒç´ " class="headerlink" title="Playbookæ ¸å¿ƒå…ƒç´ "></a>Playbookæ ¸å¿ƒå…ƒç´ </h2><p><code>Hosts</code> æ‰§è¡Œçš„è¿œç¨‹ä¸»æœºåˆ—è¡¨</p>
<p><code>Tasks</code> ä»»åŠ¡é›†</p>
<p><code>Varniables</code> å†…ç½®å˜é‡æˆ–è‡ªå®šä¹‰å˜é‡åœ¨playbookä¸­è°ƒç”¨</p>
<p><code>Templates</code> æ¨¡æ¿ï¼Œå¯æ›¿æ¢æ¨¡æ¿æ–‡ä»¶ä¸­çš„å˜é‡å¹¶å®ç°ä¸€äº›ç®€å•é€»è¾‘çš„æ–‡ä»¶</p>
<p><code>Handlers</code> å’Œ <code>notity</code> ç»“åˆä½¿ç”¨ï¼Œç”±ç‰¹å®šæ¡ä»¶è§¦å‘çš„æ“ä½œï¼Œæ»¡è¶³æ¡ä»¶æ–¹æ‰æ‰§è¡Œï¼Œå¦åˆ™ä¸æ‰§è¡Œ<br><code>tags</code> æ ‡ç­¾ æŒ‡å®šæŸæ¡ä»»åŠ¡æ‰§è¡Œï¼Œç”¨äºé€‰æ‹©è¿è¡Œplaybookä¸­çš„éƒ¨åˆ†ä»£ç ã€‚ansibleå…·æœ‰å¹‚ç­‰æ€§ï¼Œå› æ­¤ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œæœ‰äº›ä»£ç ä¸ºæµ‹è¯•å…¶ç¡®å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ä¾ç„¶ä¼šéå¸¸åœ°é•¿ã€‚æ­¤æ—¶ï¼Œå¦‚æœç¡®ä¿¡å…¶æ²¡æœ‰å˜åŒ–ï¼Œå°±å¯ä»¥é€šè¿‡tagsè·³è¿‡æ­¤äº›ä»£ç ç‰‡æ–­ã€‚</p>
<p><code>ansible-playbook -t tagsname useradd.yml</code> </p>
<h2 id="playbookåŸºç¡€ç»„ä»¶"><a href="#playbookåŸºç¡€ç»„ä»¶" class="headerlink" title="playbookåŸºç¡€ç»„ä»¶"></a>playbookåŸºç¡€ç»„ä»¶</h2><h3 id="Hostsï¼š"><a href="#Hostsï¼š" class="headerlink" title="Hostsï¼š"></a>Hostsï¼š</h3><p>playbookä¸­çš„æ¯ä¸€ä¸ªplayçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è®©æŸä¸ªæˆ–æŸäº›ä¸»æœºä»¥æŸä¸ªæŒ‡å®šçš„ç”¨æˆ·èº«ä»½æ‰§è¡Œä»»åŠ¡ã€‚hostsç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºï¼Œé¡»äº‹å…ˆå®šä¹‰åœ¨ä¸»æœºæ¸…å•ä¸­</p>
<p>å¯ä»¥æ˜¯å¦‚ä¸‹å½¢å¼ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">one.example.com
one.example.com:two.example.com
192.168.1.50
192.168.1.*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Websrvs:dbsrvs</code> ä¸¤ä¸ªç»„çš„å¹¶é›†</p>
<p><code>Websrvs:&amp;dbsrvs</code> ä¸¤ä¸ªç»„çš„äº¤é›†</p>
<p><code>websrvs:!dbsrvs</code> åœ¨websrvsç»„ï¼Œä½†ä¸åœ¨dbsrvsç»„</p>
<p>ç¤ºä¾‹ï¼š</p>
<p><code>- hosts: websrvs:dbsrvs</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> cd
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new file
      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/newfile state=touch
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new user
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=test2 system=yes shell=/sbin/nologin
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy html
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/var/www/html/index.html dest=/var/www/html/
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook -C play.yaml</code>   # æ£€æŸ¥playbook</p>
<h2 id="remote-user"><a href="#remote-user" class="headerlink" title="remote_user"></a>remote_user</h2><p>å¯ç”¨äºHostå’Œtaskä¸­</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡sudoçš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå…¶å¯ç”¨äºplayå…¨å±€æˆ–æŸä»»åŠ¡ï¼›æ­¤å¤–ï¼Œç”šè‡³å¯ä»¥åœ¨sudoæ—¶ä½¿ç”¨sudo_useræŒ‡å®šsudoæ—¶åˆ‡æ¢çš„ç”¨æˆ·</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test connection
      <span class="token key atrule">ping</span><span class="token punctuation">:</span>
      <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> magedu
      <span class="token key atrule">sudo</span><span class="token punctuation">:</span> yes   é»˜è®¤sudoä¸ºroot
      <span class="token key atrule">sudo_user</span><span class="token punctuation">:</span> wang   sudoä¸ºwang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="task-åˆ—è¡¨å’Œ-action"><a href="#task-åˆ—è¡¨å’Œ-action" class="headerlink" title="task åˆ—è¡¨å’Œ action"></a>task åˆ—è¡¨å’Œ action</h2><p>playçš„ä¸»ä½“éƒ¨åˆ†æ˜¯task list</p>
<p>task listä¸­çš„å„ä»»åŠ¡æŒ‰æ¬¡åºé€ä¸ªåœ¨hostsä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼Œå³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡åå†å¼€å§‹ç¬¬äºŒä¸ªã€‚åœ¨è¿è¡Œè‡ªä¸‹è€Œä¸‹æŸplaybookæ—¶ï¼Œå¦‚æœä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œæ‰€æœ‰å·²æ‰§è¡Œä»»åŠ¡éƒ½å°†å›æ»šï¼Œå› æ­¤ï¼Œåœ¨æ›´æ­£playbookåé‡æ–°æ‰§è¡Œä¸€æ¬¡å³å¯</p>
<p>taskçš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ã€‚æ¨¡å—æ‰§è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´</p>
<p>æ¯ä¸ªtaskéƒ½åº”è¯¥æœ‰å…¶nameï¼Œç”¨äºplaybookçš„æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå»ºè®®å…¶å†…å®¹å°½å¯èƒ½æ¸…æ™°åœ°æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ã€‚å¦‚æœæœªæä¾›nameï¼Œåˆ™actionçš„ç»“æœå°†ç”¨äºè¾“å‡º</p>
<h3 id="tasksï¼šä»»åŠ¡åˆ—è¡¨"><a href="#tasksï¼šä»»åŠ¡åˆ—è¡¨" class="headerlink" title="tasksï¼šä»»åŠ¡åˆ—è¡¨"></a>tasksï¼šä»»åŠ¡åˆ—è¡¨</h3><p>æ ¼å¼ï¼š</p>
<p>(1) <code>action: module arguments</code></p>
<p>(2) <code>module: arguments</code>   å»ºè®®ä½¿ç”¨</p>
<p>æ³¨æ„ï¼š <code>shell</code> å’Œ <code>command</code> æ¨¡å—åé¢è·Ÿå‘½ä»¤ï¼Œè€Œé<code>key=value</code></p>
<p>æŸä»»åŠ¡çš„çŠ¶æ€åœ¨è¿è¡Œåä¸ºchangedæ—¶ï¼Œå¯é€šè¿‡â€notifyâ€é€šçŸ¥ç»™ç›¸åº”çš„handlers</p>
<p>ä»»åŠ¡å¯ä»¥é€šè¿‡â€tagsâ€æ‰“æ ‡ç­¾ï¼Œè€Œåå¯åœ¨<code>ansible-playbook</code>å‘½ä»¤ä¸Šä½¿ç”¨<code>-t</code>æŒ‡å®šè¿›è¡Œè°ƒç”¨</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> disable selinux
    <span class="token key atrule">command</span><span class="token punctuation">:</span> /sbin/setenforce 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœå‘½ä»¤æˆ–è„šæœ¬çš„é€€å‡ºç ä¸ä¸ºé›¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ›¿ä»£</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run this command and ignore the result
    <span class="token key atrule">shell</span><span class="token punctuation">:</span> /usr/bin/somecommand <span class="token punctuation">|</span><span class="token punctuation">|</span> /bin/true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æˆ–è€…ä½¿ç”¨ignore_errorsæ¥å¿½ç•¥é”™è¯¯ä¿¡æ¯ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run this command and ignore the result
    <span class="token key atrule">shell</span><span class="token punctuation">:</span> /usr/bin/somecommand
    <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token boolean important">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è¿è¡Œplaybook"><a href="#è¿è¡Œplaybook" class="headerlink" title="è¿è¡Œplaybook"></a>è¿è¡Œplaybook</h2><p>è¿è¡Œplaybookçš„æ–¹å¼</p>
<p><code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p>
<p>å¸¸è§é€‰é¡¹</p>
<p><code>--check</code>   åªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ</p>
<p><code>--list-hosts</code>   åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº</p>
<p><code>--limit</code>   ä¸»æœº/åˆ—è¡¨ åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„ä¸»æœºæ‰§è¡Œ</p>
<p><code>-v</code>   æ˜¾ç¤ºè¿‡ç¨‹<code>-vv</code> <code>-vvv</code>æ›´è¯¦ç»†</p>
<p>ç¤ºä¾‹</p>
<p><code>ansible-playbook file.yml --check</code>   åªæ£€æµ‹</p>
<p><code>ansible-playbook file.yml --list</code></p>
<p><code>ansible-playbook file.yml --list-tasks</code></p>
<p><code>ansible-playbook file.yml --limit websrvs</code></p>
<p><code>ansible-playbook file.yml --list-tags</code></p>
<p>Playbook VS ShellScripts</p>
<p>SHELLè„šæœ¬</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#å®‰è£…Apache</span>
yum <span class="token function">install</span> <span class="token parameter variable">--quiet</span> <span class="token parameter variable">-y</span> httpd
<span class="token comment">#å¤åˆ¶é…ç½®æ–‡ä»¶</span>
<span class="token function">cp</span> /tmp/httpd.conf /etc/httpd/conf/httpd.conf
<span class="token function">cp</span> /tmp/vhosts.conf /etc/httpd/confd/
<span class="token comment">#å¯åŠ¨Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨</span>
<span class="token function">service</span> httpd start
<span class="token function">chkconfig</span> httpd on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Playbookå®šä¹‰</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"å®‰è£…Apache"</span>
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"å¤åˆ¶é…ç½®æ–‡ä»¶"</span>
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/tmp/httpd.conf dest=/etc/httpd/conf/
<span class="token comment">#      copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/   æ³¨æ„å¦‚æœç›¸åŒçš„æ¨¡å—ï¼Œä¸èƒ½æ”¾åœ¨ä¸€å—ï¼Œå¦åˆ™åªä¼šæ‰§è¡Œæœ€åä¸€ä¸ª</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"å¤åˆ¶é…ç½®æ–‡ä»¶"</span> 
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"å¯åŠ¨Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨"</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼šsysuser.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
    <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  

    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create mysql user
        <span class="token key atrule">user</span><span class="token punctuation">:</span> name=mysql system=yes uid=36
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create a group
        <span class="token key atrule">group</span><span class="token punctuation">:</span> name=httpd system=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼šhttpd.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file
        <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=$HOME/httpd.conf dest=/etc/httpd/conf/   <span class="token comment"># srcç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹äºå½“å‰ç›®å½•ã€‚å¦‚æœä¿®æ”¹è¿œç«¯æ–‡ä»¶ï¼Œç›´æ¥ä¿®æ”¹æœ¬åœ°æ–‡ä»¶ï¼Œå†æ¬¡æ‰§è¡Œplaybookä¼šè¦†ç›–è¿œç«¯çš„æ–‡ä»¶ã€‚</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service
        <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶"><a href="#handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶" class="headerlink" title="handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶"></a>handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶</h1><p>Handlersï¼ˆè§¦å‘å™¨å’Œtaskæ˜¯å¹¶åˆ—å…³ç³»ï¼‰</p>
<p>æ˜¯taskåˆ—è¡¨ï¼Œè¿™äº›taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œ</p>
<p>Notifyï¼ˆé€šçŸ¥ï¼‰</p>
<p>æ­¤actionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆæœ€åä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerï¼Œä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf file
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/etc/httpd/conf/ backup=yes
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service   <span class="token comment"># notifyå†…å®¹å’Œhandlesä¸­- name:å†…å®¹ä¿æŒä¸€è‡´ï¼Œæ‰ä¼šè§¦å‘ã€‚</span>
  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted
    <span class="token comment"># è¿™é‡Œå¯ä»¥å¤šä¸ª - name:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add group nginx
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> user
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx state=present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user nginx
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx state=present group=nginx
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx state=present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/config.txt dest=/etc/nginx/nginx.conf
      <span class="token key atrule">notify</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Restart Nginx
        <span class="token punctuation">-</span> Check Nginx Process
  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Restart Nginx
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted enabled=yes
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check Nginx process
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> killall <span class="token punctuation">-</span>0 nginx <span class="token punctuation">></span> /tmp/nginx.log
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Playbookä¸­tagsä½¿ç”¨"><a href="#Playbookä¸­tagsä½¿ç”¨" class="headerlink" title="Playbookä¸­tagsä½¿ç”¨"></a>Playbookä¸­tagsä½¿ç”¨</h1><p>ç¤ºä¾‹: <code>httpd.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install httpd
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> inshttp
      <span class="token comment"># tags: http</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf file
      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/etc/httpd/conf/ backup=yes
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start httpd
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> rshttp
      <span class="token comment"># tags: http</span>
  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted
<span class="token comment"># å…¶ä¸­å¤šä¸ªåŠ¨ä½œå¯ä»¥ä½¿ç”¨ç›¸åŒåç§°çš„tagsï¼Œå³ä¸€ä¸ªtagså¯ä»¥æŒ‡å®šå¤šä¸ªåŠ¨ä½œã€‚</span>
<span class="token comment"># è¿è¡Œæ—¶æŒ‡å®šæ ‡ç­¾åå³å¯ï¼Œé€—å·ä¸ºåˆ†éš”ç¬¦ã€‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible 192.168.182.131 -m service -a &quot;name=httpd state=stopped&quot;</code> </p>
<p><code>ansible-playbook -t rshttp httpd.yml</code> or <code>ansible-playbook -t inshttp,rehttp httpd.yml</code> </p>
<p><code>ansible 192.168.182.131 -m shell -a &quot;ss -anptl|grep :8080&quot;</code> </p>
<p><code>ansible-playbook 131httpconf.yaml --list-tags</code>   # åˆ—å‡ºyamlæ–‡ä»¶ä¸­çš„tags</p>
<h1 id="Playbookä¸­å˜é‡ä½¿ç”¨"><a href="#Playbookä¸­å˜é‡ä½¿ç”¨" class="headerlink" title="Playbookä¸­å˜é‡ä½¿ç”¨"></a>Playbookä¸­å˜é‡ä½¿ç”¨</h1><p>å˜é‡åï¼šä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´</p>
<p>å˜é‡æ¥æºï¼š</p>
<ol>
<li><p><code>ansible setup facts</code> è¿œç¨‹ä¸»æœºçš„æ‰€æœ‰å˜é‡éƒ½å¯ç›´æ¥è°ƒç”¨</p>
</li>
<li><p>åœ¨ <code>/etc/ansible/hosts</code> ä¸­å®šä¹‰</p>
</li>
</ol>
<p>æ™®é€šå˜é‡ï¼šä¸»æœºç»„ä¸­ä¸»æœºå•ç‹¬å®šä¹‰ï¼Œä¼˜å…ˆçº§é«˜äºå…¬å…±å˜é‡</p>
<p>å…¬å…±ï¼ˆç»„ï¼‰å˜é‡ï¼šé’ˆå¯¹ä¸»æœºç»„ä¸­æ‰€æœ‰ä¸»æœºå®šä¹‰ç»Ÿä¸€å˜é‡</p>
<ol start="3">
<li>é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜</li>
</ol>
<p><code>ansible-playbook -e varname=value</code> </p>
<ol start="4">
<li>åœ¨playbookä¸­å®šä¹‰</li>
</ol>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">vars:

- var1: value1
- var2: value2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>åœ¨roleä¸­å®šä¹‰</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#httpd.yaml</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=started enabled=true
<span class="token comment"># å®‰è£…è½¯ä»¶ å¹¶ å¯åŠ¨ï¼Œæ³¨æ„åŒ…åå’ŒæœåŠ¡å å¯èƒ½ä¸ä¸€æ ·ã€‚</span>

<span class="token comment">#app.yaml</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package1
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package2
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å˜é‡èµ‹å€¼ä¸ºhttpd</p>
<p><code>ansible-playbook -e &#39;pkname=httpd&#39; httpd.yaml</code> </p>
<p>å˜é‡èµ‹å€¼ä¸ºhttpd,nginxï¼Œyumå¯ä»¥åŒæ—¶å®‰è£…å¤šä¸ªåŒ…</p>
<p><code>ansible-playbook -e &#39;pkname1=httpd,nginx&#39; bianliang.yaml</code> </p>
<p>å¤šä¸ªå˜é‡èµ‹å€¼ï¼Œç”¨ç©ºæ ¼éš”å¼€</p>
<p><code>ansible-playbook -e &#39;pkname1=httpd pkname2=nginx&#39; bianliang.yaml</code> </p>
<p>æŸ¥è¯¢å®‰è£…çš„åŒ…</p>
<p><code>ansible 192.168.182.131 -m shell -a &quot;rpm -qa|grep -E &#39;httpd|nginx&#39;&quot;</code> </p>
<p>å¸è½½å®‰è£…çš„åŒ…ï¼ŒåŒæ ·nameå¯ä»¥å°†httpdå’ŒnginxåŒæ—¶åˆ æ‰ï¼ˆabsent=removedï¼‰</p>
<p><code>ansible 192.168.182.131 -m yum -a &#39;name=httpd,nginx state=absent&#39;</code> </p>
<p>åœ¨playbooké‡Œé¢å®šä¹‰å˜é‡</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">pkname1</span><span class="token punctuation">:</span> httpd
    <span class="token punctuation">-</span> <span class="token key atrule">pkname2</span><span class="token punctuation">:</span> nginx

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package1
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package2
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook app.yaml</code> </p>
<p>åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡<code>/etc/ansible/hosts</code> </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>webs<span class="token punctuation">]</span>
<span class="token number">192.168</span>.1.107 <span class="token assign-left variable">na</span><span class="token operator">=</span><span class="token number">107</span>
<span class="token number">192.168</span>.1.108 <span class="token assign-left variable">na</span><span class="token operator">=</span><span class="token number">108</span>
<span class="token comment"># å…¶ä¸­[webs]ä¸»æœºæ¸…å•ä¸­ï¼Œåœ¨æ¯ä¸ªä¸»æœºåé¢å¯ä»¥å¯¹æ¯ä¸ªä¸»æœºè®¾ç½®å•ä¸€å˜é‡ï¼Œä¼˜å…ˆçº§é«˜äº é€šç”¨ å˜é‡</span>

<span class="token punctuation">[</span>webs:vars<span class="token punctuation">]</span>
<span class="token assign-left variable">a</span><span class="token operator">=</span>node
<span class="token assign-left variable">z</span><span class="token operator">=</span>centos7.com
<span class="token comment"># å¯¹websä¸»æœºç»„ä¸­æ‰€æœ‰çš„ä¸»æœºè®¾ç½®çš„ é€šç”¨/å…¬å…± å˜é‡</span>

<span class="token comment"># ä¸€èˆ¬çš„è§„åˆ™ï¼šå‘½ä»¤è¡Œ-e é…ç½®çš„å˜é‡ ä¼˜å…ˆçº§é«˜äº ä¸Šé¢ä¸¤ç§å®šä¹‰å˜é‡æ–¹å¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å˜é‡å‘½å"><a href="#å˜é‡å‘½å" class="headerlink" title="å˜é‡å‘½å"></a>å˜é‡å‘½å</h2><p>å˜é‡åä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´</p>
<p>å˜é‡å®šä¹‰ï¼š<code>key=value</code> </p>
<p>ç¤ºä¾‹ï¼š<code>http_port=80</code> </p>
<p>å˜é‡è°ƒç”¨æ–¹å¼:</p>
<p>é€šè¿‡ <code>&#123;&#123; variable_name &#125;&#125;</code> è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå¿…é¡»æœ‰ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨ <code>&quot;&#123;&#123; variable_name &#125;&#125;&quot;</code> æ‰ç”Ÿæ•ˆ</p>
<p><code>ansible-playbook -e</code> é€‰é¡¹æŒ‡å®š</p>
<p><code>ansible-playbook test.yml -e &quot;hosts=www user=mageedu&quot;</code> </p>
<h2 id="ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå˜é‡-setupæ¨¡å—"><a href="#ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå˜é‡-setupæ¨¡å—" class="headerlink" title="ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå˜é‡(setupæ¨¡å—)"></a>ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå˜é‡(setupæ¨¡å—)</h2><p><code>ansible web -m setup</code>   æŸ¥çœ‹setupæ¨¡å—ä¸­å®šä¹‰çš„å˜é‡</p>
<p><code>&quot;ansible_user_uid&quot;</code>   å˜é‡åç±»ä¼¼äºè¿™æ ·</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=wang groups=wheel comment="haha wang"
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create file
      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/opt/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_fqdn <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch mode=600 owner=wang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible web -m shell -a &quot;ls /data -l&quot;</code> </p>
<p>åœ¨ <code>vars.yaml</code> æ–‡ä»¶ä¸­å®šä¹‰å˜é‡</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">var1</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">var2</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">var3</span><span class="token punctuation">:</span> haha<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> vars.yaml

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create file
      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var3 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook test.yaml</code>   è¿è¡Œplaybookæ–‡ä»¶</p>
<p><code>ansible web -m shell -a &quot;ls /data -l&quot;</code>   æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
<p>å˜é‡åä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´å˜é‡å®šä¹‰: <code>key=value</code></p>
<p>ç¤ºä¾‹: <code>http_port=80</code></p>
<p>å˜é‡è°ƒç”¨æ–¹å¼ï¼š</p>
<p>é€šè¿‡<code>&#123;&#123; variable_name &#125;&#125;</code>è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå¿…é¡»æœ‰ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨<code>&quot;&#123;&#123; variable_name &#125;&#125;&quot;</code>æ‰ç”Ÿæ•ˆ</p>
<p><code>ansible-playbook -e</code> é€‰é¡¹æŒ‡å®š</p>
<p><code>ansible-playbook test.yml -e &quot;hosts=www user=magedu&quot;</code></p>
<p>ç¤ºä¾‹ï¼šå˜é‡</p>
<p>ç¤ºä¾‹ï¼švar.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook -e pkname=httpd var.yml</code> </p>
<p>ç¤ºä¾‹ï¼šä½¿ç”¨setupå˜é‡</p>
<p>ç¤ºä¾‹ï¼švar.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create log file
      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/var/log/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_fqdn <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook var.yml</code></p>
<p>ç¤ºä¾‹ï¼šå˜é‡<br>ç¤ºä¾‹: var.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">username</span><span class="token punctuation">:</span> user1
    <span class="token punctuation">-</span> <span class="token key atrule">groupname</span><span class="token punctuation">:</span> group1

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create group
      <span class="token key atrule">group</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> groupname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user
       <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook var.yml</code><br><code>ansible-playbook -e &quot;username=user2 groupname=group2&quot; var2.yml</code> </p>
<h2 id="ä¸»æœºå˜é‡"><a href="#ä¸»æœºå˜é‡" class="headerlink" title="ä¸»æœºå˜é‡"></a>ä¸»æœºå˜é‡</h2><p>å¯ä»¥åœ¨inventoryä¸­å®šä¹‰ä¸»æœºæ—¶ä¸ºå…¶æ·»åŠ ä¸»æœºå˜é‡ä»¥ä¾¿äºåœ¨playbookä¸­ä½¿ç”¨</p>
<p>ç¤ºä¾‹:</p>
<pre class="line-numbers language-none"><code class="language-none">[websrvs]
www1.magedu.com http_port&#x3D;80 maxRequestsPerChild&#x3D;808
www2.magedu.com http_port&#x3D;8080 maxRequestsPerChild&#x3D;909<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="ç»„å˜é‡"><a href="#ç»„å˜é‡" class="headerlink" title="ç»„å˜é‡"></a>ç»„å˜é‡</h2><p>ç»„å˜é‡æ˜¯æŒ‡èµ‹äºˆç»™æŒ‡å®šç»„å†…æ‰€æœ‰ä¸»æœºä¸Šçš„åœ¨playbookä¸­å¯ç”¨çš„å˜é‡ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">[websrvs]
www1.magedu.com
www2.magedu.com

[websrvs:vars]
ntp_server&#x3D;ntp.magedu.com
nfs_server&#x3D;nfs.magedu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="æ™®é€šå˜é‡"><a href="#æ™®é€šå˜é‡" class="headerlink" title="æ™®é€šå˜é‡"></a>æ™®é€šå˜é‡</h2><pre class="line-numbers language-none"><code class="language-none">[websrvs]
192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1
192.168.99.102 http_port&#x3D;80 hname&#x3D;www2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="å…¬å…±ï¼ˆç»„ï¼‰å˜é‡"><a href="#å…¬å…±ï¼ˆç»„ï¼‰å˜é‡" class="headerlink" title="å…¬å…±ï¼ˆç»„ï¼‰å˜é‡"></a>å…¬å…±ï¼ˆç»„ï¼‰å˜é‡</h2><pre class="line-numbers language-none"><code class="language-none">[websvrs:vars]
http_port&#x3D;808
mark&#x3D; &quot;_&quot;
[websrvs]
192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1
192.168.99.102 http_port&#x3D;80 hname&#x3D;www2
ansible websvrs -m hostname -a &#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š"><a href="#å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š" class="headerlink" title="å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š"></a>å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ansible websvrs <span class="token parameter variable">-e</span> <span class="token assign-left variable">http_port</span><span class="token operator">=</span><span class="token number">8000</span> <span class="token parameter variable">-m</span> <span class="token function">hostname</span> <span class="token parameter variable">-a</span> <span class="token string">'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="ä½¿ç”¨å˜é‡æ–‡ä»¶"><a href="#ä½¿ç”¨å˜é‡æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨å˜é‡æ–‡ä»¶"></a>ä½¿ç”¨å˜é‡æ–‡ä»¶</h2><p>cat vars.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">var1</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">var2</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>cat var.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> vars.yml
  

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create httpd log
      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/app/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create nginx log
       <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/app/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¨¡æ¿<code>templates</code>ä¸èƒ½åœ¨å‘½ä»¤è¡Œä½¿ç”¨</p>
<p>æ–‡æœ¬æ–‡ä»¶ï¼ŒåµŒå¥—æœ‰è„šæœ¬ï¼ˆä½¿ç”¨æ¨¡æ¿ç¼–ç¨‹è¯­è¨€ç¼–å†™)</p>
<p>Jinja2è¯­è¨€ï¼Œä½¿ç”¨å­—é¢é‡ï¼Œæœ‰ä¸‹é¢å½¢å¼</p>
<p>å­—ç¬¦ä¸²ï¼šä½¿ç”¨å•å¼•å·æˆ–åŒå¼•å·</p>
<p>æ•°å­—ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°</p>
<p>åˆ—è¡¨ï¼š<code>[item1, item2,...]</code></p>
<p>å…ƒç»„ï¼š<code>(item1, item2,...)</code></p>
<p>å­—å…¸ï¼š<code>&#123;key1:value1, key2:value2,..&#125;</code></p>
<p>å¸ƒå°”å‹ï¼š<code>true/false</code></p>
<p>ç®—æœ¯è¿ç®—ï¼š<code>+, -, *, /, //, %, **</code></p>
<p>æ¯”è¾ƒæ“ä½œï¼š<code>==, !=, &gt;, &gt;=, &lt;, &lt;=</code></p>
<p>é€»è¾‘è¿ç®—ï¼š<code>and, or, not</code></p>
<p>æµè¡¨è¾¾å¼ï¼š<code>For If When</code></p>
<h1 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h1><p>templatesåŠŸèƒ½ï¼šæ ¹æ®æ¨¡å—æ–‡ä»¶åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶</p>
<p>templatesæ–‡ä»¶å¿…é¡»å­˜æ”¾äºtemplatesç›®å½•ä¸‹ï¼Œä¸”å‘½åä¸º.j2ç»“å°¾</p>
<p>yaml/ymlæ–‡ä»¶éœ€å’Œtemplatesç›®å½•å¹³çº§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;
|--j2test.yaml
|--templates
       |--nginx.conf.j2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Templatesç¤ºä¾‹"><a href="#Templatesç¤ºä¾‹" class="headerlink" title="Templatesç¤ºä¾‹"></a>Templatesç¤ºä¾‹</h2><p>ç¤ºä¾‹ï¼šåˆ©ç”¨templatesåŒæ­¥nginxé…ç½®æ–‡ä»¶å‡†å¤‡templates/nginx.conf.j2æ–‡ä»¶</p>
<p>åœ¨ansibleç›®å½•æ–°å»ºtemplatesæ–‡ä»¶å¤¹ï¼Œå¹¶å°† <code>/etc/nginx/nginx.conf</code> å¤åˆ¶åˆ° <code>templates/nginx.conf.j2</code></p>
<p><code>cp /etc/nginx/nginx.conf templates/nginx.conf.j2</code> </p>
<p>ç¼–è¾‘<code>j2test.yaml</code>æ–‡ä»¶</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
<span class="token comment">#      notify: restart service</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes

<span class="token comment">#  handlers:</span>
<span class="token comment">#    - name: restart service</span>
<span class="token comment">#      service: name=nginx state=restarted</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ£€æŸ¥æ‰§è¡Œplaybookæ–‡ä»¶ï¼Œæ£€æŸ¥nginxæ˜¯å¦è¿è¡Œ</p>
<p><code>ansible-playbook -C j2test.yaml</code></p>
<p><code>ansible-playbook j2test.yaml</code></p>
<p><code>ansible web -m shell -a &quot;ps aux|grep nginx&quot;</code></p>
<p>ä¿®æ”¹ <code>templates/nginx.conf.j2</code> æ–‡ä»¶ä¸º <code>worker_processes &#123;&#123; ansible_processor_vcpus*2 &#125;&#125;;</code> ï¼Œå°†workçº¿ç¨‹ä¿®æ”¹ä¸ºCPUæ ¸å¿ƒæ•°çš„2å€ã€‚åŒæ—¶å°†<code>j2test.yaml</code>æ–‡ä»¶ä¸­çš„notify-handlersæ³¨é‡Šè§£å¼€ã€‚</p>
<p>è¿è¡Œplaybookï¼ŒæŸ¥çœ‹workçº¿ç¨‹æ˜¯å¦å¢åŠ 2å€ã€‚</p>
<p><code>ansible-playbook j2test.yaml</code></p>
<p><code>ansible web -m shell -a &quot;ps aux|grep nginx&quot;</code></p>
<h1 id="when"><a href="#when" class="headerlink" title="when"></a>when</h1><p>æ¡ä»¶æµ‹è¯•ï¼šå¦‚æœéœ€è¦æ ¹æ®å˜é‡ã€factsæˆ–æ­¤å‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥åšä¸ºæŸtaskæ‰§è¡Œä¸å¦çš„å‰ææ—¶è¦ç”¨åˆ°æ¡ä»¶æµ‹è¯•ï¼Œé€šè¿‡whenè¯­å¥å®ç°ï¼Œåœ¨taskä¸­ä½¿ç”¨ï¼Œjinja2çš„è¯­æ³•æ ¼å¼</p>
<h2 id="whenè¯­å¥"><a href="#whenè¯­å¥" class="headerlink" title="whenè¯­å¥"></a>whenè¯­å¥</h2><p>åœ¨taskåæ·»åŠ whenå­å¥å³å¯ä½¿ç”¨æ¡ä»¶æµ‹è¯•ï¼›whenè¯­å¥æ”¯æŒJinja2è¡¨è¾¾å¼è¯­æ³•</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"shutdown RedHat flavored systems"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> /sbin/shutdown <span class="token punctuation">-</span>h now
    <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == "RedHat"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ansibleå˜é‡çš„ä¼˜å…ˆçº§ <code>-e &#123;&#123; var &#125;&#125;</code> &gt; <code>playbook</code> &gt; <code>hosts &#123;&#123; host_vars &#125;&#125;</code> &gt; <code>hosts &#123;&#123; group_var &#125;&#125;</code></p>
<p><code>ansible_distribution_version</code>   ç‰ˆæœ¬å·</p>
<p><code>ansible_distribution_major_version</code>   å¤§ç‰ˆæœ¬å·</p>
<p><code>ansible_processor_vcpus</code>   æœ¬æœºçš„cpuæ ¸å¿ƒæ•°</p>
<p>ç¤ºä¾‹ï¼šwhenæ¡ä»¶åˆ¤æ–­</p>
<p> <code>cat j2test.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates for centos8
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf8.j2 dest=/etc/nginx/nginx.conf
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "8"
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates for centos7
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7"
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat templates/nginx.conf7.j2 | grep -Ev &quot;#|^$&quot;</code></p>
<pre class="line-numbers language-django" data-language="django"><code class="language-django">user daemon;
worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">+</span><span class="token number">4</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events &#123;
    worker_connections 1024;
&#125;
http &#123;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    include /etc/nginx/conf.d/*.conf;
    server &#123;
        listen       <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;
        listen       [::]:<span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;
        server_name  _;
        root         /usr/share/nginx/html;
        include /etc/nginx/default.d/*.conf;
        location / &#123;
        &#125;
        error_page 404 /404.html;
            location = /40x.html &#123;
        &#125;
        error_page 500 502 503 504 /50x.html;
            location = /50x.html &#123;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat templates/nginx.conf8.j2 | grep -Ev &quot;#|^$&quot;</code></p>
<pre class="line-numbers language-django" data-language="django"><code class="language-django">user bin;
worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">*</span><span class="token number">2</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events &#123;
    worker_connections 1024;
&#125;
http &#123;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    include /etc/nginx/conf.d/*.conf;
    server &#123;
        listen       <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;
        listen       [::]:<span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;
        server_name  _;
        root         /usr/share/nginx/html;
        include /etc/nginx/default.d/*.conf;
        location / &#123;
        &#125;
        error_page 404 /404.html;
            location = /40x.html &#123;
        &#125;
        error_page 500 502 503 504 /50x.html;
            location = /50x.html &#123;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è¿­ä»£ï¼šwith-items"><a href="#è¿­ä»£ï¼šwith-items" class="headerlink" title="è¿­ä»£ï¼šwith_items"></a>è¿­ä»£ï¼šwith_items</h2><p>è¿­ä»£ï¼šå½“æœ‰éœ€è¦é‡å¤æ€§æ‰§è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿­ä»£æœºåˆ¶&gt;å¯¹è¿­ä»£é¡¹çš„å¼•ç”¨ï¼Œå›ºå®šå˜é‡åä¸ºâ€itemâ€</p>
<p>è¦åœ¨taskä¸­ä½¿ç”¨with_itemsç»™å®šè¦è¿­ä»£çš„å…ƒç´ åˆ—è¡¨</p>
<blockquote>
<p>åˆ—è¡¨æ ¼å¼ï¼š</p>
<blockquote>
<p>å­—ç¬¦<br>ä¸²å­—å…¸</p>
</blockquote>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add several users
  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present groups=wheel
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> testuser1
    <span class="token punctuation">-</span> testuser2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢è¯­å¥çš„åŠŸèƒ½ç­‰åŒäºä¸‹é¢çš„è¯­å¥ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user testuser1
  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=testuser1 state=present groups=wheel
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user testuser2
  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=testuser2 state=present groups=wheel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼šè¿­ä»£åµŒå¥—å­å˜é‡</p>
<p><code>cat user2.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create some groups
      <span class="token key atrule">group</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7"
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> g1
        <span class="token punctuation">-</span> g2
        <span class="token punctuation">-</span> g3
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create some users
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.name <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.group <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user1'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g1'</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user2'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g2'</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user3'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g3'</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Playbookä¸­template-for-if"><a href="#Playbookä¸­template-for-if" class="headerlink" title="Playbookä¸­template for if"></a>Playbookä¸­template for if</h1><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">&#123;</span>% for vhost in nginx_vhosts %<span class="token punctuation">&#125;</span>
server <span class="token punctuation">&#123;</span>
listen <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.listen <span class="token punctuation">|</span> default('80 default_server') <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;

<span class="token punctuation">&#123;</span>% if vhost.server_name is defined %<span class="token punctuation">&#125;</span>
server_name <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.server_name <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;
<span class="token punctuation">&#123;</span>% endif %<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#123;</span>% if vhost.root is defined %<span class="token punctuation">&#125;</span>
root <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.root <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;
<span class="token punctuation">&#123;</span>% endif %<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>ç¤ºä¾‹</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// temnginx.yml     // templates/nginx.conf.j2
<span class="token punctuation">---</span>                 <span class="token punctuation">&#123;</span>% for vhost in nginx_vhosts %<span class="token punctuation">&#125;</span>
                    server <span class="token punctuation">&#123;</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> testweb    listen <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.listen <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root   <span class="token punctuation">&#125;</span>
<span class="token key atrule">vars</span><span class="token punctuation">:</span>               <span class="token punctuation">&#123;</span>% endfor %<span class="token punctuation">&#125;</span>
  <span class="token key atrule">nginx_vhosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">listen</span><span class="token punctuation">:</span> 8080  // ç”Ÿæˆçš„ç»“æœ
                    server <span class="token punctuation">&#123;</span>
                      listen 8080
                    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼š</p>
<p><code>cat for.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">81</span>
      <span class="token punctuation">-</span> <span class="token number">82</span>
      <span class="token punctuation">-</span> <span class="token number">83</span>
    

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat templates/for1.conf.j2</code></p>
<pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">port</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>
server&#123;
    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>
&#125;
<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook for.yaml</code></p>
<p><code>ansible web -m shell -a &#39;cat /data/for1.conf&#39;</code></p>
<p>é”®å€¼å¯¹çš„æ–¹å¼ç»„æˆåˆ—è¡¨</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">81</span>
      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">82</span>
      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">83</span>
    

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">port</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>
server&#123;
    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">port</span><span class="token punctuation">.</span><span class="token variable">listen_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>
&#125;
<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ€ç»ˆçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒéªŒè¯æ—¶è®°å¾—åˆ é™¤åŸæ¥è¿œç¨‹ä¸»æœºç”Ÿæˆçš„æ–‡ä»¶ã€‚</p>
<p>åœ¨åˆ—è¡¨ä¸­å®šä¹‰å¦ä¸€ä¸ªåˆ—è¡¨ï¼Œè€Œå¦ä¸€ä¸ªåˆ—è¡¨å®šä¹‰äº†å¾ˆå¤šé”®å€¼å¯¹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">web1</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">81</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> web1.node.com
        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website1
      <span class="token punctuation">-</span> <span class="token key atrule">web2</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">82</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> web2.node.com
        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website2
      <span class="token punctuation">-</span> <span class="token key atrule">web3</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">83</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> web3.node.com
        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website3
    

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">p</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>
server&#123;
    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>
<span class="token comment">&lt;!-- <span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">if</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">name</span> <span class="token keyword">is</span> <span class="token test function">defined</span> <span class="token delimiter punctuation">%&#125;</span></span> --></span>
    servername <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">name</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>
<span class="token comment">&lt;!-- <span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endif</span> <span class="token delimiter punctuation">%&#125;</span></span> --></span>
    documentroot <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">rootdir</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>
&#125;
<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IFåˆ¤æ–­ï¼Œå°†ä¸Šé¢çš„j2æ–‡ä»¶æ³¨é‡Šè§£å¼€ï¼Œå¹¶æ³¨é‡Šyamlæ–‡ä»¶çš„web1å’Œweb3çš„nameé…ç½®ï¼Œæ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°åªæœ‰ç¬¬äºŒä¸ªæœ‰servernameï¼Œå…¶å®ƒä¸¤ä¸ªæ²¡æœ‰ã€‚å¦‚æœåœ¨j2æ–‡ä»¶ä¸­ï¼Œä¸åŠ ifåˆ¤æ–­ï¼Œæ‰§è¡Œansible-playbookä¼šæŠ¥é”™ã€‚</p>
<h1 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h1><p>ansilbeè‡ª1.2ç‰ˆæœ¬å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡playbookã€‚rolesèƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasksä»¥åŠhandlersç­‰ã€‚è¦ä½¿ç”¨rolesåªéœ€è¦åœ¨playbookä¸­ä½¿ç”¨includeæŒ‡ä»¤å³å¯ã€‚ç®€å•æ¥è®²ï¼Œroleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡æ¿åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ï¼Œå¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­</p>
<p>å¤æ‚åœºæ™¯ï¼šå»ºè®®ä½¿ç”¨rolesï¼Œä»£ç å¤ç”¨åº¦é«˜</p>
<blockquote>
<p>å˜æ›´æŒ‡å®šä¸»æœºæˆ–ä¸»æœºç»„<br>å¦‚å‘½åä¸è§„èŒƒç»´æŠ¤å’Œä¼ æ‰¿æˆæœ¬å¤§<br>æŸäº›åŠŸèƒ½éœ€å¤šä¸ªPlaybookï¼Œé€šè¿‡includeså³å¯å®ç°</p>
</blockquote>
<p>è§’è‰²(roles)ï¼šè§’è‰²é›†åˆ</p>
<pre class="line-numbers language-none"><code class="language-none">roles&#x2F;
  mysql&#x2F;
  httpd&#x2F;
  nginx&#x2F;
  memcached&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="rolesç›®å½•ç»“æ„"><a href="#rolesç›®å½•ç»“æ„" class="headerlink" title="rolesç›®å½•ç»“æ„"></a>rolesç›®å½•ç»“æ„</h2><p>æ¯ä¸ªè§’è‰²ï¼Œä»¥ç‰¹å®šçš„å±‚çº§ç›®å½•ç»“æ„è¿›è¡Œç»„ç»‡</p>
<p>rolesç›®å½•ç»“æ„ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">playbook.yml
roles&#x2F;
  project&#x2F;
    tasks&#x2F;
    files&#x2F;
    vars&#x2F;       ä¸å¸¸ç”¨
    default&#x2F;    ä¸å¸¸ç”¨
    templates&#x2F;
    handlers&#x2F;
    meta&#x2F;       ä¸å¸¸ç”¨<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Roleså„ç›®å½•ä½œç”¨"><a href="#Roleså„ç›®å½•ä½œç”¨" class="headerlink" title="Roleså„ç›®å½•ä½œç”¨"></a>Roleså„ç›®å½•ä½œç”¨</h2><p><code>/roles/project/</code>ï¼šé¡¹ç›®åç§°ï¼ˆ<code>/roles/nginx/</code>ã€<code>/roles/httpd/</code>ç­‰ï¼‰ï¼Œæœ‰ä»¥ä¸‹å­ç›®å½•</p>
<p><code>files/</code>ï¼šå­˜æ”¾ç”±copyæˆ–scriptæ¨¡å—ç­‰è°ƒç”¨çš„æ–‡ä»¶</p>
<p><code>templates/</code>ï¼štemplateæ¨¡å—æŸ¥æ‰¾æ‰€éœ€è¦æ¨¡æ¿æ–‡ä»¶çš„ç›®å½•</p>
<p><code>tasks/</code>ï¼šå®šä¹‰taskï¼Œroleçš„åŸºæœ¬å…ƒç´ ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</p>
<p><code>handlers/</code>ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</p>
<p><code>vars/</code>ï¼šå®šä¹‰å˜é‡ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</p>
<p><code>meta/</code>ï¼šå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œå…¶å®ƒæ–‡ä»¶éœ€åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</p>
<p><code>default/</code>ï¼šè®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ä¸­çš„main.ymlæ–‡ä»¶</p>
<h2 id="åˆ›å»ºrole"><a href="#åˆ›å»ºrole" class="headerlink" title="åˆ›å»ºrole"></a>åˆ›å»ºrole</h2><p>åˆ›å»ºroleçš„æ­¥éª¤</p>
<p>(1) åˆ›å»ºä»¥roleså‘½åçš„ç›®å½•</p>
<p>(2) åœ¨rolesç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºä»¥å„è§’è‰²åç§°å‘½åçš„ç›®å½•ï¼Œå¦‚webserversç­‰</p>
<p>(3) åœ¨æ¯ä¸ªè§’è‰²å‘½åçš„ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºfilesã€handlersã€metaã€tasksã€templateså’Œvarsç›®å½•ï¼›ç”¨ä¸åˆ°çš„ç›®å½•å¯ä»¥åˆ›å»ºä¸ºç©ºç›®å½•ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»º</p>
<p>(4) åœ¨playbookæ–‡ä»¶ä¸­ï¼Œè°ƒç”¨å„è§’è‰²</p>
<p>é’ˆå¯¹å¤§å‹é¡¹ç›®ä½¿ç”¨rolesè¿›è¡Œç¼–æ’</p>
<p>ç®€å•ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">[root@node ansible]# tree 
.
â”œâ”€â”€ nginx_role.yaml
â””â”€â”€ roles
    â””â”€â”€ nginx
        â”œâ”€â”€ tasks
        â”‚Â Â  â”œâ”€â”€ group.yaml
        â”‚Â Â  â”œâ”€â”€ main.yaml
        â”‚Â Â  â”œâ”€â”€ restart.yaml
        â”‚Â Â  â”œâ”€â”€ start.yaml
        â”‚Â Â  â”œâ”€â”€ templ.yaml
        â”‚Â Â  â”œâ”€â”€ user.yaml
        â”‚Â Â  â””â”€â”€ yum.yaml
        â””â”€â”€ templates
            â””â”€â”€ nginx.conf.j2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>playbookè°ƒç”¨è§’è‰²ï¼Œæ–‡ä»¶å†…å®¹ï¼š</p>
<p><code>nginx_role.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>group.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create group
  <span class="token key atrule">group</span><span class="token punctuation">:</span> name=nginx gid=80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>user.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user 
  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>yum.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package
  <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>templ.yaml </code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf
  <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf.j2 dest=/etc/nginx/nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>start.yaml </code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx
  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>restart.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart nginx
  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>main.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> group.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> yum.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> templ.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> start.yaml
<span class="token comment">#- include: restart.yaml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat templates/nginx.conf.j2 | grep -Ev &quot;^[[:space:]]*#|^$&quot;</code></p>
<pre class="line-numbers language-django" data-language="django"><code class="language-django">user nginx;
worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">+</span><span class="token number">2</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events &#123;
    worker_connections 1024;
&#125;
http &#123;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    include /etc/nginx/conf.d/*.conf;
    server &#123;
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;
        include /etc/nginx/default.d/*.conf;
        location / &#123;
        &#125;
        error_page 404 /404.html;
            location = /40x.html &#123;
        &#125;
        error_page 500 502 503 504 /50x.html;
            location = /50x.html &#123;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat /etc/ansible/hosts | grep -Ev &quot;^[[:space:]]*#|^$&quot;</code></p>
<pre class="line-numbers language-none"><code class="language-none">[alls]
192.168.1.2 hostnm&#x3D;node.1.2
192.168.1.3 hostnm&#x3D;node.1.3
192.168.1.4 hostnm&#x3D;node.1.4
192.168.1.5 hostnm&#x3D;node.1.5
192.168.1.6 hostnm&#x3D;node.1.6
192.168.1.7 hostnm&#x3D;node.1.7
[local]
192.168.1.2
[app]
192.168.1.[3:6]
[web]
192.168.1.5 http_port&#x3D;5555
192.168.1.6 http_port&#x3D;6666
[web2]
192.168.1.7 http_port&#x3D;7777
192.168.1.6 http_port&#x3D;6666<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œplaybookè„šæœ¬ï¼Œå¹¶éªŒè¯ï¼š</p>
<p><code>ansible-playbook nginx_role.yaml</code></p>
<p><code>ansible web2 -m shell -a &#39;ss -anptl | grep nginx&#39;</code></p>
<p><code>ansible web2 -m shell -a &#39;ps aux | grep nginx&#39;</code></p>
<p><code>ansible web2 -m shell -a &#39;getent passwd | grep nginx&#39;</code></p>
<p><code>ansible web2 -m shell -a &#39;getent group | grep nginx&#39;</code></p>
<p>ç¤ºä¾‹2ï¼š</p>
<p>åŒæ—¶æ‰§è¡Œå¤šä¸ªroles</p>
<p><code>http_role.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat roles/httpd/files/httpd.conf | grep -Ev &quot;^$|^[[:space:]]*#&quot;</code></p>
<pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">ServerRoot &quot;&#x2F;etc&#x2F;httpd&quot;
Listen 80
Include conf.modules.d&#x2F;*.conf
User apache
Group apache
ServerAdmin root@localhost
&lt;Directory &#x2F;&gt;
    AllowOverride none
    Require all denied
&lt;&#x2F;Directory&gt;
DocumentRoot &quot;&#x2F;var&#x2F;www&#x2F;html&quot;
&lt;Directory &quot;&#x2F;var&#x2F;www&quot;&gt;
    AllowOverride None
    Require all granted
&lt;&#x2F;Directory&gt;
&lt;Directory &quot;&#x2F;var&#x2F;www&#x2F;html&quot;&gt;
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
&lt;&#x2F;Directory&gt;
&lt;IfModule dir_module&gt;
    DirectoryIndex index.html
&lt;&#x2F;IfModule&gt;
&lt;Files &quot;.ht*&quot;&gt;
    Require all denied
&lt;&#x2F;Files&gt;
ErrorLog &quot;logs&#x2F;error_log&quot;
LogLevel warn
&lt;IfModule log_config_module&gt;
    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined
    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common
    &lt;IfModule logio_module&gt;
      LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; %I %O&quot; combinedio
    &lt;&#x2F;IfModule&gt;
    CustomLog &quot;logs&#x2F;access_log&quot; combined
&lt;&#x2F;IfModule&gt;
&lt;IfModule alias_module&gt;
    ScriptAlias &#x2F;cgi-bin&#x2F; &quot;&#x2F;var&#x2F;www&#x2F;cgi-bin&#x2F;&quot;
&lt;&#x2F;IfModule&gt;
&lt;Directory &quot;&#x2F;var&#x2F;www&#x2F;cgi-bin&quot;&gt;
    AllowOverride None
    Options None
    Require all granted
&lt;&#x2F;Directory&gt;
&lt;IfModule mime_module&gt;
    TypesConfig &#x2F;etc&#x2F;mime.types
    AddType application&#x2F;x-compress .Z
    AddType application&#x2F;x-gzip .gz .tgz
    AddType text&#x2F;html .shtml
    AddOutputFilter INCLUDES .shtml
&lt;&#x2F;IfModule&gt;
AddDefaultCharset UTF-8
&lt;IfModule mime_magic_module&gt;
    MIMEMagicFile conf&#x2F;magic
&lt;&#x2F;IfModule&gt;
EnableSendfile on
IncludeOptional conf.d&#x2F;*.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cat roles/httpd/tasks/copy.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy file
  <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/data owner=apache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>cat roles/httpd/tasks/main.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> copy.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>cat roles/httpd/tasks/user.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user 
  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=apache system=yes shell=/sbin/nologin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>cat some_reole.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éªŒè¯(æ¸…é™¤åŸæ¥playbookåˆ›å»ºçš„æ–‡ä»¶ğŸ˜Š)ï¼š</p>
<p><code>ansible-playbook some_reole.yaml</code></p>
<p>ç¤ºä¾‹3ï¼š</p>
<p>ä¸€ä¸ªroleè°ƒç”¨å¦ä¸€ä¸ªroleä¸­çš„tasksï¼Œnginxè°ƒç”¨httpdçš„copy.yaml</p>
<ol>
<li>ä¿®æ”¹nginxçš„main.yamlï¼Œå¢åŠ httpdçš„copy.yamlæ–‡ä»¶</li>
</ol>
<p><code>cat roles/nginx/tasks/main.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> group.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> yum.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> templ.yaml
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> start.yaml

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> roles/httpd/tasks/copy.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>å¦‚æœæ˜¯é€šç”¨çš„yamlæ–‡ä»¶ï¼Œå…¬å…±çš„yamlæ–‡ä»¶ä¸­çš„ä¸€äº›è·¯å¾„è¦å†™ç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥ä¿®æ”¹httpdçš„copy.yamlæ–‡ä»¶</li>
</ol>
<p><code>cat roles/httpd/tasks/copy.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy file
  <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/etc/httpd/conf/httpd.conf dest=/data owner=apache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹4ï¼š</p>
<p>åŠ æ ‡ç­¾ï¼ˆæ ‡ç­¾å¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼‰ï¼š</p>
<p><code>cp -r roles/nginx/ roles/app</code></p>
<p><code>cat some_reole.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'httpd'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'nginx'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"app"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éªŒè¯ï¼š</p>
<p><code>ansible-playbook -t web some_reole.yaml</code></p>
<p><code>ansible-playbook -t httpd some_reole.yaml</code></p>
<p><code>ansible-playbook -t app some_reole.yaml</code></p>
<p>ç¤ºä¾‹5ï¼š</p>
<p>whenè¯­å¥ï¼š</p>
<p><code>cat some_reole.yaml</code> </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'httpd'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'nginx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7" <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"app"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ansible-playbook some_reole.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Linux Create User and Upload User Public keys
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token comment">#remote_user: xxxx</span>
  <span class="token comment">#sudo: yes</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">user_1</span><span class="token punctuation">:</span> xiaoxiaoleo

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Make sure we have a 'wheel' group
      <span class="token key atrule">group</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wheel
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Allow 'wheel' group to have passwordless sudo
      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/sudoers
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^%wheel'</span>
        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'%wheel ALL=(ALL) NOPASSWD: ALL'</span>
 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create user <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">user</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; user_1 &#125;&#125;"</span>
        <span class="token key atrule">shell</span><span class="token punctuation">:</span> /bin/bash
        <span class="token key atrule">groups</span><span class="token punctuation">:</span> wheel
        <span class="token key atrule">createhome</span><span class="token punctuation">:</span> yes
        <span class="token key atrule">home</span><span class="token punctuation">:</span> /home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create key directory
      <span class="token key atrule">action</span><span class="token punctuation">:</span> file path=/home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/.ssh/ state=directory  owner=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> mode=0700
 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create key file
      <span class="token key atrule">action</span><span class="token punctuation">:</span> file path=/home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/.ssh/authorized_keys state=touch  owner=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> mode=0600
     

 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set authorized key took from file
      <span class="token key atrule">authorized_key</span><span class="token punctuation">:</span>
        <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; user_1 &#125;&#125;"</span>
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; lookup('file', '/tmp/pubkey/id_rsa.pub') &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



            </div>
            <hr/>

            



        </div>
    </div>

    

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


    <footer class="page-footer bg-color">

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2023</span>
            

            
                <span id="icp"><img src="/medias/icp.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="https://beian.miit.gov.cn" target="_blank">äº¬ICPå¤‡2023001682å·</a>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            <span <i class="fas fa-desktop"></i> </span>
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2020";
                        var startMonth = "8";
                        var startDate = "1";
                        var startHour = "8";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);

                        // åŒºåˆ†æ˜¯å¦æœ‰å¹´ä»½.
                        var language = 'zh-CN';
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = 'Poyaisç«™ç‚¹å·²å®‰å…¨è¿è¡Œ ' + diffDays + ' å¤© ' + diffHours + ' å°æ—¶ ' + diffMinutes + ' åˆ†é’Ÿ ' + diffSeconds + ' ç§’ğŸŠ';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                    }

                    setInterval(siteTime, 1000);
                </script>
            <br>
            

            
            
                
            
            
                <span id="busuanzi_container_site_uv">
                <i class="fas fa-users"></i>&nbsp;æ€»æµè§ˆ:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>äººğŸ‰&nbsp;
            </span>
            
            
                <span id="busuanzi_container_site_pv">
                <i class="far fa-eye"></i>&nbsp;æ€»ç‚¹å‡»:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>æ¬¡ğŸ‰&nbsp;
            </span>
            
            
                <i class="fas fa-chart-area"></i>&nbsp;æ€»å­—æ•°:&nbsp;<span
                    class="white-color">168.9k</span>åƒå­—ğŸ‰
            
            

        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wujiops" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„Gitä»“åº“" data-position="top" data-delay="50">
        <i class="fab fa-git"></i>
    </a>



    <a href="mailto:158970251@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=158970251" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 158970251" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
    
    

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a4c9204df4c3cec280b566bca80a32d5";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.js" type="module"></script>
    

</body>

</html>
