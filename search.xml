<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>shell实战</title>
      <link href="/posts/67310e62.html"/>
      <url>/posts/67310e62.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux正则表达式"><a href="#Linux正则表达式" class="headerlink" title="Linux正则表达式"></a>Linux正则表达式</h3><blockquote><p><strong>正则表达式</strong>（Regular Expression、regex或regexp，缩写为RE），也译为正规表示法、常规表示法，是一种字符模式，用于在查找过程中匹配指定的字符</p><p>许多程序设计语言都支持利用正则表达式进行<strong>字符串操作</strong>。在不同语言中，基本字符串匹配规则都是相同的，只是语法有差异。</p></blockquote><blockquote><p>匹配规则</p></blockquote><table><thead><tr><th>特别字符</th><th>描述</th></tr></thead><tbody><tr><td>.</td><td>任意单个字符，除了换行符。</td></tr><tr><td><code>*</code></td><td>前导字符出现0次或连续多次 ab*能匹配“a”，“ab”以及“abb”，但是不匹配“cb”。</td></tr><tr><td><code>.*</code></td><td>任意长度的字符 ab.* ab123 abbb abab。</td></tr><tr><td><code>^</code></td><td>匹配输入字符串的开始位置，除非在方括号表达式中使用，当该符号在方括号表达式中使用时，表示不接受该方括号表达式中的字符集合。要匹配 ^ 字符本身，请使用 ^。</td></tr><tr><td><code>$</code></td><td>匹配输入字符串的结束位置。</td></tr><tr><td><code>^$</code></td><td>匹配空行。</td></tr><tr><td><code>[]</code></td><td>匹配指定字符组内的任一单个字符 <code>[abc]</code>。</td></tr><tr><td><code>[^]</code></td><td>匹配不在指定字符组内的任一字符 <code>[^abc]</code>。</td></tr><tr><td><code>^[]</code></td><td>匹配以指定字符组内的任一字符开头 <code>^[abc]</code>。</td></tr><tr><td><code>^[^]</code></td><td>匹配不以指定字符组内的任一字符开头 <code>^[^abc]</code> 。</td></tr><tr><td><code>&lt;</code></td><td>匹配单词的头。</td></tr><tr><td><code>&gt;</code></td><td>匹配单词的尾。</td></tr><tr><td><code>&lt;&gt;</code></td><td>精确匹配单词。</td></tr><tr><td><code>&#123;n&#125;</code></td><td>匹配前导字符连续出现n次。</td></tr><tr><td><code>&#123;n,&#125;</code></td><td>匹配前导字符至少出现n次。</td></tr><tr><td><code>&#123;n,m&#125;</code></td><td>匹配前导字符出现n次与m次之间。</td></tr><tr><td><code>(strings)</code></td><td>保存被匹配的字符，将括号中的内容视为一个整体。</td></tr></tbody></table><p>Perl内置匹配：</p><table><thead><tr><th>特别字符</th><th>描述</th></tr></thead><tbody><tr><td><code>\d</code></td><td>匹配数字 [0-9]。</td></tr><tr><td><code>\w</code></td><td>匹配字母数字下划线[a-zA-Z0-9_]。</td></tr></tbody></table><p>扩展类的正则表达式 <code>grep -E</code> 或则 <code>egrep</code>：</p><table><thead><tr><th>特别字符</th><th>描述</th></tr></thead><tbody><tr><td><code>+</code></td><td>匹配一个或多个前导字符。 bo+ boo bo</td></tr><tr><td><code>?</code></td><td>匹配零个或一个前导字符。 bo? b bo</td></tr><tr><td>`(a</td><td>b)`</td></tr></tbody></table><blockquote><p>Shell三剑客之grep工具</p></blockquote><p>语法格式：</p><pre class="line-numbers language-none"><code class="language-none">grep [选项] &#39;关键字&#39; 文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用选项：</p><pre class="line-numbers language-none"><code class="language-none">OPTIONS:    -i: 不区分大小写    -v: 查找不包含指定内容的行,反向选择    -w: 按单词搜索    -o: 打印匹配关键字    -c: 统计匹配到的行数    -n: 显示行号    -R: 逐层遍历目录查找    -e: 使用正则匹配    -E:使用扩展正则匹配    ^key:以关键字开头    key$:以关键字结尾    ^$:匹配空行    --color&#x3D;auto ：可以将找到的关键词部分加上颜色的显示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>cut工具</p></blockquote><p>语法格式：</p><pre class="line-numbers language-none"><code class="language-none">cut 选项 文件名常用选项：-c:以字符为单位进行分割,截取-d:自定义分隔符，默认为制表符\t-f:与-d一起使用，指定截取哪个区域<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>样例：</p><pre class="line-numbers language-none"><code class="language-none">cut -d: -f1-3 passwd  以:冒号分割，截取第1-3列内容cut -c3,4,6 passwd    截取文件中每行第3，4，6个字符<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>sort工具</p></blockquote><p>sort工具用于排序;它将文件的每一行作为一个单位，从首字符向后，依次按ASCII码值进行比较，最后将他们按升序输出。</p><p>语法格式：</p><pre class="line-numbers language-none"><code class="language-none">sort 选项 文件名常用选项：-u ：去除重复行-r ：降序排列，默认是升序-o : 将排序结果输出到文件中,类似重定向符号&gt;-n ：以数字排序，默认是按字符排序-t ：分隔符-k ：指定列数-b ：忽略前导空格-R ：随机排序<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>样例：</p><pre class="line-numbers language-none"><code class="language-none">sort -n -t: -k3 1.txt  按照用户的uid进行升序排列sort -ur 2.txt         按照字符降序去重排序<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>uniq工具</p></blockquote><p>uniq用于去除连续的重复行。</p><pre class="line-numbers language-none"><code class="language-none">uniq 选项 文件名常用选项：-i: 忽略大小写-c: 统计重复行次数-d: 只显示重复行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>样例：</p><pre class="line-numbers language-none"><code class="language-none">uniq -i 3.txt    忽略大小写去重uniq -ic 3.txt   统计重复次数uniq -icd 3.txt  只显示重复行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>tee工具</p></blockquote><p>tee工具是从标准输入读取并写入到标准输出和文件，即：双向覆盖重定向（屏幕输出|文本输入）。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "Hello World!" | tee -a hello.txt</span>Hello World<span class="token operator">!</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat hello.txt</span>Hello World<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>paste工具</p></blockquote><pre class="line-numbers language-none"><code class="language-none">常用选项：-d：自定义间隔符，默认是tab-s：串行处理，非并行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat hello.txt </span>Hello World<span class="token operator">!</span>Hello World<span class="token operator">!</span> line <span class="token number">2</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat txt.txt </span><span class="token number">123</span><span class="token number">456</span><span class="token number">789</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># paste hello.txt txt.txt </span>Hello World<span class="token operator">!</span><span class="token number">123</span>Hello World<span class="token operator">!</span> line <span class="token number">2</span><span class="token number">456</span><span class="token number">789</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># paste -d: hello.txt txt.txt </span>Hello World<span class="token operator">!</span>:123Hello World<span class="token operator">!</span> line <span class="token number">2</span>:456:789<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># paste -s hello.txt txt.txt </span>Hello World<span class="token operator">!</span>Hello World<span class="token operator">!</span> line <span class="token number">2</span><span class="token number">123</span><span class="token number">456</span><span class="token number">789</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>diff工具</p></blockquote><p>diff工具用于逐行比较文件的不同。</p><p>语法格式：</p><pre class="line-numbers language-none"><code class="language-none">diff [选项] 文件1 文件2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用选项：</p><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>-b</td><td>不检查空格</td></tr><tr><td>-B</td><td>不检查空白行</td></tr><tr><td>-i</td><td>不检查大小写</td></tr><tr><td>-w</td><td>忽略所有的空格</td></tr><tr><td>–normal</td><td>正常格式显示(默认)</td></tr><tr><td>-c</td><td>上下文格式显示</td></tr><tr><td>-u</td><td>合并格式显示</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff -c hello.txt txt.txt </span>*** hello.txt<span class="token number">2023</span>-08-10 09:55:21.266379383 +0800--- txt.txt<span class="token number">2023</span>-08-10 09:55:08.751592760 +0800****************** <span class="token number">1,2</span> ****<span class="token operator">!</span> Hello World<span class="token operator">!</span><span class="token operator">!</span> Hello World<span class="token operator">!</span> line <span class="token number">2</span>--- <span class="token number">1,3</span> ----<span class="token operator">!</span> <span class="token number">123</span><span class="token operator">!</span> <span class="token number">456</span><span class="token operator">!</span> <span class="token number">789</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff -u hello.txt txt.txt </span>--- hello.txt<span class="token number">2023</span>-08-10 09:55:21.266379383 +0800+++ txt.txt<span class="token number">2023</span>-08-10 09:55:08.751592760 +0800@@ -1,2 +1,3 @@<span class="token parameter variable">-Hello</span> World<span class="token operator">!</span><span class="token parameter variable">-Hello</span> World<span class="token operator">!</span> line <span class="token number">2</span>+123+456+789<span class="token comment"># 文件补丁</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff -u hello.txt txt.txt > file.patch</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># patch hello.txt file.patch </span>patching <span class="token function">file</span> hello.txt<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff -u hello.txt txt.txt </span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat hello.txt </span><span class="token number">123</span><span class="token number">456</span><span class="token number">789</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat txt.txt </span><span class="token number">123</span><span class="token number">456</span><span class="token number">789</span><span class="token comment"># 目录比较</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff A/ B/</span>只在 B/ 存在：file.patch只在 A/ 存在：txt.txt<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># diff -q A/ B/</span>只在 B/ 存在：file.patch只在 A/ 存在：txt.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>tr工具</p></blockquote><p>tr用于字符转换，替换和删除；主要用于删除文件中控制字符或进行字符转换。</p><p>语法格式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用法1：命令的执行结果交给tr处理，其中string1用于查询，string2用于转换处理<span class="token comment"># command | tr  'string1'  'string2'</span>用法2：tr处理的内容来自文件，记住要使用<span class="token string">"&lt;"</span>标准输入<span class="token comment"># tr  'string1'  'string2' &lt; filename</span>用法3：匹配string1进行相应操作，如删除操作<span class="token comment"># tr options 'string1' &lt; filename</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>常用选项：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-d</span> 删除字符串1中所有输入字符。<span class="token parameter variable">-s</span> 删除所有重复出现字符序列，只保留第一个；即将重复出现字符串压缩为一个字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'[:/]'</span> <span class="token operator">&lt;</span> <span class="token number">1</span>.txt   <span class="token comment"># 将:/删除，源文件保留，删除后的内容到stdout</span><span class="token function">head</span> <span class="token number">1</span>.txt <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'[:/]'</span>   <span class="token comment"># 管道读取内容</span><span class="token function">tr</span> <span class="token string">'[0-9]'</span> <span class="token string">'$'</span> <span class="token operator">&lt;</span> <span class="token number">1</span>.txt   <span class="token comment"># 将数字替换成$</span><span class="token function">tail</span> <span class="token number">1</span>.txt <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-s</span> <span class="token string">'[a-z]'</span>   <span class="token comment"># 匹配小写字母并将重复的压缩为一个</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="shell脚本循环结构"><a href="#shell脚本循环结构" class="headerlink" title="shell脚本循环结构"></a>shell脚本循环结构</h3><blockquote><p>for循环</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">var</span> <span class="token keyword">in</span> item1 item2 <span class="token punctuation">..</span>. itemN<span class="token keyword">do</span>    command1    command2    <span class="token punctuation">..</span>.    commandN<span class="token keyword">done</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> hello abc<span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出当前路径下所有文件名</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span><span class="token variable">`</span></span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>输出序列1-10</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">10</span><span class="token variable">)</span></span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出字母a-z</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">..</span>z<span class="token punctuation">&#125;</span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>for ((…;…;…)) do…done</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">))</span></span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>while循环</p></blockquote><p>while 循环用于不断执行一系列命令，也用于从输入文件中读取数据。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> condition<span class="token keyword">do</span>    <span class="token builtin class-name">command</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>偶数和</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">sum</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> <span class="token parameter variable">-le</span> <span class="token number">50</span> <span class="token punctuation">]</span><span class="token keyword">do</span>    <span class="token builtin class-name">let</span> <span class="token assign-left variable">sum</span><span class="token operator">+=</span>i    <span class="token builtin class-name">let</span> <span class="token assign-left variable">i</span><span class="token operator">+=</span><span class="token number">2</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"0-50的偶数和为：<span class="token variable">$sum</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>循环输入名字，文件结束符为Ctrl+d，输入文件结束符后read指令返回false。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"Please input your name: "</span> name<span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$name</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>until 循环</p></blockquote><p><strong>until 循环执行一系列命令直至条件为 true 时停止。</strong></p><p>until 循环与 while 循环在处理方式上刚好相反。</p><p><strong>一般 while 循环优于 until 循环，但在某些时候—也只是极少数情况下，until 循环更加有用。</strong></p><p>until 语法格式:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">until</span> condition<span class="token keyword">do</span>    <span class="token builtin class-name">command</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>condition 一般为条件表达式，如果返回值为 false，则继续执行循环体内的语句，否则跳出循环。</p><p>以下实例我们使用 until 命令来输出 0 ~ 9 的数字：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">until</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable">$a</span> <span class="token parameter variable">-lt</span> <span class="token number">10</span> <span class="token punctuation">]</span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token variable">$a</span>    <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> $a + <span class="token number">1</span><span class="token variable">`</span></span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>跳出循环</p></blockquote><p>在循环过程中，有时候需要在未达到循环结束条件时强制跳出循环，Shell 使用两个命令来实现该功能：<strong>break</strong> 和 <strong>continue</strong>。</p><p>break 命令允许跳出所有循环（终止执行后面的所有循环）。</p><p>下面的例子中，脚本进入死循环直至用户输入数字大于5。要跳出这个循环，返回到shell提示符下，需要使用break命令。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token keyword">do</span>    <span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"请输入1-5虹之间的数字："</span> n    <span class="token keyword">case</span> <span class="token variable">$n</span> <span class="token keyword">in</span>        <span class="token number">1</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"你输入的数字为<span class="token variable">$n</span>"</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"请输入正确的数字范围"</span>           <span class="token builtin class-name">break</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">esac</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>continue 命令与 break 命令类似，只有一点差别，它不会跳出所有循环，仅仅跳出当前循环。</p><p>对上面的例子进行修改：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token keyword">do</span>    <span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"请输入1-5之间的数字："</span> n    <span class="token keyword">case</span> <span class="token variable">$n</span> <span class="token keyword">in</span>        <span class="token number">1</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"你输入的数字为<span class="token variable">$n</span>"</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"请输入正确的数字范围"</span>            <span class="token builtin class-name">continue</span>            <span class="token builtin class-name">echo</span> <span class="token string">"游戏结束，这句话永远不会被执行"</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">esac</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="常见逻辑判断运算符"><a href="#常见逻辑判断运算符" class="headerlink" title="常见逻辑判断运算符"></a>常见逻辑判断运算符</h3><blockquote><p>if 常见判断逻辑运算符详解</p></blockquote><pre class="line-numbers language-none"><code class="language-none">-f   判断文件是否存在 eg: if [ -f filename ]；-d   判断目录是否存在 eg: if [ -d dir     ]；-eq  等于，应用于整型比较 equal；-ne  不等于，应用于整型比较 not equal；-lt  小于，应用于整型比较 letter；-gt  大于，应用于整型比较 greater；-le  小于或等于，应用于整型比较；-ge  大于或等于，应用于整型比较；-a  双方都成立（and） 逻辑表达式 –a 逻辑表达式；-o  单方成立（or） 逻辑表达式 –o 逻辑表达式；-z  空字符串；-x      是否具有可执行权限||      单方成立；&amp;&amp;      双方都成立表达式。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="case-选择语句"><a href="#case-选择语句" class="headerlink" title="case 选择语句"></a>case 选择语句</h3><pre class="line-numbers language-none"><code class="language-none">#Case选择语句，主要用于对多个选择条件进行匹配输出，与if elif语句结构类似，通常用于脚本传递输入参数，打印出输出结果及内容，其语法格式以Case…in开头，esac结尾。语法格式如下：case 模式名  in  模式 1)    命令    ;;  模式 2)    命令    ;;*)不符合以上模式执行的命令esac# 每个模式必须以右括号结束，命令结尾以双分号结束。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用 case 编写一个 脚本</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"    <span class="token entity" title="\033">\033</span>[31m start <span class="token entity" title="\033">\033</span>[0m    <span class="token entity" title="\033">\033</span>[32m stop <span class="token entity" title="\033">\033</span>[0m     <span class="token entity" title="\033">\033</span>[33m restart <span class="token entity" title="\033">\033</span>[0m"</span><span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"请输入你的选择start|stop|restart"</span> char<span class="token keyword">case</span> <span class="token variable">$char</span> <span class="token keyword">in</span>start<span class="token punctuation">)</span>    systemctl start httpd <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"httpd服务已经开启"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"开启失败"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>stop<span class="token punctuation">)</span>    systemctl stop httpd <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"httpd服务已经关闭"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"关闭失败"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>restart<span class="token punctuation">)</span>    systemctl restart httpd <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"httpd服务已经重启"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"重启失败"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>*<span class="token punctuation">)</span>    <span class="token builtin class-name">echo</span> <span class="token string">"请输入你的选择start|stop|restart"</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token keyword">esac</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="示例脚本"><a href="#示例脚本" class="headerlink" title="示例脚本"></a>示例脚本</h3><blockquote><p>检查MySQL 服务是否存活</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 检测 MySQL 服务是否存活 </span><span class="token comment"># host 为你需要检测的 MySQL 主机的 IP 地址,user 为 MySQL 账户名,passwd 为密码</span><span class="token comment"># 这些信息需要根据实际情况修改后方可使用</span><span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token number">192.168</span>.1.10<span class="token assign-left variable">user</span><span class="token operator">=</span>root<span class="token assign-left variable">passwd</span><span class="token operator">=</span>xxxxxxmysqladmin <span class="token parameter variable">-h</span> <span class="token string">'$host'</span> <span class="token parameter variable">-u</span> <span class="token string">'$user'</span> -p<span class="token string">'$passwd'</span> <span class="token function">ping</span> <span class="token operator">&amp;></span>/dev/null<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"MySQL is UP"</span><span class="token keyword">else</span>        <span class="token builtin class-name">echo</span> <span class="token string">"MySQL is down"</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个最简单的检查mysql状态的脚本，其实是借助了mysqladmin命令，这个是需要大家牢记的。</p><blockquote><p>检查MySQL主从同步状态</p></blockquote><p>mysql主从复制架构在企业中应用很广，而对主从复制状态的监控，也是运维必备的工作，如何监控主从复制状态呢，看下面脚本的监控逻辑：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash  </span><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>iivey<span class="token assign-left variable">PASSWD</span><span class="token operator">=</span><span class="token number">123456</span><span class="token assign-left variable">IO_SQL_STATUS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mysql -u<span class="token environment constant">$USER</span> -p$PASSWD <span class="token parameter variable">-e</span> <span class="token string">'show slave status\G'</span> <span class="token operator">|</span><span class="token function">awk</span> -F: <span class="token string">'/Slave_.*_Running/&#123;gsub(": ",":");print $0&#125;'</span><span class="token variable">)</span></span>  <span class="token comment">#gsub去除冒号后面的空格</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$IO_SQL_STATUS</span><span class="token punctuation">;</span> <span class="token keyword">do</span>    <span class="token assign-left variable">THREAD_STATUS_NAME</span><span class="token operator">=</span><span class="token variable">$&#123;i<span class="token operator">%</span><span class="token operator">:</span>*&#125;</span>    <span class="token assign-left variable">THREAD_STATUS</span><span class="token operator">=</span><span class="token variable">$&#123;i<span class="token operator">#</span>*<span class="token operator">:</span>&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$THREAD_STATUS</span>"</span> <span class="token operator">!=</span> <span class="token string">"Yes"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"Error: MySQL Master-Slave <span class="token variable">$THREAD_STATUS_NAME</span> status is <span class="token variable">$THREAD_STATUS</span>!"</span>    <span class="token keyword">fi</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个脚本就是通过登录mysql，然后查询主从复制的两个状态值slave_sql_running和Slave_IO_Running，如果两个值都是Yes，那么就认为正常。</p><blockquote><p>基于mysqldump的备份脚本</p></blockquote><p>下面这个脚本是基于mysqldump的备份，也就是将数据库备份成sql文件，内容如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 备份 MySQL 的 shell 脚本(mysqldump版本) </span><span class="token comment"># 定义变量 user(数据库用户名),passwd(数据库密码),date(备份的时间标签)</span><span class="token comment"># dbname(需要备份的数据库名称,根据实际需求需要修改该变量的值,默认备份 mysql 数据库)</span><span class="token assign-left variable">user</span><span class="token operator">=</span>root<span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">123456</span><span class="token assign-left variable">dbname</span><span class="token operator">=</span>mysql<span class="token assign-left variable">date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span><span class="token comment"># 测试备份目录是否存在,不存在则自动创建该目录</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> /mysqlbackup <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> /mysqlbackup<span class="token comment"># 使用 mysqldump 命令备份数据库</span>mysqldump <span class="token parameter variable">-u</span> <span class="token string">"<span class="token variable">$user</span>"</span> <span class="token parameter variable">-p</span> <span class="token string">"<span class="token variable">$passwd</span>"</span> <span class="token string">"<span class="token variable">$dbname</span>"</span> <span class="token operator">></span> /mysqlbackup/<span class="token string">"<span class="token variable">$dbname</span>"</span>-<span class="token variable">$&#123;date&#125;</span>.sql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对mysql进行备份，在数据量较少的时候使用mysqldump还是很方便的，而在大量数据需要备份的话，这个mysqldump就力不从心了，需要考虑主从或者其他备份方案。</p><blockquote><p>基于mysql的mysqldump并压缩脚本</p></blockquote><p>下面这个脚本是上面脚本的升级版本，内容如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%H-%M-%S<span class="token variable">)</span></span><span class="token assign-left variable">HOST</span><span class="token operator">=</span><span class="token number">192.168</span>.1.220<span class="token assign-left variable">DB</span><span class="token operator">=</span>iivey<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>iivey<span class="token assign-left variable">PASS</span><span class="token operator">=</span><span class="token number">123456</span><span class="token assign-left variable">MAIL</span><span class="token operator">=</span><span class="token string">"abc@example.com dfg@example.com"</span><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span>/data/db_backup<span class="token assign-left variable">SQL_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;DB&#125;</span>_full_<span class="token variable">$DATE</span>.sql<span class="token assign-left variable">BAK_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;DB&#125;</span>_full_<span class="token variable">$DATE</span>.zip<span class="token builtin class-name">cd</span> <span class="token variable">$BACKUP_DIR</span><span class="token keyword">if</span> mysqldump -h<span class="token variable">$HOST</span> -u<span class="token environment constant">$USER</span> -p<span class="token variable">$PASS</span> --single-transaction <span class="token parameter variable">--routines</span> <span class="token parameter variable">--triggers</span> <span class="token parameter variable">-B</span> <span class="token variable">$DB</span> <span class="token operator">></span> <span class="token variable">$SQL_FILE</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token function">zip</span> <span class="token variable">$BAK_FILE</span> <span class="token variable">$SQL_FILE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$SQL_FILE</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token variable">$BAK_FILE</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>            <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$DATE</span> 内容"</span> <span class="token operator">|</span> mail <span class="token parameter variable">-s</span> <span class="token string">"主题"</span> <span class="token variable">$MAIL</span>    <span class="token keyword">fi</span><span class="token keyword">else</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$DATE</span> 内容"</span> <span class="token operator">|</span> mail <span class="token parameter variable">-s</span> <span class="token string">"主题"</span> <span class="token variable">$MAIL</span><span class="token keyword">fi</span><span class="token function">find</span> <span class="token variable">$BACKUP_DIR</span> <span class="token parameter variable">-name</span> <span class="token string">'*.zip'</span> <span class="token parameter variable">-ctime</span> +14 <span class="token parameter variable">-exec</span> <span class="token function">rm</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个脚本也是通过mysqldump 进行数据库的备份，不同的是它对备份出来的sql文件进行了压缩和校验。并且删除两周之前的备份。</p><blockquote><p>统计 Linux 进程相关数量信息</p></blockquote><p>这个脚本是对系统中运行的进行数和进程状态进行一个整体统计，内容如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 统计 Linux 进程相关数量信息 </span><span class="token assign-left variable">running</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">sleeping</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">stoped</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">zombie</span><span class="token operator">=</span><span class="token number">0</span><span class="token comment"># 在 proc 目录下所有以数字开始的都是当前计算机正在运行的进程的进程 PID</span><span class="token comment"># 每个 PID 编号的目录下记录有该进程相关的信息</span><span class="token keyword">for</span> <span class="token for-or-select variable">pid</span> <span class="token keyword">in</span> /proc/<span class="token punctuation">[</span><span class="token number">1</span>‐9<span class="token punctuation">]</span>*<span class="token keyword">do</span>    <span class="token assign-left variable">procs</span><span class="token operator">=</span>$<span class="token punctuation">[</span>procs+1<span class="token punctuation">]</span>    <span class="token assign-left variable">stat</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span> $pid/stat<span class="token variable">)</span></span><span class="token comment"># 每个pid目录下都有一个stat文件,该文件的第3列是该进程的状态信息</span>    <span class="token keyword">case</span> <span class="token variable">$stat</span> <span class="token keyword">in</span>    R<span class="token punctuation">)</span>        <span class="token assign-left variable">running</span><span class="token operator">=</span>$<span class="token punctuation">[</span>running+1<span class="token punctuation">]</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    T<span class="token punctuation">)</span>        <span class="token assign-left variable">stoped</span><span class="token operator">=</span>$<span class="token punctuation">[</span>stoped+1<span class="token punctuation">]</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    S<span class="token punctuation">)</span>        <span class="token assign-left variable">sleeping</span><span class="token operator">=</span>$<span class="token punctuation">[</span>sleeping+1<span class="token punctuation">]</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    Z<span class="token punctuation">)</span>        <span class="token assign-left variable">zombie</span><span class="token operator">=</span>$<span class="token punctuation">[</span>zombie+1<span class="token punctuation">]</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">esac</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"进程统计信息如下"</span><span class="token builtin class-name">echo</span> <span class="token string">"总进程数量为:<span class="token variable">$procs</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"Running 进程数为:<span class="token variable">$running</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"Stoped 进程数为:<span class="token variable">$stoped</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"Sleeping 进程数为:<span class="token variable">$sleeping</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"Zombie 进程数为:<span class="token variable">$zombie</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell技巧</title>
      <link href="/posts/89dc6cfc.html"/>
      <url>/posts/89dc6cfc.html</url>
      
        <content type="html"><![CDATA[<h3 id="bash的8个特殊参数"><a href="#bash的8个特殊参数" class="headerlink" title="bash的8个特殊参数"></a>bash的8个特殊参数</h3><blockquote><p><code>$*</code><br>($<em>) 扩展为从1开始的位置参数。在非双引号内进行扩展时，每个位置参数扩展为一个单独的单词。在执行它的上下文环境中，这些单词将进一步被拆分为单词和文件名扩展。当扩展出现在双引号内时，它会扩展为一个单词，其中每个参数的值由IFS特殊变量的第一个字符分隔。也就是说，”$</em>“等同于”$1c$2c…”，其中c是IFS变量值的第一个字符。如果IFS未设置，则参数用空格分隔。如果IFS为空，则参数被直接连接在一起，没有中间分隔符。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># set - 'a    1' 2 3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $*</span>a <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "$*"</span>a    <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># for i in $*; do printf "$i\n"; done</span>a<span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># for i in "$*"; do printf "$i\n"; done</span>a    <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># printf '%q\n' "$IFS"</span><span class="token string">$' <span class="token entity" title="\t">\t</span><span class="token entity" title="\n">\n</span>'</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># IFS=-</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $*</span>a    <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "$*"</span>a    <span class="token number">1</span>-2-3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>$@</code><br>($@) 扩展为从1开始的位置参数。在执行单词分割的上下文中，它将每个位置参数扩展为单独的单词；如果不在双引号内，这些单词将被分割成单词。在不执行单词分割的上下文中，它将扩展为每个位置参数由空格分隔的单个单词。当扩展发生在双引号内，并且执行单词分割时，每个参数将扩展为单独的单词。也就是说，”$@” 相当于 “$1” “$2” …。如果双引号扩展出现在一个单词中，第一个参数的扩展将与原始单词的开始部分连接，最后一个参数的扩展将与原始单词的最后部分连接。当没有位置参数时，”$@” 和 $@ 扩展为空（即它们被移除）。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># bash   # 新环境</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># set - 'a    1' 2 3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $@</span>a <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "$@"</span>a    <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># for i in $@; do printf "$i\n"; done</span>a<span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># for i in "$@"; do printf "$i\n"; done</span>a    <span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其它:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># bash</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># set - 1 2 3</span><span class="token variable"><span class="token variable">`</span>$#<span class="token variable">`</span></span>：扩展为位置参数的个数。<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $#</span><span class="token number">3</span><span class="token variable"><span class="token variable">`</span>$?<span class="token variable">`</span></span>：扩展为最近执行的前台管道的退出状态。<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $?</span><span class="token number">0</span><span class="token variable"><span class="token variable">`</span>$-<span class="token variable">`</span></span>：扩展为当前选项标志，由调用时指定，由 <span class="token builtin class-name">set</span> 内置命令指定，或由 shell 自身设置（例如 <span class="token parameter variable">-i</span> 选项）。<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $-</span>himBHs<span class="token variable"><span class="token variable">`</span>$$<span class="token variable">`</span></span>：扩展为 shell 进程的进程 ID（PID）。<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $$</span><span class="token number">16658</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ps &amp;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">16691</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment">#     PID TTY          TIME CMD</span>  <span class="token number">16620</span> pts/0    00:00:00 <span class="token function">bash</span>  <span class="token number">16658</span> pts/0    00:00:00 <span class="token function">bash</span>  <span class="token number">16691</span> pts/0    00:00:00 <span class="token function">ps</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>+  已完成               <span class="token function">ps</span><span class="token variable"><span class="token variable">`</span>$<span class="token operator">!</span><span class="token variable">`</span></span>：扩展为最近执行的后台命令的 PID。<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $!</span><span class="token number">16691</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $0</span><span class="token function">bash</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="shell里面的一些特殊符号"><a href="#shell里面的一些特殊符号" class="headerlink" title="shell里面的一些特殊符号"></a>shell里面的一些特殊符号</h3><blockquote><p><code>#</code>：井号用于注释，可在脚本中添加注释，提高代码可读性。<br><code>!</code>：感叹号用于执行历史命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ls</span>anaconda-ks.cfg<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># !ls</span><span class="token function">ls</span>anaconda-ks.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>$</code>：美元符号用于引用变量，例如 $HOME 将会展开为当前用户的家目录。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $HOME</span>/root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>*</code>：星号表示通配符，用于匹配任意字符，例如 *.log 将会匹配所有以 .log 结尾的文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ls /var/log/*.log</span>/var/log/dnf.librepo.log  /var/log/dnf.rpm.log  /var/log/kdump.log/var/log/dnf.log          /var/log/hawkey.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>?</code>：问号也是一个通配符，用于匹配单个字符，例如 file?.txt 将会匹配 file1.txt、file2.txt 等文件。<br><code>[]</code>：方括号也是一种通配符，用于匹配一个字符集中的任意字符，例如 [abc] 将会匹配字符 a、b 或 c。<br><code>&#123;&#125;</code>：花括号用于构建命令序列，例如 cp {file1,file2}.txt dir/ 将会拷贝 file1.txt 和 file2.txt 到 dir/ 目录中。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># touch file&#123;1,2&#125;.txt</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mkdir dir/&#123;3,4&#125;/0 -p</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cp &#123;file1,file2&#125;.txt dir/</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ls</span>anaconda-ks.cfg  <span class="token function">dir</span>  file1.txt  file2.txt<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># tree dir/</span>dir/├── <span class="token number">3</span>│   └── <span class="token number">0</span>├── <span class="token number">4</span>│   └── <span class="token number">0</span>├── file1.txt└── file2.txt<span class="token number">4</span> directories, <span class="token number">2</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>()</code>：圆括号用于创建子 shell，例如 (ls; echo “done”) 将会在子 shell 中执行 ls 命令，并在完成后输出 done。<br><code>|</code>：管道符用于将一个命令的输出传递给另一个命令作为输入，例如 ls | grep “txt” 将会列出当前目录下所有以 .txt 结尾的文件。<br><code>&gt;</code> 和 <code>&gt;&gt;</code>：大于号和双大于号用于将命令的输出重定向到一个文件或设备中，例如 ls &gt; files.txt 将会将 ls 命令的输出保存到 files.txt 文件中。&gt;&gt; 与 &gt; 的区别在于，它会将命令的输出追加到文件末尾而不是覆盖文件。<br><code>&lt;</code>：小于号用于将文件内容作为命令的输入，例如 sort &lt; input.txt 将会将 input.txt 文件内容作为 sort 命令的输入。<br><code>&amp;</code>：和号用于将命令放入后台执行，例如 ./myprogram &amp; 将会在后台执行 myprogram 程序。<br><code>;</code>：分号用于将多个命令放在同一行上，例如 command1; command2 将会先执行 command1，再执行 command2。<br><code>&amp;&amp;</code> 和 <code>||</code>：双与号和双或号用于执行条件命令，例如 command1 &amp;&amp; command2 将会先执行 command1，只有在 command1 执行成功后才会执行 command2，而 command1 || command2 则相反，只有在 command1 执行失败后才会执行 command2。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># [[ 1 > 2 ]] &amp;&amp; printf "true\n" || printf "false\n"</span><span class="token boolean">false</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># [[ 3 > 2 ]] &amp;&amp; printf "true\n" || printf "false\n"</span><span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>$()</code>：美元符号加括号用于执行子命令，并将其输出作为变量的值，例如 files=$(ls) 将会将当前目录下的文件列表保存到 files 变量中。<br>“ 和 ‘：双引号和单引号用于引用字符串，其中双引号会展开变量，而单引号则不会，例如 echo “My home directory is $HOME” 将会输出 My home directory is /home/user，而 echo ‘My home directory is $HOME’ 则会输出 My home directory is $HOME。<br><code>\</code>：反斜杠用于转义字符，例如 \n 表示换行符，\t 表示制表符等。<br><code>:</code>：冒号用于定义空命令，例如 : 就是一个空命令，它不会做任何事情。<br><code>source</code> 和 <code>.</code>：source 命令和 . 符号用于执行脚本文件，例如 source myscript.sh 或者 . myscript.sh 将会执行 myscript.sh 脚本文件。<br><code>ctrl+c</code> 和 <code>ctrl+z</code>：ctrl+c 组合键用于终止当前正在运行的命令，而 ctrl+z 组合键用于将当前正在运行的命令挂起到后台，并返回命令提示符。</p></blockquote><h3 id="Shell：交互-非交互-登录-非登录Shell的区别"><a href="#Shell：交互-非交互-登录-非登录Shell的区别" class="headerlink" title="Shell：交互/非交互/登录/非登录Shell的区别"></a>Shell：交互/非交互/登录/非登录Shell的区别</h3><blockquote><p> Bash Shell</p></blockquote><table><thead><tr><th></th><th><strong>交互式</strong></th><th><strong>非交互式</strong></th></tr></thead><tbody><tr><td><strong>登录式</strong></td><td><strong>bash –il script.sh</strong> <br> /etc/profile <br> ~/.bash_profile(-&gt; ~/.bashrc -&gt; /etc/bashrc) <br> ~/.bash_login <br> ~/.profile</td><td><strong>bash -l script.sh</strong> <br> /etc/profile <br> ~/.bash_profile(-&gt; ~/.bashrc -&gt; /etc/bashrc) <br> ~/.bash_login <br> ~/.profile <br> $BASH_ENV</td></tr><tr><td><strong>非登录式</strong></td><td><strong>bash –i test.sh</strong><br> ~/.bashrc( -&gt; /etc/bashrc)</td><td><strong>bash test.sh</strong><br>$BASH_ENV</td></tr></tbody></table><blockquote><p>sh</p></blockquote><table><thead><tr><th></th><th><strong>交互式</strong></th><th><strong>非交互式</strong></th></tr></thead><tbody><tr><td><strong>登录式</strong></td><td><strong>bash –il script.sh</strong><br>/etc/profile<br> ~/.profile</td><td><strong>bash -l script.sh</strong><br>/etc/profile<br> ~/.profile</td></tr><tr><td><strong>非登录式</strong></td><td><strong>bash –i test.sh</strong><br>$ENV</td><td><strong>bash test.sh</strong></td></tr></tbody></table><h3 id="bash变量替换用法总结"><a href="#bash变量替换用法总结" class="headerlink" title="bash变量替换用法总结"></a>bash变量替换用法总结</h3><ul><li>假设我们定义了一个变量为：</li></ul><blockquote><p><code>file=/dir1/dir2/dir3/my.file.txt</code></p><p>我们可以用 <code>$&#123; &#125;</code> 分别替换获得不同的值：</p><p><code>$&#123;file#*/&#125;</code>：拿掉第一条 / 及其左边的字串：<code>dir1/dir2/dir3/my.file.txt</code><br><code>$&#123;file##*/&#125;</code>：拿掉最后一条 / 及其左边的字串：<code>my.file.txt</code><br><code>$&#123;file#*.&#125;</code>：拿掉第一个 . 及其左边的字串：<code>file.txt</code><br><code>$&#123;file##*.&#125;</code>：拿掉最后一个 . 及其左边的字串：<code>txt</code><br><code>$&#123;file%/*&#125;</code>：拿掉最后一条 / 及其右边的字串：<code>/dir1/dir2/dir3</code><br><code>$&#123;file%/*&#125;</code>：拿掉第一条 / 及其右边的字串：(空值)<br><code>$&#123;file%.*&#125;</code>：拿掉最后一个 . 及其右边的字串：<code>/dir1/dir2/dir3/my.file</code><br><code>$&#123;file%%.*&#125;</code>：拿掉第一个 . 及其右边的字串：<code>/dir1/dir2/dir3/my</code></p></blockquote><ul><li>记忆的方法为：</li></ul><blockquote><p><code>#</code> 是去掉左边(在键盘上 <code>#</code> 在 <code>$</code> 之左边)</p><p><code>%</code> 是去掉右边(在键盘上 <code>%</code> 在 <code>$</code> 之右边)<br>单一符号是最小匹配；两个符号是最大匹配。</p></blockquote><ul><li>还可以按下标取指定长度的子串：</li></ul><blockquote><p><code>$&#123;file:0:5&#125;</code>：提取最左边的 5 个字：<code>/dir1</code><br><code>$&#123;file:5:5&#125;</code>：提取第 5 个字右边的连续 5 个字：<code>/dir2</code></p></blockquote><ul><li>我们也可以对变量值里的字串作替换：</li></ul><blockquote><p><code>$&#123;file/dir/path&#125;</code>：将第一个 dir 提换为 path：<code>/path1/dir2/dir3/my.file.txt</code><br><code>$&#123;file//dir/path&#125;</code>：将全部 dir 提换为 path：<code>/path1/path2/path3/my.file.txt</code></p></blockquote><ul><li>利用 <code>$&#123; &#125;</code> 还可针对不同的变数状态赋值(没设定、空值、非空值)：</li></ul><blockquote><p><code>$&#123;file-my.file.txt&#125;</code> ：假如 <code>$file</code> 为空值，则使用 my.file.txt 作默认值。(保留没设定及非空值)<br><code>$&#123;file:-my.file.txt&#125; </code>：假如 <code>$file</code> 没有设定或为空值，则使用 my.file.txt 作默认值。 (保留非空值)<br><code>$&#123;file+my.file.txt&#125;</code> ：不管 <code>$file</code> 为何值，均使用 my.file.txt 作默认值。 (不保留任何值)<br><code>$&#123;file:+my.file.txt&#125;</code> ：除非 <code>$file</code> 为空值，否则使用 my.file.txt 作默认值。 (保留空值)<br><code>$&#123;file=my.file.txt&#125;</code> ：若 <code>$file</code> 没设定，则使用 my.file.txt 作默认值，同时将 $file 定义为非空值。 (保留空值及非空值)<br><code>$&#123;file:=my.file.txt&#125;</code> ：若 <code>$file</code> 没设定或为空值，则使用 my.file.txt 作默认值，同时将 $file 定义为非空值。 (保留非空值)<br><code>$&#123;file?my.file.txt&#125;</code> ：若 <code>$file</code> 没设定，则将 my.file.txt 输出至 STDERR。 (保留空值及非空值))<br><code>$&#123;file:?my.file.txt&#125;</code> ：若 <code>$file</code> 没设定或为空值，则将 my.file.txt 输出至 STDERR。 (保留非空值)</p></blockquote><ul><li>还有， <code>$&#123;＃var&#125;</code> 可计算出变量值的长度：</li><li><code>$&#123;＃&#125;</code> 这个写法与hexo冲突，这里使用了全角<code>#</code>字符</li></ul><blockquote><p><code>$&#123;＃file&#125;</code> 可得到 27 ，因为 <code>/dir1/dir2/dir3/my.file.txt</code> 刚好是 27 个字<br>接下来介绍一下  bash 的数组(array)处理方法：<br>一般而言，<code>A=&quot;a b c def&quot;</code> 这样的变量只是将 <code>$A</code> 替换为一个单一的字串，<br>但是改为 <code>A=(a b c def)</code> ，则是将 <code>$A</code> 定义为数组。</p></blockquote><ul><li>bash 的数组替换方法可参考如下方法：</li></ul><blockquote><p><code>$&#123;A[@]&#125;</code> 或 <code>$&#123;A[*]&#125;</code> 可得到 <code>a b c def</code> (全部数组)<br><code>$&#123;A[0]&#125;</code> 可得到 <code>a</code> (第一个数组)，<code>$&#123;A[1]&#125; </code>则为第二个数组…<br><code>$&#123;＃A[@]&#125;</code> 或 <code>$&#123;＃A[*]&#125;</code> 可得到 4 (全部数组数量)<br><code>$&#123;＃A[0]&#125; </code>可得到 1 (即第一个数组(a)的长度)，<code>$&#123;A[3]&#125;</code> 可得到 3 (第一个数组(def)的长度)<br><code>A[3]=xyz</code> 则是将第 4 个数组重新定义为 <code>xyz ...</code></p></blockquote><h3 id="Shell：mktemp创建临时文件"><a href="#Shell：mktemp创建临时文件" class="headerlink" title="Shell：mktemp创建临时文件"></a>Shell：mktemp创建临时文件</h3><p>平常创建临时文件。</p><pre class="line-numbers language-none"><code class="language-none">touch &#x2F;tmp&#x2F;.tempfile&gt;&#x2F;tmp&#x2F;.tempfile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>使用mktemp命令创建临时文件。</p><pre class="line-numbers language-none"><code class="language-none">mktemp [options] [TEMPLATE]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数说明。</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>-d | –directory</td><td>创建目录</td></tr><tr><td>-u | –dry-run</td><td>不创建任何文件，只打印一个名字</td></tr><tr><td>-p DIR</td><td>在DIR目录下创建临时文件</td></tr><tr><td>-t TEMPLATE</td><td>在$TMPDIR文件夹下，以模板TEMPLATE创建临时文件</td></tr><tr><td>-tmpdir=[dir]</td><td>指定临时文件的路径，如果没有指定dir则使用变量$TMPDIR</td></tr><tr><td>TEMPLATE</td><td>临时文件名模板，名字中应包含至少3个以上的X如果没有指定，默认模板是tmp.XXXXXXXXXX</td></tr></tbody></table><p>结合前面介绍的trap命令进行临时文件清理，代码如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用trap在程序结束时清理临时文件</span><span class="token builtin class-name">trap</span> <span class="token string">'rm -f "$TMPFILE"'</span> EXIT<span class="token comment"># 创建临时文件，并记录到环境变量TMPFILE中</span><span class="token assign-left variable">TMPFILE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp<span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><blockquote><p>写一个检测脚本，用来检测本机所有磁盘分区读写是否都正常。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">DiskList</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">df</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"^/dev/|:"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span><span class="token variable">)</span></span><span class="token assign-left variable">Key</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$DiskList</span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token function">touch</span> <span class="token variable">$i</span>/.<span class="token variable">$Key</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$i</span>/.<span class="token variable">$Key</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>  <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$i</span> 读写异常<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">||</span> <span class="token punctuation">\</span>  <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$i</span> 读写正常<span class="token entity" title="\n">\n</span>"</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins安装</title>
      <link href="/posts/9a7f448e.html"/>
      <url>/posts/9a7f448e.html</url>
      
        <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><blockquote><p>Anolis OS 8.8<br>4C8G<br>java 8</p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><a href="https://pkg.jenkins.io/redhat-stable/">官方文档</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.keydnf <span class="token function">install</span> fontconfig java-11-openjdk <span class="token parameter variable">-y</span><span class="token comment"># 默认安装jenkins-lts</span>dnf <span class="token function">install</span> jenkins <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><blockquote><p>启动报错，没有显示是jdk版本问题。但是机器需要jdk8环境要保持旧的ci工具运行。<br>jenkins依赖jdk11，启动方式为systemctl</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑jenkins.service文件</span><span class="token function">vi</span> /usr/lib/systemd/system/jenkins.service<span class="token comment"># 找到ExecStart这一项</span><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/jenkins<span class="token comment"># 编辑/usr/bin/jenkins</span><span class="token function">vi</span> /usr/bin/jenkins<span class="token comment"># 找到java环境变量</span><span class="token function-name function">infer_java_cmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/etc/alternatives/java_sdk_11_openjdk   <span class="token comment"># 这一行是新增的</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$&#123;JENKINS_JAVA_CMD&#125;</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token parameter variable">-x</span> <span class="token string">"<span class="token variable">$&#123;JENKINS_JAVA_CMD&#125;</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">return</span> <span class="token number">0</span>    <span class="token keyword">fi</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$&#123;JAVA_HOME&#125;</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token parameter variable">-x</span> <span class="token string">"<span class="token variable">$&#123;JAVA_HOME&#125;</span>/bin/java"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token assign-left variable">JENKINS_JAVA_CMD</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;JAVA_HOME&#125;</span>/bin/java"</span>        <span class="token builtin class-name">return</span> <span class="token number">0</span>    <span class="token keyword">fi</span>    <span class="token assign-left variable">JENKINS_JAVA_CMD</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> <span class="token function">java</span><span class="token variable">)</span></span>"</span> <span class="token operator">||</span> <span class="token builtin class-name">return</span> <span class="token string">"<span class="token variable">$?</span>"</span><span class="token punctuation">&#125;</span><span class="token comment"># 重启jenkins即可</span><span class="token comment"># ------ 割了 ------</span><span class="token comment"># 编辑初始化文件</span><span class="token function">vi</span> /etc/init.d/jenkins<span class="token comment"># 找到JENKINS_JAVA_CMD，修改candidates</span><span class="token assign-left variable">candidates</span><span class="token operator">=</span><span class="token string">"/usr/lib/jvm/java-11-openjdk-11.0.19.0.7-1.0.1.an8.x86_64/bin/java"</span><span class="token keyword">for</span> <span class="token for-or-select variable">candidate</span> <span class="token keyword">in</span> <span class="token variable">$candidates</span><span class="token punctuation">;</span> <span class="token keyword">do</span>    <span class="token punctuation">[</span> <span class="token parameter variable">-x</span> <span class="token string">"<span class="token variable">$JENKINS_JAVA_CMD</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">break</span>    <span class="token assign-left variable">JENKINS_JAVA_CMD</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$candidate</span>"</span><span class="token keyword">done</span><span class="token comment"># 注意这里修改完并没有用，所以才直接修改的/usr/bin/jenkins</span><span class="token comment"># 并且/usr/bin/jenkins文件中并没有找到引用/etc/init.d/jenkins的行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start jenkins<span class="token comment"># 初始密码，记住密码浏览器要用。</span><span class="token function">cat</span> /var/lib/jenkins/secrets/initialAdminPassword2da3ae75b3af4f69a0d5a48993dbaf8e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="nginx代理"><a href="#nginx代理" class="headerlink" title="nginx代理"></a>nginx代理</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 内网代理</span><span class="token punctuation">[</span>root@nginx conf.d<span class="token punctuation">]</span><span class="token comment"># cat jenkins.conf</span>server <span class="token punctuation">&#123;</span>    listen       <span class="token number">80</span><span class="token punctuation">;</span>    server_name  jenkins.domain.com<span class="token punctuation">;</span>    access_log /home/app/logs/jenkins_access.log  main<span class="token punctuation">;</span>    error_log  /home/app/logs/jenkins_error.log<span class="token punctuation">;</span>    location / <span class="token punctuation">&#123;</span>        proxy_pass   http://192.168.1.17:8080/<span class="token punctuation">;</span>        proxy_set_header Host      <span class="token variable">$host</span><span class="token punctuation">;</span>        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        <span class="token comment"># iframe 重定向</span>        proxy_set_header X-Forwarded-Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-Port <span class="token variable">$server_port</span><span class="token punctuation">;</span>        client_max_body_size  50000m<span class="token punctuation">;</span>        client_body_buffer_size 128k<span class="token punctuation">;</span>        <span class="token comment">#websocket 配置</span>        proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>        proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># 公网二次代理</span><span class="token punctuation">[</span>root@localhost wujiops<span class="token punctuation">]</span><span class="token comment"># cat jenkins.conf</span>server <span class="token punctuation">&#123;</span>    listen       <span class="token number">80</span><span class="token punctuation">;</span>    server_name  jenkins.domain.com<span class="token punctuation">;</span>    rewrite ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$  https://<span class="token variable">$host</span><span class="token variable">$1</span> permanent<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>server <span class="token punctuation">&#123;</span>    listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>    server_name jenkins.domain.com<span class="token punctuation">;</span>    ssl_certificate /etc/nginx/cert/domain.com.cer<span class="token punctuation">;</span>    ssl_certificate_key /etc/nginx/cert/domain.com.key<span class="token punctuation">;</span>    ssl_session_timeout 5m<span class="token punctuation">;</span>    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256::<span class="token operator">!</span>MD5<span class="token punctuation">;</span>    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3<span class="token punctuation">;</span>    ssl_prefer_server_ciphers on<span class="token punctuation">;</span>    add_header Strict-Transport-Security <span class="token string">"max-age=31536000"</span><span class="token punctuation">;</span>    access_log /home/logs/jenkins_access.log  main<span class="token punctuation">;</span>    error_log  /home/logs/jenkins_error.log<span class="token punctuation">;</span>    location / <span class="token punctuation">&#123;</span>        proxy_pass   http://10.0.0.18/<span class="token punctuation">;</span>        proxy_set_header Host      <span class="token variable">$host</span><span class="token punctuation">;</span>        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-Port <span class="token variable">$server_port</span><span class="token punctuation">;</span>        client_max_body_size  50000m<span class="token punctuation">;</span>        client_body_buffer_size 128k<span class="token punctuation">;</span>        proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>        proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>打开浏览器输入jenkins.domain.com访问，</p><p>按提示输入初始密码<code>2da3ae75b3af4f69a0d5a48993dbaf8e</code></p></blockquote><p><img src="/medias/img/jenkins/image-20230708221207629.png"></p><blockquote><p>如果你不知道安装什么插件，安装推荐插件即可。</p></blockquote><p><img src="/medias/img/jenkins/image-20230708221424682.png"></p><blockquote><p>等待安装完成</p></blockquote><p><img src="/medias/img/jenkins/image-20230708221550222.png"></p><blockquote><p>创建管理员账号</p></blockquote><p><img src="/medias/img/jenkins/image-20230708222248041.png"></p><blockquote><p>配置访问URL，保存进入即可。</p></blockquote><p><img src="/medias/img/jenkins/image-20230708222346589.png"></p><blockquote><p>这里提示意思是创建jenkins-slave使每个环境有单独的构建机器。不需要的话，这里Dismiss即可。</p></blockquote><p><img src="/medias/img/jenkins/image-20230708222459752.png"></p><blockquote><p>提示反向代理错误可以不用管。<a href="https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-nginx/">正确的配置参考官方文档</a></p></blockquote><h3 id="插件加速"><a href="#插件加速" class="headerlink" title="插件加速"></a>插件加速</h3><blockquote><p>一般不需要配置此项。配置清华加速源，替换升级站点URL即可。</p><p>替换为：<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/current/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/current/update-center.json</a></p></blockquote><p><img src="/medias/img/jenkins/image-20230708223612169.png"></p>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系统初始化脚本</title>
      <link href="/posts/dc532cfb.html"/>
      <url>/posts/dc532cfb.html</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token comment"># @File    :   init.sh</span><span class="token comment"># @Time    :   2021/12/06 15:41:17</span><span class="token comment"># @Author  :   Roxn</span><span class="token comment"># @Email   :   158970251@qq.com</span><span class="token comment"># @Software:   VS Code</span><span class="token comment"># 日志存放路径</span><span class="token assign-left variable">log</span><span class="token operator">=</span><span class="token string">"/home/logs/init.log"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-e</span> <span class="token variable">$log</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-v</span> <span class="token assign-left variable">FS</span><span class="token operator">=</span>/ <span class="token parameter variable">-v</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span>/ <span class="token string">'&#123;$NF=""; print $0&#125;'</span><span class="token variable">)</span></span>  <span class="token function">touch</span> <span class="token variable">$log</span><span class="token keyword">fi</span><span class="token comment"># 如果执行过程中有错误信息均输出到日志文件中</span><span class="token comment"># ex: 2>&amp;1</span><span class="token assign-left variable">fsize</span><span class="token operator">=</span><span class="token number">2000000</span><span class="token builtin class-name">exec</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token comment"># 日志函数</span><span class="token comment"># 参数一，级别: INFO WARN ERROR</span><span class="token keyword">function</span> <span class="token function-name function">LOGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment"># local curtime</span>  <span class="token assign-left variable">curtime</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%F %T"</span><span class="token variable">)</span></span>  <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%H_%M_%S<span class="token variable">)</span></span>  <span class="token comment"># local cursize</span>  <span class="token assign-left variable">cursize</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $log <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-c</span><span class="token variable">)</span></span>  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$fsize</span> <span class="token parameter variable">-lt</span> <span class="token variable">$cursize</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token function">mv</span> <span class="token variable">$log</span><span class="token punctuation">&#123;</span>,.<span class="token variable">$timestamp</span><span class="token punctuation">&#125;</span>    <span class="token function">touch</span> <span class="token variable">$log</span>  <span class="token keyword">fi</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">INFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  LOGS  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[32m[INFO]<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">WARN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  LOGS  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[33m[WARN]<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">ERROR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  LOGS  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[31m[ERROR]<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token assign-left variable">workdir</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span><span class="token operator">&lt;&lt;</span><span class="token string">'EOF'check init file 禁止2次初始化操作check os 系统版本检查7-8 对类centos7-8的国产Linux系统初始化(opencloudos8 anolins7-8 centos7-8)，未在openeuler和9系统上面测试。原理上可以在Alibaba Cloud Linux系统上运行，但是未做测试。EOF</span>INFO <span class="token string">"checking /etc/.init"</span><span class="token comment"># [[ -e ~/.init ]] &amp;&amp; printf "true\n" || printf "false\n"</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-e</span> /.init <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  WARN <span class="token string">"line <span class="token variable">$LINENO</span>. Warnning inited."</span>  <span class="token builtin class-name">printf</span> <span class="token string">"line <span class="token variable">$LINENO</span>. Warnning inited.<span class="token entity" title="\n">\n</span>"</span>  <span class="token builtin class-name">exit</span> <span class="token number">999</span><span class="token keyword">else</span>  INFO <span class="token string">"check OK"</span>  <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$curtime</span> inited<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">></span> /.init<span class="token keyword">fi</span>INFO <span class="token string">"chekck /etc/os-release"</span><span class="token assign-left variable">SysList</span><span class="token operator">=</span><span class="token string">"CentOS Anolis OpenCloudOS"</span><span class="token assign-left variable">OS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">head</span> <span class="token parameter variable">-1</span> /etc/os-release<span class="token variable">)</span></span><span class="token comment"># [[ "$OS" =~ "Anolis" ]] || [[ "$OS" =~ "CentOS" ]] &amp;&amp; printf "pass\n" || printf "error\n"</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$OS</span>"</span> <span class="token operator">=~</span> <span class="token string">"Anolis"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$OS</span>"</span> <span class="token operator">=~</span> <span class="token string">"CentOS"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$OS</span>"</span> <span class="token operator">=~</span> <span class="token string">"OpenCloudOS"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  INFO <span class="token string">"chekck /etc/os-release pass"</span><span class="token keyword">else</span>  WARN <span class="token string">"line <span class="token variable">$LINENO</span>. Warnning check os err."</span>  <span class="token builtin class-name">printf</span> <span class="token string">"line <span class="token variable">$LINENO</span>. Warnning check os err.<span class="token entity" title="\n">\n</span>"</span>  <span class="token builtin class-name">exit</span> <span class="token number">998</span><span class="token keyword">fi</span><span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> ^VERSION<span class="token operator">=</span> /etc/os-release <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-Eo</span> <span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+ <span class="token operator">|</span> <span class="token function">cut</span> -d. <span class="token parameter variable">-f1</span><span class="token variable">)</span></span><span class="token assign-left variable">SysVersion</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span> /etc/os-release <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token punctuation">\</span>" <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$Version</span> <span class="token operator">!=</span> <span class="token number">7</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$Version</span> <span class="token operator">!=</span> <span class="token number">8</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    WARN <span class="token string">"line <span class="token variable">$LINENO</span>. check OS error."</span>    <span class="token builtin class-name">printf</span> <span class="token string">"line <span class="token variable">$LINENO</span>. check OS error."</span>    <span class="token builtin class-name">exit</span> <span class="token number">997</span><span class="token keyword">else</span>    INFO <span class="token string">"<span class="token variable">$SysVersion</span> check pass"</span><span class="token keyword">fi</span>INFO <span class="token string">"install package &amp;&amp; update"</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  INFO <span class="token string">"yum -y install lrzsz vim wget epel-release ntp unzip bash-completion"</span>  yum <span class="token parameter variable">-y</span> <span class="token function">install</span> lrzsz <span class="token function">vim</span> <span class="token function">wget</span> epel-release ntp <span class="token function">unzip</span> bash-completion <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  INFO <span class="token string">"yum update -y"</span>  yum update <span class="token parameter variable">-y</span> <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span class="token keyword">elif</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  INFO <span class="token string">"rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm"</span>  <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  INFO <span class="token string">"dnf -y install lrzsz vim wget epel-release glibc-langpack-en wntp bash-completion"</span>  dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> lrzsz <span class="token function">vim</span> <span class="token function">wget</span> epel-release glibc-langpack-en wntp bash-completion <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  INFO <span class="token string">"dnf update -y"</span>  dnf update <span class="token parameter variable">-y</span> <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span class="token keyword">fi</span>INFO <span class="token string">"close selinux &amp; firewald"</span>INFO <span class="token string">"set /etc/selinux/config SELINUX=disabled"</span><span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/configsetenforce <span class="token number">0</span>INFO <span class="token string">"systemctl disable firewalld"</span>systemctl stop firewalldsystemctl disable firewalld <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>INFO <span class="token string">"set sshd &amp; vim &amp; profile"</span>INFO <span class="token string">"set /etc/ssh/sshd_config UseDNS no"</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'/#UseDNS/a UseDNS\ no'</span> /etc/ssh/sshd_config<span class="token keyword">elif</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'s/^#\(UseDNS no\)/\1/'</span> /etc/ssh/sshd_config<span class="token keyword">fi</span>systemctl restart sshdINFO <span class="token string">"alias vi=vim &amp; tabstop &amp; F9"</span><span class="token builtin class-name">echo</span> <span class="token string">'alias vi=vim'</span> <span class="token operator">>></span> /etc/profile<span class="token function">cat</span> <span class="token operator">>></span> /root/.vimrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFset tabstop=4set shiftwidth=4set expandtabset numberset pastetoggle=&lt;F9>set pasteEOF</span>INFO <span class="token string">"set sysctl.conf"</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF# 开启SYN Cookies，当SYN等待队列溢出时，启用cookies来处理，可以防范少量的SYN攻击，默认为0，表示关闭net.ipv4.tcp_syncookies = 1# 允许将TIME_WAIT sockets重新用于新的TCP连接，默认为0，表示关闭net.ipv4.tcp_tw_reuse = 1# 允许将TIME_WAIT sockets快速回收以便利用，默认为0，表示关闭，需要同时开启 net.ipv4.tcp_timestamps 才能生效net.ipv4.tcp_tw_recycle = 1net.ipv4.tcp_timestamps = 1# 设置TCP三次请求的fin状态超时net.ipv4.tcp_fin_timeout = 30# 设置TCP 发送keepalive的频度，默认的缺省为2小时，600秒表示10分钟，表示服务器以10分钟发送keepalive消息net.ipv4.tcp_keepalive_time = 600# 探测包发送的时间间隔设置为2秒，默认75秒net.ipv4.tcp_keepalive_intvl = 2# 如果对方不给予应答，探测包发送的次数，默认9次net.ipv4.tcp_keepalive_probes = 2# 设置本地端口范围，缺省情况下: 32768到61000，现在改为 1024 到 65000，最小值不能设置太低,否则占用了正常端口net.ipv4.ip_local_port_range = 1024 65000# 表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多的网络连接数net.ipv4.tcp_max_syn_backlog = 8192# 设置保持TIME_WAIT的最大数量，如果超过这个数量，TIME_WAIT将立刻清楚并打印警告信息，默认为180000，改为5000.此项参数可以控制TIME_WAIT的最大数量,避免Squid服务器被大量的TIME_WAIT拖死net.ipv4.tcp_max_tw_buckets = 5000# 表示SYN队列的长度，选项为服务器端用于记录那些尚未收到客户端确认信息的连接请求的最大值，该参数对应系统路径为: /proc/sys/net/ipv4/tcp_max_syn_backlognet.ipv4.tcp_max_syn_backlog = 4096# 增加tcp缓冲区大小，tcp_rmem表示接受数据缓冲区范围，tcp_wmem表示发送数据缓冲区范围，单位Byte，最大64Mnet.ipv4.tcp_rmem = 4096 87380 67108864net.ipv4.tcp_wmem = 4096 65536 67108864# TCP失败重传次数,默认值15，意味着重传15次才彻底放弃，可减少到5，以尽早释放内核资源net.ipv4.tcp_retries2 = 5# 选项默认值是128，这个参数用于调节系统同时发起的tcp连接数，在高并发请求中，默认的值可能会导致连接超时或重传，因此，需要结合并发请求数来调节此值。该参数对应系统路径为: /proc/sys/net/core/somaxconn 128net.core.somaxconn = 4096# 启用timewait 快速回收net.ipv4.tcp_tw_recycle = 1EOF</span><span class="token keyword">elif</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF# 开启SYN Cookies，当SYN等待队列溢出时，启用cookies来处理，可以防范少量的SYN攻击，默认为0，表示关闭net.ipv4.tcp_syncookies = 1# 允许将TIME_WAIT sockets重新用于新的TCP连接，默认为0，表示关闭net.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_timestamps = 1# 设置TCP三次请求的fin状态超时net.ipv4.tcp_fin_timeout = 30# 设置TCP 发送keepalive的频度，默认的缺省为2小时，600秒表示10分钟，表示服务器以10分钟发送keepalive消息net.ipv4.tcp_keepalive_time = 600# 探测包发送的时间间隔设置为2秒，默认75秒net.ipv4.tcp_keepalive_intvl = 2# 如果对方不给予应答，探测包发送的次数，默认9次net.ipv4.tcp_keepalive_probes = 2# 设置本地端口范围，缺省情况下: 32768到61000，现在改为 1024 到 65000，最小值不能设置太低,否则占用了正常端口net.ipv4.ip_local_port_range = 1024 65000# 表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多的网络连接数net.ipv4.tcp_max_syn_backlog = 8192# 设置保持TIME_WAIT的最大数量，如果超过这个数量，TIME_WAIT将立刻清楚并打印警告信息，默认为180000，改为5000.此项参数可以控制TIME_WAIT的最大数量,避免Squid服务器被大量的TIME_WAIT拖死net.ipv4.tcp_max_tw_buckets = 5000# 表示SYN队列的长度，选项为服务器端用于记录那些尚未收到客户端确认信息的连接请求的最大值，该参数对应系统路径为: /proc/sys/net/ipv4/tcp_max_syn_backlognet.ipv4.tcp_max_syn_backlog = 4096# 增加tcp缓冲区大小，tcp_rmem表示接受数据缓冲区范围，tcp_wmem表示发送数据缓冲区范围，单位Byte，最大64Mnet.ipv4.tcp_rmem = 4096 87380 67108864net.ipv4.tcp_wmem = 4096 65536 67108864# TCP失败重传次数,默认值15，意味着重传15次才彻底放弃，可减少到5，以尽早释放内核资源net.ipv4.tcp_retries2 = 5# 选项默认值是128，这个参数用于调节系统同时发起的tcp连接数，在高并发请求中，默认的值可能会导致连接超时或重传，因此，需要结合并发请求数来调节此值。该参数对应系统路径为: /proc/sys/net/core/somaxconn 128net.core.somaxconn = 4096# 设置tcp确认超时时间 300秒，默认 432000 秒（5天）net.netfilter.nf_conntrack_tcp_timeout_established = 300# 设置tcp等待时间 12秒，超过12秒自动放弃，默认120秒net.netfilter.nf_conntrack_tcp_timeout_time_wait = 12# 设置tcp关闭等待时间60秒，超过60秒自动关闭，默认60秒net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60# 设置tcp fin状态的超时时间为120秒,超过该时间自动关闭，默认120秒net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120EOF</span><span class="token keyword">fi</span><span class="token function">sysctl</span> <span class="token parameter variable">-p</span>INFO <span class="token string">"set ntp server"</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  /usr/sbin/ntpdate ntp.ntsc.ac.cn  <span class="token function">crontab</span> <span class="token parameter variable">-l</span> <span class="token operator">></span> /tmp/.txt <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  <span class="token builtin class-name">echo</span> <span class="token string">"*/30 * * * * /usr/sbin/ntpdate ntp.ntsc.ac.cn > /dev/null 2>&amp;1"</span> <span class="token operator">>></span> /tmp/.txt  <span class="token function">crontab</span> /tmp/.txt  <span class="token builtin class-name">echo</span> <span class="token string">"alias ntp='/usr/sbin/ntpdate ntp.ntsc.ac.cn'"</span> <span class="token operator">>></span> /etc/profile.d/ntp.sh  systemctl <span class="token builtin class-name">enable</span> ntpd <span class="token operator">>></span> <span class="token variable">$log</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  systemctl start ntpd  systemctl restart crond.service<span class="token keyword">elif</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">crontab</span> <span class="token parameter variable">-l</span> <span class="token operator">></span> /tmp/.txt <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>  <span class="token builtin class-name">echo</span> <span class="token string">"*/30 * * * * /usr/local/bin/ntpdate ntp.ntsc.ac.cn > /dev/null 2>&amp;1"</span> <span class="token operator">>></span> /tmp/.txt  <span class="token function">crontab</span> /tmp/.txt  systemctl restart crond.service<span class="token keyword">fi</span>INFO <span class="token string">"set timezone"</span>timedatectl set-timezone Asia/ShanghaiINFO <span class="token string">"set hwclock"</span>/usr/sbin/hwclock <span class="token parameter variable">--systohc</span>/usr/sbin/hwclock <span class="token parameter variable">-w</span>INFO <span class="token string">"set limits.conf"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF* soft nofile 190000* hard nofile 200000* soft nproc 252144* hadr nproc 262144EOF</span>INFO <span class="token string">"set history"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/bashrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTFILESIZE=10000000HISTSIZE=200HISTTIMEFORMAT='%F %T 'export HISTTIMEFORMATEOF</span>INFO <span class="token string">"unset MAILCHECK"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTSIZE=200PROMPT_COMMAND="history -a"shopt -s histappendunset MAILCHECKEOF</span><span class="token builtin class-name">source</span> /etc/profileINFO <span class="token string">"set /etc/hosts"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts<span class="token operator">&lt;&lt;</span><span class="token string">EOF192.168.1.30 nnv nas192.168.1.31 node1192.168.1.32 node2192.168.1.33 node3192.168.1.35 gitlab gitlab.roxn.cnEOF</span>INFO <span class="token string">"set /usr/lib/systemd/system/openvpn@.service"</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Version</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">cat</span> <span class="token operator">>></span> /usr/lib/systemd/system/openvpn@.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[Unit]Description=OpenVPN Robust And Highly Flexible Tunneling Application On %IAfter=network.target[Service]Type=notifyPrivateTmp=trueExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf[Install]WantedBy=multi-user.targetEOF</span><span class="token keyword">fi</span><span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> anolis </tag>
            
            <tag> init </tag>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>笔记(Ⅰ)</title>
      <link href="/posts/9a736baf.html"/>
      <url>/posts/9a736baf.html</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-正则表达式"><a href="#vscode-正则表达式" class="headerlink" title="vscode 正则表达式"></a>vscode 正则表达式</h2><p><a href="https://learn.microsoft.com/zh-cn/dotnet/standard/base-types/regular-expression-language-quick-reference#character-escapes">参考microsoft文章</a></p><p>使用VSCode进行查找、替换时，经常需要用到正则表达式，一段时间不用就忘了，每次要用的时候都要耽误很多时间去查找，所以整理了一份很全的放在这里。这个其实是.NET使用的正则表达式，VSCode也是一样的，微软系的产品（比如Visual Studio等）应该都是使用这个标准的。</p><p>常用：</p><p>注意事项：在VSCode中使用时，要先把通配符开关打开（开关是查找输入框右边的”.*”符号）</p><table><thead><tr><th>转义字符</th><th>匹配内容</th></tr></thead><tbody><tr><td>\t</td><td>tab</td></tr><tr><td>\r</td><td>回车符号\r</td></tr><tr><td>\n</td><td>换行符号\n</td></tr><tr><td>\</td><td>特殊符号转义，如”*“ ，转义后匹配的是字符”*”， “(“ 匹配的是括号”(“</td></tr><tr><td>[字符序列]</td><td>匹配[ ]中的任意字符，如[ae]，字符a和字符e均匹配</td></tr><tr><td>[^字符序列]</td><td>匹配不在[ ]中的任意字符，如[^ae]除了a和e，其他字符都匹配</td></tr><tr><td>[字符1-字符2]</td><td>匹配在[ ]之间的任意字符，如[a-x]，就是匹配a和x之间的所有字符（包括a和x）</td></tr><tr><td>.</td><td>匹配任意单个字符(除了\n)</td></tr><tr><td>\w</td><td>匹配所有单词字符（如”a”，”3”，”E”，但不匹配”?”，”.”等）</td></tr><tr><td>\W</td><td>和\w相反，匹配所有非单词字符</td></tr><tr><td>\s</td><td>匹配空格</td></tr><tr><td>\S</td><td>和\s相反，匹配非空格</td></tr><tr><td>\d</td><td>匹配数字字符，如”1”，”4”，”9”等</td></tr><tr><td>\D</td><td>和\d相反，匹配除了数字字符外的其他字符</td></tr><tr><td>*</td><td>将前面的元素匹配0到多次，如”\d*.\d”，可以匹配”19.9”，”.0”,”129.9”</td></tr><tr><td>+</td><td>将前面的元素匹配1到多次，如”be+”，可以匹配”be”， “beeeeee”</td></tr><tr><td>？</td><td>将前面的元素匹配0次或者一次，如”rai?n” 可以且只可以匹配 “ran” 或者 “rain”</td></tr><tr><td>{n}</td><td>n是个数字，将前面的元素匹配n次，如”be{3}”可以且只可以匹配 “beee”</td></tr><tr><td>{n, m}</td><td>将前面的元素匹配至少n次，最多m次，如”be{1,3}” 可以且只可以匹配”be”,”bee”, “beee”</td></tr><tr><td>|</td><td>相当于”或”,表示匹配由|分割的任意一个元素，如the(e| is | at)，可以匹配”the”, “this”, “that”</td></tr><tr><td>$n</td><td>n是个数字，这个是替换时使用括号（ ）将匹配的patter分割成了几个元素，然后在替换的patter里面使用，类似于变量。 如果查找patter是”(\w+)(\s)(\w+)”,那么$1就是(\w+),$2是(\s),$3是(\w+)，替换patter是$3$2$1,那么替换结果就是(\w+)(\s)(\w+)。 假设匹配到的是”one two”，那么$1,$2,$3分别为”one”, “ “, “two”，替换后的结果为”two one”.</td></tr></tbody></table><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><pre class="line-numbers language-none"><code class="language-none">7z&#x3D;&#x3D;&#x3D;拥有极高压缩比的开源压缩软件。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>替换为</p><pre class="line-numbers language-none"><code class="language-none">title: 7z命令summary: 拥有极高压缩比的开源压缩软件。tags:  - command  - 7z<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>匹配</p><pre class="line-numbers language-none"><code class="language-none">(\w+)&#x3D;&#x3D;&#x3D;$(.*)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>替换</p><pre class="line-numbers language-none"><code class="language-none">title: $1命令summary: $2tags:  - command  - $1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="linux-运行-net程序"><a href="#linux-运行-net程序" class="headerlink" title="linux 运行.net程序"></a>linux 运行.net程序</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装yum源</span><span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm<span class="token comment"># 安装.net运行工具和依赖</span>yum <span class="token function">install</span> dotnet-sdk-3.1 aspnetcore-runtime-3.1 dotnet-runtime-3.1 <span class="token parameter variable">-y</span><span class="token comment"># 将与.exe同名的.dll文件放入后台运行即可</span><span class="token function">nohup</span> dotnet FlowTestServer.dll <span class="token assign-left variable">urls</span><span class="token operator">=</span><span class="token string">"http://*:5000"</span> <span class="token operator">>></span> logs.log <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span class="token comment"># 查看端口是否启用</span>ss <span class="token parameter variable">-anptl</span> <span class="token operator">|</span> <span class="token function">grep</span> :5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error(Ⅳ)</title>
      <link href="/posts/3d8c0ab1.html"/>
      <url>/posts/3d8c0ab1.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS8重启Network新的配置不生效"><a href="#CentOS8重启Network新的配置不生效" class="headerlink" title="CentOS8重启Network新的配置不生效"></a>CentOS8重启Network新的配置不生效</h1><p>开始涉及到以下命令不生效</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nmcli c reload ens160systemctl restart network<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="网卡配置如下"><a href="#网卡配置如下" class="headerlink" title="网卡配置如下"></a>网卡配置如下</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">"Ethernet"</span><span class="token assign-left variable">PROXY_METHOD</span><span class="token operator">=</span><span class="token string">"none"</span><span class="token assign-left variable">BROWSER_ONLY</span><span class="token operator">=</span><span class="token string">"no"</span><span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span><span class="token string">"none"</span><span class="token assign-left variable">DEFROUTE</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">IPV4_FAILURE_FATAL</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">IPV6INIT</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">IPV6_AUTOCONF</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">IPV6_DEFROUTE</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">IPV6_FAILURE_FATAL</span><span class="token operator">=</span><span class="token string">"no"</span><span class="token assign-left variable">IPV6_ADDR_GEN_MODE</span><span class="token operator">=</span><span class="token string">"stable-privacy"</span><span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"ens160"</span><span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">"1f22ea44-481f-410e-b062-7b05fa7a8375"</span><span class="token assign-left variable">DEVICE</span><span class="token operator">=</span><span class="token string">"ens160"</span><span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span><span class="token string">"yes"</span><span class="token assign-left variable">HWADDR</span><span class="token operator">=</span><span class="token string">"00:0C:29:D5:D6:DE"</span><span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token string">"192.168.1.223"</span><span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token string">"24"</span><span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token string">"192.168.1.1"</span><span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token string">"114.114.114.114"</span><span class="token assign-left variable">IPV6_PRIVACY</span><span class="token operator">=</span><span class="token string">"no"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="解决-reload-配置不生效BUG"><a href="#解决-reload-配置不生效BUG" class="headerlink" title="解决 reload 配置不生效BUG"></a>解决 reload 配置不生效BUG</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 测试可用</span><span class="token function">ifdown</span> ens160 <span class="token operator">&amp;&amp;</span> <span class="token function">ifup</span> ens160<span class="token comment"># 测试可用</span>nmcli c reload <span class="token operator">&amp;&amp;</span> nmcli d reapply ens160<span class="token comment"># 测试可用</span>nmcli c reload <span class="token operator">&amp;&amp;</span> nmcli networking off <span class="token operator">&amp;&amp;</span> nmcli networking on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结：以上设置完IP后使用上面的命令可以使新配置生效，涉及到down和off等，一定要一条命令行执行！</p><p>养成好习惯，否则只能去服务器执行up和on了。</p><h2 id="centos8安装ntpdate报错"><a href="#centos8安装ntpdate报错" class="headerlink" title="centos8安装ntpdate报错"></a>centos8安装ntpdate报错</h2><p><code>yum -y install ntpdate</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">未找到匹配的参数： ntpdate错误：没有任何匹配: ntpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="解决思路："><a href="#解决思路：" class="headerlink" title="解决思路："></a>解决思路：</h2><ol><li><p>配置epel源，阿里云Base源（测试不行）</p></li><li><p>安装centos7的ntpdate（原因centos8安装的docker版本是centos7系统版本的）（未测试）</p></li><li><p>更改/etc/chrony.conf授时地址210.72.145.44（中国国家授时中心服务器）（测试通过）</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart chronyd.servicesystemctl <span class="token builtin class-name">enable</span> chronyd.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后通过date查询时间</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hwclock <span class="token parameter variable">-s</span>   <span class="token comment"># 从硬件时钟设置系统时间</span>hwclock <span class="token parameter variable">-w</span>   <span class="token comment"># 从当前系统时间设置硬件时钟</span>hwclock <span class="token parameter variable">--systz</span>   <span class="token comment"># 基于当前时区设置系统时间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="python-TCP服务"><a href="#python-TCP服务" class="headerlink" title="python TCP服务"></a>python TCP服务</h1><p>客户端连接超时自动断开，并不会向TCP server发送断开请求，导致server端一直处于连接状态，客户端重连失败。</p><h2 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h2><ol><li>复现问题</li></ol><p>用tcpdump抓包<code>tcpdump tcp port 10000</code>（结果展示如下：）</p><p>可以看到客户端<code>106.202.127.124</code>主动断开TCP server<code>www.tcpserver.com</code>是正常的（三次握手四次断开）</p><p>当客户端是因为超时断开（处于注二状态，TCPserver未得到回复），或者断网（处于注一状态，未发生挥手）</p><ol start="2"><li>解决问题</li></ol><p>在TCP server设置socket 30s超时，客户端发送消息后，30s没有动作TCP server处于等待连接的状态</p><p>这时候需要客户端主动断开重连即可</p><pre class="line-numbers language-none"><code class="language-none">Timeout.Server is running. Waiting client...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>附录tcpdump抓包内容：</p><pre class="line-numbers language-none"><code class="language-none">①16:59:58.751349 IP 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780 &gt; www.tcpserver.com.ndmp: Flags [S], seq 642708694, win 29200, options [mss 1440,sackOK,TS val 3136578883 ecr 0,nop,wscale 7], length 0②16:59:58.751428 IP www.tcpserver.com.ndmp &gt; 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780: Flags [S.], seq 2548085368, ack 642708695, win 28960, options [mss 1460,sackOK,TS val 750917687 ecr 3136578883,nop,wscale 7], length 0③16:59:58.765865 IP 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780 &gt; www.tcpserver.com.ndmp: Flags [.], ack 1, win 229, options [nop,nop,TS val 3136578896 ecr 750917687], length 0---分割线---①注一17:00:04.932512 IP 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780 &gt; www.tcpserver.com.ndmp: Flags [F.], seq 1, ack 1, win 229, options [nop,nop,TS val 3136585065 ecr 750917687], length 0②③注二17:00:04.932669 IP www.tcpserver.com.ndmp &gt; 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780: Flags [F.], seq 1, ack 2, win 227, options [nop,nop,TS val 750923869 ecr 3136585065], length 0④17:00:04.944759 IP 106.202.127.124.broad.bj.bj.static.163data.com.cn.40780 &gt; www.tcpserver.com.ndmp: Flags [.], ack 2, win 229, options [nop,nop,TS val 3136585075 ecr 750923869], length 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>附录三个脚本：</p></blockquote><h2 id="TCP-server端"><a href="#TCP-server端" class="headerlink" title="TCP server端"></a>TCP server端</h2><p>开启端口，绑定到主机</p><p><code>tcp_update.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># TCP server</span><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> pymysql<span class="token keyword">import</span> time<span class="token keyword">import</span> _thread<span class="token keyword">import</span> socketsocket<span class="token punctuation">.</span>setdefaulttimeout<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token comment"># Manual Data</span>db_2 <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'$IP'</span><span class="token punctuation">,</span> port<span class="token operator">=</span>$PORT<span class="token punctuation">,</span>                       user<span class="token operator">=</span><span class="token string">'$NAME'</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">'$PASSWORD'</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token string">"$DATABASE"</span><span class="token punctuation">)</span>cursor_2 <span class="token operator">=</span> db_2<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    temp_str <span class="token operator">=</span> string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> temp_str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>temp_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">database_update</span><span class="token punctuation">(</span>attribute<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>    sql <span class="token operator">=</span> <span class="token string">"UPDATE dataTestUDP SET value = "</span> <span class="token operator">+</span> \        <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" WHERE attribute = \""</span> <span class="token operator">+</span> attribute <span class="token operator">+</span> <span class="token string">"\""</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        db_2<span class="token punctuation">.</span>ping<span class="token punctuation">(</span>reconnect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        cursor_2<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>        db_2<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token comment"># 如果发生错误则回滚</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Database Error'</span><span class="token punctuation">)</span>        db_2<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 关闭数据库连接</span>        db_2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">tcp_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    HOST <span class="token operator">=</span> <span class="token string">'192.168.1.2'</span>    PORT <span class="token operator">=</span> <span class="token number">10000</span>    BUFSIZ <span class="token operator">=</span> <span class="token number">1024</span>    ADDRESS <span class="token operator">=</span> <span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>    tcpServerSocket <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>    tcpServerSocket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>ADDRESS<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Server starts，listening port &#123;&#125;..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ADDRESS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    tcpServerSocket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            client_socket <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Server is running. Waiting client...'</span><span class="token punctuation">)</span>                client_socket<span class="token punctuation">,</span> client_address <span class="token operator">=</span> tcpServerSocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Client &#123;&#125; Connected！'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                    <span class="token keyword">try</span><span class="token punctuation">:</span>                        data <span class="token operator">=</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>                        <span class="token keyword">if</span> data<span class="token punctuation">:</span>                            <span class="token keyword">print</span><span class="token punctuation">(</span>                                <span class="token string">'Received Message &#123;&#125;(&#123;&#125; bytes) from &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gb2312'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>                                                                               client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token keyword">try</span><span class="token punctuation">:</span>                                a<span class="token punctuation">,</span> v <span class="token operator">=</span> process<span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gb2312'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                database_update<span class="token punctuation">(</span>a<span class="token punctuation">,</span> v<span class="token punctuation">)</span>                            <span class="token keyword">except</span><span class="token punctuation">:</span>                                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Data Error'</span><span class="token punctuation">)</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Client &#123;&#125; disconnects!'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token keyword">break</span>                    <span class="token keyword">except</span><span class="token punctuation">:</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Connenction Reset by &#123;&#125;!'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token keyword">break</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Timeout.'</span><span class="token punctuation">)</span>                <span class="token keyword">pass</span>            <span class="token keyword">finally</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> client_socket <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                    client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        tcpServerSocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    tcp_listener<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数据微调"><a href="#数据微调" class="headerlink" title="数据微调"></a>数据微调</h2><p><code>auto_update.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># auto update</span><span class="token keyword">import</span> pymysql<span class="token keyword">import</span> time<span class="token comment"># Auto Data</span>db_1 <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'$IP'</span><span class="token punctuation">,</span> port<span class="token operator">=</span>$PORT<span class="token punctuation">,</span>                       user<span class="token operator">=</span><span class="token string">'$NAME'</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">'$PASSWORD'</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token string">"$DATABASE"</span><span class="token punctuation">)</span>cursor_1 <span class="token operator">=</span> db_1<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># Update fake data automatically</span><span class="token keyword">def</span> <span class="token function">database_auto_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sql_1 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""UPDATE dataTestFake SET id = 0 WHERE id = 10"""</span>    sql_2 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""UPDATE dataTestFake SET id = id + 1 WHERE id &lt; 10"""</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment"># 执行sql语句</span>            db_1<span class="token punctuation">.</span>ping<span class="token punctuation">(</span>reconnect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>            cursor_1<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_1<span class="token punctuation">)</span>            cursor_1<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_2<span class="token punctuation">)</span>            <span class="token comment"># 提交到数据库执行</span>            db_1<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token comment"># 如果发生错误则回滚</span>            db_1<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 关闭数据库连接</span>            db_1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    database_auto_update<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="客户端发送数据"><a href="#客户端发送数据" class="headerlink" title="客户端发送数据"></a>客户端发送数据</h1><p><code>test.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># test py</span><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>HOST <span class="token operator">=</span> <span class="token string">'192.168.1.2'</span>PORT <span class="token operator">=</span> <span class="token number">10000</span>BUFSIZ <span class="token operator">=</span> <span class="token number">1024</span>ADDRESS <span class="token operator">=</span> <span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>tcpClientSocket <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>tcpClientSocket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ADDRESS<span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>        <span class="token keyword">break</span>    tcpClientSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'gb2312'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Disconnect!"</span><span class="token punctuation">)</span>tcpClientSocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error(Ⅱ)</title>
      <link href="/posts/b6418ddb.html"/>
      <url>/posts/b6418ddb.html</url>
      
        <content type="html"><![CDATA[<h2 id="kylin启动报错"><a href="#kylin启动报错" class="headerlink" title="kylin启动报错"></a>kylin启动报错</h2><blockquote><p>修改hdfs用户为root,hive对root授权<br>启动apache-kylin报错:<br><code>&lt;font color=red&gt; Caused by: java.lang.ClassNotFoundException: org.apache.commons.configuration.ConfigurationException&lt;/font&gt;</code></p></blockquote><blockquote><p>解决:将commons-configuration-1.6.jar复制到kylin/lib/目录下面即可</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@client2 logs<span class="token punctuation">]</span><span class="token comment"># find / -name commons-configuration-*.jar</span>/var/lib/ambari-agent/cred/lib/commons-configuration-1.6.jar/usr/hdp/3.1.0.0-78/ranger-hdfs-plugin/install/lib/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-yarn-plugin/install/lib/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/hbase/lib/atlas-hbase-plugin-impl/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-hbase-plugin/install/lib/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/atlas/hook/hbase/atlas-hbase-plugin-impl/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/atlas/hook/hive/atlas-hive-plugin-impl/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-atlas-plugin/install/lib/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/kafka/libs/ranger-kafka-plugin-impl/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-kafka-plugin/install/lib/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-kafka-plugin/lib/ranger-kafka-plugin-impl/commons-configuration-1.10.jar/usr/hdp/3.1.0.0-78/ranger-hive-plugin/install/lib/commons-configuration-1.10.jar<span class="token comment">#/usr/hdp/3.1.0.0-78/kylin/lib/commons-configuration-1.6.jar</span><span class="token comment"># 搭建步骤:</span><span class="token comment"># 下载apache-kylin-3.0.1-bin-hadoop3.tar.gz</span><span class="token comment"># 配置环境变量</span><span class="token comment"># cat /etc/profile</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">KYLIN_HOME</span><span class="token operator">=</span>/usr/hdp/3.1.0.0-78/kylin<span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_NODEJS_ORG_MIRROR</span><span class="token operator">=</span>https://npm.taobao.org/mirrors/node<span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_IOJS_ORG_MIRROR</span><span class="token operator">=</span>https://npm.taobao.org/mirrors/iojs<span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_HOME</span><span class="token operator">=</span>/usr/hdp/3.1.0.0-78/hadoop<span class="token builtin class-name">export</span> <span class="token assign-left variable">SPARK_HOME</span><span class="token operator">=</span>/usr/hdp/3.1.0.0-78/spark2<span class="token builtin class-name">export</span> <span class="token assign-left variable">KYLIN_CONF</span><span class="token operator">=</span>/usr/hdp/3.1.0.0-78/kylin/conf<span class="token builtin class-name">export</span> <span class="token assign-left variable">ZOOKEEPER_HOME</span><span class="token operator">=</span>/usr/hdp/3.1.0.0-78/zookeeper<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$MAVEN_HOME</span>/bin:<span class="token variable">$KYLIN_HOME</span>/bin<span class="token comment"># 启动 kylin.sh start 即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mongo连接超时"><a href="#mongo连接超时" class="headerlink" title="mongo连接超时"></a>mongo连接超时</h2><blockquote><p>因为运维的时候不知道是谁搭建的环境，更不知到安装的软件方式是什么样的。<br>故记录此次排错过程。<br>获取到程序的日志信息大致如下：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2020</span>-05-06 <span class="token number">10</span>:14:16.470  INFO <span class="token number">16447</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> org.mongodb.driver.cluster               <span class="token builtin class-name">:</span> Cluster created with settings <span class="token punctuation">&#123;</span>hosts<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">192.168</span>.1.113:8081<span class="token punctuation">]</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span>SINGLE, <span class="token assign-left variable">requiredClusterType</span><span class="token operator">=</span>UNKNOWN, <span class="token assign-left variable">serverSelectionTimeout</span><span class="token operator">=</span><span class="token string">'30000 ms'</span>, <span class="token assign-left variable">maxWaitQueueSize</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token number">2020</span>-05-06 <span class="token number">10</span>:14:16.565  INFO <span class="token number">16447</span> --- <span class="token punctuation">[</span>.168.1.113:8081<span class="token punctuation">]</span> org.mongodb.driver.cluster               <span class="token builtin class-name">:</span> Exception <span class="token keyword">in</span> monitor thread <span class="token keyword">while</span> connecting to server <span class="token number">192.168</span>.1.113:8081com.mongodb.MongoSocketOpenException: Exception opening socket    at com.mongodb.internal.connection.SocketStream.open<span class="token punctuation">(</span>SocketStream.java:67<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mongodb-driver-core-3.8.2.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>    at com.mongodb.internal.connection.InternalStreamConnection.open<span class="token punctuation">(</span>InternalStreamConnection.java:126<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mongodb-driver-core-3.8.2.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>    at com.mongodb.internal.connection.DefaultServerMonitor<span class="token variable">$ServerMonitorRunnable</span>.run<span class="token punctuation">(</span>DefaultServerMonitor.java:117<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mongodb-driver-core-3.8.2.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>    at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>Caused by: java.net.ConnectException: 拒绝连接 <span class="token punctuation">(</span>Connection refused<span class="token punctuation">)</span>    at java.net.PlainSocketImpl.socketConnect<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at java.net.AbstractPlainSocketImpl.doConnect<span class="token punctuation">(</span>AbstractPlainSocketImpl.java:350<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at java.net.AbstractPlainSocketImpl.connectToAddress<span class="token punctuation">(</span>AbstractPlainSocketImpl.java:206<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at java.net.AbstractPlainSocketImpl.connect<span class="token punctuation">(</span>AbstractPlainSocketImpl.java:188<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at java.net.SocksSocketImpl.connect<span class="token punctuation">(</span>SocksSocketImpl.java:392<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at java.net.Socket.connect<span class="token punctuation">(</span>Socket.java:589<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_151<span class="token punctuation">]</span>    at com.mongodb.internal.connection.SocketStreamHelper.initialize<span class="token punctuation">(</span>SocketStreamHelper.java:64<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mongodb-driver-core-3.8.2.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>    at com.mongodb.internal.connection.SocketStream.open<span class="token punctuation">(</span>SocketStream.java:62<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mongodb-driver-core-3.8.2.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>    <span class="token punctuation">..</span>. <span class="token number">3</span> common frames omitted<span class="token number">2020</span>-05-06 <span class="token number">10</span>:14:17.216  INFO <span class="token number">16447</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> org.mongodb.driver.cluster               <span class="token builtin class-name">:</span> Cluster description not yet available. Waiting <span class="token keyword">for</span> <span class="token number">30000</span> ms before timing out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>从上面日志中提取关键词 “timeout=30000”  “192.168.1.113:8081”  “拒绝连接”  “mongodb-driver-core-3.8.2.jar!”<br>初步怀疑mongodb挂掉，IP端口为192.168.1.113:8081<br>登录主机，查询历史命令发现是docker pull的mongo的镜像<br>docker运行镜像</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart <span class="token function">docker</span><span class="token function">docker</span> images<span class="token function">docker</span> run <span class="token parameter variable">--name</span> mongo <span class="token parameter variable">-p</span> <span class="token number">27017</span>:27017 <span class="token parameter variable">-d</span> mongo <span class="token parameter variable">--auth</span>   <span class="token comment"># 补全</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span class="token function">docker</span> start 64ca<span class="token comment"># 端口不对，处理端口问题</span><span class="token builtin class-name">cd</span> /var/lib/docker/containers/64ca58ae81<span class="token punctuation">..</span>.ddfc992ac212/   <span class="token comment"># 镜像ID</span><span class="token function">vim</span> hostconfig.json<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token string">"PortBindings"</span>:<span class="token punctuation">&#123;</span><span class="token string">"27017/tcp"</span>:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"HostIp    "</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"HostPort"</span><span class="token builtin class-name">:</span><span class="token string">"8081"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,<span class="token string">"HostPort"</span><span class="token builtin class-name">:</span><span class="token string">"8081"</span>这里是宿主机端口<span class="token string">"27017/tcp"</span>这里是容器端口<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token comment"># 改完重启docker和容器</span>systemctl restart <span class="token function">docker</span><span class="token function">docker</span> stop <span class="token number">64</span><span class="token function">docker</span> start <span class="token number">64</span><span class="token comment"># 主机再次启动程序</span><span class="token number">2020</span>-05-06 <span class="token number">10</span>:23:19.244  INFO <span class="token number">18145</span> --- <span class="token punctuation">[</span>.168.1.113:8081<span class="token punctuation">]</span> org.mongodb.driver.cluster               <span class="token builtin class-name">:</span> Monitor thread successfully connected to server with description ServerDescription<span class="token punctuation">&#123;</span>address<span class="token operator">=</span><span class="token number">192.168</span>.1.113:8081, <span class="token assign-left variable">type</span><span class="token operator">=</span>STANDALONE, <span class="token assign-left variable">state</span><span class="token operator">=</span>CONNECTED, <span class="token assign-left variable">ok</span><span class="token operator">=</span>true, <span class="token assign-left variable">version</span><span class="token operator">=</span>ServerVersion<span class="token punctuation">&#123;</span>versionList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span>, <span class="token number">2</span>, <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">minWireVersion</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">maxWireVersion</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">maxDocumentSize</span><span class="token operator">=</span><span class="token number">16777216</span>, <span class="token assign-left variable">logicalSessionTimeoutMinutes</span><span class="token operator">=</span><span class="token number">30</span>, <span class="token assign-left variable">roundTripTimeNanos</span><span class="token operator">=</span><span class="token number">5891523</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>显示mongodb连接上了,程序也正常运行😘<br>五一放假公司测试服务器关机，上班后恢复，启动程序发现一个程序一直启动失败，调查原因才有的上文所述。</p></blockquote><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><blockquote><p>如果容器内端口从没有暴露，需要在修改config.v2.json</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> config.v2.json<span class="token comment"># 在 config.v2.json 里面添加一个配置项</span><span class="token string">"ExposedPorts"</span>:<span class="token punctuation">&#123;</span><span class="token string">"27017/tcp"</span>:<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>将这个配置项添加到 “Tty” 前面即可<br>最后重启docker和容器，使用docker ps验证端口映射</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error(Ⅰ)</title>
      <link href="/posts/9c1c9375.html"/>
      <url>/posts/9c1c9375.html</url>
      
        <content type="html"><![CDATA[<h2 id="虚拟机启动报错"><a href="#虚拟机启动报错" class="headerlink" title="虚拟机启动报错"></a>虚拟机启动报错</h2><p>在启用了Hyper-V的Windows 10主机上启动VMware Workstation中的虚拟机。会看到类似于以下内容的错误：</p><blockquote><p>VMware Workstation和Device/Credential Guard不兼容。禁用Device/Credential Guard后，可以运行VMware Workstation。</p></blockquote><p>原因：</p><blockquote><p>1、出现此问题的原因是Device Guard或Credential Guard与Workstation不兼容。<br>2、Windows系统的Hyper-V不兼容导致。</p></blockquote><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><h4 id="步骤一："><a href="#步骤一：" class="headerlink" title="步骤一："></a>步骤一：</h4><blockquote><p>a) 禁用Device Guard或Credential Guard：<br>b) 禁用用于启用Credential Guard的组策略设置。<br>c) 在主机操作系统上，右键单击”<strong>开始</strong>“&gt; “<strong>运行</strong>“，键入gpedit.msc，然后单击”<strong>确定</strong>“。本地组策略编辑器打开。<br>d) 转至<strong>本地计算机策略</strong> &gt; <strong>计算机配置</strong> &gt; <strong>管理模板</strong>&gt;<strong>系统</strong> &gt;<strong>Device Guard</strong>（或者是： <strong>设备防护</strong>） &gt; <strong>启用基于虚拟化的安全性</strong>。<br>e) 选择<strong>已禁用</strong>。<br>f) 转到”<strong>控制面板</strong>“&gt;”<strong>卸载程序</strong>“&gt;”<strong>打开或关闭Windows功能</strong>“以关闭Hyper-V。<br>g) 选择<strong>不重启</strong>。</p></blockquote><h4 id="步骤二："><a href="#步骤二：" class="headerlink" title="步骤二："></a>步骤二：</h4><blockquote><p>a) 通过命令关闭Hyper-V（控制面板关闭Hyper-V起不到决定性作用，要彻底关闭Hyper-V） <br>b) <strong>以管理员身份运行Windows Powershell (管理员)（Windows键+X）</strong><br>c) 运行下面命令并重启电脑：<br>d) <code>bcdedit /set hypervisorlaunchtype off</code></p></blockquote><h2 id="centos8安装docker报错"><a href="#centos8安装docker报错" class="headerlink" title="centos8安装docker报错"></a>centos8安装docker报错</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装依赖</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2<span class="token comment"># 配置阿里云镜像库</span>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="token comment"># 安装docker</span><span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># yum -y install docker-ce</span><span class="token punctuation">..</span>.错误： 问题: package docker-ce-3:19.03.9-3.el7.x86_64 requires containerd.io <span class="token operator">>=</span> <span class="token number">1.2</span>.2-3, but none of the providers can be installed<span class="token punctuation">..</span>.<span class="token punctuation">(</span>尝试添加 <span class="token string">'--skip-broken'</span> 来跳过无法安装的软件包 或 <span class="token string">'--nobest'</span> 来不只使用最佳选择的软件包<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>报错：<code>package docker-ce-3:19.03.9-3.el7.x86_64 requires containerd.io &gt;= 1.2.2-3, but none of the providers can be installed</code></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># yum -y install containerd.io</span><span class="token comment"># 版本是1.2.0，手动下载高版本软件（dnf等同yum，也是包管理器）</span><span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># dnf install https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm</span><span class="token comment"># 再次安装docker-ce</span><span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># dnf install -y docker-ce</span><span class="token comment"># 启动设置开机自启</span><span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker</span>Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.<span class="token punctuation">[</span>root@test yum.repos.d<span class="token punctuation">]</span><span class="token comment"># systemctl start docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="记一次war包更新报错"><a href="#记一次war包更新报错" class="headerlink" title="记一次war包更新报错"></a>记一次war包更新报错</h2><blockquote><p>删除tomcat下面的webapps目录中的war包，xftp上传新包失败，使用<code>du</code>和<code>df</code>命令查询的磁盘容量不一致</p></blockquote><blockquote><p>导致这个两个命令查看磁盘容量不一致的原因是，用户删除了大量的文件被删除后，在文件系统目录中已经不可见了，所以du就不会再统计它。然而如果此时还有运行的进程持有这个已经被删除的文件句柄，那么这个文件就不会真正在磁盘中被删除，分区超级块中的信息也就不会更改，df仍会统计这个被删除的文件。</p></blockquote><blockquote><p>可通过 lsof命令查询处于deleted状态的文件，被删除的文件在系统中被标记为deleted。如果系统有大量deleted状态的文件，会导致du和df统计结果不一致。</p></blockquote><p><em><font color=red>这里记录不完全，时间太长了，之前的记录不是很详细</font></em></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">lsof</span> <span class="token operator">|</span> <span class="token function">grep</span> delted<span class="token comment"># 解决: 执行kill 29080   # 关闭占用已删除文件的进程</span><span class="token punctuation">[</span>root@client ~<span class="token punctuation">]</span><span class="token comment"># kill 29080</span><span class="token punctuation">[</span>root@client ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>Filesystem      Size  Used Avail Use% Mounted ondevtmpfs        <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /devtmpfs           <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /dev/shmtmpfs           <span class="token number">3</span>.9G  361M  <span class="token number">3</span>.5G  <span class="token number">10</span>% /runtmpfs           <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /sys/fs/cgroup/dev/vda1        40G   10G   28G  <span class="token number">27</span>% /                          <span class="token comment"># 这里磁盘已经降下来了</span>tmpfs           783M     <span class="token number">0</span>  783M   <span class="token number">0</span>% /run/user/0/dev/vdb1       197G  <span class="token number">2</span>.3G  185G   <span class="token number">2</span>% /mnt/opt<span class="token punctuation">[</span>root@client ~<span class="token punctuation">]</span><span class="token comment"># du / -sh</span>du: cannot access ‘/proc/6406/task/6406/fd/4’: No such <span class="token function">file</span> or directorydu: cannot access ‘/proc/6406/task/6406/fdinfo/4’: No such <span class="token function">file</span> or directorydu: cannot access ‘/proc/6406/fd/3’: No such <span class="token function">file</span> or directorydu: cannot access ‘/proc/6406/fdinfo/3’: No such <span class="token function">file</span> or directory13G    /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error(Ⅲ)</title>
      <link href="/posts/24973bf0.html"/>
      <url>/posts/24973bf0.html</url>
      
        <content type="html"><![CDATA[<h2 id="华为云mrs报错"><a href="#华为云mrs报错" class="headerlink" title="华为云mrs报错"></a>华为云mrs报错</h2><blockquote><p>两台电脑截图，导致图片丢失了一部分😭<br>起因：开发同学使用sqlline.py操作HBase报错<br>首先登陆MapReduce服务控制台查看报错：</p></blockquote><p><img src="/medias/img/mrs/0.png"></p><blockquote><p>参考的排错<a href="https://support.huaweicloud.com/usermanual-mrs/mrs_01_0695.html">文档</a> 并没有用。</p></blockquote><blockquote><p>按文档所说zookeeper，时间，hdfs等都是好的</p></blockquote><p><img src="/medias/img/mrs/3.png"></p><blockquote><p>根据报错信息查看服务器RegionServer是好的</p></blockquote><p><img src="/medias/img/mrs/1.png"></p><blockquote><p>从这里也能看到各项数据正常，但是RegionServer时好时坏</p></blockquote><p><img src="/medias/img/mrs/4.png"></p><blockquote><p>如下图所示（怀疑是拉起之后就被干掉，因为上图的HRegionServer也会消失）</p></blockquote><p><img src="/medias/img/mrs/5.png"></p><blockquote><p>这里进行了重启大法，大法GG😩<br><img src="/medias/img/mrs/2.png"></p></blockquote><blockquote><p>在mrs控制台找到hbase服务，进入监控页面，可以看到好几张表处于被打开的状态</p></blockquote><p><img src="/medias/img/mrs/7.png"></p><blockquote><p>往下可以看到有25张表处于RIT状态！！！</p></blockquote><p><img src="/medias/img/mrs/8.png"></p><blockquote><p>服务器日志也能看到OPENING状态的表：<br><img src="/medias/img/mrs/0.jpg"></p></blockquote><blockquote><p>就是这个鬼，参考<a href="https://www.jianshu.com/p/d5697506741e">文章</a>实际并没有解决🤟<br>因为我的集群hbase是2.1.1版本，很多命令被2.0+的hbase抛弃了，文章中的命令我这里执行报错：不存在<br>另外一篇<a href="https://blog.csdn.net/kinglyjn/article/details/78790425">文章</a>给了解决思路，查看日志是否是内存泄漏导致的RIT<br>这里的截图是错的，实际修改的是ThriftServer，原来的Xms128M Xmx128M修改为Xms1024M Xmx1024M</p></blockquote><p><img src="/medias/img/mrs/6.png"></p><blockquote><p>修改之后重启相关服务<code>HBase</code> <code>Hue</code>，修改完会提示重启，按照提示来就行<br>3分钟内，告警消失，HBase恢复<br>这里解决launcher.log过大350G+(磁盘空间告警)</p></blockquote><p><img src="/medias/img/mrs/9.png"></p><blockquote><p>这里解决熵告警：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> –ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"haveged"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"grep"</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"haveged"</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> havegedsystemctl start havegedsystemctl <span class="token builtin class-name">enable</span> haveged.service<span class="token function">cat</span> /dev/random <span class="token operator">|</span> od –x<span class="token function">cat</span> /opt/mrs_clusterinfo <span class="token function">cat</span> /proc/sys/kernel/random/entropy_avail<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>解决磁盘满导致的数据不同步告警：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /srv/BigData/journalnode/hacluster/current/<span class="token function">rm</span> <span class="token parameter variable">-rf</span> edits_*<span class="token function">rm</span> committed-txid <span class="token function">cat</span> /etc/hosts<span class="token function">scp</span> root@192.168.1.73:/srv/BigData/journalnode/hacluster/current/edit_000* ./<span class="token function">scp</span> root@192.168.1.73:/srv/BigData/journalnode/hacluster/current/edits_000* ./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nginx-413-报错"><a href="#nginx-413-报错" class="headerlink" title="nginx 413 报错"></a>nginx 413 报错</h2><blockquote><p>报错信息：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">**** - - <span class="token punctuation">[</span>05/Jun/2020:11:25:49 +0800<span class="token punctuation">]</span> <span class="token string">"POST /b****s HTTP/1.1"</span> <span class="token number">413</span> <span class="token number">183</span> <span class="token string">"-"</span> <span class="token string">"Apache-HttpClient/4.5.8 (Java/1.8.0_181)"</span> <span class="token string">"-"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>解决，在nginx配置文件中加入以下两行即可，配置文件需要根据自己实际nginx配置去找，我的是<code>/etc/nginx/conf.d/***com.conf</code></p></blockquote><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">client_max_body_size 10m;   # 设置成实际需要的大小即可，一般是8-10Mclient_body_buffer_size 128k;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>只要将上面两行配置放在报错接口的<code>location / &#123;&#125;</code>中即可<br>我的反向代理配置：</p></blockquote><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">location &#x2F;**** &#123;    proxy_pass http:&#x2F;&#x2F;1****5;    proxy_redirect off;   # 对发送给客户端的URL进行修改    proxy_set_header        Host    $host;    proxy_set_header        X-Real-IP       $remote_addr;    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;    proxy_max_temp_file_size 0;   # 设置临时文件的总大小    proxy_connect_timeout 90;   # nginx跟后端服务器连接超时时间（代理连接超时）    proxy_send_timeout 90;   # 后端服务器数据回传时间(代理发送超时)    proxy_read_timeout 90;   # 连接成功后，后端服务器响应时间(代理接收超时)    proxy_buffer_size 4k;   # 设置代理服务器（nginx）保存用户头信息的缓冲区大小    proxy_buffers 4 32k;   # 该指令设置缓冲区的大小和数量,从被代理的后端服务器取得的响应内容,会放置到这里    proxy_busy_buffers_size 64k;   # 所有处在busy状态的buffer size加起来不能超过proxy_busy_buffers_size    proxy_temp_file_write_size 64k;   # 如果response的内容很大的话，Nginx会接收并把他们写入到temp_file里去。busy的buffer传输完了会从temp_file里面接着读数据，直到传输完毕    client_max_body_size 10m;   # 允许客户端请求的最大单文件字节数    client_body_buffer_size 128k;   # 缓冲区代理缓冲用户端请求的最大字节数（请求多）&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nginx跨域问题"><a href="#nginx跨域问题" class="headerlink" title="nginx跨域问题"></a>nginx跨域问题</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">server <span class="token punctuation">&#123;</span>    listen <span class="token number">80</span><span class="token punctuation">;</span>    server_name <span class="token number">192.168</span>.1.202<span class="token punctuation">;</span>    location /api <span class="token punctuation">&#123;</span>        proxy_pass http://192.168.1.108:8090<span class="token punctuation">;</span>        <span class="token comment"># 指定允许跨域的方法，*代表所有</span>        add_header Access-Control-Allow-Methods *<span class="token punctuation">;</span>        <span class="token comment"># 预检命令的缓存，如果不缓存每次会发送两次请求</span>        add_header Access-Control-Max-Age <span class="token number">3600</span><span class="token punctuation">;</span>        <span class="token comment"># 带cookie请求需要加上这个字段，并设置为true</span>        add_header Access-Control-Allow-Credentials <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment"># 表示允许这个域跨域调用（客户端发送请求的域名和端口） </span>        <span class="token comment"># $http_origin动态获取请求客户端请求的域，不用*的原因是带cookie的请求不支持*号</span>        add_header Access-Control-Allow-Origin <span class="token variable">$http_origin</span><span class="token punctuation">;</span>        <span class="token comment"># 表示请求头的字段 动态获取</span>        add_header Access-Control-Allow-Headers        <span class="token variable">$http_access_control_request_headers</span><span class="token punctuation">;</span>        <span class="token comment"># OPTIONS预检命令，预检命令通过时才发送请求</span>        <span class="token comment"># 检查请求的类型是不是预检命令</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> OPTIONS<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token builtin class-name">return</span> <span class="token number">200</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mongo操作手册</title>
      <link href="/posts/713dc437.html"/>
      <url>/posts/713dc437.html</url>
      
        <content type="html"><![CDATA[<h2 id="MongoDB常用操作命令"><a href="#MongoDB常用操作命令" class="headerlink" title="MongoDB常用操作命令"></a>MongoDB常用操作命令</h2><blockquote><p>查看命令提示：<code>help;</code></p></blockquote><blockquote><p>切换/创建数据库：<code>use yourDB;</code><br>当创建一个集合(table)的时候会自动创建当前数据库</p></blockquote><blockquote><p>查询所有数据库：<code>show dbs;</code></p></blockquote><blockquote><p>删除当前使用数据库：<code>db.dropDatabase();</code></p></blockquote><blockquote><p>从指定主机上克隆数据库：<code>db.cloneDatabase(&quot;127.0.0.1&quot;);</code><br>将指定机器上的数据库的数据克隆到当前数据库</p></blockquote><blockquote><p>从指定的机器上复制指定数据库数据到某个数据库：<code>db.copyDatabase(&quot;mydb&quot;, &quot;temp&quot;, &quot;127.0.0.1&quot;);</code><br>将本机的mydb的数据复制到temp数据库中</p></blockquote><blockquote><p>修复当前数据库：<code>db.repairDatabase();</code></p></blockquote><blockquote><p>查看当前使用的数据库：<code>db.getName();</code>、<code>db;</code><br>db和getName方法是一样的效果，都可以查询当前使用的数据库</p></blockquote><blockquote><p>显示当前db状态：<code>db.stats();</code></p></blockquote><blockquote><p>当前db版本：<code>db.version();</code></p></blockquote><blockquote><p>查看当前db的链接机器地址：<code>db.getMongo();</code></p></blockquote><h2 id="Collection聚集集合"><a href="#Collection聚集集合" class="headerlink" title="Collection聚集集合"></a>Collection聚集集合</h2><blockquote><p>创建一个聚集集合（table）：<code>db.createCollection(&quot;collName&quot;, &#123;size: 20, capped: 5, max: 100&#125;);</code></p></blockquote><blockquote><p>创建成功会显示{“ok”:1}</p></blockquote><blockquote><p>判断集合是否为定容量：<code>db.collName.isCapped();</code></p></blockquote><blockquote><p>得到指定名称的聚集集合（table）：<code>db.getCollection(&quot;account&quot;);</code></p></blockquote><blockquote><p>得到当前db的所有聚集集合：<code>db.getCollectionNames();</code></p></blockquote><blockquote><p>显示当前db所有聚集索引的状态：<code>db.printCollectionStats();</code></p></blockquote><h2 id="用户相关"><a href="#用户相关" class="headerlink" title="用户相关"></a>用户相关</h2><blockquote><p>添加一个用户：<code>db.addUser(&quot;name&quot;);</code></p></blockquote><blockquote><p>添加用户、设置密码、是否只读：<code>db.addUser(&quot;userName&quot;, &quot;pwd123&quot;, true);</code></p></blockquote><blockquote><p>数据库认证、安全模式：<code>db.auth(&quot;userName&quot;, &quot;123123&quot;);</code></p></blockquote><blockquote><p>显示当前所有用户：<code>show users;</code></p></blockquote><blockquote><p>删除用户：<code>db.removeUser(&quot;userName&quot;);</code></p></blockquote><h2 id="聚集集合查询"><a href="#聚集集合查询" class="headerlink" title="聚集集合查询"></a>聚集集合查询</h2><blockquote><p>查询所有记录：<code>db.userInfo.find();</code><br>相当于：<code>select* from userInfo;</code><br>默认每页显示20条记录，当显示不下的情况下，可以用it迭代命令查询下一页数据。注意：键入it命令不能带”;”<br>但是你可以设置每页显示数据的大小，用：<code>DBQuery.shellBatchSize= 50;</code>这样每页就显示50条记录了。</p></blockquote><blockquote><p>查询去掉后的当前聚集集合中的某列的重复数据：<code>db.userInfo.distinct(&quot;name&quot;);</code><br>会过滤掉name中的相同数据<br>相当于：<code>select distict name from userInfo;</code></p></blockquote><blockquote><p>查询age = 22的记录：<code>db.userInfo.find(&#123;&quot;age&quot;: 22&#125;);</code><br>相当于： <code>select * from userInfo where age = 22;</code></p></blockquote><blockquote><p>查询age &gt; 22的记录：<code>db.userInfo.find(&#123;age: &#123;$gt: 22&#125;&#125;);</code><br>相当于：<code>select * from userInfo where age &gt;22;</code></p></blockquote><blockquote><p>查询age &lt; 22的记录：<code>db.userInfo.find(&#123;age: &#123;$lt: 22&#125;&#125;);</code><br>相当于：<code>select * from userInfo where age &lt;22;</code></p></blockquote><blockquote><p>查询age &gt;= 25的记录：<code>db.userInfo.find(&#123;age: &#123;$gte: 25&#125;&#125;);</code><br>相当于：<code>select * from userInfo where age &gt;= 25;</code></p></blockquote><blockquote><p>查询age &lt;= 25的记录：<code>db.userInfo.find(&#123;age: &#123;$lte: 25&#125;&#125;);</code></p></blockquote><blockquote><p>查询age &gt;= 23 并且 age &lt;= 26：<code>db.userInfo.find(&#123;age: &#123;$gte: 23, $lte: 26&#125;&#125;);</code></p></blockquote><blockquote><p>查询name中包含 mongo的数据：<code>db.userInfo.find(&#123;name: /mongo/&#125;);</code><br>相当于<code>select * from userInfo where name like &#39;%mongo%&#39;;</code></p></blockquote><blockquote><p>查询name中以mongo开头的：<code>db.userInfo.find(&#123;name: /^mongo/&#125;);</code><br>相当于：<code>select * from userInfo where name like &#39;mongo%&#39;;</code></p></blockquote><blockquote><p>查询指定列name、age数据：<code>db.userInfo.find(&#123;&#125;, &#123;name: 1, age: 1&#125;);</code><br>相当于：<code>select name, age from userInfo;</code><br>当然name也可以用true或false,当用ture的情况下河name:1效果一样，如果用false就是排除name，显示name以外的列信息。</p></blockquote><blockquote><p>查询指定列name、age数据, age &gt; 25：<code>db.userInfo.find(&#123;age: &#123;$gt: 25&#125;&#125;, &#123;name: 1, age: 1&#125;);</code><br>相当于：<code>select name, age from userInfo where age &gt;25;</code></p></blockquote><blockquote><p>按照年龄排序<br>升序：<code>db.userInfo.find().sort(&#123;age: 1&#125;);</code><br>降序：<code>db.userInfo.find().sort(&#123;age: -1&#125;);</code></p></blockquote><blockquote><p>查询name = zhangsan, age = 22的数据：<code>db.userInfo.find(&#123;name: &#39;zhangsan&#39;, age: 22&#125;);</code><br>相当于：<code>select * from userInfo where name = &#39;zhangsan&#39; and age = &#39;22&#39;;</code></p></blockquote><blockquote><p>查询前5条数据：<code>db.userInfo.find().limit(5);</code><br>相当于：<code>select top 5 * from userInfo;</code></p></blockquote><blockquote><p>查询10条以后的数据：<code>db.userInfo.find().skip(10);</code><br>相当于：<code>select * from userInfo where id not in (select top 10 * from userInfo);</code></p></blockquote><blockquote><p>查询在5-10之间的数据：<code>db.userInfo.find().limit(10).skip(5);</code><br>可用于分页，limit是pageSize，skip是第几页*pageSize</p></blockquote><blockquote><p>or/与 查询：<code>db.userInfo.find(&#123;$or: [&#123;age: 22&#125;, &#123;age: 25&#125;]&#125;);</code><br>相当于：<code>select * from userInfo where age = 22 or age = 25;</code></p></blockquote><blockquote><p>查询第一条数据：<code>db.userInfo.findOne();</code><br>相当于：<code>select top 1 * from userInfo;</code><br><code>db.userInfo.find().limit(1);</code></p></blockquote><blockquote><p>查询某个结果集的记录条数：<code>db.userInfo.find(&#123;age: &#123;$gte: 25&#125;&#125;).count();</code><br>相当于：<code>select count(*) from userInfo where age &gt;= 20;</code></p></blockquote><blockquote><p>按照某列进行排序：<code>db.userInfo.find(&#123;sex: &#123;$exists: true&#125;&#125;).count();</code><br>相当于：<code>select count(sex) from userInfo;</code></p></blockquote><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><blockquote><p>创建索引<br><code>db.userInfo.ensureIndex(&#123;name: 1&#125;);</code><br><code>db.userInfo.ensureIndex(&#123;name: 1, ts: -1&#125;);</code></p></blockquote><blockquote><p>查询当前聚集集合所有索引<br><code>db.userInfo.getIndexes();</code></p></blockquote><blockquote><p>查看总索引记录大小<br><code>db.userInfo.totalIndexSize();</code></p></blockquote><blockquote><p>读取当前集合的所有index信息<br><code>db.users.reIndex();</code></p></blockquote><blockquote><p>删除指定索引<br><code>db.users.dropIndex(&quot;name_1&quot;);</code></p></blockquote><blockquote><p>删除所有索引索引<br><code>db.users.dropIndexes();</code></p></blockquote><h2 id="修改、添加、删除集合数据"><a href="#修改、添加、删除集合数据" class="headerlink" title="修改、添加、删除集合数据"></a>修改、添加、删除集合数据</h2><blockquote><p>添加<br><code>db.users.save(&#123;name: &#39;zhangsan&#39;, age: 25, sex: true&#125;);</code><br>添加的数据的数据列，没有固定，根据添加的数据为准</p></blockquote><blockquote><p>修改<br><code>db.users.update(&#123;age: 25&#125;, &#123;$set: &#123;name: &#39;changeName&#39;&#125;&#125;, false, true);</code><br>相当于：<code>update users set name = &#39;changeName&#39; where age = 25;</code><br><code>db.users.update(&#123;name: &#39;Lisi&#39;&#125;, &#123;$inc: &#123;age: 50&#125;&#125;, false, true);</code><br>相当于：<code>update users set age = age + 50 where name = &#39;Lisi&#39;;</code><br><code>db.users.update(&#123;name: &#39;Lisi&#39;&#125;, &#123;$inc: &#123;age: 50&#125;, $set: &#123;name: &#39;hoho&#39;&#125;&#125;, false, true);</code><br>相当于：<code>update users set age = age + 50, name = &#39;hoho&#39; where name = &#39;Lisi&#39;;</code></p></blockquote><blockquote><p>删除<br><code>db.users.remove(&#123;age: 132&#125;);</code><br>查询修改删除</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span>findAndModify<span class="token punctuation">(</span>&#123;    query: &#123;age: &#123;$gte: <span class="token number">25</span>&#125;&#125;<span class="token punctuation">,</span>    sort: &#123;age: <span class="token operator">-</span><span class="token number">1</span>&#125;<span class="token punctuation">,</span>    <span class="token keyword">update</span>: &#123;$<span class="token keyword">set</span>: &#123;name: <span class="token string">'a2'</span>&#125;<span class="token punctuation">,</span> $inc: &#123;age: <span class="token number">2</span>&#125;&#125;<span class="token punctuation">,</span>    remove: <span class="token boolean">true</span>&#125;<span class="token punctuation">)</span><span class="token punctuation">;</span>db<span class="token punctuation">.</span>runCommand<span class="token punctuation">(</span>&#123; findandmodify : <span class="token string">"users"</span><span class="token punctuation">,</span>    query: &#123;age: &#123;$gte: <span class="token number">25</span>&#125;&#125;<span class="token punctuation">,</span>    sort: &#123;age: <span class="token operator">-</span><span class="token number">1</span>&#125;<span class="token punctuation">,</span>    <span class="token keyword">update</span>: &#123;$<span class="token keyword">set</span>: &#123;name: <span class="token string">'a2'</span>&#125;<span class="token punctuation">,</span> $inc: &#123;age: <span class="token number">2</span>&#125;&#125;<span class="token punctuation">,</span>    remove: <span class="token boolean">true</span>&#125;<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><blockquote><p>update 或 remove 其中一个是必须的参数; 其他参数可选。</p></blockquote><table><thead><tr><th align="left">参数</th><th align="center">详解</th><th align="right">默认值</th></tr></thead><tbody><tr><td align="left">query</td><td align="center">查询过滤条件</td><td align="right">{}</td></tr><tr><td align="left">sort</td><td align="center">如果多个文档符合查询过滤条件，将以该参数指定的排列方式选择出排在首位的对象，该对象将被操作</td><td align="right">{}</td></tr><tr><td align="left">remove</td><td align="center">若为true，被选中对象将在返回前被删除</td><td align="right">N/A</td></tr><tr><td align="left">update</td><td align="center">一个修改器对象</td><td align="right">N/A</td></tr><tr><td align="left">new</td><td align="center">若为true，将返回修改后的对象而不是原始对象。在删除操作中，该参数被忽略。</td><td align="right">false</td></tr><tr><td align="left">fields</td><td align="center">参见Retrievinga Subsetof Fields(1.5.0+)</td><td align="right">All fields</td></tr><tr><td align="left">upsert</td><td align="center">创建新对象若查询结果为空。示例(1.5.4+)</td><td align="right">false</td></tr></tbody></table><h2 id="语句块操作"><a href="#语句块操作" class="headerlink" title="语句块操作"></a>语句块操作</h2><blockquote><p>简单Hello World<br><code>print(&quot;Hello World!&quot;);</code><br>这种写法调用了print函数，和直接写入”Hello World!”的效果是一样的；</p></blockquote><blockquote><p>将一个对象转换成json<br><code>tojson(new Object());</code><br><code>tojson(new Object(&#39;a&#39;));</code></p></blockquote><blockquote><p>循环添加数据</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">for</span> <span class="token punctuation">(</span>var i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span> &#123;<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token keyword">save</span><span class="token punctuation">(</span>&#123;name: <span class="token string">"u_"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> age: <span class="token number">22</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> sex: i <span class="token operator">%</span> <span class="token number">2</span>&#125;<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> &#125;<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这样就循环添加了30条数据，同样也可以省略括号的写法<br><code>for (var i = 0; i &lt; 30; i++) db.users.save(&#123;name: &quot;u_&quot; + i, age: 22 + i, sex: i % 2&#125;);</code><br>也是可以的，当你用db.users.find()查询的时候，显示多条数据而无法一页显示的情况下，可以用it查看下一页的信息；</p></blockquote><blockquote><p>find 游标查询<br><code>var cursor = db.users.find();</code></p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">cursor</span><span class="token punctuation">.</span>hasNext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> &#123;    printjson<span class="token punctuation">(</span><span class="token keyword">cursor</span><span class="token punctuation">.</span><span class="token keyword">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这样就查询所有的users信息，同样可以这样写<br><code>var cursor = db.users.find();</code><br><code>while (cursor.hasNext()) &#123; printjson(cursor.next); &#125;</code><br>同样可以省略{}号</p></blockquote><blockquote><p>forEach迭代循环<br><code>db.users.find().forEach(printjson);</code><br>forEach中必须传递一个函数来处理每条迭代的数据信息</p></blockquote><blockquote><p>将find游标当数组处理<br><code>var cursor = db.users.find();</code><br><code>cursor[4];</code><br>取得下标索引为4的那条数据<br>既然可以当做数组处理，那么就可以获得它的长度：cursor.length();或者cursor.count();<br>那样我们也可以用循环显示数据<br><code>for (var i = 0, len = c.length(); i &lt; len; i++) printjson(c[i]);</code></p></blockquote><blockquote><p>将find游标转换成数组<br><code>var arr = db.users.find().toArray();</code><br><code>printjson(arr[2]);</code><br>用toArray方法将其转换为数组</p></blockquote><p>定制我们自己的查询结果</p><blockquote><p>只显示age &lt;= 28的并且只显示age这列数据<br><code>db.users.find(&#123;age: &#123;$lte: 28&#125;&#125;, &#123;age: 1&#125;).forEach(printjson);</code><br><code>db.users.find(&#123;age: &#123;$lte: 28&#125;&#125;, &#123;age: true&#125;).forEach(printjson);</code></p></blockquote><blockquote><p>排除age的列<br><code>db.users.find(&#123;age: &#123;$lte: 28&#125;&#125;, &#123;age: false&#125;).forEach(printjson);</code></p></blockquote><blockquote><p>forEach传递函数显示信息<br><code>db.things.find(&#123;x:4&#125;).forEach(function(x) &#123;print(tojson(x));&#125;);</code></p></blockquote><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><blockquote><p>查询之前的错误信息：<code>db.getPrevError();</code><br>清除错误记录：<code>db.resetError();</code><br>查看帮助：<code>db.yourColl.help();</code><br>查询当前集合的数据条数：<code>db.yourColl.count();</code><br>查看数据空间大小：<code>db.userInfo.dataSize();</code><br>得到当前聚集集合所在的db：<code>db.userInfo.getDB();</code><br>得到当前聚集的状态：<code>db.userInfo.stats();</code><br>得到聚集集合总大小：<code>db.userInfo.totalSize();</code><br>聚集集合储存空间大小：<code>db.userInfo.storageSize();</code><br>Shard版本信息：<code>db.userInfo.getShardVersion();</code><br>聚集集合重命名：<code>db.userInfo.renameCollection(&quot;users&quot;);</code>   # 将userInfo重命名为users<br>删除当前聚集集合：<code>db.userInfo.drop();</code><br><code>show dbs</code>：显示数据库列表<br><code>show collections</code>：显示当前数据库中的集合（类似关系数据库中的表）<br><code>show users</code>：显示用户<br><code>use &lt;db name&gt;</code>：切换当前数据库，这和MS-SQL里面的意思一样<br><code>db.help()</code>：显示数据库操作命令，里面有很多的命令<br><code>db.foo.help()</code>：显示集合操作命令，同样有很多的命令，foo指的是当前数据库下，一个叫foo的集合，并非真正意义上的命令<br><code>db.foo.find()</code>：对于当前数据库中的foo集合进行数据查找（由于没有条件，会列出所有数据）<br><code>db.foo.find( &#123; a : 1 &#125; )</code>：对于当前数据库中的foo集合进行查找，条件是数据中有一个属性叫a，且a的值为1</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mongo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SHELL</title>
      <link href="/posts/b2c6704d.html"/>
      <url>/posts/b2c6704d.html</url>
      
        <content type="html"><![CDATA[<h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><h3 id="使用内部命令"><a href="#使用内部命令" class="headerlink" title="使用内部命令"></a>使用内部命令</h3><blockquote><p>查找字符串的长度：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token string">"hello world"</span><span class="token builtin class-name">echo</span> <span class="token variable">$&#123;<span class="token operator">#</span>x&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>在Shell中逐行读取文件：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">while</span> <span class="token builtin class-name">read</span> line<span class="token keyword">do</span><span class="token builtin class-name">echo</span> <span class="token variable">$line</span><span class="token keyword">done</span> <span class="token operator">&lt;</span> /path/filename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a>set指令</h3><blockquote><p>遇到变量不存在情况，执行报错<br>``shell<br>set -u<br>set -o nounset</p></blockquote><pre class="line-numbers language-none"><code class="language-none">&gt; 在运行结果之前，先输出执行的哪一行命令&#96;&#96;&#96;shellset -xset -o xtrace<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>运行失败的命令（返回非0），执行报错</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span><span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>set -e有一个例外情况，就是不适用于管道命令。所谓管道命令，就是多个子命令通过管道运算符（|）组合成为一个大的命令。Bash 会把最后一个子命令的返回值，作为整个命令的返回值。也就是说，只要最后一个子命令不失败，管道命令总是会执行成功，因此它后面命令依然会执行，set -e就失效了。</p><blockquote><p>下面的指令能够解决这种情况：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>如果想全面实现该场景的话，就应该使用如下命令：</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token parameter variable">-eo</span> pipefail<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rm命令</title>
      <link href="/posts/5ca01e89.html"/>
      <url>/posts/5ca01e89.html</url>
      
        <content type="html"><![CDATA[<h2 id="rm-误删恢复"><a href="#rm-误删恢复" class="headerlink" title="rm 误删恢复"></a>rm 误删恢复</h2><blockquote><p>前提是被删除的文件正在被使用。</p></blockquote><p>创建文件，模拟被占用的情况</p><p><img src="/medias/img/rm%E5%91%BD%E4%BB%A4/image-20230629210612498.png"></p><p>新开一个终端，删除文件</p><p><img src="/medias/img/rm%E5%91%BD%E4%BB%A4/image-20230629211010454.png"></p><h2 id="找回文件"><a href="#找回文件" class="headerlink" title="找回文件"></a>找回文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ll log</span>ls: 无法访问<span class="token string">'log'</span><span class="token builtin class-name">:</span> No such <span class="token function">file</span> or directory<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep log$</span>root      <span class="token number">353872</span>  <span class="token number">353697</span>  <span class="token number">0</span> <span class="token number">21</span>:05 pts/1    00:00:00 <span class="token function">tail</span> <span class="token parameter variable">-f</span> log<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ll /proc/353872|grep ^l</span>lrwxrwxrwx  <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:15 cwd -<span class="token operator">></span> /root   <span class="token comment"># 文件占用程序运行的目录</span>lrwxrwxrwx  <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:15 exe -<span class="token operator">></span> /usr/bin/tail   <span class="token comment"># 文件占用程序</span>lrwxrwxrwx  <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:15 root -<span class="token operator">></span> /<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># lsof|grep \(deleted\)$   # 查看所有被删除的文件</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># lsof|grep \(deleted\)$|grep /root/log   # 查看被删除的文件</span><span class="token function">tail</span>      <span class="token number">353872</span>                            root    3r      REG              <span class="token number">252,0</span>         <span class="token number">9</span>  <span class="token number">135321620</span> /root/log <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ll /proc/353872/fd   # 查看被删除的文件</span>总用量 <span class="token number">0</span>lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">0</span> -<span class="token operator">></span> /dev/pts/1lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">1</span> -<span class="token operator">></span> /dev/pts/1lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">2</span> -<span class="token operator">></span> /dev/pts/1lr-x------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">3</span> -<span class="token operator">></span> <span class="token string">'/root/log (deleted)'</span>lr-x------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">4</span> -<span class="token operator">></span> anon_inode:inotify<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看被删除的文件</p><p><img src="/medias/img/rm%E5%91%BD%E4%BB%A4/image-20230629212749344.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 恢复</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cp /proc/353872/fd/3 /tmp/   # 可以使用cp备份</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /proc/353872/fd/3 > /root/log   # 也可以使用IO标准输出到原位置</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/3</span><span class="token number">77</span><span class="token number">88</span><span class="token number">99</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /root/log</span><span class="token number">77</span><span class="token number">88</span><span class="token number">99</span><span class="token comment"># 查看原来的PID，即使恢复文件，也是显示被删除的状态，重启服务即可。当然PID也会改变。</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ll /proc/353872/fd</span>总用量 <span class="token number">0</span>lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">0</span> -<span class="token operator">></span> /dev/pts/1lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">1</span> -<span class="token operator">></span> /dev/pts/1lrwx------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">2</span> -<span class="token operator">></span> /dev/pts/1lr-x------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">3</span> -<span class="token operator">></span> <span class="token string">'/root/log (deleted)'</span>lr-x------ <span class="token number">1</span> root root <span class="token number">64</span> <span class="token number">6</span>月  <span class="token number">29</span> <span class="token number">21</span>:22 <span class="token number">4</span> -<span class="token operator">></span> anon_inode:inotify<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rm命令详解"><a href="#rm命令详解" class="headerlink" title="rm命令详解"></a>rm命令详解</h2><p><a href="../linux-command-1.16.0/rm">rm</a> - 用于删除给定的文件和目录</p><h2 id="rm命令拓展"><a href="#rm命令拓展" class="headerlink" title="rm命令拓展"></a>rm命令拓展</h2><blockquote><p>rmdir<br><a href="../linux-command-1.16.0/rmdir">rmdir</a> - 用来删除空目录</p></blockquote><blockquote><p>rmmod<br><a href="../linux-command-1.16.0/rmmod">rmmod</a> - 从运行的内核中移除指定的内核模块</p></blockquote><blockquote><p>atrm<br><a href="../linux-command-1.16.0/atrm">atrm</a> - 删除待执行任务队列中的指定任务</p></blockquote><blockquote><p>lprm<br><a href="../linux-command-1.16.0/lprm">lprm</a> - 删除打印队列中的打印任务</p></blockquote><blockquote><p>colrm<br><a href="../linux-command-1.16.0/colrm">colrm</a> - 删除文件中的指定列</p></blockquote><blockquote><p>ipcrm<br><a href="../linux-command-1.16.0/ipcrm">ipcrm</a> - 删除消息队列、信号集、或者共享内存标识</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SHELL正则</title>
      <link href="/posts/a3e8bf48.html"/>
      <url>/posts/a3e8bf48.html</url>
      
        <content type="html"><![CDATA[<p>POSIX括号表达式</p><p>POSIX方括号表达式是一种特殊的字符类。 POSIX中括号表达式匹配一组字符中的一个字符，就像常规字符类一样。</p><p>标准POSIX</p><table><thead><tr><th>正则表达式</th><th>匹配的字符范围</th></tr></thead><tbody><tr><td><code>[[:alnum:]]</code></td><td>所有字母和数字(包括大写和小写)</td></tr><tr><td><code>[[:alpha:]]</code></td><td>所有字母(包括大写和小写)</td></tr><tr><td><code>[[:blank:]]</code></td><td>所有空白字符，如空格、制表符、换页符等</td></tr><tr><td><code>[[:cntrl:]]</code></td><td>所有控制字符，如退格、回车、换页等</td></tr><tr><td><code>[[:digit:]]</code></td><td>所有数字字符</td></tr><tr><td><code>[[:graph:]]</code></td><td>所有可打印的字符，即非空白、非控制字符的字符</td></tr><tr><td><code>[[:lower:]]</code></td><td>所有小写字母</td></tr><tr><td><code>[[:print:]]</code></td><td>所有可打印的字符，与<code>[[:graph:]]</code>相同</td></tr><tr><td><code>[[:punct:]]</code></td><td>所有标点符号</td></tr><tr><td><code>[[:space:]]</code></td><td>所有空白字符，如空格、制表符、换页符等</td></tr><tr><td><code>[[:upper:]]</code></td><td>所有大写字母</td></tr><tr><td><code>[[:xdigit:]]</code></td><td>所有十六进制数字字符</td></tr></tbody></table><p>无标准</p><table><thead><tr><th>正则表达式</th><th>匹配的字符范围</th></tr></thead><tbody><tr><td><code>[[:ascii:]]</code></td><td>所有 ASCII 字符，即 0-127 范围内的字符</td></tr><tr><td><code>[[:word:]]</code></td><td>所有单词字符，即字母、数字和下划线组成的字符串，不包括空格和标点符号</td></tr></tbody></table><p>旧式语法</p><table><thead><tr><th>正则表达式</th><th>匹配的字符范围</th></tr></thead><tbody><tr><td><code>[[:&lt;:]]</code></td><td>Start of Word 所有左尖括号，即 <code>&lt;</code> 字符</td></tr><tr><td><code>[[:&gt;:]]</code></td><td>End of Word 所有右尖括号，即 <code>&gt;</code> 字符</td></tr></tbody></table><p>随机数</p><p>bash默认有一个RANDOM的变量  默认是0~32767</p><p>使用 echo $RANDOM 随机产生一个随机数</p><p>使用 set|grep RANDOM 查看上一次产生的随机数</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo $RANDOM</span><span class="token number">11932</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># set |grep RANDOM</span><span class="token assign-left variable"><span class="token environment constant">RANDOM</span></span><span class="token operator">=</span><span class="token number">28738</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>举例说明</p><pre class="line-numbers language-none"><code class="language-none">产生0~1之间的随机数echo $[$RANDOM%2]产生0~2之间的随机数echo $[$RANDOM%3]...产生0~100内的随机数echo $[$RANDOM%101]产生50-100之内的随机数（原理：0-50的范围+50）echo $[$RANDOM%51+50]   50-100——&gt;0-50——&gt;%51 +50产生三位数的随机数（范围是100-999，可以由0-899的范围+100得到）echo $[$RANDOM%900+100]     100-999 ——&gt;0-899——&gt;%900 +100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用set|grep RANDOM查看上一次产生的随机数</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># echo $RANDOM</span><span class="token number">15832</span><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># set |grep RANDOM</span><span class="token assign-left variable"><span class="token environment constant">RANDOM</span></span><span class="token operator">=</span><span class="token number">15832</span><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dingtalk</title>
      <link href="/posts/ca3e5e1b.html"/>
      <url>/posts/ca3e5e1b.html</url>
      
        <content type="html"><![CDATA[<p>添加机器人：</p><p>1.找到群<br><img src="/medias/img/others/5.jpg"><br>2.添加自定义机器人<br><img src="/medias/img/others/6.jpg"><br>3.记住webhook<br><img src="/medias/img/others/7.jpg"><br>4.记住签值，鼠标放在框里面双击可以复制，不嫌麻烦可以添加关键字和IP地址段，与加签相比，比较容易实现。<br><img src="/medias/img/others/8.jpg"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># coding: utf-8</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> json<span class="token keyword">import</span> codecs<span class="token keyword">import</span> time<span class="token keyword">import</span> hmac<span class="token keyword">import</span> hashlib<span class="token keyword">import</span> base64<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse<span class="token keyword">from</span> time <span class="token keyword">import</span> strftime<span class="token punctuation">,</span> localtimelocaltime <span class="token operator">=</span> strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token comment"># 此段代码是python3把timestamp+"\n"+密钥当做签名字符串，使用HmacSHA256算法计算签名，然后进行Base64 encode，最后再把签名参数再进行urlEncode，得到最终的签名sign（需要使用UTF-8字符集）</span>timestamp <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>secret <span class="token operator">=</span> <span class="token string">'SEC******'</span>   <span class="token comment"># 签值</span>secret_enc <span class="token operator">=</span> secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>string_to_sign <span class="token operator">=</span> <span class="token string">'&#123;&#125;\n&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>string_to_sign_enc <span class="token operator">=</span> string_to_sign<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>hmac_code <span class="token operator">=</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>secret_enc<span class="token punctuation">,</span> string_to_sign_enc<span class="token punctuation">,</span>                     digestmod<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>sign <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote_plus<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hmac_code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">DingTalk_Base</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json;charset=utf-8'</span><span class="token punctuation">&#125;</span>        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">send_msg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>        json_text <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token string">"msgtype"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>            <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"content"</span><span class="token punctuation">:</span> text            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token string">"at"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"atMobiles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                    <span class="token string">""</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token string">"isAtAll"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_text<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>__headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token keyword">class</span> <span class="token class-name">DingTalk_Disaster</span><span class="token punctuation">(</span>DingTalk_Base<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 填写机器人的webhook</span>        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">'https://oapi.dingtalk.com/robot/send?access_token=******'</span> <span class="token operator">+</span> \            <span class="token string">'&amp;timestamp='</span> <span class="token operator">+</span> timestamp <span class="token operator">+</span> <span class="token string">'&amp;sign='</span> <span class="token operator">+</span> sign<span class="token keyword">with</span> codecs<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./text'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    txt <span class="token operator">=</span> localtime <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>   <span class="token comment"># .strip('\n')去除首行和尾行的空行</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    ding <span class="token operator">=</span> DingTalk_Disaster<span class="token punctuation">(</span><span class="token punctuation">)</span>    ding<span class="token punctuation">.</span>send_msg<span class="token punctuation">(</span>txt<span class="token punctuation">)</span>    <span class="token comment"># ding.send_msg('加盐\ntest')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>将text文件放在py文件的同级目录</strong></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">roxn测试信息haha2haha<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这里分享一个python打包py文件成可执行文件。</p><p>方法一：</p><p><code>pip3 install wheel pyinstaller tinyaes</code>安装打包模块<br><code>pyinstaller -F dingtalk.py</code>直接打包可以被反编译成源代码</p><p>反编译<code>pyhton pyinstxtractor.py xxx</code></p><p>方法二：</p><p>对源码加密打包安装模块</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> Cythonpip3 uninstall Cryptopip3 <span class="token function">install</span> pycrypto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>生成key：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span> /dev/urandom <span class="token function">tr</span> <span class="token parameter variable">-dc</span> <span class="token number">0</span>-9-A-Z-a-z-_,.?<span class="token operator">=</span>+@%<span class="token operator">!</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token variable">$&#123;1<span class="token operator">:-</span>64&#125;</span><span class="token punctuation">;</span><span class="token builtin class-name">echo</span>openssl rand <span class="token parameter variable">-base64</span> <span class="token number">32</span><span class="token operator">|</span><span class="token function">tr</span> A-Z a-z<span class="token operator">|</span><span class="token function">cut</span> <span class="token parameter variable">-c</span> <span class="token number">1</span>-64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>pyinstaller -F --key=****** --clean dingtalk.py</code>加密打包</p><p>生成dist/dingtalk可执行文件</p><p>遇到的麻烦事：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">    src/MD2.c:31:10: 致命错误：Python.h：No such <span class="token function">file</span> or directory     <span class="token comment">#include "Python.h"</span>              ^~~~~~~~~~    编译中断。    error: <span class="token builtin class-name">command</span> <span class="token string">'gcc'</span> failed with <span class="token builtin class-name">exit</span> status <span class="token number">1</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc python3-devel   <span class="token comment"># 解决</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">执行打包好的文件不报错不发送信息原因：时间未同步设置了加盐发送消息时间未做同步<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其它问题：</p><p>如果你看这篇文档之前安装了许多插件，你可能需要卸载掉一些</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 uninstall pycryptodomepip3 uninstall Crypto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> dingtalk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSH</title>
      <link href="/posts/782a8ece.html"/>
      <url>/posts/782a8ece.html</url>
      
        <content type="html"><![CDATA[<h1 id="ssh服务讲解"><a href="#ssh服务讲解" class="headerlink" title="ssh服务讲解"></a>ssh服务讲解</h1><p>SSH简介：</p><p>SSH是一种安全通道协议，主要用来实现字符界面的远程登录，远程复制等功能</p><p>ssh协议对通信双方的数据传输进行了加密处理，其中包括用户登录时输入的用户口令</p><p>与telnet等应用相比，ssh协议提供了更好的安全性</p><p>OpenSSH：ssh协议的开源实现</p><p>配置openssh服务器端：</p><p>ssh服务是”C/S”架构的，C代表客户端，S代表服务器端</p><p>在安装Linux系统时openssh服务默认已经安装</p><p>ssh服务及配置文件：</p><p>openssh-server：服务器端软件</p><p>openssh-clients：客户端软件</p><p>要保证这两个包都安装才行</p><p>启动：service sshd start</p><p>配置文件：</p><p>/etc/ssh/sshd_config</p><p>配置项：</p><p>Port 22：port代表监听的端口，默认22，可修改</p><p>ListenAddress 0.0.0.0：监听的IP地址，默认为所有，可修改</p><p>Protocol 2：代表的ssh的第二个版本</p><p>LoginGraceTime 2m：输入用户名后，2分钟不输入密码自动关闭</p><p>PermitRootLogin yes：是否允许root登录</p><p>MaxAuthTries 6：最大的认证次数，即输入密码次数</p><p>RSAAuthentication yes：启用RSA算法认证</p><p>PubkeyAuthentication yes：启用公钥认证</p><p>AuthorizedkeysFile：~/.ssh/authorized_keys公钥放置位置，在对应用户的家目录下面的.ssh隐藏目录中，名字为authorized_keys文件</p><p>PasswordAuthentication yes：密码认证</p><p>PermitEmptyPasswords no：是否允许空密码登录</p><p>限制可登录用户的配置：（allow白名单，deny黑名单）</p><p>AllowUsers user1 user2 user3…</p><p>DenyUsers</p><p>AllowGroups</p><p>DenyGroups</p><p>登录验证方法：</p><p>ssh服务支持两种验证方式：密码验证、密钥对验证，可以只设置其中一种方式，也可以两种方式都启用</p><p>密码验证：以服务器中本地系统用户的远程登录名称、密码进行验证，这种方式使用最为简便，但以客户机角度来看，正在连接的服务器有可能被假冒，从服务器角度来看，当遇到密码穷举（即暴力破解）攻击时，防御力能力比较弱</p><p>密钥对验证：要求提供相匹配的密钥信息才能通过验证</p><p>使用ssh客户端程序</p><p>客户端组件：</p><p>命令程序：ssh、scp、sftp</p><p>图形工具：Xshell</p><p>ssh远程登录命令</p><p>格式：<code>ssh [user@]host [command]</code></p><p><code>-p port</code>：远程服务器监听的端口</p><p>例如：<code>ssh test@192.168.0.10</code></p><p>使用test用户登录192.168.0.10这台服务器，注意：test用户是192.168.0.10这台服务器上的用户</p><p>scp命令：</p><p>scp [options] SRC… DEST/</p><p>两种方式：</p><p><code>scp [options] [user@]host:/sourcefile /testdir</code></p><p><code>scp [options] /sourcefile [user@]host:/testpath</code></p><p>常用选项：</p><p><code>-C</code>：压缩数据流</p><p><code>-r</code>：递归复制</p><p><code>-p</code>：保持原文件的修改时间、访问时间、权限</p><p><code>-P PORT</code>：指明远程主机监听的端口</p><h1 id="远程复制工具"><a href="#远程复制工具" class="headerlink" title="远程复制工具"></a>远程复制工具</h1><p>rsync命令：</p><p>基于ssh和rsh服务实现高效率的远程系统之间复制文件</p><p>使用安全的shell连接做为传输方式</p><p><code>rsync -av /etc/passwd server1:/tmp</code>复制目录和目录下文件</p><p><code>rsync -av /etc/ server1:/tmp</code>只复制目录下文件</p><p>比scp更快，只复制不同的文件</p><p>选项：</p><p><code>-n</code>模拟复制过程</p><p><code>-v</code>显示过程</p><p><code>-r</code>递归复制目录树</p><p><code>-p</code>保留权限</p><p><code>-t</code>保留时间戳</p><p><code>-g</code>保留组信息</p><p><code>-o</code>保留所有者信息</p><p>ssh客户端：</p><p>允许实现对远程系统经验证地加密安全访问</p><p>当用户远程连接ssh服务器时会复制ssh服务器<code>/etc/ssh/ssh_host*key.pub</code>文件中的公钥到客户机的<code>~./ssh/know_hosts</code>中，下次连接时，会比较两处是否有不同</p><h1 id="基于key认证"><a href="#基于key认证" class="headerlink" title="基于key认证"></a>基于key认证</h1><p>基于key认证：</p><p>在服务器、客户端中构建密钥对验证ssh的基本过程</p><p>第一步：创建密钥对：</p><p>公钥文件：id_rsa.pub</p><p>私钥文件：id_rsa</p><p>第二步：上传公钥文件id_rsa.pub到服务器中</p><p>第三步：导入公钥信息</p><p>公钥库文件：~/.ssh/authorized_key（此文件的权限必须为600）</p><p>第四步：使用密钥对方式验证</p><p>具体实现两种方式：</p><p>第一种方式（较复杂）：</p><p>使用<code>user</code>用户连接<code>ssh</code>服务器的<code>user1</code>用户</p><p>第一步：在客户端创建密钥对</p><p><code>su - 客户端用户</code></p><p><code>ssh-keygen -t rsa -b 2048</code>（一路回车）</p><p>第二步：上传公钥</p><p><code>cd /home/客户端用户/.ssh</code></p><p><code>scp id_rsa.pub root@服务端IP:/tmp</code></p><p>第三步：在ssh服务器中设置</p><p><code>cd /tmp</code></p><p><code>mkdir /home/服务端用户/.ssh</code></p><p><code>cat id_rsa.pub &gt; /home/服务端用户/.ssh/authorized_keys</code>（相当于mv id_rsa.pub /home/服务端/.ssh/authorized_keys）</p><p><code>chmod 600 /home/服务端用户/.ssh/authorized_keys</code></p><p>第四步：在客户端登录验证</p><p>第二种方式（简单）</p><p>使用客户端用户连接ssh服务器的服务端用户</p><p>第一步：在客户机创建密钥对</p><p><code>su - user</code></p><p><code>ssh-keygen -t rsa -b 2048</code></p><p>第二步：直接导入公钥到user1用户的家目录中</p><p><code>ssh-copy-id -i id_rsa.pub user1@192.168.0.10</code>（cd 到用户家目录下的.ssh目录下）</p><p>输入user1用户的密码</p><p>查看是否成功</p><p>第三步：在客户端验证</p><p>ssh <a href="mailto:&#117;&#115;&#101;&#x72;&#x31;&#64;&#49;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#x2e;&#48;&#46;&#x31;&#48;">&#117;&#115;&#101;&#x72;&#x31;&#64;&#49;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#x2e;&#48;&#46;&#x31;&#48;</a>以user1用户登录看是否免密</p><p>ssh服务最佳实践</p><p>1、不要使用默认端口</p><p>2、禁止使用Protocol version 1</p><p>3、限制可登录用户</p><p>4、设定空闲会话超时时长</p><p>5、利用防火墙设置ssh访问策略</p><p>6、仅监听特定的IP地址 </p><p>7、基于口令认证时，使用强密码策略</p><p>8、使用基于密钥的认证</p><p>9、禁止使用空密码</p><p>10、禁止root用户直接登录</p><p>11、限制ssh的访问频度和并发在线数</p><p>12、做好日志，经常分析</p><h1 id="sudo提升权限"><a href="#sudo提升权限" class="headerlink" title="sudo提升权限"></a>sudo提升权限</h1><p>sudo的用途：</p><ol><li><p>sudo 能够授权指定用户在指定主机上运行某些命令，如果未授权用户尝试使用，sudo会提示联系管理员</p></li><li><p>sudo 可以提供日志，记录每个用户使用sudo操作</p></li><li><p>sudo 为系统管理员提供配置文件，允许系统管理员集中地管理用户的使用权限的使用的主机</p></li><li><p>sudo 使用时间戳文件来完成类似”检票”的系统 默认存活期为5分钟的”入场券”</p></li></ol><p>通过visudo命令编辑配置文件，具有文件，具有语法检查功能</p><p><code>visudo -c</code>检查语法</p><p>配置sudo授权</p><p>配置文件：<code>/etc/sudoers</code>，<code>/etc/sudoers.d/</code></p><p>日志文件：<code>/var/log/secure</code></p><p>配置文件支持使用通配符<code>glob</code>：</p><p><code>?</code>匹配单一字符</p><p><code>*</code>匹配任意长度字符</p><p><code>[wxc]</code>匹配其中一个字符</p><p><code>[^wxc]</code>除了给定的字符</p><p><code>\x</code>转义</p><p><code>[[:alpha:]]</code>字母 示例：<code>/bin/ls [[:alpha:]]*</code></p><p><code>!</code>排除</p><p>使用方法：</p><p><code>sudo [参数] [授权命令]</code></p><p>参数：</p><p><code>-u user</code>：以指定用户身份运行命令</p><p><code>-l</code>：查看当前用户可以执行的命令</p><p><code>-v</code>：更新用户的时间戳而不执行命令</p><p><code>-V</code>：显示sudo的版本信息</p><p>配置文件格式：</p><p>使用visudo命令或执行<code>vi /etc/sudoers</code>打开配置文件</p><p>文件中记录格式：</p><p>用户  主机名列表=（代表用户）命令程序列表</p><p>ALL： 代表所有</p><p>NOPASSWD：免密</p><p>用户：运行命令者的身份</p><p>主机列表：通过哪些主机</p><p>代表用户：以哪个用户的身份</p><p>命令程序列表：运行哪些命令</p><p>注意：如果只授权用户登录本机执行命令，主机写本地ip即可</p><p>例如：</p><p>给user这个用户sudo权限，允许他在test这台主机中可执行/bin/下的所有命令，除了/sbin/reboot/外</p><p><code>visudo</code></p><p><code>user test=/sbin/*,!/sbin/reboot</code></p><p>现在user用户就可以使用授权的命令了</p><p><code>su - user</code></p><p>sudo授权命令（会提示输入密码，输入user用户的密码即可，输入密码后5分钟内不用再输入密码）</p><p>sudo别名</p><p>别名设置：</p><p>别名有四种类型：</p><p>User_Alias用户别名</p><p>Runas_Alias代表用户别名（可以省略）</p><p>Host_Alias主机别名</p><p>Cmnd_Alias命令别名</p><p>（U、H、C后面可以跟多个用 ，分开）</p><pre class="line-numbers language-none"><code class="language-none">User_Alias U&#x3D;hahaHost_Alias H&#x3D;testCmnd_Alias C&#x3D;&#x2F;sbin&#x2F;*U H&#x3D;C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>格式：<code>Alias_Type NAME1=item1,item2,item3…</code></p><p>例如：定义用户别名为USER，包括user1，user2，user3，user4四个用户</p><p><code>User_Alias USER=user1,user2,user3,user4</code></p><p>这条别名就可以用来引用了</p><p><code>USER test=/sbin/*</code></p><p>sudo别名</p><p>也可以将用户加入到组里进行统一管理，例如wheel组，组名前要加% 将用户加入到wheel组中，然后对wheel进行授权</p><p><code>%wheel test=ALL</code></p><pre class="line-numbers language-none"><code class="language-none">User_Alias U&#x3D;hahaHost_Alias H&#x3D;testCmnd_Alias C&#x3D;&#x2F;sbin&#x2F;*U H&#x3D;C%wheel H&#x3D;ALL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样wheel组里的所有用户都可以执行test主机里面的所有命令了</p><h1 id="ssh端口转发"><a href="#ssh端口转发" class="headerlink" title="ssh端口转发"></a>ssh端口转发</h1><p>转发到远端：<code>ssh -C -f -N -g -L 本地端口:目标IP:目标端口 用户名@目标IP</code></p><p>转发到本地：<code>ssh -C -f -N -g –R 本地端口:目标IP:目标端口 用户名@目标IP</code></p><p>本地ssh不是22，需要最后指定本地端口</p><p><code>ssh -C -f -N -g -L 本机端口:远端IP:远端端口 root@远端IP -p port</code></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/ssh-add">ssh-add添加密钥到agent</a><br><a href="../linux-command-1.16.0/ssh-agent">ssh-agent密钥管理器</a><br><a href="../linux-command-1.16.0/ssh-copy-id">ssh-copy-id安装密钥</a><br><a href="../linux-command-1.16.0/ssh-keygen">ssh-keygen生成和管理密钥</a><br><a href="../linux-command-1.16.0/ssh-keyscan">ssh-keyscan收集公钥</a><br><a href="../linux-command-1.16.0/ssh">ssh连接工具</a><br><a href="../linux-command-1.16.0/sshd">sshd守护进程</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安全和加密</title>
      <link href="/posts/6fa1aa0.html"/>
      <url>/posts/6fa1aa0.html</url>
      
        <content type="html"><![CDATA[<h1 id="安全和加密"><a href="#安全和加密" class="headerlink" title="安全和加密"></a>安全和加密</h1><p>OpenSSL由三部分组成：</p><p>libencrypto库：加密解密库</p><p>libssl库：实现ssl安全通信机制的库</p><p>openssl：多用途命令行工具</p><p>TCP、UDP 传输层协议</p><p>TCP协议：应用层,数据、传输层,（封装TCP首部）段、网络层（封装IP首部）叫报文、数据链路层（封装MAC首部）、发送</p><p>SSL安全套接字层，就是IP+端口，可以确认主机上的应用程序，不同的应用程序就是IP+不同的端口号？？？？？</p><p>SSL是应用层和传输层之间的一个模块</p><p>http+调用ssl库—&gt;https</p><p>https调用了SSL协议，httpd调用了ssl库就使用加密传输，反之不加密传输 </p><p><strong>http协议的实现，是由httpd程序完成的</strong></p><p>通信安全的目标（及受攻击类型）：</p><p>保密性（窃听、通信量分析）</p><p>完整性（更改、伪装、重放、否认）</p><p>可用性（拒绝服务DoS）</p><p>加密完全体：</p><p>原始数据，获取校验码，用发件人的私钥加密校验码、对称加密，加密校验码和原始数据，用收件人公钥加密对称加密密码、发送</p><p>校验码：md5、sha1、sha224等</p><p>（对称加密：对较大文件加密时，比非对称加密耗费的时间少）</p><p>CA认证：（CA有很多，各种CA之间互信）</p><p>将公钥送到CA进行认证，获得“CA证书”</p><p>证书信息：版本号、签名、证书发行者、有效期、主体公钥、等等</p><p>CA：公钥转发信任机构，客户把自己的公钥送往CA认证，CA会对公钥的特征码用CA的私钥加密（签名），互换公钥的两个客户端，把公钥送到CA认证，认证完成后用对方的公钥加密证书特征码（使用对方公钥加密是为了保证证书完整性）后互换证书，如果可以用CA的公钥解开（验证签名）双方公钥的加密特征码，证明证书是CA颁布的、可信任的</p><hr><p>加密算法和协议：</p><p>对称加密：加密和解密使用同一个密钥</p><p>算法：3DES、AES（支持128 bits 、192bits 、256bits 、384bits）</p><p>特性：加密解密使用同一个密钥、将原始数据分割成固定大小的块，逐个进行加密</p><p>缺陷：密钥过多，分发困难</p><p>公钥加密：密钥分为公钥和与之配对的私钥</p><p>公钥：从私钥中提取产生，可以公开给所有人</p><p>私钥：通过算法创建，使用者自己保留，以保证其私密性</p><p>特点：使用公钥加密的数据，只能使用对应的私钥解开</p><p>用途：数字签名，主要用于让接收方确认发送方的身份</p><p>密钥交换：发送方用对方的公钥加密一个对称密钥，并发送给对方</p><p>算法：RSA（只能签名，不能加解密），DSA（签名和加解密），ELGamal（商业的）</p><p>单向加密：即提取数据特征码</p><p>特性：定长输出、雪崩效应</p><p>功能：校验数据的完整性</p><p>算法：md5 、sha1 、sha224 、sha256等</p><p>密钥交换：IKE</p><p>公钥加密DH</p><p>ECDH（椭圆曲线DH），ECDHE（临时椭圆曲线DH）</p><p>DH算法的实现</p><p>A：p,g</p><p>B：p,g</p><p>A：x生成密钥x</p><p>—&gt;p^y%g==&gt;B  将与x计算出的结果发送给B</p><p>   A：(p^y%g)^x=p^yx%g  计算得到密钥</p><p>B：yB生成密钥y</p><p>—&gt;p^y%g==&gt;A  将与y计算结果发送给A</p><p>   B：(p^x%g)^y=p^xy%g  计算得到密钥</p><p>PKI：（公钥基础设施）</p><p>签证机构：CA</p><p>注册机构：RA</p><p>证书吊销列表：CRL</p><p>证书存取库：CB</p><p>X.509v3：定义了证书的结构以及认证协议标准</p><p>版本号</p><p>签名算法ID</p><p>发行者名称</p><p>有效期、等等</p><p>SSL：安全套接字层</p><p>由网景公司于1994年开发</p><p>版本：V1.0，V2.0，V3.0</p><p>TLS：传输层安全，二者基本上兼容</p><p>IETF组织1999年发行</p><p>版本：V1.0，V1.1，V1.2，V1.3</p><p>目前建议使用的是V1.2版</p><p>TLS本身也采用了分层设计：</p><p>1、最底层：基础算法原语的实现，aes，rsa，md5</p><p>2、向上一层：各种算法的实现</p><p>3、再向上一层：组合算法实现的半成品</p><p>4、最上层：用各种组件拼装而成的各种成品密码学协议软件</p><p>此两种协议的开源实现方式：OpenSSL</p><p>OpenSSL分为三种</p><p>libencrypto库：加密解密库</p><p>libssl库：实现ssl安全通信机制的库</p><p>openssl：多用途命令行工具</p><p>SSL会话主要有三步：</p><p>一、客户端向服务端索要并验证证书</p><p>二、双方协商生成“会话密钥”</p><p>三、双方采用“会话密钥”进行加密通信</p><p>SSL握手</p><p>第一阶段：客户端请求</p><p>支持的协议版本，如tls1.2</p><p>客户端生成一个随机数，稍后用于生成“会话密钥”</p><p>支持的加密算法，如AES、3DES、RSA</p><p>支持的压缩算法</p><p>第二阶段：服务端回应</p><p>确认使用的加密通信协议版本，如tls1.2</p><p>服务器端生成一个随机数，稍后用于生成“会话密钥”</p><p>确认使用的加密方法</p><p>服务器证书</p><p>第三阶段：</p><p>验证服务器证书，在确认无误后取出其公钥（发证机构、证书的完整性、证书持有者、有效期、吊销列表）</p><p>验证后发送一下信息给服务端一个随机数（目的是为了安全）</p><p>编码变更通知，表示随后的信息都将使用双方商定的加密方法和密钥发送</p><p>客户端握手结束通知</p><p>第四阶段：</p><p>收到客户端发来的第三个随机数后，计算生成本次会话所用到的“会话密钥”</p><p>向客户端发送如下信息：</p><p>编码变更通知，表示随后的信息都将使用双方商定的加密方法和密钥发送服务端握手结束通知</p><p>对称加密：</p><p>加密：<code>openssl enc [-e] -des3 [-a -salt] -in file -out file.m</code></p><p><img src="/medias/img/openssl/0.png"><br>解密：<code>openssl enc -d -des3 [-a -salt] -in file.m -out file1</code></p><p><img src="/medias/img/openssl/1.png"><br>选项：</p><p><code>-e</code>：加密使用</p><p><code>-d</code>：解密使用</p><p><code>-des3</code>：加密算法</p><p><code>-a</code>：文本编码格式</p><p><code>-salt</code>：加盐</p><p>单向加密：</p><p><code>openssl dgst -md5 file</code>（获取文件的md5特征码）</p><p><img src="/medias/img/openssl/2.png"><br><code>md5sum file</code>（释义同上）</p><p><img src="/medias/img/openssl/3.png"><br>算法md5、sha1、sha224等</p><p><img src="/medias/img/openssl/4.png"></p><p>生成用户密码：</p><p><code>openssl passwd -1 [-salt az]</code>（-1指定md5，-salt加盐，即随机数）</p><p><img src="/medias/img/openssl/5.png"><br><img src="/medias/img/openssl/6.png"><br>（不加盐，输入同样的密码，打印出的结果不同）</p><p>生成随机数：</p><p><code>openssl rand -hex #</code>（生成16进制随机数，打印字节数是给定的数字的2倍）</p><p><img src="/medias/img/openssl/7.png"><br>（给同样的数，每次打印出的结果不同）</p><p><code>openssl rand -base64 #</code>（使用base64编码）</p><p><img src="/medias/img/openssl/8.png"><br>（打印结果为4N，不足4N用 = 号补位，命令行每按顺序+3次，打印结果循环一次，即打印4(N+1）位，释义：命令行给3N+1，打印两个 = ；命令行给3N+2，打印一个 = ；命令行给3N+3，打印零个  = ）</p><p>生成私钥：</p><p><code>(umask 077;openssl genrsa -out file.s)</code>或<code>(umask 077;openssl genrsa -out file.s -des 1024)</code>加密的私钥（括号是为了和外边的shell环境隔离,使给定的umask值有效）</p><p><img src="/medias/img/openssl/9.png"><br><img src="/medias/img/openssl/10.png"><br>提取公钥：</p><p><code>openssl rsa -in file.s -pubout -out file.g</code></p><p>选项：</p><p><code>-pubout</code>：指明提取公钥</p><p><img src="/medias/img/openssl/11.png"></p><p>公钥加密：</p><p><code>openssl rsautl -encrypt -in testfile -inkey file.g -pubin -out tsetfile.m</code></p><p>私钥解密：</p><p><code>openssl rsautl -decrypt -in testfile.m -inkey file.s -out file2</code> </p><p>选项：</p><p><code>rsautl</code>：算法</p><p><code>-encrypt</code>：加密使用</p><p><code>-decrypt</code>：解密使用</p><p><code>-inkey</code>：指定密钥</p><p><code>-pubin</code>：表明是纯公钥加密</p><p><img src="/medias/img/openssl/12.png"></p><p>CA：</p><p>公共信任的CA，私有CA</p><p>建立私有CA，openssl命令：</p><p>配置文件：<code>/etc/pki/tls/openssl.cnf</code></p><p>在确定配置为CA的服务器上生成一个自签证书，并为CA提供所需要的目录及文件即可</p><p>实现步骤：</p><p>1.生成私钥：</p><p><code>(umask 077;openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)</code></p><p><img src="/medias/img/openssl/13.png"><br>2.生成自签证书：</p><p><code>openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 365</code></p><p><img src="/medias/img/openssl/14.png"><br>选项：</p><p><code>req</code>：证书请求即证书生成工具</p><p><code>-new</code>：生成新证书签署请求</p><p><code>-x509</code>：生成自签格式的证书，专用于创建私有CA时</p><p><code>-key</code>：生成请求时用到的私有文件路径</p><p><code>-out</code>：生成的请求文件路径；如果自签操作将直接生成签署过的证书</p><p><code>-days</code>：证书的有效时长，单位为天</p><p>3.为CA提供所需的目录及文件</p><p><code>mkdir -pv /etc/pki/CA/&#123;certs,crl,newcerts&#125;</code></p><p><code>touch /etc/pki/CA/&#123;serial,index.txt&#125;</code></p><p><code>echo 01 &gt; /etc/pki/CA/serial</code></p><p><img src="/medias/img/openssl/15.png"></p><p>要用到证书进行安全通信的服务器，需要向CA请求签署证书</p><p>步骤：（以httpd为例）</p><p>4.用到证书的主机生成私钥（要认证机构）</p><p><code>mkdir /etc/httpd/ssl;cd /etc/httpd/ssl</code></p><p><code>(umask 077;openssl genrsa -out /etc/httpd/ssl/httpd.key 2048)</code></p><p><img src="/medias/img/openssl/16.png"><br>5.生成证书签署请求（要认证机构）</p><p><code>openssl req -new -key /etc/httpd/ssl/httpd.key -out /etc/httpd/ssl/httpd.csr -days 365</code></p><p><img src="/medias/img/openssl/17.png"><br>6.将请求通过可靠的方式发送给CA主机（要认证机构）</p><p><code>scp /etc/httpd/ssl/httpd.csr root@ip:/tmp/</code></p><p><img src="/medias/img/openssl/18.png"><br>7.在CA主机上签署证书</p><p><code>openssl ca -in /tmp/httpd.csr -out /etc/pki/CA/certs/httpd.crt -days 365</code></p><p><img src="/medias/img/openssl/19.png"><br><img src="/medias/img/openssl/20.png"></p><p>查看证书中的信息：</p><p><code>openssl x509 -in /etc/pki/CA/certs/httpd.crt/ -noout -subject</code></p><p><img src="/medias/img/openssl/21.png"></p><p>吊销证书：</p><p>步骤：</p><p>1.客户端获取要吊销的证书的seral（在使用证书的主机上执行）</p><p><code>openssl x509 -in /etc/pki/CA/certs/httpd.crt -noout -serial -subject</code>（可省略）</p><p>2.CA主机吊销证书：</p><p>先根据客户提交的serial和subject信息，对比其与本机数据库index.txt中存储的是否一致</p><p>吊销：</p><p><code>openssl ca -revoke /etc/pki/CA/newcerts/证书序列号.pem</code></p><p><img src="/medias/img/openssl/22.png"><br>3.生成吊销证书的吊销编号（只在第一次吊销证书时执行）</p><p><code>echo 01 &gt; /etc/pki/CA/crlnumber</code></p><p><img src="/medias/img/openssl/23.png"><br>4.更新证书吊销列表</p><p><code>openssl ca -gencrl -out thisca.crl</code></p><p><img src="/medias/img/openssl/24.png"><br>查看crl文件：</p><p><code>openssl crl -in thisca.crl -noout -text</code></p><p><img src="/medias/img/openssl/25.png"><br><code>$( )</code> 和 <code>``</code> 可以读取里面的命令结果</p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/openssl">openssl加密</a><br><a href="../linux-command-1.16.0/mkcert">mkcert自签证书的工具</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWK</title>
      <link href="/posts/c4a2fe4.html"/>
      <url>/posts/c4a2fe4.html</url>
      
        <content type="html"><![CDATA[<h1 id="awk介绍"><a href="#awk介绍" class="headerlink" title="awk介绍"></a>awk介绍</h1><p>awk是一种处理文本的编程语言工具，报告生成器，格式化文本输出</p><p>版本：<code>new awk</code>（<code>nawk</code>），<code>GUN awk</code>（<code>gawk</code>）</p><p>gawk - 模式扫描和处理语言</p><h1 id="awk基本用法"><a href="#awk基本用法" class="headerlink" title="awk基本用法"></a>awk基本用法</h1><p><code>awk [选项] &#39;program&#39; -v var=value file</code>（<code>-v</code>选项，自定义变量var）</p><p><code>awk [选项] -f programfile</code>（将<code>program</code>写入文件中）<code>var=value file</code></p><p><code>awk [选项] &#39;BEGIN&#123;动作;处理内容&#125; 模式&#123;动作;处理内容&#125; END&#123;动作;处理内容&#125;&#39; 文件名</code></p><p>awk程序通常由：<code>BEGIN语句块</code>、能够使用模式匹配的<code>通用语句块</code>、<code>END语句块</code>，共三部分组成</p><p>program（程序）通常是在单引号或双引号中</p><p>选项：</p><p><code>-F</code>指明输入时用到的字段分隔符</p><p><code>-v var=value</code>自定义变量</p><p>基本格式：<code>awk [options] &#39;program&#39; file</code></p><p>program：<code>pattern&#123;action;要处理的内容&#125;</code></p><h2 id="pattern和action"><a href="#pattern和action" class="headerlink" title="pattern和action"></a>pattern和action</h2><p><code>pattern</code>部分决定动作语句何时触发事件<code>BEGIN</code>，<code>END</code>，<code>正则表达式</code>（模式）</p><p><code>action statements</code>对数据进行处理，放在 <code>&#123; &#125;</code> 内指明<code>print</code>，<code>printf</code></p><h2 id="分隔符、域和记录"><a href="#分隔符、域和记录" class="headerlink" title="分隔符、域和记录"></a>分隔符、域和记录</h2><p>awk执行时，由分隔符分隔的字段<code>域</code>标记<code>$1</code>,<code>$2</code>,<code>$3...</code> <code>$n</code>称为<code>域标识</code>，<code>$0</code>为<code>所有域</code>，注意：和<code>shell</code>中变量<code>$</code>符含义不同</p><p>文件的每一行称为记录</p><p>省略<code>action</code>行，则默认执行<code>print $0</code>（打印所有）的操作</p><h2 id="awk工作原理"><a href="#awk工作原理" class="headerlink" title="awk工作原理"></a>awk工作原理</h2><p>第一步：执行<code>BEGIN&#123;action;处理内容&#125;</code>语句块中的语句（可省）</p><p>第二步：从文件或标准输入（<code>stdin</code>）读取一行，然后执行<code>pattern&#123;action;处理内容&#125;</code>语句块，它逐行扫描文件，从第一行到最后一行重复这个过程，直到文件全部被读取完毕</p><p>第三步：当读至输入流末尾时，执行<code>END&#123;action;处理内容&#125;</code>语句块</p><p><code>BEGIN</code>语句块在<code>awk</code>开始从输入流中读取之前被执行，这是一个可选的语句块，比如变量初始化、打印输出表格的表头等语句通常写在<code>BEGIN</code>语句块中</p><p><code>END</code>语句块在<code>awk</code>从输入流中读取完所有的行之后即可被执行，比如打印所有行的分析结果这类信息汇总都是在<code>END</code>语句块中完成，它也是一个可选语句块</p><p><code>pattern</code>语句块中的通用命令是最重要的部分，也是可选的，如果没有提供<code>pattern</code>语句块，则默认执行<code>&#123;print&#125;</code>，即打印每一个读取到的行，<code>awk</code>读取的每一行都会执行该语句块</p><p><code>print</code>格式：<code>print item1，item2...</code>（<code>item</code>：条目）</p><p>要点：</p><ol><li><p>逗号分隔符</p></li><li><p>输出的各<code>item</code>可以是<code>字符串</code>，也可以是<code>数值</code>；当前记录的字段、变量或<code>awk</code>的表达式</p></li><li><p>如省略<code>item</code>，相当于<code>print $0</code></p></li></ol><p>示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print "hello,awk"&#125;'</span>hello,awk<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print&#125;' /etc/passwd</span>root:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologin<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print "###"&#125;' /etc/passwd</span><span class="token comment">###</span><span class="token comment">###</span><span class="token comment">###</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print $1&#125;' /etc/passwd</span>rootbindaemon<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print $0&#125;' /etc/passwd</span>root:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologin<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print $1"\t"$3&#125;' /etc/passwd</span>root    <span class="token number">0</span>bin    <span class="token number">1</span>daemon    <span class="token number">2</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># tail -3 /etc/fstab | awk '&#123;print $2,$4&#125;' </span>/ defaults/boot defaultsswap defaults<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="awk变量"><a href="#awk变量" class="headerlink" title="awk变量"></a>awk变量</h1><p>变量：内置和自定义变量</p><p>FS：指定输入分隔符，不指定默认为空白字符</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v FS=':' '&#123;print $1,$3,$7&#125;' /etc/passwd</span>root <span class="token number">0</span> /bin/bashbin <span class="token number">1</span> /sbin/nologindaemon <span class="token number">2</span> /sbin/nologin<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print $1,$3,$7&#125;' /etc/passwd</span>root <span class="token number">0</span> /bin/bashbin <span class="token number">1</span> /sbin/nologindaemon <span class="token number">2</span> /sbin/nologin<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>OFS：为输出字段指定分隔符，默认为空白字符</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v FS=':' -v OFS=':' '&#123;print $1,$3,$7&#125;' /etc/passwd</span>root:0:/bin/bashbin:1:/sbin/nologindaemon:2:/sbin/nologin<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RS：输入行分隔符，指定输入时的换行符，原换行符仍然有效</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v RS='0' '&#123;print&#125;' /etc/passwd</span>root:x:<span class="token builtin class-name">:</span>:root:/root:/bin/bash<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ORS：输出时用指定符号代替换行符</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v RS=':' -v ORS='##' '&#123;print&#125;' /etc/passwd   # 指定：为换行符，用##替换前面的换行符</span>root<span class="token comment">##x##0##0##root##/root##/bin/bash</span>bin<span class="token comment">##x##1##1##bin##/bin##/sbin/nologin</span>daemon<span class="token comment">##x##2##2##daemon##/sbin##/sbin/nologin </span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NF：字段数量（指明分割符，每行分几段）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print NF&#125;' /etc/fstab   # 引用内置变量不用$</span><span class="token number">0</span><span class="token number">1</span><span class="token number">1</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print $(NF-1)&#125;' /etc/passwd   # 以：为分割符，打印倒数第二域 </span>/root/bin/sbin<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NR：打印行号</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print NR&#125;' /etc/fstab ; awk END'&#123;print NR&#125;' /etc/fstab</span><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>FNR：各文件分别计数，行号（竖着显示行号）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print FNR&#125;' /etc/fstab /etc/inittab   # 先计数fstab再从头计数inittab</span><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>FILENAME：当前文件名</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print FILENAME&#125;' /etc/fstab</span>/etc/fstab/etc/fstab/etc/fstab<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ARGC：命令行参数的个数</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '&#123;print ARGC&#125;' /etc/fstab /etc/inittab</span><span class="token number">3</span><span class="token number">3</span><span class="token number">3</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print ARGC&#125;' /etc/fstab /etc/inittab</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ARGV：数组，保存的是命令行所给定的各参数（0为第一个参数，1为第二个参数，以此类推）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print ARGV[0]&#125;' /etc/fstab /etc/inittab</span><span class="token function">awk</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print ARGV[1]&#125;' /etc/fstab /etc/inittab</span>/etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h2><ol><li><p><code>-v var=value</code>变量名区分大小写</p></li><li><p>在<code>program</code>中直接定义</p></li></ol><p>示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v test='hello gawk' '&#123;print tast&#125;' /etc/fstab</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -v test='hello gawk' 'BEGIN&#123;print test&#125;'</span>hello <span class="token function">gawk</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;test="hello gawk";print test&#125;'</span>hello <span class="token function">gawk</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="awk格式化"><a href="#awk格式化" class="headerlink" title="awk格式化"></a>awk格式化</h1><p><code>printf</code>命令</p><p>格式输出：<code>printf &quot;FORMAT&quot;,item1,item2…</code></p><p>必须指定<code>FORMAT</code>（格式）</p><p>不会自动换行，需要显示给出换行控制符 <code>\n</code></p><p><code>FORMAT</code>中需要分别为后面每个<code>item</code>指定格式符</p><p>格式符：与<code>item</code>一一对应</p><p><code>%d</code>,<code>%i</code>：显示十进制整数</p><p><code>%s</code>：显示字符串</p><p><code>%%</code>：显示<code>%</code>自身</p><p>修饰符</p><p><code>#</code>：打印<code>#</code>个字符宽度（可以为小数）</p><p><code>-</code>：左对齐<code>%-15s</code>（默认不带 <code>-</code> 右对齐）</p><p><code>+</code>：显示数值的正负符号<code>%+d</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;printf "%s",$1&#125;' /etc/passwd</span>rootbindaemonadmlpsyncshutdownhaltmailoperatorgamesftpnobodydbussystemd-coredumpsystemd-resolvetsspolkitdlibstoragemgmtcockpit-wscockpit-wsinstancesssdsshdchronyrngdunboundnginx<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># </span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;printf "USERNAME:%s\n",$1&#125;' /etc/passwd</span>USERNAME:rootUSERNAME:binUSERNAME:daemon<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;printf "USERNAME:%s UID:%d\n",$1,$3&#125;' /etc/passwd</span>USERNAME:root <span class="token environment constant">UID</span>:0USERNAME:bin <span class="token environment constant">UID</span>:1USERNAME:daemon <span class="token environment constant">UID</span>:2<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;printf "USERNAME:%15s UID:%d\n",$1,$3&#125;' /etc/passwd</span>USERNAME:           root <span class="token environment constant">UID</span>:0USERNAME:            bin <span class="token environment constant">UID</span>:1USERNAME:         daemon <span class="token environment constant">UID</span>:2<span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;printf "USERNAME:%-15s UID:%d\n",$1,$3&#125;' /etc/passwd</span>USERNAME:root            <span class="token environment constant">UID</span>:0USERNAME:bin             <span class="token environment constant">UID</span>:1USERNAME:daemon          <span class="token environment constant">UID</span>:2<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="awk操作符"><a href="#awk操作符" class="headerlink" title="awk操作符"></a>awk操作符</h1><h2 id="算数操作符："><a href="#算数操作符：" class="headerlink" title="算数操作符："></a>算数操作符：</h2><p><code>x+y</code>,<code>x-y</code>,<code>x*y</code>,<code>x/y</code>,<code>x^y</code>,<code>x%y</code>（<code>x%y</code>，即<code>x÷y</code>取余数）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1+2&#125;'</span><span class="token number">3</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1-2&#125;'</span><span class="token parameter variable">-1</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1*2&#125;'</span><span class="token number">2</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1/2&#125;'</span><span class="token number">0.5</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1^2&#125;'</span><span class="token number">1</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 1%2&#125;'</span><span class="token number">1</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 3%2&#125;'</span><span class="token number">1</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 3%1&#125;'</span><span class="token number">0</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;print 5%3&#125;'</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>-x</code>：转换为负数（<code>-</code>用双引号引起来，可以在0前面加上<code>-</code>号）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print -$3&#125;' /etc/passwd</span><span class="token number">0</span><span class="token parameter variable">-1</span><span class="token parameter variable">-2</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>+x</code>：转换为数值（同<code>-</code>，可以用<code>&quot; &quot;</code>引起来）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '&#123;print +$3&#125;' /etc/passwd</span><span class="token number">0</span><span class="token number">1</span><span class="token number">2</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="字符串操作符："><a href="#字符串操作符：" class="headerlink" title="字符串操作符："></a>字符串操作符：</h2><blockquote><p>没有符号的操作符，字符串连接</p></blockquote><h2 id="赋值操作符："><a href="#赋值操作符：" class="headerlink" title="赋值操作符："></a>赋值操作符：</h2><p><code>=</code>，<code>+=</code>，<code>-=</code>，<code>*=</code>，<code>/=</code>，<code>%=</code>，<code>^=</code>，<code>++</code>，<code>--</code>（<code>++</code>每次加1，<code>--</code>每次减1）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;a=1;print a++,a&#125;'</span><span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;a=1;print a--,a&#125;'</span><span class="token number">1</span> <span class="token number">0</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;a=1;print --a,a&#125;'</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk 'BEGIN&#123;a=1;print ++a,a&#125;'</span><span class="token number">2</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="比较操作符："><a href="#比较操作符：" class="headerlink" title="比较操作符："></a>比较操作符：</h2><p><code>&gt;</code>，<code>&gt;=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>!=</code>，<code>==</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 > 999&#123;print $3&#125;' /etc/passwd</span><span class="token number">65534</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 >= 999&#123;print $3&#125;' /etc/passwd</span><span class="token number">65534</span><span class="token number">999</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 &lt; 3&#123;print $3&#125;' /etc/passwd</span><span class="token number">0</span><span class="token number">1</span><span class="token number">2</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 &lt;= 3&#123;print $3&#125;' /etc/passwd</span><span class="token number">0</span><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 != 2&#123;print $3&#125;' /etc/passwd</span><span class="token number">0</span><span class="token number">1</span><span class="token number">3</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3 == 2&#123;print $3&#125;' /etc/passwd</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="模式匹配符："><a href="#模式匹配符：" class="headerlink" title="模式匹配符："></a>模式匹配符：</h2><p><code>~</code>：左边包含右边匹配到的内容</p><p><code>!~</code>：左边不包含右边匹配到的内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '$0 ~ /root/&#123;print&#125;' /etc/passwd   # 支持正则表达式</span>root:x:0:0:root:/root:/bin/bashoperator:x:11:0:operator:/root:/sbin/nologin<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/passwd | awk '$0 !~ /^root/'</span>bin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologin<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="逻辑操作符"><a href="#逻辑操作符" class="headerlink" title="逻辑操作符"></a>逻辑操作符</h2><p>或 <code>||</code>，与 <code>&amp;&amp;</code>，非<code>!</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3>=0 &amp;&amp; $3&lt;=3&#123;print $1,$3&#125;' /etc/passwd</span>root <span class="token number">0</span>bin <span class="token number">1</span>daemon <span class="token number">2</span>adm <span class="token number">3</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3==0 || $3&lt;=3&#123;print $1,$3&#125;' /etc/passwd</span>root <span class="token number">0</span>bin <span class="token number">1</span>daemon <span class="token number">2</span>adm <span class="token number">3</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '!($3>=3)&#123;print $1,$3&#125;' /etc/passwd</span>root <span class="token number">0</span>bin <span class="token number">1</span>daemon <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>PATTERN</code>：根据<code>pattern</code>条件，过滤匹配的行，再做处理</p><p>如果未指定：空模式，匹配每一行</p><p><code>/正则表达式/</code>：仅处理能够被模式匹配到的行，需要用 <code>/ /</code> 括起来</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '/^UUID/&#123;print $1&#125;' /etc/fstab</span><span class="token assign-left variable">UUID</span><span class="token operator">=</span>8b1f186e-ffcb-4b8e-a9e2-caba58a3a850<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk '!/^UUID/&#123;print $1&#125;' /etc/fstab</span><span class="token punctuation">..</span>./dev/mapper/cl-root/dev/mapper/cl-swap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关系表达式：结果有”真”有”假”；结果为”真”才会被处理；</p><p>真：结果为非0值，非空字符串</p><p>假：结果为空字符串</p><p>示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$3>1000&#123;print $1,$3&#125;' /etc/passwd</span>nobody <span class="token number">65534</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '$NF~/bash$/&#123;print $1,$NF&#125;' /etc/passwd</span>root /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>line ranges</code>：行范围</p><p><code>startline,endline</code>：<code>/pat1/,/pat2/</code>不支持直接给出数字格式</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '/^root/,/^lp/&#123;print $1&#125;' /etc/passwd</span>rootbindaemonadmlp<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: '(NR>=2&amp;&amp;NR&lt;=5)&#123;print $1&#125;' /etc/passwd</span>bindaemonadmlp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>BEGIN/END</code>模式</p><p><code>BEGIN&#123;&#125;</code>：仅在开始处理文件中的文本之前执行一次</p><p><code>END&#123;&#125;</code>：仅在文本处理完成之后执行一次</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: 'BEGIN&#123;print "USER UID"&#125;(NR>=2&amp;&amp;NR&lt;=4)&#123;print $1":"$3&#125;END&#123;print "end file"&#125;' /etc/passwd</span><span class="token environment constant">USER</span> <span class="token environment constant">UID</span>bin:1daemon:2adm:3end <span class="token function">file</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/passwd | head -3 | awk -F: '&#123;print "USER UID";print $1":"$3&#125;END&#123;print "end file"&#125;'</span><span class="token environment constant">USER</span> <span class="token environment constant">UID</span>root:0<span class="token environment constant">USER</span> <span class="token environment constant">UID</span>bin:1<span class="token environment constant">USER</span> <span class="token environment constant">UID</span>daemon:2end <span class="token function">file</span><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: 'BEGIN&#123;print "USER UID \n ---------"&#125;&#123;print $1,$3&#125;' /etc/passwd</span><span class="token environment constant">USER</span> <span class="token environment constant">UID</span>  ---------root <span class="token number">0</span>bin <span class="token number">1</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># awk -F: 'BEGIN&#123;print "USER UID \n ---------"&#125;&#123;print $1,$3&#125;'END'&#123;print "========="&#125;' /etc/passwd</span><span class="token environment constant">USER</span> <span class="token environment constant">UID</span>  ---------root <span class="token number">0</span><span class="token punctuation">..</span>.nginx <span class="token number">990</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/awk">awk补充</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络</title>
      <link href="/posts/50daec4.html"/>
      <url>/posts/50daec4.html</url>
      
        <content type="html"><![CDATA[<h1 id="查看及测试网络"><a href="#查看及测试网络" class="headerlink" title="查看及测试网络"></a>查看及测试网络</h1><h2 id="查看网络："><a href="#查看网络：" class="headerlink" title="查看网络："></a>查看网络：</h2><p>使用ifconfig命令查看网络接口</p><p>（1）查看活动的网络接口信息（<code>ifconfig</code>）</p><p>（2）查看所有的网络接口信息（<code>ifconfig -a</code>）</p><p>（3） 查看指定网络接口信息（<code>ifconfig 网络接口名</code>）</p><p>直接使用ifconfig命令，查询出的是已激活的网卡列表信息，参数</p><p>eth0：第一块网卡</p><p>lo：回环，用于某些服务的测试</p><p>Hwaddr：网络接口的物理地址（MAC地址）</p><p>inet addr：网络接口的ip地址</p><p>Bacast：网络接口所在网络的广播地址</p><p>Mask：网络接口的子网掩码</p><p>使用<code>ip</code>/<code>ethtool</code>命令查看网络接口</p><p>（1）查看所有网络接口的数据链路层信息</p><p>（2）查看所有网络接口的网络层信息</p><p>（3）查看指定网络接口的速率、模式等信息</p><p><code>ip link</code>查看网络接口信息，不显示ip地址</p><p><code>ip addr</code>查看网络接口的详细信息，可以加show选项，查看指定网络接口信息</p><p><code>ethtool网络接口名</code>：查看指定网络接口的速率、模式等信息</p><h2 id="route命令"><a href="#route命令" class="headerlink" title="route命令"></a>route命令</h2><p>使用route命令查看路由表条目</p><p>linux系统中的路由表决定着本机向其他主机或其他网络发送数据的去向，是排除网络故障的关键信息</p><p>直接执行route命令</p><p>查看主机的路由表信息：</p><p>目标网段的地址</p><p>Gateway：下一跳路由的地址</p><p>Genmask：子网掩码</p><p>Flags：标记当前网络节点状态</p><p>Metric：路由距离、跳数（linux内核中没有使用）</p><p>Ref：路由项引用次数（linux内核中没有使用）</p><p>Use：该路由被使用的次数，可以粗略估计通向指定网络地址的网络流量</p><p>Iface：发送数据的网络接口，如eth0</p><p>当目标网段为“Default”时，表示此行时默认网关记录；当下一跳为“*”时，表示目标网段与本机相连的时候，不需要路由器</p><p>选项：</p><p><code>-n</code>：可以将路由记录中的地址显示为数字形式，这样可以跳过解析主机名的过程，在路由表条目较多时能够加快执行速度。</p><h2 id="netstat命令"><a href="#netstat命令" class="headerlink" title="netstat命令"></a>netstat命令</h2><p>使用<code>netstat</code>命令查看网络连接情况</p><p>选项：</p><p><code>-a</code>显示当前主机中所有活动的网络连接信息</p><p><code>-n</code>以数字形式显示相关信息</p><p><code>-r</code>显示路由表信息</p><p><code>-t</code>显示TCP协议相关信息</p><p><code>-u</code>显示UDP协议相关信息</p><p><code>-p</code>显示与网络连接相关的进程号、进程名称信息（要root权限）</p><p><code>-l</code>显示处于监听状态的网络连接及端口信息</p><p>常用组合：</p><p><code>-anpt</code>以数字形式显示当前系统中的所有的TCP连接信息，同时显示对应的进程号</p><p>查看某一个服务，使用grep过滤</p><p><code>netstat -anpt|grep sshd</code>（可以是服务名或进程号）</p><p>查询结果中各项的意思：</p><p>proto：协议</p><p>Recv-Q：接收的包的个数</p><p>Send-Q：发送的包的个数</p><p>local Address：本地ip地址</p><p>Foreign Address：远端ip地址</p><p>state：状态</p><p>PID/program name：PID号/进程名称</p><p>在state列中：    </p><p>LISTEN：监听状态</p><p>BSTABLISHED：已连接状态</p><h2 id="ss命令"><a href="#ss命令" class="headerlink" title="ss命令"></a>ss命令</h2><p><code>ss</code>命令：类似<code>netstat</code></p><p>常见用法：</p><p><code>-l</code>显示本地打开的所有端口</p><p><code>-pl</code>显示每个进程打开的socket</p><p><code>-atu</code>显示所有的TCP、UDP协议的socket</p><p><code>-atpl</code>显示所有处于监听状态的TCP协议socket</p><p>（补充：n以数字格式显示，p显示端口）</p><h2 id="测试网络连接"><a href="#测试网络连接" class="headerlink" title="测试网络连接"></a>测试网络连接</h2><p>traceroute命令的格式</p><p><code>traceroute ip|网址</code></p><p>nslookup命令的格式</p><p><code>nslookup 网址</code> [DNS服务器地址]</p><h1 id="设置网络地址参数"><a href="#设置网络地址参数" class="headerlink" title="设置网络地址参数"></a>设置网络地址参数</h1><h2 id="使用ifconfig命令修改网卡的地址、状态"><a href="#使用ifconfig命令修改网卡的地址、状态" class="headerlink" title="使用ifconfig命令修改网卡的地址、状态"></a>使用ifconfig命令修改网卡的地址、状态</h2><p>在linux主机中，手动修改网络配置包括两种最基本的方法：</p><p>临时修改：通过命令行直接修改当前正在使用的网络地址，修改后立即生效，这种方式简单快捷，一般在调试网络的过程中使用，但由于所做的修改并没有固定的存放在静态的文件中，因此当重启network服务或重启主机后将失效</p><p><code>ifconfig eth0 192.168.0.1/24</code>（或<code>ifconfig eth0 192.168.0.4 netmask 255.255.255.0</code>）</p><p><code>ifconfig eth0 up</code> 开启eth0（ifdown eth0）</p><p><code>ifconfig eth0 down</code> 关闭eth0（ifup eth0）</p><p><code>ifconfig eth0:0 192.168.0.2</code> 为网卡绑定虚拟接口（多用于调试）</p><p>固定配置：通过配置文件来存放固定的各种网络地址，需要重启network服务或重启主机后才会生效，这种方式是永久配置，一般在需要为服务器设置固定的网络地址时使用</p><h2 id="使用route命令添加、删除静态路由"><a href="#使用route命令添加、删除静态路由" class="headerlink" title="使用route命令添加、删除静态路由"></a>使用route命令添加、删除静态路由</h2><p>通过route add操作可以添加路由记录，结合“-net”选项指定目标网段的地址，结合“gw”选项指定下一跳路由器的ip地址</p><p>添加格式：route add -net 目标网段地址 gw 下一跳路由ip/本机跳出ip</p><p>例如：<code>route add -net 172.18.16.0/24 gw 192.168.0.2</code></p><p>删除格式：route del -net 目标网段地址</p><p>例如：<code>route del -net 172.18.16.0/24</code></p><p>添加、删除默认网关记录（默认网关是一条特殊的静态路由）</p><p>与添加、删除静态路由类似，但指定目标网段时只需要简单的使用“default”表示即可，无须再使用“-net”选项指明网段地址</p><p>格式：<code>route|grep default</code>先查看原路由表中的默认网关地址</p><p>删除：<code>route del default [gw 192.168.0.1]</code>（或<code>route del -net 192.168.0.1</code>）</p><p>网络接口的配置文件默认位于<code>/etc/sysconfig/network-srcipts/</code>目录中，文件名命名方式为“ifcfg-xxx”其中“xxx”是网络接口的名称</p><p>例如：网卡eth0的配置文件是“ifcfg-eth0”，回环接口lo的配置文件是“ifcfg-lo”</p><p>ifcfg-xxx文件中常用配置项的含义及作用</p><p>DEVICE：设置网络接口的名称</p><p>ONBOOT：设置网络接口是否在linux系统启动时激活</p><p>BOOTPROTO：设置网络接口的配置方式，分为“static（静态）”和“dhcp（动态）”</p><p>IPADDR：设置网络接口的ip地址</p><p>NETMASK：设置网络接口的子网掩码</p><p>GATEWAY：设置网络接口的默认网关地址</p><p>UUID：网关的UUID编号</p><p>HWADDR：网卡的MAC地址</p><p>设置完重启网卡</p><p>启用、禁用网络接口配置：</p><p>重启network服务使新的配置生效</p><p>如果只禁用某一个网络接口</p><p><code>ifup 网卡名</code></p><p><code>ifdown 网卡名</code></p><p>主机名称配置文件</p><p>若要修改主机名可以使用<code>hostname</code>命令，临时修改，重启失效</p><p>永久配置，修改配置文件</p><p><code>/etc/sysconfig/network</code></p><p>NETWORKING：用于设置IPV4网络默认启用状态</p><p>HOSTNAME：用于设置主机名</p><p>域名解析配置文件</p><p>（1）指定为本机提供DNS解析的服务器地址的文件</p><p>编辑<code>/etc/resolv.conf</code>文件，指定三个不同的DNS服务器，优先使用第一个DNS服务器</p><p>添加<code>nameserver 114.114.114.114</code></p><p>（2）本地主机映射文件</p><p><code>/etc/hosts</code>文件中记录着一份主机名与ip地址的映射关系表，当访问一个未知域名时，先查询hosts文件中是否有相应的映射记录，如果有就使用，没有再去找DNS服务器进行查询（省去去DNS服务器解析域名）</p><p>设置方式：</p><p>打开<code>/etc/hosts</code>文件，添加：<code>123.125.114.144 www.baidu.com</code></p><p>（域名可以设置别名）</p><h2 id="网卡接口配置：bonding"><a href="#网卡接口配置：bonding" class="headerlink" title="网卡接口配置：bonding"></a>网卡接口配置：bonding</h2><p>bonding是一种linux系统下的网卡绑定技术，可以把服务器上n个物理网卡在系统内部抽象成一个逻辑上的网卡，能够提升网络吞吐量、实现网络冗余、负载等功能，有很多优势。</p><p>bonding技术是是linux系统内核层面实现的，它是一个内核模块（驱动）。使用它需要系统有这个模块。</p><p><code>modinfo bonding</code>查看bonding的信</p><p><code>modprobe bonding</code>将bonding模块加载到linux内核</p><p>bonding的工作模式：</p><p>mode0</p><p>轮转，从头到尾的顺序在每一个slave接口上发送数据包（bond的网卡有一个损坏，bond就损坏）</p><p>mode1</p><p>主备，bond的所有网卡中，只有一个slave被激活（被激活的slave损坏，下一个slave顶上）</p><p>mode3</p><p>广播，在所有的slave接口上传送所有的报文。有容错能力</p><p>bonding配置</p><p>1、添加bonding模块（xshell连接不上虚拟机，需要执行<code>modprobe -r bonding</code>将bonding模块移除）</p><p><code>modprobe bonding</code></p><p>2、关闭NetworkManager服务</p><p><code>service NetworkManager stop</code></p><p>3、创建bond0</p><p><code>vim /etc/sysconfig/network-scripts/ifcfg-bond0</code></p><p>（miimon是用来进行链路检测的，如果miimon=100，那么系统每100ms检测一次链路连接状态，如果有一条线路不通就转入另一条线路）</p><p>4、配置真实网卡 <code>eth0</code> <code>eth1</code> 添加以下内容</p><pre class="line-numbers language-none"><code class="language-none">DEVICE&#x3D;eth0TYPE&#x3D;EthernetONBOOT&#x3D;yesBOOTPROTO&#x3D;noneMASTER&#x3D;bond0SLAVE&#x3D;yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">DEVICE&#x3D;eth1TYPE&#x3D;EthernetONBOOT&#x3D;yesBOOTPROTO&#x3D;noneMASTER&#x3D;bond0SLAVE&#x3D;yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>5、添加网卡驱动</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/modprobe.d/bonding.conf<span class="token builtin class-name">alias</span> bond0 bonding<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>6、启动网络服务</p><p><code>service network start</code></p><p>删除bond0</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ifconfig</span> bond0 downrmmod bonding<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/iftop">iftop实时流量监控</a><br><a href="../linux-command-1.16.0/nmcli">nmcli网络管理客户端</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>引导程序</title>
      <link href="/posts/80a30db1.html"/>
      <url>/posts/80a30db1.html</url>
      
        <content type="html"><![CDATA[<h1 id="引导程序与服务控制"><a href="#引导程序与服务控制" class="headerlink" title="引导程序与服务控制"></a>引导程序与服务控制</h1><p>Linux组成：kernel+rootfs</p><p>kernel内核：功能：进程管理、内存管理、网络管理、驱动程序、文件系统、安全功能</p><p>rootfs根文件系统：包括程序和glibc</p><p>（glibc：是GUN发布的libc库，即c运行库。几乎其它任何运行库都会依赖于glibc）</p><p>库：函数集合，function，调用接口（头文件负责描述）</p><p>过程调用：procedure，无返回值</p><p>函数调用：function</p><p>程序：二进制执行文件</p><p>内核设计流派：</p><p>单内核：Linux</p><p>把所有功能集成于同一个程序</p><p>微内核：Windows</p><p>每种功能使用一个单独子系统实现</p><p>Linux内核特点：</p><p>支持模块化：*.ko（内核对象）（在/lib/modules/发布版本/kernel/目录下存放）</p><p>如：文件系统，硬件驱动，网络协议等</p><p>支持内核模块的动态装载和卸载</p><p><img src="/medias/img/bootstrap/0.png"></p><p>Linux内核组成部分：核心文件和ramdisk</p><p>核心文件：/boot/vmlinuz-发布版本（version-release发布版本）</p><p><img src="/medias/img/bootstrap/1.png"></p><p>ramdisk：辅助的伪根系统</p><p>CentOS 5：/boot/initrd-version-release.img</p><p>CentOS 6，7：/boot/initramfs-version-release.img （6，7上的伪根系统）</p><p><img src="/medias/img/bootstrap/2.png"></p><h1 id="CentOS-6的启动流程"><a href="#CentOS-6的启动流程" class="headerlink" title="CentOS 6的启动流程"></a>CentOS 6的启动流程</h1><ol><li><p>加载BIOS的硬件信息，获取第一个启动设备</p></li><li><p>读取第一个启动设备MBR的引导加载程序（grub）的启动信息</p></li><li><p>加载核心操作系统的核心信息，核心开始解压缩，并尝试驱动所有的硬件设备</p></li><li><p>核心执行init程序，并获取默认的运行信息</p></li><li><p>init程序执行/etc/rc.d/rc.sysinit文件</p></li><li><p>启动核心的外挂模块</p></li><li><p>init执行运行的各个批处理文件（scripts）</p></li><li><p>init执行/etc/rc.d/rc.local</p></li><li><p>执行/bin/login程序，等待用户登录</p></li><li><p>登录之后开始以shell控制主机</p></li></ol><h2 id="具体流程："><a href="#具体流程：" class="headerlink" title="具体流程："></a>具体流程：</h2><h3 id="1-POST加电自检"><a href="#1-POST加电自检" class="headerlink" title="1. POST加电自检"></a>1. POST加电自检</h3><p>按下电源键后ROM芯片中的CMOS程序执行并检测CPU、内存等设备是否存在并正常运行，CMOS中的程序叫BIOS，可以设置硬盘接口，网卡声卡开关之类的简单设置。一般主板上有一个纽扣电池，这个电池就是给ROM供电的，可以保证主板断电后BIOS的一些基本设置不会重置。</p><h3 id="2-引导加载次序Boot-Sequence"><a href="#2-引导加载次序Boot-Sequence" class="headerlink" title="2. 引导加载次序Boot Sequence"></a>2. 引导加载次序Boot Sequence</h3><p>在系统启动前计算机是不知道你系统是在哪里的，需要按照设备启动顺序一次查找引导加载器BootLoader，这个查找次序可以自己在BIOS中设定，一般在boot选项中设置。</p><h3 id="3-引导加载器BootLoader"><a href="#3-引导加载器BootLoader" class="headerlink" title="3. 引导加载器BootLoader"></a>3. 引导加载器BootLoader</h3><p>前面说了计算机是不知道系统在哪里的，所以需要程序进行引导，这个引导的程序就叫BootLoader，不同操作系统的BootLoader是不同的，Windows使用的BootLoader程序是ntloader，只能对Windows进行引导不能对其它系统进行引导，而Linux的BootLoader叫GRUB，可以对其它操作系统进行引导（包括Windows），正是因为这样，所以在装有Windows又有Linux的双系统的时候，需要先装Windows，再装Linux。</p><p>功能：提供一个菜单，允许用户选择要启动系统或不同内核版本；把用户选定的内核装载到内存中的特定空间中，解压、展开，并把系统控制权移交给内核。</p><p>BootLoader的引导程序GRUB放在MBR中。</p><p>GRUB：分三个阶段（1和1.5和2）</p><p>1、运行BootLoader主程序，MBR的前446字节；</p><p>1.5、文件系统识别程序放在MBR后面的扇区中，用于识别2所在分区的文件系统；</p><p>2、通过BootLoader加载所有配置文件及相关的环境参数信息，这些配置文件及相关的环境参数都存放于磁盘分区上的/boot目录下</p><h3 id="4-引导加载器程序GRUB"><a href="#4-引导加载器程序GRUB" class="headerlink" title="4. 引导加载器程序GRUB"></a>4. 引导加载器程序GRUB</h3><p><code>grub legacy</code></p><p>前面提到的GRUB是BootLoader阶段的一个程序，这是CentOS中最常见的引导程序，CentOS 6安装的是<code>grub legacy</code></p><p><img src="/medias/img/bootstrap/3.png"></p><p>按e：进入编辑模式，用于编辑菜单</p><p><img src="/medias/img/bootstrap/4.png"></p><p>按c：进入命令模式，交互式接口</p><p><img src="/medias/img/bootstrap/5.png"></p><p>常用配置：</p><p><code>default=#</code>：设定默认启动的菜单项；落单项title编号从0开始</p><p><code>timeout=#</code>：指定菜单项等待选项选择的时长</p><p><code>kernel /PATH/TO/VMLINUZ_FILE</code>：启动的内核</p><p><code>password --md5 STRING</code>：启动选定的内核或操作系统时进行认证</p><h3 id="5-进入kernel"><a href="#5-进入kernel" class="headerlink" title="5. 进入kernel"></a>5. 进入kernel</h3><p>在GRUB中选择对应的kernel进入，然后kernel会对自身进行初始化</p><p>探测可识别到的所有硬件设备</p><p>加载硬件驱动程序</p><p>以只读方式挂载根文件系统</p><p>运行用户空间的第一个应用程序，在CentOS 6上是init，在CentOS 7上是systemd</p><p>kernel：内核核心，一般为bzimage，通常在/boot目录下，名称为vmlinuz-version-release</p><p>kernel object：内核对象，一般放置于<code>/lib/modules/version-release/</code></p><h3 id="6-运行init"><a href="#6-运行init" class="headerlink" title="6. 运行init"></a>6. 运行init</h3><p>CentOS 6上init所在的位置是在/sbin/init，init共分为7个级别</p><p>0关机</p><p>1单用户模式（root无须登录），single，维护模式</p><p>2多用户模式，会启动网络功能，但不会启动NFS，维护模式</p><p>3多用户模式，正常模式，字符终端</p><p>4预留级别，可同3级</p><p>5多用户模式，正常模式，图形界面</p><p>6重启</p><p><code>runlevel</code>和<code>who -r</code> 可以查看当前系统运行的init级别</p><p><code>runlevel</code>命令：第一个字符，上次所在级别；第二个字符，当前所在级别</p><p><img src="/medias/img/bootstrap/6.png"></p><p><code>vim /etc/inittab</code>（最后一行，修改运行级别，重启后运行修改后的级别）</p><p><img src="/medias/img/bootstrap/7.png"></p><p><img src="/medias/img/bootstrap/8.png"></p><h3 id="7-运行系统初始化脚本"><a href="#7-运行系统初始化脚本" class="headerlink" title="7. 运行系统初始化脚本"></a>7. 运行系统初始化脚本</h3><p>系统初始化脚本对应的文件是<code>/etc/rc.d/rc.sysinit</code></p><p><img src="/medias/img/bootstrap/9.png"></p><h3 id="8-启动系统服务"><a href="#8-启动系统服务" class="headerlink" title="8. 启动系统服务"></a>8. 启动系统服务</h3><p>CentOS 6下的系统服务脚本都放在/etc/init.d中，可以看到两个文件中的内容是一样的，因为/etc/init.d链接到了/etc/rc.d/init.d中</p><p><img src="/medias/img/bootstrap/10.png"><br><img src="/medias/img/bootstrap/11.png"></p><p>通过chkconfig命令可以查看什么系统级别下开启了哪些服务，以及添加服务到系统中并在指定级别下启动</p><p><code>chkconfig --list</code>：查看什么系统级别下开启了哪些服务</p><p><img src="/medias/img/bootstrap/12.png"></p><p><code>chkconfig --add 服务名</code>：添加服务到系统中并在指定级别下启动（？？在添加的时候需要将对应的服务放入放入/etc/init.d中，并在服务脚本中加入chkconfig：LLLL nn nn）</p><p>写到LLLL的init级别就是S的，没写的就是K的，第一个nn代表S的数字，第二个nn代表K的数字？？？</p><p><code>chkconfig --del 服务名</code>：删除服务</p><p><img src="/medias/img/bootstrap/13.png"></p><p>（注意：正常级别下，最后启动一个服务<code>S99local</code>没有链接至<code>/etc/rc.d/init.d</code>一个服务脚本，而是指向了<code>/etc/rc.d/rc.local</code>脚本；因此，不便或不需要写为服务脚本放置于<code>/etc/rc.d/init.d/</code>目录，且又想开机时自动运行的命令，可直接放置于<code>/etc/rc.d/rc.local</code>文件中）</p><h3 id="9-系统在启动完服务后会打印登录提示符，然后输入账号密码，进入对应的命令行界面或图行界面。"><a href="#9-系统在启动完服务后会打印登录提示符，然后输入账号密码，进入对应的命令行界面或图行界面。" class="headerlink" title="9. 系统在启动完服务后会打印登录提示符，然后输入账号密码，进入对应的命令行界面或图行界面。"></a>9. 系统在启动完服务后会打印登录提示符，然后输入账号密码，进入对应的命令行界面或图行界面。</h3><p>init进程</p><p>由Linux内核加载运行<code>/sbin/init</code>程序完成的，是系统中的第一个进程，所有进程的父进程，PID号永远为1</p><p><code>upstart</code> 启动方式</p><p>将初始化配置分散存放，响应不同的启动事件（就是不会再去读取所有的初始化配置文件，而是有什么样的事件，就把响应的配置文件读取出来生效）</p><p>配置文件：<code>/etc/inittab</code>，<code>/etc/init/*.conf</code></p><p>CentOS 6 <code>/etc/inittab</code>和相关文件</p><p><code>/etc/inittab</code></p><p>设置系统默认的运行级别</p><p>id：级别：initdefault：</p><p><code>/etc/init/control-alt-delete.conf</code></p><p>控制终端下的Ctrl+Alt+Del热键操作</p><p><code>/etc/init/tty.conf</code></p><p>控制tty终端的开启</p><p><code>/etc/init/start-ttys.conf</code></p><p>配置tty终端的开启数量，设备文件</p><p><code>/etc/init/rc.conf</code></p><p>兼容脚本，负责各运行级别的调用处理</p><p><code>/etc/inittab</code>文件结构</p><p>字段：说明（最后一行）</p><p>id：一个任务的标识符</p><p>runlevels：在哪些级别启动此服务，也可以为空，表示所有级别</p><p>action：用于描述在什么条件下启动</p><p>process：用于设置启动进程所执行的命令</p><p>服务控制及切换运行级别</p><p>服务的启动停止是通过<code>/etc/rc.d/rc3.d/</code>下的所有链接文件来决定如何启动或关闭服务的</p><p><code>/etc/rc.d/rc3.d</code>下的所有链接文件其实都是在<code>/etc/init.d/</code>下面的所有脚本，这些脚本接受至少四个基本参数（启动start、关闭stop、重启restart、服务状态status、重新加载reload）</p><h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><p>service 服务名 参数</p><p>例：<code>service httpd stop</code></p><p>查看及切换运行级别</p><p>查看运行级别：</p><p><code>runlevel</code></p><p>临时切换运行级别：</p><p><code>init #</code>（0-6）</p><p>chkconfig工具</p><p>通过chkconfig命令来管理服务</p><p>控制某服务在某服务在某种运行级别中的开启/关闭状态</p><p><code>chkconfig --level 级别 服务 on|off</code> （默认级别为2345） </p><p>查看服务在对应级别的状态：</p><p><code>chkconfig --list 服务</code></p><p>添加服务：</p><p><code>chkconfig --add 服务</code></p><p>删除服务：</p><p><code>chkconfig --del 服务</code></p><h1 id="Grub管理"><a href="#Grub管理" class="headerlink" title="Grub管理"></a>Grub管理</h1><p>GRUB配置文件：<code>/boot/grub/grub.conf</code> </p><p>每行内容：</p><p>Default：设定默认启动的内核和操作系统，如果同时按装了多个操作系统或内核，0表示定义的第一个title系统，1表示定义的第二个title系统，依次类推</p><p>Timeout：设定系统启动时选择操作系统菜单的等待时间（秒）</p><p>Splashimage：设定系统启动时grub菜单的背景图片。图片格式为xpm，14bits颜色，大小为640x480，需要gzip压缩</p><p>Hiddenmenu：隐藏选择菜单，默认情况下是不显示菜单信息，如果想要显示菜单，将该配置注释即可</p><p>Title：定义一个操作系统或系统内核</p><p>Root：指明引导当前操作系统或内核文件所在的分区</p><p>Kernel：指定文件路径、根文件系统所在设备，以及传递给内核的参数。由于启动过程中需要挂载根目录，因此需要指定根目录所在的分区。内核参数rhgb表示色彩显示，quiet表示静默模式加载内核</p><p>Initrd：指定用于辅助内核完成系统启动的ramdisk文件路径</p><p>GRUB菜单加密保护</p><p>默认进入GRUB菜单后不需要密码就可以进行编辑，相对来说比较危险，修改grub.conf配置文件为GRUB菜单设置密码保护，在grub.conf文件中的title字段上面新增一行<code>password --md5 ****</code>（md5加密）</p><p>可以使用<code>grub-md5-crypt</code>生成md5加密的密码</p><p>加密后再次进入GRUB菜单时编辑须按“p”输入GRUB密码，才能编辑</p><p><img src="/medias/img/bootstrap/14.png"><br>（按“p”输入密码）</p><p><img src="/medias/img/bootstrap/15.png"></p><h1 id="启动排错"><a href="#启动排错" class="headerlink" title="启动排错"></a>启动排错</h1><p>破解root口令</p><p>两种方法：</p><p>方法一：通过单用户模式（init 1|s）进行破解</p><p>GRUB菜单时按e→s或1→回车，按b</p><p><img src="/medias/img/bootstrap/16.png"><br>（按e）</p><p><img src="/medias/img/bootstrap/17.png"><br>（按e）</p><p><img src="/medias/img/bootstrap/18.png"><br>（按空格，输入s或1回车）</p><p><img src="/medias/img/bootstrap/19.png"><br>（按b进入单用户模式，默认root登录）</p><p><img src="/medias/img/bootstrap/20.png"><br><img src="/medias/img/bootstrap/21.png"><br>（输入passwd更改root密码）</p><p>方法二：通过救援模式破解</p><p>进入救援模式后执行以下命令</p><p><img src="/medias/img/bootstrap/22.png"><br>（开机按F2进入BIOS）</p><p><img src="/medias/img/bootstrap/23.png"><br>（通过左右键选择boot目录）</p><p><img src="/medias/img/bootstrap/24.png"><br>（通过+/-将CD-ROM移到第一个）</p><p><img src="/medias/img/bootstrap/25.png"><br>（按F10保存退出）</p><p><img src="/medias/img/bootstrap/26.png"><br>（选择Rescue installed system回车）</p><p><img src="/medias/img/bootstrap/27.png"><br>（一路回车，遇到Setup networking选No回车）</p><p><img src="/medias/img/bootstrap/28.png"><br>（接着一路回车，进入bash-4.1#）</p><p>chroot /mnt/sysimage 将目录结构切换到待修复的Linux系统中</p><p><img src="/medias/img/bootstrap/29.png"><br>（进入sh-4.1#）</p><p>passwd root更改root密码（输入新密码）</p><p><img src="/medias/img/bootstrap/30.png"><br>exit退出到bash-4.1#</p><p><img src="/medias/img/bootstrap/31.png"><br>reboot重启</p><p><img src="/medias/img/bootstrap/32.png"><br>更改引导方式启动即可（将CD-ROM移到下面即可，重启）</p><p><img src="/medias/img/bootstrap/33.png"><br>修复MBR扇区故障</p><p>如果引导过程出现故障，Linux是无法启动的</p><p>第一个MBR扇区中放置了grub引导程序和分区表</p><p>故障原因：病毒、木马等造成的破坏；不正确的分区操作、磁盘读写误操作</p><p>故障现象：找不到引导程序，启动中断；无法加载操作系统、开机后黑屏；提示“Operating System not found”</p><p>解决思路：应提前做好备份文件；以光盘引导进入急救模式；从备份文件中恢复</p><p>实例：</p><p>1、备份MBR扇区数据（注意：要备份到另一块硬盘中）</p><p><code>mkdir /backup</code> 创建挂载点</p><p><code>mount /dev/sdb /backup</code> 挂载/dev/sdb到/backup</p><p>使用dd命令备份</p><p><code>dd if=/dev/sda of=/backup/mbr.bak bs=512或446 count=1</code></p><p>2、模拟MBR扇区故障</p><p><code>dd if=/dev/zero of=/dev/sda bs=512或446 count=1</code></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/grub">grub</a><br><a href="../linux-command-1.16.0/grub2-mkconfig">grub2-mkconfig</a><br><a href="../linux-command-1.16.0/grub2-set-default">grub2-set-default</a><br><a href="../linux-command-1.16.0/lilo">lilo</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 引导程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>进程管理</title>
      <link href="/posts/852cfab6.html"/>
      <url>/posts/852cfab6.html</url>
      
        <content type="html"><![CDATA[<h1 id="进程概念"><a href="#进程概念" class="headerlink" title="进程概念"></a>进程概念</h1><p>内核的作用：进程管理、文件系统、网络功能、内存管理、驱动程序、安全功能等</p><p>Process（进程）：运行中的程序的一个副本，是被载入内存的一个指令集合</p><p>程序被触发后，执行者的权限与属性、程序的代码所需资料都会被载入到内存中，操作系统给予这些内存单元一个识别码（pid），可以说，进程就是一个正在运作的程序。</p><h2 id="进程存在生命周期"><a href="#进程存在生命周期" class="headerlink" title="进程存在生命周期"></a>进程存在生命周期</h2><p>Program（程序）：通常为binary program , 放置在存储媒介中，（如硬盘，光盘等），以实体文件的形态存在。</p><p>Thread（线程）：是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是行程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并行多个线程，每条线程并行执行不同的任务。</p><p>一般，线程具有就绪、阻塞和运行三种基本状态</p><h2 id="进程创建："><a href="#进程创建：" class="headerlink" title="进程创建："></a>进程创建：</h2><p>init ：第一个进程</p><p>“父子关系”</p><p>进程都是由其父进程创建，由COW技术实现（写时复制）（即程序为“父子关系”时，其子进程未运行时，父进程只对子进程标记，子进程运行时，才会复制子进程所需的运行文件到/porc/PID下）</p><h2 id="进程优先级："><a href="#进程优先级：" class="headerlink" title="进程优先级："></a>进程优先级：</h2><p>系统优先级：数字越小，优先级越高</p><p>0-139（CentOS4,5）：各有140个运行队列和过期队列</p><p>0-98,99（CentOS6）</p><p>实时优先级：99-0：值最大优先级最高</p><p>Nice值：-20到19对应系统优先级100-139（CentOS4,5）或99（CentOS6）</p><h2 id="进程相关概念"><a href="#进程相关概念" class="headerlink" title="进程相关概念"></a>进程相关概念</h2><h3 id="进程内存："><a href="#进程内存：" class="headerlink" title="进程内存："></a>进程内存：</h3><p>Page Frame ：页框，用于存储页面数据，存储Page 4K（内存有大小，最小的存储为Page 4K）</p><p>LRU ：近期最少使用算法：释放内存物理地址空间（实际使用的内存空间RSS）和线性地址空间（允许使用的内存空间VSZ）（通过LRU算法将不经常使用的、老的进程放到swap分区）</p><p>MMU：负责转换线性地址和物理地址（记录了进程的线性空间和物理空间大小）</p><p>IPC：进程间通讯</p><p>同一主机上：</p><p>signal：发信号</p><p>shm：共享内存（进程同时使用一块内存）</p><p>semophore：信号量，一种计数器（可以对访问的资源加锁）：多个进程访问文件时，进程可以对访问的文件加锁，其它进程不能访问该文件。</p><p>不同主机上：</p><p>rpc：进程间远程调用（unix）</p><p>socket：IP和端口号</p><p><code>netstat -ntpl</code>（netstat用于显示网络状态）（-a可以查看所有连线中的socket）</p><h3 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h3><p>Linux内核：抢占式多任务（进程在内存中“排队”，前面的进程运行完，后面的进程会立刻运行）</p><h3 id="进程类型："><a href="#进程类型：" class="headerlink" title="进程类型："></a>进程类型：</h3><p>守护进程（daemon）：在系统引导过程中启动的进程，和终端无关</p><p>前台进程：跟终端相关，通过终端启动的进程</p><p>注意：两者可以相互转化（通过命令，可以将前台进程放到后台）</p><h3 id="进程状态："><a href="#进程状态：" class="headerlink" title="进程状态："></a>进程状态：</h3><p>执行<code>ps aux</code>命令STAT栏可查看进程状态</p><p>R：运行态：running，正在运行</p><p>就绪态：ready</p><p>睡眠态：</p><p>S：可中断：interruptable</p><p>D：不可中断：uninterruptable</p><p>T：停止态：stopped，暂停于内存中，但不会被调用，除非手动启动</p><p>Z：僵死态：zombie，结束进程，父进程结束前，子进程不关闭（父进程关闭子进程未关）</p><h2 id="系统管理工具"><a href="#系统管理工具" class="headerlink" title="系统管理工具"></a>系统管理工具</h2><p>进程的分类：</p><p>CPU-Bound ：CPU密集型，非交互</p><p>IO-Bound ：IO密集型，交互</p><p>Linux系统状态的查看及管理工具：<code>pstree</code>、<code>ps</code>、<code>pidof</code>、<code>pgrep</code>、<code>top</code>、<code>pmap</code>、<code>vmstat</code>、<code>dstat</code>、<code>kill</code>、<code>pkill</code>、<code>job</code>、<code>bg</code>、<code>fg</code>、<code>nohup</code></p><p><code>pstree</code>：命令，显示正在运行的程序树（父子关系图）</p><p><code>pstree -p</code>：显示进程的pid</p><p>ps：显示进程状态</p><p><code>ps 选项</code></p><p>Linux系统各进程的相关信息均保存在/proc/PID目录下的各文件中</p><p>列举进程ps</p><p>适用ps来查看进程信息（回车时刻，瞬间）</p><p>支持选项：UNIX选项 如-A -e</p><p>默认显示当前终端中的进程</p><p><code>a</code>：所有终端中的进程</p><p><code>x</code>：包括不链接终端的进程（守护进程）</p><p><code>u</code>：显示所有者信息</p><p><code>f</code>：显示进程的父进程</p><p><code>o</code>：属性…：显示定制信息（如pid、comm、%cpu、%mem、state、tty、euser、ruser、nice）</p><p><code>ps aux</code> 每个字段的意思</p><table><thead><tr><th align="left">USER</th><th align="left">PID</th><th align="left">%CPU</th><th align="left">%MEM</th><th align="left">VSZ</th><th align="left">RSS</th><th align="left">TTY</th><th align="left">STAT</th><th align="left">START</th><th align="left">TIME</th><th align="left">COMMAND</th></tr></thead><tbody><tr><td align="left">进程拥有者user</td><td align="left">任务进程的IDpid</td><td align="left">CPU占用率%cpu</td><td align="left">内存使用率%mem</td><td align="left">许诺的运行内存大小vsz</td><td align="left">实际使用的内存大小rss</td><td align="left">终端tty</td><td align="left">进程状态stat</td><td align="left">进程开始的时间start</td><td align="left">执行的时间time</td><td align="left">所执行的指令command</td></tr></tbody></table><p>进程状态stat：详细：</p><p>R：正在运行</p><p>S：可中断的睡眠</p><p>D：不可中断的睡眠</p><p>T：停止态</p><p>Z：僵死态</p><p>+：前台进程</p><p>l：多线程进程</p><p>N：低优先级进程</p><p>&lt;：高优先级进程</p><p>s：session leader，会话（子进程）发起者</p><p>常用组合：<code>-ef</code></p><table><thead><tr><th align="left">UID</th><th align="left">PID</th><th align="left">PPID</th><th align="left">C</th><th align="left">STIME</th><th align="left">TTY</th><th align="left">TIME</th><th align="left">CMD</th></tr></thead><tbody><tr><td align="left">用户名</td><td align="left">进程ID</td><td align="left">父进程ID</td><td align="left">进程占CPU百分比</td><td align="left">进程启动到现在的时间</td><td align="left">该进程在哪个终端上运行（？代表与终端无关）</td><td align="left">使用掉的CPU时间</td><td align="left">命令名和参数</td></tr></tbody></table><p><code>-e</code>：显示所有进程</p><p><code>-f</code>：显示完整格式程序信息</p><p>常用组合：<code>-eFH</code></p><table><thead><tr><th align="left">UID</th><th align="left">PID</th><th align="left">PPID</th><th align="left">C</th><th align="left">SZ</th><th align="left">RSS</th><th align="left">PSR</th><th align="left">STIME</th><th align="left">TTY</th><th align="left">TIME</th><th align="left">CMD</th></tr></thead><tbody><tr><td align="left">用户名</td><td align="left">进程ID</td><td align="left">父进程ID</td><td align="left">进程占CPU百分比</td><td align="left">进程的核心印象的页面大小</td><td align="left">进程实际使用的内存大小</td><td align="left">绑定内核线程的处理器的逻辑处理器号</td><td align="left">进程启动到现在的时间</td><td align="left">该进程在哪个终端上运行（？代表与终端无关）</td><td align="left">使用掉的CPU时间</td><td align="left">命令名和参数</td></tr></tbody></table><p><code>-F</code>：显示更完整格式的进程信息</p><p><code>-H</code>：以进程层级格式显示进程相关信息</p><p>常用组合：<code>aux</code> 、<code>axo</code>（有o选项需要在后面指明参数）</p><h1 id="进程及系统相关工具"><a href="#进程及系统相关工具" class="headerlink" title="进程及系统相关工具"></a>进程及系统相关工具</h1><p>ni：nice值</p><p>pri：priority优先级</p><p>psr：processor CPU编号</p><p>rtprio：实时优先级</p><h2 id="搜索进程"><a href="#搜索进程" class="headerlink" title="搜索进程"></a>搜索进程</h2><p>最灵活：<code>ps 选项 | 其它命令</code></p><p>按预定义的模式：<code>pgrep</code></p><p><code>pgrep 选项 模式</code></p><p><code>-u</code>：用户名/ID ：生效用户</p><p><code>-U</code>：用户名/ID ：命令发起者</p><p><code>-t</code>：终端：与指定终端相关的进程</p><p><code>-l</code>：显示进程名</p><p><code>-a</code>：显示完整格式的进程名（CentOS7）</p><p><code>-P pid</code>：显示指定进程的子进程</p><h2 id="系统工具"><a href="#系统工具" class="headerlink" title="系统工具"></a>系统工具</h2><p><code>uptime</code>：显示当前时间，系统已启动的时间、当前上线人数，系统平均负载（1、5、15分钟的平均负载，一般不会超过1）</p><p>系统平均负载：指定在特定时间间隔内运行队列中的平均进程数</p><p>如果每个CPU内核的当前活动进程数不大于3的话，那么系统的性能良好。</p><p>如果每个CPU内核的任务数大于5，那么这台机器的性能有严重问题。</p><p>如果Linux主机是1个双核CPU的话，当load average为6的时候说明机器已经被充分使用了。</p><h2 id="进程管理工具"><a href="#进程管理工具" class="headerlink" title="进程管理工具"></a>进程管理工具</h2><p><code>top</code>：有许多内置命令：</p><p>排序：</p><p><code>P</code>：以占据的CPU百分比，%CPU</p><p><code>M</code>：占据内存百分比，%MEM</p><p><code>T</code>：累积占据CPU时长，TIME+</p><p>首部信息显示：</p><p><code>uptime</code>信息：<code>l</code>命令</p><p>tasks及cpu信息：<code>t</code>命令</p><p>cpu分别显示1（数字）</p><p>memory信息：<code>m</code>命令</p><p>退出命令：<code>q</code></p><p>修改刷新时间间隔：<code>s</code></p><p>终止指定进程：<code>k</code></p><p>保存文件：<code>w</code></p><h3 id="top栏位信息简介"><a href="#top栏位信息简介" class="headerlink" title="top栏位信息简介"></a>top栏位信息简介</h3><p>第一行：系统运行时间</p><p>系统当前时间、系统已运行时间、当前登录系统的用户数量、系统负载（1,5,15分钟的平均值）</p><p>第二行：运行进程相关</p><p>所有启动的进程数、正在运行的进程数、挂起的进程数、停止的进程数、僵死进程数</p><p>第三行：CPU相关</p><p>用户空间占CPU百分比、内核空间占CPU百分比、调整过nice时间的进程占CPU百分比、空闲CPU百分比、等待IO占CPU的百分比、CPU服务于硬中断时间所占百分比、CPU服务于软中断时间所占百分比、被虚拟机偷走时间的百分比</p><p>第四行：内存相关</p><p>物理内存总量、已用物理内存、空闲物理内存、内核缓存内存量</p><p>第五行：交换分区相关</p><p>交换分区总量、已使用交换分区总量、空闲交换分区总量、缓冲的交换分区总量白色块：具体进程信息</p><table><thead><tr><th align="left">PID</th><th align="left">USER</th><th align="left">PR</th><th align="left">NI</th><th align="left">VIRT</th><th align="left">RES</th><th align="left">SHR</th><th align="left">S</th><th align="left">%CPU</th><th align="left">%MEM</th><th align="left">TIME+</th><th align="left">COMMAND</th></tr></thead><tbody><tr><td align="left">进程ID</td><td align="left">进程所有者user</td><td align="left">优先级pr</td><td align="left">nice值</td><td align="left">进程使用的虚拟内存总量virt</td><td align="left">进程使用的,未被换出的物理内存大小res</td><td align="left">共享内存大小shr</td><td align="left">进程状态s</td><td align="left">上次更新到现在的CPU时间占用百分比%cpu</td><td align="left">进程使用的物理内存百分比%mem</td><td align="left">进程使用CPU总时间time+</td><td align="left">命令名，命令行command</td></tr></tbody></table><h3 id="内存工具"><a href="#内存工具" class="headerlink" title="内存工具"></a>内存工具</h3><p>vmstat 命令：虚拟内存信息</p><p><code>vmstat -s</code>：显示内存的统计数据</p><p><code>vmstat 2 5</code>：间隔2秒，信息刷新5次</p><p>procs：</p><p>r：等待运行的进程的个数，和核心数有关</p><p>b：处于不可中断睡眠态的进程个数（被阻塞的队列的长度）</p><p>memory：</p><p>swpd：交换内存的使用总量</p><p>free：空闲物理内存总量</p><p>buffer：用于buffer的内存总量</p><p>cache：用于cache的内存总量</p><p>swap：</p><p>si：从磁盘交换进内存的数据速率kb/s</p><p>so：从内存交换至磁盘的数据速率kb/s</p><p>io：</p><p>bi：从块设备读入数据到系统的速率kb/s</p><p>bo：保存数据至块设备的速率kb/s</p><p>system：</p><p>in：中断速率，包括时钟</p><p>cs：进程切换速率</p><p>cpu：</p><p>us：用户进程执行时间百分比</p><p>sy：内核系统进程执行时间百分比</p><p>id：空闲时间百分比</p><p>wa：IO等待时间百分比</p><p>st：虚拟内存偷走时间百分比</p><h3 id="进程管理工具-1"><a href="#进程管理工具-1" class="headerlink" title="进程管理工具"></a>进程管理工具</h3><p>按PID：<code>kill pid</code></p><p>按名称：<code>killall 进程名</code></p><p>按模式：<code>pkill 选项 模式</code></p><p><code>pkill -u 用户名/uid</code>：生效者</p><p><code>pkill -U 用户名/uid</code>：进程发起者</p><p><code>pkill -t 终端</code>：与指定终端相关的进程</p><h3 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h3><p>Linux的作业控制</p><p>前台作业：通过终端启动，且启动后一直占据终端</p><p>后台作业：可通过终端启动，但启动后即转入后台运行（释放终端）</p><p>Ctrl+z ：运行中的作业放到后台（停止态）</p><p>命令 &amp; ：未启动的作业放到后台运行（和Ctrl+z有区别）</p><p>（[1] dd命令Ctrl+z [2] dd命令 &amp; [3] cat 命令Ctrl+z [4] cat命令 &amp; ）</p><p>后台作业虽然被送往后台运行，但其依然与终端相关；退出终端，将关闭后台作业。如果希望送往后台后，剥离与终端的关系使用</p><p>nohup 命令 &amp;</p><h3 id="查看所有作业："><a href="#查看所有作业：" class="headerlink" title="查看所有作业："></a>查看所有作业：</h3><p><code>jobs</code>、<code>jobs -l</code>显示更详细</p><p>作业控制：</p><p><code>fg #</code>：把指定的后台作业调回前台</p><p><code>bg #</code>：送往后台的作业继续运行</p><p><code>kill %#</code>：终止指定的作业</p><p>进程优先级</p><p>进程优先级调整：</p><p>静态优先级：100-139</p><p>进程默认启动时的nice值为0，优先级为120</p><p>只有根用户才能调低nice值（提高优先级）</p><p><code>nice</code>命令：</p><p><code>nice 选项 命令</code> （未运行的命令）</p><p>例：<code>nice -n -5 ping 127.0.0.1</code>（将命令ping 127.0.0.1的nice值调为-5）</p><p><code>renice</code>命令：</p><p><code>renice</code>选项 PID（运行中的命令）</p><p>例：<code>renice -n -20 1234</code>（将指定PID号的进程，nice值调整为-20）</p><p><code>ps axo pid,comm,ni</code> ：查看pid，命令，nice值</p><h1 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h1><p>linux 任务计划、周期性任务执行</p><p>未来的某时间点执行任务：<code>at</code></p><p>周期性运行某任务：<code>cron</code></p><h2 id="at任务"><a href="#at任务" class="headerlink" title="at任务"></a>at任务</h2><p><code>at命令：at [option] TIME</code></p><p>常用选项：</p><p><code>-V</code>：显示版本信息</p><p><code>-l</code>：列出指定队列中等待运作的作业，相当于<code>atq</code></p><p><code>-d</code>：删除指定的作业，相当于<code>atrm</code></p><p><code>-c</code>：查看具体作业任务</p><p><code>-f file</code>：从指定文件中读取任务</p><p><code>-m</code>：当任务被完成之后，将给用户发送邮件，即使没有标准输出</p><p>注意：作业执行命令的结果中的标准输出和错误以邮件通知给相关用户</p><p>TIME：定义出什么时候进行<code>at</code>这项任务的时间</p><p><code>HH:MM [YYYY-mm-dd]</code></p><p><code>noon,midnight,teatime(4pm)</code></p><p><code>tomorrow</code></p><p><code>now+#&#123;minutes,hours,days,OR weeks&#125;</code></p><p><code>at</code>时间格式</p><p><code>HH:MM 02:00</code></p><p>在今日的<code>HH:MM</code>进行，若时刻已过，则明天此时执行任务</p><p><code>HH:MM YYYY-MM-DD 04:00 2016-09-20</code></p><p>规定在某年某月的某一天的特殊时刻进行该项任务</p><p><code>HH:MM[am|pm] [month] [date]</code></p><p><code>04pm march 17</code></p><p><code>17:20 tomorrow</code></p><p><code>HH:MM[am|pm] + number [minutes|hours|days|weeks]</code></p><p>在某个时间点再加几个时间后才进行该项任务</p><p><code>now + 5 minutes</code></p><p><code>04pm + 3 days</code></p><p>执行方式：</p><ol><li><p>交互式</p></li><li><p>输入重定向</p></li><li><p><code>at -f 文件</code></p></li></ol><p>依赖与<code>atd</code>服务，需要启动才能实现<code>at</code>任务</p><p>通过<code>/etc/at.&#123;allow,deny&#125;</code>控制用户是否能执行<code>at</code>任务，先寻找<code>/etc/at.allow</code>找，不存在就寻找<code>/etc/at.deny</code>这个文件，若写在这个<code>at.deny</code>用的使用者则不能使用<code>at</code>，而没有在这个<code>at.deny</code>文件的使用者则可使用<code>at</code>命令，如果两个文件都不存在，则只有<code>root</code>可以使用<code>at</code>这个命令</p><h2 id="周期性计划任务cron"><a href="#周期性计划任务cron" class="headerlink" title="周期性计划任务cron"></a>周期性计划任务cron</h2><p>相关的程序包：</p><p><code>cronie</code>：主程序包，提供<code>crond</code>守护进程及相关辅助工具</p><p><code>cronie-anacron</code>：<code>cronie</code>的补充程序，用于监控<code>cronie</code>任务执行状况，如<code>cronie</code>中的任务在过去该运行的时间点未能正常运行，则<code>anacron</code>会随后启动一次此任务</p><p><code>crontabs</code>：包含<code>CentOS</code>提供系统维护任务</p><p>确保<code>crond</code>守护处于运行状态</p><p><code>service crond status</code></p><p>计划周期性执行的任务交给<code>crond</code>，到指定时间会自动运行</p><p>系统<code>cron</code>任务：系统维护作业</p><p><code>/etc/crontab</code></p><p>用户<code>cron</code>任务：</p><p><code>crontab</code>命令</p><p>日志：<code>/var/log/cron</code></p><p>系统<code>cron</code>任务：<code>/etc/crontab</code></p><p>注释行以<code>#</code>开头</p><p><code>* * * * *（分时日月周）</code></p><p><code>*</code>表示”每”</p><p><code>* * * * *</code>每一分钟执行一次周期任务</p><p><code>2 * * * *</code>每小时02分执行一次周期任务</p><p><code>0 2 * * *</code>每天2点0分执行一次周期任务</p><p><code>0 0 */3 * *</code>每3天整执行一次周期任务</p><p><code>*/3 */2 */3 * *</code>每隔3天的每隔2小时的每隔3分钟执行一次周期任务</p><p><code>0 0 1 6 *</code>每到6月1日0时0分执行一次周期任务</p><p><code>* 3-8 * * */3</code>每隔3周的3到8点整每分钟执行一次周期任务</p><p><code>0 0 * * 0,3,5</code>每个周日，周三，周五0时0分执行一次周期任务</p><p>分（0-59），时（0-23），日（1-31），月（1-12），周（0-6）</p><p>系统的计划任务：</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;crontab&#x2F;etc&#x2F;cron.d&#x2F;&#x2F;etc&#x2F;cron.hourly&#x2F;&#x2F;etc&#x2F;cron.daily&#x2F;&#x2F;etc&#x2F;cron.weekly&#x2F;&#x2F;etc&#x2F;cron.monthly&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用户<code>cron</code>：</p><p><code>crontab</code>命令定义，每个用户都有专用的<code>cron</code>任务文件：</p><p><code>/var/spool/cron/USERNAME</code></p><p><code>crontab</code>命令：</p><p><code>crontab [-u user] [-l | -r | -e] [-i]</code> </p><p><code>-l</code>列出所有任务</p><p><code>-e</code>编辑任务</p><p><code>-r</code>移除所有任务</p><p><code>-i</code>同<code>-r</code>一同使用，以交互模式移除指定任务</p><p><code>-u user</code>仅<code>root</code>可运行，指定用户管理<code>cron</code>任务</p><p>控制用户执行计划任务：</p><p><code>/etc/cron.&#123;allow,deny&#125;</code></p><p>注意：运行结果的标准输出和错误以邮件通知给相关用户</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">command</span> <span class="token operator">></span> /dev/null<span class="token builtin class-name">command</span> <span class="token number">2</span><span class="token operator">&amp;></span><span class="token number">1</span> /dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>对于<code>cron</code>任务来讲，<code>%</code>号有特殊用途，如果在命令中要使用<code>%</code>，则需要转义，不过，如果把<code>%</code>号放置于单引号中，也可以不用转义</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件管理</title>
      <link href="/posts/ae533703.html"/>
      <url>/posts/ae533703.html</url>
      
        <content type="html"><![CDATA[<h1 id="系统配额"><a href="#系统配额" class="headerlink" title="系统配额"></a>系统配额</h1><ol><li>配额的作用：当Linux根分区的磁盘空间耗尽时，Linux系统将无法再建立新的文件（包括程序运行的临时文件），从而出现服务程序崩溃，系统无法启动等故障现象。</li></ol><p>为了避免在服务器中出现类似的磁盘空间不足的问题，可以设置启用磁盘配额功能，对用户在指定文件系统（分区）中使用的磁盘空间、文件数量进行限制，以防个别用户恶意或无意间占用大量磁盘空间。是为了存储空间的稳定性和可持续性。</p><ol start="2"><li>配额系统综述：</li></ol><blockquote><p>在内核中执行</p></blockquote><blockquote><p>作用范围：以文件系统（分区）为单位启用</p></blockquote><blockquote><p>限制对象：对不同组、用户限制</p></blockquote><blockquote><p>限制类型：根据磁盘容量或者文件数量（配置文件中容量单位默认为K）</p></blockquote><blockquote><p>限制方法：</p></blockquote><blockquote><blockquote><p>软限制（soft）：指定一个软性的配额数值，在固定的宽限期内（默认7天），允许超过这个限制，但文件系统会给出警告信息。</p></blockquote></blockquote><blockquote><blockquote><p>硬限制（hard）：指定一个硬性的配额数值，绝对禁止用户超过的限制值，当达到硬限制值时系统也会给出警告并禁止继续写入数据，硬限制的配额值应大于相应的软限制值，否则软限制将失效。</p></blockquote></blockquote><p>综上，只有当用户或组、文件系统（分区）及配额数值都满足限额条件时，才会对操作进行限制。</p><ol start="3"><li>配额管理：步骤：以支持配额功能的方式挂载文件系统→检测磁盘配额并生成配额文件→编辑用户和组行号的配额设置→开启文件系统配额功能→验证磁盘配额功能→查看配额使用情况。</li></ol><p>以支持配额功能的方式挂载</p><p><code>mount -o usrquota,grpquota 设备分区名 挂载点</code></p><p>以支持配额功能的方式重新挂载</p><p><code>mount -o remount,usrquota,grpquota 设备分区名 挂载点</code></p><p>开机自动挂载支持磁盘配额功能</p><p><code>vim /etc/fstab</code></p><p><code>设备分区名 挂载点 文件系统类型 usrquota,grpquota 0 0</code></p><p>检测磁盘配额并生成配额文件</p><p><code>quotacheck -augcv</code></p><blockquote><p>选项</p></blockquote><blockquote><blockquote><p>-a：检测所有分区（如不使用-a，则必须指定一个设备分区名或挂载点，作为命令参数）</p></blockquote></blockquote><blockquote><blockquote><p>-u：检测用户配额信息</p></blockquote></blockquote><blockquote><blockquote><p>-g：检测组配额信息</p></blockquote></blockquote><blockquote><blockquote><p>-c：创建新的配额文件</p></blockquote></blockquote><blockquote><blockquote><p>-v：显示命令执行过程</p></blockquote></blockquote><p>设定配额：编辑用户和组的配额设置</p><p><code>edquota -u 用户名</code></p><p>（blocks设置soft 5文件大小软限制为5k，设置hard 9文件大小硬限制为9k；inodes设置soft 2文件数量软限制为2个，设置hard 5文件数量硬限制为5个）</p><p><code>edquota -g 组名</code></p><p>打开配额文件编辑</p><pre class="line-numbers language-none"><code class="language-none">block soft hard inode soft hard        1   2           1   2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>释义：文件大小 软限制1K 硬限制2K 文件个数 软限制1个 硬限制2个</p><p>修改宽限期</p><p><code>edquota -t</code></p><p>修改配置文件 <code>#days</code></p><p>启动配额功能</p><p><code>quotaon -u 设备分区名（挂载点）</code></p><p><code>quotaon -g 设备分区名（挂载点）</code></p><p><code>-v</code> 显示命令的执行过程</p><p>关闭磁盘配额</p><p><code>quotaoff -u/g -v 设备分区名（挂载点）</code></p><p>查看配额状态</p><p><code>quota -u 用户名</code></p><p><code>quota -g 组名</code></p><p>查看指定文件系统输出配额使用情况</p><p><code>repquota 设备分区名</code></p><p>查看所有可用分区的配额使用报告</p><p><code>repquota -a</code> </p><h1 id="软RAID设备"><a href="#软RAID设备" class="headerlink" title="软RAID设备"></a>软RAID设备</h1><p>RAID：磁盘阵列</p><p>简单的说，RAID是把多块独立的物理硬盘组合起来，形成一个硬盘组即逻辑硬盘，从而提供比单个硬盘更高的存储性能和提供数据备份技术。</p><p>组成磁盘阵列的不同方式称为RAID级别，根据不同级别，分别可以提供不同的速度、安全和性价比，根据实际情况选择适当的RAID级别可以满足用户对存储系统可用性能和容量的要求。</p><h2 id="RAID实现方式："><a href="#RAID实现方式：" class="headerlink" title="RAID实现方式："></a>RAID实现方式：</h2><p>外接式磁盘阵列：通过扩展卡提供适配能力</p><p>内接式RAID：主板集成RAID控制器；安装OS前在BIOS里配置</p><p>软件RAID：通过OS实现</p><p>RAID级别：0：条带卷 1：镜像卷 5、6、1 0、0 1、</p><h3 id="RAID-0：条带卷"><a href="#RAID-0：条带卷" class="headerlink" title="RAID-0：条带卷"></a>RAID-0：条带卷</h3><p>数据分割之后并行存储</p><p>读写性能提升</p><p>可用空间N x min（N磁盘数量，min最小磁盘容量）</p><p>无容错能力（损坏一块就不能用），适合对数据读写要求高，而对安全无要求的环境</p><p>至少磁盘数：2</p><h3 id="RAID-1：镜像卷"><a href="#RAID-1：镜像卷" class="headerlink" title="RAID-1：镜像卷"></a>RAID-1：镜像卷</h3><p>数据分割后，进行镜像备份存储</p><p>读取性能提升，写入性能下降</p><p>可用空间min</p><p>有冗余能力（有一块磁盘完好就行），适合对安全要求高的环境</p><p>至少磁盘数：2或2的倍数</p><h3 id="RAID-5："><a href="#RAID-5：" class="headerlink" title="RAID-5："></a>RAID-5：</h3><p>3块以上的盘组成阵列，一个数据分成N-1份，同时生成一份校验数据，共N份数据在N块盘上循环均衡存储</p><p>校验数据作用：在某一块盘损坏时，可以通过其它盘和校验数据，把数据内容算出来</p><p>N块盘同时读写，由于校验机制，写性能相对不高，但综合性能很好</p><p>可用空间N-1 x min</p><p>有容错能力：允许坏一块，不影响数据</p><p>最少磁盘数：3</p><h3 id="RAID-6：（类似5）"><a href="#RAID-6：（类似5）" class="headerlink" title="RAID-6：（类似5）"></a>RAID-6：（类似5）</h3><p>由4块以上的盘组成阵列，数据分成N-2份，并生成2份独立的奇偶校验数据，N份数据在磁盘上循环均衡存储</p><p>由于存在2个独立的奇偶校验数据，所以写入性能较差，但数据可靠性非常高</p><p>有容错能力：最多允许坏2块盘</p><p>最少磁盘数：4</p><p>RAID-10：先进行RAID-1再进行RAID-0</p><p>RAID-01：先进行RAID-0再进行RAID-1</p><p>其它RAID-50等</p><p>步骤：安装mdadm→准备用于RAID阵列的分区→创建RAID设备→在RAID设备中建立文件系统→挂载并使用文件系统</p><p><code>fdisk /dev/sd*</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mdadm</span> <span class="token punctuation">[</span>模式<span class="token punctuation">]</span> <span class="token operator">&lt;</span>设备名称<span class="token operator">></span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>磁盘分区<span class="token operator">></span>模式：-C：创建    <span class="token parameter variable">-n</span> <span class="token comment">#：使用#块设备创建此RAID</span>    <span class="token parameter variable">-l</span> <span class="token comment">#：指明要创建的RAID级别</span>    <span class="token parameter variable">-a</span> yes：自动创建目标RAID设备文件    <span class="token parameter variable">-c</span> <span class="token comment">#[KMG]：指明块大小</span>    <span class="token parameter variable">-x</span> <span class="token comment">#：指明空闲盘的个数</span>-A：装配、激活    -s：扫描设备信息-D（--detail）：显示RAID的详细信息<span class="token function">mdadm</span> <span class="token parameter variable">-D</span> /dev/md<span class="token comment">#</span>管理模式：    -f：标记指定磁盘为损坏    -a：添加磁盘    -r：移除磁盘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>观察md的状态：</p><p><code>cat /proc/mdstat</code></p><p>创建RAID设备：</p><p><code>mdadm -C /dev/md0 -a yes -l 5 -n 3 -x 1 /dev/sdb&#123;1,2,3,4&#125;</code></p><p>在RAID中建立文件系统：</p><p><code>mkfs.ext4 /dev/md0</code></p><p>挂载使用</p><p><code>mount /dev/md0 /testdir</code></p><p>生成RAID配置文件：<code>/etc/mdadm.conf</code>（默认不存在）</p><p>执行<code>mdadm -D -s &gt;&gt; /etc/mdadm.conf</code></p><p><code>vim /etc/mdadm.conf</code></p><p>修改其内容：在最上面添加一行：<code>DEVICE /dev/sd*</code> ；第二行删除<code>metadata=…</code>,<code>name=…</code>两项；保存退出</p><p>检测配置文件是否有语法错误：</p><p>使用启动/停止服务的方式：</p><p>&emsp;&emsp;停服务：<code>mdadm -S /dev/md0</code></p><p>&emsp;&emsp;激活/启动：<code>mdadm -As /dev/md0</code></p><p>&emsp;&emsp;强制启动：<code>mdadm -R /dev/md0</code></p><p>查看<code>df -hT</code></p><p>自动挂载：添加到<code>/etc/fstab</code>文件中去</p><p>模拟磁盘故障</p><p><code>mdadm /dev/md0 -f /dev/sdb1</code></p><p>移除磁盘</p><p><code>mdadm /dev/md0 -r /dev/sdb1</code></p><p>添加新成员</p><p><code>mdadm -G /dev/md0 -n 4 -a /dev/sdb1</code></p><p>从软件RAID磁盘修复磁盘故障：</p><p>替换出故障的磁盘然后开机；在备用驱动器上重建分区；</p><p><code>mdadm /dev/md0 -a /dev/sdb1</code></p><p>查看状态：</p><p><code>mdadm --query或cat /proc/mdstat</code></p><p>删除RAID信息：<code>mdadm --zero-superblock /dev/sdb1</code></p><h1 id="LVM逻辑卷"><a href="#LVM逻辑卷" class="headerlink" title="LVM逻辑卷"></a>LVM逻辑卷</h1><p>允许对卷进行方便操作的抽象层，包括重新设定文件系统的大小，允许在多个物理设备间重新组织文件系统</p><p>将设备指定为物理卷PV</p><p>用一个或多个物理卷来创建一个卷组VG</p><p>物理卷是用固定大小的物理区域PE来定义的</p><p>在物理卷上利用物理区域创建逻辑卷LV</p><p>可以在逻辑卷上创建文件系统</p><p>LVM介绍：LVM：逻辑卷管理器；设备名：<code>/dev/dm-#</code></p><p>LVM可以弹性的更改LVM的容量：通过交换PE来进行资料的转换，将原来LV内的PE转移到其他的设备中以LV的容量，或将其他设备中的PE加到LV中以加大容量</p><table><thead><tr><th align="left">功能</th><th align="left">物理卷管理PV</th><th align="left">卷管理VG</th><th align="left">逻辑卷管理LV</th></tr></thead><tbody><tr><td align="left">scan 扫描</td><td align="left">pvscan</td><td align="left">vgscan</td><td align="left">lvscan</td></tr><tr><td align="left">create 建立</td><td align="left">pvcreate</td><td align="left">vgcreate</td><td align="left">lvcreate</td></tr><tr><td align="left">display 显示</td><td align="left">pvdisplay</td><td align="left">vgdisplay</td><td align="left">lvdisplay</td></tr><tr><td align="left">remove 删除</td><td align="left">pvremove</td><td align="left">vgremove</td><td align="left">lvremove</td></tr><tr><td align="left">reduce 缩减</td><td align="left">-</td><td align="left">vgreduce</td><td align="left">lvreduce</td></tr><tr><td align="left">extend 扩展</td><td align="left">-</td><td align="left">vgextend</td><td align="left">lvestend</td></tr></tbody></table><h2 id="PV管理工具："><a href="#PV管理工具：" class="headerlink" title="PV管理工具："></a>PV管理工具：</h2><p>PV：物理卷：整个硬盘，或使用fdisk工具建立的普通分区（8e），包括许多默认的4MB大小的PE单元</p><p>创建PV物理卷</p><p><code>pvcreate /dev/sdb&#123;1,2,3&#125;</code></p><p>pvs：显示简要pv信息（pvdisplay显示的更详细）</p><h2 id="VG管理工具"><a href="#VG管理工具" class="headerlink" title="VG管理工具"></a>VG管理工具</h2><p>VG：卷组：一个或多个物理卷组合而成的整体（相当于逻辑上的一个硬盘）</p><p>创建卷组（-s指定PE大小8M）</p><p><code>vgcreate -s 8m vg名 pv名</code></p><p>vgs：显示简要vg信息（vgdisplay显示的更详细）</p><p><code>vgextend vg名 pv名（扩容vg）</code></p><p><code>vgreduce vg名 pv名（减容vg）</code></p><p><code>vgremove /dev/vg名（删除vg）</code>，先做<code>pvmove /dev/pv1 /dev/pv2</code>（将pv1中的内容移动到pv2中），不需要保留数据则不做pvmove</p><h2 id="LV管理工具"><a href="#LV管理工具" class="headerlink" title="LV管理工具"></a>LV管理工具</h2><p>LV：逻辑卷：从卷组中割出的一块空间，可以格式化挂载使用</p><p>创建逻辑卷</p><p><code>lvcreate -L 5G -n lv名 vg名</code>（-L指定lv大小5g）</p><p>lvs：显示lv简要信息（lvdisplay显示的更详细）</p><h3 id="扩展逻辑卷LV"><a href="#扩展逻辑卷LV" class="headerlink" title="扩展逻辑卷LV"></a>扩展逻辑卷LV</h3><p><code>lvextend -L 7G /dev/vg名/lv名</code>（扩展逻辑卷到7G），</p><p>执行<code>resize2fs /dev/vg名/lv名</code>，让文件系统<code>df -h</code>识别扩展后的逻辑卷大小</p><h3 id="缩减逻辑卷"><a href="#缩减逻辑卷" class="headerlink" title="缩减逻辑卷"></a>缩减逻辑卷</h3><p><code>umount /dev/vg名/lv名</code>：卸载</p><p><code>e2fsck -f /dev/vg名/lv名</code>：磁盘检查</p><p><code>resize2fs /dev/vg名/lv名 3G</code>：指定缩减后的逻辑卷大小为3G（将分散的数据整理到要保留的3G逻辑卷空间里）</p><p><code>lvreduce -L 3G /dev/vg名/lv名</code>：缩减逻辑卷为3G</p><p><code>mount /dev/vg名/lv名 /原挂载点</code>（由于执行<code>resize2fs</code>命令，所以原挂载的内容会被保留，原挂载点数据&lt;3G）</p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/edquota">磁盘配额edquota</a><br><a href="../linux-command-1.16.0/quota">磁盘配额quota</a><br><a href="../linux-command-1.16.0/fdisk">磁盘分区fdisk</a><br><a href="../linux-command-1.16.0/parted">磁盘分区parted</a><br><a href="../linux-command-1.16.0/partprobe">重载分区</a></p><table><thead><tr><th align="left">功能</th><th align="left">物理卷管理PV</th><th align="left">卷管理VG</th><th align="left">逻辑卷管理LV</th></tr></thead><tbody><tr><td align="left">scan 扫描</td><td align="left"><a href="../linux-command-1.16.0/pvscan">pvscan</a></td><td align="left"><a href="../linux-command-1.16.0/vgscan">vgscan</a></td><td align="left"><a href="../linux-command-1.16.0/lvscan">lvscan</a></td></tr><tr><td align="left">create 建立</td><td align="left"><a href="../linux-command-1.16.0/pvcreate">pvcreate</a></td><td align="left"><a href="../linux-command-1.16.0/vgcreate">vgcreate</a></td><td align="left"><a href="../linux-command-1.16.0/lvcreate">lvcreate</a></td></tr><tr><td align="left">display 显示</td><td align="left"><a href="../linux-command-1.16.0/pvdisplay">pvdisplay</a></td><td align="left"><a href="../linux-command-1.16.0/vgdisplay">vgdisplay</a></td><td align="left"><a href="../linux-command-1.16.0/lvdisplay">lvdisplay</a></td></tr><tr><td align="left">remove 删除</td><td align="left"><a href="../linux-command-1.16.0/pvremove">pvremove</a></td><td align="left"><a href="../linux-command-1.16.0/vgremove">vgremove</a></td><td align="left"><a href="../linux-command-1.16.0/lvremove">lvremove</a></td></tr><tr><td align="left">reduce 缩减</td><td align="left">-</td><td align="left"><a href="../linux-command-1.16.0/vgreduce">vgreduce</a></td><td align="left"><a href="../linux-command-1.16.0/lvreduce">lvreduce</a></td></tr><tr><td align="left">extend 扩展</td><td align="left">-</td><td align="left"><a href="../linux-command-1.16.0/vgextend">vgextend</a></td><td align="left"><a href="../linux-command-1.16.0/lvestend">lvestend</a></td></tr></tbody></table><p><a href="../linux-command-1.16.0/pvck">pvck检查</a><br><a href="../linux-command-1.16.0/pvchange">pvchange分配</a><br><a href="../linux-command-1.16.0/pvs">pvs物理卷概要</a><br><a href="../linux-command-1.16.0/lvresize">lvresize改变逻辑卷大小</a><br><a href="../linux-command-1.16.0/vgchange">vgchange修改卷组状态</a><br><a href="../linux-command-1.16.0/vgconvert">vgconvert转换卷组格式</a><br><a href="../linux-command-1.16.0/vgrename">vgrename重命名卷组</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> file </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>磁盘管理</title>
      <link href="/posts/3eacf027.html"/>
      <url>/posts/3eacf027.html</url>
      
        <content type="html"><![CDATA[<h1 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h1><p>I/O设备地址  </p><h2 id="设备类型："><a href="#设备类型：" class="headerlink" title="设备类型："></a>设备类型：</h2><p>块设备：block，存取单位”块”，磁盘</p><p>字符设备：char，存取单位”字符”，键盘</p><p>设备文件：关联至一个设备驱动程序，进而能够跟与之对应硬件设备进行通信</p><h2 id="设备号码："><a href="#设备号码：" class="headerlink" title="设备号码："></a>设备号码：</h2><p>主设备号：标识设备类型</p><p>次设备号：标识同一类型下的不同设备</p><h2 id="硬盘接口类型："><a href="#硬盘接口类型：" class="headerlink" title="硬盘接口类型："></a>硬盘接口类型：</h2><p>并行：串口：</p><p>设备文件：磁盘设备命名：<code>/dev/sd[a-z]</code></p><p>不同设备：<code>a-z</code></p><p>同一设备不同分区<code>/dev/sda[1-4]</code>（主分区最多4个，扩展分区只1个，多个无意义即3主分区+1扩展分区）</p><h2 id="磁盘结构："><a href="#磁盘结构：" class="headerlink" title="磁盘结构："></a>磁盘结构：</h2><p>磁臂、磁头head、主轴、电机、磁道track、扇区secotr（大小512bytes）、簇（同一磁道的连续多个扇区）、盘面、盘片、柱面cylinder</p><h3 id="磁盘分区：为什么分区？"><a href="#磁盘分区：为什么分区？" class="headerlink" title="磁盘分区：为什么分区？"></a>磁盘分区：为什么分区？</h3><ol><li><p>优化I/O性能</p></li><li><p>实现磁盘空间配额限制</p></li><li><p>提高修复速度</p></li><li><p>隔离系统和程序</p></li><li><p>安装多个OS</p></li><li><p>采用不同文件系统</p></li></ol><p>分区：两种分区方式：<code>MBR</code>，<code>GPT</code></p><p>MBR：1982年，使用32位表示扇区数，分区不超过2T</p><h3 id="如何分区：按柱面分区"><a href="#如何分区：按柱面分区" class="headerlink" title="如何分区：按柱面分区"></a>如何分区：按柱面分区</h3><p>0磁道0扇区：512bytes（其中446字节为引导程序boot loader，64字节是分区表，其中16字节标识一个分区，2字节：55AA分区标志）</p><p>最多拥有64÷16=4个主分区（也可以&lt;4个主分区+1个扩展分区，在扩展分区上可划分多个逻辑分区）</p><h4 id="管理分区："><a href="#管理分区：" class="headerlink" title="管理分区："></a>管理分区：</h4><p><code>lsblk</code>：列出块设备</p><p><code>partx -a /dev/sd*</code>：重新设置内存中的内核分区表版本（使硬盘分区表生效    centos5,7使用partprobe）（多执行几次，不行就reboot）</p><p><code>blkid /dev/sda#</code>：查看分区设备的UUID</p><h4 id="fdisk-分区工具"><a href="#fdisk-分区工具" class="headerlink" title="fdisk 分区工具"></a>fdisk 分区工具</h4><p><code>fdisk /dev/sdb</code>：对sdb进行分区</p><p>子命令：</p><p><code>m</code>：帮助</p><p><code>p</code>：列表分区情况</p><p><code>t</code>：更改分区系统类型对应编号</p><p><code>l</code>：查看分区系统类型对应编号</p><p><code>d</code>：删除分区</p><p><code>w</code>：保存退出</p><p><code>q</code>：不保存退出</p><p><code>n</code>：创建分区</p><p>&emsp;&emsp;<code>e</code>：指定创建扩展分区</p><p>&emsp;&emsp;<code>p</code>：指定创建主分区</p><p>&emsp;&emsp;<code>l</code>：指定创建逻辑分区</p><p><code>fdisk -l</code>：显示硬盘使用情况（按柱面、磁道显示）</p><p><code>fdisk -lu</code>：按扇区显示信息</p><p><code>cat /proc/partitions</code>：查看内核是否已经识别新的分区</p><p><code>partx -a /dev/sd*</code>：通知内核重新读取硬盘分区表</p><p><code>partx -d --nr 5-6 /dev/sd*</code>：fdisk删除分区，内存未识别情况下，使用partx -d使其识别（范围删除5-6）</p><p><code>lsmod</code> 查看系统中启用的模块</p><h1 id="文件系统："><a href="#文件系统：" class="headerlink" title="文件系统："></a>文件系统：</h1><p>文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统。从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩，加密等。</p><h2 id="文件系统分类："><a href="#文件系统分类：" class="headerlink" title="文件系统分类："></a>文件系统分类：</h2><ol><li><p>根据其是否支持”日志”功能</p></li><li><p>日志型文件系统：ext3，ext4，xfs</p></li><li><p>非日志型文件系统：ext2，vfat</p></li></ol><p><code>cat /proc/filesystems</code>：查看支持的文件系统</p><p><code>mkfs.ext4 /dev/sd*#</code>：（.xfs .btrfs .vfat）</p><p><code>mkfs -t 文件系统类型 /dev/sd*#</code></p><p>扩展分区不可以格式化使用，因为扩展分区是个逻辑性的硬盘，只有分区后，对逻辑分区格式化后才能使用</p><h2 id="文件系统检测和修复"><a href="#文件系统检测和修复" class="headerlink" title="文件系统检测和修复"></a>文件系统检测和修复</h2><p>非常发生于死机或者非正常关机之后</p><p>挂载为文件系统标记为”no clean”</p><p>注意：一定不要在挂载状态下修复</p><p><code>fsck.ext4 /dev/sd*#</code>：对分区检测和修复（.ext4 .xfs等要与分区已存在的文件类型相同）（等同于fsck -t ext4 -ar /dev/sd*#）</p><p><code>e2fsck -y -f /dev/sd*#</code> （专用于ext系列文件的检测修复工具）</p><p><code>-y</code>：自动回答为yes</p><p><code>-f</code>：强制修复</p><h2 id="挂载mount"><a href="#挂载mount" class="headerlink" title="挂载mount"></a>挂载mount</h2><p>挂载<code>mount</code>：将额外的文件系统与文件系统某现存的目录建立起关联关系，进而使得此目录做为其它文件访问入口的行为</p><p>卸载：为解除此关联关系的过程</p><p><code>mount [选项] 设备分区名 挂载目录</code>：把设备关联到挂载点</p><p>选项：</p><p><code>-t ext4</code> 指明文件类型是ext4</p><p><code>-r</code> 只读挂载</p><p><code>-a</code> 自动挂载（定义在/etc/fstab文件中）</p><p>（umount -a 报错是/dev/sdb1挂载到/testdir目录时，/dev/sdb1分区被做成了RAID）</p><p><code>-o [选项]</code>（remount，usrquota，grpquota即：重新挂载，对用户的配额文件，对组的配额文件）</p><p>如果挂载目录下有文件，那么挂载后原有文件会被临时隐藏，解除挂载关系后原有文件还原。（挂载点目录一般为空）</p><p><code>cat /etc/mtab</code>：显示当前已挂载的所有设备</p><p><code>findmnt 挂载点</code>：查看挂载点的挂载情况</p><p><code>umount 设备分区名（或者挂载目录）</code>：卸载，即解除关联关系</p><p>挂载点和<code>/etc/fstab</code>：</p><ol><li><p>文件系统体系</p></li><li><p>被mount、fsck和其它程序使用</p></li><li><p>系统重启时保留文件系统体系</p></li><li><p>使用<code>mount -a</code>命令 挂载/etc/fstab文件里的配置信息</p></li></ol><p>/etc/fstab每行的定义：</p><ol><li><p>要挂载的设备 挂载点 文件系统类型 挂载选项 转储频率 自检次序</p></li><li><p>要挂载的设备：（设备文件、UUID、伪文件系统名称）</p></li><li><p>挂载选项：defaults（usrquota，grpquota）</p></li><li><p>转储频率：</p></li></ol><blockquote><p>0：不做备份</p></blockquote><blockquote><p>1：每天转储</p></blockquote><blockquote><p>2：每隔一天转储</p></blockquote><ol start="5"><li>自检次序：</li></ol><blockquote><p>0：不自检</p></blockquote><blockquote><p>1：首先自检；一般只有rootfs才用1</p></blockquote><h2 id="处理交换文件和分区"><a href="#处理交换文件和分区" class="headerlink" title="处理交换文件和分区"></a>处理交换文件和分区</h2><p>交换分区是系统RAM（内存）的补充</p><p>基本设置包括：</p><ol><li><p>创建交换分区或者文件</p></li><li><p>使用mkswap创建交换文件系统</p></li><li><p>在/etc/fstab文件中添加适当的条目</p></li></ol><p>挂载交换分区：</p><ol><li><p><code>mkswap /dev/sdb1</code>创建交换文件系统</p></li><li><p><code>swapon /dev/sdb1</code>激活新增的交换分区</p></li><li><p><code>swapon -a</code> 激活所有的交换分区</p></li><li><p><code>swapon -s</code>查看交换分区情况、数量</p></li><li><p><code>swapoff /dev/sdb1</code>禁用交换分区</p></li></ol><p><code>cat /proc/meminfo|grep &quot;SwapTotal&quot;</code> 查看交换分区大小（grep -i 不区分大小写）</p><h1 id="移动介质："><a href="#移动介质：" class="headerlink" title="移动介质："></a>移动介质：</h1><p>挂载意味着使用外来的文件系统看起来如同是主目录树的一部分</p><p>访问前、介质必须被挂载</p><p>摘除时、介质必须被卸载</p><p>按照默认位置，非根用户只能挂载某些设备（光盘、USB等等）</p><p>挂载点通常在/media或/mnt下</p><p>在图形环境下自动启动挂载/media/CentOS_6.9_Final/Packages</p><p>否则就必须被手工挂载</p><p><code>mount /dev/sr0 /media/</code></p><h1 id="常见工具"><a href="#常见工具" class="headerlink" title="常见工具"></a>常见工具</h1><p><code>free -m</code>：以MB为单位</p><p><code>free -g</code>：以GB为单位</p><p><code>df -H 设备分区</code>：以1000为单位</p><p><code>df -h 设备分区</code>：易读格式显示（以1024为单位）</p><p><code>df -T 设备分区</code>：文件系统类型</p><p><code>df -i 设备分区</code>：显示索引节点</p><p><code>du -h 目录</code>：易读格式显示</p><p><code>du -s 目录</code>：总的</p><p>dd命令：转换和复制文件</p><h2 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h2><p><code>dd if=/文件 of=/文件 bs= count=…</code></p><p><code>bs</code>：复制单元大小，默认单位是字节（例如：bs=6K）</p><p><code>count</code>：复制多少个单元（例如：count=2）</p><p><code>if=file</code>：从文件中读取内容</p><p><code>of=file</code>：写入到目标文件中</p><p><code>skip</code>：从开头忽略n个ibs大小的块（例如：skip=6 bs=3K 从开头忽略18k的数据开始复制）</p><p><code>seek</code>：从开头忽略n个obs大小的块（例如：seek=2 bs=2k 从开头忽略4K的数据开始写入）</p><p>备份MBR：<code>dd if=/dev/sda of=/tmp/mbr.bak bs=512 count=1</code></p><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p><code>dd if=/dev/sdb of=/dev/sdc</code>：将/dev/sdb整盘备份到/dev/sdc</p><p><code>dd if=/dev/sdb | gzip &gt; /path/sdb.gz</code>：读sdb全盘数据压缩到指定路径下的sdb.gz</p><p><code>dd if=/dev/mem of=/root/mem.bin bs=1024</code>：将内存里的数据拷贝到root目录下的mem.bin文件</p><p><code>dd if=/dev/sr0 of=/root/cd.iso</code>：拷贝到光盘数据到root文件夹下，并保存为cd.iso文件</p><h1 id="大于2T的磁盘分区"><a href="#大于2T的磁盘分区" class="headerlink" title="大于2T的磁盘分区"></a>大于2T的磁盘分区</h1><p>以在<code>CentOS 7.5</code>操作系统中使用<code>parted</code>分区工具将数据盘<code>/dev/vdc</code>设置为主分区（<code>yum install parted</code>），分区形式默认设置为<code>GPT</code>，文件系统设置为<code>EXT4</code>格式，挂载在<code>/data/newpart2</code>下，并设置<code>开机启动自动挂载</code>为例，不同操作系统的格式化操作可能不同，仅供参考。</p><ol><li><p>以<code>root</code>用户执行以下命令，查看磁盘名称。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回显信息类似如下图，表示当前的云服务器有两块磁盘，<code>/dev/vda</code>是系统盘，<code>/dev/vdc</code>是新增数据盘。<br><img src="/medias/img/linux/0.png"></p></li><li><p>执行以下命令，进入<code>parted</code>分区工具，开始对新增数据盘执行分区操作。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">parted</span> <span class="token operator">&lt;</span>新增数据盘<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以新挂载的数据盘<code>/dev/vdc</code>为例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">parted</span> /dev/vdc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回显信息类似如下图：<br><img src="/medias/img/linux/1.png"></p></li><li><p>输入<code>p</code>，按<code>Enter</code>，查看当前磁盘分区形式。<br>回显信息类似如下图：<br><img src="/medias/img/linux/2.png"><br>【Partition Table: unknown】表示磁盘分区形式未知。</p></li><li><p>执行以下命令，设置磁盘分区形式。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mklabel <span class="token operator">&lt;</span>磁盘分区方式<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>磁盘容量大于等于<code>2TB</code>时，只能使用<code>GPT</code>分区方式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mklabel gpt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>输入<code>p</code>，按<code>Enter</code>，查看磁盘分区形式是否设置成功。<br>回显信息类似如下图：<br><img src="/medias/img/linux/3.png"><br>【Partition Table: gpt】表示磁盘分区形式为 GPT。</p></li><li><p>输入<code>unit s</code>，按<code>Enter</code>，设置磁盘的计量单位为磁柱。</p></li><li><p>以为整个磁盘创建一个分区为例，输入<code>mkpart opt 2048s 100%</code>，按<code>Enter</code>。</p></li></ol><p><code>2048s</code>表示磁盘起始容量，<code>100%</code>表示磁盘截止容量，此处仅供参考，您可以根据业务需要自行规划磁盘分区数量及容量。<br>8. 输入p，按 Enter，查看新建分区的详细信息。</p><p>回显信息类似如下图：<br><img src="/medias/img/linux/4.png"><br>表示新建分区/dev/vdc1的详细信息。</p><ol start="9"><li><p>输入<code>q</code>，按<code>Enter</code>，退出<code>parted</code>分区工具</p></li><li><p>执行以下命令，查看磁盘名称。</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回显信息类似如下图，此时可看到新分区<code>/dev/vdc1</code>。<br><img src="/medias/img/linux/5.png"></p><ol start="11"><li><p>执行以下命令，将新建分区文件系统设置为系统所需格式。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkfs</span> <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>文件系统格式<span class="token operator">></span> /dev/vdc1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不同文件系统支持的分区大小不同，请根据实际需求合理选择文件系统。以设置文件系统为 EXT4 为例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkfs</span> <span class="token parameter variable">-t</span> ext4 /dev/vdc1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回显信息类似如下图：<br><img src="/medias/img/linux/6.png"><br>格式化需要等待一段时间，请观察系统运行状态，不要退出。</p></li><li><p>执行以下命令，新建挂载点。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token operator">&lt;</span>挂载点<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以新建挂载点/data/newpart2为例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /data/newpart2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>执行以下命令，将新建分区挂载至新建的挂载点。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> /dev/vdc1 <span class="token operator">&lt;</span>挂载点<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以新建挂载点/data/newpart2为例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> /dev/vdc1 /data/newpart2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>执行以下命令，查看挂载结果。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token parameter variable">-TH</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回显信息类似如下图：<br><img src="/medias/img/linux/7.png"><br>表示新建分区/dev/vdc1已挂载至/data/newpart2。</p></li><li><p>确认挂载方式并获取对应信息。<br>您可以根据业务需求选择使用弹性云硬盘的软链接、文件系统的<code>UUID</code>（universally unique identifier）或设备名称自动挂载磁盘，相关说明和信息获取方式如下：</p></li></ol><table><thead><tr><th align="left">挂载方式</th><th align="left">优缺点</th><th align="left">信息获取方式</th></tr></thead><tbody><tr><td align="left">使用弹性云硬盘的软链接（推荐）</td><td align="left">优点：每个弹性云硬盘的软链接固定且唯一，不会随卸载挂载、格式化分区等操作而改变。缺点：只有弹性云硬盘才有软链接。无法感知分区的格式化操作。</td><td align="left">查看弹性云硬盘的软链接。<code>ls -l /dev/disk/by-id</code></td></tr><tr><td align="left">使用文件系统的 UUID</td><td align="left">可能会因文件系统的 UUID 变化而导致自动挂载设置失效。例如，重新格式化文件系统后，文件系统的 UUID 将会发生变化。</td><td align="left">查看文件系统的 UUID。<code>blkid /dev/vdc1</code></td></tr><tr><td align="left">使用设备名称</td><td align="left">可能会因设备名称变化而导致自动挂载设置失效。例如，迁移数据时将云服务器上的弹性云硬盘卸载后再次挂载，操作系统再次识别到该文件系统时，名称可能会变化。</td><td align="left">查看设备名称。<code>fdisk -l</code></td></tr></tbody></table><ol start="16"><li><p>执行以下命令，备份<code>/etc/fstab</code>文件。以备份到<code>/home</code>目录下为例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> <span class="token parameter variable">-r</span> /etc/fstab /home<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>执行以下命令，使用<code>VI</code>编辑器打开<code>/etc/fstab</code>文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>按<code>i</code>，进入编辑模式。</p></li><li><p>将<code>光标移至文件末尾</code>，按<code>Enter</code>，添加如下内容。</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>设备信息<span class="token operator">></span> <span class="token operator">&lt;</span>挂载点<span class="token operator">></span> <span class="token operator">&lt;</span>文件系统格式<span class="token operator">></span> <span class="token operator">&lt;</span>文件系统安装选项<span class="token operator">></span> <span class="token operator">&lt;</span>文件系统转储频率<span class="token operator">></span> <span class="token operator">&lt;</span>启动时的文件系统检查顺序<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>（推荐）以使用弹性云硬盘的软链接自动挂载为例，结合前文示例则添加：<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/dev/disk/by-id/virtio-disk-bm42ztpm-part1 /data/newpart2   ext4 defaults     <span class="token number">0</span>   <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>以使用磁盘分区的 UUID 自动挂载为例，结合前文示例则添加：<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">UUID</span><span class="token operator">=</span>fc3f42cc-2093-49c7-b4fd-c616ba6165f4 /data/newpart2   ext4 defaults     <span class="token number">0</span>   <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>以使用设备名称自动挂载为例，结合前文示例则添加：<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/dev/vdc1 /data/newpart2   ext4 defaults     <span class="token number">0</span>   <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ol start="20"><li>按<code>Esc</code>，输入<code>:wq</code>，按<code>Enter</code>。<br>保存设置并退出编辑器。</li><li>执行以下命令，检查<code>/etc/fstab</code>文件是否写入成功。<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> <span class="token parameter variable">-a</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>如果运行通过则说明文件写入成功，新建的文件系统会在操作系统启动时自动挂载。</li></ol><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/edquota">磁盘配额edquota</a><br><a href="../linux-command-1.16.0/quota">磁盘配额quota</a><br><a href="../linux-command-1.16.0/fdisk">磁盘分区fdisk</a><br><a href="../linux-command-1.16.0/parted">磁盘分区parted</a><br><a href="../linux-command-1.16.0/partprobe">重载分区</a><br><a href="../linux-command-1.16.0/pvcreate">pvcreate</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pod</title>
      <link href="/posts/30a636b.html"/>
      <url>/posts/30a636b.html</url>
      
        <content type="html"><![CDATA[<p>声明：本地镜像仓库<code>192.168.1.40 docker.registry.com</code>，k8s集群<code>192.168.1.15&#123;0,1,2&#125;</code></p><h1 id="创建pod"><a href="#创建pod" class="headerlink" title="创建pod"></a>创建pod</h1><p>在生产环境中，推荐使用诸如Deployment，StatefulSet，Job或者CronJob等控制器来创建Pod，而不是直接创建。</p><h2 id="Deployment-模板"><a href="#Deployment-模板" class="headerlink" title="Deployment 模板"></a>Deployment 模板</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl explain deployment.spec.template   <span class="token comment"># 其它模板：job.spec.template/statefulset.spec.template/daemonset.spec.template</span>KIND:     DeploymentVERSION:  apps/v1RESOURCE: template <span class="token operator">&lt;</span>Object<span class="token operator">></span>DESCRIPTION:     Template describes the pods that will be created.     PodTemplateSpec describes the data a pod should have when created from a     templateFIELDS:   metadata    <span class="token operator">&lt;</span>Object<span class="token operator">></span>     Standard object's metadata. More info:     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#metadata</span>   spec    <span class="token operator">&lt;</span>Object<span class="token operator">></span>     Specification of the desired behavior of the pod. More info:     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#spec-and-status</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="通过Dockerfile创建镜像"><a href="#通过Dockerfile创建镜像" class="headerlink" title="通过Dockerfile创建镜像"></a>通过Dockerfile创建镜像</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> mail.dockerfile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFFROM openjdk:8-jre-alpineMAINTAINER wangjunCOPY mail-demo-0.0.1-SNAPSHOT.jar /app.jarCMD java -jar /app.jarEXPOSE 8085EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="创建镜像，上传到本地镜像库"><a href="#创建镜像，上传到本地镜像库" class="headerlink" title="创建镜像，上传到本地镜像库"></a>创建镜像，上传到本地镜像库</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> mail.dockerfile <span class="token parameter variable">-t</span> maildemo <span class="token builtin class-name">.</span><span class="token function">docker</span> tag maildemo docker.registry.com/maildemo<span class="token function">docker</span> push docker.registry.com/maildemo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="通过yaml文件创建pod"><a href="#通过yaml文件创建pod" class="headerlink" title="通过yaml文件创建pod"></a>通过yaml文件创建pod</h1><p>mail-pod.yaml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> maildemo<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> maildemo<span class="token punctuation">-</span>pod  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> maildemo<span class="token punctuation">-</span>pod    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> maildemo        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.registry.com/maildemo        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8085</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="通过yaml文件创建svc-service"><a href="#通过yaml文件创建svc-service" class="headerlink" title="通过yaml文件创建svc(service)"></a>通过yaml文件创建<code>svc</code>(service)</h1><p>mailsvc.yaml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> maildemo<span class="token punctuation">-</span>svc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> maildemo<span class="token punctuation">-</span>pod  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8085</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31000</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none"># nodePort　外部机器可访问的端口。比如一个Web应用需要被其他用户访问，那么需要配置type&#x3D;NodePort，而且配置nodePort&#x3D;30001，那么其他机器就可以通过浏览器访问scheme:&#x2F;&#x2F;node:30001访问到该服务，例如http:&#x2F;&#x2F;node:30001。　例如MySQL数据库可能不需要被外界访问，只需被内部服务访问，那么不必设置NodePort# targetPort　容器的端口（最根本的端口入口），与制作容器时暴露的端口一致（DockerFile中EXPOSE），例如docker.io官方的nginx暴露的是80端口。　docker.io官方的nginx容器的DockerFile参考https:&#x2F;&#x2F;github.com&#x2F;nginxinc&#x2F;docker-nginx# port　kubernetes中的服务之间访问的端口，尽管mysql容器暴露了3306端口（参考https:&#x2F;&#x2F;github.com&#x2F;docker-library&#x2F;mysql&#x2F;的DockerFile），但是集群内其他容器需要通过33306端口访问该服务，外部机器不能访问mysql服务，因为他没有配置NodePort类型---分割线---NodePort 服务主要有两点区别于普通的&quot;ClusterIP&quot;服务。第一，它的类型是&quot;NodePort&quot;。有一个额外的端口，称为 nodePort，它指定节点上开放的端口值 。如果你不指定这个端口，系统将选择一个随机端口。大多数时候我们应该让 Kubernetes 来选择端口，用户自己来选择可用端口代价太大。这种方法有许多缺点：1.每个端口只能是一种服务2.端口范围只能是 30000-327673.如果节点&#x2F;VM 的 IP 地址发生变化，你需要能处理这种情况基于以上原因，不建议在生产环境上用这种方式暴露服务。如果运行的服务不要求一直可用，或者对成本比较敏感，你可以使用这种方法。这样的应用的最佳例子是 demo 应用，或者某些临时应用。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="通过yaml文件创建pod和service"><a href="#通过yaml文件创建pod和service" class="headerlink" title="通过yaml文件创建pod和service"></a>通过yaml文件创建pod和service</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> mail-pod.yamlkubectl apply <span class="token parameter variable">-f</span> mailsvc.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="删除pod和service"><a href="#删除pod和service" class="headerlink" title="删除pod和service"></a>删除pod和service</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get podkubectl delete pod maildemo-pod-6b68c9c9b8-7svd9kubectl delete pod maildemo-pod-6b68c9c9b8-48mjzkubectl get deploymentkubectl delete deployment maildemo-podkubectl get svckubectl delete svc maildemo-podkubectl delete svc maildemo-svc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装</title>
      <link href="/posts/1704ea49.html"/>
      <url>/posts/1704ea49.html</url>
      
        <content type="html"><![CDATA[<h1 id="准备3台机器最小2C4G"><a href="#准备3台机器最小2C4G" class="headerlink" title="准备3台机器最小2C4G"></a>准备3台机器最小2C4G</h1><p>资源不够报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks    <span class="token punctuation">[</span>WARNING IsDockerSystemdCheck<span class="token punctuation">]</span>: detected <span class="token string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="token string">"systemd"</span><span class="token builtin class-name">.</span> Please follow the guide at https://kubernetes.io/docs/setup/cri/error execution phase preflight: <span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Some fatal errors occurred:    <span class="token punctuation">[</span>ERROR NumCPU<span class="token punctuation">]</span>: the number of available CPUs <span class="token number">1</span> is <span class="token function">less</span> than the required <span class="token number">2</span><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> If you know what you are doing, you can <span class="token function">make</span> a check non-fatal with <span class="token variable"><span class="token variable">`</span>--ignore-preflight-errors<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token variable">`</span></span>To see the stack trace of this error execute with <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">5</span> or higher---<span class="token comment"># 调整CPU核心数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="修改主机名："><a href="#修改主机名：" class="headerlink" title="修改主机名："></a>修改主机名：</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hostnamectl set-hostname k8s-master   <span class="token comment"># master节点</span>hostnamectl set-hostname k8s-node1   <span class="token comment"># node1节点</span>hostnamectl set-hostname k8s-node2   <span class="token comment"># node2节点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="基本配置："><a href="#基本配置：" class="headerlink" title="基本配置："></a>基本配置：</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改/etc/hosts文件</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF192.168.1.150 k8s-master192.168.1.151 k8s-node1192.168.1.152 k8s-node2192.168.1.40 docker.registry.comEOF</span><span class="token comment"># 关闭防火墙和selinux</span>systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span> /etc/selinux/config <span class="token operator">&amp;&amp;</span> setenforce <span class="token number">0</span><span class="token comment"># 关闭swap</span>swapoff <span class="token parameter variable">-a</span><span class="token function">yes</span> <span class="token operator">|</span> <span class="token function">cp</span> /etc/fstab /etc/fstab_bak<span class="token function">cat</span> /etc/fstab_bak <span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> swap <span class="token operator">></span> /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h1><p>使用chrony同步时间，配置master节点与网络NTP服务器同步时间，所有node节点与master节点同步时间。</p><h1 id="配置master节点："><a href="#配置master节点：" class="headerlink" title="配置master节点："></a>配置master节点：</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装chrony：</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> chrony<span class="token comment"># 注释默认ntp服务器</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^server/#&amp;/'</span> /etc/chrony.conf<span class="token comment"># 指定上游公共 ntp 服务器，并允许其他节点同步时间</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOFserver ntp1.aliyun.com iburstserver ns.cn.net iburstallow allEOF</span><span class="token comment"># 重启chronyd服务并设为开机启动：</span>systemctl <span class="token builtin class-name">enable</span> chronyd <span class="token operator">&amp;&amp;</span> systemctl restart chronyd<span class="token comment"># 开启网络时间同步功能</span>timedatectl set-ntp <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="配置node节点："><a href="#配置node节点：" class="headerlink" title="配置node节点："></a>配置node节点：</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装chrony：</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> chrony<span class="token comment"># 注释默认服务器</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^server/#&amp;/'</span> /etc/chrony.conf<span class="token comment"># 指定内网 master 节点为上游NTP服务器</span><span class="token builtin class-name">echo</span> server <span class="token number">192.168</span>.1.150 iburst <span class="token operator">>></span> /etc/chrony.conf<span class="token comment"># 重启服务并设为开机启动：</span>systemctl <span class="token builtin class-name">enable</span> chronyd <span class="token operator">&amp;&amp;</span> systemctl restart chronyd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="修改iptables相关参数"><a href="#修改iptables相关参数" class="headerlink" title="修改iptables相关参数"></a>修改iptables相关参数</h1><p>RHEL / CentOS 7上的一些用户报告了由于iptables被绕过而导致流量路由不正确的问题。创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span>  /etc/sysctl.d/k8s.conf</span>vm.swappiness = 0net.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF</span><span class="token comment"># 使配置生效</span>modprobe br_netfilter<span class="token function">sysctl</span> <span class="token parameter variable">-p</span> /etc/sysctl.d/k8s.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="加载ipvs相关模块"><a href="#加载ipvs相关模块" class="headerlink" title="加载ipvs相关模块"></a>加载ipvs相关模块</h1><p>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：<br>在所有的Kubernetes节点执行以下脚本:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&lt;&lt;</span><span class="token string">EOF#!/bin/bashmodprobe -- ip_vsmodprobe -- ip_vs_rrmodprobe -- ip_vs_wrrmodprobe -- ip_vs_shmodprobe -- nf_conntrack_ipv4EOF</span><span class="token comment"># 执行脚本</span><span class="token function">chmod</span> <span class="token number">755</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack_ipv4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面脚本创建了/etc/sysconfig/modules/ipvs.modules文件，保证在节点重启后能自动加载所需模块。 使用lsmod | grep -e ip_vs -e nf_conntrack_ipv4命令查看是否已经正确加载所需的内核模块。</p><p>接下来还需要确保各个节点上已经安装了ipset软件包。 为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm。</p><p><code>yum install ipset ipvsadm -y</code></p><h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><p>Kubernetes默认的容器运行时仍然是Docker，使用的是kubelet中内置dockershim CRI实现。需要注意的是，Kubernetes 1.13最低支持的Docker版本是1.11.1，最高支持是18.06，而Docker最新版本已经是18.09了，故我们安装时需要指定版本为18.06.1-ce。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置docker yum源</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utilsyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoyum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'&#123;  "registry-mirrors": ["https://******.mirror.aliyuncs.com"],  "exec-opts":["native.cgroupdriver=systemd"],  "insecure-registries": ["docker.registry.com"]&#125;EOF</span>systemctl daemon-reloadsystemctl start <span class="token function">docker</span>systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]</code>解决(可以不必管它)：</p><p><code>[WARNING IsDockerSystemdCheck]: detected &quot;cgroupfs&quot; as the Docker cgroup driver. The recommended driver is &quot;systemd&quot;.</code></p><p><code>&quot;insecure-registries&quot;: [&quot;docker.registry.com&quot;]</code>是本地私有镜像地址</p><p><code>&quot;registry-mirrors&quot;: [&quot;https://******.mirror.aliyuncs.com&quot;]</code>是阿里云的镜像加速服务</p><h1 id="安装kubeadm、kubelet、kubectl"><a href="#安装kubeadm、kubelet、kubectl" class="headerlink" title="安装kubeadm、kubelet、kubectl"></a>安装kubeadm、kubelet、kubectl</h1><ul><li><p>kubelet 在群集中所有节点上运行的核心组件, 用来执行如启动pods和containers等操作。</p></li><li><p>ubeadm 引导启动k8s集群的命令行工具，用于初始化 Cluster。</p></li><li><p>kubectl 是 Kubernetes 命令行工具。通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件。</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置kubernetes.repo的源，由于官方源国内无法访问，这里使用阿里云yum源</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span>[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF</span><span class="token comment"># 在所有节点上安装 kubelet、kubeadm 和 kubectl</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl<span class="token comment"># 启动kubelet服务</span>systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h1><h2 id="Master节点执行初始化："><a href="#Master节点执行初始化：" class="headerlink" title="Master节点执行初始化："></a>Master节点执行初始化：</h2><p>注意这里执行初始化用到了–image-repository选项，指定初始化需要的镜像源从阿里云镜像仓库拉取。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeadm init <span class="token punctuation">\</span>    --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.150 <span class="token punctuation">\</span>    --image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>    --kubernetes-version v1.18.3 <span class="token punctuation">\</span>    --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>初始化命令说明：</p><pre class="line-numbers language-none"><code class="language-none">--apiserver-advertise-address指明用 Master 的哪个 interface 与 Cluster 的其他节点通信。如果 Master 有多个 interface，建议明确指定，如果不指定，kubeadm 会自动选择有默认网关的 interface。--pod-network-cidr指定 Pod 网络的范围。Kubernetes 支持多种网络方案，而且不同网络方案对 --pod-network-cidr 有自己的要求，这里设置为 10.244.0.0&#x2F;16 是因为我们将使用 flannel 网络方案，必须设置成这个 CIDR。--image-repositoryKubenetes默认Registries地址是 k8s.gcr.io，在国内并不能访问 gcr.io，在1.13版本中我们可以增加–image-repository参数，默认值是 k8s.gcr.io，将其指定为阿里云镜像地址：registry.aliyuncs.com&#x2F;google_containers。--kubernetes-version&#x3D;v1.18.3关闭版本探测，因为它的默认值是stable-1，会导致从https:&#x2F;&#x2F;dl.k8s.io&#x2F;release&#x2F;stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（截至2020.06.28最新版：v1.18.3）来跳过网络请求。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>(注意记录下初始化结果中的kubeadm join命令，部署worker节点时会用到)</strong></em></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.1.150:6443 <span class="token parameter variable">--token</span> snllb2.u0jdzy8295owjg8s <span class="token punctuation">\</span>    --discovery-token-ca-cert-hash sha256:1dbb688b15c24740b288d300a5b2934828462f85f15599e047a7b5d91f0a4e1e <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>初始化过程说明：</p></blockquote><pre class="line-numbers language-none"><code class="language-none">[preflight] kubeadm 执行初始化前的检查。[kubelet-start] 生成kubelet的配置文件&quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml&quot;[certificates] 生成相关的各种token和证书[kubeconfig] 生成 KubeConfig 文件，kubelet 需要这个文件与 Master 通信[control-plane] 安装 Master 组件，会从指定的 Registry 下载组件的 Docker 镜像。[bootstraptoken] 生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到[addons] 安装附加组件 kube-proxy 和 kube-dns。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Kubernetes Master 初始化成功，提示如何配置常规用户使用kubectl访问集群。</p><p>提示如何安装 Pod 网络。</p><p>提示如何注册其他节点到 Cluster。</p><h2 id="配置-kubectl"><a href="#配置-kubectl" class="headerlink" title="配置 kubectl"></a>配置 kubectl</h2><p>kubectl 是管理 Kubernetes Cluster 的命令行工具，前面我们已经在所有的节点安装了 kubectl。Master 初始化完成后需要做一些配置工作，然后 kubectl 就能使用了。</p><p>依照 kubeadm init 输出的最后提示，推荐用 Linux 普通用户执行 kubectl。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建普通用户并设置密码123456</span><span class="token function">useradd</span> centos <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"centos:123456"</span> <span class="token operator">|</span> chpasswd centos<span class="token comment"># 追加sudo权限,并配置sudo免密</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^root/a\centos  ALL=(ALL)       NOPASSWD:ALL'</span> /etc/sudoers<span class="token comment"># 保存集群安全配置文件到当前用户.kube目录</span><span class="token function">su</span> - centos<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config<span class="token comment"># 启用 kubectl 命令自动补全功能（注销重新登录生效）</span><span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要这些配置命令的原因是：Kubernetes 集群默认需要加密方式访问。所以，这几条命令，就是将刚刚部署生成的 Kubernetes 集群的安全配置文件，保存到当前用户的.kube 目录下，kubectl 默认会使用这个目录下的授权信息访问 Kubernetes 集群。</p><p>如果不这么做的话，我们每次都需要通过 export KUBECONFIG 环境变量告诉 kubectl 这个安全配置文件的位置。</p><p>配置完成后centos用户就可以使用 kubectl 命令管理集群了。</p><p>查看集群状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get csNAME                 STATUS      MESSAGE                                                                                     ERRORscheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp <span class="token number">127.0</span>.0.1:10251: connect: connection refused controller-manager   Healthy     ok                                                                                        etcd-0               Healthy     <span class="token punctuation">&#123;</span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span>                                                                         <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>确认各个组件都处于healthy状态。</p><p>查看节点状态</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get <span class="token function">node</span>NAME         STATUS     ROLES    AGE    VERSIONk8s-master   NotReady   master   105s   v1.18.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到，当前只存在1个master节点，并且这个节点的状态是 NotReady。</p><p>使用 kubectl describe 命令来查看这个节点（Node）对象的详细信息、状态和事件（Event）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl describe <span class="token function">node</span> k8s-master<span class="token punctuation">..</span>.Events:  Type    Reason                   Age                    From                 Message  ----    ------                   ----                   ----                 -------  Normal  NodeHasNoDiskPressure    2m50s <span class="token punctuation">(</span>x4 over 2m51s<span class="token punctuation">)</span>  kubelet, k8s-master  Node k8s-master status is now: NodeHasNoDiskPressure  Normal  NodeHasSufficientPID     2m50s <span class="token punctuation">(</span>x4 over 2m51s<span class="token punctuation">)</span>  kubelet, k8s-master  Node k8s-master status is now: NodeHasSufficientPID  Normal  NodeHasSufficientMemory  2m49s <span class="token punctuation">(</span>x5 over 2m51s<span class="token punctuation">)</span>  kubelet, k8s-master  Node k8s-master status is now: NodeHasSufficientMemory  Normal  Starting                 102s                   kubelet, k8s-master  Starting kubelet.  Normal  NodeHasSufficientMemory  97s                    kubelet, k8s-master  Node k8s-master status is now: NodeHasSufficientMemory  Normal  NodeHasNoDiskPressure    97s                    kubelet, k8s-master  Node k8s-master status is now: NodeHasNoDiskPressure  Normal  NodeHasSufficientPID     97s                    kubelet, k8s-master  Node k8s-master status is now: NodeHasSufficientPID  Normal  NodeAllocatableEnforced  96s                    kubelet, k8s-master  Updated Node Allocatable limit across pods<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 kubectl describe 指令的输出，我们可以看到 NodeNotReady 的原因在于，我们尚未部署任何网络插件，kube-proxy等组件还处于starting状态。</p><p>另外，我们还可以通过 kubectl 检查这个节点上各个系统 Pod 的状态，其中，kube-system 是 Kubernetes 项目预留的系统 Pod 的工作空间（Namepsace，注意它并不是 Linux Namespace，它只是 Kubernetes 划分不同工作空间的单位）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> wideNAME                                 READY   STATUS    RESTARTS   AGE    IP              NODE         NOMINATED NODE   READINESS GATEScoredns-7ff77c879f-5kmsp             <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          58s    <span class="token operator">&lt;</span>none<span class="token operator">></span>          <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>coredns-7ff77c879f-z5v6h             <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          58s    <span class="token operator">&lt;</span>none<span class="token operator">></span>          <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>etcd-k8s-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-apiserver-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-controller-manager-k8s-master   <span class="token number">1</span>/1     Running   <span class="token number">1</span>          101s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-proxy-nsj4g                     <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          58s    <span class="token operator">&lt;</span>none<span class="token operator">></span>          <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-scheduler-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，CoreDNS依赖于网络的 Pod 都处于 Pending 状态，即调度失败。这当然是符合预期的：因为这个 Master 节点的网络尚未就绪。</p><p>集群初始化如果遇到问题，可以使用kubeadm reset命令进行清理然后重新执行初始化。</p><p>部署网络插件</p><p>要让 Kubernetes Cluster 能够工作，必须安装 Pod 网络，否则 Pod 之间无法通信。</p><p>Kubernetes 支持多种网络方案，这里我们使用 flannel</p><p>执行如下命令部署 flannel：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlThe connection to the server raw.githubusercontent.com was refused - did you specify the right <span class="token function">host</span> or port?<span class="token comment"># 报错了，你可以使用wget下载，或者访问访问网页把kube-flannel.yml文件内容复制出来</span><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl apply <span class="token parameter variable">-f</span> kube-flannel.yml podsecuritypolicy.policy/psp.flannel.unprivileged createdclusterrole.rbac.authorization.k8s.io/flannel configuredclusterrolebinding.rbac.authorization.k8s.io/flannel unchangedserviceaccount/flannel unchangedconfigmap/kube-flannel-cfg configureddaemonset.apps/kube-flannel-ds-amd64 createddaemonset.apps/kube-flannel-ds-arm64 createddaemonset.apps/kube-flannel-ds-arm createddaemonset.apps/kube-flannel-ds-ppc64le createddaemonset.apps/kube-flannel-ds-s390x created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>部署完成后，我们可以通过 kubectl get 重新检查 Pod 的状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> wideNAME                                 READY   STATUS     RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATEScoredns-7ff77c879f-5kmsp             <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          16m   <span class="token operator">&lt;</span>none<span class="token operator">></span>          <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>coredns-7ff77c879f-z5v6h             <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          16m   <span class="token operator">&lt;</span>none<span class="token operator">></span>          <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>etcd-k8s-master                      <span class="token number">1</span>/1     Running    <span class="token number">0</span>          17m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-apiserver-k8s-master            <span class="token number">1</span>/1     Running    <span class="token number">0</span>          17m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-controller-manager-k8s-master   <span class="token number">1</span>/1     Running    <span class="token number">1</span>          17m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-flannel-ds-amd64-vn6sj          <span class="token number">0</span>/1     Init:0/1   <span class="token number">0</span>          15s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-proxy-nsj4g                     <span class="token number">1</span>/1     Running    <span class="token number">0</span>          16m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-scheduler-k8s-master            <span class="token number">1</span>/1     Running    <span class="token number">1</span>          17m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，所有的系统 Pod 都成功启动了，而刚刚部署的flannel网络插件则在 kube-system 下面新建了一个名叫kube-flannel-ds-amd64-vn6sj的 Pod，一般来说，这些 Pod 就是容器网络插件在每个节点上的控制组件。</p><p>Kubernetes 支持容器网络插件，使用的是一个名叫 CNI 的通用接口，它也是当前容器网络的事实标准，市面上的所有容器网络开源项目都可以通过 CNI 接入 Kubernetes，比如 Flannel、Calico、Canal、Romana 等等，它们的部署方式也都是类似的”一键部署”。</p><p>大概等待2分钟，再次查看master节点状态已经为ready状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get nodesNAME         STATUS   ROLES    AGE   VERSIONk8s-master   Ready    master   86m   v1.18.5<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get csNAME                 STATUS    MESSAGE             ERRORcontroller-manager   Healthy   ok                scheduler            Healthy   ok                etcd-0               Healthy   <span class="token punctuation">&#123;</span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> wideNAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATEScoredns-7ff77c879f-5kmsp             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20m     <span class="token number">10.244</span>.0.2      k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>coredns-7ff77c879f-z5v6h             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20m     <span class="token number">10.244</span>.0.3      k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>etcd-k8s-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-apiserver-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-controller-manager-k8s-master   <span class="token number">1</span>/1     Running   <span class="token number">1</span>          21m     <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-flannel-ds-amd64-vn6sj          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m24s   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-proxy-nsj4g                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20m     <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-scheduler-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          21m     <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，Kubernetes 的 Master 节点就部署完成了。如果你只需要一个单节点的 Kubernetes，现在你就可以使用了。不过，在默认情况下，Kubernetes 的 Master 节点是不能运行用户 Pod 的。 </p><h1 id="部署worker节点"><a href="#部署worker节点" class="headerlink" title="部署worker节点"></a>部署worker节点</h1><p>Kubernetes 的 Worker 节点跟 Master 节点几乎是相同的，它们运行着的都是一个 kubelet 组件。唯一的区别在于，在 kubeadm init 的过程中，kubelet 启动后，Master 节点上还会自动运行 kube-apiserver、kube-scheduler、kube-controller-manger 这三个系统 Pod。</p><p>在 k8s-node1 和 k8s-node2 上分别执行如下命令，将其注册到 Cluster 中：</p><p>执行以下命令将节点接入集群</p><p><code>kubeadm join 192.168.1.150:6443 --token snllb2.u0jdzy8295owjg8s --discovery-token-ca-cert-hash sha256:1dbb688b15c24740b288d300a5b2934828462f85f15599e047a7b5d91f0a4e1e</code></p><p>如果执行kubeadm init时没有记录下加入集群的命令，可以通过以下命令重新创建</p><p><code>kubeadm token create --print-join-command</code></p><p>在k8s-node1上执行kubeadm join ：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 192.168.1.150:6443 --token snllb2.u0jdzy8295owjg8s --discovery-token-ca-cert-hash sha256:1dbb688b15c24740b288d300a5b2934828462f85f15599e047a7b5d91f0a4e1e </span>W0628 <span class="token number">13</span>:05:26.974118   <span class="token number">17888</span> join.go:346<span class="token punctuation">]</span> <span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Downloading configuration <span class="token keyword">for</span> the kubelet from the <span class="token string">"kubelet-config-1.18"</span> ConfigMap <span class="token keyword">in</span> the kube-system namespace<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/config.yaml"</span><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/kubeadm-flags.env"</span><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to perform the TLS Bootstrap<span class="token punctuation">..</span>.This <span class="token function">node</span> has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this <span class="token function">node</span> <span class="token function">join</span> the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重复执行以上操作将k8s-node2也加进去（注意重新执行kubeadm token create –print-join-command）。</p><p>然后根据提示，我们可以通过 kubectl get nodes 查看节点的状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get nodesNAME         STATUS     ROLES    AGE   VERSIONk8s-master   Ready      master   87m   v1.18.5k8s-node1    NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   33s   v1.18.5k8s-node2    NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   29s   v1.18.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>nodes状态全部为ready，由于每个节点都需要启动若干组件，如果node节点的状态是 NotReady，可以查看所有节点pod状态，确保所有pod成功拉取到镜像并处于running状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod --all-namespaces <span class="token parameter variable">-o</span> wideNAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATESkube-system   coredns-7ff77c879f-5kmsp             <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3h11m   <span class="token number">10.244</span>.0.4      k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   coredns-7ff77c879f-z5v6h             <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3h11m   <span class="token number">10.244</span>.0.5      k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   etcd-k8s-master                      <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3h11m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-apiserver-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3h11m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-controller-manager-k8s-master   <span class="token number">1</span>/1     Running   <span class="token number">2</span>          3h11m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-flannel-ds-amd64-22jwb          <span class="token number">1</span>/1     Running   <span class="token number">2</span>          105m    <span class="token number">192.168</span>.1.151   k8s-node1    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-flannel-ds-amd64-vn6sj          <span class="token number">1</span>/1     Running   <span class="token number">1</span>          174m    <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-flannel-ds-amd64-vtdqd          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          105m    <span class="token number">192.168</span>.1.152   k8s-node2    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-proxy-gb7qj                     <span class="token number">1</span>/1     Running   <span class="token number">1</span>          105m    <span class="token number">192.168</span>.1.151   k8s-node1    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-proxy-kfnmb                     <span class="token number">1</span>/1     Running   <span class="token number">1</span>          105m    <span class="token number">192.168</span>.1.152   k8s-node2    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-proxy-nsj4g                     <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3h11m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>kube-system   kube-scheduler-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">2</span>          3h11m   <span class="token number">192.168</span>.1.150   k8s-master   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时，所有的节点都已经 Ready，Kubernetes Cluster 创建成功，一切准备就绪。</p><p>如果pod状态为Pending、ContainerCreating、ImagePullBackOff 都表明 Pod 没有就绪，Running 才是就绪状态。</p><p>如果有pod提示Init:ImagePullBackOff，说明这个pod的镜像在对应节点上拉取失败，我们可以通过 kubectl describe pod 查看 Pod 具体情况，以确认拉取失败的镜像：</p><p><code>kubectl describe pod 坏掉的pod名 --namespace=kube-system</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl describe pod kube-flannel-ds-amd64-vtdqd <span class="token parameter variable">--namespace</span><span class="token operator">=</span>kube-system<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>Events:  Type     Reason     Age                 From                Message  ----     ------     ----                ----                -------  Normal   Scheduled  2m14s               default-scheduler   Successfully assigned kube-system/kube-flannel-ds-amd64-lzx5v to k8s-node2  Warning  Failed     109s                kubelet, k8s-node2  Failed to pull image <span class="token string">"quay.io/coreos/flannel:v0.12.0-amd64"</span><span class="token builtin class-name">:</span> rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> Error response from daemon: Get https://quay.io/v2/: net/http: TLS handshake <span class="token function">timeout</span>  Warning  Failed     109s                kubelet, k8s-node2  Error: ErrImagePull  Normal   BackOff    108s                kubelet, k8s-node2  Back-off pulling image <span class="token string">"quay.io/coreos/flannel:v0.12.0-amd64"</span>  Warning  Failed     108s                kubelet, k8s-node2  Error: ImagePullBackOff  Normal   Pulling    94s <span class="token punctuation">(</span>x2 over 2m6s<span class="token punctuation">)</span>  kubelet, k8s-node2  pulling image <span class="token string">"quay.io/coreos/flannel:v0.12.0-amd64"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里看最后events输出内容，可以看到在下载 image 时失败，如果网络质量不好，这种情况是很常见的。我们可以耐心等待，因为 Kubernetes 会重试，我们也可以自己手工执行 docker pull 去下载这个镜像。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># docker pull quay.io/coreos/flannel:v0.12.0-amd64</span>v0.12.0-amd64: Pulling from coreos/flannelff3a5c916c92: Already exists8a8433d1d437: Already exists306dc0ee491a: Already exists856cbd0b7b9c: Already existsaf6d1e4decc6: Already existsDigest: sha256:88f2b4d96fae34bfff3d46293f7f18d1f9f3ca026b4a4d288f28347fcb6580acStatus: Image is up to <span class="token function">date</span> <span class="token keyword">for</span> quay.io/coreos/flannel:v0.12.0-amd64<span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果无法从 quay.io/coreos/flannel:v0.12.0-amd64 下载镜像，可以从阿里云或者dockerhub镜像仓库下载，然后改回原来的tag即可：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.12.0-amd64<span class="token function">docker</span> tag registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.12.0-amd64 quay.io/coreos/flannel:v0.12.0-amd64<span class="token function">docker</span> rmi registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.12.0-amd64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>查看master节点下载了哪些镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">docker</span> imagesREPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZEregistry.aliyuncs.com/google_containers/kube-proxy                v1.18.3             3439b7546f29        <span class="token number">5</span> weeks ago         117MBregistry.aliyuncs.com/google_containers/kube-scheduler            v1.18.3             76216c34ed0c        <span class="token number">5</span> weeks ago         <span class="token number">95</span>.3MBregistry.aliyuncs.com/google_containers/kube-apiserver            v1.18.3             7e28efa976bd        <span class="token number">5</span> weeks ago         173MBregistry.aliyuncs.com/google_containers/kube-controller-manager   v1.18.3             da26705ccb4b        <span class="token number">5</span> weeks ago         162MBquay.io/coreos/flannel                                            v0.12.0-amd64       4e9f801d2217        <span class="token number">3</span> months ago        <span class="token number">52</span>.8MBregistry.aliyuncs.com/google_containers/pause                     <span class="token number">3.2</span>                 80d28bedfe5d        <span class="token number">4</span> months ago        683kBregistry.aliyuncs.com/google_containers/coredns                   <span class="token number">1.6</span>.7               67da37a9a360        <span class="token number">5</span> months ago        <span class="token number">43</span>.8MBregistry.aliyuncs.com/google_containers/etcd                      <span class="token number">3.4</span>.3-0             303ce5db0e90        <span class="token number">8</span> months ago        288MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看node节点下载了哪些镜像：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>REPOSITORY                                           TAG                 IMAGE ID            CREATED             SIZEregistry.aliyuncs.com/google_containers/kube-proxy   v1.18.3             3439b7546f29        <span class="token number">5</span> weeks ago         117MBquay.io/coreos/flannel                               v0.12.0-amd64       4e9f801d2217        <span class="token number">3</span> months ago        <span class="token number">52</span>.8MBregistry.aliyuncs.com/google_containers/pause        <span class="token number">3.2</span>                 80d28bedfe5d        <span class="token number">4</span> months ago        683kB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试集群各个组件"><a href="#测试集群各个组件" class="headerlink" title="测试集群各个组件"></a>测试集群各个组件</h2><p>首先验证kube-apiserver, kube-controller-manager, kube-scheduler, pod network 是否正常：</p><p>部署一个 Nginx Deployment，包含2个Pod</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl create deployment nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:alpinedeployment.apps/nginx created<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl scale deployment nginx <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">2</span>deployment.apps/nginx scaled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>验证Nginx Pod是否正确运行，并且会分配10.244.开头的集群IP</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx <span class="token parameter variable">-o</span> wideNAME                     READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATESnginx-745b4df97d-cgdlt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          50s   <span class="token number">10.244</span>.2.2   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>nginx-745b4df97d-qn6rm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          40s   <span class="token number">10.244</span>.1.2   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>再验证一下kube-proxy是否正常：</p><p>以 NodePort 方式对外提供服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl expose deployment nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePortservice/nginx exposed<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get services nginxNAME    TYPE       CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGEnginx   NodePort   <span class="token number">10.99</span>.83.4   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30507/TCP   8s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以通过任意 NodeIP:Port 在集群外部访问这个服务：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">192.168</span>.1.150:30507<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">192.168</span>.1.151:30507<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">192.168</span>.1.152:30507<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>最后验证一下dns, pod network是否正常：</p><p>运行Busybox并进入交互模式</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl run <span class="token parameter variable">-it</span> <span class="token function">curl</span> <span class="token parameter variable">--image</span><span class="token operator">=</span>radial/busyboxplus:curlIf you don't see a <span class="token builtin class-name">command</span> prompt, try pressing enter.<span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>输入nslookup nginx查看是否可以正确解析出集群内的IP，以验证DNS是否正常</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">nslookup</span> nginxServer:    <span class="token number">10.96</span>.0.10Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.localName:      nginxAddress <span class="token number">1</span>: <span class="token number">10.99</span>.83.4 nginx.default.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过服务名进行访问，验证kube-proxy是否正常</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">curl</span> http://nginx/<span class="token punctuation">..</span>.<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>分别访问一下2个Pod的内网IP，验证跨Node的网络通信是否正常</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">10.244</span>.1.2<span class="token punctuation">..</span>.<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token punctuation">..</span>.<span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">10.244</span>.2.2<span class="token punctuation">..</span>.<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token punctuation">..</span>.<span class="token comment"># 退出pod</span>Ctrl+P+Q<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Pod调度到Master节点"><a href="#Pod调度到Master节点" class="headerlink" title="Pod调度到Master节点"></a>Pod调度到Master节点</h2><p>出于安全考虑，默认配置下Kubernetes不会将Pod调度到Master节点。查看Taints字段默认配置：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl describe <span class="token function">node</span> k8s-master <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>Taints:             node-role.kubernetes.io/master:NoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果希望将k8s-master也当作Node节点使用，可以执行如下命令,其中k8s-master是主机节点hostname：</p><p><code>kubectl taint node k8s-master node-role.kubernetes.io/master-</code></p><p>修改后Taints字段状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl describe <span class="token function">node</span> k8s-master                           <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>Taints:             <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果要恢复Master Only状态，执行如下命令：</p><p><code>kubectl taint node k8s-master node-role.kubernetes.io/master=:NoSchedule</code></p><h2 id="kube-proxy开启ipvs"><a href="#kube-proxy开启ipvs" class="headerlink" title="kube-proxy开启ipvs"></a>kube-proxy开启ipvs</h2><p>修改ConfigMap的kube-system/kube-proxy中的config.conf，<code>mode: &quot;ipvs&quot;</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl edit cm kube-proxy <span class="token parameter variable">-n</span> kube-systemconfigmap/kube-proxy edited<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>之后重启各个节点上的kube-proxy pod：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;system("kubectl delete pod "$1" -n kube-system")&#125;'</span>pod <span class="token string">"kube-proxy-gb7qj"</span> deletedpod <span class="token string">"kube-proxy-kfnmb"</span> deletedpod <span class="token string">"kube-proxy-nsj4g"</span> deleted<span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> kube-proxykube-proxy-469fj                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6skube-proxy-cwszg                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3skube-proxy-l7qzg                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看日志：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@k8s-master ~<span class="token punctuation">]</span>$ kubectl logs kube-proxy-469fj <span class="token parameter variable">-n</span> kube-systemI0628 07:17:58.726825       <span class="token number">1</span> node.go:136<span class="token punctuation">]</span> Successfully retrieved <span class="token function">node</span> IP: <span class="token number">192.168</span>.1.152I0628 07:17:58.726979       <span class="token number">1</span> server_others.go:259<span class="token punctuation">]</span> Using ipvs Proxier.W0628 07:17:58.738693       <span class="token number">1</span> proxier.go:429<span class="token punctuation">]</span> IPVS scheduler not specified, use rr by defaultI0628 07:17:58.739315       <span class="token number">1</span> server.go:583<span class="token punctuation">]</span> Version: v1.18.3I0628 07:17:58.761164       <span class="token number">1</span> conntrack.go:52<span class="token punctuation">]</span> Setting nf_conntrack_max to <span class="token number">131072</span>I0628 07:17:58.763090       <span class="token number">1</span> config.go:133<span class="token punctuation">]</span> Starting endpoints config controllerI0628 07:17:58.763140       <span class="token number">1</span> shared_informer.go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to <span class="token function">sync</span> <span class="token keyword">for</span> endpoints configI0628 07:17:58.763180       <span class="token number">1</span> config.go:315<span class="token punctuation">]</span> Starting <span class="token function">service</span> config controllerI0628 07:17:58.763187       <span class="token number">1</span> shared_informer.go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to <span class="token function">sync</span> <span class="token keyword">for</span> <span class="token function">service</span> configI0628 07:17:58.864362       <span class="token number">1</span> shared_informer.go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> endpoints config I0628 07:17:58.880011       <span class="token number">1</span> shared_informer.go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> <span class="token function">service</span> config <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>日志中打印出了<code>Using ipvs Proxier</code>，说明ipvs模式已经开启。</p><h2 id="移除节点和集群"><a href="#移除节点和集群" class="headerlink" title="移除节点和集群"></a>移除节点和集群</h2><p>kubernetes集群移除节点</p><p>以移除k8s-node2节点为例，在Master节点上运行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl drain k8s-node2 --delete-local-data <span class="token parameter variable">--force</span> --ignore-daemonsetskubectl delete <span class="token function">node</span> k8s-node2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面两条命令执行完成后，在k8s-node2节点执行清理命令，重置kubeadm的安装状态：</p><p><code>kubeadm reset</code></p><p>在master上删除node并不会清理k8s-node2运行的容器，需要在删除节点上面手动运行清理命令。</p><p>如果你想重新配置集群，使用新的参数重新运行kubeadm init或者kubeadm join即可。</p><p>至此3个节点的集群搭建完成，后续可以继续添加node节点，或者部署dashboard、helm包管理工具、EFK日志系统、Prometheus Operator监控系统、rook+ceph存储系统等组件。</p>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS收录</title>
      <link href="/posts/e9f8a82c.html"/>
      <url>/posts/e9f8a82c.html</url>
      
        <content type="html"><![CDATA[<h1 id="北京"><a href="#北京" class="headerlink" title="北京:"></a>北京:</h1><p><code>202.96.0.133</code>     (ns.bta.net.cn)</p><p><code>202.96.199.133</code>   (ns.spt.net.cn)</p><p><code>202.97.16.195</code>    (ns.cn.net)</p><p><code>202.106.0.20</code>     (gjjline.bta.net.cn)</p><p><code>202.106.196.115</code>  (linedns.bta.net.cn)</p><h1 id="广东"><a href="#广东" class="headerlink" title="广东:"></a>广东:</h1><p><code>202.96.128.143</code>   (ns.guangzhou.gd.cn)</p><p><code>202.96.128.68</code>    (dns.guangzhou.gd.cn)</p><h1 id="上海"><a href="#上海" class="headerlink" title="上海:"></a>上海:</h1><p><code>202.96.199.132</code>    (ns.sta.net.cn)</p><p><code>202.96.209.133</code>    (ns-pd.online.sh.cn)</p><h1 id="湖北武汉"><a href="#湖北武汉" class="headerlink" title="湖北武汉:"></a>湖北武汉:</h1><p><code>202.103.24.68</code>    (ns.wuhan.net.cn)</p><p><code>202.103.0.117</code>    (ns1.hbwhptt.net.cn)</p><h1 id="浙江"><a href="#浙江" class="headerlink" title="浙江:"></a>浙江:</h1><p><code>202.96.102.3</code>     (dns.zj.cninfo.net)</p><p><code>202.96.96.68</code>     (ns.wuhan.net.cn)</p><p><code>202.96.104.18</code>    (ns.zjnbptt.net.cn)</p><h1 id="陕西"><a href="#陕西" class="headerlink" title="陕西:"></a>陕西:</h1><p><code>202.100.13.11</code>    (ns.snnic.com)</p><h1 id="西安"><a href="#西安" class="headerlink" title="西安:"></a>西安:</h1><p><code>202.100.4.15</code>     (ns1.xaonline.com)</p><h1 id="天津"><a href="#天津" class="headerlink" title="天津:"></a>天津:</h1><p><code>202.99.96.68</code>     (ns.tpt.net.cn)</p><h1 id="辽宁"><a href="#辽宁" class="headerlink" title="辽宁:"></a>辽宁:</h1><p><code>202.96.75.68</code>     (ns.dcb.ln.cn)</p><p><code>202.96.64.68</code>     (ns.lnpta.net.cn)</p><p><code>202.96.69.38</code>     (dns.dl.lnpta.net.cn) </p><h1 id="江苏"><a href="#江苏" class="headerlink" title="江苏:"></a>江苏:</h1><p><code>202.102.29.3</code>     (pub.jsinfo.net)</p><p><code>202.102.13.141</code>   (info.ptt.js.cn)</p><p><code>202.102.24.35</code>    (dns.nj-online.nj.js.cn)</p><h1 id="安徽："><a href="#安徽：" class="headerlink" title="安徽："></a>安徽：</h1><p><code>202.102.199.68</code>   (ns.ahwhtel.net.cn)</p><h1 id="四川"><a href="#四川" class="headerlink" title="四川:"></a>四川:</h1><p><code>61.139.2.69</code>      (ns.sc.cninfo.net)</p><h1 id="重庆"><a href="#重庆" class="headerlink" title="重庆:"></a>重庆:</h1><p><code>61.128.128.68</code>    (cq.cta.net.cn)</p><p><code>61.128.192.4</code>     (cq.cta.net.cn)</p><h1 id="成都"><a href="#成都" class="headerlink" title="成都:"></a>成都:</h1><p><code>202.98.96.68</code>      (ns.sccdppt.net.cn)</p><h1 id="河北"><a href="#河北" class="headerlink" title="河北:"></a>河北:</h1><p><code>202.99.160.68</code>     (ns.hesjptt.net.cn)</p><h1 id="保定"><a href="#保定" class="headerlink" title="保定:"></a>保定:</h1><p><code>202.99.160.68</code>     (sjzdns.heinfo.net)</p><p><code>202.99.166.4</code>      (tsdns.heinfo.net)</p><h1 id="山西"><a href="#山西" class="headerlink" title="山西:"></a>山西:</h1><p><code>202.99.198.6</code>      (ns.sxyzptt.net.cn)</p><h1 id="吉林"><a href="#吉林" class="headerlink" title="吉林:"></a>吉林:</h1><p><code>202.98.5.68</code>       (ns.jlccptt.net.cn)</p><h1 id="山东"><a href="#山东" class="headerlink" title="山东:"></a>山东:</h1><p><code>202.102.152.3</code>     (dns1.sdjnptt.net.cn)</p><p><code>202.102.128.68</code>    (ns.sdjnptt.net.cn)</p><h1 id="福建"><a href="#福建" class="headerlink" title="福建:"></a>福建:</h1><p><code>202.101.98.55</code>     (dns.fz.fj.cn)</p><h1 id="湖南"><a href="#湖南" class="headerlink" title="湖南:"></a>湖南:</h1><p><code>202.103.100.206</code>  </p><h1 id="广西"><a href="#广西" class="headerlink" title="广西:"></a>广西:</h1><p><code>202.103.224.68</code>    (nsc0.gxnnptt.net.cn)</p><p><code>202.103.225.68</code>    (nsc.lzptt.gx.cn)</p><h1 id="江西"><a href="#江西" class="headerlink" title="江西:"></a>江西:</h1><p><code>202.101.224.68</code>    (ns.jxncptt.net.cn)</p><p><code>202.101.226.68</code>    (ns.jxjjptt.net.cn)</p><h1 id="云南"><a href="#云南" class="headerlink" title="云南:"></a>云南:</h1><p><code>202.98.160.68</code>      (ns.ynkmptt.net.cn)</p><h1 id="河南"><a href="#河南" class="headerlink" title="河南:"></a>河南:</h1><p><code>202.102.227.68</code>     (zz.163.ppp)</p><p><code>202.102.224.68</code>     (ns1.hazzptt.net.cn)</p><h1 id="新疆"><a href="#新疆" class="headerlink" title="新疆:"></a>新疆:</h1><p><code>61.128.97.73</code> </p><h1 id="厦门"><a href="#厦门" class="headerlink" title="厦门:"></a>厦门:</h1><p><code>202.101.103.55</code>     (dns.xm.fj.cn)</p><p><code>202.101.103.54</code>     (dns2.xm.fj.cn)</p><h1 id="山东-1"><a href="#山东-1" class="headerlink" title="山东:"></a>山东:</h1><p><code>202.102.134.68</code>     (ns1.sdqdptt.net.cn)</p><h1 id="长沙"><a href="#长沙" class="headerlink" title="长沙:"></a>长沙:</h1><p><code>202.103.96.68</code>      (dns1.cs.hn.cn)</p><h1 id="各大网站DNS列表"><a href="#各大网站DNS列表" class="headerlink" title="各大网站DNS列表:"></a>各大网站DNS列表:</h1><p>天府热线:          <code>61.139.2.69</code></p><p>长春163：          <code>202.98.0.68</code>      <code>202.98.3.68</code></p><p>263在线：          <code>211.100.2.130</code>    <code>211.100.1.10</code></p><h1 id="中国万网："><a href="#中国万网：" class="headerlink" title="中国万网："></a>中国万网：</h1><p><code>218.244.147.40</code>    (dns1.hichina.com)</p><p><code>218.244.147.69</code>    (dns2.hichina.com)</p><h1 id="新网："><a href="#新网：" class="headerlink" title="新网："></a>新网：</h1><p><code>211.99.199.194</code> </p><p><code>211.99.199.195</code> </p><h1 id="263IDC："><a href="#263IDC：" class="headerlink" title="263IDC："></a>263IDC：</h1><p><code>211.100.2.130</code>    (NS.263IDC.COM)</p><p><code>211.100.1.10</code>     (NSB.263IDC.COM)</p><h1 id="教育网DNS服务器"><a href="#教育网DNS服务器" class="headerlink" title="教育网DNS服务器:"></a>教育网DNS服务器:</h1><p><code>202.114.64.2</code>     武大DNS1 (一区)</p><p><code>202.114.96.1</code>     武大DNS2 (二区)</p><p><code>202.114.96.2</code>     武大DNS3 (二区)</p><p><code>202.114.112.13</code>   武大DNS4 (三区)</p><p><code>202.114.0.242</code>    (server20.hust.edu.cn)    华工DNS</p><p><code>202.112.0.35</code>     (dns.hust.edu.cn)         华工DNS2</p><p><code>202.112.20.131</code>   (dns.whnet.edu.cn)        华中地区网络中心DNS</p><p><code>166.111.8.28</code>     (dns-a.tsinghua.edu.cn)   清华DNS1</p><p><code>166.111.8.29</code>     (dns-b.tsinghua.edu.cn)   清华DNS2</p><p><code>166.111.8.30</code>     (dns.tsinghua.edu.cn)     清华DNS</p><p><code>202.117.0.20</code>     (dec3000.xjtu.edu.cn)     西交DNS1</p><p><code>202.117.0.21</code>     (ns2.xjtu.edu.cn)         西交DNS2</p><p><code>202.112.26.34</code>    (上交)</p><p><code>202.112.112.100</code>  (人大)</p><p><code>162.105.129.27</code>   (北大)</p><p><code>202.203.128.33</code>   (cernet云南中心主dns)</p><p><code>202.115.64.33</code>    (西南交大)</p><p><code>210.33.116.112</code>   (浙江电大)</p><p><code>202.116.160.33</code>   (华南农业)</p><p><code>202.112.0.33</code>     (华北网)</p><h1 id="香港"><a href="#香港" class="headerlink" title="香港:"></a>香港:</h1><p><code>205.252.144.228</code>  (ns1.netvigator.com)</p><h1 id="澳门"><a href="#澳门" class="headerlink" title="澳门:"></a>澳门:</h1><p><code>202.175.3.8</code>      (vassun2.macau.ctm.net)</p><h1 id="深圳"><a href="#深圳" class="headerlink" title="深圳:"></a>深圳:</h1><p><code>202.96.134.133</code>   (ns.shenzhen.gd.cn)</p><p><code>202.96.154.8</code>     (public.szonline.net)</p><p><code>202.96.154.15</code>    (ns.szonline.net)</p>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dns </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sshpass</title>
      <link href="/posts/9c4cdb74.html"/>
      <url>/posts/9c4cdb74.html</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> sshpass   <span class="token comment"># 直接安装</span><span class="token function">apt-get</span> <span class="token function">install</span> sshpass   <span class="token comment"># ubuntu安装</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>应用范围：可以在命令行直接使用密码来进行远程连接和远程拉取文件。</p><p>使用前提：对于未连接过的主机。而又不输入yes进行确认，需要进行sshd服务的优化(文末有其它解决方案)：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># vi /etc/ssh/ssh_config </span>StrictHostKeyChecking no<span class="token comment"># vi /etc/ssh/sshd_config</span>GSSAPIAuthentication noUseDNS no<span class="token comment"># service sshd restart</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>直接远程连接某台主机：</li></ol><p><code>sshpass -p xxx ssh root@192.168.11.11</code></p><ol start="2"><li>本地执行远程机器的命令：</li></ol><p><code>sshpass -p xxx ssh root@192.168.11.11 &quot;ethtool eth0&quot;</code></p><ol start="3"><li>远程连接指定ssh的端口：</li></ol><p><code>sshpass -p 123456 ssh -p 1000 root@192.168.11.11</code> (当远程主机不是默认的22端口时候)</p><ol start="4"><li>从密码文件读取文件内容作为密码去远程连接主机 (sshpass不可以直接接带特殊字符意义的密码，需要转义或者用小括号，或者指定文件的方式来连接都可以规避这个问题。)</li></ol><p><code>sshpass -f xxx.txt  ssh root@192.168.11.11</code></p><ol start="5"><li>从远程主机上拉取文件到本地</li></ol><p><code>sshpass -p &#39;123456&#39; scp root@host_ip:/home/test/t ./tmp/</code></p><p>从本地上传文件到远程主机</p><p><code>sshpass -p &#39;123456&#39; scp ./tmp/ root@host_ip:/home/test/t</code></p><ol><li>使用ssh连接远程主机时加上”-o StrictHostKeyChecking=no”的选项，如下：（推荐！！！）<pre class="line-numbers language-none"><code class="language-none">1. 做法是使用-o 这个参数，在ssh&#x2F;scp里加上 -o &quot;StrictHostKeyChecking no&quot; 即可跳过这个yes&#x2F;no询问，直接进入下一步，例：Use the -o option：scp -o &quot;StrictHostKeyChecking no&quot; 1.txt user@host:1.txt ssh -o &quot;StrictHostKeyChecking no&quot; user@host2. 一个彻底去掉这个提示的方法是，修改&#x2F;etc&#x2F;ssh&#x2F;ssh_config文件（或$HOME&#x2F;.ssh&#x2F;config）中的配置，添加如下两行配置：一般为：StrictHostKeyChecking ask可改为：StrictHostKeyChecking no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sshpass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WSS</title>
      <link href="/posts/db336181.html"/>
      <url>/posts/db336181.html</url>
      
        <content type="html"><![CDATA[<p>Workerman如何创建一个wss服务，使得客户端可以用过wss协来连接通讯，比如在微信小程序中连接服务端。</p><p>wss协议实际是websocket+SSL，就是在websocket协议上加入SSL层，类似https(http+SSL)。 所以只需要在websocket协议的基础上开启SSL即可支持wss协议。</p><p>方法一 ，直接用Workerman开启SSL</p><p>准备工作：</p><p>1、Workerman版本不小于3.3.7</p><p>2、PHP安装了openssl扩展</p><p>3、已经申请了证书（pem/crt文件及key文件）放在磁盘任意目录</p><p>代码：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">require_once</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/Workerman/Autoloader.php'</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Workerman<span class="token punctuation">\</span>Worker</span><span class="token punctuation">;</span><span class="token comment">// 证书最好是申请的证书</span><span class="token variable">$context</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>    <span class="token comment">// 更多ssl选项请参考手册 http://php.net/manual/zh/context.ssl.php</span>    <span class="token string single-quoted-string">'ssl'</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span>        <span class="token comment">// 请使用绝对路径</span>        <span class="token string single-quoted-string">'local_cert'</span>                 <span class="token operator">=></span> <span class="token string single-quoted-string">'磁盘路径/server.pem'</span><span class="token punctuation">,</span> <span class="token comment">// 也可以是crt文件</span>        <span class="token string single-quoted-string">'local_pk'</span>                   <span class="token operator">=></span> <span class="token string single-quoted-string">'磁盘路径/server.key'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'verify_peer'</span>                <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>        <span class="token comment">// 'allow_self_signed' => true, //如果是自签名证书需要开启此选项</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这里设置的是websocket协议（端口任意，但是需要保证没被其它程序占用）</span><span class="token variable">$worker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'websocket://0.0.0.0:443'</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置transport开启ssl，websocket+ssl即wss</span><span class="token variable">$worker</span><span class="token operator">-></span><span class="token property">transport</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ssl'</span><span class="token punctuation">;</span><span class="token variable">$worker</span><span class="token operator">-></span><span class="token property">onMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">,</span> <span class="token variable">$msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$con</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name static-context">Worker</span><span class="token operator">::</span><span class="token function">runAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过以上的代码，Workerman就监听了wss协议，客户端就可以通过wss协议来连接workerman实现安全即时通讯了。</p><p>测试</p><p>打开chrome浏览器，按F12打开调试控制台，在Console一栏输入(或者把下面代码放入到html页面用js运行)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 证书是会检查域名的，请使用域名连接</span>ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">"wss://域名"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"给服务端发送一个字符串：tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"收到服务端的消息："</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><p>1、如果无法启动，则一般是443端口被占用，请改成其它端口，注意改成其它端口后客户端连接时需要带上端口号，客户端连接时地址类似wss://domain.com:xxx ，xxx为端口号。如果必须使用443端口请使用方法二代理的方式实现wss。</p><p>2、wss端口只能通过wss协议访问，ws无法访问wss端口。</p><p>3、证书一般是与域名绑定的，所以测试的时候客户端请使用域名连接，不要使用ip去连。</p><p>4、如果出现无法访问的情况，请检查服务器防火墙。</p><p>5、此方法要求PHP版本&gt;=5.6，因为微信小程序要求tls1.2，而PHP5.6以下版本不支持tls1.2。</p><p>方法二、利用nginx/apache代理wss</p><p>除了用Workerman自身的SSL，也可以利用nginx/apache作为wss代理转发给workerman（注意此方法workerman部分千万不要设置ssl，否则将无法连接）。</p><p>通讯原理及流程是：</p><p>1、客户端发起wss连接连到nginx/apache</p><p>2、nginx/apache将wss协议的数据转换成ws协议数据并转发到Workerman的websocket协议端口</p><p>3、Workerman收到数据后做业务逻辑处理</p><p>4、Workerman给客户端发送消息时，则是相反的过程，数据经过nginx/apache转换成wss协议然后发给客户端</p><p>前提条件及准备工作：</p><p>1、已经安装nginx，版本不低于1.3</p><p>2、假设Workerman监听的是8282端口(websocket协议)</p><p>3、已经申请了证书（pem/crt文件及key文件）放在了/etc/nginx/conf.d/ssl下</p><p>4、打算利用nginx开启443端口对外提供wss代理服务（端口可以根据需要修改）</p><p>5、nginx一般作为网站服务器运行着其它服务，为了不影响原来的站点使用，这里使用地址 域名/wss 作为wss的代理入口。也就是客户端连接地址为 <code>wss://域名/wss</code></p><p>nginx配置类似如下：</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">server &#123;  listen 443;  ssl on;  ssl_certificate &#x2F;etc&#x2F;ssl&#x2F;server.pem;  ssl_certificate_key &#x2F;etc&#x2F;ssl&#x2F;server.key;  ssl_session_timeout 5m;  ssl_session_cache shared:SSL:50m;  ssl_protocols SSLv3 SSLv2 TLSv1 TLSv1.1 TLSv1.2;  ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;  location &#x2F;wss  &#123;    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8282;    proxy_http_version 1.1;    proxy_set_header Upgrade $http_upgrade;    proxy_set_header Connection &quot;Upgrade&quot;;    proxy_set_header X-Real-IP $remote_addr;  &#125;  # location &#x2F; &#123;&#125; 站点的其它配置...&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">// 证书是会检查域名的，请使用域名连接ws = new WebSocket("wss://域名/wss");ws.onopen = function() &#123;    alert("连接成功");    ws.send('tom');    alert("给服务端发送一个字符串：tom");&#125;;ws.onmessage = function(e) &#123;    alert("收到服务端的消息：" + e.data);&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>利用apache代理wss</p><p>也可以利用apache作为wss代理转发给workerman（注意如使用apache代理SSL，则workerman部分千万不要设置ssl，否则将无法连接）。</p><p>准备工作：</p><p>1、GatewayWorker 监听 8282 端口(websocket协议)</p><p>2、已经申请了ssl证书, 放在了/server/httpd/cert/ 下</p><p>3、利用apache转发443端口至指定端口8282</p><p>4、httpd-ssl.conf 已加载</p><p>5、openssl 已安装</p><p>启用 proxy_wstunnel_module 模块</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">LoadModule proxy_module modules&#x2F;mod_proxy.soLoadModule proxy_wstunnel_module modules&#x2F;mod_proxy_wstunnel.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置SSL及代理</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">#extra&#x2F;httpd-ssl.confDocumentRoot &quot;&#x2F;网站&#x2F;目录&quot;ServerName 域名# Proxy ConfigSSLProxyEngine onProxyRequests OffProxyPass &#x2F;wss ws:&#x2F;&#x2F;127.0.0.1:8282&#x2F;wssProxyPassReverse &#x2F;wss ws:&#x2F;&#x2F;127.0.0.1:8282&#x2F;wss# 添加 SSL 协议支持协议,去掉不安全的协议SSLProtocol all -SSLv2 -SSLv3# 修改加密套件如下SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUMSSLHonorCipherOrder on# 证书公钥配置SSLCertificateFile &#x2F;server&#x2F;httpd&#x2F;cert&#x2F;your.pem# 证书私钥配置SSLCertificateKeyFile &#x2F;server&#x2F;httpd&#x2F;cert&#x2F;your.key# 证书链配置,SSLCertificateChainFile &#x2F;server&#x2F;httpd&#x2F;cert&#x2F;chain.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">// 证书是会检查域名的，请使用域名连接ws = new WebSocket("wss://域名/wss");ws.onopen = function() &#123;    alert("连接成功");    ws.send('tom');    alert("给服务端发送一个字符串：tom");&#125;;ws.onmessage = function(e) &#123;    alert("收到服务端的消息：" + e.data);&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="http://doc.workerman.net/faq/secure-websocket-server.html">参考链接</a>（此方法未验证）</p>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Registry</title>
      <link href="/posts/4b7f1d7f.html"/>
      <url>/posts/4b7f1d7f.html</url>
      
        <content type="html"><![CDATA[<h1 id="docker-registry-生成本地私有镜像库"><a href="#docker-registry-生成本地私有镜像库" class="headerlink" title="docker registry 生成本地私有镜像库"></a>docker registry 生成本地私有镜像库</h1><h2 id="获取-registry-镜像"><a href="#获取-registry-镜像" class="headerlink" title="获取 registry　镜像"></a>获取 registry　镜像</h2><p><code>docker pull registry</code></p><h2 id="运行创建容器，-var-lib-registry挂载到本地"><a href="#运行创建容器，-var-lib-registry挂载到本地" class="headerlink" title="运行创建容器，/var/lib/registry挂载到本地"></a>运行创建容器，/var/lib/registry挂载到本地</h2><p><code>docker run -d -p 80:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</code></p><h2 id="新增本地镜像仓库地址"><a href="#新增本地镜像仓库地址" class="headerlink" title="新增本地镜像仓库地址"></a>新增本地镜像仓库地址</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF&#123;  "registry-mirrors": ["https://fogd2pyo.mirror.aliyuncs.com"],  "insecure-registries": ["docker.registry.com"]&#125;EOF</span><span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"^    inet .* ens| eth.*$"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token builtin class-name">:</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">' '</span> <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F/ <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">`</span></span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$IP</span> docker.registry.com"</span> <span class="token operator">>></span> /etc/hosts<span class="token builtin class-name">echo</span> <span class="token string">"其他机器请在hosts中映射 <span class="token variable">$IP</span> docker.registry.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="重启docker"><a href="#重启docker" class="headerlink" title="重启docker"></a>重启docker</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl daemon-reloadsystemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="获取nginx镜像"><a href="#获取nginx镜像" class="headerlink" title="获取nginx镜像"></a>获取nginx镜像</h2><p><code>docker pull nginx</code></p><h2 id="重新打上本地的仓库的tag"><a href="#重新打上本地的仓库的tag" class="headerlink" title="重新打上本地的仓库的tag"></a>重新打上本地的仓库的tag</h2><p><code>docker tag nginx docker.registry.com/nginx</code></p><h2 id="将打好标签的镜像push到本地仓库"><a href="#将打好标签的镜像push到本地仓库" class="headerlink" title="将打好标签的镜像push到本地仓库"></a>将打好标签的镜像push到本地仓库</h2><p><code>docker push docker.registry.com/nginx</code></p><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><h3 id="curl访问"><a href="#curl访问" class="headerlink" title="curl访问"></a>curl访问</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://docker.registry.com/v2/_catalog<span class="token comment"># &#123;"repositories":["nginx"]&#125;   # 可以看到有nginx镜像</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="其他机器拉取"><a href="#其他机器拉取" class="headerlink" title="其他机器拉取"></a>其他机器拉取</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/docker/daemon.json</span><span class="token punctuation">&#123;</span>  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://fogd2pyo.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,  <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"docker.registry.com"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker pull docker.registry.com/nginx</span>Using default tag: latestTrying to pull repository docker.registry.com/nginx <span class="token punctuation">..</span>. latest: Pulling from docker.registry.com/nginx8559a31e96f4: Pull complete 8d69e59170f7: Pull complete 3f9f1ec1d262: Pull complete d1f5ff4f210d: Pull complete 1e22bfa8652e: Pull complete Digest: sha256:0efad4d09a419dc6d574c3c3baacb804a530acd61d5eba72cb1f14e1f5ac0c8fStatus: Downloaded newer image <span class="token keyword">for</span> docker.registry.com/nginx:latest<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZEmail                                                              latest              421b6fb6f3aa        <span class="token number">2</span> days ago          <span class="token number">167</span> MBregistry.cn-beijing.aliyuncs.com/roxn/mail                     latest              421b6fb6f3aa        <span class="token number">2</span> days ago          <span class="token number">167</span> MBdocker.registry.com/nginx                                            latest              2622e6cca7eb        <span class="token number">13</span> days ago         <span class="token number">132</span> MB<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h1><h2 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h2><h3 id="创建证书，有效期设置10年"><a href="#创建证书，有效期设置10年" class="headerlink" title="创建证书，有效期设置10年"></a>创建证书，有效期设置10年</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> ~/.certsopenssl req <span class="token parameter variable">-newkey</span> rsa:4096 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-keyout</span> ~/.certs/docker.registry.com.key <span class="token parameter variable">-x509</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-out</span> ~/.certs/docker.registry.com.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="带证书运行registry容器"><a href="#带证书运行registry容器" class="headerlink" title="带证书运行registry容器"></a>带证书运行registry容器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span><span class="token parameter variable">--name</span> registry <span class="token punctuation">\</span><span class="token parameter variable">-v</span> ~/.certs/:/certs <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_ADDR</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0:443 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="token operator">=</span>/certs/docker.registry.com.crt <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_KEY</span><span class="token operator">=</span>/certs/docker.registry.com.key <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">443</span>:443 <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /opt/registry:/var/lib/registry <span class="token punctuation">\</span>registry:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull httpd   <span class="token comment"># 从官方pull httpd镜像</span><span class="token function">docker</span> tag httpd docker.registry.com/httpd   <span class="token comment"># 重新打标签</span><span class="token function">docker</span> push docker.registry.com/httpd   <span class="token comment"># 将打好标签的镜像push到本地仓库</span><span class="token function">curl</span> https://docker.registry.com/v2/_catalog <span class="token parameter variable">-k</span>   <span class="token comment"># 验证</span><span class="token punctuation">&#123;</span><span class="token string">"repositories"</span>:<span class="token punctuation">[</span><span class="token string">"docs"</span>,<span class="token string">"httpd"</span>,<span class="token string">"nginx"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 可以看到本地镜像库中已有的镜像</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><p>向服务器发送 <code>https</code> 请求</p><p><code>curl</code>需要加上<code>-k</code>，<code>wget</code>需要加上<code>--no-check-certificate</code></p><h3 id="其他主机访问仓库"><a href="#其他主机访问仓库" class="headerlink" title="其他主机访问仓库"></a>其他主机访问仓库</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/docker/daemon.json   <span class="token comment"># 配置insecure-registries</span><span class="token punctuation">&#123;</span>  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://fogd2pyo.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,  <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"docker.registry.com"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token function">cat</span> /etc/hosts <span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<span class="token number">192.168</span>.1.40 docker.registry.com   <span class="token comment"># 主机映射</span><span class="token function">docker</span> pull docker.registry.com/httpd   <span class="token comment"># pull镜像</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="基于用户密码访问"><a href="#基于用户密码访问" class="headerlink" title="基于用户密码访问"></a>基于用户密码访问</h2><h3 id="使用htpasswd工具，生成验证文件"><a href="#使用htpasswd工具，生成验证文件" class="headerlink" title="使用htpasswd工具，生成验证文件"></a>使用htpasswd工具，生成验证文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> httpd-toolshtpasswd <span class="token parameter variable">-Bbn</span> roxn <span class="token number">123456</span> <span class="token operator">></span> ~/.certs/.htpasswd   <span class="token comment"># 这里我和ssl加密文件放在一个文件夹下</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="带证书和用户认证运行registry容器"><a href="#带证书和用户认证运行registry容器" class="headerlink" title="带证书和用户认证运行registry容器"></a>带证书和用户认证运行registry容器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span><span class="token parameter variable">--name</span> registry <span class="token punctuation">\</span><span class="token parameter variable">-v</span> ~/.certs/:/certs <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_ADDR</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0:443 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="token operator">=</span>/certs/docker.registry.com.crt <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_KEY</span><span class="token operator">=</span>/certs/docker.registry.com.key <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_AUTH</span><span class="token operator">=</span>htpasswd <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_AUTH_HTPASSWD_REALM</span><span class="token operator">=</span><span class="token string">"Registry Realm"</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="token operator">=</span>/certs/.htpasswd <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">443</span>:443 <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /opt/registry:/var/lib/registry <span class="token punctuation">\</span>docker.registry.com/registry:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><p>执行<code>docker-compose up -d</code>效果和上面的命令相同</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">registry</span><span class="token punctuation">:</span>  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.registry.com/registry  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> registry  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>  <span class="token key atrule">environment</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> REGISTRY_AUTH=htpasswd    <span class="token punctuation">-</span> REGISTRY_AUTH_HTPASSWD_REALM=Registry_Realm    <span class="token punctuation">-</span> REGISTRY_AUTH_HTPASSWD_PATH=~/.certs/.htpasswd    <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">443</span>    <span class="token punctuation">-</span> REGISTRY_HTTP_TLS_CERTIFICATE=/certs/docker.registry.com.crt    <span class="token punctuation">-</span> REGISTRY_HTTP_TLS_KEY=/certs/docker.registry.com.key  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ~/.certs/<span class="token punctuation">:</span>/auth    <span class="token punctuation">-</span> /opt/registry<span class="token punctuation">:</span>/var/lib/registry<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看本地仓库的镜像"><a href="#查看本地仓库的镜像" class="headerlink" title="查看本地仓库的镜像"></a>查看本地仓库的镜像</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://docker.registry.com/v2/_catalog <span class="token parameter variable">-k</span><span class="token punctuation">&#123;</span><span class="token string">"errors"</span>:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token builtin class-name">:</span><span class="token string">"UNAUTHORIZED"</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"authentication required"</span>,<span class="token string">"detail"</span>:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"Type"</span><span class="token builtin class-name">:</span><span class="token string">"registry"</span>,<span class="token string">"Class"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"Name"</span><span class="token builtin class-name">:</span><span class="token string">"catalog"</span>,<span class="token string">"Action"</span><span class="token builtin class-name">:</span><span class="token string">"*"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>此种方法与上述使用证书的区别在于，此时查看文件_catalog中的内容时，发现是加密过的，无法显示</p><p>注意：</p><ol><li><p>_catalog相当于一个API接口,查看私有仓库中有哪些镜像</p></li><li><p>必须先做加密后做认证，因为如果反着来就没有意义，直接可以通过数据包知道密码</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> registry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux Mail</title>
      <link href="/posts/f1140376.html"/>
      <url>/posts/f1140376.html</url>
      
        <content type="html"><![CDATA[<h1 id="关闭、卸载-sendmail-postfix"><a href="#关闭、卸载-sendmail-postfix" class="headerlink" title="关闭、卸载 sendmail/postfix"></a>关闭、卸载 sendmail/postfix</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sendmial</span><span class="token function">service</span> <span class="token function">sendmail</span> stop<span class="token function">chkconfig</span> <span class="token function">sendmail</span> off<span class="token comment"># postfix</span><span class="token function">service</span> postfix stop<span class="token function">chkconfig</span> postfix off<span class="token comment"># 直接卸载</span>yum remove <span class="token function">sendmail</span>yum remove postfix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装mailx"><a href="#安装mailx" class="headerlink" title="安装mailx"></a>安装mailx</h2><p><code>yum install mailx -y</code></p><p>Ubuntu安装：</p><p><code>sudo apt-get install heirloom-mailx</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 时间同步</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntpdatentpdate <span class="token number">210.72</span>.145.44ntpdate ntp.api.bzntpdate <span class="token parameter variable">-u</span> <span class="token number">210.72</span>.145.44   <span class="token comment"># 可以越过主机防火墙</span>clock <span class="token parameter variable">-w</span>   <span class="token comment"># 将时间同步到硬件时钟</span>---分割线---<span class="token comment"># 163邮箱</span><span class="token number">1</span><span class="token punctuation">)</span>vim /etc/mail.rc   <span class="token comment"># 最后插入已下内容：</span><span class="token builtin class-name">set</span> <span class="token assign-left variable">from</span><span class="token operator">=</span>150xxxxxxxx@163.com<span class="token builtin class-name">set</span> <span class="token assign-left variable">smtp</span><span class="token operator">=</span>smtp.163.com<span class="token builtin class-name">set</span> smtp-auth-user<span class="token operator">=</span>150xxxxxxxx@163.com<span class="token builtin class-name">set</span> smtp-auth-password<span class="token operator">=</span>xxxxxx   <span class="token comment"># 此密码为授权码，在163网页邮箱可设置</span><span class="token builtin class-name">set</span> smtp-auth<span class="token operator">=</span>login<span class="token number">2</span><span class="token punctuation">)</span>echo <span class="token string">"test mail"</span> <span class="token operator">|</span> mail <span class="token parameter variable">-vvv</span> <span class="token parameter variable">-s</span> <span class="token string">"subject"</span> xxx@qq.com   <span class="token comment"># 命令行验证</span><span class="token comment"># qq邮箱</span><span class="token number">1</span><span class="token punctuation">)</span>vim /etc/mail.rc   <span class="token comment"># 最后插入已下内容：</span><span class="token builtin class-name">set</span> <span class="token assign-left variable">from</span><span class="token operator">=</span>xxxx@qq.com<span class="token builtin class-name">set</span> smtp-auth-user<span class="token operator">=</span>xxxx@qq.com<span class="token builtin class-name">set</span> smtp-auth-password<span class="token operator">=</span>xxxxxx   <span class="token comment"># 此密码为授权码，在qq邮箱网页版中设置 </span><span class="token builtin class-name">set</span> smtp-auth<span class="token operator">=</span>login<span class="token builtin class-name">set</span> ssl-verify<span class="token operator">=</span>ignore<span class="token builtin class-name">set</span> nss-config-dir<span class="token operator">=~</span>/.certs<span class="token builtin class-name">set</span> <span class="token assign-left variable">smtp</span><span class="token operator">=</span>smtps://smtp.qq.com:465<span class="token number">2</span><span class="token punctuation">)</span>mkdir ~/.certs <span class="token operator">&amp;&amp;</span> certutil <span class="token parameter variable">-N</span> <span class="token parameter variable">-d</span> ~/.certs   <span class="token comment"># 命令行执行此命令，输入8位密码(任意)，例如Az123123</span><span class="token number">3</span><span class="token punctuation">)</span>echo <span class="token string">"test mail"</span> <span class="token operator">|</span> mail <span class="token parameter variable">-vvv</span> <span class="token parameter variable">-s</span> <span class="token string">"subject"</span> 150xxxxxxxx@163.com   <span class="token comment"># 命令行验证</span><span class="token comment"># 腾讯企业邮箱</span><span class="token number">1</span><span class="token punctuation">)</span>vim /etc/mail.rc<span class="token builtin class-name">set</span> <span class="token assign-left variable">from</span><span class="token operator">=</span>dev@xxx.com<span class="token builtin class-name">set</span> smtp-auth-user<span class="token operator">=</span>dev@xxx.com<span class="token builtin class-name">set</span> smtp-auth-password<span class="token operator">=</span>xxxxxx<span class="token builtin class-name">set</span> smtp-auth<span class="token operator">=</span>login<span class="token builtin class-name">set</span> <span class="token assign-left variable">smtp</span><span class="token operator">=</span>smtp://smtp.exmail.qq.com<span class="token number">3</span><span class="token punctuation">)</span>echo <span class="token string">"test mail"</span> <span class="token operator">|</span> mail <span class="token parameter variable">-vvv</span> <span class="token parameter variable">-s</span> <span class="token string">"subject"</span> 150xxxxxxxx@163.com   <span class="token comment"># 命令行验证</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mailx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pycharm连接服务器</title>
      <link href="/posts/62d97976.html"/>
      <url>/posts/62d97976.html</url>
      
        <content type="html"><![CDATA[<h2 id="添加远程服务器"><a href="#添加远程服务器" class="headerlink" title="添加远程服务器"></a>添加远程服务器</h2><blockquote><p>打开 文件 –&gt; 设置</p></blockquote><p><img src="/medias/img/pycharm/0.jpg"></p><blockquote><p>在 工具 SSH Config中添加远程服务器信息</p></blockquote><p><img src="/medias/img/pycharm/2.jpg"></p><blockquote><p>在 项目 这里可以看到一些本机的环境信息</p></blockquote><p><img src="/medias/img/pycharm/1.jpg"></p><blockquote><p>选择 Add 后，选择 SSH 连接，找到刚才配置好的远程服务器</p></blockquote><p><img src="/medias/img/pycharm/3.jpg"></p><blockquote><p>配置好上面的内容，选择 next ，配置python环境、工作目录</p></blockquote><p><img src="/medias/img/pycharm/4.jpg"></p><blockquote><p>配置好保存，会自动上传本地文件到远程，等待一会</p></blockquote><p><img src="/medias/img/pycharm/5.jpg"></p><blockquote><p>查看项目环境已经是远程服务器的了</p></blockquote><p><img src="/medias/img/pycharm/11.jpg"></p><h2 id="其它配置"><a href="#其它配置" class="headerlink" title="其它配置"></a>其它配置</h2><blockquote><p>修改文件字体编码<br><img src="/medias/img/pycharm/6.jpg"></p></blockquote><blockquote><p>更改为自动保存</p></blockquote><p><img src="/medias/img/pycharm/7.jpg"></p><blockquote><p>修改换行符</p></blockquote><p><img src="/medias/img/pycharm/8.jpg"></p><blockquote><p>解决 pycharm terminal 显示进度条乱码<br><img src="/medias/img/pycharm/9.jpg"></p></blockquote><blockquote><p>新建远程终端，选择自己的远程服务器即可</p></blockquote><p><img src="/medias/img/pycharm/10.jpg"></p><blockquote><p>其它的电脑也可以拉取（配置好远程服务器地址即可）</p></blockquote><p>在此更改不会被记录，建议工作目录和<a href="../../others/git/">git</a>配合使用</p><p><img src="/medias/img/pycharm/12.jpg"></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>最后在 Windows 主机的工作目录，新建、删除文件和编辑内容会实时同步到远程服务器。</p>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pycharm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pip3安装</title>
      <link href="/posts/761ebfa4.html"/>
      <url>/posts/761ebfa4.html</url>
      
        <content type="html"><![CDATA[<h1 id="安装pip3"><a href="#安装pip3" class="headerlink" title="安装pip3"></a>安装pip3</h1><p>在Linux系统中，可以直接使用</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> python36-pip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> <span class="token parameter variable">-U</span> pip   <span class="token comment"># 如果出问题，使用下面的命令升级</span>pip3 <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pipeasy_install-3.6 <span class="token parameter variable">--upgrade</span> pip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="安装指定版本"><a href="#安装指定版本" class="headerlink" title="安装指定版本"></a>安装指定版本</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> <span class="token assign-left variable">Django</span><span class="token operator">==</span><span class="token number">1.7</span>   <span class="token comment"># 指定安装Django1.7版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="卸载包"><a href="#卸载包" class="headerlink" title="卸载包"></a>卸载包</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 uninstall Django<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="搜索包"><a href="#搜索包" class="headerlink" title="搜索包"></a>搜索包</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 search Django<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="显示安装包信息"><a href="#显示安装包信息" class="headerlink" title="显示安装包信息"></a>显示安装包信息</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 show <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="查看指定包的详细信息"><a href="#查看指定包的详细信息" class="headerlink" title="查看指定包的详细信息"></a>查看指定包的详细信息</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 show <span class="token parameter variable">-f</span> Django<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="列出已安装的包"><a href="#列出已安装的包" class="headerlink" title="列出已安装的包"></a>列出已安装的包</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="查看可升级的包"><a href="#查看可升级的包" class="headerlink" title="查看可升级的包"></a>查看可升级的包</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 list <span class="token parameter variable">-o</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注意如果需要安装Python3的安装包，请使用以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> numpy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注意如果需要安装Python2的安装包，请使用以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python2 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> numpy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不建议大家直接用pip install的方式安装python包，这样你会不清楚装的是python2的包还是python3的包</p><h1 id="pip更换国内源"><a href="#pip更换国内源" class="headerlink" title="pip更换国内源"></a>pip更换国内源</h1><p>国内源：</p><p>新版ubuntu要求使用https源，要注意。</p><p>清华：<code>https://pypi.tuna.tsinghua.edu.cn/simple</code></p><p>阿里云：<code>http://mirrors.aliyun.com/pypi/simple/</code></p><p>中国科技大学：<code>https://pypi.mirrors.ustc.edu.cn/simple/</code></p><p>华中理工大学：<code>http://pypi.hustunique.com/</code></p><p>山东理工大学：<code>http://pypi.sdutlinux.org/</code> </p><p>豆瓣：<code>http://pypi.douban.com/simple/</code></p><p>永久修改：</p><p>Linux下，修改 <code>~/.pip/pip.conf</code> (没有就创建一个文件夹及文件。文件夹要加”.”，表示是隐藏文件夹)</p><p>内容如下：</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">[global]index-url &#x3D; http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple[install]trusted-host&#x3D;mirrors.aliyun.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>windows下，直接在user目录中创建一个pip目录，如：<code>C:\Users\xx\pip</code>，新建文件<code>pip.ini</code>。内容同上。</p><h1 id="安装psutil"><a href="#安装psutil" class="headerlink" title="安装psutil"></a>安装psutil</h1><p><code>psutil</code> 是一个跨平台库</p><p>能够轻松实现获取系统运行的进程和系统利用率</p><p>包括 CPU、内存、磁盘、网络等信息</p><p><code>psutil</code> 主要应用于系统监控、分析和限制系统资源及进程的管理</p><p><code>psutil</code> 实现了同等命令行工具提供的功能，</p><p>如 <code>ps</code>、<code>top</code>、<code>lsof</code>、<code>netstat</code>、<code>ifconfig</code>、<code>who</code>、<code>df</code>、<code>kill</code>、<code>free</code>、<code>nice</code>、<code>ionice</code>、<code>iostat</code>、<code>iotop</code>、<code>uptime</code>、<code>pidof</code>、<code>tty</code>、<code>taskset</code>、<code>pmap</code> 等。</p><p>目前支持 32 位和 64 位的 <code>Linux</code>、<code>Windows</code>、<code>OS X</code>、<code>FreeBSD</code> 和 <code>Sun Solaris</code> 等操作系统</p><p>Linux安装psutil报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unable to execute <span class="token string">'gcc'</span><span class="token builtin class-name">:</span> No such <span class="token function">file</span> or directory   <span class="token comment"># gcc要安装</span>psutil/_psutil_common.c:9:20: 致命错误：Python.h：没有那个文件或目录   <span class="token comment"># python-devel要安装</span>Using legacy setup.py <span class="token function">install</span> <span class="token keyword">for</span> psutil, since package <span class="token string">'wheel'</span> is not installed.   <span class="token comment"># pip安装wheel</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>安装psutil</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> python36-devel gccpip <span class="token function">install</span> wheel   <span class="token comment"># pip3 install psutil</span><span class="token punctuation">[</span>root@bogon ~<span class="token punctuation">]</span><span class="token comment"># pip3 install psutil</span>Looking <span class="token keyword">in</span> indexes: http://mirrors.aliyun.com/pypi/simple/Collecting psutil  Downloading http://mirrors.aliyun.com/pypi/packages/1c/ca/5b8c1fe032a458c2c4bcbe509d1401dca9dda35c7fc46b36bb81c2834740/psutil-5.6.3.tar.gz <span class="token punctuation">(</span>435kB<span class="token punctuation">)</span>     <span class="token operator">|</span>████████████████████████████████<span class="token operator">|</span> 440kB <span class="token number">4</span>.6MB/s Installing collected packages: psutil  Running setup.py <span class="token function">install</span> <span class="token keyword">for</span> psutil <span class="token punctuation">..</span>. <span class="token keyword">done</span>Successfully installed psutil-5.6.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习笔记 </tag>
            
            <tag> python杂记 </tag>
            
            <tag> pip3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sourcetree3.x</title>
      <link href="/posts/836e54c.html"/>
      <url>/posts/836e54c.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>前提：使用腾讯电脑管家自带的软件管理工具，先安装git，再安装sourcetree，这两个软件在软件管理里面都有，<em>安装git不用修改配置，直接下一步，直到安装完成</em>，这个时候再安装sourcetree。如果你是菜鸟sourcetree全中文界面可以很好的带你入门git，一些错误仍需要您手动执行git命令，很少情况下会发生，如果你是用git的老手，sourcetree可以让您的工作效率事半功倍🏊‍。</p></blockquote><h2 id="使用软件管理安装sourcetree"><a href="#使用软件管理安装sourcetree" class="headerlink" title="使用软件管理安装sourcetree"></a>使用软件管理安装sourcetree</h2><blockquote><p><strong><font color=green>🎉🎉🎉最新的sourcetree可以使用 Microsoft 帐户 直接登录sourcetree啦！🎉🎉🎉</font></strong></p></blockquote><h2 id="配置git和openssh"><a href="#配置git和openssh" class="headerlink" title="配置git和openssh"></a>配置git和openssh</h2><p>git安装完成后，在桌面右键打开git gui，选择show ssh key</p><p><img src="/medias/img/sourcetree/5.jpg"></p><blockquote><p>选择Generate Key</p></blockquote><p><img src="/medias/img/sourcetree/6.jpg"></p><blockquote><p>连续点两次yes</p></blockquote><p><img src="/medias/img/sourcetree/7.jpg"><br><img src="/medias/img/sourcetree/8.jpg"></p><blockquote><p>完成之后会在当前用户家目录生成公钥和私钥</p></blockquote><p>这里的公钥长期存在，您可以复制到剪切板<code>Copy To Clipboard</code>，粘贴到GitHub、coding等SSH公钥位置，从而进行免密<code>git push origin branch</code><br><img src="/medias/img/sourcetree/9.jpg"></p><blockquote><p>在”工具” “选项”中，选择openssh即可</p></blockquote><p><img src="/medias/img/sourcetree/10.jpg"></p><p>这个时候你就可以把状态栏的”戴蓝帽子的小电脑”干掉了，点击”ssh密钥”后面的”…”可以进入<code>.ssh</code>目录查看自己的私钥id_rsa和公钥id_rsa.pub</p>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> sourcetree </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FFmpeg6安装</title>
      <link href="/posts/835ea6e0.html"/>
      <url>/posts/835ea6e0.html</url>
      
        <content type="html"><![CDATA[<h2 id="英语原文及翻译："><a href="#英语原文及翻译：" class="headerlink" title="英语原文及翻译："></a>英语原文及翻译：</h2><p><a href="https://github.com/BtbN/FFmpeg-Builds">点击前往原文地址</a></p><h2 id="FFmpeg-Static-Auto-Builds"><a href="#FFmpeg-Static-Auto-Builds" class="headerlink" title="FFmpeg Static Auto-Builds"></a>FFmpeg Static Auto-Builds</h2><blockquote><p>FFmpeg 静态构建</p></blockquote><p>Static Windows (x86_64) and Linux (x86_64) Builds of ffmpeg master and latest release branch.</p><blockquote><p>FFmpeg-Builds 提供了 Windows (x86_64) 和 Linux (x86_64) 最新发布的 FFmpeg master 分支的静态构建。</p></blockquote><p>Windows builds are targetting Windows 7 and newer.</p><blockquote><p>Windows 构建针对 Windows 7 及更高版本。</p></blockquote><p><code>Linux (x86_64)</code> builds are targetting <code>Ubuntu 16.04</code> (glibc-2.23 + linux-4.4) and anything more recent.</p><blockquote><p><code>Linux (x86_64)</code> 构建针对 <code>Ubuntu 16.04</code> (glibc-2.23 + linux-4.4) 及更新版本。</p></blockquote><p><code>Linux (arm64)</code> builds are targetting <code>Ubuntu 18.04</code> (glibc-2.27 + linux-4.15) and anything more recent.</p><blockquote><p><code>Linux (arm64)</code> 构建针对 <code>Ubuntu 18.04</code> (glibc-2.27 + linux-4.15) 及更新版本。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这里使用的是系统是 CentOS 7</span><span class="token punctuation">[</span>root@dev-gpu-node-02 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release </span><span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"CentOS Linux"</span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"7 (Core)"</span><span class="token comment"># 内核版本5.4</span><span class="token punctuation">[</span>root@dev-gpu-node-02 ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span><span class="token number">5.4</span>.242-1.el7.elrepo.x86_64<span class="token comment"># glibc版本2.23</span><span class="token punctuation">[</span>root@dev-gpu-node-02 ~<span class="token punctuation">]</span><span class="token comment"># ldd --version</span>ldd <span class="token punctuation">(</span>GNU libc<span class="token punctuation">)</span> <span class="token number">2.23</span><span class="token comment"># CUDA版本12.1、NVIDIA-SMI版本530.30.02</span><span class="token punctuation">[</span>root@dev-gpu-node-02 ~<span class="token punctuation">]</span><span class="token comment"># nvidia-smi</span>Thu Jun <span class="token number">29</span> <span class="token number">14</span>:57:30 <span class="token number">2023</span>       +---------------------------------------------------------------------------------------+<span class="token operator">|</span> NVIDIA-SMI <span class="token number">530.30</span>.02              Driver Version: <span class="token number">530.30</span>.02    CUDA Version: <span class="token number">12.1</span>     <span class="token operator">|</span><span class="token operator">|</span>-----------------------------------------+----------------------+----------------------+<span class="token operator">|</span> GPU  Name                  Persistence-M<span class="token operator">|</span> Bus-Id        Disp.A <span class="token operator">|</span> Volatile Uncorr. ECC <span class="token operator">|</span><span class="token operator">|</span> Fan  Temp  Perf            Pwr:Usage/Cap<span class="token operator">|</span>         Memory-Usage <span class="token operator">|</span> GPU-Util  Compute M. <span class="token operator">|</span><span class="token operator">|</span>                                         <span class="token operator">|</span>                      <span class="token operator">|</span>               MIG M. <span class="token operator">|</span><span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">0</span>  Quadro M5000                    Off<span class="token operator">|</span> 00000000:06:00.0 Off <span class="token operator">|</span>                  Off <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">42</span>%   35C    P0               46W / 150W<span class="token operator">|</span>      0MiB /  8192MiB <span class="token operator">|</span>      <span class="token number">1</span>%      Default <span class="token operator">|</span><span class="token operator">|</span>                                         <span class="token operator">|</span>                      <span class="token operator">|</span>                  N/A <span class="token operator">|</span>+-----------------------------------------+----------------------+----------------------+<span class="token comment"># ffmpeg 版本信息</span><span class="token punctuation">[</span>root@dev-gpu-node-02 ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/ffmpeg6/bin/ffmpeg -version</span>ffmpeg version n6.0-18-g27205c0b47-20230503 Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2023 the FFmpeg developersbuilt with gcc <span class="token number">12.2</span>.0 <span class="token punctuation">(</span>crosstool-NG <span class="token number">1.25</span>.0.152_89671bf<span class="token punctuation">)</span>configuration: <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/ffbuild/prefix --pkg-config-flags<span class="token operator">=</span>--static --pkg-config<span class="token operator">=</span>pkg-config --cross-prefix<span class="token operator">=</span>x86_64-ffbuild-linux-gnu- <span class="token parameter variable">--arch</span><span class="token operator">=</span>x86_64 --target-os<span class="token operator">=</span>linux --enable-gpl --enable-version3 --disable-debug --enable-iconv --enable-libxml2 --enable-zlib --enable-libfreetype --enable-libfribidi --enable-gmp --enable-openssl --enable-lzma --enable-fontconfig --enable-libvorbis --enable-opencl --enable-libpulse --enable-libvmaf --enable-libxcb --enable-xlib --enable-amf --enable-libaom --enable-libaribb24 --enable-avisynth --enable-chromaprint --enable-libdav1d --enable-libdavs2 --disable-libfdk-aac --enable-ffnvcodec --enable-cuda-llvm --enable-frei0r --enable-libgme --enable-libkvazaar --enable-libass --enable-libbluray --enable-libjxl --enable-libmp3lame --enable-libopus --enable-librist --enable-libssh --enable-libtheora --enable-libvpx --enable-libwebp --enable-lv2 --disable-libmfx --enable-libvpl --enable-openal --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libopenh264 --enable-libopenjpeg --enable-libopenmpt --enable-librav1e --enable-librubberband --disable-schannel --enable-sdl2 --enable-libsoxr --enable-libsrt --enable-libsvtav1 --enable-libtwolame --enable-libuavs3d --enable-libdrm --enable-vaapi --enable-libvidstab --enable-vulkan --enable-libshaderc --disable-libplacebo --enable-libx264 --enable-libx265 --enable-libxavs2 --enable-libxvid --enable-libzimg --enable-libzvbi --extra-cflags<span class="token operator">=</span>-DLIBTWOLAME_STATIC --extra-cxxflags<span class="token operator">=</span> --extra-ldflags<span class="token operator">=</span>-pthread --extra-ldexeflags<span class="token operator">=</span>-pie --extra-libs<span class="token operator">=</span><span class="token string">'-ldl -lgomp'</span> --extra-version<span class="token operator">=</span><span class="token number">20230503</span>libavutil      <span class="token number">58</span>.  <span class="token number">2.100</span> / <span class="token number">58</span>.  <span class="token number">2.100</span>libavcodec     <span class="token number">60</span>.  <span class="token number">3.100</span> / <span class="token number">60</span>.  <span class="token number">3.100</span>libavformat    <span class="token number">60</span>.  <span class="token number">3.100</span> / <span class="token number">60</span>.  <span class="token number">3.100</span>libavdevice    <span class="token number">60</span>.  <span class="token number">1.100</span> / <span class="token number">60</span>.  <span class="token number">1.100</span>libavfilter     <span class="token number">9</span>.  <span class="token number">3.100</span> /  <span class="token number">9</span>.  <span class="token number">3.100</span>libswscale      <span class="token number">7</span>.  <span class="token number">1.100</span> /  <span class="token number">7</span>.  <span class="token number">1.100</span>libswresample   <span class="token number">4</span>. <span class="token number">10.100</span> /  <span class="token number">4</span>. <span class="token number">10.100</span>libpostproc    <span class="token number">57</span>.  <span class="token number">1.100</span> / <span class="token number">57</span>.  <span class="token number">1.100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Auto-Builds"><a href="#Auto-Builds" class="headerlink" title="Auto-Builds"></a>Auto-Builds</h2><blockquote><p>自动构建</p></blockquote><p>Builds run daily at 12:00 UTC (or GitHubs idea of that time) and are automatically released on success.</p><blockquote><p>每天中午 12:00 UTC运行一次自动构建，并在成功时自动发布。</p></blockquote><p><strong>Auto-Builds run ONLY for win64 and linux(arm)64. There are no win32/x86 auto-builds, though you can produce win32 builds yourself following the instructions below.</strong></p><blockquote><p><strong>仅针对 win64 和 linux(arm64) 进行自动构建。没有 win32/x86 的自动构建，但您可以按照以下说明自行生成 win32 构建。</strong></p></blockquote><p><font color=red size=4><em><strong>忽略自动构建部分，自己构建问题太多。</strong></em></font></p><h3 id="Release-Retention-Policy"><a href="#Release-Retention-Policy" class="headerlink" title="Release Retention Policy"></a>Release Retention Policy</h3><blockquote><p>本仓库构建发布保留策略</p></blockquote><ul><li><p>The last build of each month is kept for two years.</p><blockquote><p>每个月的最后一个构建将保留两年。</p></blockquote></li><li><p>The last 14 daily builds are kept.</p><blockquote><p>保留最近的 14 天的构建。</p></blockquote></li><li><p>The special “latest” build floats and provides consistent URLs always pointing to the latest build.</p><blockquote><p>“latest” 构建始终指向最新的构建。</p></blockquote></li></ul><p>The linuxarm64 target will not build some dependencies due to lack of arm64 (aarch64) architecture support or cross-compiling restrictions.</p><blockquote><p>由于缺乏arm64 (aarch64)架构支持或交叉编译限制，linuxarm64目标将不构建某些依赖项。</p></blockquote><ul><li><code>davs2</code> and xavs2: aarch64 support is broken.</li><li><code>libmfx</code> and libva: Library for Intel QSV, so there is no aarch64 support.</li></ul><p>Available variants:</p><blockquote><p>本仓库可用的构建：</p></blockquote><p><font color=red size=4><em><strong>没有什么好推荐的，各人按照各人的需要自行选择，我选择的是gpl版本</strong></em></font></p><ul><li><p><code>gpl</code> Includes all dependencies, even those that require full <code>GPL</code> instead of just <code>LGPL</code>.</p><blockquote><p><code>gpl</code> 包括所有依赖项，即使那些需要完整的<code>GPL</code>而不是仅<code>LGPL</code>的依赖项。</p></blockquote></li><li><p><code>lgpl</code> Lacking libraries that are <code>GPL-only</code>. Most prominently <code>libx264</code> and <code>libx265</code>.</p><blockquote><p><code>lgpl</code> 缺少仅供<code>GPL</code>使用的库。最显著的是<code>libx264</code>和<code>libx265</code>。</p></blockquote></li><li><p><code>nonfree</code> Includes <code>fdk-aac</code> in addition to all the dependencies of the <code>gpl</code> variant.</p><blockquote><p><code>nonfree</code> 包括<code>gpl</code>变体的所有依赖项以及<code>fdk-aac</code>。</p></blockquote></li><li><p><code>gpl-shared</code> Same as <code>gpl</code>, but comes with the <code>libav*</code> family of shared libs instead of pure static executables.</p><blockquote><p><code>gpl-shared</code> 与<code>gpl</code>相同，但附带<code>libav*</code>家族的共享库而不是纯静态可执行文件。</p></blockquote></li><li><p><code>lgpl-shared</code> Same again, but with the <code>lgpl</code> set of dependencies.</p><blockquote><p><code>lgpl-shared</code> 再次相同，但附带<code>lgpl</code>集的依赖项。</p></blockquote></li><li><p><code>nonfree-shared</code> Same again, but with the <code>nonfree</code> set of dependencies.</p><blockquote><p><code>nonfree-shared</code> 再次相同，但附带<code>nonfree</code>集的依赖项。</p></blockquote></li></ul><p><a href="https://github.com/BtbN/FFmpeg-Builds/releases">下载列表</a></p><p><img src="/medias/img/ffmpeg/image0.png"></p><p>太多了根本截图不完</p><h2 id="安装配置GPU加速转码服务器"><a href="#安装配置GPU加速转码服务器" class="headerlink" title="安装配置GPU加速转码服务器"></a>安装配置GPU加速转码服务器</h2><blockquote><p>云服务器免安装GPU驱动(参考文末阿里云GPU服务器选型)，裸金属服务器需要安装驱动程序。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://ghproxy.com/https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-n6.0-latest-linux64-gpl-6.0.tar.xz<span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/12.1.1/local_installers/cuda_12.1.1_530.30.02_linux.run<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/nux-dextop.repo </span><span class="token punctuation">[</span>nux-dextop<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>Nux.Ro RPMs <span class="token keyword">for</span> general desktop use<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://li.nux.ro/download/nux/dextop/el7/<span class="token variable">$basearch</span>/ http://mirror.li.nux.ro/li.nux.ro/nux/dextop/el7/<span class="token variable">$basearch</span>/<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-nux.ro<span class="token assign-left variable">protect</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">[</span>nux-dextop-testing<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>Nux.Ro RPMs <span class="token keyword">for</span> general desktop use - testing<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://li.nux.ro/download/nux/dextop-testing/el7/<span class="token variable">$basearch</span>/<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-nux.ro<span class="token assign-left variable">protect</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">[</span>root@dev-gpu-node-02 lishuwei<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/cuda-rhel7.repo</span><span class="token punctuation">[</span>cuda-rhel7-x86_64<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>cuda-rhel7-x86_64<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/D42D0685.pub<span class="token punctuation">[</span>root@dev-gpu-node-02 lishuwei<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/elrepo.repo</span><span class="token comment">### Name: ELRepo.org Community Enterprise Linux Repository for el7</span><span class="token comment">### URL: https://elrepo.org/</span><span class="token punctuation">[</span>elrepo<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>ELRepo.org Community Enterprise Linux Repository - el7<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://elrepo.org/linux/elrepo/el7/<span class="token variable">$basearch</span>/    http://mirrors.coreix.net/elrepo/elrepo/el7/<span class="token variable">$basearch</span>/    http://mirror.rackspace.com/elrepo/elrepo/el7/<span class="token variable">$basearch</span>/    http://linux-mirrors.fnal.gov/linux/elrepo/elrepo/el7/<span class="token variable">$basearch</span>/<span class="token assign-left variable">mirrorlist</span><span class="token operator">=</span>http://mirrors.elrepo.org/mirrors-elrepo.el7<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org<span class="token assign-left variable">protect</span><span class="token operator">=</span><span class="token number">0</span>yum <span class="token function">install</span> kernel-develyum groupinstall <span class="token string">"KDE Plasma Workspaces"</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc kernel-headersyum <span class="token function">install</span> gcc-c++yum <span class="token function">install</span> <span class="token function">git</span>yum <span class="token function">install</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>epel dkmsyum <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> bzip2‐devel cmake freetype‐devel gccyum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">unzip</span> net-tools telnet lrzszyum <span class="token parameter variable">-y</span> <span class="token function">install</span> pcre-devel zlib-devel gcc gcc-c++ <span class="token function">make</span> openssl openssl-develyum <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> bzip2-devel cmake freetype-devel gcc gcc-c ++ <span class="token function">git</span> libtool <span class="token function">make</span> mercurial pkgconfig zlib-develyum <span class="token function">install</span> alsa-lib-devel <span class="token parameter variable">-y</span>yum <span class="token function">install</span> cuda-drivers <span class="token parameter variable">-y</span>yum <span class="token function">install</span> epel-releaseyum <span class="token function">install</span> <span class="token parameter variable">-y</span> kernel-headers kernel-devel dkmsyum <span class="token function">install</span> cuda-drivers <span class="token parameter variable">-y</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nvidia-driver-latest-dkmsyum <span class="token parameter variable">-y</span> <span class="token function">install</span> cudayum-config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-rhel7.repoyum <span class="token parameter variable">-y</span> <span class="token function">install</span> nvidia-driver-latest-dkmsyum <span class="token parameter variable">-y</span> <span class="token function">install</span> nvidia-driver-latest-dkmsyum remove dkmsyum remove nvidia-driver nvidia-driver-latest kmod-nvidia-open-dkms <span class="token parameter variable">-y</span>yum remove nvidia-driver nvidia-driver-latest kmod-nvidia-open-dkms <span class="token parameter variable">-y</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nvidia-driver-latest-dkmsyum remove nvidia-driver nvidia-driver-latest kmod-nvidia-open-dkms yum <span class="token function">install</span> cuda <span class="token parameter variable">-y</span>yum <span class="token function">install</span> ffmpeg ffmpeg-develyum <span class="token function">install</span> alsa-lib-devel <span class="token parameter variable">-y</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">install</span> gcc <span class="token function">make</span> gcc-c++ yasm yasm-devel cmake automake libtool graphviz xmlto nasm  libogg-devel libvorbis libvorbis-devel libvpx libvpx-devel libwebp-devel libass libass-develyum <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> cmake freetype-devel gcc gcc-c++ <span class="token function">git</span> libtool <span class="token function">make</span> mercurial pkgconfig zlib-develyum <span class="token function">install</span> opus opus-devel <span class="token parameter variable">-y</span>yum <span class="token function">install</span> pkgconfig <span class="token parameter variable">-y</span>yum list <span class="token operator">|</span> <span class="token function">grep</span> nvidia-driver-latest-dkms yum <span class="token function">install</span> nvidia-driver-latest-dkms cudayum repolist<span class="token operator">|</span><span class="token function">grep</span> cudayum list<span class="token operator">|</span><span class="token function">grep</span> cudayum list<span class="token operator">|</span><span class="token function">grep</span> cuda<span class="token operator">|</span><span class="token function">grep</span> <span class="token number">11.4</span>.4yum <span class="token function">install</span> nvidia-driver-latest-dkms cuda-11-4.x86_64 yum <span class="token parameter variable">-y</span> <span class="token function">install</span> x264yum <span class="token function">install</span> kernel-develyum groupinstall <span class="token string">"KDE Plasma Workspaces"</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc kernel-headersyum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc kernel-headersyum <span class="token function">install</span> gcc-c++yum <span class="token function">install</span> <span class="token function">git</span>yum <span class="token function">install</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>epel dkmsyum groupinstall <span class="token string">"KDE Plasma Workspaces"</span>yum <span class="token function">install</span> x11vncyum <span class="token function">install</span> daala-utilsyum <span class="token function">install</span> libdaala-devyum <span class="token function">install</span> pkg-configyum <span class="token function">install</span> libavutil-dev libavcodec-dev libswscale-dev libpostproc-dev libaom-dev libfdk-aac libfdk-aac-dev libvorbis-dev libmp3lame-dev libmp3lame-plugins-devyum <span class="token parameter variable">-y</span> <span class="token function">install</span> librariesyum <span class="token parameter variable">-y</span> <span class="token function">install</span> glibcyum <span class="token parameter variable">-y</span> <span class="token function">install</span> glibcyum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++yum <span class="token parameter variable">-y</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-ml.x86_64 kernel-ml-devel.x86_64yum <span class="token parameter variable">-y</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-ml.x86_64 kernel-ml-devel.x86_64yum remove kernel-ml kernel-ml-devel <span class="token parameter variable">-y</span>yum <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-lt kernel-lt-devel kernel-lt-tools-libs kernel-lt-tools kernel-lt-headersyum removd kernel-tools kernel-headers kernel-tools-libs <span class="token parameter variable">-y</span>yum remove kernel-tools kernel-headers kernel-tools-libs <span class="token parameter variable">-y</span>yum <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-lt kernel-lt-devel kernel-lt-tools-libs kernel-lt-tools kernel-lt-headersyum remove kernel-3.10.0*yum remove kernel-devel-3.10.0*yum <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-lt kernel-lt-devel kernel-lt-tools-libs kernel-lt-tools kernel-lt-headersyum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++ glibc-devel glibc-headersyum <span class="token parameter variable">-y</span> <span class="token function">install</span> python3 python3-develyum <span class="token function">install</span> nvidia-driver-latest-dkms cuda-11-4.x86_64 yumcd removd kernel-tools kernel-headers kernel-tools-libs <span class="token parameter variable">-y</span>yum update <span class="token parameter variable">-y</span>yum <span class="token function">install</span> nvidia-driver-latest-dkms cuda-11-4.x86_64yum <span class="token function">install</span> nvidia-driver-latest-dkms cuda-11-4.x86_64 <span class="token parameter variable">-y</span>yum <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-lt-4.4* kernel-lt-devel-4.4* kernel-lt-tools-libs-4.4* kernel-lt-tools-4.4* kernel-lt-headers-4.4*yum list kernel-lt <span class="token parameter variable">--showduplicate</span>  <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>yum <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span> list availableyum <span class="token parameter variable">-y</span> <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> bzip2-devel cmake freetype-devel gcc gcc-c ++ <span class="token function">git</span> libtool <span class="token function">make</span> mercurial pkgconfig zlib-develyum <span class="token parameter variable">-y</span> <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> bzip2-devel cmake freetype-devel gcc gcc-c + <span class="token function">git</span> libtool <span class="token function">make</span> mercurial pkgconfig zlib-develyum <span class="token parameter variable">-y</span> <span class="token function">install</span> autoconf automake <span class="token function">bzip2</span> bzip2-devel cmake freetype-devel gcc gcc-c++ <span class="token function">git</span> libtool <span class="token function">make</span> mercurial pkgconfig zlib-develyum <span class="token parameter variable">-y</span> <span class="token function">install</span> dkmsyum <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span> list availablyum <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span> list availablyum groupinstall <span class="token string">"Development Tools"</span> <span class="token parameter variable">-y</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> centos-release-sclyum <span class="token parameter variable">-y</span> <span class="token function">install</span> centos-release-sclyum <span class="token parameter variable">-y</span> <span class="token function">install</span> devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutilsyum remove cuda-*yum remove cuda-*yum remove nvidia-*yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nvidia-driver nvidia-settings nvidia-prime<span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> yumyum <span class="token parameter variable">-y</span> <span class="token function">install</span> kmod-nvidia-470xx.x86_64yum <span class="token parameter variable">-y</span> <span class="token function">install</span> dkmsyum <span class="token function">install</span> nvidia-detectyum search kmod-nvidiayum <span class="token parameter variable">-y</span> <span class="token function">install</span> kmod-nvidia-470xx.x86_64yum <span class="token function">install</span> ocl-icdyum remove ocl-icd opencl-filesystem <span class="token parameter variable">-y</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kmod-nvidia-470xx.x86_64yum remove nvidia-*yum  remove kmod-nvidia-*yum remove nvidia-*yum <span class="token parameter variable">-y</span> remove cuda-*yum <span class="token parameter variable">-y</span> reinstall dkms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="阿里云服务器"><a href="#阿里云服务器" class="headerlink" title="阿里云服务器"></a>阿里云服务器</h3><blockquote><p>仅用于个人学习<br>阿里云抢占式实例每小时约2元，前提要充值100元余额。可以随时提现<br>当然也可以选择华为云、腾讯云等相应的产品<br>一个小时的时间和1G流量足够使用了，如果你是新手应该多在虚拟机上练习安装，多看些其它网站博客教程，避免财产损失。</p><p>其它教程有写将CUDA驱动lib编译进ffmpeg。实际测试我并没有这样做。<br>我只在GPU裸金属服务器安装上了CUDA驱动，以yum的方式安装的(也可以运行cuda_12.1.1_530.30.02_linux.run安装)。在FFmpeg-Builds仓库下载了gpl的编译包。直接解压到了我的/usr/local/ffmpeg6目录，配置了一下PATH，或者直接使用/usr/local/ffmpeg6/bin/ffmpeg [参数1] [参数2] … 直接就可以使用GPU加速转码。</p></blockquote><p><img src="/medias/img/ffmpeg/image2.png"><br><img src="/medias/img/ffmpeg/image1.png"></p>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> ffmpeg </tag>
            
            <tag> ffmpeg6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Anolis 8</title>
      <link href="/posts/ae62755e.html"/>
      <url>/posts/ae62755e.html</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-e</span> <span class="token string">"/.init"</span><span class="token keyword">then</span>  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"已初始化过...<span class="token entity" title="\n">\n</span>退出脚本"</span>  <span class="token builtin class-name">exit</span> <span class="token number">100</span><span class="token keyword">fi</span><span class="token comment"># 卸载WEB控制台</span>dnf remove cockpit-* <span class="token parameter variable">-y</span><span class="token comment"># 安装基础工具软件</span>dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> lrzsz <span class="token function">vim</span> <span class="token function">wget</span> <span class="token function">git</span> bash-completion <span class="token function">zip</span> <span class="token function">unzip</span><span class="token comment"># 安装阿里云EPEL源</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|'</span> /etc/yum.repos.d/epel*<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|^metalink|#metalink|'</span> /etc/yum.repos.d/epel*<span class="token comment"># 更新</span><span class="token comment"># dnf install openvpn -y</span>dnf update <span class="token parameter variable">-y</span><span class="token comment"># 关闭防火墙</span><span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/configsetenforce <span class="token number">0</span>systemctl stop firewalldsystemctl disable firewalld<span class="token comment"># vim各人优化各人的</span><span class="token builtin class-name">echo</span> <span class="token string">'alias vi=vim'</span> <span class="token operator">>></span> /etc/profile<span class="token function">cat</span> <span class="token operator">>></span> /etc/vimrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFset tabstop=4set shiftwidth=4set expandtabset numberset pastetoggle=&lt;F9>set pasteEOF</span><span class="token comment"># 系统优化</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF# 开启SYN Cookies，当SYN等待队列溢出时，启用cookies来处理，可以防范少量的SYN攻击，默认为0，表示关闭net.ipv4.tcp_syncookies = 1# 允许将TIME_WAIT sockets重新用于新的TCP连接，默认为0，表示关闭net.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_timestamps = 1# 设置TCP三次请求的fin状态超时net.ipv4.tcp_fin_timeout = 30# 设置TCP 发送keepalive的频度，默认的缺省为2小时，600秒表示10分钟，表示服务器以10分钟发送keepalive消息net.ipv4.tcp_keepalive_time = 600# 探测包发送的时间间隔设置为2秒，默认75秒net.ipv4.tcp_keepalive_intvl = 2# 如果对方不给予应答，探测包发送的次数，默认9次net.ipv4.tcp_keepalive_probes = 2# 设置本地端口范围，缺省情况下: 32768到61000，现在改为 1024 到 65000，最小值不能设置太低,否则占用了正常端口net.ipv4.ip_local_port_range = 1024 65000# 表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多的网络连接数net.ipv4.tcp_max_syn_backlog = 8192# 设置保持TIME_WAIT的最大数量，如果超过这个数量，TIME_WAIT将立刻清楚并打印警告信息，默认为180000，改为5000.此项参数可以控制TIME_WAIT的最大数量,避免Squid服务器被大量的TIME_WAIT拖死net.ipv4.tcp_max_tw_buckets = 5000# 表示SYN队列的长度，选项为服务器端用于记录那些尚未收到客户端确认信息的连接请求的最大值，该参数对应系统路径为: /proc/sys/net/ipv4/tcp_max_syn_backlognet.ipv4.tcp_max_syn_backlog = 4096# 增加tcp缓冲区大小，tcp_rmem表示接受数据缓冲区范围，tcp_wmem表示发送数据缓冲区范围，单位Byte，最大64Mnet.ipv4.tcp_rmem = 4096 87380 67108864net.ipv4.tcp_wmem = 4096 65536 67108864# TCP失败重传次数,默认值15，意味着重传15次才彻底放弃，可减少到5，以尽早释放内核资源net.ipv4.tcp_retries2 = 5# 选项默认值是128，这个参数用于调节系统同时发起的tcp连接数，在高并发请求中，默认的值可能会导致连接超时或重传，因此，需要结合并发请求数来调节此值。该参数对应系统路径为: /proc/sys/net/core/somaxconn 128net.core.somaxconn = 4096EOF</span><span class="token function">sysctl</span> <span class="token parameter variable">-p</span><span class="token comment"># 时间同步 设置时区</span><span class="token builtin class-name">echo</span> <span class="token string">"*/30 * * * * /usr/bin/chronyc sources -v > /dev/null 2>&amp;1"</span> <span class="token operator">>></span> /tmp/.txt<span class="token function">crontab</span> /tmp/.txtsystemctl restart crond.servicetimedatectl set-timezone Asia/Shanghai/usr/sbin/hwclock <span class="token parameter variable">--systohc</span>/usr/sbin/hwclock <span class="token parameter variable">-w</span><span class="token comment"># 系统打开文件数</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF* soft nofile 190000* hard nofile 200000* soft nproc 252144* hadr nproc 262144EOF</span><span class="token comment"># history命令记录</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/bashrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTFILESIZE=10000HISTSIZE=100HISTTIMEFORMAT='%F %T 'export HISTTIMEFORMATEOF</span><span class="token comment"># 取消系统mail</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTSIZE=100PROMPT_COMMAND="history -a"shopt -s histappendunset MAILCHECKEOF</span><span class="token builtin class-name">source</span> /etc/profile<span class="token comment"># 各人配置各人的hosts</span><span class="token function">cat</span> <span class="token operator">></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF127.0.0.1    localhost localhost.localdomain192.168.1.9  nas nas.domain.com minio minio.domain.com192.168.1.10 nginx minio.domain.com gitlab.domain.com192.168.1.11 redis redis.domain.com192.168.1.12 mysql mysql.domain.com192.168.1.13 nacos nacos.domain.com192.168.1.14 emqx emqx.domain.comEOF</span><span class="token comment"># openvpn systemctl启动文件</span><span class="token comment"># cat >> /usr/lib/systemd/system/openvpn@.service &lt;&lt; EOF</span><span class="token comment"># [Unit]</span><span class="token comment"># Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I</span><span class="token comment"># After=network.target</span><span class="token comment"># [Service]</span><span class="token comment"># Type=notify</span><span class="token comment"># PrivateTmp=true</span><span class="token comment"># ExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf</span><span class="token comment"># [Install]</span><span class="token comment"># WantedBy=multi-user.target</span><span class="token comment"># EOF</span><span class="token comment"># ssh配置优化</span>cat<span class="token operator">></span>/etc/ssh/sshd_config<span class="token operator">&lt;&lt;</span><span class="token string">EOFPort 22AllowUsers roxn app dev root   # 这里是允许登录的用户白名单，备份ssh配置文件哦HostKey /etc/ssh/ssh_host_rsa_keyHostKey /etc/ssh/ssh_host_ecdsa_keyHostKey /etc/ssh/ssh_host_ed25519_keySyslogFacility AUTHPRIVLogLevel INFOLoginGraceTime 60PermitRootLogin yes   # 修改为no禁止root登录MaxAuthTries 4MaxSessions 10AuthorizedKeysFile    .ssh/authorized_keysHostbasedAuthentication noIgnoreRhosts yesPermitEmptyPasswords noPasswordAuthentication noChallengeResponseAuthentication noGSSAPIAuthentication yesGSSAPICleanupCredentials noUsePAM yesX11Forwarding yesPrintMotd noPermitUserEnvironment noClientAliveInterval 900ClientAliveCountMax 0UseDNS noAcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGESAcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENTAcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGEAcceptEnv XMODIFIERSSubsystem    sftp    /usr/libexec/openssh/sftp-serverEOF</span>systemctl restart sshd<span class="token comment"># roxn 特权用户</span><span class="token function">cat</span> <span class="token operator">>></span>/etc/sudoers.d/roxn<span class="token operator">&lt;&lt;</span><span class="token string">EOFroxn ALL=(ALL) NOPASSWD:ALLEOF</span><span class="token comment"># 三权分立，特权用户roxn，开发用户dev，服务运行用户app</span><span class="token function">useradd</span> app<span class="token function">useradd</span> dev<span class="token function">useradd</span> roxn<span class="token function">mkdir</span> /home/roxn/.ssh <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> <span class="token number">700</span> /home/roxn/.ssh<span class="token comment"># roxn用户公钥导入目标主机</span><span class="token function">cat</span> <span class="token operator">></span> /home/roxn/.ssh/authorized_keys<span class="token operator">&lt;&lt;</span><span class="token string">EOFssh-rsa AAAA............... jumpEOF</span><span class="token function">chmod</span> <span class="token number">600</span> /home/roxn/.ssh/authorized_keys<span class="token function">chown</span> roxn. /home/roxn/.ssh <span class="token parameter variable">-R</span><span class="token comment"># 标记，禁止二次初始化</span><span class="token function">touch</span> /.init<span class="token comment"># 安装VMware tools</span><span class="token comment"># mount /dev/cdrom /mnt</span><span class="token comment"># cd /tmp/</span><span class="token comment"># cp /mnt/VMwareTools-10.3.24-18733423.tar.gz .</span><span class="token comment"># tar xf VMwareTools-10.3.24-18733423.tar.gz</span><span class="token comment"># ./vmware-tools-distrib/vmware-install.pl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> anolis </tag>
            
            <tag> 系统优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(十二)</title>
      <link href="/posts/99b042e9.html"/>
      <url>/posts/99b042e9.html</url>
      
        <content type="html"><![CDATA[<h1 id="匿名函数：定义函数时不需要定义函数名"><a href="#匿名函数：定义函数时不需要定义函数名" class="headerlink" title="匿名函数：定义函数时不需要定义函数名"></a>匿名函数：定义函数时不需要定义函数名</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> x <span class="token operator">+</span> yf <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>f1 <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y<span class="token punctuation">:</span> x<span class="token operator">+</span>y   <span class="token comment"># 匿名函数定义（其它语言：称为lambda表达式"lambda parameter_list: expression"）</span><span class="token comment"># f1 = lambda x,y: a=x+y   不能写a=x+y，只能是表达式，不能是代码块</span><span class="token keyword">print</span><span class="token punctuation">(</span>f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="三元表达式（表达式版本的if-else）"><a href="#三元表达式（表达式版本的if-else）" class="headerlink" title="三元表达式（表达式版本的if/else）"></a>三元表达式（表达式版本的if/else）</h1><blockquote><p>x &gt; y ? x : y   # 其他语言的三元表达式：比较x&gt;y 为真(?) 返回x : 否则返回y</p></blockquote><blockquote><p>python三元表达式：条件为真时返回的结果 if 条件判断 else 条件为假时返回的结果(x if x&gt;y else y)</p></blockquote><p>闭包应用场景：不建议在业务代码里大量使用闭包；写框架、包、类库的时候可以尝试写一下闭包</p><h1 id="函数式编程推荐用法"><a href="#函数式编程推荐用法" class="headerlink" title="函数式编程推荐用法"></a>函数式编程推荐用法</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>list_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>list_y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">square</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> x <span class="token operator">*</span> xr <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>square<span class="token punctuation">,</span> list_x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="lambda不能让代码运行速度变快，只能让代码更简洁"><a href="#lambda不能让代码运行速度变快，只能让代码更简洁" class="headerlink" title="lambda不能让代码运行速度变快，只能让代码更简洁"></a>lambda不能让代码运行速度变快，只能让代码更简洁</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>list_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>r <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">*</span>x<span class="token punctuation">,</span> list_x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>list_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>list_y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>   <span class="token comment"># 传入的参数个数要注意相等，如果不相等，不会报错，会按最少参数的变量走。</span>r <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token punctuation">,</span> list_x<span class="token punctuation">,</span> list_y<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="reduce-连续的计算，连续调用lambda"><a href="#reduce-连续的计算，连续调用lambda" class="headerlink" title="reduce(连续的计算，连续调用lambda)"></a>reduce(连续的计算，连续调用lambda)</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>list_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>r <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y<span class="token punctuation">:</span>x<span class="token operator">+</span>y<span class="token punctuation">,</span>list_x<span class="token punctuation">)</span><span class="token comment"># 第一次调用x=1，y=2，第二次调用，x=x+y，y=3，第三次调用，x=x+y，y=4依此类推。相当于(((((((1+2)+3)+4)+5)+6)+7)+8)=36</span>r1 <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y<span class="token punctuation">:</span>x<span class="token operator">+</span>y<span class="token punctuation">,</span>list_x<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>   <span class="token comment"># 这里是((((10+1)+2)+3)...+8)=46</span>r2 <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y<span class="token punctuation">:</span>x<span class="token operator">+</span>y<span class="token punctuation">,</span>list_x<span class="token punctuation">,</span><span class="token string">'aa'</span><span class="token punctuation">)</span>   <span class="token comment"># 这里结果为'aa112345678'</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Google提出的大数据计算模型–map/reduce，是一种编程模型，map是映射；reduce规约；用于大数据并行计算。</p><h2 id="filter-过滤"><a href="#filter-过滤" class="headerlink" title="filter(过滤)"></a>filter(过滤)</h2><p>函数式编程&amp;命令式编程（lisp函数式编程的鼻祖，在人工智能领域应用的是比较多的）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>list_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>r <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token boolean">True</span> <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token boolean">False</span><span class="token punctuation">,</span> list_x<span class="token punctuation">)</span>   <span class="token comment"># filter的lambda表达式返回结果为True/False，能表示True/False的返回结果就行（比如0/1）</span>r1 <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">,</span> list_x<span class="token punctuation">)</span>   <span class="token comment"># 因为这里x取值只有0/1，x为0就是False，x为1就是True</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="装饰器-python进阶中使用较多的"><a href="#装饰器-python进阶中使用较多的" class="headerlink" title="装饰器(python进阶中使用较多的)"></a>装饰器(python进阶中使用较多的)</h2><blockquote><p>对修改是封闭的，对扩展是开放的–编写代码的封闭原则</p></blockquote><blockquote><p>通过扩展一个函数/类，来解决需求变更的问题</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># unix时间戳（格林威治时间1970/01/01 00:00:00到执行此段话的总秒数；现在距格林威治时间多少秒）</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function2'</span><span class="token punctuation">)</span><span class="token comment"># 下面定义函数没有体现与f1/f2相关联</span><span class="token keyword">def</span> <span class="token function">print_current_time</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    func<span class="token punctuation">(</span><span class="token punctuation">)</span>print_current_time<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>print_current_time<span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token comment"># 上面定义函数,和下面的几乎没有区别</span><span class="token comment"># print(time.time())</span><span class="token comment"># f1()</span><span class="token comment"># print(time.time())</span><span class="token comment"># f2()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="这里就是装饰器-没啥价值"><a href="#这里就是装饰器-没啥价值" class="headerlink" title="这里就是装饰器(没啥价值)"></a>这里就是装饰器(没啥价值)</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token comment"># 这里也没有体现与f2相关联</span><span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>f <span class="token operator">=</span> decorator<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="装饰器的灵魂"><a href="#装饰器的灵魂" class="headerlink" title="装饰器的灵魂"></a>装饰器的灵魂</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span>   <span class="token comment"># 装饰器的灵魂</span><span class="token comment"># @+装饰器的名字，使用@decorator不改变调用方式直接使用f1()调用</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 下面两行是原来的调用方式</span><span class="token comment"># f = decorator(f1)</span><span class="token comment"># f()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>python中的装饰器引用了AOP的编程思想</p><h2 id="在装饰器中调用参数"><a href="#在装饰器中调用参数" class="headerlink" title="在装饰器中调用参数"></a>在装饰器中调用参数</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 这里也要存在f1定义的参数</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span>func_name<span class="token punctuation">)</span>   <span class="token comment"># 传参</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义一个func_name参数</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name<span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'test func'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面函数执行流程：</p><ol><li><p>加载python内置的time函数</p></li><li><p>到decorator（装饰器）方法</p></li><li><p>直接到@decorator这个装饰器</p></li><li><p>这时候执行decorator方法的函数体（这里是一个wrapper函数）</p></li><li><p>直接到return wrapper</p></li><li><p>直接到f1()函数调用/执行这里</p></li><li><p>下面才是执行wrapper函数/方法里面的函数体print()、func()</p></li><li><p>最后是f1方法里面的函数体print() def f1(func_name):此段没有走，但是走了此方法下的函数体和函数调用</p></li></ol><h1 id="扩展：-后面传入元祖-后面传入字典，哥们提供，未验证。"><a href="#扩展：-后面传入元祖-后面传入字典，哥们提供，未验证。" class="headerlink" title="扩展：*后面传入元祖**后面传入字典，哥们提供，未验证。"></a>扩展：*后面传入元祖**后面传入字典，哥们提供，未验证。</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 可变参数(这里*args是其它语言通用写法，可以是别的*单词，表示任意参数/任意参数个数),遵循封闭原则。</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 利用装饰器的可变参数定义一个参数名</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span>func_name1<span class="token punctuation">,</span> func_name2<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 利用可变参数定义多个参数</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name1<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name2<span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'test func'</span><span class="token punctuation">)</span>f2<span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">)</span>    <span class="token comment"># 调用这里要和定义保持一致</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="python里面使用-args，和-kw"><a href="#python里面使用-args，和-kw" class="headerlink" title="python里面使用*args，和**kw"></a>python里面使用*args，和**kw</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span>func_name1<span class="token punctuation">,</span> func_name2<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name1<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name2<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f3</span><span class="token punctuation">(</span>func_name3<span class="token punctuation">,</span> func_name4<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># **kw关键字参数(key word)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name3<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name4<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>kw<span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'test func'</span><span class="token punctuation">)</span>f2<span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">)</span>f3<span class="token punctuation">(</span><span class="token string">'name3'</span><span class="token punctuation">,</span> <span class="token string">'name4'</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>装饰器最基本的思想：</p><p>如果我们对某一个被封装的单元（比如说函数），做出代码上的修改，我们可以不去具体的实现，而是通过装饰器的这种形式，来改变函数的行为—-代码的稳定性</p><p>比如说打印时间这个功能，是我们新增的一个逻辑，我们把这个逻辑封装成一个装饰器，凡是需要有打印时间功能的函数，可以通过 @装饰器名 来加在要打印时间的函数上面—-代码的复用性</p><h1 id="没有可变参数和关键字参数的情况："><a href="#没有可变参数和关键字参数的情况：" class="headerlink" title="没有可变参数和关键字参数的情况："></a>没有可变参数和关键字参数的情况：</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>i<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span>q<span class="token punctuation">,</span>i<span class="token punctuation">,</span>p<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>we<span class="token punctuation">,</span>qw<span class="token punctuation">,</span>da<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'we'</span><span class="token punctuation">,</span><span class="token string">'qw'</span><span class="token punctuation">,</span><span class="token string">'da'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="几个例子，装饰器的作用"><a href="#几个例子，装饰器的作用" class="headerlink" title="几个例子，装饰器的作用"></a>几个例子，装饰器的作用</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># flask框架</span><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test_javasctipt_http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> p<span class="token punctuation">,</span> <span class="token number">200</span><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/psw'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@auth<span class="token punctuation">.</span>login_required</span><span class="token keyword">def</span> <span class="token function">get_psw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'psw'</span><span class="token punctuation">)</span>    r <span class="token operator">=</span> generate_password_hash<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'aaaaaa'</span><span class="token punctuation">,</span> <span class="token number">200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="以下为菜鸟笔记"><a href="#以下为菜鸟笔记" class="headerlink" title="以下为菜鸟笔记"></a>以下为菜鸟笔记</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"yasoob"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"now you are in the greet() function"</span>    <span class="token keyword">def</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"now you are in the welcome() function"</span>    <span class="token comment"># 每次运行只解开一段if/else语句，对比不同。</span>    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">"yasoob"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> greet<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 这里返回的是greet()</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> welcome<span class="token punctuation">(</span><span class="token punctuation">)</span>a <span class="token operator">=</span> hi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token comment">#     if name == "yasoob":</span><span class="token comment">#         return greet   # 这里返回的是greet</span><span class="token comment">#     else:</span><span class="token comment">#         return welcome</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">print(hi()())   # 仔细看这里和上面的不同，上面是返回greet()，所以打印的是hi()，而这里返回的是greet,所以是hi()()查询到的资料：再次看看这个代码。在 if&#x2F;else 语句中我们返回 greet 和 welcome，而不是 greet() 和 welcome()。为什么那样？这是因为当你把一对小括号放在后面，这个函数就会执行；然而如果你不放括号在它后面，那它可以被到处传递，并且可以赋值给别的变量而不去执行它。 你明白了吗？让我再稍微多解释点细节。当我们写下 a &#x3D; hi()，hi() 会被执行，而由于 name 参数默认是 yasoob，所以函数 greet 被返回了。如果我们把语句改为 a &#x3D; hi(name &#x3D; &quot;ali&quot;)，那么 welcome 函数将被返回。我们还可以打印出 hi()()，这会输出 now you are in the greet() function。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="装饰器释义"><a href="#装饰器释义" class="headerlink" title="装饰器释义"></a>装饰器释义</h1><p>以下只涉及装饰器和函数调用</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 第一步将此加载到内存（个人理解：python脚本运行的时候，会先把类和函数加载到内存中，利用pycharm调试模式验证）</span>    <span class="token keyword">return</span> <span class="token string">"hi yasoob!"</span>  <span class="token comment"># 第六步，众所周知，这里被执行是因为第五步调用了hi()方法。</span><span class="token keyword">def</span> <span class="token function">doSomethingBeforeHi</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 第二步，将此加载到内存，参考一。</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work before executing hi()"</span><span class="token punctuation">)</span>  <span class="token comment"># 第四步，第三步调用的是此函数/方法，给的参数是hi，</span>    <span class="token comment"># 这时候func=hi（如果第三步给的是其它字符串str，例如'ha'，这里就是func='ha'，注意第五步）</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 第五步，因为第四步，我们知道func=hi，所以这里func()就变成hi()了，上面定义的hi()函数被调用,</span>    <span class="token comment"># 这时候看第四步，如果是上面说的func='ha'，这里就会变成'ha'()，执行就会报错，字符串变成了一个函数？？？</span>doSomethingBeforeHi<span class="token punctuation">(</span>hi<span class="token punctuation">)</span>  <span class="token comment"># 第三步，将函数调用加载到内存（利用pycharm调试模式，得到的结果，先加载函数体，再加载函数调用）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="这里就是装饰器-没啥价值的装饰器"><a href="#这里就是装饰器-没啥价值的装饰器" class="headerlink" title="这里就是装饰器(没啥价值的装饰器)"></a>这里就是装饰器(没啥价值的装饰器)</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time  <span class="token comment"># 加载内置time方法</span><span class="token comment"># 这里也没有体现与f2相关联，这里的f2参考 函数式编程.py 文档</span><span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 定义decorator方法，内置func参数；这里被下文 f 调用了传入参数是f1，注一！</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 定义wrapper方法；接注五，此方法被执行了。</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 获取时间戳；接注二，这里会先被执行，打印时间戳。注三！</span>        func<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 函数调用，靠别人传参调用；接注一，所以这里是f1()，注二！</span>    <span class="token keyword">return</span> wrapper  <span class="token comment"># 返回wrapper，这里是decorator的函数体（包括wrapper方法），当decorator方法被调用的时候，才会返回wrapper</span><span class="token comment"># 接注三，return wrapper，返回时间戳。注意这里是wrapper，，不是wrapper()，</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 定义f1方法</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>  <span class="token comment"># f1的函数体；接注一，注一那里调用了f1()方法，此段被执行</span>f <span class="token operator">=</span> decorator<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>  <span class="token comment"># 这里调用了decorator方法，传入的参数是f1函数；同时把decorator()结果赋值给f，结果是return wrapper；注四！</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 接注四，结果为f=wrapper，这里就变成f()=wrapper()，注五！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比有无@decorator的区别：没有的时候，需要把f1作为参数，传递给decorator，然后把执行结果交给f，最后在执行一遍f()</p><p>有了@decorator之后：可以直接调用f1()，如果没有@decorator，只是执行f1()函数而已，不会去调用装饰器。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 注：上面两个注释太多了，弄懂之后，下面就不需要太多注释</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span>  <span class="token comment"># 装饰器的灵魂</span><span class="token comment"># @+装饰器的名字，使用@decorator不改变调用方式直接使用f1()调用</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 下面两行是原来的调用方式</span><span class="token comment"># f = decorator(f1)</span><span class="token comment"># f()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="在装饰器中调用参数-1"><a href="#在装饰器中调用参数-1" class="headerlink" title="在装饰器中调用参数"></a>在装饰器中调用参数</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 这里是传入的f1，所以func=f1</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 这里也要有形参，参考注一，如果f1()被调用，一定是有实参的。</span>        <span class="token comment"># 通过上面的两个例子我们知道，这里是被wrapper('实参')调用的，所以这里必须有形参。</span>        <span class="token comment"># 参考文末实参形参的区别（这里遵循第3条，参数的一致性）</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span>func_name<span class="token punctuation">)</span>   <span class="token comment"># 这里是f1()，这样就解释了为什么wrapper那里要加参数，因为下文调用时是f1('test func')</span>    <span class="token keyword">return</span> wrapper   <span class="token comment"># 这里返回decorator(f1)的结果</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># f1函数内置了func_name参数（同事提供：这里可以填入约束形参的类型str之类）</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name<span class="token punctuation">)</span>   <span class="token comment"># 打印'This is a function ' + func_name</span>f1<span class="token punctuation">(</span><span class="token string">'test func'</span><span class="token punctuation">)</span>   <span class="token comment"># 调用必须传入实参，注一！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><p>可变参数<em>args，</em>后面可以是其它，*a,*b等等，这样以后调用，不用更改装饰器的内容（遵循开闭原则，Just a suggestion）</p><p>扩展：*后面传入元祖**后面传入字典，哥们提供，未验证。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 可变参数(这里*args是其它语言通用写法，可以是别的*单词，表示任意参数/任意参数个数),遵循开闭原则。</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 利用装饰器的可变参数定义一个参数名</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span>func_name1<span class="token punctuation">,</span> func_name2<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 利用可变参数定义多个参数</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name1<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function '</span> <span class="token operator">+</span> func_name2<span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'test func'</span><span class="token punctuation">)</span>f2<span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">)</span>  <span class="token comment"># 调用这里要和定义保持一致</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="没有使用可变参数的情况"><a href="#没有使用可变参数的情况" class="headerlink" title="没有使用可变参数的情况"></a>没有使用可变参数的情况</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> i<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span>q<span class="token punctuation">,</span> i<span class="token punctuation">,</span> p<span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token decorator annotation punctuation">@decorator</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>we<span class="token punctuation">,</span> qw<span class="token punctuation">,</span> da<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>f1<span class="token punctuation">(</span><span class="token string">'we'</span><span class="token punctuation">,</span> <span class="token string">'qw'</span><span class="token punctuation">,</span> <span class="token string">'da'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外：没有 不使用@decorator，多次调用，一次传入多个函数的 示例</p><h1 id="附加"><a href="#附加" class="headerlink" title="附加"></a>附加</h1><p>形参和实参的区别:</p><ul><li><p>形参出现在函数定义中，在整个函数体内都可以使用， 离开该函数则不能使用。</p></li><li><p>实参出现在主调函数中，进入被调函数后，实参变量也不能使用。 </p></li><li><p>形参和实参的功能是作数据传送。发生函数调用时， 主调函数把实参的值传送给被调函数的形参从而实现主调函数向被调函数的数据传送。</p></li></ul><ol><li><p>形参变量只有在被调用时才分配内存单元，在调用结束时， 即刻释放所分配的内存单元。因此，形参只有在函数内部有效。 函数调用结束返回主调函数后则不能再使用该形参变量。 </p></li><li><p>实参可以是常量、变量、表达式、函数等， 无论实参是何种类型的量，在进行函数调用时，它们都必须具有确定的值， 以便把这些值传送给形参。 因此应预先用赋值，输入等办法使实参获得确定值。 </p></li><li><p>实参和形参在数量上，类型上，顺序上应严格一致， 否则会发生“类型不匹配”的错误。 </p></li><li><p>函数调用中发生的数据传送是单向的。 即只能把实参的值传送给形参，而不能把形参的值反向地传送给实参。 因此在函数调用过程中，形参的值发生改变，而实参中的值不会变化。</p></li><li><p>当形参和实参不是指针类型时，在该函数运行时，形参和实参是不同的变量，他们在内存中位于不同的位置，形参将实参的内容复制一份，在该函数运行结束的时候形参被释放，而实参内容不会改变。</p></li></ol><p>而如果函数的参数是指针类型变量,在调用该函数的过程中，传给函数的是实参的地址，在函数体内部使用的也是实参的地址，即使用的就是实参本身。所以在函数体内部可以改变实参的值。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 函数式编程 </tag>
            
            <tag> 装饰器 </tag>
            
            <tag> 形参和实参 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(十一)</title>
      <link href="/posts/3681d98b.html"/>
      <url>/posts/3681d98b.html</url>
      
        <content type="html"><![CDATA[<h1 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1><h2 id="枚举的意义在于它的标签，不在于它的取值"><a href="#枚举的意义在于它的标签，不在于它的取值" class="headerlink" title="枚举的意义在于它的标签，不在于它的取值"></a>枚举的意义在于它的标签，不在于它的取值</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>YELLOW<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实现枚举的功能"><a href="#实现枚举的功能" class="headerlink" title="实现枚举的功能"></a>实现枚举的功能</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>yellow <span class="token operator">=</span> <span class="token number">1</span>green <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">&#123;</span><span class="token string">'yellow'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 最贴近枚举</span><span class="token keyword">class</span> <span class="token class-name">TypeDiamond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    yellow <span class="token operator">=</span> <span class="token number">1</span>    green <span class="token operator">=</span> <span class="token number">2</span><span class="token comment"># 缺点：可变、没有防止相同标签的功能</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="枚举的类型、枚举的值、枚举的名字"><a href="#枚举的类型、枚举的值、枚举的名字" class="headerlink" title="枚举的类型、枚举的值、枚举的名字"></a>枚举的类型、枚举的值、枚举的名字</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment"># 枚举类型VIP</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment"># 枚举标签 = 枚举值</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span>    <span class="token comment"># RED = 5   相同标签</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>YELLOW<span class="token punctuation">)</span><span class="token comment"># VIP.YELLOW = 5    对YELLOW赋值，改变YELLOW</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>GREEN<span class="token punctuation">.</span>value<span class="token punctuation">)</span>    <span class="token comment"># 打印标签的值</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>GREEN<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 这是一个字符串</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>GREEN<span class="token punctuation">.</span>name<span class="token punctuation">)</span>   <span class="token comment"># 标签的名字</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>VIP<span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 这是enum的类型（枚举类型）</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">[</span><span class="token string">'GREEN'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 枚举类['枚举名称']，打印具体的枚举的类型VIP.GREEN</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="枚举的遍历，for循环"><a href="#枚举的遍历，for循环" class="headerlink" title="枚举的遍历，for循环"></a>枚举的遍历，for循环</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span class="token keyword">for</span> v <span class="token keyword">in</span> VIP<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="枚举之间的比较"><a href="#枚举之间的比较" class="headerlink" title="枚举之间的比较"></a>枚举之间的比较</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span class="token keyword">class</span> <span class="token class-name">VIP1</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span>result <span class="token operator">=</span> VIP<span class="token punctuation">.</span>GREEN <span class="token operator">==</span> VIP<span class="token punctuation">.</span>RED     <span class="token comment"># 枚举之间比较返回bool值</span>result1 <span class="token operator">=</span> VIP<span class="token punctuation">.</span>GREEN <span class="token operator">==</span> VIP<span class="token punctuation">.</span>GREEN<span class="token comment"># result2 = VIP.GREEN > VIP.RED   # 不可以这样比较</span>result3 <span class="token operator">=</span> VIP<span class="token punctuation">.</span>GREEN <span class="token operator">==</span> <span class="token number">2</span>   <span class="token comment"># 等值比较</span>result4 <span class="token operator">=</span> VIP<span class="token punctuation">.</span>GREEN <span class="token keyword">is</span> VIP<span class="token punctuation">.</span>GREEN   <span class="token comment"># 枚举之间可以进行身份比较</span>result5 <span class="token operator">=</span> VIP<span class="token punctuation">.</span>GREEN <span class="token operator">==</span> VIP1<span class="token punctuation">.</span>GREEN   <span class="token comment"># 不同枚举类型不能比较</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="枚举的注意事项"><a href="#枚举的注意事项" class="headerlink" title="枚举的注意事项"></a>枚举的注意事项</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment"># 这里GREEN是YELLOW的别名，GREEN最好更改为YELLOW_ALIAS。在使用for遍历的时候，此行不会出现。</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span class="token comment"># print(VIP.GREEN)   # 这里结果为VIP.YELLOW</span><span class="token keyword">for</span> v <span class="token keyword">in</span> VIP<span class="token punctuation">:</span>    <span class="token comment">#遍历不会打印出GREEN。</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token comment"># 想要遍历GREEN的方法：</span><span class="token comment"># for v in VIP.__members__.items():   # 调用items方法，会打印出一个元组，是包括GREEN的</span>    <span class="token comment"># print(v)</span><span class="token comment"># for v in VIP.__members__:    # 不想要元组，可以不用items方法，这样的结果为枚举的标签的名称。</span>    <span class="token comment"># print(v)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>平常使用枚举经常遇到的问题</p><ol><li><p>在数据库里存储数值表示枚举类型，和存储标签名表示枚举类型。</p></li><li><p>建议使用数字表示（简洁，占空间小）</p></li><li><p>在代码里面用数字代表枚举类型，不建议。</p></li><li><p>建议在代码里面显式的定义一个枚举类，用枚举类下面的每一个枚举类型来对应数据库的每一个数值</p></li></ol><p><strong>例如：</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> a<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment">#不建议</span>    <span class="token keyword">pass</span><span class="token keyword">if</span> a<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span class="token keyword">if</span> a<span class="token operator">==</span>VIP<span class="token punctuation">.</span>YELLOW<span class="token punctuation">:</span>   <span class="token comment">#建议这样</span>    <span class="token keyword">pass</span><span class="token keyword">if</span> a<span class="token operator">==</span>VIP<span class="token punctuation">.</span>BLACK<span class="token punctuation">:</span>    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="如何把数字转换成枚举类型"><a href="#如何把数字转换成枚举类型" class="headerlink" title="如何把数字转换成枚举类型"></a>如何把数字转换成枚举类型</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">2</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span class="token keyword">class</span> <span class="token class-name">Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span>VIP<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="枚举-1"><a href="#枚举-1" class="headerlink" title="枚举"></a>枚举</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> IntEnum<span class="token punctuation">,</span>unique   <span class="token comment"># IntEnum要求必须是整型，Enum没有限制</span><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token decorator annotation punctuation">@unique</span>    <span class="token comment"># 引入uniqe使用IntEnum的时候，不同标签的值不同会报错。</span><span class="token keyword">class</span> <span class="token class-name">VIP</span><span class="token punctuation">(</span>IntEnum<span class="token punctuation">)</span><span class="token punctuation">:</span>    YELLOW <span class="token operator">=</span> <span class="token number">1</span>    GREEN <span class="token operator">=</span> <span class="token number">1</span>    BLACK <span class="token operator">=</span> <span class="token number">3</span>    RED <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>枚举类型在python中实现的是一种单例模式，也就是说对枚举类型是不能实例化的，对枚举实例化没有意义</p><p>23种设计模式  单例模式</p><h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><blockquote><p>函数：在python中是对象，在其它语言只是一段可执行的代码</p></blockquote><blockquote><p>python：一切皆对象</p></blockquote><blockquote><p>python可以把函数当作一个参数，传递给另一个函数里。</p></blockquote><blockquote><p>也可以把一个函数，当作另外一个函数的返回结果</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token string">'2'</span>c <span class="token operator">=</span> <span class="token string">'def'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">curve_pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义curve_pre函数</span>    <span class="token keyword">def</span> <span class="token function">curve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义curve函数</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a function'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> curve   <span class="token comment"># 在curve_pre函数中调用curve函数</span>f <span class="token operator">=</span> curve_pre<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 调用curve_pre函数（直接写curve_pre是没有内容的，因为函数没有被调用）</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 调用f函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>闭包：函数在定义时候的由外部环境变量所构成的整体，不会受外部函数的影响</p><p>闭包 = 函数 + 环境变量</p><p>环境变量一定是在定义在函数的外部（这里是在curve外部），也不能是全局变量（不能在curve_pre上面）。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">curve_pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token number">25</span>    <span class="token keyword">def</span> <span class="token function">curve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 函数接受参数x</span>        <span class="token keyword">return</span> a<span class="token operator">*</span>x<span class="token operator">*</span>x    <span class="token keyword">return</span> curvea <span class="token operator">=</span> <span class="token number">10</span>f <span class="token operator">=</span> curve_pre<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__closure__<span class="token punctuation">)</span>   <span class="token comment"># 闭包的环境变量，保存在closure里面</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__closure__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span>   <span class="token comment"># 取出闭包的环境变量</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="闭包的意义：保存的是一个环境。"><a href="#闭包的意义：保存的是一个环境。" class="headerlink" title="闭包的意义：保存的是一个环境。"></a>闭包的意义：保存的是一个环境。</h2><p>他把函数调用的现场保存起来了</p><p>单一的函数是不能决定运行结果的，还需要环境变量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">curve_pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token number">25</span>    <span class="token keyword">def</span> <span class="token function">curve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> a<span class="token operator">*</span>x<span class="token operator">*</span>x    <span class="token keyword">return</span> curve<span class="token keyword">def</span> <span class="token function">curve_pre1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 不同的闭包</span>    a <span class="token operator">=</span> <span class="token number">25</span>    <span class="token keyword">def</span> <span class="token function">curve1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> a<span class="token operator">*</span>x<span class="token operator">*</span>x    <span class="token keyword">return</span> curve1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token number">10</span>    <span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> <span class="token number">20</span>   <span class="token comment"># 这里a会被python认为局部变量，不叫作闭包</span>        <span class="token comment"># c = 20 * a   # 这里是引用上面的变量a，所以才是闭包。（关键在于这里的a是引用的上面的环境变量）</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># 从外往里，这里a=10，f2函数没有被调用</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># 这里a=20，是f2函数被调用了</span>    f2<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># 这里a=10，是调用的f1函数</span>f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># f = f1()</span><span class="token comment"># print(f)</span><span class="token comment"># print(f.__closure__)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="全局变量编程"><a href="#全局变量编程" class="headerlink" title="全局变量编程"></a>全局变量编程</h2><p>不建议，因为不能保证其它函数改变全局变量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>origin <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">go</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> origin   <span class="token comment"># global声明全局变量，表示这是一个全局变量，而不是局部变量</span>    new_pos <span class="token operator">=</span> origin <span class="token operator">+</span> step    origin <span class="token operator">=</span> new_pos    <span class="token keyword">return</span> new_pos<span class="token keyword">print</span><span class="token punctuation">(</span>go<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>go<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>go<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="闭包的作用"><a href="#闭包的作用" class="headerlink" title="闭包的作用"></a>闭包的作用</h2><p>保护现场功能，记忆了上一次调用的状态</p><h1 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>origin <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">factory</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">go</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">nonlocal</span> pos   <span class="token comment"># 声明变量在整个闭包中都有效</span>        new_pos <span class="token operator">=</span> pos <span class="token operator">+</span> step        pos <span class="token operator">=</span> new_pos        <span class="token keyword">return</span> new_pos    <span class="token keyword">return</span> gotourist <span class="token operator">=</span> factory<span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span>   <span class="token comment"># 这样验证全局变量没有被改变。</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">.</span>__closure__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">.</span>__closure__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tourist<span class="token punctuation">.</span>__closure__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>闭包问题，容易造成内存泄漏，如果是JS页面有大量闭包，会造成浏览器卡顿(因为闭包的变量是存储在内存里面)</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 闭包 </tag>
            
            <tag> 函数式编程 </tag>
            
            <tag> 枚举 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vmware磁盘扩容</title>
      <link href="/posts/23d31e79.html"/>
      <url>/posts/23d31e79.html</url>
      
        <content type="html"><![CDATA[<p><strong><font color=red>更正：虚拟机安装的时候磁盘分区是默认未配置，或者选择lvm逻辑卷管理才可使用本方法，遇到BUG和ERR欢迎留言或+Q</font></strong></p><p>前言：编写lamp编译安装文档的时候，MySQL8.0 cmake完成，make编译的时候磁盘空间不足（原/有17G，一共20G，swap2G，boot1G）</p><p>故有此次扩容文档，适用于服务器系统盘扩容（不建议这样做，应当提前规划好各系统目录的作用，做好逻辑卷等等）</p><p>不涉及到关机操作，应急使用，操作步骤：</p><ol><li>打开要扩容的虚拟机设置–&gt;选中磁盘–&gt;点击扩展，输入扩容后的大小，等待扩容完成。</li></ol><h1 id="VMware-磁盘扩容"><a href="#VMware-磁盘扩容" class="headerlink" title="VMware 磁盘扩容"></a>VMware 磁盘扩容</h1><p>进入虚拟机经行命令操作</p><p>命令下是执行此命令打印的信息，删除了大部分，留下的是关键信息部分</p><h2 id="查看可用磁盘大小，我的是20G扩容到40G"><a href="#查看可用磁盘大小，我的是20G扩容到40G" class="headerlink" title="查看可用磁盘大小，我的是20G扩容到40G"></a>查看可用磁盘大小，我的是20G扩容到40G</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">fdisk</span> <span class="token parameter variable">-l</span><span class="token comment"># Disk /dev/nvme0n1：40 GiB，42949672960 字节，83886080 个扇区</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="仍然显示17G"><a href="#仍然显示17G" class="headerlink" title="仍然显示17G"></a>仍然显示17G</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token parameter variable">-h</span><span class="token comment"># 文件系统             容量  已用  可用 已用% 挂载点</span><span class="token comment"># /dev/mapper/cl-root   17G  1.8G   16G   11% /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="对其进行新的分区"><a href="#对其进行新的分区" class="headerlink" title="对其进行新的分区"></a>对其进行新的分区</h2><p>由fdisk -l得到的信息，对其进行新的分区，除了第一次输入n，最后一次输入w，其它可以直接回车</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">fdisk</span> /dev/nvme0n1<span class="token comment"># 命令(输入 m 获取帮助)：n</span><span class="token comment"># 选择 (默认 p)：</span><span class="token comment"># 分区号 (3,4, 默认  3): </span><span class="token comment"># 第一个扇区 (41943040-83886079, 默认 41943040): </span><span class="token comment"># 上个扇区，+sectors 或 +size&#123;K,M,G,T,P&#125; (41943040-83886079, 默认 83886079): </span><span class="token comment"># 创建了一个新分区 3，类型为“Linux”，大小为 20 GiB。</span><span class="token comment"># 命令(输入 m 获取帮助)：w</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看新建的分区"><a href="#查看新建的分区" class="headerlink" title="查看新建的分区"></a>查看新建的分区</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblk <span class="token parameter variable">-l</span><span class="token comment"># nvme0n1p3 259:3    0  20G  0 part </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="对新分区做物理卷"><a href="#对新分区做物理卷" class="headerlink" title="对新分区做物理卷"></a>对新分区做物理卷</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pvcreate /dev/nvme0n1p3<span class="token comment"># Physical volume "/dev/nvme0n1p3" successfully created.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="查询root分区所在的卷组"><a href="#查询root分区所在的卷组" class="headerlink" title="查询root分区所在的卷组"></a>查询root分区所在的卷组</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vgdisplay <span class="token parameter variable">-v</span><span class="token comment"># --- Logical volume ---</span><span class="token comment"># LV Path                /dev/cl/root</span><span class="token comment"># LV Name                root   # 逻辑卷名</span><span class="token comment"># VG Name                cl   # 卷组名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="扩展cl卷组"><a href="#扩展cl卷组" class="headerlink" title="扩展cl卷组"></a>扩展cl卷组</h2><p>扩展cl卷组，即把物理卷/dev/nvme0n1p3分配到cl卷组</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vgextend cl /dev/nvme0n1p3<span class="token comment"># Volume group "cl" successfully extended</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="将cl卷组的剩余容量全部分给根分区"><a href="#将cl卷组的剩余容量全部分给根分区" class="headerlink" title="将cl卷组的剩余容量全部分给根分区"></a>将cl卷组的剩余容量全部分给根分区</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lvextend <span class="token parameter variable">-l</span> +100%FREE /dev/cl/root<span class="token comment"># Size of logical volume cl/root changed from &lt;17.00 GiB (4351 extents) to 36.99 GiB (9470 extents).</span><span class="token comment"># Logical volume cl/root successfully resized.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="同步文件系统"><a href="#同步文件系统" class="headerlink" title="同步文件系统"></a>同步文件系统</h2><p>同步文件系统，另外一种写法xfs_growfs /dev/cl/root报错，酌情使用。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xfs_growfs  /<span class="token comment"># meta-data=/dev/mapper/cl-root    isize=512    agcount=4, agsize=1113856 blks</span><span class="token comment">#          =                       sectsz=512   attr=2, projid32bit=1</span><span class="token comment">#          =                       crc=1        finobt=1, sparse=1, rmapbt=0</span><span class="token comment">#          =                       reflink=1</span><span class="token comment"># data     =                       bsize=4096   blocks=4455424, imaxpct=25</span><span class="token comment">#          =                       sunit=0      swidth=0 blks</span><span class="token comment"># naming   =version 2              bsize=4096   ascii-ci=0, ftype=1</span><span class="token comment"># log      =internal log           bsize=4096   blocks=2560, version=2</span><span class="token comment">#          =                       sectsz=512   sunit=0 blks, lazy-count=1</span><span class="token comment"># realtime =none                   extsz=4096   blocks=0, rtextents=0</span><span class="token comment"># data blocks changed from 4455424 to 9697280</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看扩容后的根分区大小"><a href="#查看扩容后的根分区大小" class="headerlink" title="查看扩容后的根分区大小"></a>查看扩容后的根分区大小</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token parameter variable">-h</span><span class="token comment"># /dev/mapper/cl-root   37G  2.0G   36G    6% /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="大磁盘扩容"><a href="#大磁盘扩容" class="headerlink" title="大磁盘扩容"></a>大磁盘扩容</h1><h2 id="使用工具分区"><a href="#使用工具分区" class="headerlink" title="使用工具分区"></a>使用工具分区</h2><p>查看新增加的磁盘信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">fdisk</span> <span class="token parameter variable">-l</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/0.png"><br>新建分区（fdisk最大支持2T磁盘）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">parted</span> /dev/vdd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>mklabel gpt<br>mkpart primary 0% 100%<br>quit</p></blockquote><p><img src="/medias/img/disk-1/1.png"><br>再次查看磁盘信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">fdisk</span> <span class="token parameter variable">-l</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/2.png"></p><h2 id="LVM扩容"><a href="#LVM扩容" class="headerlink" title="LVM扩容"></a>LVM扩容</h2><p>创建PV</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pvcreate /dev/vdd1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/3.png"><br>查看VG信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token parameter variable">-h</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/10.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vgdisplay<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/4.png"><br>VG扩容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vgextend volume-nfs /dev/vdd1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/5.png"><br>使用Free空间</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lvextend <span class="token parameter variable">-l</span> +100%FREE /dev/mapper/volume--nfs-lv--nfs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/6.png"><br>刷新VG信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xfs_growfs /dev/mapper/volume--nfs-lv--nfs<span class="token comment"># 报错：xfs_growfs: /dev/mapper/xxx is not a mounted XFS filesystem 使用下面的命令。</span>xfs_growfs /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/disk-1/7.png"></p><h2 id="验证磁盘容量"><a href="#验证磁盘容量" class="headerlink" title="验证磁盘容量"></a>验证磁盘容量</h2><p>刷新磁盘挂载信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">resize2fs <span class="token parameter variable">-p</span> <span class="token parameter variable">-F</span> /dev/mapper/volume--nfs-lv--nfs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/8.png"><br>查看磁盘挂载信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token parameter variable">-h</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/disk-1/9.png"></p>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vmware </tag>
            
            <tag> disk </tag>
            
            <tag> parted </tag>
            
            <tag> lvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(十)</title>
      <link href="/posts/5484010b.html"/>
      <url>/posts/5484010b.html</url>
      
        <content type="html"><![CDATA[<p>正则表达式是一个特殊的字符序列，一个字符串是否与我们所设定的这样的字符序列，相匹配</p><p>快速检索文本，实现一些替换文本的操作</p><ol><li>检查一串数字是否是电话号码</li><li>检测一个字符串是否符合email</li><li>把一个文本里指定的单词替换成另外一个单词</li></ol><h1 id="python正则表达式"><a href="#python正则表达式" class="headerlink" title="python正则表达式"></a>python正则表达式</h1><h2 id="从长字符串中取出特定的字符串’Python’"><a href="#从长字符串中取出特定的字符串’Python’" class="headerlink" title="从长字符串中取出特定的字符串’Python’"></a>从长字符串中取出特定的字符串’Python’</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 正则表达式、JSON（XML用的少）</span><span class="token keyword">import</span> re   <span class="token comment"># re是python自带的内置函数，用于匹配规则</span><span class="token comment"># re.findall('字符串', a)   # re用法|在a里面匹配指定的'字符串'</span>a <span class="token operator">=</span> <span class="token string">'C|C++|Java|C#|Python|Javascript'</span><span class="token comment"># print(a.index('Python')>-1)   # 利用python的内置函数index()</span><span class="token comment"># print('Python' in a)   #利用in</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>   <span class="token comment"># 打印结果是一个列表，因为匹配到的正则表达式可能有多个</span><span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'字符串包含Python'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'字符串不包含Python'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="取出字符串中的数字-d"><a href="#取出字符串中的数字-d" class="headerlink" title="取出字符串中的数字\d"></a>取出字符串中的数字\d</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'C0C++1Java2C#3Python4Javascript'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\d'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>   <span class="token comment"># 这里的字符串可以填写"P.*n"或者"[0-9]",表示匹配P开头n结尾的字符串，和0-9所有数字</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'字符串包含Python'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'字符串不包含Python'</span><span class="token punctuation">)</span><span class="token comment"># 'Python'普通字符</span><span class="token comment"># '\d'元字符</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="正则中字符集的使用"><a href="#正则中字符集的使用" class="headerlink" title="正则中字符集的使用"></a>正则中字符集的使用</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 字符集</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'abc, acc, adc, aec, afc, ahc'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'a[cf]c'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>   <span class="token comment"># 这里"a[cf]c"，前后的a和c变成了定界符，规定了a开头中间是c或者f以c结尾的字符串</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token comment"># []中括号里面是 或 关系，[^abc]反选 除了 abc 其他的都选。[a-d]连续 代表abcd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="概括字符集和数量词num"><a href="#概括字符集和数量词num" class="headerlink" title="概括字符集和数量词num"></a>概括字符集和数量词num</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 概括字符集(\d,\D,\w,etc)etc意思是"及其他"。下文不解释。</span><span class="token comment"># 数量词</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'python1111java678php'</span><span class="token comment"># r = re.findall('\d', a)</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'[a-z]&#123;3,6&#125;'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>   <span class="token comment"># 匹配[a-z]最少3次至多6次</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="贪婪模式😋"><a href="#贪婪模式😋" class="headerlink" title="贪婪模式😋"></a>贪婪模式😋</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 贪婪与非贪婪，python默认为贪婪模式，比如&#123;3,6&#125;python不会匹配到3就停止，而是按最多匹配到6次停止</span><span class="token comment"># 非贪婪的表示|在正则表达式后面加上?</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'python1111java678php'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'[a-z]&#123;3,6&#125;?'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>   <span class="token comment">#加上?使用非贪婪的模式，平常写代码，这里处理不好会经常有BUG</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数量词，非num"><a href="#数量词，非num" class="headerlink" title="数量词，非num"></a>数量词，非num</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 数量词，</span><span class="token comment"># * ，匹配 * 前面的字符 0次或者无限多次</span><span class="token comment"># + ，匹配1次或者无限多次</span><span class="token comment"># ? ，匹配0次或者1次</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'pytho0 python1 pythonn2'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'python?'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="边界匹配"><a href="#边界匹配" class="headerlink" title="边界匹配"></a>边界匹配</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 边界匹配</span><span class="token keyword">import</span> reqq <span class="token operator">=</span> <span class="token string">'1000000001'</span><span class="token comment"># 打印4-8位qq号</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^\d&#123;4,8&#125;$'</span><span class="token punctuation">,</span> qq<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="组"><a href="#组" class="headerlink" title="组"></a>组</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 组</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'PythonPythonPythonPythonPython'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'(Python)&#123;2&#125;'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>    <span class="token comment"># []中括号代表或关系，()小括号代表一组数据。</span><span class="token comment"># r = re.findall('(python)&#123;2&#125;', a, re.I)   # re.I表示不区分大小写</span><span class="token comment"># '(Python)&#123;3&#125;(JS)'表示3个Python为一组，后面是JS的，匹配出来。</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="且-n匹配"><a href="#且-n匹配" class="headerlink" title="且\n匹配"></a>且\n匹配</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'PythonC#\nJavaPHP'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'c#.&#123;1&#125;'</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> re<span class="token punctuation">.</span>I <span class="token operator">|</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>   <span class="token comment">#这里的 | 表示并且。</span><span class="token comment"># .点表示匹配任意字符，除了\n。而re.S表示要求.匹配到\n。</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> rea <span class="token operator">=</span> <span class="token string">'PythonC#JavaC#PHP'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'C#'</span><span class="token punctuation">,</span> <span class="token string">'GO'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>   <span class="token comment"># re.sub()替换。('C#', 'GO', a, 0) 把C#替换成GO，0代表替换所有，1代表替换第一个，不填默认是0</span><span class="token comment"># b = a.replace('C#', 'GO')   # 另一种替换方式。使用b是因为字符串不可以被修改，所以要重新赋值。</span><span class="token comment"># print(b)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># Ctrl + Alt + L可以调 整缩进，因为此篇即以前以后的大部分为笔记，为节省行数不会刻意调整。</span><span class="token keyword">import</span> relanguage <span class="token operator">=</span> <span class="token string">'PythonC#JavaC#PHPC#'</span><span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment"># 这里打印一下value的值，会发现有三行&lt;re.Match object; span=(6, 8), match='C#'></span>    <span class="token comment"># object表示对象 span代表位置 match是匹配的字符，意思就是匹配value，获得了3个结果。</span>    <span class="token comment"># value就是下面 re.sub传进来的参数C#</span>    matched <span class="token operator">=</span> value<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 这样以后会经常使用</span>    <span class="token keyword">return</span> <span class="token string">'!!'</span> <span class="token operator">+</span> matched <span class="token operator">+</span> <span class="token string">'!!'</span>  <span class="token comment"># 返回的结果，会替换C#</span>    <span class="token comment"># return返回的结果会替换value</span>    <span class="token comment"># 实际上就是函数作为re.sub第二个参数，convert返回结果替换掉C#（可以把函数当作参数）</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'C#'</span><span class="token punctuation">,</span> convert<span class="token punctuation">,</span> language<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># re.sub第二个参数可以是一个函数。这里0不写默认是所有。</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'A8C3721D86'</span>   <span class="token comment"># 匹配所有数字，将>=6的改为9，&lt;6改为0.</span><span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    matched <span class="token operator">=</span> value<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'9'</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'0'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'\d'</span><span class="token punctuation">,</span> convert<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token comment"># 从软件设计的角度，一个函数接收另一个函数作为参数，在软件里面是一个非常经典的思想，这样做的一个好处|</span><span class="token comment"># 比如sub函数的编写方，有一些逻辑是无法帮助调用方去做决定的，所以编写方开放一个接口，让调用方编写一个函数（这里是convert），</span><span class="token comment"># 然后把调用方的函数作为sub的参数，给调用方一个中间的结果value，不管调用方如何处理这个value，最后返回一个字符串给编写方即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 把单个数字剔除，以两位为一组找出大于50的替换成100，小于50的替换成0</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'A83B4C45D67E1'</span><span class="token comment"># str = '.?'</span><span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    matched <span class="token operator">=</span> value<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># print(matched)</span>    <span class="token comment"># print(value)b</span>    <span class="token comment"># print(str)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">''</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'\d&#123;1,2&#125;'</span><span class="token punctuation">,</span> convert<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="match和search"><a href="#match和search" class="headerlink" title="match和search"></a>match和search</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># re模块的另外的函数|re.match和re.search</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'1A83B4C45D67E1'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string">'\d'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>r1 <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'\d'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>span<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># match从字符串的首字母开始匹配，匹配不到返回空（None）</span><span class="token comment"># search是搜索整个字符串，直到匹配到第一个满足结果，就把结果返回（返回的是对象）</span><span class="token comment"># match和search只匹配一次</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'life is short, i use python'</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'life(.*)python'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 爬虫爬取html网页时，标签是不需要的，所以使用group获取；(life(.*)python)外面括号可以不加，但是group(0)永远表示最外面的括号，group(1)才是(.*)</span><span class="token comment"># a = re.findall('life(.*)python', s)</span><span class="token comment"># print(a)    #使用findall，把(.*)括起来，可以直接打印出来要匹配的组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> res <span class="token operator">=</span> <span class="token string">'life is short, i use python, i love python'</span><span class="token comment"># r = re.search('life(.*)python', s)   # 这里会匹配到最后一个python</span>r <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'life(.*)python(.*)python'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># group也可以这样用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h1><p>什么是JSON|</p><blockquote><p>是一种轻量级的数据交换格式</p></blockquote><blockquote><p>JSON是一种数据格式</p></blockquote><blockquote><p>字符串是JSON的表现形式</p></blockquote><p>JSON字符串|符合JSON格式的字符串，看一下例子|</p><blockquote><p>{a: “haha”❌</p></blockquote><blockquote><p>{“name”: “haha”}&emsp;✔</p></blockquote><p>JSON VS XML（互联网产品大部分先择JSON来做数据交换）</p><p>JSON优势|</p><blockquote><p>易于阅读</p></blockquote><blockquote><p>易于解析</p></blockquote><blockquote><p>网络传输效率高</p></blockquote><blockquote><p>跨语言交换数据</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> jsonjson_str <span class="token operator">=</span> <span class="token string">'&#123;"name":"haha", "age":9&#125;'</span>   <span class="token comment"># 若定义json字符串，&#123;&#125;里面必须是双引号，所以&#123;&#125;外面是单引号</span><span class="token comment"># JSON 中表示上面的字符串是object对象，还有array数组</span>json_array <span class="token operator">=</span> <span class="token string">'[&#123;"name":"haha", "age":9, "flag":false&#125;, &#123;"name":"xixi", "age":8&#125;]'</span>student <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>student1 <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_array<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>student1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token comment"># print(student['name'])</span><span class="token comment"># print(student['age'])</span><span class="token comment"># 不同的语言会把同样的JSON字符串转换成不同的数据类型</span><span class="token comment"># 反序列化，字符串到python数据类型的过程。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>json中数据类型对应的python数据类型</p><table><thead><tr><th align="left">json</th><th align="left">python</th></tr></thead><tbody><tr><td align="left">object</td><td align="left">dict</td></tr><tr><td align="left">array</td><td align="left">list</td></tr><tr><td align="left">string</td><td align="left">str</td></tr><tr><td align="left">number</td><td align="left">int</td></tr><tr><td align="left">number</td><td align="left">float</td></tr><tr><td align="left">true</td><td align="left">True</td></tr><tr><td align="left">false</td><td align="left">False</td></tr><tr><td align="left">null</td><td align="left">None</td></tr></tbody></table><h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 序列化</span><span class="token keyword">import</span> jsonstudent <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'xixi'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>json_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>json_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>json_str<span class="token punctuation">)</span><span class="token comment"># NOSQL MongoDB 比较适合存储对象，</span><span class="token comment"># 将对象序列化成字符串，存到MySQL中，读出来之后反序列化成对象。--不建议这样做。</span><span class="token comment"># 或者将对象拆分之后，以目录树的形式，存储到MySQL中。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>JSON、JSON对象</p><blockquote><p>JSON|数据交换的标准格式</p></blockquote><blockquote><p>JSON对象|在Javascript中是存在JSON对象的，对于python来说是没有JSON对象说法的。</p></blockquote><p>JavaScript是实现ECMASCRIPT（W3C制定的脚本标准）标准之一，同样也有ActionScript，JSON，TypeScript（微软）</p><h1 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h1><style>table th:first-of-type {    width: 120px;}</style><table><thead><tr><th align="left">元字符</th><th>描述</th></tr></thead><tbody><tr><td align="left"><code>\</code></td><td>将下一个字符标记符、或一个向后引用、或一个八进制转义符。例如，”<code>\\n</code>“匹配<code>\n</code>。”<code>\n</code>“匹配换行符。序列”<code>\\</code>“匹配”<code>\</code>“而”<code>\(</code>“则匹配”<code>(</code>“。即相当于多种编程语言中都有的”转义字符”的概念。</td></tr><tr><td align="left"><code>^</code></td><td>匹配输入字行首。如果设置了RegExp对象的Multiline属性，<code>^</code>也匹配”<code>\n</code>“或”<code>\r</code>“之后的位置。</td></tr><tr><td align="left"><code>$</code></td><td>匹配输入行尾。如果设置了RegExp对象的Multiline属性，<code>$</code>也匹配”<code>\n</code>“或”<code>\r</code>“之前的位置。</td></tr><tr><td align="left"><code>*</code></td><td>匹配前面的子表达式任意次。例如，<code>zo*</code>能匹配”<code>z</code>“，也能匹配”<code>zo</code>“以及”<code>zoo</code>“。<code>*</code>等价于{<code>0,</code>}。</td></tr><tr><td align="left"><code>+</code></td><td>匹配前面的子表达式一次或多次(大于等于1次）。例如，”<code>zo+</code>“能匹配”<code>zo</code>“以及”<code>zoo</code>“，但不能匹配”<code>z</code>“。<code>+</code>等价于<code>&#123;1,&#125;</code>。</td></tr><tr><td align="left"><code>?</code></td><td>匹配前面的子表达式零次或一次。例如，”<code>do(es)?</code>“可以匹配”<code>do</code>“或”<code>does</code>“。<code>?</code>等价于<code>&#123;0,1&#125;</code>。</td></tr><tr><td align="left"><code>&#123;*n*&#125;</code></td><td><code>*n*</code>是一个非负整数。匹配确定的<code>*n*</code>次。例如，”<code>o&#123;2&#125;</code>“不能匹配”<code>Bob</code>“中的”<code>o</code>“，但是能匹配”<code>food</code>“中的两个<code>o</code>。</td></tr><tr><td align="left"><code>&#123;*n*,&#125;</code></td><td><code>*n*</code>是一个非负整数。至少匹配<code>*n*</code>次。例如，”<code>o&#123;2,&#125;</code>“不能匹配”<code>Bob</code>“中的”<code>o</code>“，但能匹配”<code>foooood</code>“中的所有<code>o</code>。”<code>o&#123;1,&#125;</code>“等价于”<code>o+</code>“。”<code>o&#123;0,&#125;</code>“则等价于”<code>o*</code>“。</td></tr><tr><td align="left"><code>&#123;*n*,*m*&#125;</code></td><td><code>*m*</code>和<code>*n*</code>均为非负整数，其中<code>*n*</code>&lt;=<code>*m*</code>。最少匹配<code>*n*</code>次且最多匹配<code>*m*</code>次。例如，”<code>o&#123;1,3&#125;</code>“将匹配”<code>fooooood</code>“中的前三个o为一组，后三个o为一组。”<code>o&#123;0,1&#125;</code>“等价于”<code>o?</code>“。请注意在逗号和两个数之间不能有空格。</td></tr><tr><td align="left"><code>?</code></td><td>当该字符紧跟在任何一个其他限制符（<code>*,+,?，&#123;*n*&#125;，&#123;*n*,&#125;，&#123;*n*,*m*&#125;</code>）后面时，匹配模式是非贪婪的。非贪婪模式尽可能少地匹配所搜索的字符串，而默认的贪婪模式则尽可能多地匹配所搜索的字符串。例如，对于字符串”oooo”，”o+”将尽可能多地匹配”o”，得到结果[“oooo”]，而”<code>o+?</code>“将尽可能少地匹配”o”，得到结果 <code>[&#39;o&#39;, &#39;o&#39;, &#39;o&#39;, &#39;o&#39;]</code></td></tr><tr><td align="left"><code>.</code></td><td>匹配除”<code>\n</code>“和”<code>\r</code>“之外的任何单个字符。要匹配包括”<code>\n</code>“和”<code>\r</code>“在内的任何字符，请使用像”<code>[\s\S]</code>“的模式。</td></tr><tr><td align="left"><code>(pattern)</code></td><td>匹配pattern并获取这一匹配。所获取的匹配可以从产生的Matches集合得到，在VBScript中使用SubMatches集合，在JScript中则使用<code>$0…$9</code>属性。要匹配圆括号字符，请使用”<code>\(</code>“或”<code>\)</code>“。</td></tr><tr><td align="left"><code>(?:pattern)</code></td><td>非获取匹配，匹配pattern但不获取匹配结果，不进行存储供以后使用。这在使用或字符”<code>(|)</code>“来组合一个模式的各个部分时很有用。例如”<code>industr(?:y|ies)</code>“就是一个比”<code>industry|industries</code>“更简略的表达式。</td></tr><tr><td align="left"><code>(?=pattern)</code></td><td>非获取匹配，正向肯定预查，在任何匹配pattern的字符串开始处匹配查找字符串，该匹配不需要获取供以后使用。例如，”<code>Windows(?=95|98|NT|2000)</code>“能匹配”<code>Windows2000</code>“中的”<code>Windows</code>“，但不能匹配”<code>Windows3.1</code>“中的”<code>Windows</code>“。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td></tr><tr><td align="left"><code>(?!pattern)</code></td><td>非获取匹配，正向否定预查，在任何不匹配pattern的字符串开始处匹配查找字符串，该匹配不需要获取供以后使用。例如”<code>Windows(?!95|98|NT|2000)</code>“能匹配”Windows3.1”中的”Windows”，但不能匹配”Windows2000”中的”Windows”。</td></tr><tr><td align="left"><code>(?&lt;=pattern)</code></td><td>非获取匹配，反向肯定预查，与正向肯定预查类似，只是方向相反。例如，”<code>(?&lt;=95|98|NT|2000)Windows</code>“能匹配”2000Windows”中的”Windows”，但不能匹配”3.1Windows”中的”Windows”。</td></tr><tr><td align="left"><code>(?&lt;!patte_n)</code></td><td>非获取匹配，反向否定预查，与正向否定预查类似，只是方向相反。例如”<code>(?&lt;!95|98|NT|2000)Windows</code>“能匹配”3.1Windows”中的”Windows”，但不能匹配”2000Windows”中的”Windows”。</td></tr><tr><td align="left"><code>x|y</code></td><td>匹配<code>x</code>或<code>y</code>。例如，”<code>z|food</code>“能匹配”<code>z</code>“或”<code>food</code>“(此处请谨慎)。”<code>[z|f]ood</code>“则匹配”<code>zood</code>“或”<code>food</code>“。</td></tr><tr><td align="left"><code>[xyz]</code></td><td>字符集合。匹配所包含的任意一个字符。例如，”<code>[abc]</code>“可以匹配”plain”中的”a”。</td></tr><tr><td align="left"><code>[^xyz]</code></td><td>负值字符集合。匹配未包含的任意字符。例如，”<code>[^abc]</code>“可以匹配”plain”中的”plin”任一字符。</td></tr><tr><td align="left"><code>[a-z]</code></td><td>字符范围。匹配指定范围内的任意字符。例如，”<code>[a-z]</code>“可以匹配”a”到”z”范围内的任意小写字母字符。注意:只有连字符在字符组内部时,并且出现在两个字符之间时,才能表示字符的范围; 如果出字符组的开头,则只能表示连字符本身.</td></tr><tr><td align="left"><code>[^a-z]</code></td><td>负值字符范围。匹配任何不在指定范围内的任意字符。例如，”<code>[^a-z]</code>“可以匹配任何不在”a”到”z”范围内的任意字符。</td></tr><tr><td align="left"><code>\b</code></td><td>匹配一个单词的边界，也就是指单词和空格间的位置（即正则表达式的”匹配”有两种概念，一种是匹配字符，一种是匹配位置，这里的<code>\b</code>就是匹配位置的）。例如，”<code>er\b</code>“可以匹配”never”中的”er”，但不能匹配”verb”中的”er”；”<code>\b1_</code>“可以匹配”1_23”中的”1_”，但不能匹配”21_3”中的”1_”。</td></tr><tr><td align="left"><code>\B</code></td><td>匹配非单词边界。”<code>er\B</code>“能匹配”verb”中的”er”，但不能匹配”never”中的”er”。</td></tr><tr><td align="left"><code>\cx</code></td><td>匹配由x指明的控制字符。例如，<code>\cM</code>匹配一个Control-M或回车符。x的值必须为A-Z或a-z之一。否则，将c视为一个原义的”c”字符。</td></tr><tr><td align="left"><code>\d</code></td><td>匹配一个数字字符。等价于<code>[0-9]</code>。grep 要加上-P，perl正则支持</td></tr><tr><td align="left"><code>\D</code></td><td>匹配一个非数字字符。等价于<code>[^0-9]</code>。grep要加上-P，perl正则支持</td></tr><tr><td align="left"><code>\f</code></td><td>匹配一个换页符。等价于<code>\x0c</code>和<code>\cL</code>。</td></tr><tr><td align="left"><code>\n</code></td><td>匹配一个换行符。等价于<code>\x0a</code>和<code>\cJ</code>。</td></tr><tr><td align="left"><code>\r</code></td><td>匹配一个回车符。等价于<code>\x0d</code>和<code>\cM</code>。</td></tr><tr><td align="left"><code>\s</code></td><td>匹配任何不可见字符，包括空格、制表符、换页符等等。等价于<code>[ \f\n\r\t\v]</code>。</td></tr><tr><td align="left"><code>\S</code></td><td>匹配任何可见字符。等价于<code>[^ \f\n\r\t\v]</code>。</td></tr><tr><td align="left"><code>\t</code></td><td>匹配一个制表符。等价于<code>\x09</code>和<code>\cI</code>。</td></tr><tr><td align="left"><code>\v</code></td><td>匹配一个垂直制表符。等价于<code>\x0b</code>和<code>\cK</code>。</td></tr><tr><td align="left"><code>\w</code></td><td>匹配包括下划线的任何单词字符。类似但不等价于”<code>[A-Za-z0-9_]</code>“，这里的”单词”字符使用Unicode字符集。</td></tr><tr><td align="left"><code>\W</code></td><td>匹配任何非单词字符。等价于”<code>[^A-Za-z0-9_]</code>“。</td></tr><tr><td align="left"><code>\x*n*</code></td><td>匹配<code>*n*</code>，其中<code>*n*</code>为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，”<code>\x41</code>“匹配”<code>A</code>“。”<code>\x041</code>“则等价于”<code>\x04&amp;1</code>“。正则表达式中可以使用ASCII编码。</td></tr><tr><td align="left"><code>\*num*</code></td><td>匹配<code>*num*</code>，其中<code>*num*</code>是一个正整数。对所获取的匹配的引用。例如，”<code>(.)\1</code>“匹配两个连续的相同字符。</td></tr><tr><td align="left"><code>\*n*</code></td><td>标识一个八进制转义值或一个向后引用。如果<code>\*n*</code>之前至少<code>*n*</code>个获取的子表达式，则<code>*n*</code>为向后引用。否则，如果<code>*n*</code>为八进制数字（0-7），则<code>*n*</code>为一个八进制转义值。</td></tr><tr><td align="left"><code>\*nm*</code></td><td>标识一个八进制转义值或一个向后引用。如果<code>\*nm*</code>之前至少有<code>*nm*</code>个获得子表达式，则<code>*nm*</code>为向后引用。如果<code>\*nm*</code>之前至少有<code>*n*</code>个获取，则<code>*n*</code>为一个后跟文字<code>*m*</code>的向后引用。如果前面的条件都不满足，若<code>*n*</code>和<code>*m*</code>均为八进制数字（0-7），则<code>\*nm*</code>将匹配八进制转义值<code>*nm*</code>。</td></tr><tr><td align="left"><code>\*nml*</code></td><td>如果<code>*n*</code>为八进制数字（0-7），且<code>*m*</code>和<code>*l*</code>均为八进制数字（0-7），则匹配八进制转义值<code>*nml*</code>。</td></tr><tr><td align="left"><code>\u*n*</code></td><td>匹配<code>*n*</code>，其中<code>*n*</code>是一个用四个十六进制数字表示的Unicode字符。例如，<code>\u00A9</code>匹配版权符号（<code>&amp;copy;</code>）。</td></tr><tr><td align="left"><code>\p&#123;P&#125;</code></td><td>小写 p 是 property 的意思，表示 Unicode 属性，用于 Unicode 正表达式的前缀。中括号内的”P”表示Unicode 字符集七个字符属性之一：标点字符。其他六个属性L：字母；M：标记符号（一般不会单独出现）；Z：分隔符（比如空格、换行等）；S：符号（比如数学符号、货币符号等）；N：数字（比如阿拉伯数字、罗马数字等）；C：其他字符。*注：此语法部分语言不支持，例</td></tr><tr><td align="left"><code>\&lt;\&gt;</code></td><td>匹配词（word）的开始（<code>\&lt;</code>）和结束（<code>\&gt;</code>）。例如正则表达式<code>\&lt;the\&gt;</code>能够匹配字符串”for the wise”中的”the”，但是不能匹配字符串”otherwise”中的”the”。注意：这个元字符不是所有的软件都支持的。</td></tr><tr><td align="left"><code>( )</code></td><td>将<code>(</code> 和 <code>)</code> 之间的表达式定义为”组”（group），并且将匹配这个表达式的字符保存到一个临时区域（一个正则表达式中最多可以保存9个），它们可以用 <code>\1</code> 到<code>\9</code> 的符号来引用。</td></tr><tr><td align="left"><code>|</code></td><td>将两个匹配条件进行逻辑”或”（Or）运算。例如正则表达式(<code>him|her</code>) 匹配”it belongs to him”和”it belongs to her”，但是不能匹配”it belongs to them.”。注意：这个元字符不是所有的软件都支持的。</td></tr></tbody></table><h1 id="正则表达式语法支持情况"><a href="#正则表达式语法支持情况" class="headerlink" title="正则表达式语法支持情况"></a>正则表达式语法支持情况</h1><table><thead><tr><th><strong>命令或环境</strong></th><th><strong>.</strong> <strong>[ ]</strong> <strong>^</strong> <strong>$</strong></th><th><strong>( )</strong></th><th><strong>{ }</strong></th><th><strong>?</strong> <strong>+</strong> <strong>|</strong> <strong>( )</strong></th></tr></thead><tbody><tr><td><strong>vi</strong></td><td>√</td><td>√</td><td></td><td></td></tr><tr><td><strong>Visual C++</strong></td><td>√</td><td>√</td><td></td><td></td></tr><tr><td><strong>awk</strong></td><td>√</td><td></td><td>awk是支持该语法的，只是要在命令行加入<code>--posix</code> or <code>--re-interval</code>参数即可，可见man awk中的 r{n,m}</td><td>√</td></tr><tr><td><strong>sed</strong></td><td>√</td><td>√</td><td>√</td><td></td></tr><tr><td><strong>delphi</strong></td><td>√</td><td>√</td><td></td><td>√</td></tr><tr><td><strong>python</strong></td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td><strong>java</strong></td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td><strong>javascript</strong></td><td>√</td><td>√</td><td></td><td>√</td></tr><tr><td><strong>php</strong></td><td>√</td><td>√</td><td></td><td></td></tr></tbody></table><p>| <strong>perl</strong>       | √                        | √         |           | √<br>| <strong>C#</strong>         | √                        |           |           | √ </p><h1 id="shell正则"><a href="#shell正则" class="headerlink" title="shell正则"></a>shell正则</h1><p>字符匹配、匹配次数、位置锚定、分组</p><table><thead><tr><th align="left">表达式</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left"><code>.</code></td><td align="left">匹配任意单个字符</td></tr><tr><td align="left"><code>[]</code></td><td align="left">匹配指定范围内的任意单个字符</td></tr><tr><td align="left"><code>[^]</code></td><td align="left">匹配指定范围外的任意字符</td></tr><tr><td align="left"><code>[:blank:]</code></td><td align="left">空白字符（空格和制表符）</td></tr><tr><td align="left"><code>[:punct:]</code></td><td align="left">标点符号</td></tr><tr><td align="left"><code>*</code></td><td align="left">匹配前面字符任意次，包括0次和尽可能长的匹配</td></tr><tr><td align="left"><code>.*</code></td><td align="left">任意字符任意次</td></tr><tr><td align="left"><code>\?</code></td><td align="left">匹配前面的字符0或1次</td></tr><tr><td align="left"><code>\+</code></td><td align="left">匹配前面的字符1次以上</td></tr><tr><td align="left"><code>\&#123;n，m\&#125;</code></td><td align="left">匹配前面的字符至少n次至多m次</td></tr><tr><td align="left"><code>\&#123;n\&#125;</code></td><td align="left">匹配前面的字符n次</td></tr><tr><td align="left"><code>\&#123;,n\&#125;</code></td><td align="left">匹配前面的字符至多n次</td></tr><tr><td align="left"><code>\&#123;n,\&#125;</code></td><td align="left">匹配前面的字符至少n次</td></tr><tr><td align="left"><code>^</code></td><td align="left">行首锚定</td></tr><tr><td align="left"><code>$</code></td><td align="left">行尾锚定</td></tr><tr><td align="left"><code>\&lt;</code></td><td align="left">词首锚定</td></tr><tr><td align="left"><code>\&gt;</code></td><td align="left">词尾锚定</td></tr><tr><td align="left"><code>^$</code></td><td align="left">空行</td></tr><tr><td align="left"><code>^[[:space:]]*$</code></td><td align="left">空白行</td></tr></tbody></table><h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><table><thead><tr><th align="left">分组</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left"><code>\(\)</code></td><td align="left">将一个或多个字符捆绑在一起，当作一个整体进行处理</td></tr><tr><td align="left"><code>\1</code></td><td align="left">后向引用：引用前面的分组括号中的模式所匹配的字符（而非模式本身）</td></tr><tr><td align="left"><code>[[:alnum:]]</code></td><td align="left">文字数字字符</td></tr><tr><td align="left"><code>[[:alpha:]]</code></td><td align="left">文字字符</td></tr><tr><td align="left"><code>[[:digit:]]</code></td><td align="left">数字字符</td></tr><tr><td align="left"><code>[[:graph:]]</code></td><td align="left">非空字符（非空格，非控制字符）</td></tr><tr><td align="left"><code>[[:lower:]]</code></td><td align="left">小写字符</td></tr><tr><td align="left"><code>[[:cntrl:]]</code></td><td align="left">控制字符</td></tr><tr><td align="left"><code>[[:print:]]</code></td><td align="left">非空字符（包括空格）</td></tr><tr><td align="left"><code>[[:punct:]]</code></td><td align="left">标点符号</td></tr><tr><td align="left"><code>[[:space:]]</code></td><td align="left">所有空白字符（新行，空格，制表符）</td></tr><tr><td align="left"><code>[[:upper:]]</code></td><td align="left">大写字符</td></tr><tr><td align="left"><code>[[:xdigit:]]</code></td><td align="left">十六进制数字（0-9，a-f，A-F）</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 学习笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git仓库</title>
      <link href="/posts/94ba0f37.html"/>
      <url>/posts/94ba0f37.html</url>
      
        <content type="html"><![CDATA[<h2 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h2><p>hexo搭建个人网站，使用OSS+CDN加速。（涉及到域名备案（又涉及到服务器购买）、因为购买了ECS打算利用一下做Git仓库，做web访问）</p><p>阿里云备案免费，服务器要钱具体看下图：</p><p><img src="/medias/img/git/0.jpg"></p><p>买了一个最便宜的服务器102元/年，好像有99元/年的，域名roxn.cn首年29元/年，续费39元/年</p><p>备案成本：102+29=131元</p><p>以后花费：39+OSS+CDN≈100左右，服务器预算超过300元/年，打算用GitHub pages+免费CDN，年费0元。</p><p>接着介绍git仓库搭建情况，及上线</p><h2 id="系统情况："><a href="#系统情况：" class="headerlink" title="系统情况："></a>系统情况：</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 系统版本</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release </span><span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"OpenCloudOS"</span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"8.6"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 均为yum安装</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum -y install nginx vim git</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable nginx</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl start nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="git仓库"><a href="#git仓库" class="headerlink" title="git仓库"></a>git仓库</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd /home/</span><span class="token punctuation">[</span>root@localhost home<span class="token punctuation">]</span><span class="token comment"># git init --bare roxn.git</span><span class="token punctuation">[</span>root@localhost home<span class="token punctuation">]</span><span class="token comment"># ls</span>roxn.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="本地仓库连接远程仓库"><a href="#本地仓库连接远程仓库" class="headerlink" title="本地仓库连接远程仓库"></a>本地仓库连接远程仓库</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> remote <span class="token function">add</span> origin ssh://root@<span class="token operator">&lt;</span>服务器IP<span class="token operator">></span>:<span class="token operator">&lt;</span>ssh端口<span class="token operator">></span>/home/roxn.git<span class="token comment"># hexo _config.yml 配置hexo d命令上传的仓库地址</span><span class="token comment"># repository: ssh://root@&lt;服务器IP>:&lt;ssh端口>/home/roxn.git</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="SSH免密登录"><a href="#SSH免密登录" class="headerlink" title="SSH免密登录"></a>SSH免密登录</h3><p><img src="/medias/img/git/1.jpg"></p><p>指明ECS服务器IP地址和ssh端口</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ssh-copy-id root@<span class="token operator">&lt;</span>服务器IP<span class="token operator">></span>: <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>ssh端口<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="服务器WEB自动获取"><a href="#服务器WEB自动获取" class="headerlink" title="服务器WEB自动获取"></a>服务器WEB自动获取</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost <span class="token punctuation">]</span><span class="token comment"># cd /usr/share/nginx/</span><span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># rm -fr html</span><span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># git clone ssh://root@localhost:222/home/roxn.git html</span><span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># cd html/</span><span class="token punctuation">[</span>root@localhost html<span class="token punctuation">]</span><span class="token comment"># ls</span><span class="token number">404</span>       baidusitemap.xml  categories  cv           index.html  libs    posts    search.xml   tagsarchives  baidu_urls.txt    css         favicon.png  js          medias  project  sitemap.xml<span class="token punctuation">[</span>root@localhost html<span class="token punctuation">]</span><span class="token comment"># cd /home/roxn.git/hooks/</span><span class="token punctuation">[</span>root@localhost hooks<span class="token punctuation">]</span><span class="token comment"># cat post-receive   # 每次更新仓库会触发此脚本</span><span class="token comment">#!/bin/bash  </span><span class="token builtin class-name">cd</span> /usr/share/nginx/html<span class="token builtin class-name">unset</span> GIT_DIR<span class="token function">git</span> fetch <span class="token parameter variable">--all</span> <span class="token operator">&amp;></span> /dev/null <span class="token function">git</span> reset <span class="token parameter variable">--hard</span> origin/master <span class="token operator">&amp;></span> /dev/null   <span class="token comment"># 到这里会更新html目录。</span><span class="token function">sh</span> /home/shell/information.sh   <span class="token comment"># 这里到下面是自定义的脚本，获取两次hexo d之间的commit信息</span>dingtalk   <span class="token comment"># 发送钉钉通知</span><span class="token function">sleep</span> <span class="token number">1</span> <span class="token function">sh</span> /opt/python-dingtalk/splicing_url.bash   <span class="token comment"># 整理所有的url，上传到百度收录。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="404页面"><a href="#404页面" class="headerlink" title="404页面"></a>404页面</h3><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf"># 因为html是一个本地git仓库，注意配置访问.git转到404。    location ^~ &#x2F;.git &#123;        return 404;    &#125;   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"1"</span><span class="token comment"># git config --global --edit</span><span class="token comment"># git config --global user.name "Your Name"</span><span class="token comment"># git config --global user.email you@example.com</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> <span class="token parameter variable">--edit</span>   <span class="token comment"># 执行，设置全局配置</span><span class="token comment"># 或者执行下面两个命令</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">"Your Name"</span>   <span class="token comment"># 提交者姓名</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email you@example.com   <span class="token comment"># 提交者邮箱</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">Enumerating objects: 1820, done.Counting objects: 100% (1820/1820), done.Delta compression using up to 12 threadsCompressing objects: 100% (1664/1664), done.Writing objects: 100% (1820/1820), 37.00 MiB | 4.88 MiB/s, done.Total 1820 (delta 808), reused 0 (delta 0), pack-reused 0remote: 处理 delta 中: 100% (808/808), 完成.remote: error: denying non-fast-forward refs/heads/master (you should pull first)To ssh://82.156.36.179:/home/roxn.git ! [remote rejected] HEAD -> master (non-fast-forward)error: failed to push some refs to 'ssh://82.156.36.179:/home/roxn.git'FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.htmlError: Spawn failed    at ChildProcess.&lt;anonymous> (D:\blog\node_modules\hexo-util\lib\spawn.js:51:21)    at ChildProcess.emit (node:events:513:28)    at cp.emit (D:\blog\node_modules\cross-spawn\lib\enoent.js:34:29)    at ChildProcess._handle.onexit (node:internal/child_process:291:12)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 允许覆盖push，禁止的话使用true</span><span class="token function">git</span> --git-dir<span class="token operator">=</span>/home/roxn.git config receive.denyNonFastForwards <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab安装</title>
      <link href="/posts/228d3dce.html"/>
      <url>/posts/228d3dce.html</url>
      
        <content type="html"><![CDATA[<h1 id="gitlab-jh部署手册"><a href="#gitlab-jh部署手册" class="headerlink" title="gitlab-jh部署手册"></a>gitlab-jh部署手册</h1><blockquote><p>先阅读全文再安装</p></blockquote><h4 id="1-安装和配置必须的依赖项"><a href="#1-安装和配置必须的依赖项" class="headerlink" title="1. 安装和配置必须的依赖项"></a>1. 安装和配置必须的依赖项</h4><p>在 CentOS 7上，下面的命令也会在系统防火墙中打开 HTTP、HTTPS 和 SSH 访问。这是一个可选步骤，如果您打算仅从本地网络访问极狐GitLab，则可以跳过它。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">curl</span> policycoreutils-python openssh-server perlsystemctl <span class="token builtin class-name">enable</span> sshdsystemctl start sshdfirewall-cmd <span class="token parameter variable">--permanent</span> --add-service<span class="token operator">=</span>httpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-service<span class="token operator">=</span>httpssystemctl reload firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（可选）下一步，安装 Postfix 以发送电子邮件通知。如果您想使用其他解决方案发送电子邮件，请跳过此步骤并在安装极狐GitLab 后配置外部 SMTP 服务器。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> postfixsystemctl <span class="token builtin class-name">enable</span> postfixsystemctl start postfix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在安装 Postfix 的过程中可能会出现一个配置界面，在该界面中选择”Internet Site”并按下回车。把”mail name”设置为您服务器的外部 DNS 域名并按下回车。如果还有其它配置界面出现，继续按下回车以接受默认配置。</p><h4 id="2-下载-安装极狐GitLab"><a href="#2-下载-安装极狐GitLab" class="headerlink" title="2. 下载/安装极狐GitLab"></a>2. 下载/安装极狐GitLab</h4><p>配置极狐GitLab 软件源镜像。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://packages.gitlab.cn/repository/raw/scripts/setup.sh <span class="token operator">|</span> /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来，安装极狐GitLab。确保您已正确<a href="https://docs.gitlab.cn/omnibus/settings/dns.html">设置您的 DNS</a>，并更改 <a href="https://gitlab.example.com/">https://gitlab.example.com</a> 为您要访问极狐GitLab 实例的 URL。安装包将在该 URL 上自动配置和启动极狐GitLab。</p><p>对于 <code>https</code> 站点，极狐GitLab 将使用 Let’s Encrypt 自动请求 SSL 证书，这需要有效的主机名和入站 HTTP 访问。您也可以使用自己的证书或仅使用 <code>http://</code>（不带<code>s</code>）。</p><p>如果您想为初始管理员用户(<code>root</code>)指定自定义密码，请查看<a href="https://docs.gitlab.cn/omnibus/installation/index.html#%E8%AE%BE%E7%BD%AE%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">文档</a>。如果未指定密码，将自动生成随机密码。</p><p>执行如下命令开始安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">EXTERNAL_URL</span><span class="token operator">=</span><span class="token string">"https://gitlab.example.com"</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gitlab-jh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-访问极狐GitLab-实例并登录"><a href="#3-访问极狐GitLab-实例并登录" class="headerlink" title="3. 访问极狐GitLab 实例并登录"></a>3. 访问极狐GitLab 实例并登录</h4><p>除非您在安装过程中指定了自定义密码，否则将随机生成一个密码并存储在 <code>/etc/gitlab/initial_root_password</code> 文件中(出于安全原因，24 小时后，此文件会被第一次 <code>gitlab-ctl reconfigure</code> 自动删除，因此若使用随机密码登录，建议安装成功初始登录成功之后，立即修改初始密码）。使用此密码和用户名 <code>root</code> 登录。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># hostname -I</span><span class="token number">192.168</span>.1.18 <span class="token number">10.8</span>.0.150<span class="token comment"># 主机IP。在esxi中的主机名为gitlab</span><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># df -h|grep /$</span>/dev/mapper/centos-root   53G  <span class="token number">9</span>.4G   44G  <span class="token number">18</span>% /<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>              total        used        <span class="token function">free</span>      shared  buff/cache   availableMem:           <span class="token number">7</span>.6G        <span class="token number">3</span>.5G        <span class="token number">1</span>.7G        102M        <span class="token number">2</span>.4G        <span class="token number">3</span>.7G<span class="token comment"># 50G系统盘，8G内存。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><blockquote><p>登录服务器，上传init.sh脚本，并执行。文件位置在wps–&gt;运维–&gt;运维文档中。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 系统初始化</span><span class="token function">sh</span> init.sh<span class="token comment"># 执行官方安装脚本，会自动生成/etc/yum.repos.d/gitlab_gitlab-ce.repo文件</span><span class="token comment"># curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | bash</span><span class="token comment"># cat /etc/yum.repos.d/gitlab_gitlab-ce.repo</span><span class="token comment"># 执行安装，提醒证书安装超时，将上面文件中的gpgcheck=1改为gpgcheck=0</span><span class="token comment"># yum install -y gitlab-ce</span><span class="token comment"># systemctl enable gitlab-jh</span><span class="token comment"># 修改配置文件/etc/gitlab/gitlab.rb</span>external_url <span class="token string">'https://gitlab.domain.com'</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_ssh_host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'gitlab.domain.com'</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gitlab@domain.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"dxxxxxxxxxxxxxxd"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gitlab@domain.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_pool'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gitlab@domain.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'manage_backup_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/var/opt/gitlab/backups"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_keep_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">604800</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gravatar_plain_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://sdn.geekzu.org/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon'</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gravatar_ssl_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'https://sdn.geekzu.org/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon'</span>nginx<span class="token punctuation">[</span><span class="token string">'redirect_http_to_https'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/domain.com.cer"</span>nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate_key'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/domain.com.key"</span><span class="token comment"># 其中/etc/gitlab/ssl/目录下的文件，由腾讯云xxx.xxx.xxx.xxx服务器scp发送过来</span><span class="token function">scp</span> /root/.acme.sh/*.domain.com/*.domain.com.cer gitlab:/etc/gitlab/ssl/domain.com.cer<span class="token function">scp</span> /root/.acme.sh/*.domain.com/*.domain.com.key gitlab:/etc/gitlab/ssl/domain.com.key<span class="token comment"># 修改完配置文件重新加载</span>gitlab-ctl reconfigure<span class="token comment"># 重启gitlab-ce</span>gitlab-ctl restart---------分割线--------<span class="token comment"># 如果使用以下方式禁用了IPv6，邮件发送可能会有问题。修复方式如下：</span><span class="token function">grep</span> net.ipv6.conf.all.disable_ipv6 /etc/sysctl.confnet.ipv6.conf.all.disable_ipv6 <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment"># 禁用ipv6</span><span class="token comment"># 禁用IPv6后，修改postfix的配置文件监听为all，默认为localhost。也可以修改为本机IP地址。</span><span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">"^#"</span> /etc/postfix/main.cf <span class="token operator">|</span> <span class="token function">grep</span> inet_interfacesinet_interfaces <span class="token operator">=</span> all<span class="token comment"># 重启邮件服务即可。</span>systemctl restart postfix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 没有修改/etc/gitlab/gitlab.rb使用gitlab-ctl restart重启即可。</span>gitlab-ctl restart<span class="token comment"># 修改/etc/gitlab/gitlab.rb使用下面两个命令重启</span>gitlab-ctl reconfiguregitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="访问地址"><a href="#访问地址" class="headerlink" title="访问地址"></a>访问地址</h2><p><a href="https://gitlab.domain.com/">https://gitlab.domain.com/</a></p><p><img src="/medias/img/gitlab/image-20221025114208899.png"></p><blockquote><p>默认用户名：root</p><p>密码在<code>cat /etc/gitlab/initial_root_password</code>中。</p></blockquote><h2 id="修改中文"><a href="#修改中文" class="headerlink" title="修改中文"></a>修改中文</h2><blockquote><p>右上角编辑个人状态。</p></blockquote><p><img src="/medias/img/gitlab/image-20221025114406108.png"></p><p><img src="/medias/img/gitlab/image-20221025114441914.png"></p><blockquote><p>修改完保存，刷新页面即可。</p></blockquote><p><img src="/medias/img/gitlab/image-20221025114638590.png"></p><blockquote><p>修改邮箱。</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155225288.png"></p><blockquote><p>登录邮箱，点击链接激活</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155251644.png"></p><blockquote><p>激活后邮箱为绿色可使用状态</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155310117.png"></p><blockquote><p>修改资料邮箱，并更新。</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155445235.png"></p><blockquote><p>修改通知邮箱</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155539455.png"></p><blockquote><p>这个时候就可以删除原邮箱啦</p></blockquote><p><img src="/medias/img/gitlab/image-20221025155558724.png"></p><blockquote><p>左上角切换到管理员配置。</p></blockquote><p><img src="/medias/img/gitlab/image-20221025114745270.png"></p><blockquote><p>如果你不需要，请禁止主动注册。注意<em><strong>保存按钮</strong></em>的位置！！！</p></blockquote><p><img src="/medias/img/gitlab/image-20221025114940488.png"></p><p><img src="/medias/img/gitlab/image-20221025115053846.png"></p><h1 id="使用外部nginx代理gitlab"><a href="#使用外部nginx代理gitlab" class="headerlink" title="使用外部nginx代理gitlab"></a>使用外部nginx代理gitlab</h1><blockquote><p>通过Nginx代理实现互联网访问使用本地内网服务器部署的GitLab并确保 SSH / HTTP 克隆地址正确</p></blockquote><p>一、环境说明：<br>    公司机房局域网组网，提供开发、测试、代码管理等，只有一个公网IP，通过外网防火墙映射到了其中一台外网服务器上，在这台服务器上安装ginx，实现了内网服务的域名解析等功能，提供外部访问能力。<br>    本文章主要介绍本地化代码管理服务<a href="https://so.csdn.net/so/search?q=GitLab&spm=1001.2101.3001.7020">GitLab</a>到配置，以提供外网正常访问。在公司某台内网的CentOS服务器上面安装GitLab（不会安装的百度一下GitLab本地安装），这里主要介绍安装完后的配置。<br>网络结构图如下：</p><p><img src="/medias/img/gitlab/image-fasfusafhajgfg.png"></p><blockquote><p>192.168.100.100==10.8.0.1，192.168.100.121==10.8.0.54</p></blockquote><p> 二、配置方法<br>    GitLab 安装完成后自己是有 Nginx 的，也是因为其存在，导致代理容易出问题，所以需要修改配置：</p><blockquote><ol><li>修改配置文件 gitlab.yml：<br>vim /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml</li></ol></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 修改内容如下</span>  <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>    <span class="token key atrule">host</span><span class="token punctuation">:</span> gitlab.domain.com    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">ssh_host</span><span class="token punctuation">:</span> gitlab.domain.com<span class="token comment"># 我这里使用的是 HTTPS 的，所以端口使用 443 并开启了 https，配置 ssh 地址。</span><span class="token comment"># git.xxx.com 是你自己解析到域名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><ol start="2"><li>修改配置文件 gitlab.rb：<br>vim /etc/gitlab/gitlab.rb</li></ol></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 配置域名地址    git.xxx.com 是你自己解析到域名</span>external_url 'https<span class="token punctuation">:</span>//gitlab.domain.com'<span class="token comment"># 配置 ssh 地址</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_ssh_host'</span><span class="token punctuation">]</span> = 'gitlab.domain.com'<span class="token comment"># Nginx 授信地址    10.8.0.1是局域网内提供公网服务到某台器的内网IP地址</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'trusted_proxies'</span><span class="token punctuation">]</span> = <span class="token punctuation">[</span><span class="token string">'10.8.0.1'</span><span class="token punctuation">]</span><span class="token comment"># SSH 端口</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_shell_ssh_port'</span><span class="token punctuation">]</span> = 55503<span class="token comment"># 服务监听方式&amp;地址</span>gitlab_workhorse<span class="token punctuation">[</span><span class="token string">'listen_network'</span><span class="token punctuation">]</span> = "tcp"gitlab_workhorse<span class="token punctuation">[</span><span class="token string">'listen_addr'</span><span class="token punctuation">]</span> = "0.0.0.0<span class="token punctuation">:</span>10080"<span class="token comment"># 禁用自带的 nginx</span>nginx<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false<span class="token comment">## 修改这些配置之后达到的效果：</span><span class="token comment">## gitlab自带的nginx关闭了，换成了监听tcp10080端口，这样就能使用前置nginx反向代理该端口。</span><span class="token comment">## 配置了域名地址和ssh地址端口，这样页面上的克隆地址就会是这里配置的地址，ssh端口使用55503是到</span><span class="token comment">## 时候nginx上面会使用的端口，gitlab 本身还是 22 的 ssh 端口。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>完整配置文件</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">external_url <span class="token string">'https://gitlab.domain.com'</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_ssh_host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'gitlab.domain.com'</span><span class="token comment"># 邮件系统</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.exmail.qq.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gitlab@domain.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Wxxxxxxxxxxxxxxg"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.exmail.qq.com"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'gitlab@domain.com'</span><span class="token comment"># 注意这些端口与下文nginx的配置文件配置的端口关系</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'trusted_proxies'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'10.8.0.1'</span><span class="token punctuation">]</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_shell_ssh_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">55503</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'manage_backup_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/var/opt/gitlab/backups"</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_keep_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">604800</span>gitlab_workhorse<span class="token punctuation">[</span><span class="token string">'listen_network'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"tcp"</span>gitlab_workhorse<span class="token punctuation">[</span><span class="token string">'listen_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0.0.0.0:10080"</span><span class="token comment"># 头像默认裂开，下面是配置代理，让头像显示完整</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gravatar_plain_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://sdn.geekzu.org/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon'</span>gitlab_rails<span class="token punctuation">[</span><span class="token string">'gravatar_ssl_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'https://sdn.geekzu.org/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon'</span>nginx<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token comment"># 如果不需要监控可以注释以下插件，释放主机内存</span>redis_exporter<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>postgres_exporter<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>node_exporter<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>gitlab_exporter<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>grafana<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>prometheus<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>alertmanager<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><ol start="3"><li>配置完成后重启 gitlab：</li></ol></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl reconfiguregitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><ol start="4"><li>配置作为代理的 nginx：</li></ol></blockquote><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">server &#123;    listen       80;    server_name  gitlab.domain.com;    return 301 https:&#x2F;&#x2F;$server_name$request_uri;&#125;server &#123;    listen       443 ssl http2;    server_name  gitlab.wujiops.cn;    charset utf-8;    ssl_certificate &#x2F;etc&#x2F;nginx&#x2F;cert&#x2F;wujiops.cn.cer;    ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;cert&#x2F;wujiops.cn.key;    ssl_session_timeout 1d;    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256::!MD5;    ssl_protocols TLSv1.2 TLSv1.3;    ssl_session_cache shared:MozSSL:10m;    ssl_prefer_server_ciphers on;    add_header Strict-Transport-Security &quot;max-age&#x3D;63072000&quot; always;    client_max_body_size 4096m;    access_log &#x2F;home&#x2F;app&#x2F;logs&#x2F;gitlab_access.log  main;    error_log  &#x2F;home&#x2F;app&#x2F;logs&#x2F;gitlab_error.log;    location &#x2F; &#123;        proxy_redirect http:&#x2F;&#x2F; https:&#x2F;&#x2F;;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-Ssl on;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_pass http:&#x2F;&#x2F;10.8.0.54:10080;    &#125;    error_page 404 &#x2F;404.html;    location &#x3D; &#x2F;404.html &#123;    &#125;    error_page 500 502 503 504 &#x2F;50x.html;    location &#x3D; &#x2F;50x.html &#123;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>5.tcp 反向代理，用于 ssh 克隆：</p></blockquote><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">stream &#123;    log_format proxy  &#39;$remote_addr [$time_local] &#39;                      &#39;$protocol $status $bytes_sent $bytes_received &#39;                      &#39;$session_time &quot;$upstream_addr&quot; &#39;                      &#39;&quot;$upstream_bytes_sent&quot; &quot;$upstream_bytes_received&quot; &quot;$upstream_connect_time&quot;&#39;;    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;tcp-access.log proxy ;    open_log_file_cache off;    server &#123;        listen     55503;        proxy_connect_timeout   300s;        proxy_timeout   300s;        proxy_pass gitlab;   # jump ssh port    &#125;    upstream gitlab &#123;        hash   $remote_addr consistent;        server 10.8.0.54:22;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，整个配置就完成了，重启Nginx服务，赶快在开发电脑上访问试试吧。</p><p><img src="/medias/img/gitlab/image-20230314103917017.png"></p><h1 id="重启，稍等一会验证"><a href="#重启，稍等一会验证" class="headerlink" title="重启，稍等一会验证"></a>重启，稍等一会验证</h1><p><code>gitlab-ctl restart</code>，慎重执行<code># gitlab-ctl reconfigure</code><br><img src="/medias/img/git/2.jpg"></p><p>执行<code>gitlab-ctl stop</code> <code>gitlab-ctl reconfigure</code> <code>gitlab-ctl start</code></p><h1 id="gitlab迁移"><a href="#gitlab迁移" class="headerlink" title="gitlab迁移"></a>gitlab迁移</h1><p>概述：<code>centos-7.7.1908</code> + <code>gitlab-ce-12.6.1</code> 迁移到 <code>centos-8.2.2004</code> + <code>gitlab-ce-13.3.6</code><br>PS：有博客提示需从<code>gitlab-ce-12.6.1</code>升级到<code>gitlab-ce-12.10.14</code>，再升级到<code>gitlab-ce-13.3.6</code><br>原因不能夸大版本升级，之能先升级到当前大版本的最后一个版本，之后依次升级到下一个大版本的最后一个版本，最后升级到最新的大版本的latest。</p><p>备份的文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份旧服务器上的文件</span>/etc/gitlab/gitlab.rb   <span class="token comment"># 配置文件须备份</span>/var/opt/gitlab/nginx/conf   <span class="token comment"># nginx 配置目录</span>/etc/postfix/main.cf   <span class="token comment"># postfix 邮件配置备份</span>gitlab-rake gitlab:backup:create   <span class="token comment"># 备份仓库、用户等数据tar包在/var/opt/gitlab/backups</span><span class="token comment"># 拷贝到新服务器gitlab.bak</span><span class="token function">scp</span> * gitlab.bak:/backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>搭建环境，安装gitlab-ce</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 仓库配置</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/yum.repos.d/gitlab-ce.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[gitlab-ce]name=Gitlab CE Repositorybaseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el\<span class="token variable">$releasever</span>/gpgcheck=0enabled=1EOF</span>yum list gitlab-ce <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>   <span class="token comment"># 当前yum仓库可安装gitlab-ce的版本</span>yum <span class="token function">install</span> gitlab-ce <span class="token parameter variable">-y</span>   <span class="token comment"># 安装</span><span class="token function">cat</span> /etc/gitlab/gitlab.rb <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">"^$|^#"</span>   <span class="token comment"># 对比两个配置文件1</span><span class="token function">cat</span> /backup/gitlab.rb   <span class="token comment"># 对比两个配置文件2</span>gitlab-ctl reconfigure   <span class="token comment"># 配置不启动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="git仓库清理"><a href="#git仓库清理" class="headerlink" title="git仓库清理"></a>git仓库清理</h1><h2 id="使用-BFG-存储库清洁剂"><a href="#使用-BFG-存储库清洁剂" class="headerlink" title="使用 BFG 存储库清洁剂"></a>使用 BFG 存储库清洁剂</h2><ol><li><p>从其开源社区存储库安装 BFG。</p></li><li><p>导航到存储库：</p></li></ol><p><code>cd my_repository/</code></p><ol start="3"><li>更改为要从中删除大文件的分支：</li></ol><p><code>git checkout master</code></p><ol start="4"><li>创建从分支中删除大文件的提交（如果该提交仍然存在）：</li></ol><p><code>git rm path/to/big_file.mpg</code></p><p><code>git commit -m &#39;Remove unneeded large file&#39;</code></p><ol start="5"><li>重写历史记录：</li></ol><p><code>bfg --delete-files path/to/big_file.mpg</code></p><p>对象映射文件将写入。保持它周围你需要它的最后一步！<code>object-id-map.old-new.txt</code></p><ol start="6"><li>强制将更改推送到 GitLab：</li></ol><p><code>git push --force-with-lease origin master</code></p><p>如果此步骤失败，则有人在您重写历史记录时更改了分支。您可以还原分支并重新运行 BFG 以保留其更改，或使用来覆盖其更改。<code>mastergit push --force</code></p><ol start="7"><li>导航到项目 &gt; 设置 &gt; 存储库 &gt; 存储库清理：</li></ol><p><img src="/medias/img/notes/0.png"><br>上传文件，然后按”开始清理”。这将删除对旧提交的任何内部 Git 引用，并针对存储库运行。完成后，您将收到一封电子邮件。<code>object-id-map.old-new.txtgit gc</code></p><p>注意：此过程将从 GitLab 的缓存和数据库中删除一些重写的提交副本，但在覆盖范围上仍然存在许多差距目前，某些副本可能会无限期地保留。清除实例缓存可能有助于删除其中一些缓存，但出于安全考虑，不应依赖它！</p><h2 id="使用git-filter-branch"><a href="#使用git-filter-branch" class="headerlink" title="使用git filter-branch"></a>使用git filter-branch</h2><ol><li>导航到存储库：</li></ol><p><code>cd my_repository/</code></p><ol start="2"><li>更改为要从中删除大文件的分支：</li></ol><p><code>git checkout master</code></p><ol start="3"><li>用于删除大文件：filter-branch</li></ol><p><code>git filter-branch --force --tree-filter &#39;rm -f path/to/big_file.mpg&#39; HEAD</code></p><p><code>git filter-branch --force --tree-filter &#39;rm -rf target/&#39; HEAD</code></p><ol start="4"><li>指示 Git 清除不需要的数据：</li></ol><p><code>git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive</code></p><ol start="5"><li>最后，强制推送到存储库(去除保护分支再推送)：</li></ol><p><code>git push --force origin master</code></p><p>您的存储库现在应低于大小限制。</p><h1 id="gitlab-ce原版安装"><a href="#gitlab-ce原版安装" class="headerlink" title="gitlab-ce原版安装"></a>gitlab-ce原版安装</h1><blockquote><p>anolis 8.8 安装 gitlab-ce</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/gitlab-ce.repo </span><span class="token punctuation">[</span>gitlab_gitlab-ce<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>gitlab_gitlab-ce<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://packages.gitlab.com/gitlab/gitlab-ce/el/8/<span class="token variable">$basearch</span><span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey       https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey/gitlab-gitlab-ce-3D645A26AB9FBD22.pub.gpg<span class="token assign-left variable">sslverify</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">sslcacert</span><span class="token operator">=</span>/etc/pki/tls/certs/ca-bundle.crt<span class="token assign-left variable">metadata_expire</span><span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">[</span>gitlab_gitlab-ce-source<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>gitlab_gitlab-ce-source<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://packages.gitlab.com/gitlab/gitlab-ce/el/8/SRPMS<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey       https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey/gitlab-gitlab-ce-3D645A26AB9FBD22.pub.gpg<span class="token assign-left variable">sslverify</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">sslcacert</span><span class="token operator">=</span>/etc/pki/tls/certs/ca-bundle.crt<span class="token assign-left variable">metadata_expire</span><span class="token operator">=</span><span class="token number">300</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dnf <span class="token function">install</span> gitlab-ce <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>配置参考gitlab-jh部分</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Phoenix应用</title>
      <link href="/posts/a4efbc46.html"/>
      <url>/posts/a4efbc46.html</url>
      
        <content type="html"><![CDATA[<h1 id="Phoenix简介"><a href="#Phoenix简介" class="headerlink" title="Phoenix简介"></a>Phoenix简介</h1><p>Phoenix作为应用层和HBASE之间的中间件,以下特性使它在大数据量的简单查询场景有着独有的优势</p><ul><li>二级索引支持(global index + local index)</li><li>编译SQL成为原生HBASE的可并行执行的scan</li><li>在数据层完成计算，server端的coprocessor执行聚合</li><li>下推where过滤条件到server端的scan filter上</li><li>利用统计信息优化、选择查询计划（5.x版本将支持CBO）</li><li>skip scan功能提高扫描速度</li></ul><p>一般可以使用以下三种方式访问Phoenix</p><ol><li><p>JDBC API</p></li><li><p>使用Python编写的命令行工具（sqlline, sqlline-thin和psql等）</p></li><li><p>SQuirrel</p></li></ol><h1 id="一、命令行工具psql使用示例"><a href="#一、命令行工具psql使用示例" class="headerlink" title="一、命令行工具psql使用示例"></a>一、命令行工具psql使用示例</h1><h2 id="1-创建一个建表的sql脚本文件us-population-sql："><a href="#1-创建一个建表的sql脚本文件us-population-sql：" class="headerlink" title="1.创建一个建表的sql脚本文件us_population.sql："></a>1.创建一个建表的sql脚本文件us_population.sql：</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> us_population <span class="token punctuation">(</span>    state <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    city <span class="token keyword">VARCHAR</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    population <span class="token keyword">BIGINT</span>    <span class="token keyword">CONSTRAINT</span> my_pk <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-创建csv格式的数据文件us-population-csv："><a href="#2-创建csv格式的数据文件us-population-csv：" class="headerlink" title="2. 创建csv格式的数据文件us_population.csv："></a>2. 创建csv格式的数据文件us_population.csv：</h2><pre class="line-numbers language-csv" data-language="csv"><code class="language-csv"><span class="token value">NY</span><span class="token punctuation">,</span><span class="token value">New York</span><span class="token punctuation">,</span><span class="token value">8143197</span><span class="token value">CA</span><span class="token punctuation">,</span><span class="token value">Los Angeles</span><span class="token punctuation">,</span><span class="token value">3844829</span><span class="token value">IL</span><span class="token punctuation">,</span><span class="token value">Chicago</span><span class="token punctuation">,</span><span class="token value">2842518</span><span class="token value">TX</span><span class="token punctuation">,</span><span class="token value">Houston</span><span class="token punctuation">,</span><span class="token value">2016582</span><span class="token value">PA</span><span class="token punctuation">,</span><span class="token value">Philadelphia</span><span class="token punctuation">,</span><span class="token value">1463281</span><span class="token value">AZ</span><span class="token punctuation">,</span><span class="token value">Phoenix</span><span class="token punctuation">,</span><span class="token value">1461575</span><span class="token value">TX</span><span class="token punctuation">,</span><span class="token value">San Antonio</span><span class="token punctuation">,</span><span class="token value">1256509</span><span class="token value">CA</span><span class="token punctuation">,</span><span class="token value">San Diego</span><span class="token punctuation">,</span><span class="token value">1255540</span><span class="token value">TX</span><span class="token punctuation">,</span><span class="token value">Dallas</span><span class="token punctuation">,</span><span class="token value">1213825</span><span class="token value">CA</span><span class="token punctuation">,</span><span class="token value">San Jose</span><span class="token punctuation">,</span><span class="token value">912332</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-创建一个查询sql脚本文件us-population-queries-sql"><a href="#3-创建一个查询sql脚本文件us-population-queries-sql" class="headerlink" title="3. 创建一个查询sql脚本文件us_population_queries.sql"></a>3. 创建一个查询sql脚本文件us_population_queries.sql</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> state <span class="token keyword">as</span> <span class="token string">"State"</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"City Count"</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"Population Sum"</span><span class="token keyword">FROM</span> us_population<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> state<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token function">sum</span><span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-执行psql-py工具运行sql脚本"><a href="#4-执行psql-py工具运行sql脚本" class="headerlink" title="4. 执行psql.py工具运行sql脚本"></a>4. 执行psql.py工具运行sql脚本</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">.</span><span class="token operator">/</span>psql<span class="token punctuation">.</span>py <span class="token operator">&lt;</span>your_zookeeper_quorum<span class="token operator">></span> us_population<span class="token punctuation">.</span><span class="token keyword">sql</span> us_population<span class="token punctuation">.</span>csv us_population_queries<span class="token punctuation">.</span><span class="token keyword">sql</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="二、JDBC-API使用示例"><a href="#二、JDBC-API使用示例" class="headerlink" title="二、JDBC API使用示例"></a>二、JDBC API使用示例</h1><h2 id="1-使用Maven构建工程时，需要添加以下依赖"><a href="#1-使用Maven构建工程时，需要添加以下依赖" class="headerlink" title="1. 使用Maven构建工程时，需要添加以下依赖"></a>1. 使用Maven构建工程时，需要添加以下依赖</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.aliyun.phoenix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>ali-phoenix-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-创建名为test-java的文件"><a href="#2-创建名为test-java的文件" class="headerlink" title="2. 创建名为test.java的文件"></a>2. 创建名为test.java的文件</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Statement</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">ResultSet</span> rset <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>              <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:phoenix:[zookeeper]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stmt <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              stmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token string">"create table test (mykey integer not null primary key, mycolumn varchar)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token string">"upsert into test values (1,'Hello')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token string">"upsert into test values (2,'World!')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        con<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"select * from test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rset <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>rset<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rset<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"mycolumn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        statement<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-执行test-java"><a href="#3-执行test-java" class="headerlink" title="3.执行test.java"></a>3.执行test.java</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">javac test<span class="token punctuation">.</span>javajava <span class="token operator">-</span>cp <span class="token string">"../phoenix-[version]-client.jar:."</span> test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="什么是SQuirrel？"><a href="#什么是SQuirrel？" class="headerlink" title="什么是SQuirrel？"></a>什么是SQuirrel？</h1><p><a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http://www.squirrelsql.org/">SQuirreL SQL Client</a>是一个开源免费软件, 可以通过jdbc对多种数据库进行可视化的管理，查询等。</p><h1 id="安装SQuirrel访问Phoenix"><a href="#安装SQuirrel访问Phoenix" class="headerlink" title="安装SQuirrel访问Phoenix"></a>安装SQuirrel访问Phoenix</h1><ol><li>下载最新的<a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http://www.squirrelsql.org/%23installation">SQuirrel</a></li><li>安装SQuirrel<br><img src="/medias/img/phoenix/0.jpg"></li><li>在云Hbase官网下载最新版的<a href="https://help.aliyun.com/document_detail/53600.html?spm=5176.product49055.6.553.ZkkmG9">phoneix</a>, 解压后将phoenix-4.11.0-AliHBase–client.jar拷贝到SQuirrel根目录的lib文件夹下。</li><li>启动SQuirrel， 可以通过Windows-&gt;View SQuirrel Logs查询运行日志。<br><img src="/medias/img/phoenix/1.jpg"></li></ol><h1 id="配置SQuirrel链接Phoenix"><a href="#配置SQuirrel链接Phoenix" class="headerlink" title="配置SQuirrel链接Phoenix"></a>配置SQuirrel链接Phoenix</h1><ol><li>设置Phoenix JDBC DRIVE。点击Drivers进行设置，Name项根据自己需要填写，Website URL可以省略，其余根据实际情况填写。然后点击OK确认。<br><img src="/medias/img/phoenix/2.jpg"></li><li>配置Phoenix链接。点击Aliases, 配置链接。Name项根据自己需要填写，Username和Password是访问数据库的账户名和密码（此示例中链接hbase不需要用户和密码，所以这两项为空）。<br><img src="/medias/img/phoenix/3.jpg"></li><li>链接Phoenix<br><img src="/medias/img/phoenix/4.jpg"></li></ol><h1 id="在SQuirrel中如何配置Phoenix参数"><a href="#在SQuirrel中如何配置Phoenix参数" class="headerlink" title="在SQuirrel中如何配置Phoenix参数"></a>在SQuirrel中如何配置Phoenix参数</h1><p>Phoenix客户端参数可以通过hbase-site.xm文件进行配置，我们只需要将需要配置项填在此文件中，并放置在SQuirrel启动的classpath中就能生效。</p><p>以配置phoenix.force.index为例：</p><ol><li>在未对phoenix.force.index进行设置时，默认值为true。那么在查询中查询非索引列时会报错。<br><img src="/medias/img/phoenix/5.jpg"></li><li>在hbase-site.xml中添加如下配置，并在SQuirrel根目录的lib文件夹中创建conf文件夹， 将hbase-site.xml移动至conf文件夹下，重启SQuirrel.</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>phoenix.force.index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/phoenix/6.jpg"></p><p>PS：连接如果报错：<code>ClusterId read in ZooKeeper is null。</code></p><p>请检查hbase-site.xml配置的zookeeper.znode.parent属性值。</p><p>如果配置的是：/hbase-unsecure，那么url地址要带上</p><pre class="line-numbers language-XML" data-language="XML"><code class="language-XML">zk node: jdbc:phoenix:xxxxx:2181:&#x2F;hbase-unsecure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phoenix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqoop应用</title>
      <link href="/posts/3ce40967.html"/>
      <url>/posts/3ce40967.html</url>
      
        <content type="html"><![CDATA[<h1 id="一、sqoop概念"><a href="#一、sqoop概念" class="headerlink" title="一、sqoop概念"></a>一、sqoop概念</h1><h2 id="1-官网"><a href="#1-官网" class="headerlink" title="1. 官网:"></a>1. 官网:</h2><p><a href="http://sqoop.apache.org/">http://sqoop.apache.org/</a></p><h2 id="2-描述"><a href="#2-描述" class="headerlink" title="2. 描述:"></a>2. 描述:</h2><p>Sqoop是一个用来将关系型数据库和Hadoop中的数据进行相互转移的工具，可以将一个关系型数据库(例如Mysql、Oracle)中的数据导入到Hadoop(例如HDFS、Hive、Hbase)中，也可以将Hadoop(例如HDFS、Hive、Hbase)中的数据导入到关系型数据库(例如Mysql、Oracle)中。如下图所示：<br><img src="/medias/img/sqoop/0.jpg"></p><h2 id="3-场景"><a href="#3-场景" class="headerlink" title="3. 场景:"></a>3. 场景:</h2><h3 id="1-数据迁移"><a href="#1-数据迁移" class="headerlink" title="(1)数据迁移"></a>(1)数据迁移</h3><p>企业大数据平台关系型数据仓库中的数据以分析为主，综合考虑扩展性、容错性和成本开销等方面。若将数据迁移到Hadoop大数据平台上，可以方便地使用Hadoop提供的如Hive、SparkSQL分布式系统等工具进行数据分析。为了一次性将数据导入Hadoop存储系统，可使用Sqoop。</p><h3 id="2-可视化分析结果"><a href="#2-可视化分析结果" class="headerlink" title="(2)可视化分析结果"></a>(2)可视化分析结果</h3><p>Hadoop处理的输入数据规模可能是非常庞大的，比如PB级别，但最终产生的分析结果可能不会太大，比如报表数据等，而这类结果通常需要进行可视化，以便更直观地展示分析结果。目前绝大部分可视化工具与关系型数据库对接得比较好，因此，比较主流的做法是，将Hadoop产生的结果导入关系型数据库进行可视化展示。</p><h3 id="3-数据增量导入"><a href="#3-数据增量导入" class="headerlink" title="(3)数据增量导入"></a>(3)数据增量导入</h3><p>考虑到Hadoop对事务的支持比较差，因此，凡是涉及事务的应用，比如支付平台等，后端的存储均会选择关系数据库，而事务相关的分析数据，比如用户支付行为等，可能在Hadoop分析过程中用到（比如广告系统，推荐系统等）。为了减少Hadoop分析过程中影响这类系统的性能，我们通常不会直接让Hadoop访问这些关系型数据库，而是单独导入一份到Hadoop存储系统中。</p><h1 id="二、架构"><a href="#二、架构" class="headerlink" title="二、架构"></a>二、架构</h1><h2 id="1-hadoop业务开发流程"><a href="#1-hadoop业务开发流程" class="headerlink" title="1. hadoop业务开发流程:"></a>1. hadoop业务开发流程:</h2><p>在实际的业务当中，我们首先对原始数据集通过MapReduce进行数据清洗，然后将清洗后的数据存入到Hbase数据库中，而后通过数据仓库Hive对Hbase中的数据进行统计与分析，分析之后将分析结果存入到Hive表中，然后通过Sqoop这个工具将我们的数据挖掘结果导入到MySql数据库中，最后通过Web将结果展示。如下图所示:</p><p><img src="/medias/img/sqoop/1.jpg"></p><h2 id="2-Sqoop架构"><a href="#2-Sqoop架构" class="headerlink" title="2. Sqoop架构:"></a>2. Sqoop架构:</h2><p>Sqoop工具接收到客户端的shell命令或者Java api命令后，通过Sqoop中的任务翻译器(Task Translator)将命令转换为对应的MapReduce任务，而后将关系型数据库和Hadoop中的数据进行相互转移，进而完成数据的拷贝。如下图所示:</p><p><img src="/medias/img/sqoop/2.jpg"></p><h1 id="三、应用"><a href="#三、应用" class="headerlink" title="三、应用"></a>三、应用</h1><h2 id="1-Sqoop导入-import"><a href="#1-Sqoop导入-import" class="headerlink" title="1. Sqoop导入(import):"></a>1. Sqoop导入(import):</h2><h3 id="1-示例场景"><a href="#1-示例场景" class="headerlink" title="(1) 示例场景:"></a>(1) 示例场景:</h3><p>将mysql数据库中的bigDataCity表通过Sqoop导入到hive数据库中。</p><h3 id="2-命令"><a href="#2-命令" class="headerlink" title="(2) 命令:"></a>(2) 命令:</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop <span class="token function">import</span> <span class="token comment"># 指定JDBC的URL 其中iitData指的是(Mysql或者Oracle)中的数据库名 </span><span class="token parameter variable">--connect</span> jdbc:mysql://192.168.1.110:3306/iitData <span class="token comment"># 指的是Mysql数据库中的用户名</span><span class="token parameter variable">--username</span> iituser <span class="token comment"># 指的是Mysql数据库中的用户名密码</span><span class="token parameter variable">--password</span> iit123 <span class="token comment"># 指的是要读取数据库iitData中的表名</span><span class="token parameter variable">--table</span> bigDataCity <span class="token comment"># 导入表中的部分字段，后面跟指定的列名</span><span class="token parameter variable">--columns</span> <span class="token string">"ciryID,cityName,provincialID"</span><span class="token comment"># 指的是hive数据库导入</span>--hive-import <span class="token comment"># 指的是hive数据库创建表</span>--create-hive-table <span class="token comment"># 设定导入数据后每个字段的分隔符</span>--fields-terminated-by <span class="token string">"<span class="token entity" title="\t">\t</span>"</span><span class="token comment"># 并发的map数量</span><span class="token parameter variable">-m</span> <span class="token number">1</span><span class="token comment"># 指的是HDFS中导入表的存放目录(注意：是目录)</span>--target-dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-导入"><a href="#3-导入" class="headerlink" title="(3) 导入:"></a>(3) 导入:</h3><p><img src="/medias/img/sqoop/3.jpg"><br><img src="/medias/img/sqoop/4.jpg"></p><h2 id="2-Sqoop导出-export"><a href="#2-Sqoop导出-export" class="headerlink" title="2. Sqoop导出(export):"></a>2. Sqoop导出(export):</h2><h3 id="1-示例场景-1"><a href="#1-示例场景-1" class="headerlink" title="(1)示例场景:"></a>(1)示例场景:</h3><p>将hive数据库中的test表通过Sqoop导出到mysql数据库中。</p><p>注：从Hadoop向数据库中导入数据时，数据库中相应的表事先必须创建好。 </p><h3 id="2-命令-1"><a href="#2-命令-1" class="headerlink" title="(2)命令:"></a>(2)命令:</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop <span class="token builtin class-name">export</span> <span class="token comment"># 指定JDBC的URL 其中iitData指的是(Mysql或者Oracle)中的数据库名</span><span class="token parameter variable">--connect</span> jdbc:mysql://192.168.1.42/mytable<span class="token comment"># 指的是Mysql数据库中的用户名和密码</span><span class="token parameter variable">--username</span> root <span class="token comment"># 指的是Mysql数据库中的用户名密码</span><span class="token parameter variable">--password</span> root <span class="token comment"># 指的是要读取数据库iitData中的表名</span><span class="token parameter variable">--table</span> <span class="token builtin class-name">test</span><span class="token comment"># 设定导入数据后每个字段的分隔符 </span>--fields-terminated-by <span class="token string">"<span class="token entity" title="\t">\t</span>"</span> <span class="token comment"># 指的是HDFS中即将被导出的文件目录(注意：是目录)</span>--export-dir /warehouse/tablespace/managed/hive/test/base_0000002<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-导出"><a href="#3-导出" class="headerlink" title="(3)导出:"></a>(3)导出:</h3><p><img src="/medias/img/sqoop/5.jpg"><br><img src="/medias/img/sqoop/6.jpg"><br><img src="/medias/img/sqoop/7.jpg"><br><img src="/medias/img/sqoop/8.jpg"></p><h2 id="3-批量导入"><a href="#3-批量导入" class="headerlink" title="3. 批量导入:"></a>3. 批量导入:</h2><h3 id="1-示例场景-2"><a href="#1-示例场景-2" class="headerlink" title="(1) 示例场景:"></a>(1) 示例场景:</h3><p>将mysql数据库中的test表数据通过Sqoop批量导入到hive数据库中的test表。</p><h3 id="2-命令-2"><a href="#2-命令-2" class="headerlink" title="(2) 命令:"></a>(2) 命令:</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop <span class="token function">import</span> <span class="token comment"># 导入的字段为空时，用指定的字符进行替换 </span>--null-string <span class="token string">' '</span><span class="token comment"># 增量导入 </span><span class="token parameter variable">--incremental</span> append<span class="token comment"># 指定增量导入时的参考列 </span>--check-column <span class="token function">id</span><span class="token comment"># 上一次导入的最后一个值 </span>--last-value <span class="token number">1205</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-导入-1"><a href="#3-导入-1" class="headerlink" title="(3) 导入:"></a>(3) 导入:</h3><p><img src="/medias/img/sqoop/9.jpg"><br><img src="/medias/img/sqoop/10.jpg"><br><img src="/medias/img/sqoop/11.jpg"><br><img src="/medias/img/sqoop/12.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sqoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSL证书配置</title>
      <link href="/posts/bc32d58.html"/>
      <url>/posts/bc32d58.html</url>
      
        <content type="html"><![CDATA[<h1 id="nginx-ssl"><a href="#nginx-ssl" class="headerlink" title="nginx ssl"></a>nginx ssl</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># nginx yum源配置</span><span class="token punctuation">[</span>root@nginx conf.d<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/nginx.repo </span><span class="token punctuation">[</span>nginx-stable<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>nginx stable repo<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://nginx.org/packages/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://nginx.org/keys/nginx_signing.key<span class="token assign-left variable">module_hotfixes</span><span class="token operator">=</span>true<span class="token comment"># 配置文件</span><span class="token punctuation">[</span>root@nginx conf.d<span class="token punctuation">]</span><span class="token comment"># cat gitlab.conf</span><span class="token comment"># 80 -- > 443 自动跳转</span>server <span class="token punctuation">&#123;</span>    listen       <span class="token number">80</span><span class="token punctuation">;</span>    server_name  gitlab.wujiops.cn<span class="token punctuation">;</span>    <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>server <span class="token punctuation">&#123;</span>    listen       <span class="token number">443</span> ssl<span class="token punctuation">;</span>    server_name  gitlab.wujiops.cn<span class="token punctuation">;</span>    charset utf-8<span class="token punctuation">;</span>    <span class="token comment"># 证书配置</span>    ssl_certificate /etc/nginx/cert/wujiops.cn.cer<span class="token punctuation">;</span>    ssl_certificate_key /etc/nginx/cert/wujiops.cn.key<span class="token punctuation">;</span>    ssl_session_timeout 1d<span class="token punctuation">;</span>    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256::<span class="token operator">!</span>MD5<span class="token punctuation">;</span>    ssl_protocols TLSv1.2 TLSv1.3<span class="token punctuation">;</span>    ssl_session_cache shared:MozSSL:10m<span class="token punctuation">;</span>    ssl_prefer_server_ciphers on<span class="token punctuation">;</span>    add_header Strict-Transport-Security <span class="token string">"max-age=63072000"</span> always<span class="token punctuation">;</span>    client_max_body_size 4096m<span class="token punctuation">;</span>    access_log /home/app/logs/gitlab_access.log  main<span class="token punctuation">;</span>    error_log  /home/app/logs/gitlab_error.log<span class="token punctuation">;</span>    <span class="token comment"># nginx 反向代理配置</span>    location / <span class="token punctuation">&#123;</span>        proxy_redirect http:// https://<span class="token punctuation">;</span>        proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-Ssl on<span class="token punctuation">;</span>        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        proxy_pass http://192.168.1.15:18080<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>    location <span class="token operator">=</span> /404.html <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>    location <span class="token operator">=</span> /50x.html <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="apache-ssl"><a href="#apache-ssl" class="headerlink" title="apache ssl"></a>apache ssl</h1><p>检查<code>apache</code>是否启用<code>mod_ssl</code>模块，一般情况下会在<code>/etc/httpd/conf.d/</code>下存在<code>ssl.conf</code>文件。</p><h2 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h2><p>安装<code>mod_ssl</code>模块</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> mod_ssl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="修改ssl-conf文件"><a href="#修改ssl-conf文件" class="headerlink" title="修改ssl.conf文件"></a>修改ssl.conf文件</h2><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">&lt;VirtualHost _default_:443&gt;DocumentRoot &quot;&#x2F;var&#x2F;www&#x2F;html&quot;ServerName roxn.cn:443SSLEngine onSSLProtocol all -SSLv2 -SSLv3SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUMSSLHonorCipherOrder onSSLCipherSuite PROFILE&#x3D;SYSTEMSSLProxyCipherSuite PROFILE&#x3D;SYSTEMSSLCertificateFile &#x2F;etc&#x2F;pki&#x2F;tls&#x2F;certs&#x2F;apache&#x2F;4434998_roxn.cn_public.crtSSLCertificateKeyFile &#x2F;etc&#x2F;pki&#x2F;tls&#x2F;certs&#x2F;apache&#x2F;4434998_roxn.cn.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改httpd-conf，使http跳转到https"><a href="#修改httpd-conf，使http跳转到https" class="headerlink" title="修改httpd.conf，使http跳转到https"></a>修改httpd.conf，使http跳转到https</h2><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">&lt;VirtualHost *:80&gt;    RewriteEngine on    RewriteCond %&#123;SERVER_PORT&#125; !^443$    RewriteRule ^(.*)$ https:&#x2F;&#x2F;%&#123;SERVER_NAME&#125;$1 [L,R]&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="重启验证"><a href="#重启验证" class="headerlink" title="重启验证"></a>重启验证</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/gif/0.gif"></p><h1 id="acme-sh"><a href="#acme-sh" class="headerlink" title="acme.sh"></a>acme.sh</h1><blockquote><p>以下报错检查~/.acme.sh/account.conf文件中SAVED_DP_Id和SAVED_DP_Key的值是否正确<br>或者手动添加TXT验证</p><p>invalid domain<br>Error add txt for domain:_acme-challenge.wujiops.cn<br>Please add ‘–debug’ or ‘–log’ to check more details.<br>See: <a href="https://github.com/acmesh-official/acme.sh/wiki/How-to-debug-acme.sh">https://github.com/acmesh-official/acme.sh/wiki/How-to-debug-acme.sh</a></p></blockquote><p><a href="https://console.dnspod.cn/account/token/token">DNSPod需要申请id和token</a><br><a href="https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E">acme.sh中文文档：可以修改证书品牌和DNS服务商</a><br><a href="https://github.com/acmesh-official/acme.sh#supported-ca">支持的证书品牌</a><br><a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi#how-to-use-dns-api">支持的DNS厂商</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这里使用的是默认的ZeroSSL.com CA，和DNSPod解析</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">DP_Id</span><span class="token operator">=</span><span class="token string">""</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">DP_Key</span><span class="token operator">=</span><span class="token string">""</span><span class="token comment"># 安装acme</span><span class="token function">curl</span> https://get.acme.sh <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> <span class="token assign-left variable">email</span><span class="token operator">=</span>my@wujiops.cn<span class="token comment"># 签发泛域证书</span>acme.sh <span class="token parameter variable">--issue</span> <span class="token parameter variable">--dns</span> dns_dp <span class="token parameter variable">-d</span> *.wujiops.cn<span class="token comment"># acme会自动续签</span><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ls .acme.sh/\*.wujiops.cn/ -ltrh</span>总用量 36K-rw------- <span class="token number">1</span> root root <span class="token number">1</span>.7K <span class="token number">6</span>月  <span class="token number">10</span> <span class="token number">2022</span> *.wujiops.cn.key   <span class="token comment"># 私钥</span>-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">147</span> <span class="token number">6</span>月  <span class="token number">19</span> 00:59 *.wujiops.cn.csr.conf-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">952</span> <span class="token number">6</span>月  <span class="token number">19</span> 00:59 *.wujiops.cn.csr-rw-r--r-- <span class="token number">1</span> root root <span class="token number">6</span>.6K <span class="token number">6</span>月  <span class="token number">19</span> 01:00 fullchain.cer   <span class="token comment"># 全链路证书 nginx配置这两个证书即可</span>-rw-r--r-- <span class="token number">1</span> root root <span class="token number">2</span>.3K <span class="token number">6</span>月  <span class="token number">19</span> 01:00 *.wujiops.cn.cer-rw-r--r-- <span class="token number">1</span> root root <span class="token number">4</span>.3K <span class="token number">6</span>月  <span class="token number">19</span> 01:00 ca.cer-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">554</span> <span class="token number">6</span>月  <span class="token number">19</span> 01:00 *.wujiops.cn.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>Short Name</th><th>ACME server URL</th><th>Usage Wiki</th></tr></thead><tbody><tr><td>letsencrypt</td><td><a href="https://acme-v02.api.letsencrypt.org/directory">https://acme-v02.api.letsencrypt.org/directory</a></td><td>N/A</td></tr><tr><td>letsencrypt_test</td><td><a href="https://acme-staging-v02.api.letsencrypt.org/directory">https://acme-staging-v02.api.letsencrypt.org/directory</a></td><td>N/A</td></tr><tr><td>buypass</td><td><a href="https://api.buypass.com/acme/directory">https://api.buypass.com/acme/directory</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/BuyPass.com-CA">BuyPass.com CA</a></td></tr><tr><td>buypass_test</td><td><a href="https://api.test4.buypass.no/acme/directory">https://api.test4.buypass.no/acme/directory</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/BuyPass.com-CA">BuyPass.com CA</a></td></tr><tr><td>zerossl</td><td><a href="https://acme.zerossl.com/v2/DV90">https://acme.zerossl.com/v2/DV90</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/ZeroSSL.com-CA">ZeroSSL.com CA</a></td></tr><tr><td>sslcom</td><td><a href="https://acme.ssl.com/sslcom-dv-rsa">https://acme.ssl.com/sslcom-dv-rsa</a>, <a href="https://acme.ssl.com/sslcom-dv-ecc">https://acme.ssl.com/sslcom-dv-ecc</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/SSL.com-CA">SSL.com CA</a></td></tr><tr><td>google</td><td><a href="https://dv.acme-v02.api.pki.goog/directory">https://dv.acme-v02.api.pki.goog/directory</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/Google-Public-CA">Google Public CA</a></td></tr><tr><td>googletest</td><td><a href="https://dv.acme-v02.test-api.pki.goog/directory">https://dv.acme-v02.test-api.pki.goog/directory</a></td><td><a href="https://github.com/acmesh-official/acme.sh/wiki/Google-Public-CA">Google Public CA</a></td></tr></tbody></table><br><table><thead><tr><th>CA</th><th>MaxLifetime</th><th>ECC</th><th>Domain Count</th><th>Wildcard</th><th>IPv4</th><th>IPv6</th><th>NotAfter</th><th>IDN</th></tr></thead><tbody><tr><td>Let’s Encrypt</td><td>90</td><td>Yes</td><td>100</td><td>Yes</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>ZeroSSL</td><td>90</td><td>Yes</td><td>100</td><td>Yes</td><td>No</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Google</td><td>90</td><td>Yes</td><td>100</td><td>Yes</td><td>No</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Buypass</td><td>180</td><td>Yes</td><td>5</td><td>Paid</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>SSL.com</td><td>90</td><td>Yes</td><td>2</td><td>Paid</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>HiCA</td><td>180</td><td>Paid</td><td>10 (1 if Wildcard)</td><td>Yes</td><td>Paid</td><td>Paid</td><td>No</td><td>Paid</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssl证书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(九)</title>
      <link href="/posts/292d767f.html"/>
      <url>/posts/292d767f.html</url>
      
        <content type="html"><![CDATA[<p>类和方法的源码下载地址:<a href="https://wujiops.coding.net/p/download/d/code/git/raw/master/%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95.zip" title="类和方法.zip">download</a></p><h1 id="关于类的理解"><a href="#关于类的理解" class="headerlink" title="关于类的理解"></a><font size=5>关于类的理解</font></h1><p>编写有意义的面向对象的代码</p><p>类 = 面向对象 ❌</p><p>类命名（建议：首字母大写、连接词首字母大写（变量，最好小写、连接词使用下划线连接））、对象（看下文）</p><p>实例化（下文）</p><p>类只负责去定义或去刻画一些东西，但是它不负责去执行代码。  运行或调用这个类，要在此类的外部。（非要在类内部调用，那这个类就变成了一个函数）</p><h1 id="函数和类"><a href="#函数和类" class="headerlink" title="函数和类"></a><font size=5>函数和类</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># class定义类，def定义函数</span><span class="token comment"># 函数：</span><span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义函数名</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> x <span class="token operator">+</span> y   <span class="token comment"># 定义函数体</span>    <span class="token keyword">return</span> <span class="token builtin">sum</span>a <span class="token operator">=</span> name<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment"># 传入实参</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># 打印结果</span><span class="token comment"># 类：</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义类名</span>    school <span class="token operator">=</span> <span class="token string">'类小学'</span>   <span class="token comment"># 定义类体，类的特性表现形式，又称数据成员</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token string">'100'</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> school<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 构造函数，对类初始化。（构造函数__init__，在实例化的时候做一些类的初始化的工作）</span>        self<span class="token punctuation">.</span>school <span class="token operator">=</span> school   <span class="token comment"># 定义实例变量，对于对象来说。（类是一个大范围，对象是一个具体事物）</span>        self<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span>    <span class="token comment"># 如果注释这一行,会去找类中的sum(注一)</span>    <span class="token keyword">def</span> <span class="token function">workbook</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义方法（或者称函数），对于类来说。（类方法）</span>        <span class="token keyword">pass</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>school<span class="token punctuation">)</span>    <span class="token comment"># 类变量没有实例化也可以调用，实例化之后通过实例也可以调用</span>school1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'abc小学'</span><span class="token punctuation">,</span> <span class="token string">'1000'</span><span class="token punctuation">)</span>   <span class="token comment"># 实例化，实例化意义：获取一个具体的对象</span>school2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'哈哈小学'</span><span class="token punctuation">,</span> <span class="token string">'900'</span><span class="token punctuation">)</span>   <span class="token comment"># （实例化一个对象）</span><span class="token keyword">print</span><span class="token punctuation">(</span>school1<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>   <span class="token comment"># 打印结果（(解注一)先找实例本身，没有的话就去类里找）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="类"><a href="#类" class="headerlink" title="类"></a><font size=4>类</font></h2><p>类的定义和类下面方法的调用，类最基本的作用：封装函数体(封装方法)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 面向对象.py</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">''</span>   <span class="token comment"># 类体（对比函数体学习）</span>    age <span class="token operator">=</span> <span class="token string">'0'</span>    <span class="token keyword">def</span> <span class="token function">print_file</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># （self下文讲,这是方法,注二）</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'name: '</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'age: '</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>age<span class="token punctuation">)</span>student <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 其他语言使用 new Student() 调用Student类, 在python中直接使用</span>student<span class="token punctuation">.</span>print_file<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 调用类下面的方法，（函数和方法的区别下文讲）</span><span class="token comment"># class StudentHomework():   # 模块里面可以有多个类</span><span class="token comment">#     homework_name = ''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="引用类"><a href="#引用类" class="headerlink" title="引用类"></a><font size=4>引用类</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> 面向对象 <span class="token keyword">import</span> Studentstudent <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>student<span class="token punctuation">.</span>print_file<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 可以这样在另一个模块中引用类，但是这样会让代码看起来非常松散</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>方法</strong> 和 <strong>函数</strong> 的区别：（初学者对此不必纠结。下文只是建议）</p><p>在C、C++更多称为函数，在java、C#里更多称为方法（对def name(): \n pass的称谓）</p><p>方法是设计层面的一个称谓。函数是程序运行、过程式的称谓</p><p>变量在模块里面，称为变量；在类里面，更多称为数据成员。</p><p><strong>类</strong> 和 <strong>对象</strong> 有什么区别？</p><p>通用定义：类是现实世界或思维世界中的实体在计算机中的反映，它将数据以及这些数据上的操作封装在一起</p><p>在Student类里面，学生有很多的特性（名字、年龄、性别等）在类里面是由 数据成员 来表示的，还因该有它们的行为（做作业、考试等）</p><p>行为用方法表示。</p><p>类设置的好不好关键看行为与特征。 </p><p><strong>对象</strong>：表示一个具体的概念（类比’学生类’，学生类代表学生整体，对象就是具体的一个学生）</p><p>换句话说，类只是告诉我们对于一个学生群体来说，每一个学生都会有它的特征名字和年龄等，但是年龄具体取什么值，名字具体取什么值，需要实例化来完成。当类被实例化了以后，就变成了一个对象。</p><p>在类被实例化的时候，需要我们往类里面传递具体值，然后才能得到一个具体的对象。</p><h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a><font size=5>对象</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 定义一个学生类</span>    name <span class="token operator">=</span> <span class="token string">''</span>   <span class="token comment"># 学生的特征</span>    age <span class="token operator">=</span> <span class="token string">'0'</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 学生的行为：做作业</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a><font size=4>实例化</font></h2><p>实例化的意义：用模板创建一个新的对象</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">''</span>    age <span class="token operator">=</span> <span class="token string">'7'</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 然在实际代表一个事物，</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>student3 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>student1<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 但是在计算机中，打印的内存地址是不同的。</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>student2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>student3<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>类变量</strong>和<strong>实例变量</strong>，类和模块的行为要区分对待，类有自己的规则和特性</p><p>类变量，和类相关联的变量；</p><p>实例变量，是和对象相关联的</p><h3 id="案例一："><a href="#案例一：" class="headerlink" title="案例一："></a><font size=3>案例一：</font></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'abc'</span>   <span class="token comment"># 这样定义是否有意义：答案是没有意义的。名字和年龄是小明小红的属性，不是学生的属性，但是python语法是对的</span>    age <span class="token operator">=</span> <span class="token string">'7'</span>   <span class="token comment"># 这里可以定义一个sum = 100，一个班级学生总数。对比name和age可能会好一点。</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># __init__称为构造函数，在构造函数中，最常用的初始化类的特征</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name   <span class="token comment"># 定义实例变量：self.变量名（self下文讲,注二，可以是任意标识如abc，python建议是self）</span>        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        <span class="token comment"># return None   # __init__函数和不同函数的区别，init函数不能返回任意的字符串，只能是None(可以省略此行)</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">)</span>   <span class="token comment"># 实例化</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">)</span>student3 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'大壮'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token comment"># 构造函数的调用是自动进行的，当你在实例化的时候，python会自动帮你调用__init__构造函数。</span><span class="token comment"># 也能手动调用（很少显式调用）。就是说不必使用下面三行代码调用构造函数。</span><span class="token comment"># student1.__init__()</span><span class="token comment"># student2.__init__()</span><span class="token comment"># student3.__init__()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="案例二："><a href="#案例二：" class="headerlink" title="案例二："></a><font size=3>案例二：</font></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'abc'</span>    age <span class="token operator">=</span> <span class="token string">'0'</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name    <span class="token comment"># 定义实例变量，如果没有前面的self，print(student1.__dict__)是空的字典。并且字典里面只有设置了self.*这样的元素</span>        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>    <span class="token comment"># 实例化一个对象</span><span class="token comment"># print(student1.name)    # 直接打印是空</span><span class="token comment"># print(Student.name)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token comment"># 实例变量和类里面都有__dict__函数。使用print()可以查看变量名和变量值的对应关系。</span><span class="token comment"># 如果python访问一个实例变量，找不到会到类里面去找，再找不到去父类里面去找。</span><span class="token comment"># 类里面也有__dict__变量，</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解,注二:</p><p><strong>实例方法</strong>，对类下面的实例方法，默认会有一个self，调用的时候默认传入，不需要手动添加。</p><p>self必须是显示的（和其它语言this.几乎是一样的。其它语言是隐藏的），但是可以是任意字符，只是默认为self（不建议更换成其他字符）</p><p>self就是当前调用某一个方法的对象；self代表的是实例，而不是类。（self必须要写，当然你也可以不叫self）</p><p>实例方法最大的特点，第一个参数是需要传入一个self，实例方法是和实例对象相关联的，也是实例可以调用的方法</p><p><strong>总结：</strong></p><p>类包含：变量（类变量、实例变量）；方法（实例方法、类方法、静态方法）；构造函数</p><p>方法和变量的关系：从面向对象角度：方法代表类的行为，变量代表刻画一个类的特征。（变量用来刻画名字和年龄，而方法用来描述我们可以做什么事情以及我们自身的一些行为）</p><p>在绝大多数情况下面，方法需要对变量做一系列运算，或者说逻辑上的操作，最终去改变变量的状态。当然方法也可以不操作任何变量（少数）</p><h1 id="补充：类的专有方法"><a href="#补充：类的专有方法" class="headerlink" title="补充：类的专有方法"></a><font size=5>补充：类的专有方法</font></h1><table><thead><tr><th align="left">方法</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">__init__</td><td align="left">构造函数，在生成对象时调用</td></tr><tr><td align="left">__del__</td><td align="left">析构函数，释放对象时使用</td></tr><tr><td align="left">__repr__</td><td align="left">打印，转换</td></tr><tr><td align="left">__setitem__</td><td align="left">按照索引赋值</td></tr><tr><td align="left">__getitem__</td><td align="left">按照索引获取值</td></tr><tr><td align="left">__len__</td><td align="left">获得长度</td></tr><tr><td align="left">__cmp__</td><td align="left">比较运算</td></tr><tr><td align="left">__call__</td><td align="left">函数调用</td></tr><tr><td align="left">__add__</td><td align="left">加运算</td></tr><tr><td align="left">__sub__</td><td align="left">减运算</td></tr><tr><td align="left">__mul__</td><td align="left">乘运算</td></tr><tr><td align="left">__truediv__</td><td align="left">除运算</td></tr><tr><td align="left">__mod__</td><td align="left">求余运算</td></tr><tr><td align="left">__pow__</td><td align="left">乘方</td></tr></tbody></table><h1 id="在方法里面操作变量"><a href="#在方法里面操作变量" class="headerlink" title="在方法里面操作变量"></a><font size=5>在方法里面操作变量</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 类</span>    sum1 <span class="token operator">=</span> <span class="token number">0</span>    name <span class="token operator">=</span> <span class="token string">'abc'</span>   <span class="token comment"># 类变量</span>    age <span class="token operator">=</span> <span class="token string">'0'</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 构造函数，特别的一个实例方法。</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name   <span class="token comment"># 实例变量</span>        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>   <span class="token comment"># 在实例方法里面操作实例变量,建议加上self</span>        <span class="token comment"># print(name)   # 读取的是 形参name ，不加self情况。</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>sum1<span class="token punctuation">)</span>   <span class="token comment"># 在实例方法里面访问类变量</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>sum1<span class="token punctuation">)</span>   <span class="token comment"># self里面有一个__class__函数，也可以访问类变量</span><span class="token comment"># 构造函数是一个特殊的实例方法，调用方式不一样。</span><span class="token comment"># 调用构造函数实际上是通过 类(),普通的实例方法调用 对象.do_homework</span><span class="token comment"># 意义不一样，实例方法描述类的行为；构造函数是用来初始化类的特征的。</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 实例方法(普通的实例方法)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>   <span class="token comment"># 实例化，实例对象</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>   <span class="token comment"># 调用</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token comment"># 类变量也有专门操作它的类方法</span><span class="token comment"># @classmethod</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="案例一：-1"><a href="#案例一：-1" class="headerlink" title="案例一："></a><font size=4>案例一：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 实例方法（构造函数）</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前学生总数为：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 实例方法</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>Student<span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>   <span class="token comment"># 实例化，传参过程。打印结果为sum1=3(实例化的时候会自动调用构造函数。)</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>Student<span class="token punctuation">(</span><span class="token string">'小O'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token comment"># 注释上面三行，不打印任何东西，因为没有去调用此类</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="案例二：-1"><a href="#案例二：-1" class="headerlink" title="案例二："></a><font size=4>案例二：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 实例方法（构造函数）</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 实例方法</span>        <span class="token comment"># print('homework')</span>        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前学生总数为：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>student1<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>student2<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>student3 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小O'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>student3<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 注释上面student1-3三行，不打印任何东西，因为没有去调用此类</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="案例三："><a href="#案例三：" class="headerlink" title="案例三："></a><font size=4>案例三：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前人数：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>    <span class="token decorator annotation punctuation">@classmethod</span>    <span class="token comment"># 装饰器（高阶函数讲）;决定类方法和实例方法的不同</span>    <span class="token keyword">def</span> <span class="token function">plus_sum</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>        cls<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>Student<span class="token punctuation">.</span>plus_sum<span class="token punctuation">(</span><span class="token punctuation">)</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'ss'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>Student<span class="token punctuation">.</span>plus_sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># student1 = Student('abc', 8)   # python可以用对象调用方法，但是不建议这样做。</span><span class="token comment"># student1.plus_sum()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a><font size=5>静态方法</font></h1><p>大部分可以使用类方法，几乎和普通函数没区别。（不推荐使用静态方法，很熟练无所谓。）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前人数：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>    <span class="token decorator annotation punctuation">@classmethod</span>    <span class="token comment"># 类方法装饰器（高阶函数讲）;决定类方法和实例方法的不同</span>    <span class="token keyword">def</span> <span class="token function">plus_sum</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>        cls<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>        <span class="token comment"># print(self.name)   # 不能访问实例变量；下面的静态方法同样不能访问实例变量</span>    <span class="token decorator annotation punctuation">@staticmethod</span>   <span class="token comment"># 静态方法装饰器。（对象和类均可调用）</span>    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>   <span class="token comment"># 基本上和类方法一样，只是没有显式传入cls</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a static method'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>Student<span class="token punctuation">.</span>plus_sum<span class="token punctuation">(</span><span class="token punctuation">)</span>student2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'ss'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>Student<span class="token punctuation">.</span>plus_sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># student1.add(1, 2)   # 对象调用静态方法</span><span class="token comment"># Student.add(1, 4)   # 类调用静态方法</span><span class="token comment"># student1.plus_sum()   # 对象调用类方法</span><span class="token comment"># Student.plus_sum()    # 类调用类方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="成员的可见性"><a href="#成员的可见性" class="headerlink" title="成员的可见性"></a><font size=5>成员的可见性</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>do_english_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 在类的内部，一个函数可以调用另一个函数。（内部调用）</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_english_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>        <span class="token comment"># self.__class__.sum += 1</span>        <span class="token comment"># print('当前学生总数为：' + str(self.__class__.sum))</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>student1<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 在对象的外部调用，do_homework方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="类的不安全"><a href="#类的不安全" class="headerlink" title="类的不安全"></a><font size=5>类的不安全</font></h1><p>一个倡议：一个类，它下面的一些数据变量，是类非常重要的特征数据，如果要修改类特征的值，不建议通过直接访问变量的方式，来改变变量的状态</p><p>所有对于类下面的变量的更改，建议通过方法来完成（大部分语言所提倡）</p><p>不要对变量做外部修改，应该通过方法修改</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># def __init__(self, name, age, score):</span><span class="token comment">#     self.name = name</span><span class="token comment">#     self.age = age</span><span class="token comment">#     self.score   # score定义学生的分数，但是这样定义，下面可以使用student1.score = -1修改。正确实例：</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        <span class="token comment"># self.score</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>do_english_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">marking</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 对score变量创建一个方法，使用if/else判断。</span>        <span class="token keyword">if</span> score <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'不能出现负分'</span>        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'同学本次考试成绩为：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>result <span class="token operator">=</span> student1<span class="token punctuation">.</span>marking<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="私有方法"><a href="#私有方法" class="headerlink" title="私有方法"></a><font size=5>私有方法</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment"># 其他语言里面使用public/private sum = 0来表示公有或私有的变量/方法，是不能从外部访问的。</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># __init__这样前后双下划线的，都不是私有,验证下面"__marking__",看结果。</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name            <span class="token comment"># 自己写不建议使用"__marking__"，__*__是python内置的一些变量。</span>        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span>        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">def</span> <span class="token function">__marking</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 对方法/变量加上双下划线，将其变为私有</span>        <span class="token keyword">if</span> score <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'不能出现负分'</span>        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'同学本次考试成绩为：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token comment"># result = student1.__marking(89)   # 这样访问会报错。</span><span class="token comment"># print(result)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">复习：类体（数据成员（类变量））、实例变量、构造函数（特殊实例方法）、类方法、静态方法、对象、实例化、装饰器、成员可见性公开的 public（可以在外部赋值调用）;私有的 private（python中在变量名前面加入__双下划线即可,不能在外部调用，可以在类内部调用）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="私有变量"><a href="#私有变量" class="headerlink" title="私有变量"></a><font size=5>私有变量</font></h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment"># 注三</span>        self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">def</span> <span class="token function">marking</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> score <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'不能出现负分'</span>        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'同学本次考试成绩为：'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>result <span class="token operator">=</span> student1<span class="token punctuation">.</span>marking<span class="token punctuation">(</span><span class="token number">89</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>student1<span class="token punctuation">.</span>__score <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>   <span class="token comment"># 注四 和 注三 不是同一个变量哦，一个是_Student__score一个是__score</span><span class="token comment"># 实际上是python语言的动态特性。对student1这个对象添加了一个新的属性（__score）,并不是上面'注三'的__score</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>__score<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>   <span class="token comment"># 验证注四</span><span class="token comment"># __dict__函数打印出来的_Student__score就是设置的私有变量__score，而后面的__score就是下面动态设置的student1.__score = -1</span><span class="token comment"># 扩展：为什么我们访问私有变量，python会报错找不到私有变量，就是因为python存储私有变量的时候，更改了私有变量的名字。</span><span class="token comment"># 换句话说，python保护私有变量，就是保存私有变量的时候改个名字而已。</span><span class="token comment"># 严格意义上来讲，python是没有私有变量的。因为上面的例子print(student1._Student__score)就可以读到私有变量。</span><span class="token comment"># 但是既然别人这样写了，就最好不要打破。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="继承性"><a href="#继承性" class="headerlink" title="继承性"></a><font size=5>继承性</font></h1><p>面向对象3大特性：继承性、封装性（抽象）、多态性</p><p>类的组成：类的特征（实例变量、类变量）；行为（各种各样的方法）</p><p>继承性最基本的定义：避免我们定义重复性的方法和变量（建议一个模块只写一个类，java、C#是这样的）</p><p>继承性.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">class</span> <span class="token class-name">Human</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age    <span class="token keyword">def</span> <span class="token function">get_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Human'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> 继承性 <span class="token keyword">import</span> Human<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>   <span class="token comment"># 子类里面没有sum变量，直接继承的父类</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> 继承性 <span class="token keyword">import</span> Human<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>   <span class="token comment"># 通过对象调用类变量</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>   <span class="token comment"># 实例变量也可以被子类继承</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">)</span>    <span class="token comment"># 通过类调用类变量</span>student1<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 继承父类的方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># 子类里面调用父类的构造函数</span><span class="token keyword">from</span> 继承性 <span class="token keyword">import</span> Human<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> school<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>school <span class="token operator">=</span> school        Human<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>   <span class="token comment"># 这里必须传入self，用类调用实例方法（普通方法的调用）</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">,</span> <span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>age<span class="token punctuation">)</span>Student<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>   <span class="token comment"># 类调用实例方法,这样self就是一个普通的参数</span>student1<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 对象调用实例方法</span><span class="token comment"># 在很多语言里面类是不能调用实例方法的，但是python可以。</span><span class="token comment"># 缺点：如果父类改名，子类中的所有父类的方法都要改</span><span class="token comment"># 开闭原则：代码对自身扩展是开放的，对自身的更改是关闭的。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> 继承性 <span class="token keyword">import</span> Human<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> school<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>school <span class="token operator">=</span> school        <span class="token builtin">super</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>   <span class="token comment"># 最好使用super关键字调用父类构造函数</span>    <span class="token keyword">def</span> <span class="token function">do_homework</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'homework'</span><span class="token punctuation">)</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 注五，调用父类实例方法</span>student1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">,</span> <span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>student1<span class="token punctuation">.</span>age<span class="token punctuation">)</span>student1<span class="token punctuation">.</span>do_homework<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 注释掉注五，优先调用子类的方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(八)</title>
      <link href="/posts/35fc9c9b.html"/>
      <url>/posts/35fc9c9b.html</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 就是一个函数</span>a <span class="token operator">=</span> <span class="token number">1.2345</span>   <span class="token comment"># 保留两位</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>wj_result <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment"># 做好使用变量，函数嵌套函数很乱。(一个建议而已)</span><span class="token keyword">print</span><span class="token punctuation">(</span>wj_result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="函数作用："><a href="#函数作用：" class="headerlink" title="函数作用："></a><font size=5>函数作用：</font></h1><ol><li><p>功能性（有一个非常明确的目的）</p></li><li><p>隐藏细节</p></li><li><p>避免编写重复的代码</p></li></ol><p>组织代码、自定义函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">funcname</span><span class="token punctuation">(</span>parameter_list<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 函数的基本结构：def关键字定义函数、funcname函数名、parameter_list参数列表要用()括起来以:结尾</span>    <span class="token keyword">pass</span>   <span class="token comment">#函数体，代码块，前面要有缩进</span>parameter_list 参数列表，可以没有函数体里面，使用<span class="token keyword">return</span>返回结果，    <span class="token keyword">return</span> value，如果没有<span class="token keyword">return</span>语句默认返回<span class="token boolean">None</span>空值<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>实现两个数字相加</p></li><li><p>打印输入的参数</p></li></ol><h2 id="案例一："><a href="#案例一：" class="headerlink" title="案例一："></a><font size=4>案例一：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment"># 报错name 'add' is not defined这里使用的add在python中是找不到的。</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> x <span class="token operator">+</span> y    <span class="token keyword">return</span> result<span class="token keyword">def</span> <span class="token function">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="案例二："><a href="#案例二：" class="headerlink" title="案例二："></a><font size=4>案例二：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># import sys</span><span class="token comment"># sys.setrecursionlimit(100)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> x <span class="token operator">+</span> y    <span class="token keyword">return</span> result<span class="token keyword">def</span> <span class="token function">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 自己调自己，报错[Previous line repeated 995 more times]重复了995次，默认值（或者998，1000），设置最大重复次数，注意看more times数值变化</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>   <span class="token comment"># import sys # sys.setrecursionlimit(100)设置最大重复次数</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token comment"># 函数和变量不要和内置的重名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="案例三："><a href="#案例三：" class="headerlink" title="案例三："></a><font size=4>案例三：</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> x <span class="token operator">+</span> y    <span class="token keyword">return</span> result<span class="token keyword">def</span> <span class="token function">w_print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>    <span class="token comment"># return True   # 测试有return返回True</span>a <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>b <span class="token operator">=</span> w_print<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token comment"># 执行流程，1.def函数定义，2.把计算结果赋值给a，3.执行w_print函数，4.在def w_print(code):里面直接打印“Python”;5.执行print(a, b)，a是3，b是None（没有return返回None）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>学好函数的参数，是学好函数的重要的一个环节（.py文件是模块，def定义的是函数）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> x <span class="token operator">+</span> y    <span class="token keyword">return</span> result<span class="token keyword">def</span> <span class="token function">w_print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>    <span class="token keyword">return</span>   <span class="token comment"># 尝试注释return,会发现"haha"被打印了</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">)</span>   <span class="token comment"># 在函数中，return后面的语句不会被执行</span>a <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>b <span class="token operator">=</span> w_print<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">damage</span><span class="token punctuation">(</span>skill1<span class="token punctuation">,</span> skill2<span class="token punctuation">)</span><span class="token punctuation">:</span>    damage1 <span class="token operator">=</span> skill1 <span class="token operator">*</span> <span class="token number">3</span>    damage2 <span class="token operator">=</span> skill2 <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">10</span>    <span class="token keyword">return</span> damage1<span class="token punctuation">,</span> damage2<span class="token comment"># damages = damage(3, 6)   # 不建议*1</span><span class="token comment"># print(type(damages))</span><span class="token comment"># print(damages)</span><span class="token comment"># print(damages[0], damages[1])   # 不建议使用此方法*1</span><span class="token comment"># ------</span>skill1_damage<span class="token punctuation">,</span> skill2_damage <span class="token operator">=</span> damage<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>   <span class="token comment">#序列解包</span><span class="token keyword">print</span><span class="token punctuation">(</span>skill1_damage<span class="token punctuation">,</span> skill2_damage<span class="token punctuation">)</span><span class="token comment"># -------</span><span class="token comment"># a, b, c = 1, 2, 3   # 这是变量赋值，等同于：a = 1，b = 2，c = 3</span><span class="token comment"># d = 4, 5, 6   # 这是一个tuple，使用type()可以验证</span><span class="token comment"># x, y, z = d   # 这叫序列解包，相当于：x = 4，y = 5，z = 6</span><span class="token comment"># a = b = c = 1   # 相当于：a = 1，b = 1，c = 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><iframe src="https://tool.lu/coderunner/embed/8Gs.html" width="793" height="550" frameborder="0" mozallowfullscreen webkitallowfullscreen allowfullscreen></iframe><h1 id="函数参数："><a href="#函数参数：" class="headerlink" title="函数参数："></a><font size=5>函数参数：</font></h1><h2 id="1-必须参数"><a href="#1-必须参数" class="headerlink" title="1.必须参数"></a><font size=4>1.必须参数</font></h2><p>我们在函数的参数列表里面，所定义的参数，是必须要传递的。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 这里必须给x，y参数</span>    <span class="token comment"># 这里x和y称为：形式参数，形参</span>    result <span class="token operator">=</span> x <span class="token operator">+</span> y    <span class="token keyword">return</span> resulta <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment"># 函数调用的过程中，往函数的参数列表里面传递的参数的实际的取值。--实际参数，a是实参</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-关键字参数"><a href="#2-关键字参数" class="headerlink" title="2.关键字参数"></a><font size=4>2.关键字参数</font></h2><p>关键字参数和必须参数的区别：在于函数的调用上，不在于函数的定义上。定义是相同的，调用不同。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">def</span> <span class="token function">add1</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">:</span>    result1 <span class="token operator">=</span> x1 <span class="token operator">+</span> y1    <span class="token keyword">return</span> result1a1 <span class="token operator">=</span> add1<span class="token punctuation">(</span>y1<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> x1<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment"># 关键字参数，在函数调用的时候明确告诉python，给定的实参是具体给哪个形参的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-默认参数"><a href="#3-默认参数" class="headerlink" title="3.默认参数"></a><font size=4>3.默认参数</font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># def print_student_files(name, gender, age,</span><span class="token comment">#                         college):</span><span class="token comment">#     print('我叫' + name)</span><span class="token comment">#     print('我今年' + age + '岁')</span><span class="token comment">#     print('我是' + gender + '生')</span><span class="token comment">#     print('我在' + college + '上学')</span><span class="token comment"># print_student_files('大壮', '男', '8', '哈哈小学')</span><span class="token keyword">def</span> <span class="token function">print_student_files</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token string">'男'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token string">'8'</span><span class="token punctuation">,</span>                        college<span class="token operator">=</span><span class="token string">'哈哈小学'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 给形参设置默认值，未设置的形参是一定要传实参的。</span>    <span class="token comment">#（不能夹杂着混，比如：（name, gender='男', age）是不可以的。）</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'我叫'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'我今年'</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">'岁'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'我是'</span> <span class="token operator">+</span> gender <span class="token operator">+</span> <span class="token string">'生'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'我在'</span> <span class="token operator">+</span> college <span class="token operator">+</span> <span class="token string">'上学'</span><span class="token punctuation">)</span>print_student_files<span class="token punctuation">(</span><span class="token string">'小牛'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--------分割线--------'</span><span class="token punctuation">)</span>print_student_files<span class="token punctuation">(</span><span class="token string">'小乐'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">)</span>   <span class="token comment"># 即使有了默认值，实参传递的值也会覆盖默认值</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--------分割线--------'</span><span class="token punctuation">)</span>print_student_files<span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> college <span class="token operator">=</span> <span class="token string">'喜喜小学'</span><span class="token punctuation">)</span>   <span class="token comment"># 关键字赋值，是不用考虑传参顺序的。</span><span class="token comment">#（同上，不能夹杂混和，比如（'小红', gender='女', '8'），这样子不行的。反过来关键字参数中间夹杂着实参也不行。）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 学习笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(七)</title>
      <link href="/posts/fcae2397.html"/>
      <url>/posts/fcae2397.html</url>
      
        <content type="html"><![CDATA[<h2 id="Python项目的组织结构："><a href="#Python项目的组织结构：" class="headerlink" title="Python项目的组织结构："></a><font size=5><strong>Python项目的组织结构：</strong></font></h2><p><img src="/medias/img/python7/0.jpg"></p><h2 id="直接表现形式："><a href="#直接表现形式：" class="headerlink" title="直接表现形式："></a><font size=5><strong>直接表现形式：</strong></font></h2><p>包 —— 文件夹</p><p>名字就是文件夹名（包里面可以有子包，文件夹中有文件夹，很灵活）</p><p>模块 —— *.py文件</p><p>名字就是文件名，区分不同包的相同名的模块 </p><p>class —— 类<br>写在.py文件里        </p><p>命名空间：（abc.c4和xyz.c4）abc和xyz是文件夹名（包名），c4是同名文件，不同包。abc.c4称为路径也是命名空间</p><p>包和文件夹区分：包里面包含一个__init__.py文件（可以是空白文件，可以是模块）引用__init__.py模块，直接引用包名即可</p><p>文件夹里没有__init__.py就是一个普通文件夹</p><center>-----------------------分割线-----------------------</center>import(导入模块使用麻烦)、from..import(导入模块直接使用，不建议直接使用import *)、import..as(对import导入设置别名)，避免循环导入<p><strong>约定目录结构：</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon workdir<span class="token punctuation">]</span><span class="token comment"># tree A</span>A├── A<span class="token punctuation">.</span>py├── B│   └── B<span class="token punctuation">.</span>py└── C    └── C<span class="token punctuation">.</span>py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>内容：</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat B/B.py  #设置变量</span>a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat C/C.py  #设置变量</span>c <span class="token operator">=</span> <span class="token number">3</span>d <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat A.py </span><span class="token keyword">import</span> B<span class="token punctuation">.</span>B   <span class="token comment">#导入B/B.py模块</span><span class="token keyword">print</span> <span class="token punctuation">(</span>B<span class="token punctuation">.</span>B<span class="token punctuation">.</span>a<span class="token punctuation">)</span>   <span class="token comment">#打印B.py模块里 的变量a</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># python A.py </span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat A.py </span><span class="token keyword">from</span> B<span class="token punctuation">.</span>B <span class="token keyword">import</span> a   <span class="token comment">#导入B.py里面的a变量</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">#直接使用</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># python A.py </span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat A.py </span><span class="token keyword">import</span> B<span class="token punctuation">.</span>B <span class="token keyword">as</span> NAME   <span class="token comment">#设置别名</span><span class="token keyword">print</span> <span class="token punctuation">(</span>NAME<span class="token punctuation">.</span>a<span class="token punctuation">,</span>NAME<span class="token punctuation">.</span>b<span class="token punctuation">)</span>   <span class="token comment">#打印别名+变量名</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># python A.py </span><span class="token number">1</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat A.py </span><span class="token keyword">from</span> B<span class="token punctuation">.</span>B <span class="token keyword">import</span> a<span class="token punctuation">,</span> \   <span class="token comment">#换行方式</span>    b<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># python A.py </span><span class="token number">1</span> <span class="token number">2</span><span class="token comment"># from B.B import (a, 换行方式2</span><span class="token comment">#     b)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat B/__init__.py </span>H <span class="token operator">=</span> <span class="token string">"haha"</span>   <span class="token comment">#在模块目录直接编写__init__.py文件</span><span class="token keyword">print</span><span class="token punctuation">(</span>H<span class="token punctuation">)</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># cat A.py </span><span class="token keyword">import</span> B   <span class="token comment">#直接引用包B</span><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@bogon A<span class="token punctuation">]</span><span class="token comment"># python A.py </span>haha   <span class="token comment">#直接出结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><center>-----------------------分割线-----------------------</center><p><strong>包的引用问题</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">$ tree workdir workdir├── README<span class="token punctuation">.</span>md├── test1│   ├── c1<span class="token punctuation">.</span>py│   ├── __pycache__│   │   └── c1<span class="token punctuation">.</span>cpython<span class="token operator">-</span><span class="token number">37</span><span class="token punctuation">.</span>pyc│   └── test2│       ├── c1<span class="token punctuation">.</span>py│       └── __pycache__│           └── c1<span class="token punctuation">.</span>cpython<span class="token operator">-</span><span class="token number">37</span><span class="token punctuation">.</span>pyc└── test2    ├── c2<span class="token punctuation">.</span>py    └── __pycache__        └── c2<span class="token punctuation">.</span>cpython<span class="token operator">-</span><span class="token number">37</span><span class="token punctuation">.</span>pycA<span class="token operator">=</span><span class="token operator">/</span>workdir<span class="token operator">/</span>test1<span class="token operator">/</span>c1<span class="token punctuation">.</span>pyB<span class="token operator">=</span><span class="token operator">/</span>workdir<span class="token operator">/</span>test1<span class="token operator">/</span>test2<span class="token operator">/</span>c1<span class="token punctuation">.</span>pyC<span class="token operator">=</span><span class="token operator">/</span>workdir<span class="token operator">/</span>test2<span class="token operator">/</span>c2<span class="token punctuation">.</span>py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>A可以调用B</p><p>C可以调用A</p><p>A再调用C出错</p><p><strong>注意:</strong> </p><p>包的引用，个人理解：被引用的模块中加入 if <strong>name</strong> == ‘<strong>main</strong>‘: 函数，这样可以只引用函数，不会执行 “main”。</p><p>被引用模块加入 <strong>all</strong> = [‘a’, ‘c’]，引用时使用 from model.mod import *，这样只会引入被引模块all定义的函数，不会引入其他函数</p><p>将函数定义在一个包中，这样比较好一点</p><p>相互引用会造成一些错误。当被引模块出现 sys.path.append(‘..’) 的时候，或者其他状况。</p><p><strong>源码下载</strong> <a href="https://wujiops.coding.net/p/download/d/code/git/raw/master/python7.zip" title="python7.zip">download</a> </p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 包和模块 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(六)</title>
      <link href="/posts/63a63b1d.html"/>
      <url>/posts/63a63b1d.html</url>
      
        <content type="html"><![CDATA[<h2 id="什么是表达式"><a href="#什么是表达式" class="headerlink" title="什么是表达式"></a><font size=5><strong>什么是表达式</strong></font></h2><p><strong>C语言对表达式定义：</strong> <strong>表达式</strong>（Expression）是<strong>运算符</strong>（operator）和<strong>操作数</strong>（operand）所<strong>构成的序列</strong>。</p><p><strong>编程语言是模拟现实生活的。</strong></p><p><strong>‘=’</strong>,号是赋值运算符（运算符：函数的调用，<strong>and</strong>，<strong>or</strong>等都是表达式）</p><p>例如：<strong>a = 1，b = 2，c = 3</strong>计算<strong>a + b * c</strong>和<strong>a or b and c</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">+</span> b <span class="token operator">*</span> c   <span class="token comment"># 类比数学运算，乘号优先级是高于加号的。</span><span class="token number">7</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token keyword">or</span> b <span class="token keyword">and</span> c   <span class="token comment"># and优先级高于or</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运算符优先级，从高到低（仅供参考）</p><p><img src="/medias/img/python6/0.jpg"></p><p>解释器解析表达式的顺序：从左向右（左结合），加()可以调高优先级，类比数学四则运算</p><p>c = a + b（例外：右结合，要先计算a + b）总结：上述表格仅供参考</p><p>思考：<strong>a = 1,b = 2,c = 2,not a or b +2 == c</strong>用括号标注出表达式的顺序（带括号和不带括号顺序相同）</p><p>参考表格：优先级应该是 <strong>+、==、not、or</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> a <span class="token keyword">or</span> b <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">==</span> c<span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> a <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> c<span class="token punctuation">)</span>   <span class="token comment"># not优先级本来就高于or</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">not</span> a<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> c<span class="token punctuation">)</span>   <span class="token comment"># 这个思路，or本来就是最后，是not和==的比较</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>逻辑运算符优先级：<strong>not &gt; and &gt; or</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># python在每一行的末尾，不需要强制加;分号,加了;也不会报错</span><span class="token comment"># &#123;</span><span class="token comment">#   if class function  #其它语言需要&#123;&#125;包裹代码块,python中不需要</span><span class="token comment"># &#125;</span><span class="token comment"># python中靠缩进区分代码和代码块</span><span class="token comment"># 流程控制语句</span><span class="token comment"># 条件控制  循环控制  分支</span><span class="token comment"># 其它语言条件控制:if else</span><span class="token comment"># 其它语言循环控制:for while</span><span class="token comment"># 其它语言分支控制:switch</span><span class="token triple-quoted-string string">'''代码是为了解决现实中的选择性问题。python代码不能被混淆压缩'''</span><span class="token comment"># mood = True</span><span class="token comment">#</span><span class="token comment"># if mood == False :</span><span class="token comment">#     print('go to left')</span><span class="token comment"># else :</span><span class="token comment">#     print('go to right')</span><span class="token comment"># print('-----')</span><span class="token comment"># if mood :</span><span class="token comment">#     print('go to left')</span><span class="token comment"># else :</span><span class="token comment">#     print('go to right')</span><span class="token comment"># python条件控制if else</span>a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token keyword">if</span> a <span class="token operator">></span> b<span class="token punctuation">:</span>    <span class="token comment">#if后面可以是表达式、bool、空列表等</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'😘'</span><span class="token punctuation">)</span>c <span class="token operator">=</span> <span class="token number">2</span>d <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'null'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'😱'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><iframe src="https://tool.lu/coderunner/embed/7X4.html" width="793" height="550" frameborder="0" mozallowfullscreen webkitallowfullscreen allowfullscreen></iframe><h2 id="分支的基本语法"><a href="#分支的基本语法" class="headerlink" title="分支的基本语法"></a><font size=5><strong>分支的基本语法</strong></font></h2><p><strong>（可以参考shell中的if/else）</strong></p><p>1.if条件表达式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">语句1语句2<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2.条件表达式就是计算结果必须为布尔值得表达式</p><p>3.表达式后面的冒号不能少</p><p>4.注意if后面出现的语句，如果属于if语句块，则必须同一个缩进等级</p><p>5.条件表达式结果为True执行if后面的缩进语句块</p><p>双向分支：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> 条件表达式:  语句1  语句2  <span class="token punctuation">..</span>.else:  语句1  语句2  <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>双向分支有两个分支，当程序执行到if……else……语句的时候，一定会执行if或else中的一个，也仅执行一个</p><p>缩进问题，if和else一个层次，其余语句一个层次。</p><p>多线路分支：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> 条件表达式:  语句1<span class="token keyword">elif</span> 条件表达式:  语句1<span class="token keyword">elif</span> 条件表达式:  语句1else:  语句1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>if语句其他</strong></p><p>1.if语句可以嵌套使用，但不推荐。</p><p>2.python没有switch-case语句。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''snippet 片段,vscode中使用'''</span><span class="token keyword">if</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span> <span class="token comment"># 空语句/占位语句,避免报错.用于api接口等</span><span class="token keyword">if</span> <span class="token boolean">False</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span class="token triple-quoted-string string">'''if/else可以参考shell嵌套'''</span><span class="token keyword">if</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span>    <span class="token keyword">if</span> <span class="token boolean">False</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>简单交互、if/else、脚本</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">account <span class="token operator">=</span> <span class="token string">'user'</span>password <span class="token operator">=</span> <span class="token string">'123'</span><span class="token comment"># python建议变量名的定义规范：名称最好都是小写的，组合单词用下划线分割</span><span class="token comment"># 命令行接受用户输入</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'please input account'</span><span class="token punctuation">)</span>user_account <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'please input password'</span><span class="token punctuation">)</span>user_password <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># if user_account == 'hello' and user_password == '123456' :</span><span class="token comment">#     print('success')</span><span class="token comment"># else :</span><span class="token comment">#     print('error')</span><span class="token keyword">if</span> account <span class="token operator">==</span> user_account <span class="token keyword">and</span> password <span class="token operator">==</span> user_password<span class="token punctuation">:</span>  <span class="token comment">#注意这里表达式优先级关系,必要时用()调整优先级</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#--*--coding:utf-8--*--</span><span class="token triple-quoted-string string">'''变量a=xa=1;print(apple)a=2;print(orange)a=3;print(banana)a=other;print('shopping')'''</span>a <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 如果直接这样写，命令行输入type是str，if判断要用a == '1'，或者进行转换a = int(a)</span><span class="token comment"># input()函数接受的是字符串str</span><span class="token comment"># print(a)</span><span class="token comment"># if a==1:</span><span class="token comment">#     print('apple')</span><span class="token comment"># else:</span><span class="token comment">#     if a==2:</span><span class="token comment">#         print('orange')</span><span class="token comment">#     else:</span><span class="token comment">#         if a==3:</span><span class="token comment">#             print('banana')</span><span class="token comment">#         else:</span><span class="token comment">#             print('shopping')</span><span class="token comment"># a = int(a)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#打印a的类型，验证命令行输入是str</span><span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">)</span><span class="token keyword">elif</span> a <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">)</span><span class="token keyword">elif</span> a <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'shopping'</span><span class="token punctuation">)</span><span class="token comment"># 命令行输入的是字符串str</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 枚举 </tag>
            
            <tag> 分支 </tag>
            
            <tag> 循环 </tag>
            
            <tag> 条件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(五)</title>
      <link href="/posts/faa9736f.html"/>
      <url>/posts/faa9736f.html</url>
      
        <content type="html"><![CDATA[<h2 id="复习"><a href="#复习" class="headerlink" title="复习"></a><font size=5><strong>复习</strong></font></h2><p><strong>算术运算符</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'hello'</span><span class="token operator">+</span><span class="token string">'world'</span><span class="token string">'helloworld'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">3</span><span class="token operator">/</span><span class="token number">2</span><span class="token number">1.5</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">3</span><span class="token operator">//</span><span class="token number">2</span>   <span class="token comment">#整除</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">5</span><span class="token operator">%</span><span class="token number">2</span>   <span class="token comment">#余数</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">5</span>   <span class="token comment">#次方</span><span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a><font size=5><strong>算术运算符</strong></font></h2><p>+、-、<em>、/、//、%、</em>*</p><p><img src="/medias/img/python5/0.jpg" alt="算数运算符.jpg"></p><h2 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a><font size=5><strong>赋值运算符</strong></font></h2><p>=、+=、*=、/=、%=、**=、//=</p><p><img src="/medias/img/python5/1.jpg" alt="赋值运算符.jpg"></p><h2 id="比较-逻辑运算符"><a href="#比较-逻辑运算符" class="headerlink" title="比较/逻辑运算符"></a><font size=5><strong>比较/逻辑运算符</strong></font></h2><h3 id="比较（关系）运算符"><a href="#比较（关系）运算符" class="headerlink" title="比较（关系）运算符"></a><font size=4><strong>比较（关系）运算符</strong></font></h3><p>==、!=、&gt;、&lt;、&gt;=、&lt;=</p><h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a><font size=4><strong>逻辑运算符</strong></font></h3><p>and、or、not<br><img src="/medias/img/python5/2.jpg" alt="比较/逻辑运算符.jpg"></p><h2 id="成员-身份-位运算符"><a href="#成员-身份-位运算符" class="headerlink" title="成员/身份/位运算符"></a><font size=5><strong>成员/身份/位运算符</strong></font></h2><h3 id="成员运算符"><a href="#成员运算符" class="headerlink" title="成员运算符"></a><font size=4><strong>成员运算符</strong></font></h3><p>in、not in</p><h3 id="身份运算符"><a href="#身份运算符" class="headerlink" title="身份运算符"></a><font size=4><strong>身份运算符</strong></font></h3><p>is、not is</p><h3 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a><font size=4><strong>位运算符</strong></font></h3><p>&amp;、|、^、~、&lt;&lt;、&gt;&gt;<br><img src="/medias/img/python5/3.jpg" alt="成员/身份/位运算符.jpg"></p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a><font size=5><strong>例子</strong></font></h2><h3 id="算术-赋值运算符"><a href="#算术-赋值运算符" class="headerlink" title="算术/赋值运算符"></a><font size=4><strong>算术/赋值运算符</strong></font></h3><p><strong><font color=red>注意：</font></strong> Python中不存在变量的定义，变量在Python中就是一个名字。c = 1，即把1赋值给c</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> c<span class="token operator">+=</span><span class="token number">1</span>   <span class="token comment">#相当于c = c + 1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> c<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">,</span>c<span class="token operator">-</span><span class="token operator">-</span>   <span class="token comment">#++，--自增和自减运算符，（shell体现）但是在python中不能这样写</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">+=</span>a   <span class="token comment">#相当于b = b + a</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">-=</span>a   <span class="token comment">#相当于b = b - a</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">*=</span>a   <span class="token comment">#相当于b = b * a</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="比较-逻辑运算符-1"><a href="#比较-逻辑运算符-1" class="headerlink" title="比较/逻辑运算符"></a><font size=4><strong>比较/逻辑运算符</strong></font></h3><p>数字，字符串，布尔值都可以比较，返回值是布尔值（==，!=，&gt;，&lt;，&gt;=，&lt;=）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">True</span> <span class="token operator">></span> <span class="token boolean">False</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span><span class="token operator">==</span><span class="token number">1</span>  <span class="token comment">#==如果两个变量取值相等，返回结果True，参考下文对比is</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span><span class="token operator">></span><span class="token number">1</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'abc'</span><span class="token operator">==</span><span class="token string">'abc'</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span><span class="token operator">!=</span><span class="token number">2</span><span class="token boolean">True</span><span class="token comment"># b = 1，b+=b>=1，b的值</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">+=</span>b<span class="token operator">>=</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token comment"># 字符串比较的是ascll码</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>   <span class="token comment">#ord()查看元素的ascll码</span><span class="token number">97</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token number">98</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'a'</span> <span class="token operator">&lt;</span> <span class="token string">'b'</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="逻辑运算符-1"><a href="#逻辑运算符-1" class="headerlink" title="逻辑运算符"></a><font size=4><strong>逻辑运算符</strong></font></h3><p>（and两者都为真才是True，or有一个为真就是True，not双not抵消）（或or、与and、非not）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">True</span> <span class="token keyword">and</span> <span class="token boolean">True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">False</span> <span class="token keyword">and</span> <span class="token boolean">False</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">False</span> <span class="token keyword">and</span> <span class="token boolean">True</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">False</span> <span class="token keyword">or</span> <span class="token boolean">True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token boolean">True</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token keyword">not</span> <span class="token boolean">True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">1</span>   <span class="token comment">#相当于True and True</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'a'</span> <span class="token keyword">and</span> <span class="token string">'c'</span>   <span class="token comment">#参考下文,理解：and  or</span><span class="token string">'c'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token string">'a'</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'a'</span> <span class="token keyword">or</span> <span class="token string">'b'</span><span class="token string">'a'</span><span class="token comment"># 对于int整形和float浮点型，0表示False，非0表示True</span><span class="token comment"># 对于str字符串类型，‘’空表示False，非空表示True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token number">0</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token string">''</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token string">'0'</span><span class="token boolean">False</span><span class="token comment"># 对于list列表，[]空列表是False，非空表示True</span><span class="token comment"># 对于tuple元组，set集合，dict字典；同样遵循列表的风格。空表示False，非空表示True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">not</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token comment"># 理解：and  or</span><span class="token comment"># 当计算机读到第一个数的时候，并不能给出结果。只有将全部的代码解析完，才能出结果。</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'a'</span> <span class="token keyword">and</span> <span class="token string">'b'</span>   <span class="token comment">#非空都为True，但是会显示第二个（最后一个）代码（值）。</span><span class="token string">'b'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'b'</span> <span class="token keyword">and</span> <span class="token string">'a'</span><span class="token string">'a'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token string">'c'</span>   <span class="token comment">#0为False</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'c'</span> <span class="token keyword">and</span> <span class="token number">0</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'b'</span> <span class="token keyword">and</span> <span class="token string">'a'</span> <span class="token keyword">and</span> <span class="token string">'c'</span><span class="token string">'c'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>现实例子：</strong> 1 &gt; 0，计算机必须读到0的时候才会知道结果是True，读到1的时候不会有结果。<br><img src="/medias/img/python5/4.jpg"></p><h3 id="or运算"><a href="#or运算" class="headerlink" title="or运算"></a><font size=4><strong>or运算</strong></font></h3><p><strong>区别：</strong> 因为or是有一个为真就返回True，所以它只需要读到第一个真就返回结果就行了。（避免计算资源浪费😊）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token number">1</span> <span class="token keyword">or</span> <span class="token number">3</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">3</span> <span class="token keyword">or</span> <span class="token number">1</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token boolean">False</span> <span class="token keyword">or</span> <span class="token string">'a'</span> <span class="token keyword">or</span> <span class="token number">1</span><span class="token string">'a'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="成员运算符-1"><a href="#成员运算符-1" class="headerlink" title="成员运算符"></a><font size=4><strong>成员运算符</strong></font></h3><p>in，not in（list列表，tuple元组，str字符串，set集合，dict字典）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment">#判断a是否在list列表[1,2,3]中</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">in</span> a<span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token operator">+=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">in</span> a<span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> c<span class="token operator">+=</span>b   <span class="token comment">#c = c + b，print(c) = 3</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token keyword">not</span> <span class="token keyword">in</span> a   <span class="token comment">#c是否不在list列表a中</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token number">8</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token string">'a'</span>   <span class="token comment">#字典dict</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token string">'c'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token string">'c'</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token string">'c'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span>   <span class="token comment">#对于字典dict来说，成员运算符是判断的key:value中的key</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token string">'c'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="身份运算符-1"><a href="#身份运算符-1" class="headerlink" title="身份运算符"></a><font size=4><strong>身份运算符</strong></font></h3><p>比较的是两个变量的身份是否相等（和==有区别，is比较的是内存地址）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'a'</span> <span class="token keyword">is</span> <span class="token string">'a'</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">is</span> <span class="token number">1</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1.0</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">is</span> <span class="token number">1.0</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token number">1270122593352</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">140728377594912</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 这里是两个列表，所以显示False，记作lista 和 listb</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 这里是listb</span><span class="token number">1270130542216</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 这两次查询都是最后一个列表内存地址，这里也是listb</span><span class="token number">1270130542216</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 这里变成了listc 和 listd</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 这里是listd的内存地址</span><span class="token number">1270133275656</span><span class="token comment"># a = &#123;1,2,3&#125;，b = &#123;2,1,3&#125;；求a == b，a is b。</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">==</span> b   <span class="token comment"># 集合set和字典dict是无序序列，所以顺序变化不影响取值（无序序列：dict&#123;&#125;字典，set&#123;&#125;集合，有序序列[]lise列表，()tuple元组，''str字符串）</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">&#125;</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token string">'b'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token keyword">is</span> b<span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">1270133037096</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token keyword">is</span> b<span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token keyword">is</span> c   <span class="token comment"># 变量赋值 比较的是 同一个变量，所以返回True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment"># 相同的集合set&#123;&#125;，dict字典&#123;&#125;，list列表[]，直接比较返回False，因为身份运算比较的内存地址</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 验证两个[1,2]列表，内存地址是不同的。第二个[1,2]相当于一个新的list不是原来的了</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">1270130541064</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">1270130542216</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="type类型"><a href="#type类型" class="headerlink" title="type类型"></a><font size=4><strong>type类型</strong></font></h3><p>type类型判断</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">'hello'</span>   <span class="token comment"># 把判断a的类型是不是str，返回True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">)</span>   <span class="token comment"># 判断a是不是str类型</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 判断a是否属于元组tuple()中的其中一个</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>对象的三个特征：</strong> id、value、type；</p><p><strong>对应判断方式：</strong> is（判断id）、==（判断value）、isinstance（判断type），（type类型判断，不能判断对象的子类型属于某一种类型，isinstance可以）</p><p><strong>位运算符：</strong> &amp;按位与、|按位或、^按位异或、~按位取反、&lt;&lt;左移动、&gt;&gt;右 移动</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">&amp;</span> b<span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token string">'0b10'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token string">'0b11'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与IP地址划分作类比。按位与&amp;，只有 同位值都为1 结果才是1。</p><p><img src="/medias/img/python5/5.jpg"></p><p>按位或|，只要 同位值有一个为1 结果就是1。</p><p><img src="/medias/img/python5/6.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 运算符 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ambari安装Hadoop</title>
      <link href="/posts/dd432904.html"/>
      <url>/posts/dd432904.html</url>
      
        <content type="html"><![CDATA[<!-- # <font size=5>**Hadoop安装视频**</font><iframe height="600" width="800" src="//player.bilibili.com/player.html?aid=80560637&cid=137867649&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe> --><h1 id="ambari安装hadoop配置"><a href="#ambari安装hadoop配置" class="headerlink" title="ambari安装hadoop配置"></a><font size=5><strong>ambari安装hadoop配置</strong></font></h1><p>接上文ambari安装，利用其虚拟机分配master，slave，client。</p><table><thead><tr><th align="right">主机名</th><th align="center">IP</th><th align="center">内存</th><th align="left">介绍</th></tr></thead><tbody><tr><td align="right">ambari.hadoop.com</td><td align="center">192.168.1.229</td><td align="center">4G+</td><td align="left">Hadoop集群管理工具</td></tr><tr><td align="right">master1.hadoop.com</td><td align="center">192.168.1.207</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">master2.hadoop.com</td><td align="center">192.168.1.208</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">master3.hadoop.com</td><td align="center">192.168.1.209</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">slave1.hadoop.com</td><td align="center">192.168.1.211</td><td align="center">4G+</td><td align="left">Hadoop集群slave节点</td></tr><tr><td align="right">slave2.hadoop.com</td><td align="center">192.168.1.212</td><td align="center">4G+</td><td align="left">Hadoop集群slave节点</td></tr><tr><td align="right">client.hadoop.com</td><td align="center">192.168.1.221</td><td align="center">4G+</td><td align="left">Hadoop集群client节点</td></tr><tr><td align="right">repo.hadoop.com</td><td align="center">192.168.1.228</td><td align="center">1G+</td><td align="left">Hadoop集群本地仓库</td></tr></tbody></table><h2 id="网页登录"><a href="#网页登录" class="headerlink" title="网页登录"></a><font size=4><strong>网页登录</strong></font></h2><p><img src="/medias/img/hdp/0.jpg"></p><h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a><font size=4><strong>创建集群</strong></font></h2><p><img src="/medias/img/hdp/1.jpg"></p><h2 id="集群名"><a href="#集群名" class="headerlink" title="集群名"></a><font size=4><strong>集群名</strong></font></h2><p><img src="/medias/img/hdp/2.jpg"></p><h2 id="选择版本，yum源"><a href="#选择版本，yum源" class="headerlink" title="选择版本，yum源"></a><font size=4><strong>选择版本，yum源</strong></font></h2><p>网速好的可以选择公共源，也可以本地搭建源，下载地址：</p><p><strong>注意：ambari2.7.5需要登录,并获得授权之后才能下载，ambari版本号 ≤ 2.7.4 的版本可以直接下载</strong><br><strong>罗列RedHat|CentOS|Oracle Linux 7、amazonlinux 2、SLES 12、Ubuntu 14|16|18、Debian 9系统的下载地址</strong><br>可以在此选择hdp不同系统的安装源 <a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/bk_ambari-installation/content/hdp_314_repositories.html">hdp_314</a><br>可以在此选择ambari不同系统的安装源 <a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/bk_ambari-installation/content/ambari_repositories.html">ambari</a> </p><p><strong>罗列ambari的版本</strong><br>可以在此选择ambari版本 <a href="https://docs.cloudera.com/HDPDocuments/Ambari/Ambari-2.7.4.0/index.html">Ambari-2.7.4</a> </p><p><strong>centos7版本直接下载</strong><br>直接下载 <a href="http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.7.4.0/ambari-2.7.4.0-centos7.tar.gz">Ambari-2.7.4.0</a><br>直接下载 <a href="http://public-repo-1.hortonworks.com/HDP/centos7/3.x/updates/3.1.4.0/HDP-3.1.4.0-centos7-rpm.tar.gz">HDP-3.1.4.0</a><br>直接下载 <a href="http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz">HDP-UTILS-1.1.0.22</a><br>直接下载 <a href="http://public-repo-1.hortonworks.com/HDP-GPL/centos7/3.x/updates/3.1.4.0/HDP-GPL-3.1.4.0-centos7-gpl.tar.gz">HDP-GPL-3.1.4.0</a></p><p><img src="/medias/img/hdp/3.jpg"></p><h2 id="使用本地库，填入地址"><a href="#使用本地库，填入地址" class="headerlink" title="使用本地库，填入地址"></a><font size=4><strong>使用本地库，填入地址</strong></font></h2><p><img src="/medias/img/hdp/5.jpg"></p><h2 id="选择安装的服务器，填入ambari服务器私钥"><a href="#选择安装的服务器，填入ambari服务器私钥" class="headerlink" title="选择安装的服务器，填入ambari服务器私钥"></a><font size=4><strong>选择安装的服务器，填入ambari服务器私钥</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span><span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<span class="token number">192.168</span>.1.201  master1.hadoop.com<span class="token number">192.168</span>.1.202  master2.hadoop.com<span class="token number">192.168</span>.1.203  master3.hadoop.com<span class="token number">192.168</span>.1.204  slave1.hadoop.com<span class="token number">192.168</span>.1.205  slave2.hadoop.com<span class="token number">192.168</span>.1.206  client.hadoop.com<span class="token number">192.168</span>.1.207  repo.hadoop.com<span class="token number">192.168</span>.1.200  ambari.hadoop.com<span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># cat .ssh/id_rsa</span>-----BEGIN RSA PRIVATE KEY-----MIIEogIBAAKCAQEAlbnsR3q/iOaDdbTU5pvEyvnbtdYf3mZaT5JJAP6oFxNsGExjR+V5hLGAicW01oCidXBrlWOwlhTSh2BDjfaGkuz7fBS5hdpPDxE8a9/7se3oxLz8eXAHeJTc0w0dbaB2SriFcBDTjOpr+LjIuysDaMIa4oqOdJ7vXeZ6NZD+OvqmB3HQUf3UhQNvG/TSzikOQx7Ic0Qhax0bK2N9QDoMJpjihcCQB+iL+RqErj2GoAvais7FMWH0w7r4XwBAPnllTbMGnOJ1QqCpu6lgcvHKNu0i/9j92AHQ7iLv3X3b7ABXWj+sWhu4eWjhEStLxWndPdBRNTxshtcmw0SGOAbr2QIDAQABAoIBACj+twr7OOYq92OLF5/sln1c3CN1dVRXgfK3gvWaxDtNPhOJFsXgttz2HNOcJl906QZuuYY1vWvaV6ppWRXNohsod9MJeaKEm5DsjzaaJTgag9kaRaaaXfFOEQhYVu5lOP5Md3yvnry+ksGPFqboqA5O1z2f4lFcEv4K1PtFr9ZFz2mW/rx5JAoJ/kyS8Ue221ExSDzfzv1dV4RjPNIBNr1VsXeBV1NiCdc37m2BzdnuuxRJPyCiiY5Y6EMGfHnw6M/Q7I4IVSV7oEuk+iFi9UL58V2e6jZudMtEn/jgaN1y4lum3GFvGrfUcZAlRwWcPpezsf6Lc+KaqKkckgX03AECgYEAxJ6WgjKpubv+ABH8fqn0lchL9Y5+IHUZt9D3VwVAgfRhStN5C94aSw6zVvkVVoY35sQQi5MmJeHQqt2sZUifvxlzYF3voR1UGZtK08sk9i3CC669fu8M0tbd8glHwHf64Q8vZrALDLtPUDvQtup2/UkRcicrN6uv+rOmDGPuYtECgYEAwvHWvDYK8CsW5Cjh4AfIr5rxgVCg2v69WuH5FhAWv0nkv8wIiBcuvEZ7pFQG0C0ND7IjLxdOCcMtqTY++eJe6smfr9kSgyR9Nxz7+GuUWg6odg2moEZO4hqPIbPKzClTMHb8wUQYQi9U5Ry0EtEWMjCEwORUvQtWfZy6DSNR6okCgYAsAkcz+z0MKqzuvRfkDgyF3iBKZUuL3koUX7yNCMroi5efVPg6FMuT00WHCReil0Y569a8NwKJ5iJ7rERjIz9GWd7+SehSCquBU8YK4+RxCcruLH2TxNP8+UUSYMtjpDdOWsTEWlEO13ooPks4NgDOLqWuBGBjBJXOKpnXGiMIkQKBgBYjBDFnKaLQIc9S3SNlfuKCA76de0ai+rmhQ3m/5fVe3Lzy3F0n1MTIdC3a5NMq6nrHzbsBOHlfUoYOhOQ3UnPy5VFAoxuFPzrM7cft33DCjVqqfithEIAYZ/x5wCOi5bFxMY54vxB083z433HrkEuuusR0qTK2YOHutCndwuWRAoGANJx6rxBlwjfJuoLWoFdPWpx3hxpOY+kHoSWTd6wnpnJgE06zg5KFXutVYVqJF8OYLunxq+5uj4ao4bbWrTO+zE4ui2yxsYRjgJoLUlzvxRdJ3hWhI8IC82Jw+dm9DB2ST+lYHdfUMl5h6ZrFOeyhTVrfIXUNhy8jCD0DvxX9vCA<span class="token operator">=</span>-----END RSA PRIVATE KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/hdp/6.jpg"></p><h2 id="等待ambari-agent安装和注册"><a href="#等待ambari-agent安装和注册" class="headerlink" title="等待ambari-agent安装和注册"></a><font size=4><strong>等待ambari-agent安装和注册</strong></font></h2><p><img src="/medias/img/hdp/7.jpg"></p><h2 id="全部Success就OK"><a href="#全部Success就OK" class="headerlink" title="全部Success就OK"></a><font size=4><strong>全部Success就OK</strong></font></h2><p><img src="/medias/img/hdp/8.jpg"></p><h1 id="选择自己需要的组件安装"><a href="#选择自己需要的组件安装" class="headerlink" title="选择自己需要的组件安装"></a><font size=5><strong>选择自己需要的组件安装</strong></font></h1><p>减少不必要的组件，提高安装成功率<br><img src="/medias/img/hdp/9.jpg"></p><h2 id="手动把组件均匀分配给maser1-2-3三台服务器"><a href="#手动把组件均匀分配给maser1-2-3三台服务器" class="headerlink" title="手动把组件均匀分配给maser1|2|3三台服务器"></a><font size=4><strong>手动把组件均匀分配给maser1|2|3三台服务器</strong></font></h2><p><img src="/medias/img/hdp/10.jpg"></p><h2 id="master-slave-client节点安装分配"><a href="#master-slave-client节点安装分配" class="headerlink" title="master|slave|client节点安装分配"></a><font size=4><strong>master|slave|client节点安装分配</strong></font></h2><p>master节点不勾选，slave节点不勾选client其中ranger tagsync只能勾选一个，client节点只勾选client即可，注意看红框。<br><img src="/medias/img/hdp/11.jpg"></p><h2 id="填入密码，自己设置即可"><a href="#填入密码，自己设置即可" class="headerlink" title="填入密码，自己设置即可"></a><font size=4><strong>填入密码，自己设置即可</strong></font></h2><p><img src="/medias/img/hdp/12.jpg"><br><strong><font color=red>此段主机ambari.hadoop.com</font></strong></p><h1 id="这里要安装MySQL数据库"><a href="#这里要安装MySQL数据库" class="headerlink" title="这里要安装MySQL数据库"></a><font size=5><strong>这里要安装MySQL数据库</strong></font></h1><p><img src="/medias/img/hdp/13.jpg"></p><h2 id="数据库的yum源"><a href="#数据库的yum源" class="headerlink" title="数据库的yum源"></a><font size=4><strong>数据库的yum源</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># cat > /etc/yum.repos.d/mariadb.repo &lt;&lt; EOF</span><span class="token punctuation">[</span>mariadb<span class="token punctuation">]</span>name <span class="token operator">=</span> MariaDBbaseurl <span class="token operator">=</span> https://mirrors.ustc.edu.cn/mariadb/yum/10.2/centos7-amd64<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/hdp/14.jpg"></p><h2 id="安装启动数据库"><a href="#安装启动数据库" class="headerlink" title="安装启动数据库"></a><font size=4><strong>安装启动数据库</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># yum install MariaDB-client MariaDB-server MariaDB-devel -y</span><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable mariadb</span><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># systemctl start mariadb</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/hdp/15.jpg"></p><h2 id="授权信息"><a href="#授权信息" class="headerlink" title="授权信息"></a><font size=4><strong>授权信息</strong></font></h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> hive<span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">database</span> ranger<span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'root'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'root'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'root'</span><span class="token variable">@'ambari.hadoop.com'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'hive'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'hive'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'hive'</span><span class="token variable">@'ambari.hadoop.com'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'rangeradmin'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'rangeradmin'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'rangeradmin'</span><span class="token variable">@'ambari.hadoop.com'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'hdp121212'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/hdp/16.jpg"></p><h2 id="jdbc工具配置"><a href="#jdbc工具配置" class="headerlink" title="jdbc工具配置"></a><font size=4><strong>jdbc工具配置</strong></font></h2><p><img src="/medias/img/hdp/17.jpg"></p><h2 id="修改数据库地址，填入密码，测试通过即可"><a href="#修改数据库地址，填入密码，测试通过即可" class="headerlink" title="修改数据库地址，填入密码，测试通过即可"></a><font size=4><strong>修改数据库地址，填入密码，测试通过即可</strong></font></h2><p><img src="/medias/img/hdp/18.jpg"></p><h2 id="新手不建议配置直接下一步即可"><a href="#新手不建议配置直接下一步即可" class="headerlink" title="新手不建议配置直接下一步即可"></a><font size=4><strong>新手不建议配置直接下一步即可</strong></font></h2><p><img src="/medias/img/hdp/19.jpg"><br><img src="/medias/img/hdp/20.jpg"><br><img src="/medias/img/hdp/21.jpg"></p><h1 id="下载保存配置文件"><a href="#下载保存配置文件" class="headerlink" title="下载保存配置文件"></a><font size=5><strong>下载保存配置文件</strong></font></h1><p><img src="/medias/img/hdp/22.jpg"></p><h2 id="等待加载完成"><a href="#等待加载完成" class="headerlink" title="等待加载完成"></a><font size=4><strong>等待加载完成</strong></font></h2><p><img src="/medias/img/hdp/23.jpg"></p><h2 id="等待安装完成，全部成功即可"><a href="#等待安装完成，全部成功即可" class="headerlink" title="等待安装完成，全部成功即可"></a><font size=4><strong>等待安装完成，全部成功即可</strong></font></h2><p><img src="/medias/img/hdp/24.jpg"></p><h1 id="尝试排错重新启动"><a href="#尝试排错重新启动" class="headerlink" title="尝试排错重新启动"></a><font size=4><strong>尝试排错重新启动</strong></font></h1><p>经常出错，耐心排错吧😄<br>少安装一些不用的组件、内存大一些、防火墙关闭、selinux关闭、拍摄快照、ambari-server主机免密登录ambari-agent主机即可、等等，重试几次。多次尝试后报同一个错误请留言或百度解决😘。<br><img src="/medias/img/hdp/25.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ambari </tag>
            
            <tag> hadoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Breezean安装</title>
      <link href="/posts/daacb33a.html"/>
      <url>/posts/daacb33a.html</url>
      
        <content type="html"><![CDATA[<h1 id="约定"><a href="#约定" class="headerlink" title="约定"></a><font size=5><strong>约定</strong></font></h1><p><strong>系统要求:</strong><br>部署机: docker 1.13.1+ and docker-compose 1.12.0+ .<br>Kubernetes集群节点: 兼容CentOS 7.4|5|6|7 及 Ubuntu 16|18 版本，Minimal安装，应尽可能保证系统的干净。</p><h1 id="breeze安装环境配置"><a href="#breeze安装环境配置" class="headerlink" title="breeze安装环境配置"></a><font size=5><strong>breeze安装环境配置</strong></font></h1><p>接上文esxi安装，利用其虚拟化出多个虚拟机。</p><table><thead><tr><th align="right">主机名</th><th align="center">IP</th><th align="center">内存</th><th align="center">角色</th><th align="left">组件</th></tr></thead><tbody><tr><td align="right">deploy</td><td align="center">192.168.1.220</td><td align="center">4G+</td><td align="center">Breeze Deploy</td><td align="left">docker/docker-compose/Breeze</td></tr><tr><td align="right">master01</td><td align="center">192.168.1.221</td><td align="center">4G+</td><td align="center">K8S Master Node</td><td align="left">K8S Master/etcd/HAProxy/Keepalived</td></tr><tr><td align="right">master02</td><td align="center">192.168.1.222</td><td align="center">4G+</td><td align="center">K8S Master Node</td><td align="left">K8S Master/etcd/HAProxy/Keepalived</td></tr><tr><td align="right">master03</td><td align="center">192.168.1.223</td><td align="center">4G+</td><td align="center">K8S Master Node</td><td align="left">K8S Master/etcd/HAProxy/Keepalived</td></tr><tr><td align="right">worker01</td><td align="center">192.168.1.224</td><td align="center">4G+</td><td align="center">K8S Worker Node</td><td align="left">K8S Worker/Prometheus</td></tr><tr><td align="right">harbor</td><td align="center">192.168.1.225</td><td align="center">4G+</td><td align="center">Harbor</td><td align="left">Harbor 1.7.0</td></tr><tr><td align="right"></td><td align="center">192.168.1.226</td><td align="center"></td><td align="center">VIP</td><td align="left">HA虚IP地址在3台K8S Master浮动</td></tr></tbody></table><h2 id="创建6台虚拟机"><a href="#创建6台虚拟机" class="headerlink" title="创建6台虚拟机"></a><font size=4><strong>创建6台虚拟机</strong></font></h2><p><img src="/medias/img/breeze/0.jpg"></p><h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a><font size=4><strong>安装系统</strong></font></h2><p><img src="/medias/img/breeze/1.jpg"></p><h2 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a><font size=4><strong>配置防火墙</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0 </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># sed --follow-symlinks -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --set-default-zone=trusted </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --complete-reload </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/breeze/2.jpg"></p><h1 id="导入下载好的镜像"><a href="#导入下载好的镜像" class="headerlink" title="导入下载好的镜像"></a><font size=5><strong>导入下载好的镜像</strong></font></h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># docker-compose up -d   # 这个以后执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/breeze/3.jpg"></p><h1 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a><font size=5><strong>安装docker-compose</strong></font></h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/docker-compose </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="安装docker-io"><a href="#安装docker-io" class="headerlink" title="安装docker-io"></a><font size=4><strong>安装docker-io</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># yum install docker </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker &amp;&amp; systemctl start docker </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/img/breeze/4.jpg"></p><h2 id="下载镜像文件"><a href="#下载镜像文件" class="headerlink" title="下载镜像文件"></a><font size=4><strong>下载镜像文件</strong></font></h2><p>最新为breeze/v1.17.0</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># curl -L https://raw.githubusercontent.com/wise2c-devops/breeze/v1.17.0/docker-compose.yml o docker-compose.yml </span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># docker-compose up -d   # 下载好之后可以备份迁移，下面我就是这么做的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="导入下载好的镜像文件"><a href="#导入下载好的镜像文件" class="headerlink" title="导入下载好的镜像文件"></a><font size=4><strong>导入下载好的镜像文件</strong></font></h2><p><img src="/medias/img/breeze/5.jpg"></p><h2 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a><font size=4><strong>免密登录</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen </span> <span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id 192.168.1.221:</span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id 192.168.1.222:</span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id 192.168.1.223:</span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id 192.168.1.224:</span><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id 192.168.1.225:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/breeze/6.jpg"></p><h2 id="导入完成，启动"><a href="#导入完成，启动" class="headerlink" title="导入完成，启动"></a><font size=4><strong>导入完成，启动</strong></font></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@deploy ~<span class="token punctuation">]</span><span class="token comment"># docker-compose up -d</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/breeze/7.jpg"></p><h1 id="配置hosts文件"><a href="#配置hosts文件" class="headerlink" title="配置hosts文件"></a><font size=5><strong>配置hosts文件</strong></font></h1><p><img src="/medias/img/breeze/8.jpg"></p><h2 id="访问220-88开始安装"><a href="#访问220-88开始安装" class="headerlink" title="访问220:88开始安装"></a><font size=4><strong>访问220:88开始安装</strong></font></h2><p><img src="/medias/img/breeze/9.jpg"></p><h2 id="填写集群名"><a href="#填写集群名" class="headerlink" title="填写集群名"></a><font size=4><strong>填写集群名</strong></font></h2><p><img src="/medias/img/breeze/10.jpg"></p><h2 id="创建完成打开"><a href="#创建完成打开" class="headerlink" title="创建完成打开"></a><font size=4><strong>创建完成打开</strong></font></h2><p><img src="/medias/img/breeze/11.jpg"></p><h2 id="增加主机"><a href="#增加主机" class="headerlink" title="增加主机"></a><font size=4><strong>增加主机</strong></font></h2><p><img src="/medias/img/breeze/12.jpg"></p><h2 id="完成后如下"><a href="#完成后如下" class="headerlink" title="完成后如下"></a><font size=4><strong>完成后如下</strong></font></h2><p><img src="/medias/img/breeze/13.jpg"></p><h2 id="增加组件"><a href="#增加组件" class="headerlink" title="增加组件"></a><font size=4><strong>增加组件</strong></font></h2><p><img src="/medias/img/breeze/14.jpg"></p><h2 id="全部配置如下"><a href="#全部配置如下" class="headerlink" title="全部配置如下"></a><font size=4><strong>全部配置如下</strong></font></h2><p><img src="/medias/img/breeze/15.jpg"></p><h1 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a><font size=5><strong>开始安装</strong></font></h1><p><img src="/medias/img/breeze/16.jpg"></p><h1 id="安装完成"><a href="#安装完成" class="headerlink" title="安装完成"></a><font size=5><strong>安装完成</strong></font></h1><p><img src="/medias/img/breeze/17.jpg"><br><img src="/medias/img/breeze/18.jpg"><br>接下来就是到服务器上去使用啦</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">验证： <span class="token punctuation">[</span>root@worker01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cs </span><span class="token punctuation">[</span>root@worker01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get csr </span><span class="token punctuation">[</span>root@worker01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes -o wide </span><span class="token punctuation">[</span>root@worker01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl -n kube-system get pods </span><span class="token punctuation">[</span>root@worker01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl -n monitoring get pods </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Grafana: <a href="http://node:30902/">http://node:30902</a><br>Prometheus: <a href="http://node:30900/">http://node:30900</a><br>Alertmanager: <a href="http://node:30903/">http://node:30903</a></p><p><strong>ERR：</strong><br>点击创建无反应，切换浏览器急速模式or换浏览器。</p>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> breeze </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ambari安装</title>
      <link href="/posts/9bf5a8ac.html"/>
      <url>/posts/9bf5a8ac.html</url>
      
        <content type="html"><![CDATA[<!-- # <font size=5>**ambari安装视频**</font><iframe height="600" width="800" src="//player.bilibili.com/player.html?aid=80163134&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe> --><h1 id="ambari安装环境配置"><a href="#ambari安装环境配置" class="headerlink" title="ambari安装环境配置"></a><font size=5><strong>ambari安装环境配置</strong></font></h1><p>接上文esxi安装，利用其虚拟化出多个虚拟机。</p><table><thead><tr><th align="right">主机名</th><th align="center">IP</th><th align="center">内存</th><th align="left">介绍</th></tr></thead><tbody><tr><td align="right">ambari.hadoop.com</td><td align="center">192.168.1.229</td><td align="center">4G+</td><td align="left">Hadoop集群管理工具</td></tr><tr><td align="right">master1.hadoop.com</td><td align="center">192.168.1.207</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">master2.hadoop.com</td><td align="center">192.168.1.208</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">master3.hadoop.com</td><td align="center">192.168.1.209</td><td align="center">8G+</td><td align="left">Hadoop集群master节点</td></tr><tr><td align="right">slave1.hadoop.com</td><td align="center">192.168.1.211</td><td align="center">4G+</td><td align="left">Hadoop集群slave节点</td></tr><tr><td align="right">slave2.hadoop.com</td><td align="center">192.168.1.212</td><td align="center">4G+</td><td align="left">Hadoop集群slave节点</td></tr><tr><td align="right">client.hadoop.com</td><td align="center">192.168.1.221</td><td align="center">4G+</td><td align="left">Hadoop集群client节点</td></tr><tr><td align="right">repo.hadoop.com</td><td align="center">192.168.1.228</td><td align="center">1G+</td><td align="left">Hadoop集群本地仓库</td></tr></tbody></table><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a><font size=4><strong>创建虚拟机</strong></font></h2><p><img src="/medias/img/ambari/0.jpg"></p><h2 id="虚拟机名-amp-系统"><a href="#虚拟机名-amp-系统" class="headerlink" title="虚拟机名&amp;系统"></a><font size=4><strong>虚拟机名&amp;系统</strong></font></h2><p><img src="/medias/img/ambari/1.jpg"></p><h2 id="虚拟机安装位置"><a href="#虚拟机安装位置" class="headerlink" title="虚拟机安装位置"></a><font size=4><strong>虚拟机安装位置</strong></font></h2><p><img src="/medias/img/ambari/2.jpg"></p><h3 id="选择CPU热添加"><a href="#选择CPU热添加" class="headerlink" title="选择CPU热添加"></a><font size=3><strong>选择CPU热添加</strong></font></h3><p><img src="/medias/img/ambari/3.jpg"></p><h3 id="选择CPU虚拟化"><a href="#选择CPU虚拟化" class="headerlink" title="选择CPU虚拟化"></a><font size=3><strong>选择CPU虚拟化</strong></font></h3><p><img src="/medias/img/ambari/4.jpg"></p><h3 id="设置RAM大小，启用内存热插拔"><a href="#设置RAM大小，启用内存热插拔" class="headerlink" title="设置RAM大小，启用内存热插拔"></a><font size=3><strong>设置RAM大小，启用内存热插拔</strong></font></h3><p><img src="/medias/img/ambari/5.jpg"></p><h2 id="选择系统盘大小40G"><a href="#选择系统盘大小40G" class="headerlink" title="选择系统盘大小40G+"></a><font size=4><strong>选择系统盘大小40G+</strong></font></h2><p><img src="/medias/img/ambari/6.jpg"></p><h2 id="选择上载的ISO文件"><a href="#选择上载的ISO文件" class="headerlink" title="选择上载的ISO文件"></a><font size=4><strong>选择上载的ISO文件</strong></font></h2><p><img src="/medias/img/ambari/7.jpg"></p><h2 id="双击红色框区域，和VMware安装一样"><a href="#双击红色框区域，和VMware安装一样" class="headerlink" title="双击红色框区域，和VMware安装一样"></a><font size=4><strong>双击红色框区域，和VMware安装一样</strong></font></h2><p><img src="/medias/img/ambari/8.jpg"></p><h1 id="全部安装完记得右键拍摄快照，记好快照备注"><a href="#全部安装完记得右键拍摄快照，记好快照备注" class="headerlink" title="全部安装完记得右键拍摄快照，记好快照备注"></a><font size=5><strong>全部安装完记得右键拍摄快照，记好快照备注</strong></font></h1><p><img src="/medias/img/ambari/9.jpg"><br><strong><font color=red>此段主机repo.hadoop.com</font></strong></p><h1 id="repo机器安装apache服务"><a href="#repo机器安装apache服务" class="headerlink" title="repo机器安装apache服务"></a><font size=5><strong>repo机器安装apache服务</strong></font></h1><p><img src="/medias/img/ambari/10.jpg"></p><h2 id="上传下载好的ambari-HDP库"><a href="#上传下载好的ambari-HDP库" class="headerlink" title="上传下载好的ambari-HDP库"></a><font size=4><strong>上传下载好的ambari-HDP库</strong></font></h2><p><strong>参考ambari安装hdp-链接</strong><br><img src="/medias/img/ambari/11.jpg"><br><strong><font color=red>此段结束</font></strong></p><h2 id="repo仓库配置"><a href="#repo仓库配置" class="headerlink" title="repo仓库配置"></a><font size=4><strong>repo仓库配置</strong></font></h2><p><strong>一定要修改脚本,为自己可用,下面有写在优化脚本中,本段可忽略</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@repo ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/ambari.repo</span><span class="token punctuation">[</span>ambari<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>ambari<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://192.168.1.200/ambari/centos7/2.7.3.0-139/<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">[</span>HDP<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>HDP<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://192.168.1.200/HDP/centos7/3.1.0.0-78/<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">[</span>HDP-UTILS<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>HDP-UTILS<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://192.168.1.200/HDP-UTILS/centos7/1.1.0.22/<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="jdk配置"><a href="#jdk配置" class="headerlink" title="jdk配置"></a><font size=5><strong>jdk配置</strong></font></h1><p><strong>一定要修改脚本,为自己可用,下面有写在优化脚本中,本段可忽略</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> <span class="token parameter variable">-O</span> /opt/jdk-8u151-linux-x64.tar.gz http://192.168.1.200/jdk-8u151-linux-x64.tar.gz<span class="token builtin class-name">cd</span> /opt <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> xf jdk-8u151-linux-x64.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFexport JAVA_HOME=/opt/jdk1.8.0_151/export PATH=<span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>export CLASSPATH=.:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jarEOF</span><span class="token builtin class-name">source</span> /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="一些脚本"><a href="#一些脚本" class="headerlink" title="一些脚本"></a><font size=5><strong>一些脚本</strong></font></h1><h2 id="免交互生成密钥-amp-密钥分发"><a href="#免交互生成密钥-amp-密钥分发" class="headerlink" title="免交互生成密钥 &amp; 密钥分发"></a><font size=4><strong>免交互生成密钥 &amp; 密钥分发</strong></font></h2><p><strong><font color=red>此段主机ambari.hadoop.com</font></strong></p><p><strong>一定要修改脚本,为自己可用</strong></font></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 安装密钥生成工具和批量处理工具</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">expect</span> sshpass<span class="token comment"># 无交互生成密钥</span>spawn ssh-keygen<span class="token function">expect</span> <span class="token punctuation">&#123;</span>        <span class="token string">"*(~/.ssh/id_rsa)"</span> <span class="token punctuation">&#123;</span>send <span class="token string">"<span class="token entity" title="\r">\r</span>"</span><span class="token punctuation">;</span>exp_continue<span class="token punctuation">&#125;</span>        <span class="token string">"*(empty for no passphrase)"</span> <span class="token punctuation">&#123;</span>send <span class="token string">"<span class="token entity" title="\r">\r</span>"</span><span class="token punctuation">;</span>exp_continue<span class="token punctuation">&#125;</span>        <span class="token string">"*again"</span> <span class="token punctuation">&#123;</span>send <span class="token string">"<span class="token entity" title="\r">\r</span>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">expect</span> eof<span class="token comment"># 批量分发</span><span class="token comment">#for ip in $*</span><span class="token keyword">for</span> <span class="token for-or-select variable">ip</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">101</span> <span class="token number">111</span><span class="token variable">)</span></span><span class="token keyword">do</span>  <span class="token function">ping</span> <span class="token number">192.168</span>.1.<span class="token variable">$ip</span> <span class="token parameter variable">-c1</span> <span class="token operator">&amp;></span>/dev/null   <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-gt</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"192.168.1.<span class="token variable">$ip</span>无法ping通请检查网络"</span>     <span class="token builtin class-name">continue</span>  <span class="token keyword">fi</span>  sshpass <span class="token parameter variable">-p</span> <span class="token string">"pass@word1"</span> ssh-copy-id <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no root@192.168.1.<span class="token variable">$ip</span> <span class="token operator">&amp;></span>/dev/null  <span class="token builtin class-name">echo</span> <span class="token string">"192.168.1.<span class="token variable">$ip</span> 密钥分发成功"</span><span class="token keyword">done</span><span class="token comment">################################</span><span class="token comment">#1.使用ssh连接远程主机时加上"-o StrictHostKeyChecking=no"的选项，如下：（推荐！！！）</span><span class="token comment">#做法是使用-o 这个参数，在ssh/scp里加上 -o "StrictHostKeyChecking no" 即可跳过这个yes/no询问，直接进入下一步，例：</span><span class="token comment">#Use the -o option：</span><span class="token comment">#scp -o "StrictHostKeyChecking no" 1.txt user@host:1.txt </span><span class="token comment">#ssh -o "StrictHostKeyChecking no" user@host</span><span class="token comment">#2.一个彻底去掉这个提示的方法是，修改当前主机/etc/ssh/ssh_config文件（或$HOME/.ssh/config）中的配置，添加如下两行配置：</span><span class="token comment">#源为：StrictHostKeyChecking ask</span><span class="token comment">#改为：StrictHostKeyChecking no</span><span class="token comment">#################################</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 执行bash 当前脚本 IP1 IP2 IP3...,输入的IP会传给$*</span><span class="token assign-left variable">User</span><span class="token operator">=</span>root<span class="token assign-left variable">passWord</span><span class="token operator">=</span>pass@word1<span class="token keyword">for</span> <span class="token for-or-select variable">ip</span> <span class="token keyword">in</span> <span class="token variable">$*</span><span class="token keyword">do</span>    <span class="token function">ping</span> <span class="token number">192.168</span>.1.<span class="token variable">$ip</span> <span class="token parameter variable">-c1</span> <span class="token operator">&amp;></span>/dev/null     <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-gt</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$ip</span>无法ping通请检查网络"</span>         <span class="token builtin class-name">continue</span>    <span class="token keyword">fi</span><span class="token comment">#    sshpass -p "$passWord" ssh-copy-id -i ~/.ssh/id_dsa.pub "-o StrictHostKeyChecking=no $&#123;User&#125;@$ip" &amp;>/dev/null</span><span class="token comment">#    echo "$ip 密钥分发成功"</span>     <span class="token builtin class-name">echo</span> <span class="token string">"192.168.1.<span class="token variable">$ip</span> ok"</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><font color=red>此段结束</font></strong></p><h2 id="安装系统-优化脚本"><a href="#安装系统-优化脚本" class="headerlink" title="安装系统,优化脚本"></a><font size=4><strong>安装系统,优化脚本</strong></font></h2><p><strong>一定要修改脚本,为自己可用</strong></p><p>将脚本分发给所有主机并执行.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment">#Yum源更换为国内阿里源</span>yum <span class="token function">install</span> <span class="token function">wget</span> telnet <span class="token parameter variable">-y</span><span class="token builtin class-name">cd</span> /etc/yum.repos.d/<span class="token function">mkdir</span> repo_old<span class="token function">mv</span> *.repo repo_old/<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<span class="token comment">#添加阿里的epel源</span><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<span class="token comment">#添加ambari本地源</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/yum.repos.d/ambari.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[ambari]name=ambaribaseurl=http://192.168.1.200/ambari/centos7/2.7.3.0-139/gpgcheck=0enabled=1[HDP]name=HDPbaseurl=http://192.168.1.200/HDP/centos7/3.1.0.0-78/gpgcheck=0enabled=1[HDP-UTILS]name=HDP-UTILSbaseurl=http://192.168.1.200/HDP-UTILS/centos7/1.1.0.22/gpgcheck=0enabled=1EOF</span><span class="token comment">#修改hosts文件</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF192.168.1.101  master1.hadoop.com192.168.1.102  master2.hadoop.com192.168.1.103  master3.hadoop.com192.168.1.104  slave1.hadoop.com192.168.1.105  slave2.hadoop.com192.168.1.108  client.hadoop.com192.168.1.110  ambari.hadoop.comEOF</span><span class="token comment">#yum重新建立缓存</span>yum clean allyum makecache<span class="token comment">#同步时间</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntp/usr/sbin/ntpdate cn.pool.ntp.org<span class="token builtin class-name">echo</span> <span class="token string">"* 4 * * * /usr/sbin/ntpdate cn.pool.ntp.org > /dev/null 2>&amp;1"</span> <span class="token operator">>></span> /var/spool/cron/rootsystemctl  restart crond.service<span class="token comment">#安装vim</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">vim</span><span class="token comment">#设置最大打开文件描述符数</span><span class="token builtin class-name">echo</span> <span class="token string">"ulimit -SHn 102400"</span> <span class="token operator">>></span> /etc/rc.local<span class="token function">cat</span> <span class="token operator">>></span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF*           soft   nofile       655350*           hard   nofile       655350EOF</span><span class="token comment">#禁用selinux &amp; firewalld</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/configsetenforce <span class="token number">0</span>systemctl disable firewalld.service systemctl stop firewalld.service <span class="token comment">#ssh设置</span><span class="token comment">#sed -i 's/^GSSAPIAuthentication yes$/GSSAPIAuthentication no/' /etc/ssh/sshd_config</span><span class="token comment">#sed -i 's/#UseDNS yes/UseDNS no/' /etc/ssh/sshd_config</span><span class="token comment">#systemctl  restart sshd.service</span><span class="token comment">#内核参数优化</span><span class="token comment">#cat >> /etc/sysctl.conf &lt;&lt; EOF</span><span class="token comment">#vm.overcommit_memory = 1</span><span class="token comment">#net.ipv4.tcp_fin_timeout = 1</span><span class="token comment">#net.ipv4.tcp_keepalive_time = 1200</span><span class="token comment">#net.ipv4.tcp_mem = 94500000 915000000 927000000</span><span class="token comment">#net.ipv4.tcp_tw_reuse = 1</span><span class="token comment">#net.ipv4.tcp_tw_recycle = 1</span><span class="token comment">#net.ipv4.tcp_timestamps = 0</span><span class="token comment">#net.ipv4.tcp_synack_retries = 1</span><span class="token comment">#net.ipv4.tcp_syn_retries = 1</span><span class="token comment">#net.ipv4.tcp_abort_on_overflow = 0</span><span class="token comment">#net.core.rmem_max = 16777216</span><span class="token comment">#net.core.wmem_max = 16777216</span><span class="token comment">#net.core.netdev_max_backlog = 262144</span><span class="token comment">#net.ipv4.tcp_max_orphans = 3276800</span><span class="token comment">#net.ipv4.tcp_max_syn_backlog = 262144</span><span class="token comment">#net.core.wmem_default = 8388608</span><span class="token comment">#net.core.rmem_default = 8388608</span><span class="token comment">#EOF</span><span class="token comment">#/sbin/sysctl -p</span><span class="token comment"># jdk 配置</span><span class="token function">wget</span> <span class="token parameter variable">-O</span> /opt/jdk-8u151-linux-x64.tar.gz http://192.168.1.200/jdk-8u151-linux-x64.tar.gz<span class="token builtin class-name">cd</span> /opt <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> xf jdk-8u151-linux-x64.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFexport JAVA_HOME=/opt/jdk1.8.0_151/export PATH=<span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>export CLASSPATH=.:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jarEOF</span><span class="token comment">#vim定义退格键可删除最后一个字符类型</span><span class="token builtin class-name">echo</span> <span class="token string">'alias vi=vim'</span> <span class="token operator">>></span> /etc/profile<span class="token builtin class-name">echo</span> <span class="token string">'stty erase ^H'</span> <span class="token operator">>></span> /etc/profile<span class="token function">cat</span> <span class="token operator">>></span> /root/.vimrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFset tabstop=4set shiftwidth=4set expandtabsyntax onset numberEOF</span><span class="token comment">#update soft</span><span class="token comment">#yum -y update</span><span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ambari安装"><a href="#ambari安装" class="headerlink" title="ambari安装"></a><font size=5><strong>ambari安装</strong></font></h1><p><strong><font color=red>此段在ambari.hadoop.com</font></strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># yum install ambari-server -y</span><span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># ambari-server setup</span>Using python  /usr/bin/pythonSetup ambari-serverChecking SELinux<span class="token punctuation">..</span>.SELinux status is <span class="token string">'disabled'</span>Customize user account <span class="token keyword">for</span> ambari-server daemon <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>? yEnter user account <span class="token keyword">for</span> ambari-server daemon <span class="token punctuation">(</span>root<span class="token punctuation">)</span>:rootAdjusting ambari-server permissions and ownership<span class="token punctuation">..</span>.Checking firewall status<span class="token punctuation">..</span>.Checking JDK<span class="token punctuation">..</span>.<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Oracle JDK <span class="token number">1.8</span> + Java Cryptography Extension <span class="token punctuation">(</span>JCE<span class="token punctuation">)</span> Policy Files <span class="token number">8</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Custom JDK<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Enter choice <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>: <span class="token number">2</span>WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.WARNING: JCE Policy files are required <span class="token keyword">for</span> configuring Kerberos security. If you plan to use Kerberos,please <span class="token function">make</span> sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.Path to JAVA_HOME: /opt/jdk1.8.0_151/Validating JDK on Ambari Server<span class="token punctuation">..</span>.done.Check JDK version <span class="token keyword">for</span> Ambari Server<span class="token punctuation">..</span>.JDK version found: <span class="token number">8</span>Minimum JDK version is <span class="token number">8</span> <span class="token keyword">for</span> Ambari. Skipping to setup different JDK <span class="token keyword">for</span> Ambari Server.Checking GPL software agreement<span class="token punctuation">..</span>.GPL License <span class="token keyword">for</span> LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.htmlEnable Ambari Server to download and <span class="token function">install</span> GPL Licensed LZO packages <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>? Completing setup<span class="token punctuation">..</span>.Configuring database<span class="token punctuation">..</span>.Enter advanced database configuration <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>? Configuring database<span class="token punctuation">..</span>.Default properties detected. Using built-in database.Configuring ambari database<span class="token punctuation">..</span>.Checking PostgreSQL<span class="token punctuation">..</span>.Running initdb: This may take up to a minute.Initializing database <span class="token punctuation">..</span>. OKAbout to start PostgreSQLConfiguring <span class="token builtin class-name">local</span> database<span class="token punctuation">..</span>.Configuring PostgreSQL<span class="token punctuation">..</span>.Restarting PostgreSQLCreating schema and user<span class="token punctuation">..</span>.done.Creating tables<span class="token punctuation">..</span>.done.Extracting system views<span class="token punctuation">..</span>.ambari-admin-2.7.3.0.139.jar<span class="token punctuation">..</span><span class="token punctuation">..</span>Ambari repo <span class="token function">file</span> doesn<span class="token string">'t contain latest json url, skipping repoinfos modificationAdjusting ambari-server permissions and ownership...Ambari Server '</span>setup' completed successfully.<span class="token punctuation">[</span>root@ambari ~<span class="token punctuation">]</span><span class="token comment"># ambari-server start</span><span class="token comment"># 网页端访问ambari.hadoop.com:8080安装hadoop即可，下一篇介绍。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><font color=red>此段结束</font></strong></p>]]></content>
      
      
      <categories>
          
          <category> KDP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ambari </tag>
            
            <tag> hadoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ESXi 6.7</title>
      <link href="/posts/fe6fc899.html"/>
      <url>/posts/fe6fc899.html</url>
      
        <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote><p>约定</p></blockquote><p>软碟通 版本9.7 <a href="https://cn.ultraiso.net/xiazai.html" title="版本：9.7.2.3561">软碟通9.7</a><br>esxi 版本6.7 <a href="https://my.vmware.com/cn/web/vmware/evalcenter?p=vsphere-eval&wd=&eqid=bbb193fe000386d7000000025dfc67c4" title="VMware vSphere 6.7">VMware vSphere 6.7</a><br>下载好esxi6.7需要注册账户下载(免费)，或者通过第三方分享下载。<br>下载好ultraiso可以免费试用</p><blockquote><p>esxi系统安装</p></blockquote><blockquote><p>打开软碟通软件，选择镜像，点击启动，写入硬盘映像</p></blockquote><p><img src="/medias/img/esxi/0.jpg"></p><blockquote><p>写入，等待完成</p></blockquote><p><img src="/medias/img/esxi/1.jpg"></p><blockquote><p>完成后，写入便捷启动</p></blockquote><p><img src="/medias/img/esxi/2.jpg"></p><blockquote><p>选择syslinux写入即可</p></blockquote><p><img src="/medias/img/esxi/3.jpg"></p><blockquote><p>选择Linux服务器安装syslinux</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> syslinux <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/esxi/4.jpg"></p><blockquote><p>把menu.c32复制出来</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/share/syslinux<span class="token comment"># 1.使用sftp工具导出</span><span class="token comment"># 2.使用lrzsz导出</span>yum <span class="token function">install</span> lrzsz <span class="token parameter variable">-y</span>sz menu.c32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/esxi/5.jpg"></p><blockquote><p>把menu.c32复制到U盘的根目录，选择覆盖</p></blockquote><p><img src="/medias/img/esxi/6.jpg"></p><blockquote><p>U盘插入服务器，开机F8选择U盘启动</p></blockquote><p><img src="/medias/img/esxi/7.jpg"></p><blockquote><p>欢迎安装界面，选择Continue</p></blockquote><p><img src="/medias/img/esxi/8.jpg"></p><blockquote><p>用户协议，F11同意继续</p></blockquote><p><img src="/medias/img/esxi/9.jpg"></p><blockquote><p>扫描设备，等一会就好</p></blockquote><p><img src="/medias/img/esxi/10.jpg"></p><blockquote><p>注意！这里一定确认是你的硬盘<br>这里是安装esxi需要的硬盘，不要选择自己的U盘，除非你想把系统安装到U盘中</p></blockquote><p><img src="/medias/img/esxi/11.jpg"></p><blockquote><p>输入设备，如果你的键鼠不是特殊的，默认即可</p></blockquote><p><img src="/medias/img/esxi/12.jpg"></p><blockquote><p>root密码，网页管理台和设置用得到<br>(最好<font color=red>大小写 符号 数字</font>都有)</p></blockquote><p><img src="/medias/img/esxi/13.jpg"></p><blockquote><p>选择安装</p></blockquote><p><img src="/medias/img/esxi/14.jpg"></p><blockquote><p>等待读条</p></blockquote><p><img src="/medias/img/esxi/15.jpg"></p><blockquote><p>重启</p></blockquote><p><img src="/medias/img/esxi/16.jpg"></p><blockquote><p>重启完的页面<br>我的服务器是插入网线，是可以上网的。<font color=red>F2</font>进入设置界面</p></blockquote><p><img src="/medias/img/esxi/17.jpg"></p><blockquote><p>输入刚才设定的密码，进入设置<br>输入密码会回到首页，<font color=red>再按一次F2</font>即可</p></blockquote><p><img src="/medias/img/esxi/18.jpg"></p><blockquote><p>三个网卡设置选项<br>从上到下分别是，<font color=red>设置网络、重启、测试</font></p></blockquote><p><img src="/medias/img/esxi/19.jpg"></p><blockquote><p>回车进入设置，只设置IPv4和DNS即可</p></blockquote><p><img src="/medias/img/esxi/20.jpg"></p><blockquote><p>IPv4选择手动设置，使用空格键选择，设置完，回车保存</p></blockquote><p><img src="/medias/img/esxi/21.jpg"></p><blockquote><p>DNS设置和上面一样</p></blockquote><p><img src="/medias/img/esxi/22.jpg"></p><blockquote><p>使用Esc退出</p></blockquote><p><img src="/medias/img/esxi/23.jpg"></p><blockquote><p>会提示你保存，保存即可</p></blockquote><p><img src="/medias/img/esxi/24.jpg"></p><blockquote><p>重启网络</p></blockquote><p><img src="/medias/img/esxi/25.jpg"></p><blockquote><p>测试网络，给定几个IP，回车测试</p></blockquote><p><img src="/medias/img/esxi/26.jpg"></p><blockquote><p>全是OK.就行</p></blockquote><p><img src="/medias/img/esxi/27.jpg"></p><blockquote><p>Esc退回到首页</p></blockquote><p><img src="/medias/img/esxi/28.jpg"></p><blockquote><p>首页是自己设定的IP和DNS</p></blockquote><p><img src="/medias/img/esxi/29.jpg"></p><blockquote><p>浏览器输入地址，按红框一步步来</p></blockquote><p><img src="/medias/img/esxi/30.jpg"></p><blockquote><p>输入用户密码进入管理台</p></blockquote><p><img src="/medias/img/esxi/31.jpg"></p><blockquote><p>按照红框，选择分配许可证</p></blockquote><p><img src="/medias/img/esxi/32.jpg"></p><blockquote><p>添加后看过期日期</p></blockquote><p><img src="/medias/img/esxi/33.jpg"></p><blockquote><p>按照红框，创建虚拟机和VMware一样</p></blockquote><p><img src="/medias/img/esxi/34.jpg"></p><blockquote><p>补充镜像上载<br>按照标注序号一步步操作即可，选择存储–&gt;选定其中一块磁盘–&gt;数据存储浏览器–&gt;上载–&gt;选择自己的镜像上传即可.</p></blockquote><p><img src="/medias/img/esxi/35.jpg"></p><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><h3 id="通过zip包升级"><a href="#通过zip包升级" class="headerlink" title="通过zip包升级"></a>通过zip包升级</h3><p>本文以ESXI6.7.0 Update 1为例，将ESXI版本升级至6.7.0 Update 3</p><blockquote><p>1、下载升级包</p></blockquote><p>登陆vmware下载升级包</p><p><a href="https://my.vmware.com/zh/group/vmware/patch">https://my.vmware.com/zh/group/vmware/patch</a></p><p><img src="/medias/img/esxi/esxi_update1-1024x405.png"></p><blockquote><p>2、将下载好的.zip包，上传到存储卷中</p></blockquote><p><img src="/medias/img/esxi/esxi_update2-1024x456.png"></p><blockquote><p>3、启用安全Shell（SSH），并关闭所有正在运行的虚拟机</p></blockquote><p><img src="/medias/img/esxi/esxi_update3-1024x248.png"></p><blockquote><p>4、进入维护模式准备升级</p></blockquote><p><img src="/medias/img/esxi/esxi_update4.png"></p><p><img src="/medias/img/esxi/esxi_update5.png"></p><blockquote><p>5、使用xshell连接ESXI，假设ESXI的IP地址192.168.50.127</p></blockquote><p><img src="/medias/img/esxi/esxi_update6.png"></p><p>连接时选择Keyboard Interactive，密码是你当前ESXI的密码</p><p><img src="/medias/img/esxi/esxi_update7.png"></p><blockquote><p>6、升级</p></blockquote><blockquote><p>输入升级命令进行升级，其中/vmfs/volumes/db1/ESXi670-201912001.zip为升级包所在位置，每个人的路径都不同</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">esxcli software vib update <span class="token parameter variable">-d</span> /vmfs/volumes/db1/ESXi670-201912001.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>Installation Result<br>Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.<br>Reboot Required: true<br>VIBs Installed: VMW_bootbank_bnxtnet_20.6.101.7-24vmw.670.3.73.14320388, VMW_bootbank_brcmfcoe_11.4.1078.25-14vmw.670.3.73.14320388, VMW_bootbank_elxnet_11.4.1097.0-5vmw.670.3.73.14320388,  ……列出的各种升级包。</p></blockquote><blockquote><p>7、重启</p></blockquote><p>输入命令重启ESXI</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">reboot</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>8、重启后可看到版本号改变，升级成功</p></blockquote><p><img src="/medias/img/esxi/esxi_update8-1024x250.png"></p><blockquote><p>9、退出维护模式，升级至此完成</p></blockquote><p><img src="/medias/img/esxi/esxi_update9.png"></p><h3 id="ESXi-6-7-0-通过命令行升级"><a href="#ESXi-6-7-0-通过命令行升级" class="headerlink" title="ESXi 6.7.0 通过命令行升级"></a>ESXi 6.7.0 通过命令行升级</h3><p>上面写了基于离线包的升级方式。下面写一下在线升级的基本步骤。（实测速度很慢）</p><blockquote><p>1、查看可用的更新包</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">esxcli software sources profile list <span class="token parameter variable">-d</span> https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml <span class="token operator">|</span> <span class="token function">grep</span> ESXi-6.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>2、执行在线更新（不含TOOLS，防止 No Space Left On Device）</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">esxcli software profile update <span class="token parameter variable">-p</span> ESXi-6.7.0-20190802001-no-tools <span class="token parameter variable">-d</span> https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>3、单独更新TOOLS</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">esxcli software vib <span class="token function">install</span> <span class="token parameter variable">-v</span> https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/esx/vmw/vib20/tools-light/VMware_locker_tools-light_10.3.10.12406962-14141615.vib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>4、重启服务器</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> esxi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(四)</title>
      <link href="/posts/fc022412.html"/>
      <url>/posts/fc022412.html</url>
      
        <content type="html"><![CDATA[<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a><font size=5><strong>变量</strong></font></h2><p>变量的意义和 赋值符号 =, ‘把列表复制给变量A’<br>命名要有意义, 用简洁的英文单词表示一个变量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> A <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token comment"># 没有意义</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">>></span><span class="token operator">></span> skill <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'新月打击'</span><span class="token punctuation">]</span>   <span class="token comment"># 技能为新月打击, 可以让读者快速的 读懂变量的意义</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>skill<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'新月打击'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="变量基本规范"><a href="#变量基本规范" class="headerlink" title="变量基本规范"></a><font size=4><strong>变量基本规范</strong></font></h3><p>1.变量名首字符不能是数字</p><p>2.变量名由 字母, 数字, 下划线 组成</p><p>3.系统的 保留关键字 不能在变量名中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token string">'False'</span><span class="token punctuation">,</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'True'</span><span class="token punctuation">,</span> <span class="token string">'and'</span><span class="token punctuation">,</span> <span class="token string">'as'</span><span class="token punctuation">,</span> <span class="token string">'assert'</span><span class="token punctuation">,</span> <span class="token string">'break'</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'continue'</span><span class="token punctuation">,</span> <span class="token string">'def'</span><span class="token punctuation">,</span> <span class="token string">'del'</span><span class="token punctuation">,</span> <span class="token string">'elif'</span><span class="token punctuation">,</span> <span class="token string">'else'</span><span class="token punctuation">,</span> <span class="token string">'except'</span><span class="token punctuation">,</span> <span class="token string">'finally'</span><span class="token punctuation">,</span> <span class="token string">'for'</span><span class="token punctuation">,</span> <span class="token string">'from'</span><span class="token punctuation">,</span> <span class="token string">'global'</span><span class="token punctuation">,</span> <span class="token string">'if'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'in'</span><span class="token punctuation">,</span> <span class="token string">'is'</span><span class="token punctuation">,</span> <span class="token string">'lambda'</span><span class="token punctuation">,</span> <span class="token string">'nonlocal'</span><span class="token punctuation">,</span> <span class="token string">'not'</span><span class="token punctuation">,</span> <span class="token string">'or'</span><span class="token punctuation">,</span> <span class="token string">'pass'</span><span class="token punctuation">,</span> <span class="token string">'raise'</span><span class="token punctuation">,</span> <span class="token string">'return'</span><span class="token punctuation">,</span> <span class="token string">'try'</span><span class="token punctuation">,</span> <span class="token string">'while'</span><span class="token punctuation">,</span> <span class="token string">'with'</span><span class="token punctuation">,</span> <span class="token string">'yield'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4.变量名区分大小写</p><p>5.变量本身是没有类型的, 可以是字符串str、元组tuple、列表list、集合set、数字int,float,tuple、布尔数bool、字典dict</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment"># type虽然不是保留字, 但是不建议用作变量名, 类似还有print</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>   File <span class="token string">"&lt;pyshell#34>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>TypeError<span class="token punctuation">:</span> <span class="token string">'int'</span> <span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token builtin">callable</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># typy(1)等同于1(1)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#35>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token number">1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>TypeError<span class="token punctuation">:</span> <span class="token string">'int'</span> <span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token builtin">callable</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment"># 如果后面的代码不使用type()方法进行调用, 只打印等操作是可以使用的。还是上面那句话 不建议使用。</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>作业:</strong> 思考下面的代码: </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a   <span class="token comment"># 将a列表赋值给b</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span>   <span class="token comment"># 把a列表的第1个元素替换为'a'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># a列表改变</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment"># b也会变, a列表赋值给b列表, a列表中元素改变, b中的也会变</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="int值类型-amp-list引用类型"><a href="#int值类型-amp-list引用类型" class="headerlink" title="int值类型 &amp; list引用类型"></a><font size=4><strong>int值类型 &amp; list引用类型</strong></font></h3><p><strong>区别:</strong> int是值类型, list是引用类型</p><p><font color=red><strong>int str tuple</strong></font>(<strong>不可改变</strong>), <font color=green><strong>list set dict</strong></font>(<strong>可变</strong>)</p><p>【复习: int整型 str字符串 tuple元组 list列表 set集合 dict字典 float浮点数 bool布尔数 [36j]complex复数, 序列字符串列表和元组】</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">'hello'</span>   <span class="token comment"># 把'hello'赋值给a</span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token string">'python'</span>   <span class="token comment"># 把'hello' + 'python'赋值给a</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>hellopython<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment"># 查看对象的内存地址</span><span class="token number">2563202155776</span><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token string">'python'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token number">2563199608560</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'python'</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token string">'p'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'python'</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span>   <span class="token comment"># 字符串不可改变, 不能对字符串的某个字符赋值</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#21>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token string">'python'</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span>TypeError<span class="token punctuation">:</span> <span class="token string">'str'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tuple和list区别"><a href="#tuple和list区别" class="headerlink" title="tuple和list区别"></a><font size=4><strong>tuple和list区别</strong></font></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment"># id()查看对象的内存地址</span><span class="token number">2563202131272</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># hex()十转十六进制, oct()十转八进制, bin()十转二进制 </span><span class="token string">'0x254cac0a548'</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token number">2563202131272</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tuple:</strong> 不可改变, list可以</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#32>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span>TypeError<span class="token punctuation">:</span> <span class="token string">'tuple'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>list</strong>列表可以增加, 元组tuple不可以。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment"># list列表可以增加, 元组tuple不可以。</span><span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span> append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">.</span> append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#37>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    c<span class="token punctuation">.</span> append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>AttributeError<span class="token punctuation">:</span> <span class="token string">'tuple'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'append'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="多维序列"><a href="#多维序列" class="headerlink" title="多维序列 "></a><font size=4><strong>多维序列</strong> </font></h3><p>二维和三维用的较多</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'tuple'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token number">6</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'list'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token number">7</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'tuple'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span>   <span class="token comment"># 注意改变的是列表不是元组。[4,5,(6,7)]是列表, 而元组(6,7)是列表的元素, 所以可变, 但是元组中的6, 7元素是不可变的。</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">6</span><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'b'</span>   <span class="token comment"># 元组中的6, 所以不可变</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#13>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'b'</span>TypeError<span class="token punctuation">:</span> <span class="token string">'tuple'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'c'</span>   <span class="token comment"># 元组a[3] = [4,5,(6,7)], 是元组的元素, 所以也不可变</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#14>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'c'</span>TypeError<span class="token punctuation">:</span> <span class="token string">'tuple'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 变量 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(三)</title>
      <link href="/posts/641cb1d.html"/>
      <url>/posts/641cb1d.html</url>
      
        <content type="html"><![CDATA[<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a><font size=5><strong>列表</strong></font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>   <span class="token comment"># 列表</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'list'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 列表中元素的类型可以是多种</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'list'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 嵌套列表(其他语言叫"二维数组")</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'list'</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以一个数字访问列表得到的是一个字符串, 以冒号的形式访问列表得到一个列表, 即使只有一个元素。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token string">'新月打击'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>   <span class="token comment"># 有冒号, 得到一个列表</span><span class="token punctuation">[</span><span class="token string">'月神冲刺'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment"># 数字得到在一个字符串</span><span class="token string">'月神冲刺'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>列表运算</strong>(列表+列表, 列表乘数字)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token string">"点燃"</span><span class="token punctuation">,</span><span class="token string">"闪现"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">,</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'点燃'</span><span class="token punctuation">,</span> <span class="token string">'闪现'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token string">"月神冲刺"</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">[</span><span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>分组:</strong> 4个小组, 每组4个小队(一共16个小队)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"A[1,2,3,4]"</span><span class="token punctuation">,</span><span class="token string">"B[5,6,7,8]"</span><span class="token punctuation">,</span><span class="token string">"C[9,10,11,12]"</span><span class="token punctuation">,</span><span class="token string">"D[13,14,15,16]"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'A[1,2,3,4]'</span><span class="token punctuation">,</span> <span class="token string">'B[5,6,7,8]'</span><span class="token punctuation">,</span> <span class="token string">'C[9,10,11,12]'</span><span class="token punctuation">,</span> <span class="token string">'D[13,14,15,16]'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="元组"><a href="#元组" class="headerlink" title="元组"></a><font size=5><strong>元组</strong></font></h2><p>基础参考列表</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"-2"</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'-2'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'tuple'</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编程里面的一个约定俗成的习惯: int整形(int类型), str字符串(str类型), list列表(list类型), tuple元组(tuple类型)音标[tʌpl]</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 当type()中 只有一个元素的元组 是会默认进行运算的</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># 如数学运算中, ()是运算符, 优先级高</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># ,表示只有一个元素的元组。</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'tuple'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># ()代表什么都没有的元组</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'tuple'</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结number大类型包含:<strong>int整型、float浮点型、bool布尔数。序列包含: str字符串、list列表、tuple元组</strong></p><h2 id="序列"><a href="#序列" class="headerlink" title="序列"></a><font size=5><strong>序列</strong></font></h2><ol><li><p>“序列”[num] 每一个序列的元素, 都有一个序号</p></li><li><p>切片, “xulie”[2:4] 称为切片操作。拓展: “xulie”[2:4:2]</p></li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 参考下面的结果'llo wo'共取6个字符, 取其中[1,3,5]即, 'low', 理解为'步长'。左舍2至左取8按步长为2取字符, 即前面切片截取的字符串, 再以步长为2取1,3,5,7...</span><span class="token string">'low'</span>   <span class="token comment"># 这里步长2是从1开始数</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>   <span class="token comment"># 正正, 从左取8, 左舍2</span><span class="token string">'llo wo'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token string">'l '</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>   <span class="token comment"># 切片截取后步长取字符为1,4,7,10...上面取了'l'和'空格'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3.序列可以 加<font color=red>+</font>和乘<font color=red>*</font></p><p><strong>拓展:</strong> 逻辑运算符(两个变量间的逻辑关系)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">3</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token comment">#3 是否在这个序列中, 返回值为bool类型</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token comment"># 0是否 不在这个序列中</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">5</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4.判断序列中有多少个元素、最大最小值</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># len()函数 求序列的元素个数</span><span class="token number">5</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># max()函数 求元素的最大值</span><span class="token number">7</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># min()函数 求元素的最小值</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token string">"hello "</span><span class="token punctuation">)</span>   <span class="token comment"># 字符也有排序, 下面验证顺序应该为: '空格'0-9a-z'汉字'</span><span class="token string">' '</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token string">"abcxyz"</span><span class="token punctuation">)</span><span class="token string">'a'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token string">"abcxyz09"</span><span class="token punctuation">)</span><span class="token string">'0'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token string">"abcxyz0 9"</span><span class="token punctuation">)</span><span class="token string">' '</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token string">"abcxyz0 9哈"</span><span class="token punctuation">)</span><span class="token string">'哈'</span><span class="token comment"># 排序按ascll码排序</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>   <span class="token comment"># ord()查看字符的ascll码</span><span class="token number">48</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token number">32</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token number">97</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'哈'</span><span class="token punctuation">)</span><span class="token number">21704</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a><font size=5><strong>集合</strong></font></h2><p>集合: set, 特点: 无序, 不能切片</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'set'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token comment"># 不能取字符</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#66>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>TypeError<span class="token punctuation">:</span> <span class="token string">'set'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support indexing<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#67>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>TypeError<span class="token punctuation">:</span> <span class="token string">'set'</span> <span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> subscriptable<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 重复压缩</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>集合操作: 长度判断, 逻辑运算</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>集合优势: 剔除集合中的元素(求两个集合的差集)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token operator">-</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token operator">-</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>集合的交集</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>集合的合集(并集)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token operator">|</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>集合为空</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># set()表示空集</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'set'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 验证集合元素是否为0, 0即为空</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   <span class="token comment"># dict类型, 不是set类型</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a><font size=5><strong>字典</strong></font></h2><p>字典: dict, 类比汉语字典拼音查汉字</p><p>对于字典来说有Key和Value , Key代表关键字, Value代表值</p><p>字典可以有很多个key和value, 用set集合表示, 而不是序列</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>key1<span class="token punctuation">:</span>value1<span class="token punctuation">,</span>key2<span class="token punctuation">:</span>value2<span class="token punctuation">,</span>key3<span class="token punctuation">:</span>value3<span class="token punctuation">&#125;</span>   <span class="token comment"># 字典定义 key:value</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string">'Q'</span><span class="token punctuation">]</span>   <span class="token comment"># 字典取值</span><span class="token string">'新月打击'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string">'Q'</span><span class="token punctuation">]</span>   <span class="token comment"># 不能有重复的key</span><span class="token string">'苍白之瀑'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 验证重复key</span><span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 验证key值可以是字符串和数字 '' 和 "" 均表示字符串</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token string">'新月打击'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span><span class="token string">'苍白之瀑'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">]</span><span class="token string">'月之降临'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>   <span class="token comment"># 验证''和""均表示字符串, 而且字符串必须是被引号引起来的无所谓是单引号还是双引号</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>key必须是不可变的类型, (int, str都是不可变的类型)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"E"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>   <span class="token comment"># key可以是元组</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">:</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"E"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>   <span class="token comment"># key不可以为列表</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;pyshell#96>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"E"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">&#125;</span>TypeError<span class="token punctuation">:</span> unhashable <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token string">'list'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>value可以是任何类型</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span><span class="token string">"新月打击"</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">:</span><span class="token string">"苍白之瀑"</span><span class="token punctuation">,</span><span class="token string">"E"</span><span class="token punctuation">:</span><span class="token string">"月之降临"</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">:</span><span class="token string">"月神冲刺"</span><span class="token punctuation">,</span><span class="token string">'DF'</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span><span class="token string">'点燃'</span><span class="token punctuation">,</span><span class="token string">'闪现'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token string">'Q'</span><span class="token punctuation">:</span> <span class="token string">'新月打击'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">:</span> <span class="token string">'苍白之瀑'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token string">'月之降临'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'月神冲刺'</span><span class="token punctuation">,</span> <span class="token string">'DF'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'点燃'</span><span class="token punctuation">,</span> <span class="token string">'闪现'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>空的字典: 以下均可以{},{ },set()</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'dict'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>思维导图</strong>: </p><p><img src="/medias/img/python3/0.jpg" alt="Python基本数据类型.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 组的概念 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python学习笔记(二)</title>
      <link href="/posts/78b2eb36.html"/>
      <url>/posts/78b2eb36.html</url>
      
        <content type="html"><![CDATA[<h2 id="什么是代码？"><a href="#什么是代码？" class="headerlink" title="什么是代码？"></a><font size=5><strong>什么是代码</strong>？</font></h2><p>代码是现实世界事物在计算机世界中的映射</p><h2 id="什么是写代码？"><a href="#什么是写代码？" class="headerlink" title="什么是写代码？"></a><font size=5><strong>什么是写代码</strong>？</font></h2><p>写代码是将现实世界中的事物用计算机语言来描述</p><h2 id="python的基本数据类型"><a href="#python的基本数据类型" class="headerlink" title="python的基本数据类型: "></a><font size=5><strong>python的基本数据类型</strong>: </font></h2><p>**number:**数字(大分类 包含整数、小数)</p><p>**整数:**int</p><p>**小数, 浮点数:**float就是双精度</p><p>**其它语言:**单精度float, 双精度double</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">#type查看对象数据类型查询方法</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'float'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1.444444</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'float'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'float'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">#除法</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'float'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">#整除</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0b10</span>  <span class="token comment">#0b二进制</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0b11</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0o10</span>   <span class="token comment">#0o八进制</span><span class="token number">8</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0o11</span><span class="token number">9</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0x10</span>   <span class="token comment">#0x十六进制</span><span class="token number">16</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0x11</span><span class="token number">17</span><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0x1F</span><span class="token number">31</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>   <span class="token comment">#bin可以将任意进制转换成二进制</span><span class="token string">'0b1010'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token number">0o6</span><span class="token punctuation">)</span><span class="token string">'0b110'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token number">0xA</span><span class="token punctuation">)</span><span class="token string">'0b1010'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0o65</span><span class="token punctuation">)</span>   <span class="token comment">#int将任意进制转换成十进制</span><span class="token number">53</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0x7A</span><span class="token punctuation">)</span><span class="token number">122</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">88</span><span class="token punctuation">)</span>   <span class="token comment">#hex将任意进制转换成十六进制</span><span class="token string">'0x58'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">0o23</span><span class="token punctuation">)</span><span class="token string">'0x13'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">oct</span><span class="token punctuation">(</span><span class="token number">0b110</span><span class="token punctuation">)</span>   <span class="token comment">#oct将任意进制转换成八进制</span><span class="token string">'0o6'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">oct</span><span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">)</span><span class="token string">'0o210'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>bool布尔数/值:</strong> 真True、假False</p><p><strong>complex复数:</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">True</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token boolean">False</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'bool'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">#布尔值非零即为真。bool(1.1),bool(-3),bool(0o110)都是真</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">#非空即为真。(None是False)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token string">'acb'</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>复数</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">36j</span><span class="token number">36j</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a><font size=5><strong>符号</strong></font></h2><p><strong>引号</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'hello world'</span><span class="token string">'hello world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token string">'hello world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'1'</span><span class="token string">'1'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'str'</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"let's go"</span>   <span class="token comment">#引号表示字符串的时候要成对出现, 不能有中文字符</span><span class="token string">"let's go"</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'let\'s go'</span>   <span class="token comment">#"\"转义字符</span><span class="token string">"let's go"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>换行</strong>(三引号 ‘’’ 换行, \n 换行, \ 换行)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token triple-quoted-string string">'''hellohaha'''</span><span class="token string">'\nhello\nhaha\n'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello\nhaha'</span><span class="token punctuation">)</span>hellohaha<span class="token operator">>></span><span class="token operator">></span> 'haha\xixi'<span class="token string">'hahaxixi'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>转义字符:</strong> 特殊的字符(表示无法”看见”的字符、与语言本身语法有冲突的字符)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">\n   <span class="token comment"># 换行</span>\<span class="token string">'   # 单引号, 表示与python语法有冲突的字符, 参考: '</span>let\<span class="token string">'s go'</span>\t   <span class="token comment"># 横向制表符</span>\r   <span class="token comment"># 回车</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello \\n world'</span><span class="token punctuation">)</span>   <span class="token comment"># 将hello \n world输出出来</span>hello \n world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>应用:</strong> 打印一个路径但是包含\n,\r等相邻的字符, 就变成了特殊字符</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'c:\nortwind\nortwest'</span><span class="token punctuation">)</span>c<span class="token punctuation">:</span>ortwindortwest<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'c:\\nortwind\\nortwest'</span><span class="token punctuation">)</span>c<span class="token punctuation">:</span>\nortwind\nortwest<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">r'c:\nortwind\nortwest'</span><span class="token punctuation">)</span>   <span class="token comment"># r 表示这个字符串不是一个普通字符串, 而是一个原始字符串。及所见即所得。</span>c<span class="token punctuation">:</span>\nortwind\nortwest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>错误</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">r'let'</span>s go'<span class="token punctuation">)</span>   <span class="token comment"># 引号没有成对出现😉</span>SyntaxError<span class="token punctuation">:</span> invalid syntax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a><font size=5><strong>字符串</strong></font></h2><p><strong>字符串操作:</strong> hello world合并与拆分</p><p><strong>字符串运算:</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello"</span> <span class="token operator">+</span> <span class="token string">"world"</span>    <span class="token string">'helloworld'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello"</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token string">'hellohellohello'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token string">'h'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token string">'l'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token string">'d'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token string">'o'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取”hello world“中w字符, 两种方法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token string">'w'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token string">'w'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>截取字符(切片操作)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token string">'hell'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token comment"># 这里截取前5个字符</span><span class="token string">'hello'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># 复数, 代表步长, 从前数0个从后数1个, 截取中间的。</span><span class="token string">'hello wor'</span>   <span class="token comment"># 左边舍弃0个, 右边舍弃1个。</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token string">'lo wo'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>截取world, 用两种方式</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>   <span class="token comment"># 成功, 取6-10</span><span class="token string">'world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span>   <span class="token comment"># 成功, 解释: 右舍0要忽略0, 因为0代表了第一个数</span><span class="token string">'world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span>   <span class="token comment"># 测试左舍0, 忽略0, 成功</span><span class="token string">'hello'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token string">'hello'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 解释, 套路上面的解释, 左舍-4右不舍(右取4至右不舍)</span><span class="token string">'world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 左舍-4, 右舍2(右取4至右舍2)</span><span class="token string">'wo'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token comment"># 与上面拗口的做对比</span><span class="token string">'ll'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 解释, 套路上面的解释, 左舍-4右不舍(右取4至右不舍)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 左舍-4, 右舍2(右取4至右舍2)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token comment"># 左不舍至右舍4</span><span class="token string">'hello '</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>   <span class="token comment"># 左舍4至右不舍</span><span class="token string">'o world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>   <span class="token comment"># 左舍-4 == 右取4(右取4至右不舍)</span><span class="token string">'world'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token comment"># 右为正数(左不舍至左取4)</span><span class="token string">'hell'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>理解:</strong></p><p>[2:4]: 左右为正数, 看右, 从左 数4个字符, 舍弃前2个</p><p>[-4:-2]: 左右为负数, 看左, 从右 数4个字符, 舍弃后边的2个</p><p>[2:-4]: 正负数, 左舍2右舍4</p><p>[;]: 右/左为空, 代表空的方向是不舍弃</p><p><strong>实例:</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token string">'o'</span><span class="token operator">>></span><span class="token operator">></span> <span class="token string">"hello world"</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token string">'w'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 基本数据类型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python学习笔记(一)</title>
      <link href="/posts/d5667ccc.html"/>
      <url>/posts/d5667ccc.html</url>
      
        <content type="html"><![CDATA[<h2 id="python特点"><a href="#python特点" class="headerlink" title="python特点"></a><font size=5><strong>python特点</strong></font></h2><p>Python特点, 简洁, 很Python  Pythonic<br>细致与进阶<br>python是一种编程语言。他是众多编程语言的一种。<br>语法简介优雅, 编写的程序容易阅读</p><h2 id="导语"><a href="#导语" class="headerlink" title="导语"></a><font size=5><strong>导语</strong></font></h2><p>跨平台, Windows、Linux、macOS<br>易于学习, 非计算机专业学习python比C++, Java, javascript语言简单<br>极为强大而丰富的标准库与第三方库, 比如电子邮件, 图形GUI<br>python是面向对象的语言(把现实的形形色色的事物映射到计算机世界里)</p><h2 id="为什么喜欢python"><a href="#为什么喜欢python" class="headerlink" title="为什么喜欢python"></a><font size=5><strong>为什么喜欢python</strong></font></h2><h3 id="1-简洁-灵活-优雅-哲学"><a href="#1-简洁-灵活-优雅-哲学" class="headerlink" title="1, 简洁, 灵活, 优雅, 哲学"></a><font size=4>1, 简洁, 灵活, 优雅, 哲学</font></h3><p><strong>(python之禅)</strong></p><p>simple is better than complex</p><p>简洁胜于复杂</p><p>now is better than never。although never is often better than <em>right</em> now</p><p>做也许好过不做, 但不假思索就动手还不如不做</p><h3 id="2-易于上手难于精通"><a href="#2-易于上手难于精通" class="headerlink" title="2, 易于上手难于精通"></a><font size=4>2, 易于上手难于精通</font></h3><h3 id="3-python既有动态脚本的特性-又有面向对象的特性-非常具有自己的特点"><a href="#3-python既有动态脚本的特性-又有面向对象的特性-非常具有自己的特点" class="headerlink" title="3, python既有动态脚本的特性, 又有面向对象的特性, 非常具有自己的特点"></a><font size=4>3, python既有动态脚本的特性, 又有面向对象的特性, 非常具有自己的特点</font></h3><h2 id="python的缺点"><a href="#python的缺点" class="headerlink" title="python的缺点"></a><font size=5><strong>python的缺点</strong></font></h2><p><strong>慢</strong>(相较于C、C++、Java, 运行效率慢)</p><p>主流语言两大类: 编译型语言C、C++, 解释型语言JavaScript、python</p><p>编译型语言: 执行程序之前将源代码编译成机器码(机器码更接近于底层)</p><p>解释型语言: 每次执行程序, 都会解释源码使其变成机器码</p><p>运行效率与开发效率, 鱼与熊掌不可兼得</p><p>语言适合的才是最好的</p><p>例如开发web如果选择汇编和C开发效率很慢</p><p>但是运行程序快慢和开发快慢是没有必然关系的。python运行起来用户是感觉不到慢的。</p><h2 id="python能做什么？"><a href="#python能做什么？" class="headerlink" title="python能做什么？"></a><font size=5><strong>python能做什么</strong>？</font></h2><p><strong>(几乎是万能的)</strong></p><p>1.爬虫</p><p>2.大数据与数据分析(spark)</p><p>3.自动化运维与自动化测试</p><p>4.web开发: flask、django</p><p>5.机器学习: tensor flow(python是入门级语言)</p><p>6.胶水语言: 混合C++、Java等来编程。能够把其他语言制作的各种模块很轻松地联接在一起</p><p>当你遇到问题时, 随手拿起python, 编写一个工具, 这才是python正确的打开方式。</p><p>基础语法: 基础语法是任何语言的基础, 只有熟练掌握才能灵活运用语言, 写出高效、优美、简洁的代码。</p><h2 id="pythonic"><a href="#pythonic" class="headerlink" title="pythonic: "></a><font size=5><strong>pythonic</strong>: </font></h2><p><strong>问题: a、b两个变量值交换</strong></p><p>C语言风格: </p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> t <span class="token operator">=</span> a <span class="token punctuation">;</span>a <span class="token operator">=</span> b <span class="token punctuation">;</span>b <span class="token operator">=</span> t <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>python中: </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>这就是pythonic.</strong></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python2min </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python数据分析学习</title>
      <link href="/posts/fb40c079.html"/>
      <url>/posts/fb40c079.html</url>
      
        <content type="html"><![CDATA[<h2 id="造数据"><a href="#造数据" class="headerlink" title="造数据 "></a><font size=5><strong>造数据</strong> </font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># @Time     : 2019/12/11 9:39</span><span class="token comment"># @Author   : wangjun</span><span class="token comment"># @Mail     : 158970251@qq.com</span><span class="token comment"># @File     : name.py</span><span class="token comment"># @Software : PyCharm</span><span class="token comment"># _*_ coding: utf-8 _*_</span><span class="token keyword">import</span> randomlistf <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'王'</span><span class="token punctuation">,</span> <span class="token string">'李'</span><span class="token punctuation">,</span> <span class="token string">'张'</span><span class="token punctuation">,</span> <span class="token string">'刘'</span><span class="token punctuation">,</span> <span class="token string">'陈'</span><span class="token punctuation">,</span> <span class="token string">'杨'</span><span class="token punctuation">,</span> <span class="token string">'黄'</span><span class="token punctuation">,</span> <span class="token string">'赵'</span><span class="token punctuation">,</span> <span class="token string">'吴'</span><span class="token punctuation">,</span> <span class="token string">'周'</span><span class="token punctuation">,</span> <span class="token string">'徐'</span><span class="token punctuation">,</span> <span class="token string">'孙'</span><span class="token punctuation">,</span> <span class="token string">'马'</span><span class="token punctuation">,</span> <span class="token string">'朱'</span><span class="token punctuation">,</span> <span class="token string">'胡'</span><span class="token punctuation">,</span> <span class="token string">'郭'</span><span class="token punctuation">,</span> <span class="token string">'何'</span><span class="token punctuation">,</span> <span class="token string">'高'</span><span class="token punctuation">,</span> <span class="token string">'林'</span><span class="token punctuation">,</span> <span class="token string">'罗'</span><span class="token punctuation">,</span>    <span class="token string">'郑'</span><span class="token punctuation">,</span> <span class="token string">'梁'</span><span class="token punctuation">,</span> <span class="token string">'谢'</span><span class="token punctuation">,</span> <span class="token string">'宋'</span><span class="token punctuation">,</span> <span class="token string">'唐'</span><span class="token punctuation">,</span> <span class="token string">'许'</span><span class="token punctuation">,</span> <span class="token string">'韩'</span><span class="token punctuation">,</span> <span class="token string">'冯'</span><span class="token punctuation">,</span> <span class="token string">'邓'</span><span class="token punctuation">,</span> <span class="token string">'曹'</span><span class="token punctuation">,</span> <span class="token string">'彭'</span><span class="token punctuation">,</span> <span class="token string">'曾'</span><span class="token punctuation">,</span> <span class="token string">'肖'</span><span class="token punctuation">,</span> <span class="token string">'田'</span><span class="token punctuation">,</span> <span class="token string">'董'</span><span class="token punctuation">,</span> <span class="token string">'袁'</span><span class="token punctuation">,</span> <span class="token string">'潘'</span><span class="token punctuation">,</span> <span class="token string">'于'</span><span class="token punctuation">,</span> <span class="token string">'蒋'</span><span class="token punctuation">,</span> <span class="token string">'蔡'</span><span class="token punctuation">,</span>    <span class="token string">'余'</span><span class="token punctuation">,</span> <span class="token string">'杜'</span><span class="token punctuation">,</span> <span class="token string">'叶'</span><span class="token punctuation">,</span> <span class="token string">'程'</span><span class="token punctuation">,</span> <span class="token string">'苏'</span><span class="token punctuation">,</span> <span class="token string">'魏'</span><span class="token punctuation">,</span> <span class="token string">'吕'</span><span class="token punctuation">,</span> <span class="token string">'丁'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'沈'</span><span class="token punctuation">,</span> <span class="token string">'姚'</span><span class="token punctuation">,</span> <span class="token string">'卢'</span><span class="token punctuation">,</span> <span class="token string">'姜'</span><span class="token punctuation">,</span> <span class="token string">'崔'</span><span class="token punctuation">,</span> <span class="token string">'钟'</span><span class="token punctuation">,</span> <span class="token string">'谭'</span><span class="token punctuation">,</span> <span class="token string">'陆'</span><span class="token punctuation">,</span> <span class="token string">'汪'</span><span class="token punctuation">,</span> <span class="token string">'范'</span><span class="token punctuation">,</span> <span class="token string">'金'</span><span class="token punctuation">,</span>    <span class="token string">'石'</span><span class="token punctuation">,</span> <span class="token string">'廖'</span><span class="token punctuation">,</span> <span class="token string">'贾'</span><span class="token punctuation">,</span> <span class="token string">'夏'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'付'</span><span class="token punctuation">,</span> <span class="token string">'方'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'邹'</span><span class="token punctuation">,</span> <span class="token string">'孟'</span><span class="token punctuation">,</span> <span class="token string">'熊'</span><span class="token punctuation">,</span> <span class="token string">'秦'</span><span class="token punctuation">,</span> <span class="token string">'邱'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">'尹'</span><span class="token punctuation">,</span> <span class="token string">'薛'</span><span class="token punctuation">,</span> <span class="token string">'闫'</span><span class="token punctuation">,</span> <span class="token string">'段'</span><span class="token punctuation">,</span> <span class="token string">'雷'</span><span class="token punctuation">,</span> <span class="token string">'侯'</span><span class="token punctuation">,</span>    <span class="token string">'龙'</span><span class="token punctuation">,</span> <span class="token string">'史'</span><span class="token punctuation">,</span> <span class="token string">'陶'</span><span class="token punctuation">,</span> <span class="token string">'黎'</span><span class="token punctuation">,</span> <span class="token string">'贺'</span><span class="token punctuation">,</span> <span class="token string">'顾'</span><span class="token punctuation">,</span> <span class="token string">'毛'</span><span class="token punctuation">,</span> <span class="token string">'郝'</span><span class="token punctuation">,</span> <span class="token string">'龚'</span><span class="token punctuation">,</span> <span class="token string">'邵'</span><span class="token punctuation">,</span> <span class="token string">'万'</span><span class="token punctuation">,</span> <span class="token string">'钱'</span><span class="token punctuation">,</span> <span class="token string">'严'</span><span class="token punctuation">,</span> <span class="token string">'覃'</span><span class="token punctuation">,</span> <span class="token string">'武'</span><span class="token punctuation">,</span> <span class="token string">'戴'</span><span class="token punctuation">,</span> <span class="token string">'莫'</span><span class="token punctuation">,</span> <span class="token string">'孔'</span><span class="token punctuation">,</span> <span class="token string">'向'</span><span class="token punctuation">,</span> <span class="token string">'汤'</span><span class="token punctuation">]</span>listm <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'兰'</span><span class="token punctuation">,</span> <span class="token string">'旺'</span><span class="token punctuation">,</span> <span class="token string">'瑶'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'晴'</span><span class="token punctuation">,</span> <span class="token string">'镇'</span><span class="token punctuation">,</span> <span class="token string">'乔'</span><span class="token punctuation">,</span> <span class="token string">'欣'</span><span class="token punctuation">,</span> <span class="token string">'昆'</span><span class="token punctuation">,</span> <span class="token string">'泰'</span><span class="token punctuation">,</span> <span class="token string">'筱'</span><span class="token punctuation">,</span> <span class="token string">'秉'</span><span class="token punctuation">,</span> <span class="token string">'曜'</span><span class="token punctuation">,</span> <span class="token string">'忠'</span><span class="token punctuation">,</span> <span class="token string">'真'</span><span class="token punctuation">,</span> <span class="token string">'凯'</span><span class="token punctuation">,</span> <span class="token string">'雯'</span><span class="token punctuation">,</span> <span class="token string">'懿'</span><span class="token punctuation">,</span> <span class="token string">'崇'</span><span class="token punctuation">,</span> <span class="token string">'成'</span><span class="token punctuation">,</span> <span class="token string">'顺'</span><span class="token punctuation">,</span> <span class="token string">'博'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'孟'</span><span class="token punctuation">,</span> <span class="token string">'琦'</span><span class="token punctuation">,</span> <span class="token string">'兆'</span><span class="token punctuation">,</span> <span class="token string">'佑'</span><span class="token punctuation">,</span> <span class="token string">'健'</span><span class="token punctuation">,</span> <span class="token string">'金'</span><span class="token punctuation">,</span> <span class="token string">'宥'</span><span class="token punctuation">,</span> <span class="token string">'贵'</span><span class="token punctuation">,</span> <span class="token string">'盛'</span><span class="token punctuation">,</span> <span class="token string">'元'</span><span class="token punctuation">,</span> <span class="token string">'珍'</span><span class="token punctuation">,</span> <span class="token string">'辰'</span><span class="token punctuation">,</span> <span class="token string">'初'</span><span class="token punctuation">,</span> <span class="token string">'慈'</span><span class="token punctuation">,</span> <span class="token string">'勇'</span><span class="token punctuation">,</span> <span class="token string">'仲'</span><span class="token punctuation">,</span> <span class="token string">'思'</span><span class="token punctuation">,</span> <span class="token string">'雪'</span><span class="token punctuation">,</span> <span class="token string">'右'</span><span class="token punctuation">,</span> <span class="token string">'琼'</span><span class="token punctuation">,</span> <span class="token string">'华'</span><span class="token punctuation">,</span> <span class="token string">'其'</span><span class="token punctuation">,</span>    <span class="token string">'火'</span><span class="token punctuation">,</span> <span class="token string">'彦'</span><span class="token punctuation">,</span> <span class="token string">'安'</span><span class="token punctuation">,</span> <span class="token string">'婷'</span><span class="token punctuation">,</span> <span class="token string">'曼'</span><span class="token punctuation">,</span> <span class="token string">'予'</span><span class="token punctuation">,</span> <span class="token string">'湖'</span><span class="token punctuation">,</span> <span class="token string">'绍'</span><span class="token punctuation">,</span> <span class="token string">'伊'</span><span class="token punctuation">,</span> <span class="token string">'以'</span><span class="token punctuation">,</span> <span class="token string">'宝'</span><span class="token punctuation">,</span> <span class="token string">'育'</span><span class="token punctuation">,</span> <span class="token string">'夙'</span><span class="token punctuation">,</span> <span class="token string">'富'</span><span class="token punctuation">,</span> <span class="token string">'武'</span><span class="token punctuation">,</span> <span class="token string">'品'</span><span class="token punctuation">,</span> <span class="token string">'玉'</span><span class="token punctuation">,</span> <span class="token string">'馨'</span><span class="token punctuation">,</span> <span class="token string">'家'</span><span class="token punctuation">,</span> <span class="token string">'山'</span><span class="token punctuation">,</span> <span class="token string">'美'</span><span class="token punctuation">,</span> <span class="token string">'一'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'常'</span><span class="token punctuation">,</span> <span class="token string">'扬'</span><span class="token punctuation">,</span> <span class="token string">'诚'</span><span class="token punctuation">,</span> <span class="token string">'士'</span><span class="token punctuation">,</span> <span class="token string">'姿'</span><span class="token punctuation">,</span> <span class="token string">'力'</span><span class="token punctuation">,</span> <span class="token string">'耀'</span><span class="token punctuation">,</span> <span class="token string">'竣'</span><span class="token punctuation">,</span> <span class="token string">'允'</span><span class="token punctuation">,</span> <span class="token string">'筠'</span><span class="token punctuation">,</span> <span class="token string">'瑜'</span><span class="token punctuation">,</span> <span class="token string">'舜'</span><span class="token punctuation">,</span> <span class="token string">'昌'</span><span class="token punctuation">,</span> <span class="token string">'冰'</span><span class="token punctuation">,</span> <span class="token string">'行'</span><span class="token punctuation">,</span> <span class="token string">'晓'</span><span class="token punctuation">,</span> <span class="token string">'轩'</span><span class="token punctuation">,</span> <span class="token string">'义'</span><span class="token punctuation">,</span> <span class="token string">'纬'</span><span class="token punctuation">,</span> <span class="token string">'淑'</span><span class="token punctuation">,</span> <span class="token string">'荣'</span><span class="token punctuation">,</span> <span class="token string">'海'</span><span class="token punctuation">,</span>    <span class="token string">'呈'</span><span class="token punctuation">,</span> <span class="token string">'素'</span><span class="token punctuation">,</span> <span class="token string">'之'</span><span class="token punctuation">,</span> <span class="token string">'碧'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'峻'</span><span class="token punctuation">,</span> <span class="token string">'晏'</span><span class="token punctuation">,</span> <span class="token string">'胜'</span><span class="token punctuation">,</span> <span class="token string">'裕'</span><span class="token punctuation">,</span> <span class="token string">'惠'</span><span class="token punctuation">,</span> <span class="token string">'子'</span><span class="token punctuation">,</span> <span class="token string">'昭'</span><span class="token punctuation">,</span> <span class="token string">'骏'</span><span class="token punctuation">,</span> <span class="token string">'芳'</span><span class="token punctuation">,</span> <span class="token string">'凡'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'恭'</span><span class="token punctuation">,</span> <span class="token string">'弘'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'兴'</span><span class="token punctuation">,</span> <span class="token string">'坚'</span><span class="token punctuation">,</span> <span class="token string">'紫'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'婉'</span><span class="token punctuation">,</span> <span class="token string">'芝'</span><span class="token punctuation">,</span> <span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'孝'</span><span class="token punctuation">,</span> <span class="token string">'翊'</span><span class="token punctuation">,</span> <span class="token string">'乐'</span><span class="token punctuation">,</span> <span class="token string">'如'</span><span class="token punctuation">,</span> <span class="token string">'姵'</span><span class="token punctuation">,</span> <span class="token string">'珮'</span><span class="token punctuation">,</span> <span class="token string">'智'</span><span class="token punctuation">,</span> <span class="token string">'惟'</span><span class="token punctuation">,</span> <span class="token string">'添'</span><span class="token punctuation">,</span> <span class="token string">'旻'</span><span class="token punctuation">,</span> <span class="token string">'宁'</span><span class="token punctuation">,</span> <span class="token string">'东'</span><span class="token punctuation">,</span> <span class="token string">'淳'</span><span class="token punctuation">,</span> <span class="token string">'柏'</span><span class="token punctuation">,</span> <span class="token string">'沛'</span><span class="token punctuation">,</span> <span class="token string">'合'</span><span class="token punctuation">,</span> <span class="token string">'国'</span><span class="token punctuation">,</span> <span class="token string">'宣'</span><span class="token punctuation">,</span> <span class="token string">'益'</span><span class="token punctuation">,</span>    <span class="token string">'伯'</span><span class="token punctuation">,</span> <span class="token string">'长'</span><span class="token punctuation">,</span> <span class="token string">'于'</span><span class="token punctuation">,</span> <span class="token string">'平'</span><span class="token punctuation">,</span> <span class="token string">'绿'</span><span class="token punctuation">,</span> <span class="token string">'维'</span><span class="token punctuation">,</span> <span class="token string">'舒'</span><span class="token punctuation">,</span> <span class="token string">'妤'</span><span class="token punctuation">,</span> <span class="token string">'南'</span><span class="token punctuation">,</span> <span class="token string">'昱'</span><span class="token punctuation">,</span> <span class="token string">'宇'</span><span class="token punctuation">,</span> <span class="token string">'岳'</span><span class="token punctuation">,</span> <span class="token string">'恩'</span><span class="token punctuation">,</span> <span class="token string">'礼'</span><span class="token punctuation">,</span> <span class="token string">'群'</span><span class="token punctuation">,</span> <span class="token string">'佩'</span><span class="token punctuation">,</span> <span class="token string">'军'</span><span class="token punctuation">,</span> <span class="token string">'璇'</span><span class="token punctuation">,</span> <span class="token string">'文'</span><span class="token punctuation">,</span> <span class="token string">'咏'</span><span class="token punctuation">,</span> <span class="token string">'介'</span><span class="token punctuation">,</span> <span class="token string">'喜'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'毅'</span><span class="token punctuation">,</span> <span class="token string">'君'</span><span class="token punctuation">,</span> <span class="token string">'劭'</span><span class="token punctuation">,</span> <span class="token string">'嘉'</span><span class="token punctuation">,</span> <span class="token string">'肇'</span><span class="token punctuation">,</span> <span class="token string">'法'</span><span class="token punctuation">,</span> <span class="token string">'逸'</span><span class="token punctuation">,</span> <span class="token string">'治'</span><span class="token punctuation">,</span> <span class="token string">'万'</span><span class="token punctuation">,</span> <span class="token string">'松'</span><span class="token punctuation">,</span> <span class="token string">'水'</span><span class="token punctuation">,</span> <span class="token string">'浩'</span><span class="token punctuation">,</span> <span class="token string">'莹'</span><span class="token punctuation">,</span> <span class="token string">'景'</span><span class="token punctuation">,</span> <span class="token string">'茂'</span><span class="token punctuation">,</span> <span class="token string">'绮'</span><span class="token punctuation">,</span> <span class="token string">'蓉'</span><span class="token punctuation">,</span> <span class="token string">'薇'</span><span class="token punctuation">,</span> <span class="token string">'郁'</span><span class="token punctuation">,</span> <span class="token string">'俞'</span><span class="token punctuation">,</span> <span class="token string">'和'</span><span class="token punctuation">,</span> <span class="token string">'坤'</span><span class="token punctuation">,</span>    <span class="token string">'毓'</span><span class="token punctuation">,</span> <span class="token string">'均'</span><span class="token punctuation">,</span> <span class="token string">'梦'</span><span class="token punctuation">,</span> <span class="token string">'培'</span><span class="token punctuation">,</span> <span class="token string">'与'</span><span class="token punctuation">,</span> <span class="token string">'廷'</span><span class="token punctuation">,</span> <span class="token string">'乃'</span><span class="token punctuation">,</span> <span class="token string">'勋'</span><span class="token punctuation">,</span> <span class="token string">'登'</span><span class="token punctuation">,</span> <span class="token string">'爱'</span><span class="token punctuation">,</span> <span class="token string">'梅'</span><span class="token punctuation">,</span> <span class="token string">'千'</span><span class="token punctuation">,</span> <span class="token string">'书'</span><span class="token punctuation">,</span> <span class="token string">'欢'</span><span class="token punctuation">,</span> <span class="token string">'琇'</span><span class="token punctuation">,</span> <span class="token string">'念'</span><span class="token punctuation">,</span> <span class="token string">'玟'</span><span class="token punctuation">,</span> <span class="token string">'秋'</span><span class="token punctuation">,</span> <span class="token string">'颖'</span><span class="token punctuation">,</span> <span class="token string">'得'</span><span class="token punctuation">,</span> <span class="token string">'星'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'容'</span><span class="token punctuation">,</span> <span class="token string">'映'</span><span class="token punctuation">,</span> <span class="token string">'德'</span><span class="token punctuation">,</span> <span class="token string">'怡'</span><span class="token punctuation">,</span> <span class="token string">'茹'</span><span class="token punctuation">,</span> <span class="token string">'仪'</span><span class="token punctuation">,</span> <span class="token string">'儒'</span><span class="token punctuation">,</span> <span class="token string">'杰'</span><span class="token punctuation">,</span> <span class="token string">'哲'</span><span class="token punctuation">,</span> <span class="token string">'汉'</span><span class="token punctuation">,</span> <span class="token string">'刚'</span><span class="token punctuation">,</span> <span class="token string">'娇'</span><span class="token punctuation">,</span> <span class="token string">'修'</span><span class="token punctuation">,</span> <span class="token string">'旭'</span><span class="token punctuation">,</span> <span class="token string">'桂'</span><span class="token punctuation">,</span> <span class="token string">'雨'</span><span class="token punctuation">,</span> <span class="token string">'仕'</span><span class="token punctuation">,</span> <span class="token string">'莉'</span><span class="token punctuation">,</span> <span class="token string">'克'</span><span class="token punctuation">,</span> <span class="token string">'佳'</span><span class="token punctuation">,</span> <span class="token string">'珊'</span><span class="token punctuation">,</span> <span class="token string">'阿'</span><span class="token punctuation">,</span>    <span class="token string">'秀'</span><span class="token punctuation">,</span> <span class="token string">'尚'</span><span class="token punctuation">,</span> <span class="token string">'尧'</span><span class="token punctuation">,</span> <span class="token string">'晋'</span><span class="token punctuation">,</span> <span class="token string">'湘'</span><span class="token punctuation">,</span> <span class="token string">'俐'</span><span class="token punctuation">,</span> <span class="token string">'春'</span><span class="token punctuation">,</span> <span class="token string">'虹'</span><span class="token punctuation">,</span> <span class="token string">'瑞'</span><span class="token punctuation">,</span> <span class="token string">'百'</span><span class="token punctuation">,</span> <span class="token string">'琳'</span><span class="token punctuation">,</span> <span class="token string">'语'</span><span class="token punctuation">,</span> <span class="token string">'阳'</span><span class="token punctuation">,</span> <span class="token string">'木'</span><span class="token punctuation">,</span> <span class="token string">'建'</span><span class="token punctuation">,</span> <span class="token string">'丰'</span><span class="token punctuation">,</span> <span class="token string">'琪'</span><span class="token punctuation">,</span> <span class="token string">'财'</span><span class="token punctuation">,</span> <span class="token string">'英'</span><span class="token punctuation">,</span> <span class="token string">'慧'</span><span class="token punctuation">,</span> <span class="token string">'靖'</span><span class="token punctuation">,</span> <span class="token string">'菁'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'若'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'原'</span><span class="token punctuation">,</span> <span class="token string">'婕'</span><span class="token punctuation">,</span> <span class="token string">'意'</span><span class="token punctuation">,</span> <span class="token string">'展'</span><span class="token punctuation">,</span> <span class="token string">'巧'</span><span class="token punctuation">,</span> <span class="token string">'人'</span><span class="token punctuation">,</span> <span class="token string">'吟'</span><span class="token punctuation">,</span> <span class="token string">'竹'</span><span class="token punctuation">,</span> <span class="token string">'重'</span><span class="token punctuation">,</span> <span class="token string">'鸿'</span><span class="token punctuation">,</span> <span class="token string">'敬'</span><span class="token punctuation">,</span> <span class="token string">'依'</span><span class="token punctuation">,</span> <span class="token string">'进'</span><span class="token punctuation">,</span> <span class="token string">'台'</span><span class="token punctuation">,</span> <span class="token string">'左'</span><span class="token punctuation">,</span> <span class="token string">'亦'</span><span class="token punctuation">,</span> <span class="token string">'韵'</span><span class="token punctuation">,</span> <span class="token string">'钰'</span><span class="token punctuation">,</span> <span class="token string">'新'</span><span class="token punctuation">,</span> <span class="token string">'羽'</span><span class="token punctuation">,</span>    <span class="token string">'静'</span><span class="token punctuation">,</span> <span class="token string">'名'</span><span class="token punctuation">,</span> <span class="token string">'中'</span><span class="token punctuation">,</span> <span class="token string">'仁'</span><span class="token punctuation">,</span> <span class="token string">'采'</span><span class="token punctuation">,</span> <span class="token string">'亭'</span><span class="token punctuation">,</span> <span class="token string">'妙'</span><span class="token punctuation">,</span> <span class="token string">'希'</span><span class="token punctuation">,</span> <span class="token string">'必'</span><span class="token punctuation">,</span> <span class="token string">'承'</span><span class="token punctuation">,</span> <span class="token string">'豪'</span><span class="token punctuation">,</span> <span class="token string">'吉'</span><span class="token punctuation">,</span> <span class="token string">'芷'</span><span class="token punctuation">,</span> <span class="token string">'上'</span><span class="token punctuation">,</span> <span class="token string">'石'</span><span class="token punctuation">,</span> <span class="token string">'冠'</span><span class="token punctuation">,</span> <span class="token string">'威'</span><span class="token punctuation">,</span> <span class="token string">'又'</span><span class="token punctuation">,</span> <span class="token string">'辛'</span><span class="token punctuation">,</span> <span class="token string">'奕'</span><span class="token punctuation">,</span> <span class="token string">'雅'</span><span class="token punctuation">,</span> <span class="token string">'泓'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'伶'</span><span class="token punctuation">,</span> <span class="token string">'玫'</span><span class="token punctuation">,</span> <span class="token string">'定'</span><span class="token punctuation">,</span> <span class="token string">'世'</span><span class="token punctuation">,</span> <span class="token string">'皓'</span><span class="token punctuation">,</span> <span class="token string">'协'</span><span class="token punctuation">,</span> <span class="token string">'芸'</span><span class="token punctuation">,</span> <span class="token string">'政'</span><span class="token punctuation">,</span> <span class="token string">'洁'</span><span class="token punctuation">,</span> <span class="token string">'祥'</span><span class="token punctuation">,</span> <span class="token string">'清'</span><span class="token punctuation">,</span> <span class="token string">'光'</span><span class="token punctuation">,</span> <span class="token string">'贞'</span><span class="token punctuation">,</span> <span class="token string">'翠'</span><span class="token punctuation">,</span> <span class="token string">'纯'</span><span class="token punctuation">,</span> <span class="token string">'伟'</span><span class="token punctuation">,</span> <span class="token string">'振'</span><span class="token punctuation">,</span> <span class="token string">'庭'</span><span class="token punctuation">,</span> <span class="token string">'易'</span><span class="token punctuation">,</span> <span class="token string">'香'</span><span class="token punctuation">,</span> <span class="token string">'永'</span><span class="token punctuation">,</span> <span class="token string">'皇'</span><span class="token punctuation">,</span>    <span class="token string">'茜'</span><span class="token punctuation">,</span> <span class="token string">'良'</span><span class="token punctuation">,</span> <span class="token string">'敏'</span><span class="token punctuation">,</span> <span class="token string">'燕'</span><span class="token punctuation">,</span> <span class="token string">'俊'</span><span class="token punctuation">,</span> <span class="token string">'月'</span><span class="token punctuation">,</span> <span class="token string">'民'</span><span class="token punctuation">,</span> <span class="token string">'隆'</span><span class="token punctuation">,</span> <span class="token string">'侑'</span><span class="token punctuation">,</span> <span class="token string">'诗'</span><span class="token punctuation">,</span> <span class="token string">'心'</span><span class="token punctuation">,</span> <span class="token string">'友'</span><span class="token punctuation">,</span> <span class="token string">'致'</span><span class="token punctuation">,</span> <span class="token string">'贤'</span><span class="token punctuation">,</span> <span class="token string">'宛'</span><span class="token punctuation">,</span> <span class="token string">'奇'</span><span class="token punctuation">,</span> <span class="token string">'玲'</span><span class="token punctuation">,</span> <span class="token string">'志'</span><span class="token punctuation">,</span> <span class="token string">'宪'</span><span class="token punctuation">,</span> <span class="token string">'启'</span><span class="token punctuation">,</span> <span class="token string">'亚'</span><span class="token punctuation">,</span> <span class="token string">'盈'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'睿'</span><span class="token punctuation">,</span> <span class="token string">'涵'</span><span class="token punctuation">,</span> <span class="token string">'柔'</span><span class="token punctuation">,</span> <span class="token string">'萱'</span><span class="token punctuation">,</span> <span class="token string">'昀'</span><span class="token punctuation">,</span> <span class="token string">'伦'</span><span class="token punctuation">,</span> <span class="token string">'升'</span><span class="token punctuation">,</span> <span class="token string">'季'</span><span class="token punctuation">,</span> <span class="token string">'玮'</span><span class="token punctuation">,</span> <span class="token string">'凤'</span><span class="token punctuation">,</span> <span class="token string">'善'</span><span class="token punctuation">,</span> <span class="token string">'云'</span><span class="token punctuation">,</span> <span class="token string">'祯'</span><span class="token punctuation">,</span> <span class="token string">'幸'</span><span class="token punctuation">,</span> <span class="token string">'宏'</span><span class="token punctuation">,</span> <span class="token string">'可'</span><span class="token punctuation">,</span> <span class="token string">'信'</span><span class="token punctuation">,</span> <span class="token string">'天'</span><span class="token punctuation">,</span> <span class="token string">'宗'</span><span class="token punctuation">,</span> <span class="token string">'宜'</span><span class="token punctuation">,</span> <span class="token string">'忆'</span><span class="token punctuation">,</span> <span class="token string">'康'</span><span class="token punctuation">,</span>    <span class="token string">'翰'</span><span class="token punctuation">,</span> <span class="token string">'正'</span><span class="token punctuation">,</span> <span class="token string">'丽'</span><span class="token punctuation">,</span> <span class="token string">'翔'</span><span class="token punctuation">,</span> <span class="token string">'少'</span><span class="token punctuation">,</span> <span class="token string">'朝'</span><span class="token punctuation">,</span> <span class="token string">'倩'</span><span class="token punctuation">,</span> <span class="token string">'圣'</span><span class="token punctuation">,</span> <span class="token string">'钧'</span><span class="token punctuation">,</span> <span class="token string">'琬'</span><span class="token punctuation">,</span> <span class="token string">'铭'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'幼'</span><span class="token punctuation">,</span> <span class="token string">'立'</span><span class="token punctuation">,</span> <span class="token string">'蕙'</span><span class="token punctuation">,</span> <span class="token string">'青'</span><span class="token punctuation">,</span> <span class="token string">'枝'</span><span class="token punctuation">,</span> <span class="token string">'庆'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">]</span>listl <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'盛'</span><span class="token punctuation">,</span> <span class="token string">'斌'</span><span class="token punctuation">,</span> <span class="token string">'铃'</span><span class="token punctuation">,</span> <span class="token string">'峰'</span><span class="token punctuation">,</span> <span class="token string">'志'</span><span class="token punctuation">,</span> <span class="token string">'原'</span><span class="token punctuation">,</span> <span class="token string">'莲'</span><span class="token punctuation">,</span> <span class="token string">'扬'</span><span class="token punctuation">,</span> <span class="token string">'全'</span><span class="token punctuation">,</span> <span class="token string">'茂'</span><span class="token punctuation">,</span> <span class="token string">'辰'</span><span class="token punctuation">,</span> <span class="token string">'彰'</span><span class="token punctuation">,</span> <span class="token string">'臻'</span><span class="token punctuation">,</span> <span class="token string">'竹'</span><span class="token punctuation">,</span> <span class="token string">'翰'</span><span class="token punctuation">,</span> <span class="token string">'静'</span><span class="token punctuation">,</span> <span class="token string">'妹'</span><span class="token punctuation">,</span> <span class="token string">'霖'</span><span class="token punctuation">,</span> <span class="token string">'添'</span><span class="token punctuation">,</span> <span class="token string">'吟'</span><span class="token punctuation">,</span> <span class="token string">'廷'</span><span class="token punctuation">,</span> <span class="token string">'正'</span><span class="token punctuation">,</span>    <span class="token string">'奇'</span><span class="token punctuation">,</span> <span class="token string">'平'</span><span class="token punctuation">,</span> <span class="token string">'安'</span><span class="token punctuation">,</span> <span class="token string">'柔'</span><span class="token punctuation">,</span> <span class="token string">'毓'</span><span class="token punctuation">,</span> <span class="token string">'贵'</span><span class="token punctuation">,</span> <span class="token string">'宪'</span><span class="token punctuation">,</span> <span class="token string">'怡'</span><span class="token punctuation">,</span> <span class="token string">'秋'</span><span class="token punctuation">,</span> <span class="token string">'茜'</span><span class="token punctuation">,</span> <span class="token string">'和'</span><span class="token punctuation">,</span> <span class="token string">'玉'</span><span class="token punctuation">,</span> <span class="token string">'泉'</span><span class="token punctuation">,</span> <span class="token string">'珍'</span><span class="token punctuation">,</span> <span class="token string">'季'</span><span class="token punctuation">,</span> <span class="token string">'娇'</span><span class="token punctuation">,</span> <span class="token string">'盈'</span><span class="token punctuation">,</span> <span class="token string">'蓉'</span><span class="token punctuation">,</span> <span class="token string">'仪'</span><span class="token punctuation">,</span> <span class="token string">'群'</span><span class="token punctuation">,</span> <span class="token string">'升'</span><span class="token punctuation">,</span> <span class="token string">'忠'</span><span class="token punctuation">,</span>    <span class="token string">'慧'</span><span class="token punctuation">,</span> <span class="token string">'睿'</span><span class="token punctuation">,</span> <span class="token string">'军'</span><span class="token punctuation">,</span> <span class="token string">'友'</span><span class="token punctuation">,</span> <span class="token string">'威'</span><span class="token punctuation">,</span> <span class="token string">'云'</span><span class="token punctuation">,</span> <span class="token string">'玲'</span><span class="token punctuation">,</span> <span class="token string">'康'</span><span class="token punctuation">,</span> <span class="token string">'彬'</span><span class="token punctuation">,</span> <span class="token string">'雅'</span><span class="token punctuation">,</span> <span class="token string">'勋'</span><span class="token punctuation">,</span> <span class="token string">'丰'</span><span class="token punctuation">,</span> <span class="token string">'帆'</span><span class="token punctuation">,</span> <span class="token string">'君'</span><span class="token punctuation">,</span> <span class="token string">'琴'</span><span class="token punctuation">,</span> <span class="token string">'毅'</span><span class="token punctuation">,</span> <span class="token string">'玫'</span><span class="token punctuation">,</span> <span class="token string">'璇'</span><span class="token punctuation">,</span> <span class="token string">'淑'</span><span class="token punctuation">,</span> <span class="token string">'秀'</span><span class="token punctuation">,</span> <span class="token string">'琦'</span><span class="token punctuation">,</span> <span class="token string">'玮'</span><span class="token punctuation">,</span>    <span class="token string">'媛'</span><span class="token punctuation">,</span> <span class="token string">'逸'</span><span class="token punctuation">,</span> <span class="token string">'博'</span><span class="token punctuation">,</span> <span class="token string">'筑'</span><span class="token punctuation">,</span> <span class="token string">'维'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'均'</span><span class="token punctuation">,</span> <span class="token string">'昌'</span><span class="token punctuation">,</span> <span class="token string">'欣'</span><span class="token punctuation">,</span> <span class="token string">'合'</span><span class="token punctuation">,</span> <span class="token string">'强'</span><span class="token punctuation">,</span> <span class="token string">'法'</span><span class="token punctuation">,</span> <span class="token string">'冰'</span><span class="token punctuation">,</span> <span class="token string">'其'</span><span class="token punctuation">,</span> <span class="token string">'昀'</span><span class="token punctuation">,</span> <span class="token string">'心'</span><span class="token punctuation">,</span> <span class="token string">'惠'</span><span class="token punctuation">,</span> <span class="token string">'甄'</span><span class="token punctuation">,</span> <span class="token string">'薇'</span><span class="token punctuation">,</span> <span class="token string">'旺'</span><span class="token punctuation">,</span> <span class="token string">'纬'</span><span class="token punctuation">,</span> <span class="token string">'南'</span><span class="token punctuation">,</span>    <span class="token string">'辛'</span><span class="token punctuation">,</span> <span class="token string">'伯'</span><span class="token punctuation">,</span> <span class="token string">'凤'</span><span class="token punctuation">,</span> <span class="token string">'祥'</span><span class="token punctuation">,</span> <span class="token string">'倩'</span><span class="token punctuation">,</span> <span class="token string">'舜'</span><span class="token punctuation">,</span> <span class="token string">'菱'</span><span class="token punctuation">,</span> <span class="token string">'英'</span><span class="token punctuation">,</span> <span class="token string">'美'</span><span class="token punctuation">,</span> <span class="token string">'虹'</span><span class="token punctuation">,</span> <span class="token string">'松'</span><span class="token punctuation">,</span> <span class="token string">'星'</span><span class="token punctuation">,</span> <span class="token string">'辉'</span><span class="token punctuation">,</span> <span class="token string">'元'</span><span class="token punctuation">,</span> <span class="token string">'圣'</span><span class="token punctuation">,</span> <span class="token string">'隆'</span><span class="token punctuation">,</span> <span class="token string">'龙'</span><span class="token punctuation">,</span> <span class="token string">'花'</span><span class="token punctuation">,</span> <span class="token string">'苹'</span><span class="token punctuation">,</span> <span class="token string">'筠'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'纶'</span><span class="token punctuation">,</span>    <span class="token string">'岚'</span><span class="token punctuation">,</span> <span class="token string">'妃'</span><span class="token punctuation">,</span> <span class="token string">'昆'</span><span class="token punctuation">,</span> <span class="token string">'贤'</span><span class="token punctuation">,</span> <span class="token string">'生'</span><span class="token punctuation">,</span> <span class="token string">'瑄'</span><span class="token punctuation">,</span> <span class="token string">'谦'</span><span class="token punctuation">,</span> <span class="token string">'兴'</span><span class="token punctuation">,</span> <span class="token string">'伟'</span><span class="token punctuation">,</span> <span class="token string">'宝'</span><span class="token punctuation">,</span> <span class="token string">'沛'</span><span class="token punctuation">,</span> <span class="token string">'馨'</span><span class="token punctuation">,</span> <span class="token string">'珮'</span><span class="token punctuation">,</span> <span class="token string">'蓁'</span><span class="token punctuation">,</span> <span class="token string">'蕙'</span><span class="token punctuation">,</span> <span class="token string">'钰'</span><span class="token punctuation">,</span> <span class="token string">'杰'</span><span class="token punctuation">,</span> <span class="token string">'劭'</span><span class="token punctuation">,</span> <span class="token string">'旭'</span><span class="token punctuation">,</span> <span class="token string">'宏'</span><span class="token punctuation">,</span> <span class="token string">'庭'</span><span class="token punctuation">,</span> <span class="token string">'坤'</span><span class="token punctuation">,</span>    <span class="token string">'轩'</span><span class="token punctuation">,</span> <span class="token string">'修'</span><span class="token punctuation">,</span> <span class="token string">'芸'</span><span class="token punctuation">,</span> <span class="token string">'佳'</span><span class="token punctuation">,</span> <span class="token string">'月'</span><span class="token punctuation">,</span> <span class="token string">'桦'</span><span class="token punctuation">,</span> <span class="token string">'来'</span><span class="token punctuation">,</span> <span class="token string">'霞'</span><span class="token punctuation">,</span> <span class="token string">'孜'</span><span class="token punctuation">,</span> <span class="token string">'乐'</span><span class="token punctuation">,</span> <span class="token string">'达'</span><span class="token punctuation">,</span> <span class="token string">'敏'</span><span class="token punctuation">,</span> <span class="token string">'善'</span><span class="token punctuation">,</span> <span class="token string">'亦'</span><span class="token punctuation">,</span> <span class="token string">'超'</span><span class="token punctuation">,</span> <span class="token string">'钧'</span><span class="token punctuation">,</span> <span class="token string">'天'</span><span class="token punctuation">,</span> <span class="token string">'羽'</span><span class="token punctuation">,</span> <span class="token string">'刚'</span><span class="token punctuation">,</span> <span class="token string">'绿'</span><span class="token punctuation">,</span> <span class="token string">'爱'</span><span class="token punctuation">,</span> <span class="token string">'纯'</span><span class="token punctuation">,</span>    <span class="token string">'侑'</span><span class="token punctuation">,</span> <span class="token string">'士'</span><span class="token punctuation">,</span> <span class="token string">'名'</span><span class="token punctuation">,</span> <span class="token string">'雯'</span><span class="token punctuation">,</span> <span class="token string">'义'</span><span class="token punctuation">,</span> <span class="token string">'亚'</span><span class="token punctuation">,</span> <span class="token string">'琬'</span><span class="token punctuation">,</span> <span class="token string">'芷'</span><span class="token punctuation">,</span> <span class="token string">'尧'</span><span class="token punctuation">,</span> <span class="token string">'伦'</span><span class="token punctuation">,</span> <span class="token string">'新'</span><span class="token punctuation">,</span> <span class="token string">'乔'</span><span class="token punctuation">,</span> <span class="token string">'雄'</span><span class="token punctuation">,</span> <span class="token string">'洁'</span><span class="token punctuation">,</span> <span class="token string">'幸'</span><span class="token punctuation">,</span> <span class="token string">'娥'</span><span class="token punctuation">,</span> <span class="token string">'恩'</span><span class="token punctuation">,</span> <span class="token string">'玟'</span><span class="token punctuation">,</span> <span class="token string">'书'</span><span class="token punctuation">,</span> <span class="token string">'惟'</span><span class="token punctuation">,</span> <span class="token string">'泰'</span><span class="token punctuation">,</span> <span class="token string">'瑜'</span><span class="token punctuation">,</span>    <span class="token string">'珊'</span><span class="token punctuation">,</span> <span class="token string">'远'</span><span class="token punctuation">,</span> <span class="token string">'晴'</span><span class="token punctuation">,</span> <span class="token string">'彦'</span><span class="token punctuation">,</span> <span class="token string">'哲'</span><span class="token punctuation">,</span> <span class="token string">'瑞'</span><span class="token punctuation">,</span> <span class="token string">'琇'</span><span class="token punctuation">,</span> <span class="token string">'智'</span><span class="token punctuation">,</span> <span class="token string">'映'</span><span class="token punctuation">,</span> <span class="token string">'珠'</span><span class="token punctuation">,</span> <span class="token string">'鸿'</span><span class="token punctuation">,</span> <span class="token string">'梦'</span><span class="token punctuation">,</span> <span class="token string">'燕'</span><span class="token punctuation">,</span> <span class="token string">'人'</span><span class="token punctuation">,</span> <span class="token string">'春'</span><span class="token punctuation">,</span> <span class="token string">'儒'</span><span class="token punctuation">,</span> <span class="token string">'卿'</span><span class="token punctuation">,</span> <span class="token string">'佩'</span><span class="token punctuation">,</span> <span class="token string">'祯'</span><span class="token punctuation">,</span> <span class="token string">'良'</span><span class="token punctuation">,</span> <span class="token string">'清'</span><span class="token punctuation">,</span> <span class="token string">'欢'</span><span class="token punctuation">,</span>    <span class="token string">'中'</span><span class="token punctuation">,</span> <span class="token string">'麟'</span><span class="token punctuation">,</span> <span class="token string">'骏'</span><span class="token punctuation">,</span> <span class="token string">'岳'</span><span class="token punctuation">,</span> <span class="token string">'财'</span><span class="token punctuation">,</span> <span class="token string">'芳'</span><span class="token punctuation">,</span> <span class="token string">'诚'</span><span class="token punctuation">,</span> <span class="token string">'文'</span><span class="token punctuation">,</span> <span class="token string">'真'</span><span class="token punctuation">,</span> <span class="token string">'柏'</span><span class="token punctuation">,</span> <span class="token string">'湖'</span><span class="token punctuation">,</span> <span class="token string">'菁'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token string">'一'</span><span class="token punctuation">,</span> <span class="token string">'佑'</span><span class="token punctuation">,</span> <span class="token string">'颖'</span><span class="token punctuation">,</span> <span class="token string">'阳'</span><span class="token punctuation">,</span> <span class="token string">'水'</span><span class="token punctuation">,</span> <span class="token string">'枝'</span><span class="token punctuation">,</span> <span class="token string">'茹'</span><span class="token punctuation">,</span> <span class="token string">'德'</span><span class="token punctuation">,</span> <span class="token string">'豪'</span><span class="token punctuation">,</span>    <span class="token string">'谕'</span><span class="token punctuation">,</span> <span class="token string">'华'</span><span class="token punctuation">,</span> <span class="token string">'裕'</span><span class="token punctuation">,</span> <span class="token string">'山'</span><span class="token punctuation">,</span> <span class="token string">'孝'</span><span class="token punctuation">,</span> <span class="token string">'依'</span><span class="token punctuation">,</span> <span class="token string">'木'</span><span class="token punctuation">,</span> <span class="token string">'宣'</span><span class="token punctuation">,</span> <span class="token string">'涵'</span><span class="token punctuation">,</span> <span class="token string">'凯'</span><span class="token punctuation">,</span> <span class="token string">'源'</span><span class="token punctuation">,</span> <span class="token string">'韵'</span><span class="token punctuation">,</span> <span class="token string">'成'</span><span class="token punctuation">,</span> <span class="token string">'育'</span><span class="token punctuation">,</span> <span class="token string">'喜'</span><span class="token punctuation">,</span> <span class="token string">'宁'</span><span class="token punctuation">,</span> <span class="token string">'郁'</span><span class="token punctuation">,</span> <span class="token string">'仁'</span><span class="token punctuation">,</span> <span class="token string">'仲'</span><span class="token punctuation">,</span> <span class="token string">'希'</span><span class="token punctuation">,</span> <span class="token string">'芬'</span><span class="token punctuation">,</span> <span class="token string">'雨'</span><span class="token punctuation">,</span>    <span class="token string">'瑶'</span><span class="token punctuation">,</span> <span class="token string">'翔'</span><span class="token punctuation">,</span> <span class="token string">'火'</span><span class="token punctuation">,</span> <span class="token string">'铭'</span><span class="token punctuation">,</span> <span class="token string">'芝'</span><span class="token punctuation">,</span> <span class="token string">'东'</span><span class="token punctuation">,</span> <span class="token string">'定'</span><span class="token punctuation">,</span> <span class="token string">'璋'</span><span class="token punctuation">,</span> <span class="token string">'意'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">'靖'</span><span class="token punctuation">,</span> <span class="token string">'民'</span><span class="token punctuation">,</span> <span class="token string">'易'</span><span class="token punctuation">,</span> <span class="token string">'如'</span><span class="token punctuation">,</span> <span class="token string">'淳'</span><span class="token punctuation">,</span> <span class="token string">'光'</span><span class="token punctuation">,</span> <span class="token string">'发'</span><span class="token punctuation">,</span> <span class="token string">'启'</span><span class="token punctuation">,</span> <span class="token string">'俐'</span><span class="token punctuation">,</span> <span class="token string">'俊'</span><span class="token punctuation">,</span> <span class="token string">'礼'</span><span class="token punctuation">,</span> <span class="token string">'齐'</span><span class="token punctuation">,</span>    <span class="token string">'庆'</span><span class="token punctuation">,</span> <span class="token string">'谚'</span><span class="token punctuation">,</span> <span class="token string">'香'</span><span class="token punctuation">,</span> <span class="token string">'富'</span><span class="token punctuation">,</span> <span class="token string">'妤'</span><span class="token punctuation">,</span> <span class="token string">'宜'</span><span class="token punctuation">,</span> <span class="token string">'弘'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'汉'</span><span class="token punctuation">,</span> <span class="token string">'政'</span><span class="token punctuation">,</span> <span class="token string">'以'</span><span class="token punctuation">,</span> <span class="token string">'伶'</span><span class="token punctuation">,</span> <span class="token string">'勇'</span><span class="token punctuation">,</span> <span class="token string">'绮'</span><span class="token punctuation">,</span> <span class="token string">'凡'</span><span class="token punctuation">,</span> <span class="token string">'吉'</span><span class="token punctuation">,</span> <span class="token string">'梅'</span><span class="token punctuation">,</span> <span class="token string">'慈'</span><span class="token punctuation">,</span> <span class="token string">'容'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'荣'</span><span class="token punctuation">,</span> <span class="token string">'萍'</span><span class="token punctuation">,</span>    <span class="token string">'贞'</span><span class="token punctuation">,</span> <span class="token string">'娟'</span><span class="token punctuation">,</span> <span class="token string">'信'</span><span class="token punctuation">,</span> <span class="token string">'青'</span><span class="token punctuation">,</span> <span class="token string">'皓'</span><span class="token punctuation">,</span> <span class="token string">'雪'</span><span class="token punctuation">,</span> <span class="token string">'治'</span><span class="token punctuation">,</span> <span class="token string">'琳'</span><span class="token punctuation">,</span> <span class="token string">'紫'</span><span class="token punctuation">,</span> <span class="token string">'兰'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'婷'</span><span class="token punctuation">,</span> <span class="token string">'莹'</span><span class="token punctuation">,</span> <span class="token string">'嘉'</span><span class="token punctuation">,</span> <span class="token string">'恭'</span><span class="token punctuation">,</span> <span class="token string">'萱'</span><span class="token punctuation">,</span> <span class="token string">'顺'</span><span class="token punctuation">,</span> <span class="token string">'行'</span><span class="token punctuation">,</span> <span class="token string">'琪'</span><span class="token punctuation">,</span> <span class="token string">'念'</span><span class="token punctuation">,</span> <span class="token string">'宇'</span><span class="token punctuation">,</span> <span class="token string">'海'</span><span class="token punctuation">,</span>    <span class="token string">'坚'</span><span class="token punctuation">,</span> <span class="token string">'福'</span><span class="token punctuation">,</span> <span class="token string">'绍'</span><span class="token punctuation">,</span> <span class="token string">'桂'</span><span class="token punctuation">]</span><span class="token comment"># 生成10000个人名</span><span class="token keyword">for</span> WJ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment"># for WJ in range(1, 10001):</span>    <span class="token comment"># 名字格式</span>    name <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listf<span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listm<span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listl<span class="token punctuation">)</span>    <span class="token comment"># 打开文件,(a+)追加内容</span>    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'file.txt'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span>    <span class="token comment"># 写入格式</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token comment"># 关闭文件</span>    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析 "></a><font size=5><strong>数据分析</strong> </font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># _*_ coding: utf-8 _*_</span><span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> matplotlib<span class="token keyword">from</span> time <span class="token keyword">import</span> <span class="token operator">*</span>time1 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 设置图片字体</span>matplotlib<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.family'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'SimHei'</span><span class="token comment"># 打开文件,(r)读取内容</span>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'D:/PyCharm/1211/file.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token comment"># 将读取的内容存入变量</span><span class="token builtin">str</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 格式化成字典</span>b <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>Counter<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 显示重复次数超过50的人名</span><span class="token comment"># print(&#123;key:value for key,value in b.items()if value > 50&#125;) </span><span class="token comment"># 整理排序,(reverse=True)按从大到小排序</span>res <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> b<span class="token punctuation">:</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># 取前十</span>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 格式化打印格式</span><span class="token comment"># df2 = pd.DataFrame(&#123;"名字": df[0], "次数": df[1]&#125;)</span><span class="token comment"># 打印名字和重复次数</span><span class="token comment"># print(df2)</span><span class="token comment"># x,y轴的内容,以列表的形式赋值</span>x <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>y <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># x,y轴的坐标系名称字体的大小的设定</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'名字'</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'重复次数'</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token comment"># 设置x,y轴的条形图信息,宽度,颜色等</span>plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token string">'orange'</span><span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">)</span><span class="token comment"># 传值,把x,y列表的'值'导入到坐标系</span><span class="token keyword">for</span> a<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token operator">+</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token string">'%.0f'</span> <span class="token operator">%</span> b<span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">'bottom'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment"># 生成的图片信息</span>file_name <span class="token operator">=</span> <span class="token string">"重名次数统计图.jpg"</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"重名次数统计图"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>time2 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>time3 <span class="token operator">=</span> time2 <span class="token operator">-</span> time1<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'该循环程序运行时间: '</span><span class="token punctuation">,</span> time3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看图片"><a href="#查看图片" class="headerlink" title="查看图片 "></a><font size=5><strong>查看图片</strong> </font></h2><p><img src="/medias/img/python0/0.jpg" alt="重名次数统计图.jpg"></p><h2 id="创建数据库和表"><a href="#创建数据库和表" class="headerlink" title="创建数据库和表 "></a><font size=5><strong>创建数据库和表</strong> </font></h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># sql语句</span><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>school<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_bin'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>school<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>cclass<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>yuwen<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>shuxue<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>english<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>total<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据 "></a><font size=5><strong>导入数据</strong> </font></h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># @Time     : 2019/12/9 17:23</span><span class="token comment"># @Author   : wangjun</span><span class="token comment"># @Mail     : 158970251@qq.com</span><span class="token comment"># @File     : mysql.py</span><span class="token comment"># @Software : PyCharm</span><span class="token comment"># _*_ coding: utf-8 _*_</span><span class="token keyword">import</span> pymysql<span class="token keyword">import</span> random<span class="token keyword">from</span> time <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># 姓</span>listf <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'王'</span><span class="token punctuation">,</span> <span class="token string">'李'</span><span class="token punctuation">,</span> <span class="token string">'张'</span><span class="token punctuation">,</span> <span class="token string">'刘'</span><span class="token punctuation">,</span> <span class="token string">'陈'</span><span class="token punctuation">,</span> <span class="token string">'杨'</span><span class="token punctuation">,</span> <span class="token string">'黄'</span><span class="token punctuation">,</span> <span class="token string">'赵'</span><span class="token punctuation">,</span> <span class="token string">'吴'</span><span class="token punctuation">,</span> <span class="token string">'周'</span><span class="token punctuation">,</span> <span class="token string">'徐'</span><span class="token punctuation">,</span> <span class="token string">'孙'</span><span class="token punctuation">,</span> <span class="token string">'马'</span><span class="token punctuation">,</span> <span class="token string">'朱'</span><span class="token punctuation">,</span> <span class="token string">'胡'</span><span class="token punctuation">,</span> <span class="token string">'郭'</span><span class="token punctuation">,</span> <span class="token string">'何'</span><span class="token punctuation">,</span> <span class="token string">'高'</span><span class="token punctuation">,</span> <span class="token string">'林'</span><span class="token punctuation">,</span> <span class="token string">'罗'</span><span class="token punctuation">,</span>    <span class="token string">'郑'</span><span class="token punctuation">,</span> <span class="token string">'梁'</span><span class="token punctuation">,</span> <span class="token string">'谢'</span><span class="token punctuation">,</span> <span class="token string">'宋'</span><span class="token punctuation">,</span> <span class="token string">'唐'</span><span class="token punctuation">,</span> <span class="token string">'许'</span><span class="token punctuation">,</span> <span class="token string">'韩'</span><span class="token punctuation">,</span> <span class="token string">'冯'</span><span class="token punctuation">,</span> <span class="token string">'邓'</span><span class="token punctuation">,</span> <span class="token string">'曹'</span><span class="token punctuation">,</span> <span class="token string">'彭'</span><span class="token punctuation">,</span> <span class="token string">'曾'</span><span class="token punctuation">,</span> <span class="token string">'肖'</span><span class="token punctuation">,</span> <span class="token string">'田'</span><span class="token punctuation">,</span> <span class="token string">'董'</span><span class="token punctuation">,</span> <span class="token string">'袁'</span><span class="token punctuation">,</span> <span class="token string">'潘'</span><span class="token punctuation">,</span> <span class="token string">'于'</span><span class="token punctuation">,</span> <span class="token string">'蒋'</span><span class="token punctuation">,</span> <span class="token string">'蔡'</span><span class="token punctuation">,</span>    <span class="token string">'余'</span><span class="token punctuation">,</span> <span class="token string">'杜'</span><span class="token punctuation">,</span> <span class="token string">'叶'</span><span class="token punctuation">,</span> <span class="token string">'程'</span><span class="token punctuation">,</span> <span class="token string">'苏'</span><span class="token punctuation">,</span> <span class="token string">'魏'</span><span class="token punctuation">,</span> <span class="token string">'吕'</span><span class="token punctuation">,</span> <span class="token string">'丁'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'沈'</span><span class="token punctuation">,</span> <span class="token string">'姚'</span><span class="token punctuation">,</span> <span class="token string">'卢'</span><span class="token punctuation">,</span> <span class="token string">'姜'</span><span class="token punctuation">,</span> <span class="token string">'崔'</span><span class="token punctuation">,</span> <span class="token string">'钟'</span><span class="token punctuation">,</span> <span class="token string">'谭'</span><span class="token punctuation">,</span> <span class="token string">'陆'</span><span class="token punctuation">,</span> <span class="token string">'汪'</span><span class="token punctuation">,</span> <span class="token string">'范'</span><span class="token punctuation">,</span> <span class="token string">'金'</span><span class="token punctuation">,</span>    <span class="token string">'石'</span><span class="token punctuation">,</span> <span class="token string">'廖'</span><span class="token punctuation">,</span> <span class="token string">'贾'</span><span class="token punctuation">,</span> <span class="token string">'夏'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'付'</span><span class="token punctuation">,</span> <span class="token string">'方'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'邹'</span><span class="token punctuation">,</span> <span class="token string">'孟'</span><span class="token punctuation">,</span> <span class="token string">'熊'</span><span class="token punctuation">,</span> <span class="token string">'秦'</span><span class="token punctuation">,</span> <span class="token string">'邱'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">'尹'</span><span class="token punctuation">,</span> <span class="token string">'薛'</span><span class="token punctuation">,</span> <span class="token string">'闫'</span><span class="token punctuation">,</span> <span class="token string">'段'</span><span class="token punctuation">,</span> <span class="token string">'雷'</span><span class="token punctuation">,</span> <span class="token string">'侯'</span><span class="token punctuation">,</span>    <span class="token string">'龙'</span><span class="token punctuation">,</span> <span class="token string">'史'</span><span class="token punctuation">,</span> <span class="token string">'陶'</span><span class="token punctuation">,</span> <span class="token string">'黎'</span><span class="token punctuation">,</span> <span class="token string">'贺'</span><span class="token punctuation">,</span> <span class="token string">'顾'</span><span class="token punctuation">,</span> <span class="token string">'毛'</span><span class="token punctuation">,</span> <span class="token string">'郝'</span><span class="token punctuation">,</span> <span class="token string">'龚'</span><span class="token punctuation">,</span> <span class="token string">'邵'</span><span class="token punctuation">,</span> <span class="token string">'万'</span><span class="token punctuation">,</span> <span class="token string">'钱'</span><span class="token punctuation">,</span> <span class="token string">'严'</span><span class="token punctuation">,</span> <span class="token string">'覃'</span><span class="token punctuation">,</span> <span class="token string">'武'</span><span class="token punctuation">,</span> <span class="token string">'戴'</span><span class="token punctuation">,</span> <span class="token string">'莫'</span><span class="token punctuation">,</span> <span class="token string">'孔'</span><span class="token punctuation">,</span> <span class="token string">'向'</span><span class="token punctuation">,</span> <span class="token string">'汤'</span><span class="token punctuation">]</span><span class="token comment"># 中间穿插的''是为了生成两个字的名字</span>listm <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'兰'</span><span class="token punctuation">,</span> <span class="token string">'旺'</span><span class="token punctuation">,</span> <span class="token string">'瑶'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'晴'</span><span class="token punctuation">,</span> <span class="token string">'镇'</span><span class="token punctuation">,</span> <span class="token string">'乔'</span><span class="token punctuation">,</span> <span class="token string">'欣'</span><span class="token punctuation">,</span> <span class="token string">'昆'</span><span class="token punctuation">,</span> <span class="token string">'泰'</span><span class="token punctuation">,</span> <span class="token string">'筱'</span><span class="token punctuation">,</span> <span class="token string">'秉'</span><span class="token punctuation">,</span> <span class="token string">'曜'</span><span class="token punctuation">,</span> <span class="token string">'忠'</span><span class="token punctuation">,</span> <span class="token string">'真'</span><span class="token punctuation">,</span> <span class="token string">'凯'</span><span class="token punctuation">,</span> <span class="token string">'雯'</span><span class="token punctuation">,</span> <span class="token string">'懿'</span><span class="token punctuation">,</span> <span class="token string">'崇'</span><span class="token punctuation">,</span> <span class="token string">'成'</span><span class="token punctuation">,</span> <span class="token string">'顺'</span><span class="token punctuation">,</span> <span class="token string">'博'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'孟'</span><span class="token punctuation">,</span> <span class="token string">'琦'</span><span class="token punctuation">,</span> <span class="token string">'兆'</span><span class="token punctuation">,</span> <span class="token string">'佑'</span><span class="token punctuation">,</span> <span class="token string">'健'</span><span class="token punctuation">,</span> <span class="token string">'金'</span><span class="token punctuation">,</span> <span class="token string">'宥'</span><span class="token punctuation">,</span> <span class="token string">'贵'</span><span class="token punctuation">,</span> <span class="token string">'盛'</span><span class="token punctuation">,</span> <span class="token string">'元'</span><span class="token punctuation">,</span> <span class="token string">'珍'</span><span class="token punctuation">,</span> <span class="token string">'辰'</span><span class="token punctuation">,</span> <span class="token string">'初'</span><span class="token punctuation">,</span> <span class="token string">'慈'</span><span class="token punctuation">,</span> <span class="token string">'勇'</span><span class="token punctuation">,</span> <span class="token string">'仲'</span><span class="token punctuation">,</span> <span class="token string">'思'</span><span class="token punctuation">,</span> <span class="token string">'雪'</span><span class="token punctuation">,</span> <span class="token string">'右'</span><span class="token punctuation">,</span> <span class="token string">'琼'</span><span class="token punctuation">,</span> <span class="token string">'华'</span><span class="token punctuation">,</span> <span class="token string">'其'</span><span class="token punctuation">,</span>    <span class="token string">'火'</span><span class="token punctuation">,</span> <span class="token string">'彦'</span><span class="token punctuation">,</span> <span class="token string">'安'</span><span class="token punctuation">,</span> <span class="token string">'婷'</span><span class="token punctuation">,</span> <span class="token string">'曼'</span><span class="token punctuation">,</span> <span class="token string">'予'</span><span class="token punctuation">,</span> <span class="token string">'湖'</span><span class="token punctuation">,</span> <span class="token string">'绍'</span><span class="token punctuation">,</span> <span class="token string">'伊'</span><span class="token punctuation">,</span> <span class="token string">'以'</span><span class="token punctuation">,</span> <span class="token string">'宝'</span><span class="token punctuation">,</span> <span class="token string">'育'</span><span class="token punctuation">,</span> <span class="token string">'夙'</span><span class="token punctuation">,</span> <span class="token string">'富'</span><span class="token punctuation">,</span> <span class="token string">'武'</span><span class="token punctuation">,</span> <span class="token string">'品'</span><span class="token punctuation">,</span> <span class="token string">'玉'</span><span class="token punctuation">,</span> <span class="token string">'馨'</span><span class="token punctuation">,</span> <span class="token string">'家'</span><span class="token punctuation">,</span> <span class="token string">'山'</span><span class="token punctuation">,</span> <span class="token string">'美'</span><span class="token punctuation">,</span> <span class="token string">'一'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'常'</span><span class="token punctuation">,</span> <span class="token string">'扬'</span><span class="token punctuation">,</span> <span class="token string">'诚'</span><span class="token punctuation">,</span> <span class="token string">'士'</span><span class="token punctuation">,</span> <span class="token string">'姿'</span><span class="token punctuation">,</span> <span class="token string">'力'</span><span class="token punctuation">,</span> <span class="token string">'耀'</span><span class="token punctuation">,</span> <span class="token string">'竣'</span><span class="token punctuation">,</span> <span class="token string">'允'</span><span class="token punctuation">,</span> <span class="token string">'筠'</span><span class="token punctuation">,</span> <span class="token string">'瑜'</span><span class="token punctuation">,</span> <span class="token string">'舜'</span><span class="token punctuation">,</span> <span class="token string">'昌'</span><span class="token punctuation">,</span> <span class="token string">'冰'</span><span class="token punctuation">,</span> <span class="token string">'行'</span><span class="token punctuation">,</span> <span class="token string">'晓'</span><span class="token punctuation">,</span> <span class="token string">'轩'</span><span class="token punctuation">,</span> <span class="token string">'义'</span><span class="token punctuation">,</span> <span class="token string">'纬'</span><span class="token punctuation">,</span> <span class="token string">'淑'</span><span class="token punctuation">,</span> <span class="token string">'荣'</span><span class="token punctuation">,</span> <span class="token string">'海'</span><span class="token punctuation">,</span>    <span class="token string">'呈'</span><span class="token punctuation">,</span> <span class="token string">'素'</span><span class="token punctuation">,</span> <span class="token string">'之'</span><span class="token punctuation">,</span> <span class="token string">'碧'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'峻'</span><span class="token punctuation">,</span> <span class="token string">'晏'</span><span class="token punctuation">,</span> <span class="token string">'胜'</span><span class="token punctuation">,</span> <span class="token string">'裕'</span><span class="token punctuation">,</span> <span class="token string">'惠'</span><span class="token punctuation">,</span> <span class="token string">'子'</span><span class="token punctuation">,</span> <span class="token string">'昭'</span><span class="token punctuation">,</span> <span class="token string">'骏'</span><span class="token punctuation">,</span> <span class="token string">'芳'</span><span class="token punctuation">,</span> <span class="token string">'凡'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'恭'</span><span class="token punctuation">,</span> <span class="token string">'弘'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'兴'</span><span class="token punctuation">,</span> <span class="token string">'坚'</span><span class="token punctuation">,</span> <span class="token string">'紫'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'婉'</span><span class="token punctuation">,</span> <span class="token string">'芝'</span><span class="token punctuation">,</span> <span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'孝'</span><span class="token punctuation">,</span> <span class="token string">'翊'</span><span class="token punctuation">,</span> <span class="token string">'乐'</span><span class="token punctuation">,</span> <span class="token string">'如'</span><span class="token punctuation">,</span> <span class="token string">'姵'</span><span class="token punctuation">,</span> <span class="token string">'珮'</span><span class="token punctuation">,</span> <span class="token string">'智'</span><span class="token punctuation">,</span> <span class="token string">'惟'</span><span class="token punctuation">,</span> <span class="token string">'添'</span><span class="token punctuation">,</span> <span class="token string">'旻'</span><span class="token punctuation">,</span> <span class="token string">'宁'</span><span class="token punctuation">,</span> <span class="token string">'东'</span><span class="token punctuation">,</span> <span class="token string">'淳'</span><span class="token punctuation">,</span> <span class="token string">'柏'</span><span class="token punctuation">,</span> <span class="token string">'沛'</span><span class="token punctuation">,</span> <span class="token string">'合'</span><span class="token punctuation">,</span> <span class="token string">'国'</span><span class="token punctuation">,</span> <span class="token string">'宣'</span><span class="token punctuation">,</span> <span class="token string">'益'</span><span class="token punctuation">,</span>    <span class="token string">'伯'</span><span class="token punctuation">,</span> <span class="token string">'长'</span><span class="token punctuation">,</span> <span class="token string">'于'</span><span class="token punctuation">,</span> <span class="token string">'平'</span><span class="token punctuation">,</span> <span class="token string">'绿'</span><span class="token punctuation">,</span> <span class="token string">'维'</span><span class="token punctuation">,</span> <span class="token string">'舒'</span><span class="token punctuation">,</span> <span class="token string">'妤'</span><span class="token punctuation">,</span> <span class="token string">'南'</span><span class="token punctuation">,</span> <span class="token string">'昱'</span><span class="token punctuation">,</span> <span class="token string">'宇'</span><span class="token punctuation">,</span> <span class="token string">'岳'</span><span class="token punctuation">,</span> <span class="token string">'恩'</span><span class="token punctuation">,</span> <span class="token string">'礼'</span><span class="token punctuation">,</span> <span class="token string">'群'</span><span class="token punctuation">,</span> <span class="token string">'佩'</span><span class="token punctuation">,</span> <span class="token string">'军'</span><span class="token punctuation">,</span> <span class="token string">'璇'</span><span class="token punctuation">,</span> <span class="token string">'文'</span><span class="token punctuation">,</span> <span class="token string">'咏'</span><span class="token punctuation">,</span> <span class="token string">'介'</span><span class="token punctuation">,</span> <span class="token string">'喜'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'毅'</span><span class="token punctuation">,</span> <span class="token string">'君'</span><span class="token punctuation">,</span> <span class="token string">'劭'</span><span class="token punctuation">,</span> <span class="token string">'嘉'</span><span class="token punctuation">,</span> <span class="token string">'肇'</span><span class="token punctuation">,</span> <span class="token string">'法'</span><span class="token punctuation">,</span> <span class="token string">'逸'</span><span class="token punctuation">,</span> <span class="token string">'治'</span><span class="token punctuation">,</span> <span class="token string">'万'</span><span class="token punctuation">,</span> <span class="token string">'松'</span><span class="token punctuation">,</span> <span class="token string">'水'</span><span class="token punctuation">,</span> <span class="token string">'浩'</span><span class="token punctuation">,</span> <span class="token string">'莹'</span><span class="token punctuation">,</span> <span class="token string">'景'</span><span class="token punctuation">,</span> <span class="token string">'茂'</span><span class="token punctuation">,</span> <span class="token string">'绮'</span><span class="token punctuation">,</span> <span class="token string">'蓉'</span><span class="token punctuation">,</span> <span class="token string">'薇'</span><span class="token punctuation">,</span> <span class="token string">'郁'</span><span class="token punctuation">,</span> <span class="token string">'俞'</span><span class="token punctuation">,</span> <span class="token string">'和'</span><span class="token punctuation">,</span> <span class="token string">'坤'</span><span class="token punctuation">,</span>    <span class="token string">'毓'</span><span class="token punctuation">,</span> <span class="token string">'均'</span><span class="token punctuation">,</span> <span class="token string">'梦'</span><span class="token punctuation">,</span> <span class="token string">'培'</span><span class="token punctuation">,</span> <span class="token string">'与'</span><span class="token punctuation">,</span> <span class="token string">'廷'</span><span class="token punctuation">,</span> <span class="token string">'乃'</span><span class="token punctuation">,</span> <span class="token string">'勋'</span><span class="token punctuation">,</span> <span class="token string">'登'</span><span class="token punctuation">,</span> <span class="token string">'爱'</span><span class="token punctuation">,</span> <span class="token string">'梅'</span><span class="token punctuation">,</span> <span class="token string">'千'</span><span class="token punctuation">,</span> <span class="token string">'书'</span><span class="token punctuation">,</span> <span class="token string">'欢'</span><span class="token punctuation">,</span> <span class="token string">'琇'</span><span class="token punctuation">,</span> <span class="token string">'念'</span><span class="token punctuation">,</span> <span class="token string">'玟'</span><span class="token punctuation">,</span> <span class="token string">'秋'</span><span class="token punctuation">,</span> <span class="token string">'颖'</span><span class="token punctuation">,</span> <span class="token string">'得'</span><span class="token punctuation">,</span> <span class="token string">'星'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'容'</span><span class="token punctuation">,</span> <span class="token string">'映'</span><span class="token punctuation">,</span> <span class="token string">'德'</span><span class="token punctuation">,</span> <span class="token string">'怡'</span><span class="token punctuation">,</span> <span class="token string">'茹'</span><span class="token punctuation">,</span> <span class="token string">'仪'</span><span class="token punctuation">,</span> <span class="token string">'儒'</span><span class="token punctuation">,</span> <span class="token string">'杰'</span><span class="token punctuation">,</span> <span class="token string">'哲'</span><span class="token punctuation">,</span> <span class="token string">'汉'</span><span class="token punctuation">,</span> <span class="token string">'刚'</span><span class="token punctuation">,</span> <span class="token string">'娇'</span><span class="token punctuation">,</span> <span class="token string">'修'</span><span class="token punctuation">,</span> <span class="token string">'旭'</span><span class="token punctuation">,</span> <span class="token string">'桂'</span><span class="token punctuation">,</span> <span class="token string">'雨'</span><span class="token punctuation">,</span> <span class="token string">'仕'</span><span class="token punctuation">,</span> <span class="token string">'莉'</span><span class="token punctuation">,</span> <span class="token string">'克'</span><span class="token punctuation">,</span> <span class="token string">'佳'</span><span class="token punctuation">,</span> <span class="token string">'珊'</span><span class="token punctuation">,</span> <span class="token string">'阿'</span><span class="token punctuation">,</span>    <span class="token string">'秀'</span><span class="token punctuation">,</span> <span class="token string">'尚'</span><span class="token punctuation">,</span> <span class="token string">'尧'</span><span class="token punctuation">,</span> <span class="token string">'晋'</span><span class="token punctuation">,</span> <span class="token string">'湘'</span><span class="token punctuation">,</span> <span class="token string">'俐'</span><span class="token punctuation">,</span> <span class="token string">'春'</span><span class="token punctuation">,</span> <span class="token string">'虹'</span><span class="token punctuation">,</span> <span class="token string">'瑞'</span><span class="token punctuation">,</span> <span class="token string">'百'</span><span class="token punctuation">,</span> <span class="token string">'琳'</span><span class="token punctuation">,</span> <span class="token string">'语'</span><span class="token punctuation">,</span> <span class="token string">'阳'</span><span class="token punctuation">,</span> <span class="token string">'木'</span><span class="token punctuation">,</span> <span class="token string">'建'</span><span class="token punctuation">,</span> <span class="token string">'丰'</span><span class="token punctuation">,</span> <span class="token string">'琪'</span><span class="token punctuation">,</span> <span class="token string">'财'</span><span class="token punctuation">,</span> <span class="token string">'英'</span><span class="token punctuation">,</span> <span class="token string">'慧'</span><span class="token punctuation">,</span> <span class="token string">'靖'</span><span class="token punctuation">,</span> <span class="token string">'菁'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'若'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'原'</span><span class="token punctuation">,</span> <span class="token string">'婕'</span><span class="token punctuation">,</span> <span class="token string">'意'</span><span class="token punctuation">,</span> <span class="token string">'展'</span><span class="token punctuation">,</span> <span class="token string">'巧'</span><span class="token punctuation">,</span> <span class="token string">'人'</span><span class="token punctuation">,</span> <span class="token string">'吟'</span><span class="token punctuation">,</span> <span class="token string">'竹'</span><span class="token punctuation">,</span> <span class="token string">'重'</span><span class="token punctuation">,</span> <span class="token string">'鸿'</span><span class="token punctuation">,</span> <span class="token string">'敬'</span><span class="token punctuation">,</span> <span class="token string">'依'</span><span class="token punctuation">,</span> <span class="token string">'进'</span><span class="token punctuation">,</span> <span class="token string">'台'</span><span class="token punctuation">,</span> <span class="token string">'左'</span><span class="token punctuation">,</span> <span class="token string">'亦'</span><span class="token punctuation">,</span> <span class="token string">'韵'</span><span class="token punctuation">,</span> <span class="token string">'钰'</span><span class="token punctuation">,</span> <span class="token string">'新'</span><span class="token punctuation">,</span> <span class="token string">'羽'</span><span class="token punctuation">,</span>    <span class="token string">'静'</span><span class="token punctuation">,</span> <span class="token string">'名'</span><span class="token punctuation">,</span> <span class="token string">'中'</span><span class="token punctuation">,</span> <span class="token string">'仁'</span><span class="token punctuation">,</span> <span class="token string">'采'</span><span class="token punctuation">,</span> <span class="token string">'亭'</span><span class="token punctuation">,</span> <span class="token string">'妙'</span><span class="token punctuation">,</span> <span class="token string">'希'</span><span class="token punctuation">,</span> <span class="token string">'必'</span><span class="token punctuation">,</span> <span class="token string">'承'</span><span class="token punctuation">,</span> <span class="token string">'豪'</span><span class="token punctuation">,</span> <span class="token string">'吉'</span><span class="token punctuation">,</span> <span class="token string">'芷'</span><span class="token punctuation">,</span> <span class="token string">'上'</span><span class="token punctuation">,</span> <span class="token string">'石'</span><span class="token punctuation">,</span> <span class="token string">'冠'</span><span class="token punctuation">,</span> <span class="token string">'威'</span><span class="token punctuation">,</span> <span class="token string">'又'</span><span class="token punctuation">,</span> <span class="token string">'辛'</span><span class="token punctuation">,</span> <span class="token string">'奕'</span><span class="token punctuation">,</span> <span class="token string">'雅'</span><span class="token punctuation">,</span> <span class="token string">'泓'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'伶'</span><span class="token punctuation">,</span> <span class="token string">'玫'</span><span class="token punctuation">,</span> <span class="token string">'定'</span><span class="token punctuation">,</span> <span class="token string">'世'</span><span class="token punctuation">,</span> <span class="token string">'皓'</span><span class="token punctuation">,</span> <span class="token string">'协'</span><span class="token punctuation">,</span> <span class="token string">'芸'</span><span class="token punctuation">,</span> <span class="token string">'政'</span><span class="token punctuation">,</span> <span class="token string">'洁'</span><span class="token punctuation">,</span> <span class="token string">'祥'</span><span class="token punctuation">,</span> <span class="token string">'清'</span><span class="token punctuation">,</span> <span class="token string">'光'</span><span class="token punctuation">,</span> <span class="token string">'贞'</span><span class="token punctuation">,</span> <span class="token string">'翠'</span><span class="token punctuation">,</span> <span class="token string">'纯'</span><span class="token punctuation">,</span> <span class="token string">'伟'</span><span class="token punctuation">,</span> <span class="token string">'振'</span><span class="token punctuation">,</span> <span class="token string">'庭'</span><span class="token punctuation">,</span> <span class="token string">'易'</span><span class="token punctuation">,</span> <span class="token string">'香'</span><span class="token punctuation">,</span> <span class="token string">'永'</span><span class="token punctuation">,</span> <span class="token string">'皇'</span><span class="token punctuation">,</span>    <span class="token string">'茜'</span><span class="token punctuation">,</span> <span class="token string">'良'</span><span class="token punctuation">,</span> <span class="token string">'敏'</span><span class="token punctuation">,</span> <span class="token string">'燕'</span><span class="token punctuation">,</span> <span class="token string">'俊'</span><span class="token punctuation">,</span> <span class="token string">'月'</span><span class="token punctuation">,</span> <span class="token string">'民'</span><span class="token punctuation">,</span> <span class="token string">'隆'</span><span class="token punctuation">,</span> <span class="token string">'侑'</span><span class="token punctuation">,</span> <span class="token string">'诗'</span><span class="token punctuation">,</span> <span class="token string">'心'</span><span class="token punctuation">,</span> <span class="token string">'友'</span><span class="token punctuation">,</span> <span class="token string">'致'</span><span class="token punctuation">,</span> <span class="token string">'贤'</span><span class="token punctuation">,</span> <span class="token string">'宛'</span><span class="token punctuation">,</span> <span class="token string">'奇'</span><span class="token punctuation">,</span> <span class="token string">'玲'</span><span class="token punctuation">,</span> <span class="token string">'志'</span><span class="token punctuation">,</span> <span class="token string">'宪'</span><span class="token punctuation">,</span> <span class="token string">'启'</span><span class="token punctuation">,</span> <span class="token string">'亚'</span><span class="token punctuation">,</span> <span class="token string">'盈'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token string">'睿'</span><span class="token punctuation">,</span> <span class="token string">'涵'</span><span class="token punctuation">,</span> <span class="token string">'柔'</span><span class="token punctuation">,</span> <span class="token string">'萱'</span><span class="token punctuation">,</span> <span class="token string">'昀'</span><span class="token punctuation">,</span> <span class="token string">'伦'</span><span class="token punctuation">,</span> <span class="token string">'升'</span><span class="token punctuation">,</span> <span class="token string">'季'</span><span class="token punctuation">,</span> <span class="token string">'玮'</span><span class="token punctuation">,</span> <span class="token string">'凤'</span><span class="token punctuation">,</span> <span class="token string">'善'</span><span class="token punctuation">,</span> <span class="token string">'云'</span><span class="token punctuation">,</span> <span class="token string">'祯'</span><span class="token punctuation">,</span> <span class="token string">'幸'</span><span class="token punctuation">,</span> <span class="token string">'宏'</span><span class="token punctuation">,</span> <span class="token string">'可'</span><span class="token punctuation">,</span> <span class="token string">'信'</span><span class="token punctuation">,</span> <span class="token string">'天'</span><span class="token punctuation">,</span> <span class="token string">'宗'</span><span class="token punctuation">,</span> <span class="token string">'宜'</span><span class="token punctuation">,</span> <span class="token string">'忆'</span><span class="token punctuation">,</span> <span class="token string">'康'</span><span class="token punctuation">,</span>    <span class="token string">'翰'</span><span class="token punctuation">,</span> <span class="token string">'正'</span><span class="token punctuation">,</span> <span class="token string">'丽'</span><span class="token punctuation">,</span> <span class="token string">'翔'</span><span class="token punctuation">,</span> <span class="token string">'少'</span><span class="token punctuation">,</span> <span class="token string">'朝'</span><span class="token punctuation">,</span> <span class="token string">'倩'</span><span class="token punctuation">,</span> <span class="token string">'圣'</span><span class="token punctuation">,</span> <span class="token string">'钧'</span><span class="token punctuation">,</span> <span class="token string">'琬'</span><span class="token punctuation">,</span> <span class="token string">'铭'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'幼'</span><span class="token punctuation">,</span> <span class="token string">'立'</span><span class="token punctuation">,</span> <span class="token string">'蕙'</span><span class="token punctuation">,</span> <span class="token string">'青'</span><span class="token punctuation">,</span> <span class="token string">'枝'</span><span class="token punctuation">,</span> <span class="token string">'庆'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token comment"># 名</span>listl <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'盛'</span><span class="token punctuation">,</span> <span class="token string">'斌'</span><span class="token punctuation">,</span> <span class="token string">'铃'</span><span class="token punctuation">,</span> <span class="token string">'峰'</span><span class="token punctuation">,</span> <span class="token string">'志'</span><span class="token punctuation">,</span> <span class="token string">'原'</span><span class="token punctuation">,</span> <span class="token string">'莲'</span><span class="token punctuation">,</span> <span class="token string">'扬'</span><span class="token punctuation">,</span> <span class="token string">'全'</span><span class="token punctuation">,</span> <span class="token string">'茂'</span><span class="token punctuation">,</span> <span class="token string">'辰'</span><span class="token punctuation">,</span> <span class="token string">'彰'</span><span class="token punctuation">,</span> <span class="token string">'臻'</span><span class="token punctuation">,</span> <span class="token string">'竹'</span><span class="token punctuation">,</span> <span class="token string">'翰'</span><span class="token punctuation">,</span> <span class="token string">'静'</span><span class="token punctuation">,</span> <span class="token string">'妹'</span><span class="token punctuation">,</span> <span class="token string">'霖'</span><span class="token punctuation">,</span> <span class="token string">'添'</span><span class="token punctuation">,</span> <span class="token string">'吟'</span><span class="token punctuation">,</span> <span class="token string">'廷'</span><span class="token punctuation">,</span> <span class="token string">'正'</span><span class="token punctuation">,</span>    <span class="token string">'奇'</span><span class="token punctuation">,</span> <span class="token string">'平'</span><span class="token punctuation">,</span> <span class="token string">'安'</span><span class="token punctuation">,</span> <span class="token string">'柔'</span><span class="token punctuation">,</span> <span class="token string">'毓'</span><span class="token punctuation">,</span> <span class="token string">'贵'</span><span class="token punctuation">,</span> <span class="token string">'宪'</span><span class="token punctuation">,</span> <span class="token string">'怡'</span><span class="token punctuation">,</span> <span class="token string">'秋'</span><span class="token punctuation">,</span> <span class="token string">'茜'</span><span class="token punctuation">,</span> <span class="token string">'和'</span><span class="token punctuation">,</span> <span class="token string">'玉'</span><span class="token punctuation">,</span> <span class="token string">'泉'</span><span class="token punctuation">,</span> <span class="token string">'珍'</span><span class="token punctuation">,</span> <span class="token string">'季'</span><span class="token punctuation">,</span> <span class="token string">'娇'</span><span class="token punctuation">,</span> <span class="token string">'盈'</span><span class="token punctuation">,</span> <span class="token string">'蓉'</span><span class="token punctuation">,</span> <span class="token string">'仪'</span><span class="token punctuation">,</span> <span class="token string">'群'</span><span class="token punctuation">,</span> <span class="token string">'升'</span><span class="token punctuation">,</span> <span class="token string">'忠'</span><span class="token punctuation">,</span>    <span class="token string">'慧'</span><span class="token punctuation">,</span> <span class="token string">'睿'</span><span class="token punctuation">,</span> <span class="token string">'军'</span><span class="token punctuation">,</span> <span class="token string">'友'</span><span class="token punctuation">,</span> <span class="token string">'威'</span><span class="token punctuation">,</span> <span class="token string">'云'</span><span class="token punctuation">,</span> <span class="token string">'玲'</span><span class="token punctuation">,</span> <span class="token string">'康'</span><span class="token punctuation">,</span> <span class="token string">'彬'</span><span class="token punctuation">,</span> <span class="token string">'雅'</span><span class="token punctuation">,</span> <span class="token string">'勋'</span><span class="token punctuation">,</span> <span class="token string">'丰'</span><span class="token punctuation">,</span> <span class="token string">'帆'</span><span class="token punctuation">,</span> <span class="token string">'君'</span><span class="token punctuation">,</span> <span class="token string">'琴'</span><span class="token punctuation">,</span> <span class="token string">'毅'</span><span class="token punctuation">,</span> <span class="token string">'玫'</span><span class="token punctuation">,</span> <span class="token string">'璇'</span><span class="token punctuation">,</span> <span class="token string">'淑'</span><span class="token punctuation">,</span> <span class="token string">'秀'</span><span class="token punctuation">,</span> <span class="token string">'琦'</span><span class="token punctuation">,</span> <span class="token string">'玮'</span><span class="token punctuation">,</span>    <span class="token string">'媛'</span><span class="token punctuation">,</span> <span class="token string">'逸'</span><span class="token punctuation">,</span> <span class="token string">'博'</span><span class="token punctuation">,</span> <span class="token string">'筑'</span><span class="token punctuation">,</span> <span class="token string">'维'</span><span class="token punctuation">,</span> <span class="token string">'韦'</span><span class="token punctuation">,</span> <span class="token string">'均'</span><span class="token punctuation">,</span> <span class="token string">'昌'</span><span class="token punctuation">,</span> <span class="token string">'欣'</span><span class="token punctuation">,</span> <span class="token string">'合'</span><span class="token punctuation">,</span> <span class="token string">'强'</span><span class="token punctuation">,</span> <span class="token string">'法'</span><span class="token punctuation">,</span> <span class="token string">'冰'</span><span class="token punctuation">,</span> <span class="token string">'其'</span><span class="token punctuation">,</span> <span class="token string">'昀'</span><span class="token punctuation">,</span> <span class="token string">'心'</span><span class="token punctuation">,</span> <span class="token string">'惠'</span><span class="token punctuation">,</span> <span class="token string">'甄'</span><span class="token punctuation">,</span> <span class="token string">'薇'</span><span class="token punctuation">,</span> <span class="token string">'旺'</span><span class="token punctuation">,</span> <span class="token string">'纬'</span><span class="token punctuation">,</span> <span class="token string">'南'</span><span class="token punctuation">,</span>    <span class="token string">'辛'</span><span class="token punctuation">,</span> <span class="token string">'伯'</span><span class="token punctuation">,</span> <span class="token string">'凤'</span><span class="token punctuation">,</span> <span class="token string">'祥'</span><span class="token punctuation">,</span> <span class="token string">'倩'</span><span class="token punctuation">,</span> <span class="token string">'舜'</span><span class="token punctuation">,</span> <span class="token string">'菱'</span><span class="token punctuation">,</span> <span class="token string">'英'</span><span class="token punctuation">,</span> <span class="token string">'美'</span><span class="token punctuation">,</span> <span class="token string">'虹'</span><span class="token punctuation">,</span> <span class="token string">'松'</span><span class="token punctuation">,</span> <span class="token string">'星'</span><span class="token punctuation">,</span> <span class="token string">'辉'</span><span class="token punctuation">,</span> <span class="token string">'元'</span><span class="token punctuation">,</span> <span class="token string">'圣'</span><span class="token punctuation">,</span> <span class="token string">'隆'</span><span class="token punctuation">,</span> <span class="token string">'龙'</span><span class="token punctuation">,</span> <span class="token string">'花'</span><span class="token punctuation">,</span> <span class="token string">'苹'</span><span class="token punctuation">,</span> <span class="token string">'筠'</span><span class="token punctuation">,</span> <span class="token string">'任'</span><span class="token punctuation">,</span> <span class="token string">'纶'</span><span class="token punctuation">,</span>    <span class="token string">'岚'</span><span class="token punctuation">,</span> <span class="token string">'妃'</span><span class="token punctuation">,</span> <span class="token string">'昆'</span><span class="token punctuation">,</span> <span class="token string">'贤'</span><span class="token punctuation">,</span> <span class="token string">'生'</span><span class="token punctuation">,</span> <span class="token string">'瑄'</span><span class="token punctuation">,</span> <span class="token string">'谦'</span><span class="token punctuation">,</span> <span class="token string">'兴'</span><span class="token punctuation">,</span> <span class="token string">'伟'</span><span class="token punctuation">,</span> <span class="token string">'宝'</span><span class="token punctuation">,</span> <span class="token string">'沛'</span><span class="token punctuation">,</span> <span class="token string">'馨'</span><span class="token punctuation">,</span> <span class="token string">'珮'</span><span class="token punctuation">,</span> <span class="token string">'蓁'</span><span class="token punctuation">,</span> <span class="token string">'蕙'</span><span class="token punctuation">,</span> <span class="token string">'钰'</span><span class="token punctuation">,</span> <span class="token string">'杰'</span><span class="token punctuation">,</span> <span class="token string">'劭'</span><span class="token punctuation">,</span> <span class="token string">'旭'</span><span class="token punctuation">,</span> <span class="token string">'宏'</span><span class="token punctuation">,</span> <span class="token string">'庭'</span><span class="token punctuation">,</span> <span class="token string">'坤'</span><span class="token punctuation">,</span>    <span class="token string">'轩'</span><span class="token punctuation">,</span> <span class="token string">'修'</span><span class="token punctuation">,</span> <span class="token string">'芸'</span><span class="token punctuation">,</span> <span class="token string">'佳'</span><span class="token punctuation">,</span> <span class="token string">'月'</span><span class="token punctuation">,</span> <span class="token string">'桦'</span><span class="token punctuation">,</span> <span class="token string">'来'</span><span class="token punctuation">,</span> <span class="token string">'霞'</span><span class="token punctuation">,</span> <span class="token string">'孜'</span><span class="token punctuation">,</span> <span class="token string">'乐'</span><span class="token punctuation">,</span> <span class="token string">'达'</span><span class="token punctuation">,</span> <span class="token string">'敏'</span><span class="token punctuation">,</span> <span class="token string">'善'</span><span class="token punctuation">,</span> <span class="token string">'亦'</span><span class="token punctuation">,</span> <span class="token string">'超'</span><span class="token punctuation">,</span> <span class="token string">'钧'</span><span class="token punctuation">,</span> <span class="token string">'天'</span><span class="token punctuation">,</span> <span class="token string">'羽'</span><span class="token punctuation">,</span> <span class="token string">'刚'</span><span class="token punctuation">,</span> <span class="token string">'绿'</span><span class="token punctuation">,</span> <span class="token string">'爱'</span><span class="token punctuation">,</span> <span class="token string">'纯'</span><span class="token punctuation">,</span>    <span class="token string">'侑'</span><span class="token punctuation">,</span> <span class="token string">'士'</span><span class="token punctuation">,</span> <span class="token string">'名'</span><span class="token punctuation">,</span> <span class="token string">'雯'</span><span class="token punctuation">,</span> <span class="token string">'义'</span><span class="token punctuation">,</span> <span class="token string">'亚'</span><span class="token punctuation">,</span> <span class="token string">'琬'</span><span class="token punctuation">,</span> <span class="token string">'芷'</span><span class="token punctuation">,</span> <span class="token string">'尧'</span><span class="token punctuation">,</span> <span class="token string">'伦'</span><span class="token punctuation">,</span> <span class="token string">'新'</span><span class="token punctuation">,</span> <span class="token string">'乔'</span><span class="token punctuation">,</span> <span class="token string">'雄'</span><span class="token punctuation">,</span> <span class="token string">'洁'</span><span class="token punctuation">,</span> <span class="token string">'幸'</span><span class="token punctuation">,</span> <span class="token string">'娥'</span><span class="token punctuation">,</span> <span class="token string">'恩'</span><span class="token punctuation">,</span> <span class="token string">'玟'</span><span class="token punctuation">,</span> <span class="token string">'书'</span><span class="token punctuation">,</span> <span class="token string">'惟'</span><span class="token punctuation">,</span> <span class="token string">'泰'</span><span class="token punctuation">,</span> <span class="token string">'瑜'</span><span class="token punctuation">,</span>    <span class="token string">'珊'</span><span class="token punctuation">,</span> <span class="token string">'远'</span><span class="token punctuation">,</span> <span class="token string">'晴'</span><span class="token punctuation">,</span> <span class="token string">'彦'</span><span class="token punctuation">,</span> <span class="token string">'哲'</span><span class="token punctuation">,</span> <span class="token string">'瑞'</span><span class="token punctuation">,</span> <span class="token string">'琇'</span><span class="token punctuation">,</span> <span class="token string">'智'</span><span class="token punctuation">,</span> <span class="token string">'映'</span><span class="token punctuation">,</span> <span class="token string">'珠'</span><span class="token punctuation">,</span> <span class="token string">'鸿'</span><span class="token punctuation">,</span> <span class="token string">'梦'</span><span class="token punctuation">,</span> <span class="token string">'燕'</span><span class="token punctuation">,</span> <span class="token string">'人'</span><span class="token punctuation">,</span> <span class="token string">'春'</span><span class="token punctuation">,</span> <span class="token string">'儒'</span><span class="token punctuation">,</span> <span class="token string">'卿'</span><span class="token punctuation">,</span> <span class="token string">'佩'</span><span class="token punctuation">,</span> <span class="token string">'祯'</span><span class="token punctuation">,</span> <span class="token string">'良'</span><span class="token punctuation">,</span> <span class="token string">'清'</span><span class="token punctuation">,</span> <span class="token string">'欢'</span><span class="token punctuation">,</span>    <span class="token string">'中'</span><span class="token punctuation">,</span> <span class="token string">'麟'</span><span class="token punctuation">,</span> <span class="token string">'骏'</span><span class="token punctuation">,</span> <span class="token string">'岳'</span><span class="token punctuation">,</span> <span class="token string">'财'</span><span class="token punctuation">,</span> <span class="token string">'芳'</span><span class="token punctuation">,</span> <span class="token string">'诚'</span><span class="token punctuation">,</span> <span class="token string">'文'</span><span class="token punctuation">,</span> <span class="token string">'真'</span><span class="token punctuation">,</span> <span class="token string">'柏'</span><span class="token punctuation">,</span> <span class="token string">'湖'</span><span class="token punctuation">,</span> <span class="token string">'菁'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token string">'一'</span><span class="token punctuation">,</span> <span class="token string">'佑'</span><span class="token punctuation">,</span> <span class="token string">'颖'</span><span class="token punctuation">,</span> <span class="token string">'阳'</span><span class="token punctuation">,</span> <span class="token string">'水'</span><span class="token punctuation">,</span> <span class="token string">'枝'</span><span class="token punctuation">,</span> <span class="token string">'茹'</span><span class="token punctuation">,</span> <span class="token string">'德'</span><span class="token punctuation">,</span> <span class="token string">'豪'</span><span class="token punctuation">,</span>    <span class="token string">'谕'</span><span class="token punctuation">,</span> <span class="token string">'华'</span><span class="token punctuation">,</span> <span class="token string">'裕'</span><span class="token punctuation">,</span> <span class="token string">'山'</span><span class="token punctuation">,</span> <span class="token string">'孝'</span><span class="token punctuation">,</span> <span class="token string">'依'</span><span class="token punctuation">,</span> <span class="token string">'木'</span><span class="token punctuation">,</span> <span class="token string">'宣'</span><span class="token punctuation">,</span> <span class="token string">'涵'</span><span class="token punctuation">,</span> <span class="token string">'凯'</span><span class="token punctuation">,</span> <span class="token string">'源'</span><span class="token punctuation">,</span> <span class="token string">'韵'</span><span class="token punctuation">,</span> <span class="token string">'成'</span><span class="token punctuation">,</span> <span class="token string">'育'</span><span class="token punctuation">,</span> <span class="token string">'喜'</span><span class="token punctuation">,</span> <span class="token string">'宁'</span><span class="token punctuation">,</span> <span class="token string">'郁'</span><span class="token punctuation">,</span> <span class="token string">'仁'</span><span class="token punctuation">,</span> <span class="token string">'仲'</span><span class="token punctuation">,</span> <span class="token string">'希'</span><span class="token punctuation">,</span> <span class="token string">'芬'</span><span class="token punctuation">,</span> <span class="token string">'雨'</span><span class="token punctuation">,</span>    <span class="token string">'瑶'</span><span class="token punctuation">,</span> <span class="token string">'翔'</span><span class="token punctuation">,</span> <span class="token string">'火'</span><span class="token punctuation">,</span> <span class="token string">'铭'</span><span class="token punctuation">,</span> <span class="token string">'芝'</span><span class="token punctuation">,</span> <span class="token string">'东'</span><span class="token punctuation">,</span> <span class="token string">'定'</span><span class="token punctuation">,</span> <span class="token string">'璋'</span><span class="token punctuation">,</span> <span class="token string">'意'</span><span class="token punctuation">,</span> <span class="token string">'江'</span><span class="token punctuation">,</span> <span class="token string">'靖'</span><span class="token punctuation">,</span> <span class="token string">'民'</span><span class="token punctuation">,</span> <span class="token string">'易'</span><span class="token punctuation">,</span> <span class="token string">'如'</span><span class="token punctuation">,</span> <span class="token string">'淳'</span><span class="token punctuation">,</span> <span class="token string">'光'</span><span class="token punctuation">,</span> <span class="token string">'发'</span><span class="token punctuation">,</span> <span class="token string">'启'</span><span class="token punctuation">,</span> <span class="token string">'俐'</span><span class="token punctuation">,</span> <span class="token string">'俊'</span><span class="token punctuation">,</span> <span class="token string">'礼'</span><span class="token punctuation">,</span> <span class="token string">'齐'</span><span class="token punctuation">,</span>    <span class="token string">'庆'</span><span class="token punctuation">,</span> <span class="token string">'谚'</span><span class="token punctuation">,</span> <span class="token string">'香'</span><span class="token punctuation">,</span> <span class="token string">'富'</span><span class="token punctuation">,</span> <span class="token string">'妤'</span><span class="token punctuation">,</span> <span class="token string">'宜'</span><span class="token punctuation">,</span> <span class="token string">'弘'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'汉'</span><span class="token punctuation">,</span> <span class="token string">'政'</span><span class="token punctuation">,</span> <span class="token string">'以'</span><span class="token punctuation">,</span> <span class="token string">'伶'</span><span class="token punctuation">,</span> <span class="token string">'勇'</span><span class="token punctuation">,</span> <span class="token string">'绮'</span><span class="token punctuation">,</span> <span class="token string">'凡'</span><span class="token punctuation">,</span> <span class="token string">'吉'</span><span class="token punctuation">,</span> <span class="token string">'梅'</span><span class="token punctuation">,</span> <span class="token string">'慈'</span><span class="token punctuation">,</span> <span class="token string">'容'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'荣'</span><span class="token punctuation">,</span> <span class="token string">'萍'</span><span class="token punctuation">,</span>    <span class="token string">'贞'</span><span class="token punctuation">,</span> <span class="token string">'娟'</span><span class="token punctuation">,</span> <span class="token string">'信'</span><span class="token punctuation">,</span> <span class="token string">'青'</span><span class="token punctuation">,</span> <span class="token string">'皓'</span><span class="token punctuation">,</span> <span class="token string">'雪'</span><span class="token punctuation">,</span> <span class="token string">'治'</span><span class="token punctuation">,</span> <span class="token string">'琳'</span><span class="token punctuation">,</span> <span class="token string">'紫'</span><span class="token punctuation">,</span> <span class="token string">'兰'</span><span class="token punctuation">,</span> <span class="token string">'白'</span><span class="token punctuation">,</span> <span class="token string">'婷'</span><span class="token punctuation">,</span> <span class="token string">'莹'</span><span class="token punctuation">,</span> <span class="token string">'嘉'</span><span class="token punctuation">,</span> <span class="token string">'恭'</span><span class="token punctuation">,</span> <span class="token string">'萱'</span><span class="token punctuation">,</span> <span class="token string">'顺'</span><span class="token punctuation">,</span> <span class="token string">'行'</span><span class="token punctuation">,</span> <span class="token string">'琪'</span><span class="token punctuation">,</span> <span class="token string">'念'</span><span class="token punctuation">,</span> <span class="token string">'宇'</span><span class="token punctuation">,</span> <span class="token string">'海'</span><span class="token punctuation">,</span>    <span class="token string">'坚'</span><span class="token punctuation">,</span> <span class="token string">'福'</span><span class="token punctuation">,</span> <span class="token string">'绍'</span><span class="token punctuation">,</span> <span class="token string">'桂'</span><span class="token punctuation">]</span><span class="token comment"># 数据库类</span><span class="token keyword">class</span> <span class="token class-name">Wdatabases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__db_host <span class="token operator">=</span> <span class="token string">"192.168.236.128"</span>        self<span class="token punctuation">.</span>__db_port <span class="token operator">=</span> <span class="token number">3306</span>        self<span class="token punctuation">.</span>__db_user <span class="token operator">=</span> <span class="token string">"root"</span>        self<span class="token punctuation">.</span>__db_password <span class="token operator">=</span> <span class="token string">"YjUzZjg0NTU1OWViM2I5ZTM1ZWE0NWZj"</span>        self<span class="token punctuation">.</span>__db_database <span class="token operator">=</span> <span class="token string">"school"</span>    <span class="token comment"># 链接数据库</span>    <span class="token keyword">def</span> <span class="token function">Wlink</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>            host<span class="token operator">=</span>self<span class="token punctuation">.</span>__db_host<span class="token punctuation">,</span>            port<span class="token operator">=</span>self<span class="token punctuation">.</span>__db_port<span class="token punctuation">,</span>            user<span class="token operator">=</span>self<span class="token punctuation">.</span>__db_user<span class="token punctuation">,</span>            password<span class="token operator">=</span>self<span class="token punctuation">.</span>__db_password<span class="token punctuation">,</span>            database<span class="token operator">=</span>self<span class="token punctuation">.</span>__db_database<span class="token punctuation">,</span>            charset<span class="token operator">=</span><span class="token string">'utf8'</span>        <span class="token punctuation">)</span>    <span class="token comment"># 插入数据</span>    <span class="token keyword">def</span> <span class="token function">Winsert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> ages<span class="token punctuation">,</span> cclass<span class="token punctuation">,</span> yuwen<span class="token punctuation">,</span> shuxue<span class="token punctuation">,</span> english<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment"># 连接数据库</span>            self<span class="token punctuation">.</span>Wlink<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 创建游标</span>            <span class="token keyword">global</span> cursor            cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>__db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># sql命令</span>            sql <span class="token operator">=</span> <span class="token string">"insert into student(name,gender,age,cclass,yuwen,shuxue,english, total) value(%s,%s,%s,%s,%s,%s,"</span> \                  <span class="token string">"%s,%s)"</span>            <span class="token comment"># 执行sql命令</span>            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> ages<span class="token punctuation">,</span> cclass<span class="token punctuation">,</span> yuwen<span class="token punctuation">,</span> shuxue<span class="token punctuation">,</span> english<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token keyword">finally</span><span class="token punctuation">:</span>            <span class="token comment"># 关闭游标</span>            cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 提交</span>            self<span class="token punctuation">.</span>__db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 关闭数据库连接</span>            self<span class="token punctuation">.</span>__db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 数据生成姓名, 年龄, 等并调用数据插入方法</span>    <span class="token keyword">def</span> <span class="token function">Wcommit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listf<span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listm<span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>listf<span class="token punctuation">)</span>        age <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>        yuwen <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>        shuxue <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>        english <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>        gender <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        total <span class="token operator">=</span> yuwen <span class="token operator">+</span> shuxue <span class="token operator">+</span> english        cclass <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>        <span class="token comment"># cclass = random.choice(('一', '二', '三'))</span>        self<span class="token punctuation">.</span>Winsert<span class="token punctuation">(</span>name<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> age<span class="token punctuation">,</span> cclass<span class="token punctuation">,</span> yuwen<span class="token punctuation">,</span> shuxue<span class="token punctuation">,</span> english<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    开始时间 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 创建实例化对象</span>    db <span class="token operator">=</span> Wdatabases<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 插入100条数据</span>    <span class="token keyword">for</span> WJ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 调用方法</span>        db<span class="token punctuation">.</span>Wcommit<span class="token punctuation">(</span><span class="token punctuation">)</span>    结束时间 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>    运行时间 <span class="token operator">=</span> 结束时间 <span class="token operator">-</span> 开始时间    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'该循环程序运行时间: '</span><span class="token punctuation">,</span> 运行时间<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看运行时间"><a href="#查看运行时间" class="headerlink" title="查看运行时间 "></a><font size=5><strong>查看运行时间</strong> </font></h2><p>(我用的是pycharm软件,可以直接复制到MySQL服务器,运行.py文件)</p><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">D:\PyCharm\venv\Scripts\python<span class="token punctuation">.</span>exe <span class="token string">"F:\PyCharm 2019.2.3\helpers\pydev\pydevconsole.py"</span> <span class="token operator">--</span>mode=client <span class="token operator">--</span>port=62152import sys<span class="token punctuation">;</span> print<span class="token punctuation">(</span><span class="token string">'Python %s on %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>version<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>platform<span class="token punctuation">)</span><span class="token punctuation">)</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'D:\\PyCharm'</span><span class="token punctuation">,</span> <span class="token string">'D:/PyCharm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>PyDev console: starting<span class="token punctuation">.</span>Python 3<span class="token punctuation">.</span>7<span class="token punctuation">.</span>0 <span class="token punctuation">(</span>v3<span class="token punctuation">.</span>7<span class="token punctuation">.</span>0:1bf9cc5093<span class="token punctuation">,</span> Jun 27 2018<span class="token punctuation">,</span> 04:59:51<span class="token punctuation">)</span> <span class="token namespace">[MSC v.1914 64 bit (AMD64)]</span> on win32>>> runfile<span class="token punctuation">(</span><span class="token string">'D:/PyCharm/1209/mysql.py'</span><span class="token punctuation">,</span> wdir=<span class="token string">'D:/PyCharm/1209'</span><span class="token punctuation">)</span>该循环程序运行时间:  0<span class="token punctuation">.</span>7610917091369629<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> data </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker-ce安装</title>
      <link href="/posts/2146a1db.html"/>
      <url>/posts/2146a1db.html</url>
      
        <content type="html"><![CDATA[<h1 id="约定"><a href="#约定" class="headerlink" title="约定"></a><font size=5><strong>约定</strong></font></h1><p>系统Ubuntu 18.04.3 LTS</p><h1 id="修改阿里云apt源"><a href="#修改阿里云apt源" class="headerlink" title="修改阿里云apt源"></a><font size=5><strong>修改阿里云apt源</strong></font></h1><p>如果你是按照本博客Ubuntu安装视频安装的Ubuntu系统,则不用修改apt源</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wang@roxn:/etc/apt$ <span class="token function">sudo</span> <span class="token function">mv</span> /etc/apt/sources.list /etc/apt/sources.old   <span class="token comment"># 备份旧的apt源</span>wang@roxn:/etc/apt$ <span class="token function">cat</span> sources.list   <span class="token comment"># 新的apt源</span><span class="token comment"># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span><span class="token comment"># newer versions of the distribution.</span>deb http://mirrors.aliyun.com/ubuntu bionic main restricted<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic main restricted</span><span class="token comment">## Major bug fix updates produced after the final release of the</span><span class="token comment">## distribution.</span>deb http://mirrors.aliyun.com/ubuntu bionic-updates main restricted<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-updates main restricted</span><span class="token comment">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><span class="token comment">## team. Also, please note that software in universe WILL NOT receive any</span><span class="token comment">## review or updates from the Ubuntu security team.</span>deb http://mirrors.aliyun.com/ubuntu bionic universe<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic universe</span>deb http://mirrors.aliyun.com/ubuntu bionic-updates universe<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-updates universe</span><span class="token comment">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><span class="token comment">## team, and may not be under a free licence. Please satisfy yourself as to</span><span class="token comment">## your rights to use the software. Also, please note that software in</span><span class="token comment">## multiverse WILL NOT receive any review or updates from the Ubuntu</span><span class="token comment">## security team.</span>deb http://mirrors.aliyun.com/ubuntu bionic multiverse<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic multiverse</span>deb http://mirrors.aliyun.com/ubuntu bionic-updates multiverse<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-updates multiverse</span><span class="token comment">## N.B. software from this repository may not have been tested as</span><span class="token comment">## extensively as that contained in the main release, although it includes</span><span class="token comment">## newer versions of some applications which may provide useful features.</span><span class="token comment">## Also, please note that software in backports WILL NOT receive any review</span><span class="token comment">## or updates from the Ubuntu security team.</span>deb http://mirrors.aliyun.com/ubuntu bionic-backports main restricted universe multiverse<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-backports main restricted universe multiverse</span><span class="token comment">## Uncomment the following two lines to add software from Canonical's</span><span class="token comment">## 'partner' repository.</span><span class="token comment">## This software is not part of Ubuntu, but is offered by Canonical and the</span><span class="token comment">## respective vendors as a service to Ubuntu users.</span><span class="token comment"># deb http://archive.canonical.com/ubuntu bionic partner</span><span class="token comment"># deb-src http://archive.canonical.com/ubuntu bionic partner</span>deb http://mirrors.aliyun.com/ubuntu bionic-security main restricted<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-security main restricted</span>deb http://mirrors.aliyun.com/ubuntu bionic-security universe<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-security universe</span>deb http://mirrors.aliyun.com/ubuntu bionic-security multiverse<span class="token comment"># deb-src http://mirrors.aliyun.com/ubuntu bionic-security multiverse</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="配置Ubuntu-docker-ce-阿里云apt源"><a href="#配置Ubuntu-docker-ce-阿里云apt源" class="headerlink" title="配置Ubuntu docker-ce 阿里云apt源"></a><font size=5><strong>配置Ubuntu docker-ce 阿里云apt源</strong></font></h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wang@roxn:/etc/apt$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update   <span class="token comment"># 更新apt源</span>wang@roxn:/etc/apt$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common   <span class="token comment"># 安装系统工具</span>wang@roxn:/etc/apt$ <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -   <span class="token comment"># 添加GPG证书</span>wang@roxn:/etc/apt$ <span class="token function">sudo</span> add-apt-repository <span class="token string">"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span>   <span class="token comment"># 设置Ubuntu的docker-ce的阿里云apt源</span>wang@roxn:/etc/apt$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> update   <span class="token comment"># 更新apt源</span>wang@roxn:/etc/apt$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce   <span class="token comment"># 安装docker-ce</span><span class="token comment">#**安装指定版本**</span>wang@roxn:/etc/apt$ <span class="token function">apt-cache</span> madison docker-ce   <span class="token comment"># 查看docker-ce版本</span> docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.5~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.4~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.3~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.2~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.1~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:19.03.0~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.9~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.8~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.7~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.6~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.5~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.4~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.3~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.2~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.1~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">5</span>:18.09.0~3-0~ubuntu-bionic <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">18.06</span>.3~ce~3-0~ubuntu <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">18.06</span>.2~ce~3-0~ubuntu <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">18.06</span>.1~ce~3-0~ubuntu <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">18.06</span>.0~ce~3-0~ubuntu <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages docker-ce <span class="token operator">|</span> <span class="token number">18.03</span>.1~ce~3-0~ubuntu <span class="token operator">|</span> http://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages<span class="token comment"># 安装指定版本的docker-ce: (VERSION=19.03.5~3-0~ubuntu-bionic)</span><span class="token comment"># wang@roxn:/etc/apt$ sudo apt-get -y install docker-ce=[VERSION]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="安装和校验"><a href="#安装和校验" class="headerlink" title="安装和校验"></a><font size=5><strong>安装和校验</strong></font></h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wang@roxn:~$ <span class="token function">sudo</span> <span class="token function">docker</span> version   <span class="token comment"># 查看docker-ce版本</span>Client: Docker Engine - Community Version:           <span class="token number">19.03</span>.5 API version:       <span class="token number">1.40</span> Go version:        go1.12.12 Git commit:        633a0ea838 Built:             Wed Nov <span class="token number">13</span> 07:29:52 <span class="token number">2019</span> OS/Arch:           linux/amd64 Experimental:      <span class="token boolean">false</span>Server: Docker Engine - Community Engine:  Version:          <span class="token number">19.03</span>.5  API version:      <span class="token number">1.40</span> <span class="token punctuation">(</span>minimum version <span class="token number">1.12</span><span class="token punctuation">)</span>  Go version:       go1.12.12  Git commit:       633a0ea838  Built:            Wed Nov <span class="token number">13</span> 07:28:22 <span class="token number">2019</span>  OS/Arch:          linux/amd64  Experimental:     <span class="token boolean">false</span> containerd:  Version:          <span class="token number">1.2</span>.10  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339 runc:  Version:          <span class="token number">1.0</span>.0-rc8+dev  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657 docker-init:  Version:          <span class="token number">0.18</span>.0  GitCommit:        fec3683<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="centos-7-安装docker-ce"><a href="#centos-7-安装docker-ce" class="headerlink" title="centos 7 安装docker-ce"></a>centos 7 安装docker-ce</h1><h2 id="关闭firewalld和selinux"><a href="#关闭firewalld和selinux" class="headerlink" title="关闭firewalld和selinux"></a>关闭firewalld和selinux</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl stop firewalldsystemctl disable firewalldsetenforce <span class="token number">0</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/enforcing$/disabled/g'</span> /etc/selinux/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="增加aliyun-dockeryum源"><a href="#增加aliyun-dockeryum源" class="headerlink" title="增加aliyun dockeryum源"></a>增加aliyun dockeryum源</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="安装启动"><a href="#安装启动" class="headerlink" title="安装启动"></a>安装启动</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum makecache fast   <span class="token comment"># 建立缓存</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce<span class="token function">service</span> <span class="token function">docker</span> start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="docker-pull加速"><a href="#docker-pull加速" class="headerlink" title="docker pull加速"></a>docker pull加速</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'&#123;  "registry-mirrors": ["https://fogd2pyo.mirror.aliyuncs.com"]&#125;EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="重启docker"><a href="#重启docker" class="headerlink" title="重启docker"></a>重启docker</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl daemon-reload   <span class="token comment"># 加载配置</span>systemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18 安装</title>
      <link href="/posts/cfa70856.html"/>
      <url>/posts/cfa70856.html</url>
      
        <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote><p>约定</p></blockquote><p>VMware 版本 15.5.1 <a href="https://my.vmware.com/cn/web/vmware/details?downloadGroup=WKST-1551-WIN&productId=799&rPId=39513" title="VMware版本15.5.1 build-15018445">build-15018445</a></p><p>Ubuntu18 版本 <a href="http://mirror.bytemark.co.uk/ubuntu-releases/18.04.3/ubuntu-18.04.3-live-server-amd64.iso" title="ubuntu-18.04.3-live-server-amd64.iso">ubuntu-18.04.3-live-server-amd64</a></p><blockquote><p>新建虚拟机,选择典型<br><img src="/medias/img/ubuntu/0.jpg"></p></blockquote><blockquote><p>选择下载好的Ubuntu18-server镜像<br><img src="/medias/img/ubuntu/1.jpg"></p></blockquote><blockquote><p>个性化(用户名密码)<br><img src="/medias/img/ubuntu/2.jpg"></p></blockquote><blockquote><p>安装位置,和虚拟机名称<br><img src="/medias/img/ubuntu/3.jpg"></p></blockquote><blockquote><p>磁盘选择20G,存储为单个文件<br><img src="/medias/img/ubuntu/4.jpg"></p></blockquote><blockquote><p>点击完成<br><img src="/medias/img/ubuntu/5.jpg"></p></blockquote><blockquote><p>开机设置,设置使用英语<br><img src="/medias/img/ubuntu/6.jpg"></p></blockquote><blockquote><p>键盘默认,不用改<br><img src="/medias/img/ubuntu/7.jpg"></p></blockquote><blockquote><p>选定网卡,选择IPv4<br><img src="/medias/img/ubuntu/8.jpg"></p></blockquote><blockquote><p>设置Manual<br><img src="/medias/img/ubuntu/9.jpg"></p></blockquote><blockquote><p>填入自己的IP,网关等.<br><img src="/medias/img/ubuntu/10.jpg"></p></blockquote><blockquote><p>我的如下<br><img src="/medias/img/ubuntu/11.jpg"></p></blockquote><blockquote><p>查询自己的信息</p></blockquote><p>在VMware编辑里面,选择NAT模式,进入NAT设置,查看网关信息.依据此,填写自己的IP和网关.<br><img src="/medias/img/ubuntu/12.jpg"></p><blockquote><p>填完效果如下<br><img src="/medias/img/ubuntu/13.jpg"></p></blockquote><blockquote><p>代理跳过,不设置<br><img src="/medias/img/ubuntu/14.jpg"></p></blockquote><blockquote><p>修改为阿里云apt源<br><img src="/medias/img/ubuntu/15.jpg"></p></blockquote><blockquote><p>选择安装磁盘<br><img src="/medias/img/ubuntu/16.jpg"></p></blockquote><blockquote><p>直接回车<br><img src="/medias/img/ubuntu/17.jpg"></p></blockquote><blockquote><p>分好的区<br>20G磁盘没有必要自定义分区,<strong>服务器安装请勿参考此分区.</strong><br><img src="/medias/img/ubuntu/18.jpg"></p></blockquote><blockquote><p>选择格式化<br><img src="/medias/img/ubuntu/19.jpg"></p></blockquote><blockquote><p>填入姓名,主机名,密码<br><img src="/medias/img/ubuntu/20.jpg"></p></blockquote><blockquote><p>选择安装OpenSSH<br><img src="/medias/img/ubuntu/21.jpg"></p></blockquote><blockquote><p>跳过,直接Done<br><img src="/medias/img/ubuntu/22.jpg"></p></blockquote><blockquote><p>等待安装,View full log可以查看安装日志<br><img src="/medias/img/ubuntu/23.jpg"></p></blockquote><blockquote><p>重启,完成安装<br><img src="/medias/img/ubuntu/24.jpg"></p></blockquote><blockquote><p>用户名,密码登录<br><img src="/medias/img/ubuntu/25.jpg"></p></blockquote><blockquote><p>会打印启动日志,覆盖掉登录窗口,直接回车显示登录信息<br><img src="/medias/img/ubuntu/26.jpg"></p></blockquote><blockquote><p>开机设置,root密码,SSH远程登录</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置root密码</span>wang@roxn:~$ <span class="token function">sudo</span> <span class="token function">passwd</span> <span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> wang:    <span class="token comment"># 当前用户密码</span>Enter new UNIX password:    <span class="token comment"># 新root密码</span>Retype new UNIX password:    <span class="token comment"># 再次输入</span>passwd: password updated successfullywang@roxn:~$ <span class="token function">sudo</span> <span class="token function">vi</span> /etc/ssh/sshd_config<span class="token comment"># 揭开注释 &amp; 修改以下两行内容</span>Port <span class="token number">22</span>PermitRootLogin <span class="token function">yes</span>wang@roxn:~$ <span class="token function">sudo</span> <span class="token function">service</span> sshd restart   <span class="token comment"># 重启sshd服务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开xshell尝试链接吧!</p><h2 id="安装后优化"><a href="#安装后优化" class="headerlink" title="安装后优化"></a>安装后优化</h2><p>此文章在Ubuntu 20.04 LTS Desktop验证通过。</p><p>不建议修改过多系统项，以免引起系统稳定性。</p><blockquote><p>安装openssh</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-serversystemctl start sshd<span class="token comment"># 按提示输入密码</span><span class="token comment"># xhsell链接</span><span class="token function">ssh</span> username@IP<span class="token comment"># ssh username:password@ip:port</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>修改apt为阿里云源</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.backup<span class="token function">sudo</span> <span class="token function">vi</span> /etc/apt/sources.list<span class="token comment">###</span>deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse<span class="token comment">###</span><span class="token function">sudo</span> <span class="token function">apt</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>vim安装</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">vim</span><span class="token function">sudo</span> <span class="token function">vi</span> /etc/profile<span class="token comment">### 增加</span><span class="token builtin class-name">alias</span> <span class="token assign-left variable">vi</span><span class="token operator">=</span>vim<span class="token comment">### source 文件生效</span><span class="token function">vi</span> /etc/vim/vimrc<span class="token comment">### 增加显示行号、tab设置4个空格</span><span class="token builtin class-name">set</span> number<span class="token builtin class-name">set</span> <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">4</span><span class="token builtin class-name">set</span> expandtab<span class="token builtin class-name">set</span> autoindent<span class="token comment">### 立即生效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>root权限</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user@user-virtual-machine:~$ <span class="token function">sudo</span> <span class="token function">passwd</span>新的 密码： 重新输入新的 密码： passwd：已成功更新密码user@user-virtual-machine:~$ <span class="token function">su</span> - root密码： root@user-virtual-machine:~<span class="token comment"># </span><span class="token comment"># 允许root远程登录</span><span class="token function">vi</span> /etc/ssh/sshd_config<span class="token comment">###</span>PermitRootLogin <span class="token function">yes</span><span class="token comment">###</span>systemctl restart sshd<span class="token comment"># 验证</span><span class="token punctuation">[</span>C:<span class="token punctuation">\</span>~<span class="token punctuation">]</span>$ <span class="token function">ssh</span> root:1@192.168.1.12<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>bash修改</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token parameter variable">-al</span> /bin/sh<span class="token comment"># lrwxrwxrwx 1 root root 4 7月  27 17:20 /bin/sh -> dash</span>dpkg-reconfigure dash   <span class="token comment"># 选择 否/No</span><span class="token comment"># 正在删除 通过 dash 从 /bin/sh 到 /bin/sh.distrib 的转移</span><span class="token comment"># 正在添加 通过 bash 从 /bin/sh 到 /bin/sh.distrib 的转移</span><span class="token comment"># 正在删除 通过 dash 从 /usr/share/man/man1/sh.1.gz 到 /usr/share/man/man1/sh.distrib.1.gz 的转移</span><span class="token comment"># 正在添加 通过 bash 从 /usr/share/man/man1/sh.1.gz 到 /usr/share/man/man1/sh.distrib.1.gz 的转移</span><span class="token function">ls</span> <span class="token parameter variable">-al</span> /bin/sh<span class="token comment"># lrwxrwxrwx 1 root root 4 7月  28 17:02 /bin/sh -> bash</span><span class="token function">vi</span> .bashrc <span class="token comment"># PS1="\[\e]0;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h: \w\a\]$PS1" 修改为 PS1="[\u@\h \W]\\$ "</span><span class="token comment"># bash 生效，centos风格</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>apache2</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> apache2 <span class="token function">curl</span>systemctl start apache2update-rc.d <span class="token parameter variable">-f</span> apache2 defaults   <span class="token comment"># 开机自启</span><span class="token builtin class-name">echo</span> <span class="token string">"apache2 test page"</span> <span class="token operator">></span> /var/www/html/index.html <span class="token function">curl</span> localhost<span class="token comment"># apache2 test page</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>python3</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认安装python3.8</span><span class="token function">apt</span> <span class="token function">install</span> python3-pippython3 <span class="token parameter variable">-V</span><span class="token comment"># Python 3.8.2</span>pip3 <span class="token parameter variable">-V</span><span class="token comment"># pip 20.0.2 from /usr/lib/python3/dist-packages/pip (python 3.8)</span><span class="token function">mkdir</span> .pip<span class="token function">vi</span> .pip/pip.conf   <span class="token comment"># 配置pip阿里云源</span><span class="token comment">###</span><span class="token punctuation">[</span>global<span class="token punctuation">]</span>index-url <span class="token operator">=</span> http://mirrors.aliyun.com/pypi/simple/trusted-host <span class="token operator">=</span> mirrors.aliyun.com<span class="token comment">###</span>pip3 <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip   <span class="token comment"># 安装升级pip</span>pip <span class="token parameter variable">-V</span><span class="token comment"># pip 20.1.1 from /usr/local/lib/python3.8/dist-packages/pip (python 3.8)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>java</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> default-jre default-jdk   <span class="token comment"># 安装默认版本</span><span class="token function">apt</span> <span class="token function">install</span> openjdk-8-jdk openjdk-8-jre   <span class="token comment"># 安装指定版本</span><span class="token function">java</span> <span class="token parameter variable">-version</span>   <span class="token comment"># java默认版本</span><span class="token comment"># openjdk version "11.0.8" 2020-07-14</span><span class="token comment"># OpenJDK Runtime Environment (build 11.0.8+10-post-Ubuntu-0ubuntu120.04)</span><span class="token comment"># OpenJDK 64-Bit Server VM (build 11.0.8+10-post-Ubuntu-0ubuntu120.04, mixed mode, sharing)</span>javac <span class="token parameter variable">-version</span>   <span class="token comment"># javac默认版本</span><span class="token comment"># javac 11.0.8</span>update-alternatives <span class="token parameter variable">--config</span> <span class="token function">java</span>   <span class="token comment"># 设置默认java</span><span class="token comment"># 有 2 个候选项可用于替换 java (提供 /usr/bin/java)。</span><span class="token comment">#   选择       路径                                          优先级  状态</span><span class="token comment"># ------------------------------------------------------------</span><span class="token comment"># * 0            /usr/lib/jvm/java-11-openjdk-amd64/bin/java      1111      自动模式</span><span class="token comment">#   1            /usr/lib/jvm/java-11-openjdk-amd64/bin/java      1111      手动模式</span><span class="token comment">#   2            /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java   1081      手动模式</span><span class="token comment"># 要维持当前值[*]请按&lt;回车键>，或者键入选择的编号：2</span><span class="token comment"># update-alternatives: 使用 /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java 来在手动模式中提供 /usr/bin/java (java)</span>update-alternatives <span class="token parameter variable">--config</span> javac   <span class="token comment"># 设置默认javac</span><span class="token comment"># 有 2 个候选项可用于替换 javac (提供 /usr/bin/javac)。</span><span class="token comment">#   选择       路径                                        优先级  状态</span><span class="token comment"># ------------------------------------------------------------</span><span class="token comment"># * 0            /usr/lib/jvm/java-11-openjdk-amd64/bin/javac   1111      自动模式</span><span class="token comment">#   1            /usr/lib/jvm/java-11-openjdk-amd64/bin/javac   1111      手动模式</span><span class="token comment">#   2            /usr/lib/jvm/java-8-openjdk-amd64/bin/javac    1081      手动模式</span><span class="token comment"># 要维持当前值[*]请按&lt;回车键>，或者键入选择的编号：2</span><span class="token comment"># update-alternatives: 使用 /usr/lib/jvm/java-8-openjdk-amd64/bin/javac 来在手动模式中提供 /usr/bin/javac (javac)</span>javac <span class="token parameter variable">-version</span>   <span class="token comment"># 验证</span><span class="token comment"># javac 1.8.0_252</span><span class="token function">java</span> <span class="token parameter variable">-version</span>   <span class="token comment"># 验证</span><span class="token comment"># openjdk version "1.8.0_252"</span><span class="token comment"># OpenJDK Runtime Environment (build 1.8.0_252-8u252-b09-1ubuntu1-b09)</span><span class="token comment"># OpenJDK 64-Bit Server VM (build 25.252-b09, mixed mode)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Anolis 7</title>
      <link href="/posts/a463e511.html"/>
      <url>/posts/a463e511.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>注意：</strong>此段脚本可能不好用了，简单修改一下还能使。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env sh</span><span class="token comment"># @File    :   init.sh</span><span class="token comment"># @Time    :   2021/12/06 15:41:17</span><span class="token comment"># @Author  :   Roxn</span><span class="token comment"># @Email   :   158970251@qq.com</span><span class="token comment"># @Software:   VS Code</span><span class="token comment"># 操作日志存放路径</span><span class="token comment"># log file</span><span class="token assign-left variable">log</span><span class="token operator">=</span><span class="token string">"/home/logs/init.log"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-e</span> <span class="token variable">$log</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $log <span class="token operator">|</span> <span class="token function">awk</span> -F/ <span class="token string">'&#123;$NF=""; print $0&#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s! !/!g'</span><span class="token variable">)</span></span>  <span class="token function">touch</span> <span class="token variable">$log</span><span class="token keyword">fi</span><span class="token comment"># 如果执行过程中有错误信息均输出到日志文件中</span><span class="token comment"># ex: 2>&amp;1</span><span class="token assign-left variable">fsize</span><span class="token operator">=</span><span class="token number">2000000</span><span class="token builtin class-name">exec</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token comment"># 日志函数</span><span class="token comment"># 参数</span><span class="token comment"># 参数一，级别：INFO WARN ERROR</span><span class="token comment"># 参数二，内容</span><span class="token comment"># 返回值</span><span class="token comment"># Parameter level: INFO WARN ERROR</span><span class="token comment"># Parameter content</span><span class="token comment"># return</span><span class="token keyword">function</span> <span class="token function-name function">rose_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment"># local curtime</span>  <span class="token assign-left variable">curtime</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%F %T"</span><span class="token variable">)</span></span>  <span class="token comment"># local cursize</span>  <span class="token assign-left variable">cursize</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $log <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-c</span><span class="token variable">)</span></span>  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$fsize</span> <span class="token parameter variable">-lt</span> <span class="token variable">$cursize</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token function">mv</span> <span class="token variable">$&#123;log&#125;</span><span class="token punctuation">&#123;</span>,.<span class="token variable">$&#123;curtime&#125;</span><span class="token punctuation">&#125;</span>     <span class="token function">touch</span> <span class="token variable">$log</span>  <span class="token keyword">fi</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">INFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  rose_log  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">WARN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  rose_log  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[33mWARN<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">ERROR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  rose_log  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$curtime</span> <span class="token entity" title="\033">\033</span>[31mERROR<span class="token entity" title="\033">\033</span>[0m <span class="token variable">$*</span>"</span> <span class="token operator">>></span> <span class="token variable">$log</span><span class="token punctuation">&#125;</span><span class="token assign-left variable">workdir</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span><span class="token comment"># echo "--- chekck /etc/redhat-release ---"</span><span class="token comment"># if test ! -e /etc/redhat-release; then echo -e "\033[31m /etc/redhat-release\033[0m not found." &amp;&amp; exit 1; fi</span><span class="token comment"># Jnum=$(cat /etc/redhat-release | awk '&#123;print $(NF-1)&#125;')</span><span class="token comment"># if test $Jnum != 7.9.2009; then echo -e "Scripts only support \033[32mcentos7\033[0m" &amp;&amp; exit 1; else echo -e "Centos7 \033[32mtrue\033[0m"; fi</span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token operator">!</span> <span class="token parameter variable">-e</span> /etc/redhat-release<span class="token punctuation">;</span> <span class="token keyword">then</span>    ERROR <span class="token string">"<span class="token entity" title="\033">\033</span>[31m/etc/redhat-release<span class="token entity" title="\033">\033</span>[0m not found."</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token assign-left variable">Jnum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/redhat-release <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $(NF-1)&#125;'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d. <span class="token parameter variable">-f1</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token variable">$Jnum</span> <span class="token operator">!=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    WARN <span class="token string">"Scripts only support <span class="token entity" title="\033">\033</span>[33mcentos7<span class="token entity" title="\033">\033</span>[0m"</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">else</span>    INFO <span class="token string">"Centos7 <span class="token entity" title="\033">\033</span>[32mtrue<span class="token entity" title="\033">\033</span>[0m"</span><span class="token keyword">fi</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- install package &amp;&amp; update ---"</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> lrzsz <span class="token function">vim</span> <span class="token function">wget</span> epel-release ntp <span class="token operator">>></span> /dev/null<span class="token comment"># yum update -y >> /dev/null</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- close selinux &amp; firewald ---"</span><span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/configsetenforce <span class="token number">0</span>systemctl stop firewalldsystemctl disable firewalld<span class="token comment"># reboot</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- set sshd &amp; vim &amp; profile ---"</span><span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'/#UseDNS/a UseDNS\ no'</span> /etc/ssh/sshd_configsystemctl restart sshd<span class="token builtin class-name">echo</span> <span class="token string">'alias vi=vim'</span> <span class="token operator">>></span> /etc/profile<span class="token function">cat</span> <span class="token operator">>></span> /root/.vimrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFset tabstop=4set shiftwidth=4set expandtabset numberset pastetoggle=&lt;F9>set pasteEOF</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- set sysctl.conf ---"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF# 开启SYN Cookies，当SYN等待队列溢出时，启用cookies来处理，可以防范少量的SYN攻击，默认为0，表示关闭net.ipv4.tcp_syncookies = 1# 允许将TIME_WAIT sockets重新用于新的TCP连接，默认为0，表示关闭net.ipv4.tcp_tw_reuse = 1# 允许将TIME_WAIT sockets快速回收以便利用，默认为0，表示关闭，需要同时开启 net.ipv4.tcp_timestamps 才能生效net.ipv4.tcp_tw_recycle = 1net.ipv4.tcp_timestamps = 1  # 默认为1# 同时开启同造成TCP服务端收到syn但是不回复syn ack，不建议同时开启# 如果客户端处于NAT的网络(多个客户端，同一个IP出口的网络环境)，如果配置了tw_recycle# 就可能在一个RTO的时间内，只能有一个客户端和自己连接成功# 设置TCP三次请求的fin状态超时net.ipv4.tcp_fin_timeout = 30# 设置TCP 发送keepalive的频度，默认的缺省为2小时，600秒表示10分钟，表示服务器以10分钟发送keepalive消息net.ipv4.tcp_keepalive_time = 600# 探测包发送的时间间隔设置为2秒，默认75秒net.ipv4.tcp_keepalive_intvl = 2# 如果对方不给予应答，探测包发送的次数，默认9次net.ipv4.tcp_keepalive_probes = 2# 设置本地端口范围，缺省情况下：32768到61000，现在改为 1024 到 65000，最小值不能设置太低,否则占用了正常端口net.ipv4.ip_local_port_range = 1024 65000# 表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多的网络连接数net.ipv4.tcp_max_syn_backlog = 8192# 设置保持TIME_WAIT的最大数量，如果超过这个数量，TIME_WAIT将立刻清楚并打印警告信息，默认为180000，改为5000.此项参数可以控制TIME_WAIT的最大数量,避免Squid服务器被大量的TIME_WAIT拖死net.ipv4.tcp_max_tw_buckets = 5000# 表示SYN队列的长度，选项为服务器端用于记录那些尚未收到客户端确认信息的连接请求的最大值，该参数对应系统路径为：/proc/sys/net/ipv4/tcp_max_syn_backlognet.ipv4.tcp_max_syn_backlog = 4096# 增加tcp缓冲区大小，tcp_rmem表示接受数据缓冲区范围，tcp_wmem表示发送数据缓冲区范围，单位Byte，最大64Mnet.ipv4.tcp_rmem = 4096 87380 67108864net.ipv4.tcp_wmem = 4096 65536 67108864# TCP失败重传次数,默认值15，意味着重传15次才彻底放弃，可减少到5，以尽早释放内核资源net.ipv4.tcp_retries2 = 5# 选项默认值是128，这个参数用于调节系统同时发起的tcp连接数，在高并发请求中，默认的值可能会导致连接超时或重传，因此，需要结合并发请求数来调节此值。该参数对应系统路径为：/proc/sys/net/core/somaxconn 128net.core.somaxconn = 4096# 启用timewait 快速回收net.ipv4.tcp_tw_recycle = 1EOF</span><span class="token function">sysctl</span> <span class="token parameter variable">-p</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- set ntp server ---"</span>/usr/sbin/ntpdate ntp.ntsc.ac.cn<span class="token builtin class-name">echo</span> <span class="token string">"*/30 * * * * /usr/sbin/ntpdate ntp.ntsc.ac.cn > /dev/null 2>&amp;1"</span> <span class="token operator">>></span> /var/spool/cron/root<span class="token builtin class-name">echo</span> <span class="token string">"alias ntp='/usr/sbin/ntpdate ntp.ntsc.ac.cn'"</span> <span class="token operator">>></span> /etc/profile.d/ntp.shtimedatectl set-timezone Asia/Shanghai/usr/sbin/hwclock <span class="token parameter variable">--systohc</span>/usr/sbin/hwclock <span class="token parameter variable">-w</span><span class="token function">chmod</span> <span class="token number">600</span> /var/spool/cron/rootsystemctl <span class="token builtin class-name">enable</span> ntpd <span class="token operator">&amp;&amp;</span> systemctl start ntpdsystemctl restart crond.servicerose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- set limits.conf ---"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF* soft nofile 190000* hard nofile 200000* soft nproc 252144* hadr nproc 262144EOF</span>rose_log <span class="token string">"<span class="token entity" title="\033">\033</span>[32mINFO<span class="token entity" title="\033">\033</span>[0m --- set history ---"</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/bashrc <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTFILESIZE=10000000HISTSIZE=200HISTTIMEFORMAT='%F %T 'export HISTTIMEFORMATEOF</span><span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span> <span class="token string">EOFHISTSIZE=200PROMPT_COMMAND="history -a"shopt -s histappendEOF</span><span class="token builtin class-name">source</span> /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> anolis </tag>
            
            <tag> 系统优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WeChat</title>
      <link href="/posts/33b986e9.html"/>
      <url>/posts/33b986e9.html</url>
      
        <content type="html"><![CDATA[<h1 id="注册一个企业微信"><a href="#注册一个企业微信" class="headerlink" title="注册一个企业微信"></a>注册一个企业微信</h1><p><a href="https://work.weixin.qq.com/">企业微信注册</a>，个人用户就行，不需要企业认证。</p><p>需要<code>企业ID</code>、<code>Agentid</code>、<code>Secret</code>，普通微信<code>扫码关注</code>企业微信</p><h2 id="创建一个新的机器人"><a href="#创建一个新的机器人" class="headerlink" title="创建一个新的机器人"></a>创建一个新的机器人</h2><p>应用管理–应用–创建应用<br><img src="/medias/img/wujiops/wechat/3.png"></p><h2 id="查看机器人Agentid和Secret"><a href="#查看机器人Agentid和Secret" class="headerlink" title="查看机器人Agentid和Secret"></a>查看机器人<code>Agentid</code>和<code>Secret</code></h2><p>应用管理–应用–点击你创建的机器人，其中<code>Secret</code>只能在<code>企业微信</code>中查看，需要下载安装<code>企业微信</code><br><img src="/medias/img/wujiops/wechat/2.png"></p><h2 id="查看企业ID"><a href="#查看企业ID" class="headerlink" title="查看企业ID"></a>查看企业ID</h2><p>我的企业–企业信息–企业ID<br><img src="/medias/img/wujiops/wechat/0.png"></p><h2 id="关注企业微信"><a href="#关注企业微信" class="headerlink" title="关注企业微信"></a>关注企业微信</h2><p>普通微信扫码关注企业微信，企业微信获取到<code>Secret</code>后，可以卸载企业微信，以后通过关注的企业微信接收消息。</p><p>扫码关注企业微信后，需要在机器人管理界面，点击编辑<code>可见范围</code>，选中刚才关注的微信号即可。后续其他微信接收消息只要关注了企业微信后，再将关注人添加到<code>可见范围</code>即可<br><img src="/medias/img/wujiops/wechat/1.png"></p><h1 id="编写告警应用"><a href="#编写告警应用" class="headerlink" title="编写告警应用"></a>编写告警应用</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- encoding: utf-8 -*-</span><span class="token triple-quoted-string string">'''@File    :   wechat.py@Time    :   2021/11/25 22:40:56@Author  :   Roxn@Email   :   158970251@qq.com@Software:   VS Code'''</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> json<span class="token keyword">import</span> sys<span class="token keyword">from</span> time <span class="token keyword">import</span> strftime<span class="token punctuation">,</span> localtime<span class="token keyword">from</span> base64 <span class="token keyword">import</span> encodelocaltime <span class="token operator">=</span> strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token keyword">class</span> <span class="token class-name">Weixin</span><span class="token punctuation">:</span>       <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>corpid<span class="token punctuation">,</span>secret<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>token <span class="token operator">=</span> <span class="token string">'https://qyapi.weixin.qq.com/cgi-bin/gettoken'</span>        self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'https://qyapi.weixin.qq.com/cgi-bin/message/send'</span>        self<span class="token punctuation">.</span>corpid <span class="token operator">=</span> corpid        self<span class="token punctuation">.</span>secret <span class="token operator">=</span> secret    <span class="token keyword">def</span> <span class="token function">get_token</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        param <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'corpid'</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>corpid<span class="token punctuation">,</span><span class="token string">'corpsecret'</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>secret<span class="token punctuation">&#125;</span>        request <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>token<span class="token punctuation">,</span>params<span class="token operator">=</span>param<span class="token punctuation">)</span>        <span class="token keyword">if</span> request<span class="token punctuation">.</span>status_code <span class="token operator">==</span> requests<span class="token punctuation">.</span>codes<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>            response <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span>            <span class="token keyword">return</span> response    <span class="token keyword">def</span> <span class="token function">send_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>        param <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'access_token'</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>get_token<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>        message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token string">"touser"</span><span class="token punctuation">:</span> <span class="token string">"@all"</span><span class="token punctuation">,</span>            <span class="token comment"># "touser": user, # 给某个用户发消息，使用方法: wechat user</span>            <span class="token string">"toparty"</span><span class="token punctuation">:</span> <span class="token string">"@all"</span><span class="token punctuation">,</span>            <span class="token string">"totag"</span><span class="token punctuation">:</span> <span class="token string">"@all"</span><span class="token punctuation">,</span>            <span class="token string">"msgtype"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>            <span class="token string">"agentid"</span><span class="token punctuation">:</span> <span class="token number">1000002</span><span class="token punctuation">,</span> <span class="token comment"># 填写Agentid</span>            <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>content<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token string">"safe"</span><span class="token punctuation">:</span> <span class="token number">0</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># 将文本内容json化，以符合接口标准</span>        send_data <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span>        request <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>message<span class="token punctuation">,</span>params<span class="token operator">=</span>param<span class="token punctuation">,</span>data<span class="token operator">=</span>send_data<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># user = sys.argv[1]</span>    <span class="token comment"># 这里是要发送的告警内容的文本</span>    path <span class="token operator">=</span> <span class="token string">'/tmp/txt'</span>    <span class="token comment"># 对脚本传参，以读取不同的文件</span>    <span class="token comment"># path = '/home/package/' + sys.argv[1] + '/.txt1'</span>    <span class="token comment"># if len(sys.argv) == 3:</span>    <span class="token comment">#     path = '/home/package/' + sys.argv[1] + '/.txt2'</span>    <span class="token comment">#     if sys.argv[2] == 'build':</span>    <span class="token comment">#         path = '/home/package/' + sys.argv[1] + '/.txt3'</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> localtime <span class="token operator">+</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token comment"># 填入&lt;企业ID>和&lt;Secret></span>    weixin <span class="token operator">=</span> Weixin<span class="token punctuation">(</span><span class="token string">'&lt;企业ID>'</span><span class="token punctuation">,</span><span class="token string">'&lt;Secret>'</span><span class="token punctuation">)</span>    weixin<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="对应用打包"><a href="#对应用打包" class="headerlink" title="对应用打包"></a>对应用打包</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装打包程序pyinstaller</span>pip <span class="token function">install</span> requests pyinstaller tinyaes<span class="token comment"># 加入随机密钥反反编译</span>pyinstaller <span class="token parameter variable">-D</span> <span class="token parameter variable">-F</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">"&lt;随机密钥>"</span> <span class="token parameter variable">--clean</span> wechat.py<span class="token comment"># 全局使用wechat </span><span class="token function">cp</span> dist/wechat /usr/bin/<span class="token comment"># 编辑文件</span><span class="token builtin class-name">echo</span> <span class="token string">"test"</span> <span class="token operator">></span> /tmp/txt<span class="token comment"># 执行告警脚本</span>wechat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wechat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible</title>
      <link href="/posts/c5cc7aa1.html"/>
      <url>/posts/c5cc7aa1.html</url>
      
        <content type="html"><![CDATA[<h1 id="ansible简介"><a href="#ansible简介" class="headerlink" title="ansible简介"></a>ansible简介</h1><h2 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h2><blockquote><p>文件传输<br>命令执行</p><blockquote><p>应用部署<br>配置管理<br>任务流编排</p></blockquote></blockquote><h2 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h2><ol><li><p>ansible：基于python开发，agentless一般不需要代理，需要ssh连接基于key验证是基本，中小型应用环境（主机数量 &lt; 300 台）</p></li><li><p>saltstack：基于python开发，一般需部署agent，执行效率更高</p></li><li><p>puppet：基于ruby开发，功能强大，配置复杂，适合大型环境</p></li><li><p>fabric、chef、cfengine、func等</p></li></ol><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><blockquote><p>模块化：调用特定的模块，完成特定任务<br>有Paramiko，PyYAML，Jinja2（模板语言）三个关键模块<br>支持自定义模块<br>基于Python语言实现<br>部署简单，基于python和SSH（默认已安装），agentless<br>安全，基于OpenSSH<br>支持playbook编排任务<br>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况<br>无需代理不依赖PKI（无需ssl）<br>可使用任何编程语言写模块<br>YAML格式，编排任务，支持丰富的数据结构<br>较强大的多层解决方案</p></blockquote><h2 id="ansible-playbook（剧本）执行过程："><a href="#ansible-playbook（剧本）执行过程：" class="headerlink" title="ansible-playbook（剧本）执行过程："></a>ansible-playbook（剧本）执行过程：</h2><ol><li><p>将已有编排好的任务集写入ansible-playbook</p></li><li><p>通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐条执行</p></li></ol><h2 id="Ansible主要操作对象："><a href="#Ansible主要操作对象：" class="headerlink" title="Ansible主要操作对象："></a>Ansible主要操作对象：</h2><ol><li><p>hosts主机</p></li><li><p>NETWORKING网络设备</p></li></ol><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li><p>执行ansible的主机一般称为主控端，中控，master或堡垒机</p></li><li><p>主控端Python版本需要2.6或以上</p></li><li><p>被控端Python版本小于2.4需要安装python-simplejson</p></li><li><p>被控端如开启SELinux需要安装libselinux-python</p></li><li><p>windows不能做为主控端</p></li></ol><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># rpm包安装:EPEL源</span>yum <span class="token function">install</span> ansible <span class="token parameter variable">-y</span><span class="token comment"># 编译安装:</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> python-jinja2 PyYAML python-paramiko python-babel python-crypto<span class="token function">tar</span> xf ansible-1.5.4.tar.gz<span class="token builtin class-name">cd</span> ansible-1.5.4python setup.py buildpython setup.py <span class="token function">install</span><span class="token function">mkdir</span> /etc/ansiblecp-r examples/* /etc/ansible<span class="token comment"># Git方式:</span><span class="token function">git</span> clone git://github.com/ansible/ansible.git <span class="token parameter variable">--recursive</span><span class="token builtin class-name">cd</span> ./ansible<span class="token builtin class-name">source</span> ./hacking/env-setup<span class="token comment"># pip安装:pip是安装Python包的管理器，类似yum</span>yum <span class="token function">install</span> python-pip python-develyum <span class="token function">install</span> gcc glibc-devel zibl-devel rpm-bulid openssl-develpip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pippip <span class="token function">install</span> ansible <span class="token parameter variable">--upgrade</span><span class="token comment"># 确认安装:</span>ansible <span class="token parameter variable">--version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg   # 主配置文件，配置ansible工作特性&#x2F;etc&#x2F;ansible&#x2F;hosts   # 主机清单&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;   # 存放角色的目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;usr&#x2F;bin&#x2F;ansible   # 主程序，临时命令执行工具&#x2F;usr&#x2F;bin&#x2F;ansible-doc   # 查看配置文档，模块功能查看工具&#x2F;usr&#x2F;bin&#x2F;ansible-galaxy   # 下载&#x2F;上传优秀代码或Roles模块的官网平台&#x2F;usr&#x2F;bin&#x2F;ansible-playbook   # 定制自动化任务，编排剧本工具&#x2F;usr&#x2F;bin&#x2F;ansible-pull   # 远程执行命令的工具&#x2F;usr&#x2F;bin&#x2F;ansible-vault   # 文件加密工具&#x2F;usr&#x2F;bin&#x2F;ansible-console   # 基于console界面与用户交互的执行工具<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h2><p>Inventory主机清单</p><p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p><p>默认的inventory file为 <code>/etc/ansible/hosts</code> </p><p>inventory file可以有多个，且也可以通过 <code>Dynamic Inventory</code> 来动态生成</p><h3 id="etc-ansible-hosts文件格式"><a href="#etc-ansible-hosts文件格式" class="headerlink" title="/etc/ansible/hosts文件格式"></a>/etc/ansible/hosts文件格式</h3><p>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</p><pre class="line-numbers language-hosts" data-language="hosts"><code class="language-hosts">ntp.magedu.com[webservers]www1.magedu.com:2222www2.magedu.com[dbservers]db1.magedu.comdb2.magedu.comdb3.magedu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</p><p>示例：</p><pre class="line-numbers language-hosts" data-language="hosts"><code class="language-hosts">[webservers]www[01:100].example.com[dbservers]db-[a:f].example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ansible配置文件"><a href="#ansible配置文件" class="headerlink" title="ansible配置文件"></a>ansible配置文件</h2><p>Ansible配置文件<code>/etc/ansible/ansible.cfg</code> （一般保持默认）</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">[defaults]#inventory &#x3D; &#x2F;etc&#x2F;ansible&#x2F;hosts   # 主机列表配置文件#library &#x3D; &#x2F;usr&#x2F;share&#x2F;my_modules&#x2F;   # 库文件存放目录#remote_tmp &#x3D; $HOME&#x2F;.ansible&#x2F;tmp   # 临时py命令文件存放在远程主机目录#local_tmp&#x3D; $HOME&#x2F;.ansible&#x2F;tmp   # 本机的临时命令执行目录#forks&#x3D; 5   # 默认并发数#sudo_user&#x3D; root   # 默认sudo用户#ask_sudo_pass &#x3D; True   # 每次执行ansible命令是否询问ssh密码#ask_pass&#x3D; True#remote_port&#x3D; 22#host_key_checking &#x3D; False   # 检查对应服务器的host_key，首次连接不必输入yes&#x2F;no#log_path&#x3D;&#x2F;var&#x2F;log&#x2F;ansible.log   # 日志文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Ansible系列命令"><a href="#Ansible系列命令" class="headerlink" title="Ansible系列命令"></a>Ansible系列命令</h2><p><code>ansible</code>、<code>ansible-doc</code>、<code>ansible-playbook</code>、<code>ansible-vault</code>、<code>ansible-console</code>、<code>ansible-galaxy</code>、<code>ansible-pull</code></p><p><code>ansible-doc</code>：显示模块帮助</p><p><code>ansible-doc [options] [module...]</code></p><p><code>-a</code>&emsp;# 显示所有模块的文档</p><p><code>-l</code>, <code>--list</code>&emsp;# 列出可用模块</p><p><code>-s</code>, <code>--snippet</code>&emsp;# 显示指定模块的playbook片段</p><p>示例：</p><p><code>ansible-doc -l</code>   # 列出所有模块</p><p><code>ansible-doc ping</code>   # 查看指定模块帮助用法</p><p><code>ansible-doc -s ping</code>   # 查看指定模块帮助用法</p><p>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点</p><p><code>ansible &lt;host-pattern&gt; [-m module_name] [-a args]</code></p><p><code>--version</code>   # 显示版本</p><p><code>-m module</code>   # 指定模块，默认为command</p><p><code>-v</code>   # 详细过程<code>-vv</code> <code>-vvv</code>更详细</p><p><code>--list</code>,<code> --list-hosts</code>   # 显示主机列表</p><p><code>-k</code>, <code>--ask-pass</code>   # 提示输入ssh连接密码，默认Key验证</p><p><code>-K</code>, <code>--ask-become-pass</code>   # 提示输入sudo时的口令</p><p><code>-C</code>，<code>--check</code>   # 检查，并不执行</p><p><code>-T</code>，<code>--timeout=TIMEOUT</code>   # 执行命令的超时时间，默认10s</p><p><code>-u</code>，<code>--user=REMOTE_USER</code>   # 执行远程执行的用户</p><p><code>-b</code>,  <code>--become</code>   # 代替旧版的sudo切换</p><h1 id="ansible的host-pattern"><a href="#ansible的host-pattern" class="headerlink" title="ansible的host-pattern"></a>ansible的host-pattern</h1><p>匹配主机的列表</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># all：表示所有inventory中的所有主机</span>ansible all <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># *：通配符</span>ansible <span class="token string">"*"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>ansible <span class="token number">192.168</span>.182.* <span class="token parameter variable">-m</span> <span class="token function">ping</span>ansible <span class="token string">"*cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># 或关系</span>ansible <span class="token string">"ab:cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>ansible <span class="token string">"192.168.182.130:192.168.182.131"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># 逻辑与</span>ansible <span class="token string">"ab:&amp;bcd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># 在ab组并且在bcd组中的主机</span><span class="token comment"># 逻辑非</span>ansible <span class="token string">'ab:!bcd'</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># 在ab组，但不在bcd组中的主机，注意是单引号</span><span class="token comment"># 综合逻辑</span>ansible <span class="token string">'ab:cd:&amp;bcd:!cd'</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span class="token comment"># 正则表达式</span>ansible <span class="token string">"ab:&amp;cd"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span> ansible <span class="token string">"~(b|c)d"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h1><ol><li><p>加载自己的配置文件默认 <code>/etc/ansible/ansible.cfg</code> </p></li><li><p>加载自己对应的模块文件，如  <code>command</code> </p></li><li><p>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户<code>$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</code></p></li><li><p>给文件+x执行</p></li><li><p>执行并返回结果</p></li><li><p>删除临时py文件，<code>sleep 0</code>退出</p></li></ol><p>执行状态（在ansible.cfg配置文件中[colors]可以更改）：</p><blockquote><p><font color=Green>绿色</font>：执行成功并且不需要做改变的操作<br><font color=Yellow>黄色</font>：执行成功并且对目标主机做变更<br><font color=Red>红色</font>：执行失败</p></blockquote><h1 id="ansible使用示例"><a href="#ansible使用示例" class="headerlink" title="ansible使用示例"></a>ansible使用示例</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以wang用户执行ping存活检测</span>ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-k</span><span class="token comment"># 以wang sudo至root执行ping存活检测</span>ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span><span class="token comment"># 以wang sudo至mage用户执行ping存活检测</span>ansible all <span class="token parameter variable">-m</span> ping-u wang <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span> --become-user mage<span class="token comment"># 以wang sudo至root用户执行ls</span>ansible all <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-u</span> wang --become-user<span class="token operator">=</span>root <span class="token parameter variable">-a</span> <span class="token string">'ls /root'</span> <span class="token parameter variable">-b</span> <span class="token parameter variable">-k</span> <span class="token parameter variable">-K</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h2><ol><li>command：在远程主机执行命令，默认模块，可忽略-m选项</li></ol><p><code>ansible ab -m command -a &#39;service vsftpd start&#39;</code> </p><p><code>ansible ab -m command -a &#39;echo magedu | passwd --stdin wang&#39;</code> 不成功</p><p>此命令不支持<code>$VARNAME</code> <code>&lt;</code> <code>&gt;</code> <code>|</code> <code>;</code> <code>&amp;</code>等，用shell模块实现</p><ol start="2"><li>Shell：和command相似，用shell执行命令</li></ol><p><code>ansible ab -m shell -a &#39; &#39;</code> </p><p>调用bash执行命令类似<code>cat /tmp/stanley.md | awk -F&#39;|&#39; &#39;iprint $1,$2&#125;&#39; &amp;&gt; /tmp/example.txt</code>这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</p><ol start="3"><li>Script: 运行脚本</li></ol><p><code>-a &quot;/PATH/TO/SCRIPT_FILE&quot;</code> </p><p><code>snsible abc -m script -a f1.sh</code> </p><ol start="4"><li>Copy：从服务器复制文件到客户端,</li></ol><p><code>ansible bcd -m copy -a &quot;src=/root/host.sh dest=/data/host.sh owner=wang mode=600 backup=yes&quot;</code></p><p>如目标存在，默认覆盖，此处指定先备份(注意：文件未更改则不会备份)</p><p><code>ansible 192.168.182.128 -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/f1.txt&quot;</code>利用内容，直接生成目标文件</p><ol start="5"><li>Fetch：从客户端取文件至服务器端，copy相反，目录可先tar</li></ol><p><code>ansible ab -m fetch -a &#39;src=/root/a.sh dest=/data/scripts&#39;</code></p><p><code>ansible bcd -m shell -a &#39;tar JPcf /var/log/log.txz /var/log/*.log&#39;</code></p><p><code>ansible bcd -m fetch -a &#39;src=/var/log/log.txz dest=/data&#39;</code></p><ol start="6"><li>File：设置文件属性</li></ol><p><code>ansible bcd -m file -a &quot;path=/root/a.sh owner=wang mode=755&quot;</code></p><p><code>ansible bcd -m file -a &#39;src=/etc/fstab dest=/data/fstab state=link&#39;</code></p><ol start="7"><li>Hostname：管理主机名</li></ol><p><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></p><p><code>ansible 192.168.182.128 -m hostname -a &#39;name=node128&#39;</code></p><ol start="8"><li>Cron：计划任务</li></ol><p>支持时间：<code>minute </code>, <code>hour</code> , <code>day </code>, <code>month</code> , <code>weekday</code></p><p><code>ansible bcd -m cron -a &#39;minute=* weekday=2,4,6 job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>创建任务</p><p><code>ansible bcd -m cron -a &#39;disabled=true job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>注释任务</p><p><code>ansible bcd -m cron -a &#39;disabled=false job=&quot;/usr/bin/wall PC warning&quot; name=waring&#39;</code>取消注释任务，true、false可以被yes、no替换</p><p><code>ansible bcd -m cron -a &#39;job=&quot;/usr/bin/wall PC warning&quot; name=waring state=absent&#39;</code>删除任务</p><ol start="9"><li>Yum：管理包</li></ol><p><code>ansible all -m yum -a &#39;name=httpd state=latest&#39;</code>安装(<code>state=latest</code>可省)</p><p><code>ansible bcd -m yum -a &#39;name=httpd,nginx&#39;</code>安装多个</p><p><code>ansible all -m yum -a &#39;name=httpd state=removed&#39;</code>删除</p><p><code>ansible all -m yum -a &#39;name=httpd state=absent&#39;</code>删除</p><p>安装本地包，先copy再安装，忽略key检查<code>disable_gpg_check=yes</code></p><p><code>ansible bcd -m copy -a &#39;src=/data/vsftpd-3.0.2-22.el8.x86_64.rpm dest/=root/&#39;</code></p><p><code>ansible bcd -m yum -a &#39;name=/root/vsftpd-3.0.2-22.el8.x86_64.rpm&#39;</code></p><p><code>ansible bcd -m yum -a &#39;name=/root/vsftpd-3.0.2-22.el8.x86_64.rpm disable_gpg_check=yes&#39;</code></p><p>清除缓存安装包</p><p><code>ansible bcd -m yum -a &#39;name=dstat update_cache=yes&#39;</code> <code>update_cache=yes</code>等同于<code>yum clean all</code></p><ol start="10"><li>Service：管理服务</li></ol><p><code>ansible bcd -m service -a &#39;name=httpd state=started enabled=yes&#39;</code> <code>enable=yes</code>设置开机自启</p><p><code>ansible bcd -m service -a &#39;name=httpd state=stopped&#39;</code></p><p><code>ansible bcd -m service -a &#39;name=httpd state=started&#39;</code></p><p><code>ansible bcd -m service -a &#39;name=httpd state=reloaded&#39;</code></p><p><code>ansible bcd -m service -a &#39;name=httpd state=restarted&#39;</code></p><ol start="11"><li>User：管理用户</li></ol><p><code>ansible cd -m user -a &#39;name=nginx shell=/sbin/nologin system=yes home=/var/nginx groups=root,bin uid=80 comment=&quot;nginx service&quot;&#39;</code></p><p><code>ansible cd -a &#39;getent passwd nginx&#39;</code></p><p><code>ansible cd -m user -a &#39;name=nginx remove=yes state=absent&#39;</code> 删除用户及家目录等数据</p><p><code>ansible cd -a &#39;getent passwd nginx&#39;</code></p><ol start="12"><li>Group：管理组</li></ol><p><code>ansible cd -m group -a &#39;name=nginx system=yes gid=80&#39;</code></p><p><code>ansible cd -a &#39;getent group nginx&#39;</code></p><p><code>ansible cd -m group -a &#39;name=nginx state=absent&#39;</code></p><p><code>ansible cd -a &#39;getent group nginx&#39;</code></p><p>ansible-galaxy</p><p>连接<a href="https://galaxy.ansible.com下载相应的roles/">https://galaxy.ansible.com下载相应的roles</a></p><p><a href="https://galaxy.ansible.com/search?deprecated=false&amp;keywords=&amp;order_by=-relevance%E6%9F%A5%E6%89%BE%E5%8C%85%E5%9C%B0%E5%9D%80%E3%80%82">https://galaxy.ansible.com/search?deprecated=false&amp;keywords=&amp;order_by=-relevance查找包地址。</a></p><p><code>ansible-galaxy install geerlingguy.nginx</code> 安装别人的galaxy</p><p><code>ansible-galaxy list</code> 列出所有已安装的</p><p><code>ansible-galaxy list geerlingguy.nginx</code> 查看已安装<code>geerlingguy.nginx</code>的版本</p><p><code>cd  /root/.ansible/roles/</code> 安装后会提示安装的目录</p><p><code>tree .</code> 查看结构</p><p><code>cp geerlingguy.nginx wang.nginx -rp</code> 复制一份 修修改改 当自己的😋</p><p><code>ansible-galaxy list</code> 列出已安装的可以看到多了一个<code>wang.nginx</code></p><p>删除galaxy，可以直接删除文件夹<code>geerlingguy.nginx</code> <code>wang.nginx</code></p><p><code>ansible-galaxy remove geerlingguy.nginx</code> 命令删除</p><p><code>ansible-galaxy list</code> 列出所有已安装的</p><p><code>rm -fr wang.nginx/</code> 直接删除文件夹</p><p><code>ansible-galaxy list</code> 列出所有已安装的</p><h2 id="ansible-pull"><a href="#ansible-pull" class="headerlink" title="ansible-pull"></a>ansible-pull</h2><p>推送命令至远程，效率无限提升，对运维要求较高</p><h2 id="Ansible-playbook"><a href="#Ansible-playbook" class="headerlink" title="Ansible-playbook"></a>Ansible-playbook</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#hello world yml file</span><span class="token comment">#abcd is 192.168.182.1&#123;28,31&#125;</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> cd  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello world      <span class="token key atrule">command</span><span class="token punctuation">:</span> /usr/bin/wall hello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook hello.yml</code> 执行结果可以打开c、d机器的终端查看，xshell等。</p><h2 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible-vault"></a>Ansible-vault</h2><p>功能：管理加密解密yml文件</p><p><code>ansible-vault [create|decrypt|edit|encrypt|rekey|view]</code></p><p><code>ansible-vault encrypt hello.yml</code>   # 加密</p><p><code>ansible-vault decrypt hello.yml</code>   # 解密</p><p><code>ansible-vault view hello.yml</code>   # 查看</p><p><code>ansible-vault edit hello.yml</code>   # 编辑加密文件</p><p><code>ansible-vault rekey hello.yml</code>   # 修改口令</p><p><code>ansible-vault create new.yml</code>   # 创建带口令的新文件</p><h2 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h2><p>2.0+新增，可交互执行命令，支持tab</p><p><code>root@test(2)[f:10]$</code></p><p><code>执行用户@当前操作的主机组(当前组的主机数量)[f:并发数]$</code></p><p>设置并发数: <code>forks n</code> 例如： <code>forks 10</code></p><p>切换组: <code>cd 主机组</code> 例如: <code>cd web</code></p><p>列出当前组主机列表：<code>list</code></p><p>列出所有的内置命令：<code>?</code> 或 <code>help</code></p><p>示例:</p><p><code>root@all (4)[f:5]$ list</code></p><p><code>root@all (4)[f:5]$ cd cd</code></p><p><code>root@cd (2)[f:5]$ list</code></p><p><code>root@cd (2)[f:5]$ yum name=httpd state=present</code></p><p><code>root@cd (2)[f:5]$ service name=httpd state=started</code></p><h1 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h1><p>playbook是由一个或多个”play”组成的列表</p><p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联同起来按事先编排的机制同唱一台大戏</p><p>Playbook采用YAML语言编写</p><h2 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h2><p>YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括:XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</p><p>YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是:”Yet Another Markup Language”(仍是一种标记语言）</p><h3 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h3><blockquote><p>YAML的可读性好<br>YAML和脚本语言的交互性好<br>YAML使用实现语言的数据类型<br>YAML有一个一致的信息模型<br>YAML易于实现<br>YAML可以基于流来处理<br>YAML表达能力强，扩展性好</p></blockquote><p>更多的内容及规范参见<a href="http://www.yaml.org/">http://www.yaml.org</a></p><h3 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h3><p>在单一档案中，可用连续三个连字号<code>---</code>区分多个档案。另外，还有选择性的连续三个点号<code>...</code>用来表示档案结尾</p><p>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p><p>使用<code>#</code>号注释代码</p><p>缩进必须是统一的，不能空格和tab混用</p><p>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</p><p>YAML文件内容和Linux系统大小写判断方式保持一致，是区别大小写的，k/v的值均需大小写敏感</p><p>k/v的值可同行写也可换行写。同行使用<code>:</code>分隔</p><p>v可是个字符串，也可是另一个列表</p><p>一个完整的代码块功能需最少元素需包括<code>name: task</code></p><p>一个name只能包括一个task</p><p>YAML文件扩展名通常为yml或yaml</p><h3 id="List：列表，其所有元素均使用-打头"><a href="#List：列表，其所有元素均使用-打头" class="headerlink" title="List：列表，其所有元素均使用-打头"></a>List：列表，其所有元素均使用<code>-</code>打头</h3><p>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#A list of tasty fruits</span><span class="token punctuation">-</span> Apple<span class="token punctuation">-</span> Orange<span class="token punctuation">-</span> Strawberry<span class="token punctuation">-</span> Mango<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Dictionary：字典，通常由多个key与value构成"><a href="#Dictionary：字典，通常由多个key与value构成" class="headerlink" title="Dictionary：字典，通常由多个key与value构成"></a>Dictionary：字典，通常由多个key与value构成</h3><p>示例:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token comment"># An employee record</span><span class="token key atrule">name</span><span class="token punctuation">:</span> Example Developer<span class="token key atrule">job</span><span class="token punctuation">:</span> Developer<span class="token key atrule">skill</span><span class="token punctuation">:</span> Elite<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以将<code>key:value</code>放置于<code>&#123;&#125;</code>中进行表示，用<code>,</code>分隔多个<code>key:value</code></p><p>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token comment"># An employee record</span><span class="token punctuation">&#123;</span><span class="token key atrule">name</span><span class="token punctuation">:</span> Example Developer<span class="token punctuation">,</span> <span class="token key atrule">job</span><span class="token punctuation">:</span> Developer<span class="token punctuation">,</span> skill<span class="token punctuation">:</span>Elite<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。其结构(Structure )通过空格来展示，序列(Sequence )里的项用<code>-</code>来代表，Map里的键值对用<code>:</code>分隔</p><p>示例</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> John Smith<span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token key atrule">gender</span><span class="token punctuation">:</span> Male<span class="token key atrule">spouse</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> Jane Smith  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">37</span>  <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female<span class="token key atrule">children</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jimmy Smith    <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">17</span>    <span class="token key atrule">gender</span><span class="token punctuation">:</span> Male  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jenny Smith    <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">13</span>    <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h2><p><code>Hosts</code> 执行的远程主机列表</p><p><code>Tasks</code> 任务集</p><p><code>Varniables</code> 内置变量或自定义变量在playbook中调用</p><p><code>Templates</code> 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</p><p><code>Handlers</code> 和 <code>notity</code> 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行<br><code>tags</code> 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断。</p><p><code>ansible-playbook -t tagsname useradd.yml</code> </p><h2 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h2><h3 id="Hosts："><a href="#Hosts：" class="headerlink" title="Hosts："></a>Hosts：</h3><p>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p><p>可以是如下形式：</p><pre class="line-numbers language-none"><code class="language-none">one.example.comone.example.com:two.example.com192.168.1.50192.168.1.*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>Websrvs:dbsrvs</code> 两个组的并集</p><p><code>Websrvs:&amp;dbsrvs</code> 两个组的交集</p><p><code>websrvs:!dbsrvs</code> 在websrvs组，但不在dbsrvs组</p><p>示例：</p><p><code>- hosts: websrvs:dbsrvs</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> cd  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/newfile state=touch    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new user      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=test2 system=yes shell=/sbin/nologin    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy html      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/var/www/html/index.html dest=/var/www/html/    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook -C play.yaml</code>   # 检查playbook</p><h2 id="remote-user"><a href="#remote-user" class="headerlink" title="remote_user"></a>remote_user</h2><p>可用于Host和task中</p><p>也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test connection      <span class="token key atrule">ping</span><span class="token punctuation">:</span>      <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> magedu      <span class="token key atrule">sudo</span><span class="token punctuation">:</span> yes   默认sudo为root      <span class="token key atrule">sudo_user</span><span class="token punctuation">:</span> wang   sudo为wang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="task-列表和-action"><a href="#task-列表和-action" class="headerlink" title="task 列表和 action"></a>task 列表和 action</h2><p>play的主体部分是task list</p><p>task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后再开始第二个。在运行自下而下某playbook时，如果中途发生错误，所有已执行任务都将回滚，因此，在更正playbook后重新执行一次即可</p><p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</p><p>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出</p><h3 id="tasks：任务列表"><a href="#tasks：任务列表" class="headerlink" title="tasks：任务列表"></a>tasks：任务列表</h3><p>格式：</p><p>(1) <code>action: module arguments</code></p><p>(2) <code>module: arguments</code>   建议使用</p><p>注意： <code>shell</code> 和 <code>command</code> 模块后面跟命令，而非<code>key=value</code></p><p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers</p><p>任务可以通过”tags”打标签，而后可在<code>ansible-playbook</code>命令上使用<code>-t</code>指定进行调用</p><p>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> disable selinux    <span class="token key atrule">command</span><span class="token punctuation">:</span> /sbin/setenforce 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果命令或脚本的退出码不为零，可以使用如下方式替代</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run this command and ignore the result    <span class="token key atrule">shell</span><span class="token punctuation">:</span> /usr/bin/somecommand <span class="token punctuation">|</span><span class="token punctuation">|</span> /bin/true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>或者使用ignore_errors来忽略错误信息：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run this command and ignore the result    <span class="token key atrule">shell</span><span class="token punctuation">:</span> /usr/bin/somecommand    <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token boolean important">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h2><p>运行playbook的方式</p><p><code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p><p>常见选项</p><p><code>--check</code>   只检测可能会发生的改变，但不真正执行操作</p><p><code>--list-hosts</code>   列出运行任务的主机</p><p><code>--limit</code>   主机/列表 只针对主机列表中的主机执行</p><p><code>-v</code>   显示过程<code>-vv</code> <code>-vvv</code>更详细</p><p>示例</p><p><code>ansible-playbook file.yml --check</code>   只检测</p><p><code>ansible-playbook file.yml --list</code></p><p><code>ansible-playbook file.yml --list-tasks</code></p><p><code>ansible-playbook file.yml --limit websrvs</code></p><p><code>ansible-playbook file.yml --list-tags</code></p><p>Playbook VS ShellScripts</p><p>SHELL脚本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment">#安装Apache</span>yum <span class="token function">install</span> <span class="token parameter variable">--quiet</span> <span class="token parameter variable">-y</span> httpd<span class="token comment">#复制配置文件</span><span class="token function">cp</span> /tmp/httpd.conf /etc/httpd/conf/httpd.conf<span class="token function">cp</span> /tmp/vhosts.conf /etc/httpd/confd/<span class="token comment">#启动Apache，并设置开机启动</span><span class="token function">service</span> httpd start<span class="token function">chkconfig</span> httpd on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Playbook定义</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"安装Apache"</span>      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"复制配置文件"</span>      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/tmp/httpd.conf dest=/etc/httpd/conf/<span class="token comment">#      copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/   注意如果相同的模块，不能放在一块，否则只会执行最后一个</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"复制配置文件"</span>       <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"启动Apache，并设置开机启动"</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：sysuser.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all    <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root      <span class="token key atrule">tasks</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create mysql user        <span class="token key atrule">user</span><span class="token punctuation">:</span> name=mysql system=yes uid=36      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create a group        <span class="token key atrule">group</span><span class="token punctuation">:</span> name=httpd system=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：httpd.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file        <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=$HOME/httpd.conf dest=/etc/httpd/conf/   <span class="token comment"># src相对路径是相对于当前目录。如果修改远端文件，直接修改本地文件，再次执行playbook会覆盖远端的文件。</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service        <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h1><p>Handlers（触发器和task是并列关系）</p><p>是task列表，这些task与前述的task并没有本质上的不同，用于当关注的资源发生变化时，才会采取一定的操作</p><p>Notify（通知）</p><p>此action可用于在每个play的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成最后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf file      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/etc/httpd/conf/ backup=yes      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service   <span class="token comment"># notify内容和handles中- name:内容保持一致，才会触发。</span>  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted    <span class="token comment"># 这里可以多个 - name:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add group nginx      <span class="token key atrule">tags</span><span class="token punctuation">:</span> user      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user nginx      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx state=present group=nginx    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/config.txt dest=/etc/nginx/nginx.conf      <span class="token key atrule">notify</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> Restart Nginx        <span class="token punctuation">-</span> Check Nginx Process  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Restart Nginx      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted enabled=yes    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check Nginx process      <span class="token key atrule">shell</span><span class="token punctuation">:</span> killall <span class="token punctuation">-</span>0 nginx <span class="token punctuation">></span> /tmp/nginx.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h1><p>示例: <code>httpd.yml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd      <span class="token key atrule">tags</span><span class="token punctuation">:</span> inshttp      <span class="token comment"># tags: http</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf file      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/etc/httpd/conf/ backup=yes      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start httpd      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes      <span class="token key atrule">tags</span><span class="token punctuation">:</span> rshttp      <span class="token comment"># tags: http</span>  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted<span class="token comment"># 其中多个动作可以使用相同名称的tags，即一个tags可以指定多个动作。</span><span class="token comment"># 运行时指定标签名即可，逗号为分隔符。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible 192.168.182.131 -m service -a &quot;name=httpd state=stopped&quot;</code> </p><p><code>ansible-playbook -t rshttp httpd.yml</code> or <code>ansible-playbook -t inshttp,rehttp httpd.yml</code> </p><p><code>ansible 192.168.182.131 -m shell -a &quot;ss -anptl|grep :8080&quot;</code> </p><p><code>ansible-playbook 131httpconf.yaml --list-tags</code>   # 列出yaml文件中的tags</p><h1 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h1><p>变量名：仅能由字母、数字和下划线组成，且只能以字母开头</p><p>变量来源：</p><ol><li><p><code>ansible setup facts</code> 远程主机的所有变量都可直接调用</p></li><li><p>在 <code>/etc/ansible/hosts</code> 中定义</p></li></ol><p>普通变量：主机组中主机单独定义，优先级高于公共变量</p><p>公共（组）变量：针对主机组中所有主机定义统一变量</p><ol start="3"><li>通过命令行指定变量，优先级最高</li></ol><p><code>ansible-playbook -e varname=value</code> </p><ol start="4"><li>在playbook中定义</li></ol><pre class="line-numbers language-text" data-language="text"><code class="language-text">vars:- var1: value1- var2: value2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>在role中定义</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#httpd.yaml</span><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=started enabled=true<span class="token comment"># 安装软件 并 启动，注意包名和服务名 可能不一样。</span><span class="token comment">#app.yaml</span><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package1      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package2      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>变量赋值为httpd</p><p><code>ansible-playbook -e &#39;pkname=httpd&#39; httpd.yaml</code> </p><p>变量赋值为httpd,nginx，yum可以同时安装多个包</p><p><code>ansible-playbook -e &#39;pkname1=httpd,nginx&#39; bianliang.yaml</code> </p><p>多个变量赋值，用空格隔开</p><p><code>ansible-playbook -e &#39;pkname1=httpd pkname2=nginx&#39; bianliang.yaml</code> </p><p>查询安装的包</p><p><code>ansible 192.168.182.131 -m shell -a &quot;rpm -qa|grep -E &#39;httpd|nginx&#39;&quot;</code> </p><p>卸载安装的包，同样name可以将httpd和nginx同时删掉（absent=removed）</p><p><code>ansible 192.168.182.131 -m yum -a &#39;name=httpd,nginx state=absent&#39;</code> </p><p>在playbook里面定义变量</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 192.168.182.131  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">pkname1</span><span class="token punctuation">:</span> httpd    <span class="token punctuation">-</span> <span class="token key atrule">pkname2</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package1      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package2      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook app.yaml</code> </p><p>在主机清单中定义变量<code>/etc/ansible/hosts</code> </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>webs<span class="token punctuation">]</span><span class="token number">192.168</span>.1.107 <span class="token assign-left variable">na</span><span class="token operator">=</span><span class="token number">107</span><span class="token number">192.168</span>.1.108 <span class="token assign-left variable">na</span><span class="token operator">=</span><span class="token number">108</span><span class="token comment"># 其中[webs]主机清单中，在每个主机后面可以对每个主机设置单一变量，优先级高于 通用 变量</span><span class="token punctuation">[</span>webs:vars<span class="token punctuation">]</span><span class="token assign-left variable">a</span><span class="token operator">=</span>node<span class="token assign-left variable">z</span><span class="token operator">=</span>centos7.com<span class="token comment"># 对webs主机组中所有的主机设置的 通用/公共 变量</span><span class="token comment"># 一般的规则：命令行-e 配置的变量 优先级高于 上面两种定义变量方式</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h2><p>变量名仅能由字母、数字和下划线组成，且只能以字母开头</p><p>变量定义：<code>key=value</code> </p><p>示例：<code>http_port=80</code> </p><p>变量调用方式:</p><p>通过 <code>&#123;&#123; variable_name &#125;&#125;</code> 调用变量，且变量名前后必须有空格，有时用 <code>&quot;&#123;&#123; variable_name &#125;&#125;&quot;</code> 才生效</p><p><code>ansible-playbook -e</code> 选项指定</p><p><code>ansible-playbook test.yml -e &quot;hosts=www user=mageedu&quot;</code> </p><h2 id="直接使用系统变量-setup模块"><a href="#直接使用系统变量-setup模块" class="headerlink" title="直接使用系统变量(setup模块)"></a>直接使用系统变量(setup模块)</h2><p><code>ansible web -m setup</code>   查看setup模块中定义的变量</p><p><code>&quot;ansible_user_uid&quot;</code>   变量名类似于这样</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=wang groups=wheel comment="haha wang"    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/opt/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_fqdn <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch mode=600 owner=wang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible web -m shell -a &quot;ls /data -l&quot;</code> </p><p>在 <code>vars.yaml</code> 文件中定义变量</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">var1</span><span class="token punctuation">:</span> httpd<span class="token key atrule">var2</span><span class="token punctuation">:</span> nginx<span class="token key atrule">var3</span><span class="token punctuation">:</span> haha<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> vars.yaml  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var3 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook test.yaml</code>   运行playbook文件</p><p><code>ansible web -m shell -a &quot;ls /data -l&quot;</code>   查看文件是否创建成功</p><p>变量名仅能由字母、数字和下划线组成，且只能以字母开头变量定义: <code>key=value</code></p><p>示例: <code>http_port=80</code></p><p>变量调用方式：</p><p>通过<code>&#123;&#123; variable_name &#125;&#125;</code>调用变量，且变量名前后必须有空格，有时用<code>&quot;&#123;&#123; variable_name &#125;&#125;&quot;</code>才生效</p><p><code>ansible-playbook -e</code> 选项指定</p><p><code>ansible-playbook test.yml -e &quot;hosts=www user=magedu&quot;</code></p><p>示例：变量</p><p>示例：var.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> pkname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook -e pkname=httpd var.yml</code> </p><p>示例：使用setup变量</p><p>示例：var.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create log file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/var/log/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_fqdn <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook var.yml</code></p><p>示例：变量<br>示例: var.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">username</span><span class="token punctuation">:</span> user1    <span class="token punctuation">-</span> <span class="token key atrule">groupname</span><span class="token punctuation">:</span> group1  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create group      <span class="token key atrule">group</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> groupname <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user       <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook var.yml</code><br><code>ansible-playbook -e &quot;username=user2 groupname=group2&quot; var2.yml</code> </p><h2 id="主机变量"><a href="#主机变量" class="headerlink" title="主机变量"></a>主机变量</h2><p>可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用</p><p>示例:</p><pre class="line-numbers language-none"><code class="language-none">[websrvs]www1.magedu.com http_port&#x3D;80 maxRequestsPerChild&#x3D;808www2.magedu.com http_port&#x3D;8080 maxRequestsPerChild&#x3D;909<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="组变量"><a href="#组变量" class="headerlink" title="组变量"></a>组变量</h2><p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量示例：</p><pre class="line-numbers language-none"><code class="language-none">[websrvs]www1.magedu.comwww2.magedu.com[websrvs:vars]ntp_server&#x3D;ntp.magedu.comnfs_server&#x3D;nfs.magedu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="普通变量"><a href="#普通变量" class="headerlink" title="普通变量"></a>普通变量</h2><pre class="line-numbers language-none"><code class="language-none">[websrvs]192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1192.168.99.102 http_port&#x3D;80 hname&#x3D;www2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="公共（组）变量"><a href="#公共（组）变量" class="headerlink" title="公共（组）变量"></a>公共（组）变量</h2><pre class="line-numbers language-none"><code class="language-none">[websvrs:vars]http_port&#x3D;808mark&#x3D; &quot;_&quot;[websrvs]192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1192.168.99.102 http_port&#x3D;80 hname&#x3D;www2ansible websvrs -m hostname -a &#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="命令行指定变量："><a href="#命令行指定变量：" class="headerlink" title="命令行指定变量："></a>命令行指定变量：</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ansible websvrs <span class="token parameter variable">-e</span> <span class="token assign-left variable">http_port</span><span class="token operator">=</span><span class="token number">8000</span> <span class="token parameter variable">-m</span> <span class="token function">hostname</span> <span class="token parameter variable">-a</span> <span class="token string">'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="使用变量文件"><a href="#使用变量文件" class="headerlink" title="使用变量文件"></a>使用变量文件</h2><p>cat vars.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">var1</span><span class="token punctuation">:</span> httpd<span class="token key atrule">var2</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>cat var.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> vars.yml    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create httpd log      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/app/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create nginx log       <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/app/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> var2 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>.log state=touch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>模板<code>templates</code>不能在命令行使用</p><p>文本文件，嵌套有脚本（使用模板编程语言编写)</p><p>Jinja2语言，使用字面量，有下面形式</p><p>字符串：使用单引号或双引号</p><p>数字：整数，浮点数</p><p>列表：<code>[item1, item2,...]</code></p><p>元组：<code>(item1, item2,...)</code></p><p>字典：<code>&#123;key1:value1, key2:value2,..&#125;</code></p><p>布尔型：<code>true/false</code></p><p>算术运算：<code>+, -, *, /, //, %, **</code></p><p>比较操作：<code>==, !=, &gt;, &gt;=, &lt;, &lt;=</code></p><p>逻辑运算：<code>and, or, not</code></p><p>流表达式：<code>For If When</code></p><h1 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h1><p>templates功能：根据模块文件动态生成对应的配置文件</p><p>templates文件必须存放于templates目录下，且命名为.j2结尾</p><p>yaml/yml文件需和templates目录平级，目录结构如下：</p><pre class="line-numbers language-none"><code class="language-none">.&#x2F;|--j2test.yaml|--templates       |--nginx.conf.j2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Templates示例"><a href="#Templates示例" class="headerlink" title="Templates示例"></a>Templates示例</h2><p>示例：利用templates同步nginx配置文件准备templates/nginx.conf.j2文件</p><p>在ansible目录新建templates文件夹，并将 <code>/etc/nginx/nginx.conf</code> 复制到 <code>templates/nginx.conf.j2</code></p><p><code>cp /etc/nginx/nginx.conf templates/nginx.conf.j2</code> </p><p>编辑<code>j2test.yaml</code>文件</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf.j2 dest=/etc/nginx/nginx.conf<span class="token comment">#      notify: restart service</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes<span class="token comment">#  handlers:</span><span class="token comment">#    - name: restart service</span><span class="token comment">#      service: name=nginx state=restarted</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>检查执行playbook文件，检查nginx是否运行</p><p><code>ansible-playbook -C j2test.yaml</code></p><p><code>ansible-playbook j2test.yaml</code></p><p><code>ansible web -m shell -a &quot;ps aux|grep nginx&quot;</code></p><p>修改 <code>templates/nginx.conf.j2</code> 文件为 <code>worker_processes &#123;&#123; ansible_processor_vcpus*2 &#125;&#125;;</code> ，将work线程修改为CPU核心数的2倍。同时将<code>j2test.yaml</code>文件中的notify-handlers注释解开。</p><p>运行playbook，查看work线程是否增加2倍。</p><p><code>ansible-playbook j2test.yaml</code></p><p><code>ansible web -m shell -a &quot;ps aux|grep nginx&quot;</code></p><h1 id="when"><a href="#when" class="headerlink" title="when"></a>when</h1><p>条件测试：如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试，通过when语句实现，在task中使用，jinja2的语法格式</p><h2 id="when语句"><a href="#when语句" class="headerlink" title="when语句"></a>when语句</h2><p>在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</p><p>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"shutdown RedHat flavored systems"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> /sbin/shutdown <span class="token punctuation">-</span>h now    <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == "RedHat"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ansible变量的优先级 <code>-e &#123;&#123; var &#125;&#125;</code> &gt; <code>playbook</code> &gt; <code>hosts &#123;&#123; host_vars &#125;&#125;</code> &gt; <code>hosts &#123;&#123; group_var &#125;&#125;</code></p><p><code>ansible_distribution_version</code>   版本号</p><p><code>ansible_distribution_major_version</code>   大版本号</p><p><code>ansible_processor_vcpus</code>   本机的cpu核心数</p><p>示例：when条件判断</p><p> <code>cat j2test.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates for centos8      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf8.j2 dest=/etc/nginx/nginx.conf      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "8"      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy templates for centos7      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7"      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart service    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat templates/nginx.conf7.j2 | grep -Ev &quot;#|^$&quot;</code></p><pre class="line-numbers language-django" data-language="django"><code class="language-django">user daemon;worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">+</span><span class="token number">4</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;error_log /var/log/nginx/error.log;pid /run/nginx.pid;include /usr/share/nginx/modules/*.conf;events &#123;    worker_connections 1024;&#125;http &#123;    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '                      '$status $body_bytes_sent "$http_referer" '                      '"$http_user_agent" "$http_x_forwarded_for"';    access_log  /var/log/nginx/access.log  main;    sendfile            on;    tcp_nopush          on;    tcp_nodelay         on;    keepalive_timeout   65;    types_hash_max_size 2048;    include             /etc/nginx/mime.types;    default_type        application/octet-stream;    include /etc/nginx/conf.d/*.conf;    server &#123;        listen       <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;        listen       [::]:<span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;        server_name  _;        root         /usr/share/nginx/html;        include /etc/nginx/default.d/*.conf;        location / &#123;        &#125;        error_page 404 /404.html;            location = /40x.html &#123;        &#125;        error_page 500 502 503 504 /50x.html;            location = /50x.html &#123;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat templates/nginx.conf8.j2 | grep -Ev &quot;#|^$&quot;</code></p><pre class="line-numbers language-django" data-language="django"><code class="language-django">user bin;worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">*</span><span class="token number">2</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;error_log /var/log/nginx/error.log;pid /run/nginx.pid;include /usr/share/nginx/modules/*.conf;events &#123;    worker_connections 1024;&#125;http &#123;    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '                      '$status $body_bytes_sent "$http_referer" '                      '"$http_user_agent" "$http_x_forwarded_for"';    access_log  /var/log/nginx/access.log  main;    sendfile            on;    tcp_nopush          on;    tcp_nodelay         on;    keepalive_timeout   65;    types_hash_max_size 2048;    include             /etc/nginx/mime.types;    default_type        application/octet-stream;    include /etc/nginx/conf.d/*.conf;    server &#123;        listen       <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;        listen       [::]:<span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">http_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span> default_server;        server_name  _;        root         /usr/share/nginx/html;        include /etc/nginx/default.d/*.conf;        location / &#123;        &#125;        error_page 404 /404.html;            location = /40x.html &#123;        &#125;        error_page 500 502 503 504 /50x.html;            location = /50x.html &#123;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="迭代：with-items"><a href="#迭代：with-items" class="headerlink" title="迭代：with_items"></a>迭代：with_items</h2><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制&gt;对迭代项的引用，固定变量名为”item”</p><p>要在task中使用with_items给定要迭代的元素列表</p><blockquote><p>列表格式：</p><blockquote><p>字符<br>串字典</p></blockquote></blockquote><p>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add several users  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> state=present groups=wheel  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> testuser1    <span class="token punctuation">-</span> testuser2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面语句的功能等同于下面的语句：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user testuser1  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=testuser1 state=present groups=wheel<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add user testuser2  <span class="token key atrule">user</span><span class="token punctuation">:</span> name=testuser2 state=present groups=wheel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>示例：迭代嵌套子变量</p><p><code>cat user2.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create some groups      <span class="token key atrule">group</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7"      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> g1        <span class="token punctuation">-</span> g2        <span class="token punctuation">-</span> g3    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create some users      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.name <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.group <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user1'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g1'</span> <span class="token punctuation">&#125;</span>        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user2'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g2'</span> <span class="token punctuation">&#125;</span>        <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'user3'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'g3'</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Playbook中template-for-if"><a href="#Playbook中template-for-if" class="headerlink" title="Playbook中template for if"></a>Playbook中template for if</h1><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">&#123;</span>% for vhost in nginx_vhosts %<span class="token punctuation">&#125;</span>server <span class="token punctuation">&#123;</span>listen <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.listen <span class="token punctuation">|</span> default('80 default_server') <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;<span class="token punctuation">&#123;</span>% if vhost.server_name is defined %<span class="token punctuation">&#125;</span>server_name <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.server_name <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;<span class="token punctuation">&#123;</span>% endif %<span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>% if vhost.root is defined %<span class="token punctuation">&#125;</span>root <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.root <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;<span class="token punctuation">&#123;</span>% endif %<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>示例</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// temnginx.yml     // templates/nginx.conf.j2<span class="token punctuation">---</span>                 <span class="token punctuation">&#123;</span>% for vhost in nginx_vhosts %<span class="token punctuation">&#125;</span>                    server <span class="token punctuation">&#123;</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> testweb    listen <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> vhost.listen <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root   <span class="token punctuation">&#125;</span><span class="token key atrule">vars</span><span class="token punctuation">:</span>               <span class="token punctuation">&#123;</span>% endfor %<span class="token punctuation">&#125;</span>  <span class="token key atrule">nginx_vhosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">listen</span><span class="token punctuation">:</span> 8080  // 生成的结果                    server <span class="token punctuation">&#123;</span>                      listen 8080                    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><p><code>cat for.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token number">81</span>      <span class="token punctuation">-</span> <span class="token number">82</span>      <span class="token punctuation">-</span> <span class="token number">83</span>      <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat templates/for1.conf.j2</code></p><pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">port</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>server&#123;    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>&#125;<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook for.yaml</code></p><p><code>ansible web -m shell -a &#39;cat /data/for1.conf&#39;</code></p><p>键值对的方式组成列表</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">81</span>      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">82</span>      <span class="token punctuation">-</span> <span class="token key atrule">listen_port</span><span class="token punctuation">:</span> <span class="token number">83</span>      <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">port</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>server&#123;    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">port</span><span class="token punctuation">.</span><span class="token variable">listen_port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>&#125;<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终的效果是一样的，验证时记得删除原来远程主机生成的文件。</p><p>在列表中定义另一个列表，而另一个列表定义了很多键值对：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">web1</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">81</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> web1.node.com        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website1      <span class="token punctuation">-</span> <span class="token key atrule">web2</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">82</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> web2.node.com        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website2      <span class="token punctuation">-</span> <span class="token key atrule">web3</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">83</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> web3.node.com        <span class="token key atrule">rootdir</span><span class="token punctuation">:</span> /data/website3      <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=for1.conf.j2 dest=/data/for1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">for</span> <span class="token variable">p</span> <span class="token keyword">in</span> <span class="token variable">ports</span> <span class="token delimiter punctuation">%&#125;</span></span>server&#123;    listen <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">port</span> <span class="token delimiter punctuation">&#125;&#125;</span></span><span class="token comment">&lt;!-- <span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">if</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">name</span> <span class="token keyword">is</span> <span class="token test function">defined</span> <span class="token delimiter punctuation">%&#125;</span></span> --></span>    servername <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">name</span> <span class="token delimiter punctuation">&#125;&#125;</span></span><span class="token comment">&lt;!-- <span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endif</span> <span class="token delimiter punctuation">%&#125;</span></span> --></span>    documentroot <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">p</span><span class="token punctuation">.</span><span class="token variable">rootdir</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>&#125;<span class="token django language-django"><span class="token delimiter punctuation">&#123;%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>IF判断，将上面的j2文件注释解开，并注释yaml文件的web1和web3的name配置，执行结果可以看到只有第二个有servername，其它两个没有。如果在j2文件中，不加if判断，执行ansible-playbook会报错。</p><h1 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h1><p>ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</p><p>复杂场景：建议使用roles，代码复用度高</p><blockquote><p>变更指定主机或主机组<br>如命名不规范维护和传承成本大<br>某些功能需多个Playbook，通过includes即可实现</p></blockquote><p>角色(roles)：角色集合</p><pre class="line-numbers language-none"><code class="language-none">roles&#x2F;  mysql&#x2F;  httpd&#x2F;  nginx&#x2F;  memcached&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h2><p>每个角色，以特定的层级目录结构进行组织</p><p>roles目录结构：</p><pre class="line-numbers language-none"><code class="language-none">playbook.ymlroles&#x2F;  project&#x2F;    tasks&#x2F;    files&#x2F;    vars&#x2F;       不常用    default&#x2F;    不常用    templates&#x2F;    handlers&#x2F;    meta&#x2F;       不常用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Roles各目录作用"><a href="#Roles各目录作用" class="headerlink" title="Roles各目录作用"></a>Roles各目录作用</h2><p><code>/roles/project/</code>：项目名称（<code>/roles/nginx/</code>、<code>/roles/httpd/</code>等），有以下子目录</p><p><code>files/</code>：存放由copy或script模块等调用的文件</p><p><code>templates/</code>：template模块查找所需要模板文件的目录</p><p><code>tasks/</code>：定义task，role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</p><p><code>handlers/</code>：至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</p><p><code>vars/</code>：定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</p><p><code>meta/</code>：定义当前角色的特殊设定及其依赖关系，至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</p><p><code>default/</code>：设定默认变量时使用此目录中的main.yml文件</p><h2 id="创建role"><a href="#创建role" class="headerlink" title="创建role"></a>创建role</h2><p>创建role的步骤</p><p>(1) 创建以roles命名的目录</p><p>(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等</p><p>(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建</p><p>(4) 在playbook文件中，调用各角色</p><p>针对大型项目使用roles进行编排</p><p>简单示例：</p><pre class="line-numbers language-none"><code class="language-none">[root@node ansible]# tree .├── nginx_role.yaml└── roles    └── nginx        ├── tasks        │   ├── group.yaml        │   ├── main.yaml        │   ├── restart.yaml        │   ├── start.yaml        │   ├── templ.yaml        │   ├── user.yaml        │   └── yum.yaml        └── templates            └── nginx.conf.j2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>playbook调用角色，文件内容：</p><p><code>nginx_role.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">roles</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>group.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create group  <span class="token key atrule">group</span><span class="token punctuation">:</span> name=nginx gid=80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>user.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user   <span class="token key atrule">user</span><span class="token punctuation">:</span> name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>yum.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package  <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>templ.yaml </code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf  <span class="token key atrule">template</span><span class="token punctuation">:</span> src=nginx.conf.j2 dest=/etc/nginx/nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>start.yaml </code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>restart.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart nginx  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>main.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> group.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> yum.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> templ.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> start.yaml<span class="token comment">#- include: restart.yaml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat templates/nginx.conf.j2 | grep -Ev &quot;^[[:space:]]*#|^$&quot;</code></p><pre class="line-numbers language-django" data-language="django"><code class="language-django">user nginx;worker_processes <span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span> <span class="token variable">ansible_processor_vcpus</span><span class="token operator">+</span><span class="token number">2</span> <span class="token delimiter punctuation">&#125;&#125;</span></span>;error_log /var/log/nginx/error.log;pid /run/nginx.pid;include /usr/share/nginx/modules/*.conf;events &#123;    worker_connections 1024;&#125;http &#123;    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '                      '$status $body_bytes_sent "$http_referer" '                      '"$http_user_agent" "$http_x_forwarded_for"';    access_log  /var/log/nginx/access.log  main;    sendfile            on;    tcp_nopush          on;    tcp_nodelay         on;    keepalive_timeout   65;    types_hash_max_size 2048;    include             /etc/nginx/mime.types;    default_type        application/octet-stream;    include /etc/nginx/conf.d/*.conf;    server &#123;        listen       80 default_server;        listen       [::]:80 default_server;        server_name  _;        root         /usr/share/nginx/html;        include /etc/nginx/default.d/*.conf;        location / &#123;        &#125;        error_page 404 /404.html;            location = /40x.html &#123;        &#125;        error_page 500 502 503 504 /50x.html;            location = /50x.html &#123;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat /etc/ansible/hosts | grep -Ev &quot;^[[:space:]]*#|^$&quot;</code></p><pre class="line-numbers language-none"><code class="language-none">[alls]192.168.1.2 hostnm&#x3D;node.1.2192.168.1.3 hostnm&#x3D;node.1.3192.168.1.4 hostnm&#x3D;node.1.4192.168.1.5 hostnm&#x3D;node.1.5192.168.1.6 hostnm&#x3D;node.1.6192.168.1.7 hostnm&#x3D;node.1.7[local]192.168.1.2[app]192.168.1.[3:6][web]192.168.1.5 http_port&#x3D;5555192.168.1.6 http_port&#x3D;6666[web2]192.168.1.7 http_port&#x3D;7777192.168.1.6 http_port&#x3D;6666<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行playbook脚本，并验证：</p><p><code>ansible-playbook nginx_role.yaml</code></p><p><code>ansible web2 -m shell -a &#39;ss -anptl | grep nginx&#39;</code></p><p><code>ansible web2 -m shell -a &#39;ps aux | grep nginx&#39;</code></p><p><code>ansible web2 -m shell -a &#39;getent passwd | grep nginx&#39;</code></p><p><code>ansible web2 -m shell -a &#39;getent group | grep nginx&#39;</code></p><p>示例2：</p><p>同时执行多个roles</p><p><code>http_role.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">roles</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat roles/httpd/files/httpd.conf | grep -Ev &quot;^$|^[[:space:]]*#&quot;</code></p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">ServerRoot &quot;&#x2F;etc&#x2F;httpd&quot;Listen 80Include conf.modules.d&#x2F;*.confUser apacheGroup apacheServerAdmin root@localhost&lt;Directory &#x2F;&gt;    AllowOverride none    Require all denied&lt;&#x2F;Directory&gt;DocumentRoot &quot;&#x2F;var&#x2F;www&#x2F;html&quot;&lt;Directory &quot;&#x2F;var&#x2F;www&quot;&gt;    AllowOverride None    Require all granted&lt;&#x2F;Directory&gt;&lt;Directory &quot;&#x2F;var&#x2F;www&#x2F;html&quot;&gt;    Options Indexes FollowSymLinks    AllowOverride None    Require all granted&lt;&#x2F;Directory&gt;&lt;IfModule dir_module&gt;    DirectoryIndex index.html&lt;&#x2F;IfModule&gt;&lt;Files &quot;.ht*&quot;&gt;    Require all denied&lt;&#x2F;Files&gt;ErrorLog &quot;logs&#x2F;error_log&quot;LogLevel warn&lt;IfModule log_config_module&gt;    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common    &lt;IfModule logio_module&gt;      LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; %I %O&quot; combinedio    &lt;&#x2F;IfModule&gt;    CustomLog &quot;logs&#x2F;access_log&quot; combined&lt;&#x2F;IfModule&gt;&lt;IfModule alias_module&gt;    ScriptAlias &#x2F;cgi-bin&#x2F; &quot;&#x2F;var&#x2F;www&#x2F;cgi-bin&#x2F;&quot;&lt;&#x2F;IfModule&gt;&lt;Directory &quot;&#x2F;var&#x2F;www&#x2F;cgi-bin&quot;&gt;    AllowOverride None    Options None    Require all granted&lt;&#x2F;Directory&gt;&lt;IfModule mime_module&gt;    TypesConfig &#x2F;etc&#x2F;mime.types    AddType application&#x2F;x-compress .Z    AddType application&#x2F;x-gzip .gz .tgz    AddType text&#x2F;html .shtml    AddOutputFilter INCLUDES .shtml&lt;&#x2F;IfModule&gt;AddDefaultCharset UTF-8&lt;IfModule mime_magic_module&gt;    MIMEMagicFile conf&#x2F;magic&lt;&#x2F;IfModule&gt;EnableSendfile onIncludeOptional conf.d&#x2F;*.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cat roles/httpd/tasks/copy.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy file  <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=httpd.conf dest=/data owner=apache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>cat roles/httpd/tasks/main.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> copy.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>cat roles/httpd/tasks/user.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create user   <span class="token key atrule">user</span><span class="token punctuation">:</span> name=apache system=yes shell=/sbin/nologin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>cat some_reole.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">roles</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>验证(清除原来playbook创建的文件😊)：</p><p><code>ansible-playbook some_reole.yaml</code></p><p>示例3：</p><p>一个role调用另一个role中的tasks，nginx调用httpd的copy.yaml</p><ol><li>修改nginx的main.yaml，增加httpd的copy.yaml文件</li></ol><p><code>cat roles/nginx/tasks/main.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> group.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> user.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> yum.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> templ.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> start.yaml<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> roles/httpd/tasks/copy.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>如果是通用的yaml文件，公共的yaml文件中的一些路径要写绝对路径，所以修改httpd的copy.yaml文件</li></ol><p><code>cat roles/httpd/tasks/copy.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy file  <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/etc/httpd/conf/httpd.conf dest=/data owner=apache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>示例4：</p><p>加标签（标签可以是一个列表）：</p><p><code>cp -r roles/nginx/ roles/app</code></p><p><code>cat some_reole.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">roles</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'httpd'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'nginx'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"app"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>验证：</p><p><code>ansible-playbook -t web some_reole.yaml</code></p><p><code>ansible-playbook -t httpd some_reole.yaml</code></p><p><code>ansible-playbook -t app some_reole.yaml</code></p><p>示例5：</p><p>when语句：</p><p><code>cat some_reole.yaml</code> </p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web2  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">roles</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> httpd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'httpd'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> nginx<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'web'</span><span class="token punctuation">,</span><span class="token string">'nginx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution_major_version == "7" <span class="token punctuation">&#125;</span>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"app"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ansible-playbook some_reole.yaml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Linux Create User and Upload User Public keys  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test  <span class="token comment">#remote_user: xxxx</span>  <span class="token comment">#sudo: yes</span>  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">user_1</span><span class="token punctuation">:</span> xiaoxiaoleo  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Make sure we have a 'wheel' group      <span class="token key atrule">group</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> wheel        <span class="token key atrule">state</span><span class="token punctuation">:</span> present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Allow 'wheel' group to have passwordless sudo      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/sudoers        <span class="token key atrule">state</span><span class="token punctuation">:</span> present        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^%wheel'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'%wheel ALL=(ALL) NOPASSWD: ALL'</span>     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create user <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">user</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; user_1 &#125;&#125;"</span>        <span class="token key atrule">shell</span><span class="token punctuation">:</span> /bin/bash        <span class="token key atrule">groups</span><span class="token punctuation">:</span> wheel        <span class="token key atrule">createhome</span><span class="token punctuation">:</span> yes        <span class="token key atrule">home</span><span class="token punctuation">:</span> /home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">state</span><span class="token punctuation">:</span> present     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create key directory      <span class="token key atrule">action</span><span class="token punctuation">:</span> file path=/home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/.ssh/ state=directory  owner=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> mode=0700     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create key file      <span class="token key atrule">action</span><span class="token punctuation">:</span> file path=/home/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/.ssh/authorized_keys state=touch  owner=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> group=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> user_1 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> mode=0600          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set authorized key took from file      <span class="token key atrule">authorized_key</span><span class="token punctuation">:</span>        <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; user_1 &#125;&#125;"</span>        <span class="token key atrule">state</span><span class="token punctuation">:</span> present        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; lookup('file', '/tmp/pubkey/id_rsa.pub') &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Activemq</title>
      <link href="/posts/21603f2b.html"/>
      <url>/posts/21603f2b.html</url>
      
        <content type="html"><![CDATA[<h1 id="ActiveMQ-ZooKeeper-集群"><a href="#ActiveMQ-ZooKeeper-集群" class="headerlink" title="ActiveMQ+ZooKeeper 集群"></a>ActiveMQ+ZooKeeper 集群</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>三台主机，IP分别为192.168.3.100、192.168.3.101、192.168.3.102</strong></p><p><strong>原理简介：</strong><br>一般在部署ActiveMQ集群的时候，更倾向于使用基于ZooKeeper的<code>Replicated LevelDB Store方式</code>，该方式是<code>Master Slave部署方案</code>的其中一种策略，也是在多台主机实现ActiveMQ集群的主流部署方式。 此教程<code>只保证了高可用性</code>。要想保证负载均衡得再结合Broker Clusters 部署方案，配置网络连接器。</p><p><strong>工作流程：</strong><br>在ZooKeeper中管理多个Broker节点，根据 Master选举策略让其中一个 Broker选举为Master（只有Master才具备对外提供服务的能力），剩下Broker为slave。<br>编码时，client端（消费者）通过failover协议来连接ActiveMQ集群。</p><h1 id="一、服务器配置"><a href="#一、服务器配置" class="headerlink" title="一、服务器配置"></a>一、服务器配置</h1><h2 id="1-ZooKeeper集群"><a href="#1-ZooKeeper集群" class="headerlink" title="1. ZooKeeper集群"></a>1. ZooKeeper集群</h2><p>ZooKeeper集群保证ZooKeeper本身的高可用性。</p><h3 id="1-1-修改ZK配置文件conf-zoo-cfg"><a href="#1-1-修改ZK配置文件conf-zoo-cfg" class="headerlink" title="1.1 修改ZK配置文件conf/zoo.cfg"></a>1.1 修改ZK配置文件<code>conf/zoo.cfg</code></h3><table><thead><tr><th>主机IP</th><th>服务端口（默认）</th><th>集群通信端口</th><th>节点目录/home/下</th></tr></thead><tbody><tr><td>192.168.3.100</td><td>2181</td><td>2888:3888</td><td>zookeeper</td></tr><tr><td>192.168.3.101</td><td>2181</td><td>2888:3888</td><td>zookeeper</td></tr><tr><td>192.168.3.103</td><td>2181</td><td>2888:3888</td><td>zookeeper</td></tr></tbody></table><blockquote><p>集群通信端口：第一个端口是master和slave之间的通信端口，默认是2888；第二个端口是leader选举的端口，集群刚启动的时候选举或者leader挂掉之后进行新的选举的端口默认是3888。</p></blockquote><p>在3台主机上都安装zookeeper服务，/home/zookeeper，并分别配置它们的文件conf/zoo.cfg:</p><p>**主机1(192.168.3.100)**：<br><code>/home/zookeeper/conf/zoo.cfg:</code></p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf"># zookeeper的数据存储和日志存储目录（如果目录不存在就新建）dataDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;datadataLogDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;log# zk集群之间的通信地址server.1&#x3D;192.168.3.100:2888:3888server.2&#x3D;192.168.3.101:2888:3888server.3&#x3D;192.168.3.103:2888:3888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>/home/zookeeper/data/myid</code>文件,填入数字1：</p><pre class="line-numbers language-awk" data-language="awk"><code class="language-awk"><span class="token comment"># 由于该主机1（192.168.3.100）是server.1，所以在myid中设置数字1</span>$ vim <span class="token operator">/</span>home<span class="token operator">/</span>zookeeper<span class="token operator">/</span>data<span class="token operator">/</span>myid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>主机2（192.168.3.101）</strong>：<br><code>/home/zookeeper/conf/zoo.cfg:</code></p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">dataDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;datadataLogDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;logserver.1&#x3D;192.168.3.100:2888:3888server.2&#x3D;192.168.3.101:2888:3888server.3&#x3D;192.168.3.103:2888:3888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>/home/zookeeper/data/myid</code>文件,填入数字2：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 由于该主机2（192.168.3.101）是server.2，所以在myid中设置数字2</span>$ <span class="token function">vim</span> /home/zookeeper/data/myid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>主机3（192.168.3.101）</strong>：<br><code>/home/zookeeper/conf/zoo.cfg:</code></p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">dataDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;datadataLogDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;logserver.1&#x3D;192.168.3.100:2888:3888server.2&#x3D;192.168.3.101:2888:3888server.3&#x3D;192.168.3.103:2888:3888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>/home/zookeeper/data/myid</code>文件,填入数字3：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 由于该主机3（192.168.3.102）是server.3，所以在myid中设置数字3</span>$ <span class="token function">vim</span> /home/zookeeper/data/myid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="1-2-分别启动zookeeper服务"><a href="#1-2-分别启动zookeeper服务" class="headerlink" title="1.2 分别启动zookeeper服务"></a>1.2 分别启动zookeeper服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ /home/zookeeper/bin/zkServer.sh start <span class="token comment"># 启动zk服务</span>$ /home/zookeeper/bin/zkServer.sh status <span class="token comment"># 查看zk服务状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="2-ActiveMQ集群"><a href="#2-ActiveMQ集群" class="headerlink" title="2. ActiveMQ集群"></a>2. ActiveMQ集群</h2><h3 id="2-1-修改ActiveMQ配置文件conf-activemq-xml和conf-jetty-xml"><a href="#2-1-修改ActiveMQ配置文件conf-activemq-xml和conf-jetty-xml" class="headerlink" title="2.1 修改ActiveMQ配置文件conf/activemq.xml和conf/jetty.xml"></a>2.1 修改ActiveMQ配置文件<code>conf/activemq.xml</code>和<code>conf/jetty.xml</code></h3><table><thead><tr><th>主机IP</th><th>服务端口(默认)</th><th>复制协议端口（动态）</th><th>jetty控制台端口（默认）</th><th>节点目录/home/下</th></tr></thead><tbody><tr><td>192.168.3.100</td><td>61616</td><td>tcp://0.0.0.0:0</td><td>8161</td><td>activemq/node1</td></tr><tr><td>192.168.3.101</td><td>61616</td><td>tcp://0.0.0.0:0</td><td>8161</td><td>activemq/node2</td></tr><tr><td>192.168.3.103</td><td>61616</td><td>tcp://0.0.0.0:0</td><td>8161</td><td>activemq/node3</td></tr></tbody></table><p>在3台主机上都安装activemq 服务，/home/activemq，并分别配置它们的文件conf/activemq.xml和conf/jetty.xml:</p><p>**主机1(192.168.3.100)**：<br><code>/home/activemq/conf/activemq.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 持久化的部分为ZooKeeper集群连接地址--></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceAdapter</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replicatedLevelDB</span>        <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;activemq.data&#125;/leveldb<span class="token punctuation">"</span></span>        <span class="token attr-name">replicas</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span>        <span class="token attr-name">bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tcp://0.0.0.0:62621<span class="token punctuation">"</span></span>        <span class="token attr-name">zkAddress</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.100:2181,192.168.3.101:2181,192.168.3.103:2181<span class="token punctuation">"</span></span>         <span class="token attr-name">zkPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/home/activemq/leveldb-stores<span class="token punctuation">"</span></span>        <span class="token attr-name">hostname</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.100<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceAdapter</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- # directory： 存储数据的路径# replicas：集群中的节点数【(replicas/2)+1公式表示集群中至少要正常运行的服务数量】，3台集群那么允许1台宕机， 另外两台要正常运行  # bind：当该节点成为master后，它将绑定已配置的地址和端口来为复制协议提供服务。还支持使用动态端口。只需使用tcp://0.0.0.0:0进行配置即可，默认端口为61616。 # zkAddress：ZK的ip和port， 如果是集群，则用逗号隔开(这里作为简单示例ZooKeeper配置为单点， 这样已经适用于大多数环境了， 集群也就多几个配置) # zkPassword：当连接到ZooKeeper服务器时用的密码，没有密码则不配置。 # zkPah：ZK选举信息交换的存贮路径，启动服务后actimvemq会到zookeeper上注册生成此路径   # hostname： ActiveMQ所在主机的IP# 更多参考：http://activemq.apache.org/replicated-leveldb-store.html--></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/home/activemq/conf/jetty.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jettyPort<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.activemq.web.WebConsolePort<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>start<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>host<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.0.0.0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8161<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- 在这里修改端口为8161,默认就是8161 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>**主机2(192.168.3.101)**：<br><code>/home/activemq/conf/activemq.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceAdapter</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replicatedLevelDB</span>        <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;activemq.data&#125;/leveldb<span class="token punctuation">"</span></span>        <span class="token attr-name">replicas</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span>        <span class="token attr-name">bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tcp://0.0.0.0:62621<span class="token punctuation">"</span></span>        <span class="token attr-name">zkAddress</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.100:2181,192.168.3.101:2181,192.168.3.103:2181<span class="token punctuation">"</span></span>         <span class="token attr-name">zkPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/home/activemq/leveldb-stores<span class="token punctuation">"</span></span>        <span class="token attr-name">hostname</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.101<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceAdapter</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/home/activemq/conf/jetty.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jettyPort<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.activemq.web.WebConsolePort<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>start<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>host<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.0.0.0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8161<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- 在这里修改端口为8161,默认就是8161 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>**主机3(192.168.3.103)**：<br><code>/home/activemq/conf/activemq.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceAdapter</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replicatedLevelDB</span>        <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;activemq.data&#125;/leveldb<span class="token punctuation">"</span></span>        <span class="token attr-name">replicas</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span>        <span class="token attr-name">bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tcp://0.0.0.0:62621<span class="token punctuation">"</span></span>        <span class="token attr-name">zkAddress</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.100:2181,192.168.3.101:2181,192.168.3.103:2181<span class="token punctuation">"</span></span>         <span class="token attr-name">zkPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/home/activemq/leveldb-stores<span class="token punctuation">"</span></span>        <span class="token attr-name">hostname</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.3.103<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceAdapter</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/home/activemq/conf/jetty.xml：</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jettyPort<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.activemq.web.WebConsolePort<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>start<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>host<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.0.0.0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8161<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- 在这里修改端口为8161,默认就是8161 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-依次启动activemq服务"><a href="#2-2-依次启动activemq服务" class="headerlink" title="2.2 依次启动activemq服务"></a>2.2 依次启动activemq服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ /home/activemq/bin/activemq start <span class="token comment"># 启动activemq服务</span>$ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> activemq <span class="token comment"># 检查进程是否运行，即activemq是否启动成功</span>$ <span class="token function">netstat</span> -anp<span class="token operator">|</span><span class="token function">grep</span> <span class="token number">61616</span> <span class="token comment"># 查看服务端口61616，监听情况</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="三、Client使用"><a href="#三、Client使用" class="headerlink" title="三、Client使用"></a>三、Client使用</h1><p>该zookeeper+activemq的集群Master Slave部署方案，能够提供(3-1)/2的容错率，即3台服务器允许宕机一台，而不影响整个集群的对外提供服务。</p><p>编写代码连接时使用failover策略：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> url <span class="token operator">=</span> failover<span class="token operator">:</span><span class="token punctuation">(</span>tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">61616</span><span class="token punctuation">,</span>tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.101</span><span class="token operator">:</span><span class="token number">61616</span><span class="token punctuation">,</span>tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">61616</span><span class="token punctuation">)</span><span class="token operator">?</span>initialReconnectDelay<span class="token operator">=</span><span class="token number">1000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx</title>
      <link href="/posts/b0ebf657.html"/>
      <url>/posts/b0ebf657.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><p><a href="http://nginx.org/en/download.html">官网</a>下载tar包编译安装</p><p><a href="https://nginx.org/en/linux_packages.html">yum源安装</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> yum-utils<span class="token function">tee</span> /etc/yum.repos.d/nginx-stable.repo <span class="token operator">&lt;&lt;-</span><span class="token string">"EOF"<span class="token bash punctuation">   <span class="token comment"># 使用引号可以将变量识别为文本传递</span></span>[nginx-stable]name=nginx stable repobaseurl=http://nginx.org/packages/centos/$releasever/$basearch/gpgcheck=1enabled=1gpgkey=https://nginx.org/keys/nginx_signing.keymodule_hotfixes=true[nginx-mainline]name=nginx mainline repobaseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/gpgcheck=1enabled=0gpgkey=https://nginx.org/keys/nginx_signing.keymodule_hotfixes=trueEOF</span>yum-config-manager <span class="token parameter variable">--enable</span> nginx-mainline   <span class="token comment"># 是否开启主线版本安装，不执行默认安装稳定版</span>dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> nginxnginx <span class="token parameter variable">-c</span> nginx.conf   <span class="token comment"># 指定主配置文件启动</span>nginx <span class="token parameter variable">-s</span> quit   <span class="token comment"># 优雅退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="nginx配置文件优化"><a href="#nginx配置文件优化" class="headerlink" title="nginx配置文件优化"></a>nginx配置文件优化</h3><blockquote><p>按日期自动生成日志文件</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># http块添加以下配置</span><span class="token comment"># 新增logdate日期变量</span>    map <span class="token variable">$time_iso8601</span> <span class="token variable">$logdate</span> <span class="token punctuation">&#123;</span>      <span class="token string">'~^(?&lt;ymd>\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;)'</span> <span class="token variable">$ymd</span><span class="token punctuation">;</span>      default    <span class="token string">'date-not-found'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment"># server块添加日志文件变量</span>        location /trackLog <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">!</span>~* POST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>           <span class="token comment"># 日志文件名添加日期变量</span>            access_log  /home/nginx/logs/access-<span class="token variable">$logdate</span>.log main<span class="token punctuation">;</span>            proxy_pass http://127.0.0.1/return200/<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用Nginx实现限流</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;&lt;</span><span class="token string">'COMMENT'limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;$binary_remote_addr 表示通过remote_addr这个标识来做限制，是限制同一客户端ip地址。zone=one:10m 表示生成一个大小为10M，名字定义为one的内存区域，用来存储访问的频次信息。rate=1r/s 表示允许相同标识的客户端的访问频次，这里限制的是每秒1次，30r/m每分钟30次。limit_req zone=one burst=5 nodelay;zone=one 设置使用哪个配置区域来做限制，与上面 limit_req_zone 里的name对应。burst=5，设置一个大小为5的缓冲区当有大量请求（爆发）过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。nodelay，如果设置，超过访问频次而且缓冲区也满了的时候就会直接返回503，如果没有设置，则所有请求会等待排队。COMMENT</span>limit_req_zone <span class="token variable">$binary_remote_addr</span><span class="token variable">$uri</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>per_ip_and_uri:10m <span class="token assign-left variable">rate</span><span class="token operator">=</span>1r/s<span class="token punctuation">;</span>location /api/ <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> POST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        limit_req <span class="token assign-left variable">zone</span><span class="token operator">=</span>per_ip_and_uri <span class="token assign-left variable">burst</span><span class="token operator">=</span><span class="token number">1</span> nodelay<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># 如何返回指定错误信息呢？</span>location /api/ <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> POST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        limit_req <span class="token assign-left variable">zone</span><span class="token operator">=</span>per_ip_and_uri <span class="token assign-left variable">burst</span><span class="token operator">=</span><span class="token number">1</span> nodelay<span class="token punctuation">;</span>        limit_req_status <span class="token number">200</span><span class="token punctuation">;</span>        add_header Content-Type <span class="token string">"application/json"</span><span class="token punctuation">;</span>        <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">'&#123;"code": 500, "msg": "请求太频繁，请稍后再试！"&#125;'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># 下载速度限制</span>limit_rate 500k<span class="token punctuation">;</span>   <span class="token comment"># 例如限制下载速度为500k</span>location /download <span class="token punctuation">&#123;</span>    root /download<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>limit_rate_after 500k<span class="token punctuation">;</span>limit_rate 10k<span class="token punctuation">;</span>   <span class="token comment"># 下载速度超过500k则限制为10k</span>location /download <span class="token punctuation">&#123;</span>    root /download<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Nginx负载均衡策略</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 轮询（Round Robin）</span><span class="token comment"># 这是默认的负载均衡策略，它将请求依次分配给不同的后端服务器。</span>upstream backend <span class="token punctuation">&#123;</span>    server backend1.example.com<span class="token punctuation">;</span>    server backend2.example.com<span class="token punctuation">;</span>    server backend3.example.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># IP哈希（IP Hash）</span><span class="token comment"># 此策略基于客户端IP地址计算哈希值，然后将请求发送到具有该哈希值的服务器。</span>upstream backend <span class="token punctuation">&#123;</span>    ip_hash<span class="token punctuation">;</span>    server backend1.example.com<span class="token punctuation">;</span>    server backend2.example.com<span class="token punctuation">;</span>    server backend3.example.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 最少连接（Least Connections）</span><span class="token comment"># 此策略将请求发送到当前具有最少活动连接数的服务器。</span>upstream backend <span class="token punctuation">&#123;</span>    least_conn<span class="token punctuation">;</span>    server backend1.example.com<span class="token punctuation">;</span>    server backend2.example.com<span class="token punctuation">;</span>    server backend3.example.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 加权轮询（Weighted Round Robin）</span><span class="token comment"># 此策略与轮询相似，但是可以为不同的服务器分配不同的权重。</span>upstream backend <span class="token punctuation">&#123;</span>    server backend1.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>    server backend2.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>    server backend3.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 加权最少连接（Weighted Least Connections）</span><span class="token comment"># 此策略与最少连接策略相似，请求将被发送到当前具有最少活动连接数的服务器，当然仍然可以分配权重。</span>upstream backend <span class="token punctuation">&#123;</span>    least_conn<span class="token punctuation">;</span>    server backend1.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>    server backend2.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>    server backend3.example.com <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>动静分离</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 针对业务来讲，将静态资源与动态资源分离开。</span><span class="token comment"># 后端开发不需要将一些图片、视频等资源暴露，通过nginx代理静态资源缓解后台服务器压力。</span>location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>bmp<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token operator">|</span>txt<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    root   /soft/nginx/static_resources<span class="token punctuation">;</span>    expires 7d<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Nginx资源压缩</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>    <span class="token comment"># 开启压缩机制</span>    <span class="token function">gzip</span> on<span class="token punctuation">;</span>    <span class="token comment"># 指定会被压缩的文件类型(也可自己配置其他类型)</span>    gzip_types text/plain application/javascript text/css application/xml text/javascript image/jpeg image/gif image/png<span class="token punctuation">;</span>    <span class="token comment"># 设置压缩级别，越高资源消耗越大，但压缩效果越好</span>    gzip_comp_level <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token comment"># 在头部中添加Vary: Accept-Encoding（建议开启）</span>    gzip_vary on<span class="token punctuation">;</span>    <span class="token comment"># 处理压缩请求的缓冲区数量和大小</span>    gzip_buffers <span class="token number">16</span> 8k<span class="token punctuation">;</span>    <span class="token comment"># 对于不支持压缩功能的客户端请求不开启压缩机制</span>    gzip_disable <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span> <span class="token comment"># 低版本的IE浏览器不支持压缩</span>    <span class="token comment"># 设置压缩响应所支持的HTTP最低版本</span>    gzip_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>    <span class="token comment"># 设置触发压缩的最小阈值</span>    gzip_min_length 2k<span class="token punctuation">;</span>    <span class="token comment"># 关闭对后端服务器的响应结果进行压缩</span>    gzip_proxied off<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;&lt;</span><span class="token string">'EOF'gzip与sendfile的冲突问题我们知道，开启sendfile文件高效传输模式，文件在内核空间直接传输给socket，不会经过用户程序，开启gzip之后，该模式也就失效了。我们可以通过引入ngx_http_gzip_static_module模块来进行解决。该模块允许发送文件扩展名为.gz的预压缩文件。作用域：http, server, location语法：gzip_static on | off | always;默认值：gzip_static off;gzip_static on;或gzip_static off;都会检测是否存在.gz预压缩文件。gzip_static always;会始终使用.gz预压缩文件。EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx缓存</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>    <span class="token comment"># 设置缓存的目录，并且内存中缓存区名为hot_cache，大小为128m，</span>    <span class="token comment"># 三天未被访问过的缓存自动清楚，磁盘中缓存的最大容量为2GB。</span>    proxy_cache_path /soft/nginx/cache <span class="token assign-left variable">levels</span><span class="token operator">=</span><span class="token number">1</span>:2 <span class="token assign-left variable">keys_zone</span><span class="token operator">=</span>hot_cache:128m <span class="token assign-left variable">inactive</span><span class="token operator">=</span>3d <span class="token assign-left variable">max_size</span><span class="token operator">=</span>2g<span class="token punctuation">;</span>    server<span class="token punctuation">&#123;</span>        location / <span class="token punctuation">&#123;</span>            <span class="token comment"># 使用名为nginx_cache的缓存空间</span>            proxy_cache hot_cache<span class="token punctuation">;</span>            <span class="token comment"># 对于200、206、304、301、302状态码的数据缓存1天</span>            proxy_cache_valid <span class="token number">200</span> <span class="token number">206</span> <span class="token number">304</span> <span class="token number">301</span> <span class="token number">302</span> 1d<span class="token punctuation">;</span>            <span class="token comment"># 对于其他状态的数据缓存30分钟</span>            proxy_cache_valid any 30m<span class="token punctuation">;</span>            <span class="token comment"># 定义生成缓存键的规则（请求的url+参数作为key）</span>            proxy_cache_key <span class="token variable">$host</span><span class="token variable">$uri</span><span class="token variable">$is_args</span><span class="token variable">$args</span><span class="token punctuation">;</span>            <span class="token comment"># 资源至少被重复访问三次后再加入缓存</span>            proxy_cache_min_uses <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token comment"># 出现重复请求时，只让一个去后端读数据，其他的从缓存中读取</span>            proxy_cache_lock on<span class="token punctuation">;</span>            <span class="token comment"># 上面的锁超时时间为3s，超过3s未获取数据，其他请求直接去后端</span>            proxy_cache_lock_timeout 3s<span class="token punctuation">;</span>            <span class="token comment"># 对于请求参数或cookie中声明了不缓存的数据，不再加入缓存</span>            proxy_no_cache <span class="token variable">$cookie_nocache</span> <span class="token variable">$arg_nocache</span> <span class="token variable">$arg_comment</span><span class="token punctuation">;</span>            <span class="token comment"># 在响应头中添加一个缓存是否命中的状态（便于调试）</span>            add_header Cache-status <span class="token variable">$upstream_cache_status</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># 清除缓存：①删除缓存目录</span><span class="token function">rm</span> <span class="token parameter variable">-fr</span> /soft/nginx/cache/*<span class="token comment"># ②借助第三方模块ngx_cache_purge来实现对指定缓存的删除。</span><span class="token comment"># 需要将模块编译进nginx命令</span>https://github.com/FRiCKLE/ngx_cache_purge./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/soft/nginx/ --add-module<span class="token operator">=</span>/soft/cache_purge/ngx_cache_purge/<span class="token comment"># 添加location purge字段，用于http访问清除缓存链接</span>location ~ /purge<span class="token punctuation">(</span>/.*<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment"># 配置可以执行清除操作的IP（线上可以配置成内网机器）</span>  <span class="token comment"># allow 127.0.0.1; # 代表本机</span>  allow all<span class="token punctuation">;</span> <span class="token comment"># 代表允许任意IP清除缓存</span>  proxy_cache_purge <span class="token variable">$host</span><span class="token variable">$1</span><span class="token variable">$is_args</span><span class="token variable">$args</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 然后再重启Nginx，接下来即可通过http://127.0.0.1/purge/clean的方式清除缓存。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx缓冲区</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>    <span class="token comment"># 设置与后端服务器建立连接时的超时时间。</span>    proxy_connect_timeout <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment"># 设置从后端服务器读取响应数据的超时时间。</span>    proxy_read_timeout <span class="token number">120</span><span class="token punctuation">;</span>    <span class="token comment"># 设置向后端服务器传输请求数据的超时时间。</span>    proxy_send_timeout <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment"># 是否启用缓冲机制，默认为on关闭状态。</span>    proxy_buffering on<span class="token punctuation">;</span>    <span class="token comment"># 设置缓冲客户端请求数据的内存大小。</span>    client_body_buffer_size 512k<span class="token punctuation">;</span>    <span class="token comment"># 为每个请求/连接设置缓冲区的数量和大小，默认4 4k/8k。</span>    proxy_buffers <span class="token number">4</span> 64k<span class="token punctuation">;</span>    <span class="token comment"># 设置用于存储响应头的缓冲区大小。</span>    proxy_buffer_size 16k<span class="token punctuation">;</span>    <span class="token comment"># 在后端数据没有完全接收完成时，Nginx可以将busy状态的缓冲返回给客户端，该参数用来设置busy状态的buffer具体有多大，默认为proxy_buffer_size*2。</span>    proxy_busy_buffers_size 128k<span class="token punctuation">;</span>    <span class="token comment"># 设置每次写数据到临时文件的大小限制。</span>    proxy_temp_file_write_size 128k<span class="token punctuation">;</span>    <span class="token comment"># 当内存缓冲区存满时，可以将数据临时存放到磁盘，该参数是设置存储缓冲数据的目录。</span>    proxy_temp_path /soft/nginx/temp_buffer<span class="token punctuation">;</span>    <span class="token comment"># 设置临时的缓冲目录中允许存储的最大容量。</span>    proxy_max_temp_file_size 256k<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginxIP黑名单</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>    <span class="token comment"># 屏蔽该文件中的所有IP</span>    include /soft/nginx/IP/BlocksIP.conf<span class="token punctuation">;</span> server<span class="token punctuation">&#123;</span>    location xxx <span class="token punctuation">&#123;</span>        <span class="token comment"># 某一系列接口只开放给白名单中的IP</span>        include /soft/nginx/IP/blockip.conf<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># -------黑名单：BlocksIP.conf---------</span>deny <span class="token number">192.177</span>.12.222<span class="token punctuation">;</span> <span class="token comment"># 屏蔽192.177.12.222访问</span>deny <span class="token number">192.177</span>.44.201<span class="token punctuation">;</span> <span class="token comment"># 屏蔽192.177.44.201访问</span>deny <span class="token number">127.0</span>.0.0/8<span class="token punctuation">;</span> <span class="token comment"># 屏蔽127.0.0.1到127.255.255.254网段中的所有IP访问</span><span class="token comment"># --------白名单：WhiteIP.conf---------</span>allow <span class="token number">192.177</span>.12.222<span class="token punctuation">;</span> <span class="token comment"># 允许192.177.12.222访问</span>allow <span class="token number">192.177</span>.44.201<span class="token punctuation">;</span> <span class="token comment"># 允许192.177.44.201访问</span>allow <span class="token number">127.45</span>.0.0/16<span class="token punctuation">;</span> <span class="token comment"># 允许127.45.0.1到127.45.255.254网段中的所有IP访问</span>deny all<span class="token punctuation">;</span> <span class="token comment"># 除开上述IP外，其他IP全部禁止访问</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx跨域配置</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">location / <span class="token punctuation">&#123;</span>    <span class="token comment"># 允许跨域的请求，可以自定义变量$http_origin，*表示所有</span>    add_header <span class="token string">'Access-Control-Allow-Origin'</span> *<span class="token punctuation">;</span>    <span class="token comment"># 允许携带cookie请求</span>    add_header <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span><span class="token punctuation">;</span>    <span class="token comment"># 允许跨域请求的方法：GET,POST,OPTIONS,PUT</span>    add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET,POST,OPTIONS,PUT'</span><span class="token punctuation">;</span>    <span class="token comment"># 允许请求时携带的头部信息，*表示所有</span>    add_header <span class="token string">'Access-Control-Allow-Headers'</span> *<span class="token punctuation">;</span>    <span class="token comment"># 允许发送按段获取资源的请求</span>    add_header <span class="token string">'Access-Control-Expose-Headers'</span> <span class="token string">'Content-Length,Content-Range'</span><span class="token punctuation">;</span>    <span class="token comment"># 一定要有！！！否则Post请求无法进行跨域！</span>    <span class="token comment"># 在发送Post跨域请求前，会以Options方式发送预检请求，服务器接受时才会正式请求</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        add_header <span class="token string">'Access-Control-Max-Age'</span> <span class="token number">1728000</span><span class="token punctuation">;</span>        add_header <span class="token string">'Content-Type'</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">;</span>        add_header <span class="token string">'Content-Length'</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment"># 对于Options方式的请求返回204，表示接受跨域请求</span>        <span class="token builtin class-name">return</span> <span class="token number">204</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx防盗链</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在动静分离的location中开启防盗链机制</span>location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>bmp<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token operator">|</span>txt<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment"># 最后面的值在上线前可配置为允许的域名地址</span>    valid_referers blocked <span class="token number">192.168</span>.12.129 *.poyais.cn www.roxn.cn<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment"># 可以配置成返回一张禁止盗取的图片，优雅的禁止盗链。</span>        <span class="token comment"># rewrite   ^/ http://xx.xx.com/NO.jpg;</span>        <span class="token comment"># 也可直接返回403</span>        <span class="token builtin class-name">return</span>   <span class="token number">403</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>       root   /soft/nginx/static_resources<span class="token punctuation">;</span>    expires 7d<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 上面的配置可以过滤大部分的盗链，少部分程序伪装盗链可以使用ngx_http_secure_link_module模块，对请求的链接进行真伪校验，并限制链接的有效时间。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx大文件传输</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置请求体允许的最大体积</span>client_max_body_size 1024m<span class="token punctuation">;</span><span class="token comment"># 等待客户端发送一个请求头的超时时间</span>client_header_timeout 1s<span class="token punctuation">;</span><span class="token comment"># 设置读取请求体的超时时间</span>client_body_timeout 1s<span class="token punctuation">;</span><span class="token comment"># 设置请求被后端服务器读取时，nginx等待的最长时间</span>proxy_read_timeout 15s<span class="token punctuation">;</span><span class="token comment"># 设置后端向nginx返回响应时的超时时间</span>proxy_send_timeout 10s<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginxSSL</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ------HTTP请求转HTTPS--------</span>server <span class="token punctuation">&#123;</span>    <span class="token comment"># 监听HTTP默认的80端口</span>    listen       <span class="token number">80</span><span class="token punctuation">;</span>    <span class="token comment"># 如果80端口出现访问该域名的请求</span>    server_name  n9e.xxxx.cn<span class="token punctuation">;</span>    <span class="token comment"># 将请求改写为HTTPS（这里写你配置了HTTPS的域名</span>    rewrite ^ https://<span class="token variable">$http_host</span><span class="token variable">$request_uri</span>? permanent<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># ----------HTTPS配置-----------</span>server <span class="token punctuation">&#123;</span>    <span class="token comment"># 监听HTTPS默认的443端口，开启ssl http2</span>    listen      <span class="token number">443</span> ssl http2<span class="token punctuation">;</span>    <span class="token comment"># 配置自己项目的域名</span>    server_name  n9e.hqzg.cloud<span class="token punctuation">;</span>    <span class="token comment"># 设置字符集</span>    charset utf-8<span class="token punctuation">;</span>    <span class="token comment"># 数字证书，pem、crt、cer等等格式</span>    ssl_certificate /etc/nginx/cert/hqzg.cloud.cer<span class="token punctuation">;</span>    <span class="token comment"># 证书私钥</span>    ssl_certificate_key /etc/nginx/cert/hqzg.cloud.key<span class="token punctuation">;</span>    <span class="token comment"># 停止通信时，加密会话的有效期，在该时间段内不需要重新交换密钥</span>    ssl_session_timeout 5m<span class="token punctuation">;</span>    <span class="token comment"># TLS握手时，服务器采用的密码套件</span>    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256::<span class="token operator">!</span>MD5<span class="token punctuation">;</span>    <span class="token comment"># 服务器支持的TLS版本</span>    ssl_protocols TLSv1.2 TLSv1.3<span class="token punctuation">;</span>    <span class="token comment"># 开启由服务器决定采用的密码套件</span>    ssl_prefer_server_ciphers on<span class="token punctuation">;</span>    <span class="token comment"># HSTS Header，告诉浏览器，在接下来的31536000秒内（1年），对于当前域名及其子域名的后续通信应该强制性的只使用HTTPS，直到超过有效期为止。</span>    add_header Strict-Transport-Security <span class="token string">"max-age=31536000"</span><span class="token punctuation">;</span>    location / <span class="token punctuation">&#123;</span>        <span class="token punctuation">..</span><span class="token punctuation">..</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;&lt;</span><span class="token string">"EOF"# SSL加速开启http2listen 443 ssl http2;调整Cipher优先级挑选更新更快的Cipher减少延迟# 手动启用 cipher 列表ssl_prefer_server_ciphers on;  # prefer a list of ciphers to prevent old and slow ciphersssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';优化国内Let's Encrypt 证书的服务或网站的延迟。解决这个问题的方法有两个：不使用 Let's Encrypt，可以尝试替换为阿里云提供的免费 DV 证书开启 OCSP Staplingssl_stapling on;ssl_stapling_verify on;ssl_trusted_certificate /path/to/full_chain.pem;调整ssl_buffer_size 建议 2 - 16kssl_buffer_size 4k;启用SSL Session缓存，减少TLS反复验证ssl_session_cache   shared:SSL:50m; # speed up first time. 1m ~= 4000 connectionsssl_session_timeout 4h;EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx重写</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># rewrite相关指令</span><span class="token comment"># set指令</span><span class="token builtin class-name">set</span> <span class="token variable">$variable</span> value<span class="token punctuation">;</span> location /test <span class="token punctuation">&#123;</span>     default_type text/html<span class="token punctuation">;</span>     <span class="token builtin class-name">set</span> <span class="token variable">$username</span> zhangsan<span class="token punctuation">;</span>     <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token operator">&lt;</span>html<span class="token operator">>></span><span class="token operator">&lt;</span>p<span class="token operator">></span>username:<span class="token variable">$username</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>request_uri:<span class="token variable">$request_uri</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>document_uri:<span class="token variable">$document_uri</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>uri:<span class="token variable">$uri</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>query_string:<span class="token variable">$query_string</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>args:<span class="token variable">$args</span><span class="token operator">&lt;</span>/p<span class="token operator">></span><span class="token operator">&lt;</span>/html<span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment"># if指令</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> POST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~ Mozilla/5.0<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>-f <span class="token variable">$request_filename</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>-f <span class="token variable">$request_filename</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token comment"># break指令</span> location /testBreak <span class="token punctuation">&#123;</span>     default_type text/plain<span class="token punctuation">;</span>     <span class="token builtin class-name">set</span> <span class="token variable">$username</span> lisi<span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>     <span class="token builtin class-name">set</span> <span class="token variable">$username</span> wangwu<span class="token punctuation">;</span>         <span class="token builtin class-name">break</span><span class="token punctuation">;</span>         <span class="token builtin class-name">set</span> <span class="token variable">$username</span> zhaoliu<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     add_header username <span class="token variable">$username</span><span class="token punctuation">;</span>     <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token variable">$username</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment"># return指令</span>location /testReturn <span class="token punctuation">&#123;</span>default_type text/plain<span class="token punctuation">;</span><span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">"test return"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>location /testReturn <span class="token punctuation">&#123;</span><span class="token builtin class-name">return</span> <span class="token number">302</span> https://www.baidu.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>location /testReturn <span class="token punctuation">&#123;</span><span class="token builtin class-name">return</span> https://www.baidu.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># rewrite指令</span>location /rewrite <span class="token punctuation">&#123;</span>rewrite ^/rewrite/aaa<span class="token punctuation">\</span>w+$ https://www.baidu.com<span class="token punctuation">;</span>rewrite ^/rewrite/<span class="token punctuation">(</span>bbb<span class="token punctuation">)</span><span class="token punctuation">\</span>w+$ /<span class="token variable">$1</span> last<span class="token punctuation">;</span>   <span class="token comment"># 停止处理rewrite指令，使用重写URI与各个location匹配</span>rewrite ^/rewrite/<span class="token punctuation">(</span>ccc<span class="token punctuation">)</span><span class="token punctuation">\</span>w+$ /<span class="token variable">$1</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span>   <span class="token comment"># 停止处理rewrite，与break效果一样</span>rewrite ^/rewrite/<span class="token punctuation">(</span>ddd<span class="token punctuation">)</span><span class="token punctuation">\</span>w+$ /<span class="token variable">$1</span> redirect<span class="token punctuation">;</span>   <span class="token comment"># 302响应不以http(s)://、或$scheme开头，就重写URL</span>rewrite ^/rewrite/<span class="token punctuation">(</span>eee<span class="token punctuation">)</span><span class="token punctuation">\</span>w+$ /<span class="token variable">$1</span> permanent<span class="token punctuation">;</span>   <span class="token comment"># 301响应重写URL</span><span class="token punctuation">&#125;</span>location /bbb <span class="token punctuation">&#123;</span>default_type text/plain<span class="token punctuation">;</span><span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">"this is bbb"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>location /ccc <span class="token punctuation">&#123;</span>default_type text/plain<span class="token punctuation">;</span><span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">"this is ccc"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>location /ddd <span class="token punctuation">&#123;</span>default_type text/plain<span class="token punctuation">;</span><span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">"this is ddd"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>location /eee <span class="token punctuation">&#123;</span>default_type text/plain<span class="token punctuation">;</span><span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">"this is eee"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># rewrite_log指令</span>location /rewrite <span class="token punctuation">&#123;</span><span class="token comment"># 开启rewrite_log</span>rewrite_log on<span class="token punctuation">;</span><span class="token comment"># 配置error_log</span>error_log logs/error.log notice<span class="token punctuation">;</span>rewrite ^/rewrite/aaa<span class="token punctuation">\</span>w+$ https://www.baidu.com<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx实时流量镜像</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ngx_http_mirror_module模块特性：nginx <span class="token number">1.13</span>.4及后续版本内置ngx_http_mirror_module模块，提供流量镜像<span class="token punctuation">(</span>复制<span class="token punctuation">)</span>的功能。支持流量放大，做法为：配置多份相同镜像。相比tcp-copy的优势：无需录制流量，实时可用；配置相当简单。源站请求，直接原路返回；正常配置下，mirror请求不影响源站请求及响应，源站nginx-server将流量复制到mirror站后，两者不再有任何交集。作用：nginx镜像流量接入自建开源WAF，以消除对源站的影响<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>TCP流量转发</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># TCP转发写法1</span>stream  <span class="token punctuation">&#123;</span>     server <span class="token punctuation">&#123;</span>         listen <span class="token number">3306</span><span class="token punctuation">;</span>         proxy_pass <span class="token number">192.168</span>.110.101:3306<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token comment"># 配置白名单</span> stream  <span class="token punctuation">&#123;</span>     allow <span class="token number">192.168</span>.110.100<span class="token punctuation">;</span>     deny all<span class="token punctuation">;</span>     server <span class="token punctuation">&#123;</span>         listen <span class="token number">3306</span><span class="token punctuation">;</span>         proxy_pass <span class="token number">192.168</span>.110.101:3306<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token comment"># TCP转发写法2</span> stream  <span class="token punctuation">&#123;</span>     upstream mysql_socket <span class="token punctuation">&#123;</span>         server <span class="token number">192.168</span>.110.101:3306<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     server <span class="token punctuation">&#123;</span>             listen <span class="token number">3306</span><span class="token punctuation">;</span>             proxy_pass mysql_socket<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其它优化</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 打开长连接配置</span>upstream xxx <span class="token punctuation">&#123;</span>    <span class="token comment"># 长连接数</span>    keepalive <span class="token number">32</span><span class="token punctuation">;</span>    <span class="token comment"># 每个长连接提供的最大请求数</span>    keepalived_requests <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token comment"># 每个长连接没有新的请求时，保持的最长时间</span>    keepalive_timeout 60s<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 开启零拷贝技术</span>sendfile on<span class="token punctuation">;</span><span class="token comment"># 开启无延迟或多包共发机制</span>tcp_nodelay on<span class="token punctuation">;</span>tcp_nopush on<span class="token punctuation">;</span><span class="token comment"># 调整Worker工作进程</span>worker_processes auto<span class="token punctuation">;</span><span class="token comment"># 每个Worker能打开的文件描述符，最少调整至1W以上，负荷较高建议2-3W</span>worker_rlimit_nofile <span class="token number">20000</span><span class="token punctuation">;</span><span class="token comment"># 开启CPU亲和机制</span>worker_cpu_affinity auto<span class="token punctuation">;</span><span class="token comment"># 开启epoll模型及调整并发连接数</span>events <span class="token punctuation">&#123;</span>    <span class="token comment"># 使用epoll网络模型</span>    use epoll<span class="token punctuation">;</span>    <span class="token comment"># 调整每个Worker能够处理的连接数上限</span>    worker_connections  <span class="token number">10240</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装部署nginxha"><a href="#安装部署nginxha" class="headerlink" title="安装部署nginxha"></a>安装部署nginxha</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h4><blockquote><p>编辑keepalived的配置文件<code>vi /etc/keepalived/keepalived.conf</code><br>主机137.12.7.129和137.12.7.130</p></blockquote><pre class="line-numbers language-none"><code class="language-none">! Configuration File for keepalivedglobal_defs &#123;# 自带的邮件提醒服务，建议用独立的监控或第三方SMTP，也可选择配置邮件发送。notification_email &#123;xx@xx.com&#125;notification_email_from xx@xx.comsmtp_server 127.0.0.1smtp_connect_timeout 30# 高可用集群主机身份标识(集群中主机身份标识名称不能重复，建议配置成本机IP)router_id HAbackup-129&#125;# 定时运行的脚本文件配置vrrp_script chk_http_port &#123;  # 之前编写的nginx重启脚本的所在位置  script &quot;&#x2F;opt&#x2F;chk_nginx.sh&quot;  # 每间隔2秒执行一次  interval 2  # 如果脚本中的条件成立，重启一次则权重-5  weight -5  fall 2  rise 1&#125;vrrp_instance VI_1 &#123;  state MASTER   # 设置MASTER&#x2F;SLAVE  interface eth0  mcast_src_ip 137.12.7.129   # 本机IP  virtual_router_id 51   # keepalived集群，ID要保持一致  priority 150   # 权重，权重越大VIP优先级越高  # 优先级高的设置nopreempt，解决异常恢复后再次抢占造成的脑裂问题  nopreempt  # 组播信息发送间隔，两个节点设置必须一样，默认1s（类似于心跳检测）  advert_int 1   authentication &#123;    auth_type PASS    auth_pass 1111   # 集群密码保持一致  &#125;  virtual_ipaddress &#123;     137.12.7.168   # VIP可配置多个  &#125;track_script &#123;   # 执行Nginx监控的脚本   chk_http_port&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nginx自启"><a href="#nginx自启" class="headerlink" title="nginx自启"></a>nginx自启</h2><blockquote><p>编辑nginx自启脚本<code>vi /opt/chk_nginx.sh</code></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">counter</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> <span class="token parameter variable">-C</span> nginx --no-heading<span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">)</span></span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$counter</span>"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$&#123;counter&#125;</span>"</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    /home/nginx/sbin/nginx   <span class="token comment"># 编译安装</span><span class="token comment">#   systemctl start nginx   # yum安装</span>    <span class="token function">sleep</span> <span class="token number">2</span>    <span class="token assign-left variable">counter</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> <span class="token parameter variable">-C</span> nginx --no-heading<span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">)</span></span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$&#123;counter&#125;</span>"</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>   systemctl stop keepalived    <span class="token keyword">fi</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>授权<code>chmod +x /opt/chk_nginx.sh</code></p></blockquote><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><blockquote><p>手动停止nginx会自动重启<br>停止keepalived，VIP会漂移至130主</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> nginxha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch</title>
      <link href="/posts/faf3d18c.html"/>
      <url>/posts/faf3d18c.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Elasticsearch集群搭建文中有两种方式：单机版修改成集群配置、新建新的集群将单机版数据导入集群。</p></blockquote><h1 id="单机安装"><a href="#单机安装" class="headerlink" title="单机安装"></a>单机安装</h1><p>下载软件包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装JDK略</span><span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.5.4.tar.gz<span class="token function">useradd</span> elasticsearch<span class="token function">tar</span> xf elasticsearch-6.5.4.tar.gz <span class="token parameter variable">-C</span> /home/<span class="token function">chown</span> <span class="token parameter variable">-R</span> elasticsearch. /home/elasticsearch-6.5.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编辑配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'55cnetwork.host: 0.0.0.0'</span> /home/elasticsearch-6.5.4/config/elasticsearch.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>jvm调整及系统参数调整</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">vm</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$<span class="token punctuation">(</span>free <span class="token operator">-</span>g <span class="token operator">|</span> grep Mem <span class="token operator">|</span> awk '&#123;print $<span class="token number">2</span>&#125;'<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token variable">))</span></span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">"/^-Xms/c -Xms<span class="token variable">$&#123;vm&#125;</span>g"</span> <span class="token parameter variable">-e</span> <span class="token string">"/^-Xmx/c -Xmx<span class="token variable">$&#123;vm&#125;</span>g"</span>  /home/elasticsearch-6.5.4/config/jvm.options<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span>  <span class="token string">"s/4096/40960/g"</span> /etc/security/limits.d/20-nproc.conf<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"*  soft  nofile  65536 <span class="token entity" title="\n">\n</span>*  hard  nofile  131072"</span><span class="token operator">>></span>/etc/security/limits.conf<span class="token builtin class-name">echo</span> <span class="token string">"vm.max_map_count = 655360"</span><span class="token operator">>></span> /etc/sysctl.conf<span class="token function">sysctl</span> <span class="token parameter variable">-p</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安装ik</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 初次安装es没有ik插件，需要到官网下载ik插件，全称analysis-ik，放在安装elasticsearch目录的plugins下面</span><span class="token function">wget</span> https://github.91chifun.workers.dev/https://github.com//medcl/elasticsearch-analysis-ik/releases/download/v6.8.18/elasticsearch-analysis-ik-6.8.18.zip<span class="token comment"># 或者直接使用随文档一起的压缩文件ik.tgz，注意plugins/目录只能放插件，不要把压缩包拷贝进去，否则启动es报错*ik.tgz*。</span>/home/elasticsearch-6.5.4/plugins/analysis-ik<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>启动服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> - elasticsearch <span class="token parameter variable">-c</span> <span class="token string">"/home/elasticsearch-6.5.4/bin/elasticsearch -d"</span> 启动<span class="token comment"># 设置开机自启</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">'source /etc/profile \nsu elasticsearch -c "/home/elasticsearch-6.5.4/bin/elasticsearch -d"'</span> <span class="token operator">>></span>/etc/rc.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>运行状态监控</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过进程状态来查看运行状态：</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> elasticsearch<span class="token comment"># 通过端口状态来查看运行状态：</span><span class="token function">netstat</span> <span class="token parameter variable">-ntplua</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">9200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="单机Elasticsearch备份恢复"><a href="#单机Elasticsearch备份恢复" class="headerlink" title="单机Elasticsearch备份恢复"></a>单机Elasticsearch备份恢复</h1><h2 id="安装elasticdump"><a href="#安装elasticdump" class="headerlink" title="安装elasticdump"></a>安装elasticdump</h2><h3 id="方法一-NPM安装"><a href="#方法一-NPM安装" class="headerlink" title="方法一 NPM安装"></a>方法一 NPM安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装npm并升级，否则执行elasticdump报错*loop*</span><span class="token function">curl</span> <span class="token parameter variable">--silent</span> <span class="token parameter variable">--location</span> https://rpm.nodesource.com/setup_10.x <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nodejs<span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> nn latest<span class="token comment"># 安装elasticdump</span><span class="token function">npm</span> <span class="token function">install</span> elasticdump <span class="token parameter variable">-g</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方法二-离线安装"><a href="#方法二-离线安装" class="headerlink" title="方法二 离线安装"></a>方法二 离线安装</h3><blockquote><p>去官网下载nodejs的tar包，在互联网利用npm下载elasticdump<br>copy到离线环境，配置环境变量</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/home/node/node-v16.7.0-linux-x64/bin:/home/node/elasticdump/bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>导入/出模板，注意同一个索引需要导入/出mapping和data两个类型数据。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">elasticdump <span class="token parameter variable">--input</span><span class="token operator">=</span>http://IP:PORT/索引名 <span class="token parameter variable">--output</span><span class="token operator">=</span>./索引名_mapping.json <span class="token parameter variable">--type</span><span class="token operator">=</span>mappingelasticdump <span class="token parameter variable">--input</span><span class="token operator">=</span>http://IP:PORT/索引名 <span class="token parameter variable">--output</span><span class="token operator">=</span>./索引名_data.json <span class="token parameter variable">--type</span><span class="token operator">=</span>dataelasticdump <span class="token parameter variable">--output</span><span class="token operator">=</span>http://IP:PORT/索引名 <span class="token parameter variable">--input</span><span class="token operator">=</span>/home/索引名_mapping.json <span class="token parameter variable">--type</span><span class="token operator">=</span>mappingelasticdump <span class="token parameter variable">--output</span><span class="token operator">=</span>http://IP:PORT/索引名 <span class="token parameter variable">--input</span><span class="token operator">=</span>/home/索引名_data.json <span class="token parameter variable">--type</span><span class="token operator">=</span>data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="旧机器导出数据"><a href="#旧机器导出数据" class="headerlink" title="旧机器导出数据"></a>旧机器导出数据</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看所有索引</span><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">'localhost:9200/_cat/indices?v&amp;pretty'</span><span class="token comment"># 导出数据，一条索引，分别导出mapping和data</span>elasticdump <span class="token parameter variable">--input</span><span class="token operator">=</span>http://localhost:9200/avm_index <span class="token parameter variable">--output</span><span class="token operator">=</span>./avm_index_mapping.json <span class="token parameter variable">--type</span><span class="token operator">=</span>mapping elasticdump <span class="token parameter variable">--input</span><span class="token operator">=</span>http://localhost:9200/avm_index <span class="token parameter variable">--output</span><span class="token operator">=</span>./avm_index_data.json <span class="token parameter variable">--type</span><span class="token operator">=</span>data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="新机器导入数据"><a href="#新机器导入数据" class="headerlink" title="新机器导入数据"></a>新机器导入数据</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导入数据，一条索引，分别导入mapping和data</span><span class="token function">su</span> - elasticsearch <span class="token parameter variable">-c</span> <span class="token string">"elasticdump --output=http://localhost:9200/avm_index --input=/home/wangj-pdmi/avm_index_mapping.json --type=mapping"</span><span class="token function">su</span> - elasticsearch <span class="token parameter variable">-c</span> <span class="token string">"elasticdump --output=http://localhost:9200/avm_index --input=/home/wangj-pdmi/avm_index_data.json --type=data"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看所有索引</span><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">'localhost:9200/_cat/indices?v&amp;pretty'</span><span class="token comment"># 获取索引信息*/索引名?pretty</span><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">"localhost:9200/索引名?pretty"</span><span class="token comment"># 查看索引的统计信息*/索引名/_stats?pretty</span><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">"localhost:9200/索引名/_stats?pretty"</span><span class="token comment"># 获取索引的mappings</span><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">"localhost:9200/索引名/_mappings?pretty"</span><span class="token comment"># 删除索引</span><span class="token function">curl</span> <span class="token parameter variable">-XDELETE</span> <span class="token string">"localhost:9200/索引名"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h1><p>以上述搭建好的单机为例，在此基础上搭建Elasticsearch集群。记得修改系统配置、安装JDK。</p><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p><code>vi elasticsearch.yml</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster.name: elasticsearch   <span class="token comment"># 集群名3台机器保持一致</span>node.name: node-1   <span class="token comment"># 集群中节点名，3台机器保持不同</span>path.data: /home/elasticsearch/es_datapath.logs: /home/elasticsearch/es_logsbootstrap.memory_lock: <span class="token boolean">true</span>network.host: <span class="token number">192.168</span>.0.130   <span class="token comment"># 绑定主机的IP</span>discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">"192.168.0.132"</span>, <span class="token string">"192.168.0.130"</span>, <span class="token string">"192.168.0.131"</span><span class="token punctuation">]</span>node.master: <span class="token boolean">true</span>http.cors.enabled: <span class="token boolean">true</span>http.cors.allow-origin: <span class="token string">"*"</span>http.max_content_length: 500mb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="附录（一）"><a href="#附录（一）" class="headerlink" title="附录（一）"></a>附录（一）</h1><p>安装kibana</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://artifacts.elastic.co/downloads/kibana/kibana-6.5.4-linux-x86_64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h1><p>这里比较几个东西：</p><ol><li><p><code>kafka</code>，应用在消息、行为跟踪、日志收集方面（吞吐量巨大，内置分区，冗余和容错性）</p></li><li><p><code>mqtt</code>，在物联网系统应用广泛（工作在低宽带，不可靠的网络远程通讯系统中）</p></li><li><p><code>redis</code>，key-value的nosql数据库，可作为队列使用（小数据入队性能要优于rabbitmq，rabbitmq的出队性能则远低于redis）</p></li><li><p><code>rabbitmq</code>，吞吐量不如kafka，可用性优于kafka（rabbitmq支持miror的queue，主queue失效，miror queue接管）</p></li></ol><p>这里总结一下：</p><p><code>kafka</code>：可用于峰值数亿级的日志收集，常用于分布式架构，对性能要求高的可以考虑kafka</p><p><code>RocketMQ</code>：思路来源于KAFKA，改成了主从结构，在事务性可靠性方面做了优化，广泛来说，电商、金融等对事务性要求很高，可以考虑RabbitMQ和RocketMQ；</p><p><code>mqtt</code>：在物联网中任然是不可取代的存在。遥感数据，汽车，智能家居，智慧城市，医疗医护等；</p><p><code>redis</code>：key-value的nosql数据库，还是做数据库、缓存使用吧；</p><p><code>rabbitmq</code>：消息队列，在对数据完整性要求高的场景使用吧，增加集群装机量来弥补吞吐量的不足。</p><h1 id="一些ELK的架构图"><a href="#一些ELK的架构图" class="headerlink" title="一些ELK的架构图"></a>一些ELK的架构图</h1><p><img src="/medias/img/elk/0.jpg"><br><img src="/medias/img/elk/0.png"><br><img src="/medias/img/elk/1.jpg"><br><img src="/medias/img/elk/1.png"></p><p>这里展示了4张包含kafka日志收集的ELK架构，我的理解是：</p><p><code>filebeat(web logs)</code> –&gt; <code>[+logstash]kafka</code> –&gt; <code>logstash</code> –&gt; <code>elasticsearch</code> –&gt; <code>kibana</code> –&gt; <code>nginx</code></p><p>解释：</p><p>Q1：filebeat和logstash为什么分离？</p><p>Q2：为什么两层logstash？</p><p>Q3：kafka有什么用？why kafka？</p><p>A1：原因很简单，资源消耗比较大。</p><p>由于 Logstash 是跑在 JVM 上面，资源消耗比较大，后来作者用 GO 写了一个功能较少但是资源消耗也小的轻量级的 Agent 叫 Logstash-forwarder。</p><p>后来作者加入 elastic.co 公司， Logstash-forwarder 的开发工作给公司内部 GO 团队来搞，最后命名为 Filebeat。</p><p>Filebeat 需要部署在每台应用服务器上，可以通过 Salt 来推送并安装配置。</p><p>A2：你可以在kafka前面增加0-多台logstash，因为在大量的日志数据写入时，容易导致数据的丢失和混乱，为了解决这一问题，增加logstash通过类型进行汇总分类，降低数据传输的臃肿。在elasticsearch前增加一层logstash仅作转发处理，既可以通过kibana监控实时数据流，又能将kafka数据源源不断的存储到elasticsearch磁盘中。</p><p>当然你可以配置将filebeat收集到的日志直接导入到kafka集群中。</p><p>A3：Kafka主要特点是基于Pull的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输。0.8版本开始支持复制，不支持事务，对消息的重复、丢失、错误没有严格要求，适合产生大量数据的互联网服务的数据收集业务。</p><p>你也可以使用别的日志收集工具，甚至是只用ELK。</p><p>你必须要知道这是根据你的业务场景来决定的，如果你在金融部门，Kafka并不是你的第一选择。</p><p>补充：</p><p>整个架构加入Kafka，是为了让整个系统更好的分层，Kafka作为一个消息流处理与持久化存储软件，能够帮助我们在主节点上屏蔽掉多个从节点之间不同日志文件的差异，负责管理日志端（从节点）的人可以专注于向 Kafka里生产数据，而负责数据分析聚合端的人则可以专注于从 Kafka内消费数据。所以部署时要把Kafka加进去。</p><p>而且使用Kafka进行日志传输的原因还在于其有数据缓存的能力，并且它的数据可重复消费，Kafka本身具有高可用性，能够很好的防止数据丢失，它的吞吐量相对来说比较好并且使用广泛。可以有效防止日志丢失和防止logsthash挂掉。综合来说：它均衡了网络传输，从而降低了网络闭塞，尤其是丢失数据的可能性。</p><p>这里为什么要在Kafka前面增加二台logstash呢？</p><p>如果只有一层的Logstash，它将处理来自不同客户端Filebeat收集的日志信息汇总，并且进行处理分析，在一定程度上会造成在大规模日志数据下信息的处理混乱，并严重加深负载，所以有二层的结构进行负载均衡处理，并且职责分工，一层汇聚简单分流，一层分析过滤处理信息，并且内层都有二台Logstash来保障服务的高可用性，以此提升整个架构的稳定性。</p><h1 id="安装ELK"><a href="#安装ELK" class="headerlink" title="安装ELK"></a>安装ELK</h1><p>采用kafka+ELK采集log。</p><h2 id="服务器和角色"><a href="#服务器和角色" class="headerlink" title="服务器和角色"></a>服务器和角色</h2><table><thead><tr><th align="left">IP</th><th align="left">主机名</th><th align="left">角色</th></tr></thead><tbody><tr><td align="left">192.168.1.90</td><td align="left">node0</td><td align="left">web log+filebeat</td></tr><tr><td align="left">192.168.1.91</td><td align="left">node1</td><td align="left">kafka+zookeeper</td></tr><tr><td align="left">192.168.1.92</td><td align="left">node2</td><td align="left">kafka+zookeeper</td></tr><tr><td align="left">192.168.1.93</td><td align="left">node3</td><td align="left">kafka+zookeeper</td></tr><tr><td align="left">192.168.1.94</td><td align="left">node4</td><td align="left">logstash</td></tr><tr><td align="left">192.168.1.95</td><td align="left">node5</td><td align="left">elasticsearch kibana nginx</td></tr></tbody></table><h2 id="导入密钥"><a href="#导入密钥" class="headerlink" title="导入密钥"></a>导入密钥</h2><p><code>rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</code></p><h2 id="配置yum仓库安装"><a href="#配置yum仓库安装" class="headerlink" title="配置yum仓库安装"></a>配置yum仓库安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>elasticsearch<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>Elasticsearch repository <span class="token keyword">for</span> <span class="token number">7</span>.x packages<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://artifacts.elastic.co/packages/7.x/yum<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://artifacts.elastic.co/GPG-KEY-elasticsearch<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">autorefresh</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">type</span><span class="token operator">=</span>rpm-md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="直接下载rpm包安装"><a href="#直接下载rpm包安装" class="headerlink" title="直接下载rpm包安装"></a>直接下载rpm包安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># https://elasticsearch.cn/download/   # 中文社区下载地址，建议使用迅雷等工具下载。</span><span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.8.0-x86_64.rpm<span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.8.0-x86_64.rpm.sha512shasum <span class="token parameter variable">-a</span> <span class="token number">512</span> <span class="token parameter variable">-c</span> elasticsearch-7.8.0-x86_64.rpm.sha512 <span class="token function">rpm</span> <span class="token parameter variable">--install</span> elasticsearch-7.8.0-x86_64.rpm<span class="token function">wget</span> https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-x86_64.rpm<span class="token function">wget</span> https://artifacts.elastic.co/downloads/logstash/logstash-7.8.0.rpm<span class="token function">wget</span> https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.8.0-x86_64.rpm<span class="token function">wget</span> https://mirrors.aliyun.com/apache/kafka/2.5.0/kafka_2.13-2.5.0.tgz<span class="token function">wget</span> https://mirrors.aliyun.com/apache/zookeeper/zookeeper-3.6.1/apache-zookeeper-3.6.1-bin.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># node0节点</span>hostnamectl set-hostname node0   <span class="token comment"># 设置主机名</span>systemctl stop firewalld   <span class="token comment"># 关闭防火墙</span>setenforce <span class="token number">0</span>   <span class="token comment"># 关闭selinux</span><span class="token function">tee</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF192.168.1.90 node0192.168.1.91 node1192.168.1.92 node2192.168.1.93 node3192.168.1.94 node4192.168.1.95 node5EOF</span>   <span class="token comment"># 设置主机名</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nginx filebeat <span class="token comment"># node123安装zookeeper+kafka</span><span class="token builtin class-name">cd</span> /home<span class="token function">tar</span> xf apache-zookeeper-3.6.1-bin.tar.gz<span class="token function">mv</span> apache-zookeeper-3.6.1-bin/ zookeeper<span class="token builtin class-name">cd</span> zookeeper/<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> tmp/zookeeper<span class="token builtin class-name">echo</span> <span class="token string">"1"</span> <span class="token operator">></span> tmp/zookeeper/myid<span class="token comment"># node上安装配置kafka</span><span class="token function">tar</span> xf kafka_2.13-2.5.0.tgz<span class="token function">mv</span> kafka_2.13-2.5.0/ kafka<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/kafka-logs<span class="token comment"># 生成zookeeper配置文件</span><span class="token builtin class-name">cd</span> conf<span class="token function">cp</span> zoo_sample.cfg zoo.cfg<span class="token comment"># node4</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">java</span> java-devel logstash<span class="token comment"># node5</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> elasticsearch kibana nginx httpd-tools   <span class="token comment"># epel-release</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><blockquote><p>nginx</p></blockquote><p><code>/etc/nginx/nginx.conf</code></p><p>修改Nginx配置文件添加以下内容</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">log_format json &#39;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&quot;@version&quot;:&quot;1&quot;,&quot;client_ip&quot;:&quot;$remote_addr&quot;,&quot;status&quot;:&quot;$status&quot;,&quot;host&quot;:&quot;$server_addr&quot;,&quot;url&quot;:&quot;$request_uri&quot;,&quot;domain&quot;:&quot;$host&quot;,&quot;size&quot;:&quot;$body_bytes_sent&quot;,&quot;responsetime&quot;:&quot;$request_time&quot;,&quot;referer&quot;:&quot;$scheme:&#x2F;&#x2F;$server_addr$request_uri&quot;,&quot;user_agent&quot;:&quot;$http_user_agent&quot;&#125;&#39;;access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log json;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>filebeat</p></blockquote><p><code>/etc/filebeat/filebeat.yml</code>详细配置在解释末</p><p>filebeat支持很多种输入和输出.具体可看input,output.</p><p>项目中用到的输入是log,输出的kafka.在这只讲这两种配置.</p><p>输入配置log</p><p>log输入是从文件中按行读取.在paths指定需要监视的文件.</p><p>例子:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /var/log/nginx    <span class="token punctuation">-</span> /var/log/<span class="token important">*.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主要有以下几个配置项.</p><p><code>paths</code>：需要监视的文件路径.支持Go Glab的所有模式.例如: /var/log/*.log.这个配置将监视/var/log文件夹下所有以.log结尾的文件.可以用recursive_glob来递归子文件夹.</p><p><code>recursive_glob.enabled</code>：允许扩展 * * 为递归的glob模式.启用此功能后. /foo/* * 扩展到/foo, /foo/* ,/foo/* /* ,等等,它会将单个扩展 * * 为8级深度*模式.</p><p>默认情况下启用此功能.设置false禁用.</p><p><code>exclude_lines</code>：正则表达式列表,用于匹配您希望Filebeat排除的行.Filebeat会删除与列表中的正则表达式匹配的所有行.默认情况下,不会删除任何行.空行被忽略.</p><p>以下示例将Filebeat配置为删除任何以DBG开头的行:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token punctuation">...</span>  <span class="token key atrule">exclude_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'^DBG'</span><span class="token punctuation">]</span>include_lines<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正则表达式列表,用于匹配您希望Filebeat包含的行.Filebeat仅导出与列表中的正则表达式匹配的行.默认情况下,将导出所有行.空行被忽略.</p><p>以下示例将Filebeat配置为导出以ERR或WARN开头的所有行:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token punctuation">...</span>  <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'^ERR'</span><span class="token punctuation">,</span> <span class="token string">'^WARN'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>PS: 如果include_lines和exclude_lines两个配置同时出现,优先执行inlcude_lines再执行exclude_lines.和配置项放的位置没有关系.</p><p><code>json</code>：filebeat支持json格式的消息日志.它将逐行处理日志,因此只有每行有一个json对象时,json解码才有效.</p><p>配置示例:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">json.add_error_key</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">json.message_key</span><span class="token punctuation">:</span> logenabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>输入开关.默认true打开.</p><p>输出配置kafka</p><p>kafka将输出流发送到Apache Kafka.</p><p>配置示例:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">output.kafka</span><span class="token punctuation">:</span>  <span class="token comment"># initial brokers for reading cluster metadata</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kafka1:9092"</span><span class="token punctuation">,</span> <span class="token string">"kafka2:9092"</span><span class="token punctuation">,</span> <span class="token string">"kafka3:9092"</span><span class="token punctuation">]</span>  <span class="token comment"># message topic selection + partitioning</span>  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">'%&#123;[fields.log_topic]&#125;'</span>  <span class="token key atrule">partition.round_robin</span><span class="token punctuation">:</span>    <span class="token key atrule">reachable_only</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">required_acks</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">compression</span><span class="token punctuation">:</span> gzip  <span class="token key atrule">max_message_bytes</span><span class="token punctuation">:</span> <span class="token number">1000000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主要以下几个配置项<br><code>enabled</code>：是否打开输出配置项.true打开,false关闭.默认是true.</p><p><code>hosts</code>：kafka的broker地址.</p><p><code>topic</code>：kafka的topic.</p><p><code>worker</code>：并发负载均衡Kafka输出工作线程的数量.</p><p><code>timeout</code>：kafka返回应答的等待时间.默认30(秒).</p><p><code>keep_alive</code>：连接的存活时间.如果为0,表示短连,发送完就关闭.默认为0秒.</p><p><code>required_acks</code>：ACK的可靠等级.0=无响应,1=等待本地消息,-1=等待所有副本提交.默认1.</p><p>PS：如果设为0,kafka无应答返回时,消息将丢失.</p><p>配置例子</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log   <span class="token comment"># 日志类型</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 可以让字段位于根节点</span>  <span class="token key atrule">json.overwrite_keys</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 对于同名的key，覆盖原有key值</span>  <span class="token key atrule">fields_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 可以让字段位于根节点</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /var/log/nginx/access.log   <span class="token comment"># 日志文件路径</span>  <span class="token key atrule">fields</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> log    <span class="token key atrule">log_topic</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>access   <span class="token comment"># 指定日志topic名称</span><span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>nginx<span class="token key atrule">output.kafka</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.91:9092"</span><span class="token punctuation">,</span><span class="token string">"192.168.1.92:9092"</span><span class="token punctuation">,</span><span class="token string">"192.168.1.93:9092"</span><span class="token punctuation">]</span>   <span class="token comment"># kafka集群地址</span>  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">'%&#123;[log_topic]&#125;'</span>   <span class="token comment"># fileds.log_topic 定义的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>zookeeper+kafka<br>node1编辑zookeeper配置文件zoo.cfg</p></blockquote><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">dataDir&#x3D;&#x2F;home&#x2F;zookeeper&#x2F;tmp&#x2F;zookeeperserver.1&#x3D;192.168.1.91:2888:3888server.2&#x3D;192.168.1.92:2888:3888server.3&#x3D;192.168.1.93:2888:3888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>配置node2和node3的zookeeper</p><p>依照node1的配置配置node2和node3，注意下面的参数三个节点各有差异</p><p>Node2：<code>echo &quot;2&quot; &gt; tmp/zookeeper/myid</code></p><p>Node3：<code>echo &quot;3&quot; &gt; tmp/zookeeper/myid</code></p><p>依次启动三个节点的服务<code>./bin/zkServer.sh start conf/zoo.cfg</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Using config:/usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfgStarting zookeeper <span class="token punctuation">..</span>. STARTED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><p>错误: 找不到或无法加载主类 org.apache.zookeeper.server.quorum.QuorumPeerMain<br>解决：下载apache-zookeeper-3.6.1-bin.tar.gz包运行</p><p>2020-07-05 19:43:54,474 [myid:] - ERROR [main:QuorumPeerMain@98] - Invalid config, exiting abnormally<br>org.apache.zookeeper.server.quorum.QuorumPeerConfig$ConfigException: Address unresolved: 192.168.1.91:3888<br>解决：myid文件的路径不对，我的后面有两个空格删掉就好了</p><hr><p>查看三个节点的状态</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Node1：<span class="token comment"># ./bin/zkServer.sh status</span><span class="token punctuation">[</span>root@localhost zookeeper<span class="token punctuation">]</span><span class="token comment"># ./bin/zkServer.sh status</span>/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfgClient port found: <span class="token number">2181</span>. Client address: localhost.Mode: followerNode2：<span class="token punctuation">[</span>root@localhost zookeeper<span class="token punctuation">]</span><span class="token comment"># ./bin/zkServer.sh status</span>/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfgClient port found: <span class="token number">2181</span>. Client address: localhost.Mode: leaderNode3：<span class="token punctuation">[</span>root@localhost zookeeper<span class="token punctuation">]</span><span class="token comment"># ./bin/zkServer.sh status</span>/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfgClient port found: <span class="token number">2181</span>. Client address: localhost.Mode: follower<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>node1配置kafka</p><p>/kafkaconfig/server.properties</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">9092</span><span class="token assign-left variable">host.name</span><span class="token operator">=</span>node1<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/home/kafka/tmp/kafka-logs<span class="token assign-left variable">num.partitions</span><span class="token operator">=</span><span class="token number">2</span><span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.1.91:2181,192.168.1.92:2181,192.168.1.93:2181<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置Node2和node3的kafka</p><p>依照node1的配置配置node2和node3，注意下面的参数三个节点各有差异</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Node2：<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">host.name</span><span class="token operator">=</span>node2node3：<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">2</span><span class="token assign-left variable">host.name</span><span class="token operator">=</span>node3说明：host.name是节点的主机名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>依次启动三个节点的kafka<code>./bin/kafka-server-start.sh config/server.properties</code></p><p>创建topic验证集群是否正常</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Node1上创建topic</span>./bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.1.91:2181 --replication-factor <span class="token number">3</span> <span class="token parameter variable">--partitions</span> <span class="token number">2</span> <span class="token parameter variable">--topic</span> test1Created topic <span class="token string">"test1"</span><span class="token builtin class-name">.</span><span class="token comment"># Node2上发送消息至kafka（2节点模拟producer）</span>./bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.1.91:9092 <span class="token parameter variable">--topic</span> test1hello world<span class="token comment"># Node3显示消息的消费（3节点模拟consumer）</span>./bin/kafka-console-consumer.sh <span class="token parameter variable">--zookeeper</span>  <span class="token number">192.168</span>.1.91:2181 <span class="token parameter variable">--topic</span> test1 --from-beginninghello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到在node2节点的输入的信息可以在nide3节点显示，说明集群正常使用。</p><hr><p>./bin/kafka-console-consumer.sh –zookeeper  192.168.1.91:2181 –topic test1 –from-beginning<br>报错：zookeeper is not a recognized option<br>这个是0.9之后的打开方式<br>/usr/java/kafka_2.12-2.2.0/bin/kafka-console-consumer.sh –bootstrap-server localhost:9092 –topic test –from-beginning<br>这个是0.9之前的打开方式<br>/usr/java/kafka_2.12-2.2.0/bin/kafka-console-consumer.sh –zookeeper localhost:2181 –topic test –from-beginning<br>解决：./bin/kafka-console-consumer.sh –bootstrap-server 192.168.1.91:9092 –topic test1 –from-beginning</p><hr><blockquote><p>logstash<br>/etc/logstash/conf.d/kafka.conf</p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">input <span class="token punctuation">&#123;</span>    kafka <span class="token punctuation">&#123;</span>        bootstrap_servers =<span class="token punctuation">></span> "192.168.1.91<span class="token punctuation">:</span><span class="token number">9092</span><span class="token punctuation">,</span>192.168.1.92<span class="token punctuation">:</span><span class="token number">9092</span><span class="token punctuation">,</span>192.168.1.93<span class="token punctuation">:</span>9092"   <span class="token comment"># kafka集群地址</span>        topics =<span class="token punctuation">></span> "dev<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>access"   <span class="token comment"># 接受topic的名称</span>        codec =<span class="token punctuation">></span> "json"   <span class="token comment"># 解析格式</span>        consumer_threads =<span class="token punctuation">></span> 5   <span class="token comment"># 最大线程</span>        decorate_events =<span class="token punctuation">></span> true   <span class="token comment"># 将当前topic、offset、group、partition等信息也带到message中</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>output <span class="token punctuation">&#123;</span>    elasticsearch <span class="token punctuation">&#123;</span>        hosts =<span class="token punctuation">></span> <span class="token punctuation">[</span><span class="token string">"192.168.1.95:9200"</span><span class="token punctuation">]</span>   <span class="token comment"># ES集群信息</span>        index =<span class="token punctuation">></span> "dev<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>access<span class="token punctuation">-</span>%<span class="token punctuation">&#123;</span>+YYYY<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd<span class="token punctuation">&#125;</span>"   <span class="token comment"># 索引格式建议按天切割</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/etc/logstash/logstash.yml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">path.data</span><span class="token punctuation">:</span> /var/lib/logstash<span class="token key atrule">pipeline.ordered</span><span class="token punctuation">:</span> auto<span class="token key atrule">path.config</span><span class="token punctuation">:</span> /etc/logstash/conf.d/<span class="token important">*.conf</span><span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /var/log/logstash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>/usr/share/logstash/bin/logstash -t -f /etc/logstash/conf.d/logstash-nginx.conf</code>测试是否OK</p><p>提示：Configuration OK</p><blockquote><p>elasticsearch<br><code>/etc/elasticsearch/elasticsearch.yml</code></p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 允许商业功能创建索引</span><span class="token key atrule">action.auto_create_index</span><span class="token punctuation">:</span> .monitoring*<span class="token punctuation">,</span>.watches<span class="token punctuation">,</span>.triggered_watches<span class="token punctuation">,</span>.watcher<span class="token punctuation">-</span>history*<span class="token punctuation">,</span>.ml*<span class="token comment"># 如果不确定本地的Logstash或Beats配置，可以考虑将该值设置为*，允许自动创建所有索引</span><span class="token key atrule">action.auto_create_index</span><span class="token punctuation">:</span> *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>配置样例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 更改数据和日志文件的路径实例</span><span class="token key atrule">path</span><span class="token punctuation">:</span>    <span class="token key atrule">data</span><span class="token punctuation">:</span> /var/lib/elasticsearch    <span class="token key atrule">logs</span><span class="token punctuation">:</span> /var/log/elasticsearch<span class="token comment"># 也可以这样并行写</span><span class="token key atrule">path.data</span><span class="token punctuation">:</span> /var/lib/elasticsearch<span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /var/log/elasticsearch<span class="token comment"># 以变量方式配置yml文件</span><span class="token key atrule">node.name</span><span class="token punctuation">:</span>    $<span class="token punctuation">&#123;</span>HOSTNAME<span class="token punctuation">&#125;</span><span class="token key atrule">network.host</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>ES_NETWORK_HOST<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>环境变量的值必须是简单的字符串。使用逗号分隔的字符串提供Elasticsearch将解析为列表的值。例如，Elasticsearch将以下字符串拆分为<code>$&#123;HOSTNAME&#125;</code>环境变量的值列表：</p><p><code>export HOSTNAME=&quot;host1,host2&quot;</code><br>一些配置文件</p><p><code>/etc/elasticsearch</code></p><ol><li><p><code>elasticsearch.yml</code> 用于配置Elasticsearch</p></li><li><p><code>jvm.options</code> 用于配置Elasticsearch JVM设置</p></li><li><p><code>log4j2.properties</code> 用于配置Elasticsearch日志记录</p></li></ol><h4 id="详细项"><a href="#详细项" class="headerlink" title="详细项"></a>详细项</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 自定义路径存储数据和日志。</span><span class="token key atrule">path</span><span class="token punctuation">:</span>  <span class="token key atrule">logs</span><span class="token punctuation">:</span> /var/log/elasticsearch  <span class="token key atrule">data</span><span class="token punctuation">:</span> /var/data/elasticsearch<span class="token comment"># 甚至你可以这样，将数据存到多个目录</span><span class="token comment"># path:</span><span class="token comment">#   data:</span><span class="token comment">#     - /mnt/elasticsearch_1</span><span class="token comment">#     - /mnt/elasticsearch_2</span><span class="token comment">#     - /mnt/elasticsearch_3</span><span class="token comment"># 设置集群名，node加入集群的名，多个集群名字要设置不同的，否则node可能加入错误的集群</span><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>prod<span class="token comment"># 当前节点的主机名</span><span class="token key atrule">node.name</span><span class="token punctuation">:</span> prod<span class="token punctuation">-</span>data<span class="token punctuation">-</span><span class="token number">2</span><span class="token comment"># 与其它节点形成集群，默认是回环地址，单机</span><span class="token key atrule">network.host</span><span class="token punctuation">:</span> 192.168.1.95<span class="token comment"># 默认绑定到回环地址，默认端口为9300</span><span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.95"</span><span class="token punctuation">]</span><span class="token comment"># 你也可以这样使用</span><span class="token comment"># discovery.seed_hosts:</span><span class="token comment">#    - 192.168.1.10:9300</span><span class="token comment">#    - 192.168.1.11 </span><span class="token comment">#    - seeds.mydomain.com   # 绑定DNS解析的域名</span><span class="token comment">#    - [0:0:0:0:0:ffff:c0a8:10c]:9301   # IPv6</span><span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span>   <span class="token comment"># 显式列出有master资格的主机节点，并在第一次选举中对其投票进行计数，生产环境建议使用此配置</span>  <span class="token punctuation">-</span> node5<span class="token comment">#    - master-node-b</span><span class="token comment">#    - master-node-c</span><span class="token comment"># 最少有两个节点存活才可以选举master</span><span class="token comment"># discovery.zen.minimum_master_nodes: 2</span><span class="token comment"># 最少两个节点存活在开始数据存活</span><span class="token comment"># gateway.recover_after_nodes: 2</span><span class="token comment"># 其它有master资格的节点，与上面不同的配置仅有以下2项</span><span class="token comment"># network.host:   # 本机IP地址</span><span class="token comment"># node.name:   # 分配的节点名称</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th align="left">属性名</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">cluster.name</td><td align="left">配置elasticsearch的集群名称，默认是elasticsearch。建议修改成一个有意义的名称。</td></tr><tr><td align="left">node.name</td><td align="left">节点名，es会默认随机指定一个名字，建议指定一个有意义的名称，方便管理</td></tr><tr><td align="left">path.conf</td><td align="left">设置配置文件的存储路径，tar或zip包安装默认在es根目录下的config文件夹，rpm安装默认在/etc/ elasticsearch</td></tr><tr><td align="left">path.data</td><td align="left">设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开</td></tr><tr><td align="left">path.logs</td><td align="left">设置日志文件的存储路径，默认是es根目录下的logs文件夹</td></tr><tr><td align="left">path.plugins</td><td align="left">设置插件的存放路径，默认是es根目录下的plugins文件夹</td></tr><tr><td align="left">bootstrap.memory_lock</td><td align="left">设置为true可以锁住ES使用的内存，避免内存进行swap</td></tr><tr><td align="left">network.host</td><td align="left">设置bind_host和publish_host，设置为0.0.0.0允许外网访问</td></tr><tr><td align="left">http.port</td><td align="left">设置对外服务的http端口，默认为9200。</td></tr><tr><td align="left">transport.tcp.port</td><td align="left">集群结点之间通信端口</td></tr><tr><td align="left">discovery.zen.ping.timeout</td><td align="left">设置ES自动发现节点连接超时的时间，默认为3秒，如果网络延迟高可设置大些</td></tr><tr><td align="left">discovery.zen.minimum_master_nodes</td><td align="left">主结点数量的最少值 ,此值的公式为：(master_eligible_nodes/2) + 1 ，比如：有3个符合要求的主结点，那么这里要设置为2</td></tr></tbody></table><blockquote><p>jvm.options</p></blockquote><ol><li><p><code>/etc/elasticsearch/jvm.options</code>直接修改配置文件</p></li><li><p><code>/etc/elasticsearch/jvm.options.d/</code>将配置文件放入此目录下，读取顺序按字典顺序a-z</p></li></ol><p><code>jvm.options</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 独立于JVM版本的JVM选项</span><span class="token punctuation">-</span>Xmx2g<span class="token comment"># JDK版本为8的JVM选项</span><span class="token comment"># 8:-Xmx2g</span><span class="token comment"># JDK版本大于8的JVM选项，如果你的JDK是11将应用这个选项</span><span class="token comment"># 8-:-Xmx2g</span><span class="token comment"># JDK版本大于8小于9的JVM选项</span><span class="token comment"># 8-9:-Xmx2g</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>/etc/sysconfig/elasticsearch<br>| 配置项             | 解释                                                                                                                                                                                                         |<br>| :—————– | :———————————————————————————————————————————————————————————————————– |<br>| JAVA_HOME          | 设置要使用的自定义Java路径。                                                                                                                                                                                 |<br>| MAX_OPEN_FILES     | 最大打开文件数，默认为65535。                                                                                                                                                                                |<br>| MAX_LOCKED_MEMORY  | 最大锁定内存大小。如果您在elasticsearch.yml中使用bootstrap.memory_lock选项，请设置为<code>unlimited</code>。                                                                                                            |<br>| MAX_MAP_COUNT      | 一个进程可能具有的最大内存映射区域数。如果将mmapfs用作索引存储类型，请确保将其设置为较高的值。在启动Elasticsearch之前通过<code>sysctl</code>进行设置。默认为262144。                                                    |<br>| ES_PATH_CONF       | 配置文件目录（需要包含<code>elasticsearch.yml</code>，<code>jvm.options</code>和<code>log4j2.properties</code>文件）；默认为<code>/etc/elasticsearch</code>。                                                                                            |<br>| ES_JAVA_OPTS       | 您可能想要应用的任何其他JVM系统属性。                                                                                                                                                                        |<br>| RESTART_ON_UPGRADE | 配置在软件包升级时重新启动，默认为<code>false</code>。这意味着您必须在手动安装软件包后重新启动Elasticsearch实例。这样做的原因是为了确保集群中的升级不会导致连续的分片重新分配，从而导致高网络流量并减少集群的响应时间。 |</p></blockquote><h4 id="验证它"><a href="#验证它" class="headerlink" title="验证它"></a>验证它</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">[root@localhost ~]# curl 192.168.1.95:9200&#123;  "name" : "node5",  "cluster_name" : "my-application",  "cluster_uuid" : "_na_",  "version" : &#123;    "number" : "7.8.0",    "build_flavor" : "default",    "build_type" : "rpm",    "build_hash" : "757314695644ea9a1dc2fecd26d1a43856725e65",    "build_date" : "2020-06-14T19:35:50.234439Z",    "build_snapshot" : false,    "lucene_version" : "8.5.1",    "minimum_wire_compatibility_version" : "6.8.0",    "minimum_index_compatibility_version" : "6.0.0-beta1"  &#125;,  "tagline" : "You Know, for Search"&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><table><thead><tr><th align="left">Type</th><th align="left">Description</th><th align="left">Default Location</th><th align="left">Setting</th></tr></thead><tbody><tr><td align="left">home</td><td align="left">Elasticsearch主目录或$ES_HOME</td><td align="left">/usr/share/elasticsearch</td><td align="left">-</td></tr><tr><td align="left">bin</td><td align="left">二进制脚本，包括用于启动节点的elasticsearch和用于安装插件的elasticsearch-plugin</td><td align="left">usr/share/elasticsearch/bin</td><td align="left">-</td></tr><tr><td align="left">conf</td><td align="left">配置文件，包括elasticsearch.yml</td><td align="left">/etc/elasticsearch</td><td align="left">ES_PATH_CONF</td></tr><tr><td align="left">conf</td><td align="left">环境变量，包括堆大小，文件描述符.</td><td align="left">/etc/sysconfig/elasticsearch</td><td align="left">-</td></tr><tr><td align="left">data</td><td align="left">节点上分配的每个索引/分片的数据文件的位置。可以容纳多个位置.</td><td align="left">/var/lib/elasticsearch</td><td align="left">path.data</td></tr><tr><td align="left">jdk</td><td align="left">捆绑的Java开发工具包，用于运行Elasticsearch。可以通过在/etc/sysconfig/elasticsearch.</td><td align="left">/usr/share/elasticsearch/jdk</td><td align="left">-</td></tr><tr><td align="left">logs</td><td align="left">日志文件位置</td><td align="left">/var/log/elasticsearch</td><td align="left">path.logs</td></tr><tr><td align="left">plugins</td><td align="left">插件文件位置。每个插件将包含在一个子目录中。</td><td align="left">/usr/share/elasticsearch/plugins</td><td align="left">-</td></tr><tr><td align="left">repo</td><td align="left">共享文件系统存储库位置。可以容纳多个位置。可以将文件系统存储库放置在此处指定的任何目录的任何子目录中。</td><td align="left">Not configured</td><td align="left">path.repo</td></tr></tbody></table><blockquote><p>kibana<br><code>/etc/kibana/kibana.yml</code></p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server.port</span><span class="token punctuation">:</span> <span class="token number">5601</span><span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">"192.168.1.95"</span><span class="token key atrule">elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://192.168.1.95:9200"</span><span class="token punctuation">]</span><span class="token key atrule">i18n.locale</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>nginx</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">htpasswd <span class="token parameter variable">-cm</span> /etc/nginx/kibana-user admin   <span class="token comment"># 推荐</span>htpasswd <span class="token parameter variable">-bcm</span> /etc/nginx/kibana-user admin admin   <span class="token comment"># 不推荐，密码明文暴露在命令行</span><span class="token comment"># vi /etc/nginx/conf.d/kibana.conf </span>server <span class="token punctuation">&#123;</span>    listen <span class="token number">80</span><span class="token punctuation">;</span>    server_name <span class="token number">192.168</span>.1.95<span class="token punctuation">;</span>    auth_basic <span class="token string">"Restricted Access"</span><span class="token punctuation">;</span>    auth_basic_user_file /etc/nginx/kibana-user<span class="token punctuation">;</span>    location / <span class="token punctuation">&#123;</span>        proxy_pass http://192.168.1.95:5601<span class="token punctuation">;</span>        proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>        proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>        proxy_set_header Connection <span class="token string">'upgrade'</span><span class="token punctuation">;</span>        proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>        proxy_cache_bypass <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="你可能需要修改一下系统参数"><a href="#你可能需要修改一下系统参数" class="headerlink" title="你可能需要修改一下系统参数"></a>你可能需要修改一下系统参数</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/security/limits.conf   <span class="token comment"># 新增或修改以下选项，重新登陆生效</span>* soft nofile <span class="token number">65536</span>* hard nofile <span class="token number">131072</span>* soft nproc <span class="token number">2048</span>* hard nproc <span class="token number">4096</span>* soft memlock unlimited* hard memlock unlimited<span class="token builtin class-name">echo</span> <span class="token string">"vm.max_map_count=262144"</span> <span class="token operator">>></span> /etc/sysctl.conf<span class="token function">sysctl</span> <span class="token parameter variable">-p</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="end"><a href="#end" class="headerlink" title="end"></a>end</h1><p>访问kibana界面，查看dev-nginx-access-*索引是否存在</p>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> elk </tag>
            
            <tag> elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mongodb</title>
      <link href="/posts/effa6b88.html"/>
      <url>/posts/effa6b88.html</url>
      
        <content type="html"><![CDATA[<h1 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h1><h2 id="下载软件包到服务器进行解压"><a href="#下载软件包到服务器进行解压" class="headerlink" title="下载软件包到服务器进行解压"></a>下载软件包到服务器进行解压</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-4.0.20.tgz<span class="token function">tar</span> <span class="token parameter variable">-xvzf</span> mongodb-linux-x86_64-4.0.20.tgz<span class="token function">mv</span> mongodb-linux-x86_64-4.0.20.tgz /home/mongodb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="创建配置相关的目录及配置文件"><a href="#创建配置相关的目录及配置文件" class="headerlink" title="创建配置相关的目录及配置文件"></a>创建配置相关的目录及配置文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/mongodb/conf<span class="token function">vim</span> /home/mongodb/conf/mongodb.conf    <span class="token comment">#编辑配置文件</span><span class="token assign-left variable">bind_ip</span><span class="token operator">=</span><span class="token number">192.168</span>.0.128<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3717</span><span class="token assign-left variable">dbpath</span><span class="token operator">=</span>/data/db<span class="token assign-left variable">logpath</span><span class="token operator">=</span>/data/log/mongodb.log<span class="token assign-left variable">logappend</span><span class="token operator">=</span>true<span class="token assign-left variable">fork</span><span class="token operator">=</span>true<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /data/<span class="token punctuation">&#123;</span>db,log<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mongod <span class="token parameter variable">-f</span> /home/mongodb/conf/mongodb.conf     <span class="token comment">#启动mongod</span><span class="token function">netstat</span> <span class="token parameter variable">-nlutp</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">3717</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user: <span class="token string">"root"</span>, customData: <span class="token punctuation">&#123;</span>description: <span class="token string">"superuser"</span><span class="token punctuation">&#125;</span>, pwd: <span class="token string">"123456"</span>, roles: <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role: <span class="token string">"userAdminAnyDatabase"</span>, db: <span class="token string">"admin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>use roxndb.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user: <span class="token string">"roxn_user"</span>, pwd: <span class="token string">"111111"</span>, roles: <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role: <span class="token string">"dbOwner"</span>, db: <span class="token string">"roxn"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># 2</span>use admindb.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user: <span class="token string">"root"</span>, pwd: <span class="token string">"123456"</span>, roles: <span class="token punctuation">[</span> <span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># 使用官方推荐的方法 调用passwordPrompt() 提示用户输入密码</span>use admindb.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user: <span class="token string">"myUserAdmin"</span>, pwd: passwordPrompt<span class="token punctuation">(</span><span class="token punctuation">)</span>, roles: <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> role: <span class="token string">"userAdminAnyDatabase"</span>, db: <span class="token string">"admin"</span> <span class="token punctuation">&#125;</span>, <span class="token string">"readWriteAnyDatabase"</span> <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看用户授权"><a href="#查看用户授权" class="headerlink" title="查看用户授权"></a>查看用户授权</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span> db.system.users.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin.root"</span>, <span class="token string">"userId"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"5a4be19a-181e-4d68-b04b-65939beb27d3"</span><span class="token punctuation">)</span>, <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"root"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span>, <span class="token string">"credentials"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"SCRAM-SHA-1"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"uB6KbqXzfsFjemhs+Gzo+A=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"JBomPI/VnfRTKNygB2FLbHyjNEU="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"dnC1NF7Vq1NaJM30EusD54QqnSY="</span> <span class="token punctuation">&#125;</span>, <span class="token string">"SCRAM-SHA-256"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">15000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"PsztIWthH9+7pXWqwBCqRQ4gSAds3IJVZASS4Q=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"DdO2o7BDdkt9Tzz3FdQATk9VtA4RFEbZWZ2YS9p2mD4="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"S+99H9gGXZHMD54x/4I2qxwOJA+8nbeNCXijbNKRdJ8="</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"root"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"roxn.roxn_user"</span>, <span class="token string">"userId"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b8227dc2-2092-4943-b6c8-a38164892a00"</span><span class="token punctuation">)</span>, <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"roxn_user"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"roxn"</span>, <span class="token string">"credentials"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"SCRAM-SHA-1"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"07foaRFBvRSpO49F2Zy3IQ=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"XQ1Hkjrl2+TkLV8zwVDYRT/WjgA="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"IaE3SSDf6auO6oziBr/VApFOzV4="</span> <span class="token punctuation">&#125;</span>, <span class="token string">"SCRAM-SHA-256"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">15000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"y12xFVQG7SlTjpYdHAJZf2RXH+VHTDnrH6hDLw=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"D9ZU9zSaxS1w0g7xDQwcPQWNsDotA9Bo4ZZXOQWLan8="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"lA6g/FnbOCKCFx6U4JgGqtuxocHFCE1PC0BnE8NHtlQ="</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"dbOwner"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"roxn"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h1><p>在上述查看用户授权中，对root和roxn_user授完权后执行以下操作</p><blockquote><p>在192.168.0.128、192.168.0.129、192.168.0.130三台机器均安装mongodb，别忘了创建db和log目录创建配置文件，内容如下：<br>bind_ip=192.168.0.128   # 三台机器仅IP不一样，绑定本机IP<br>port=3717<br>dbpath=/home/mongodb/db<br>logpath=/home/mongodb/log/mongodb.log<br>logappend=true<br>fork=true<br>auth=true<br>replSet=rs   # 集群名称创建集群配置会用到<br>keyFile=/home/mongodb/key_file   # 集群主机间验证文件</p></blockquote><h2 id="生成key-file"><a href="#生成key-file" class="headerlink" title="生成key_file"></a>生成key_file</h2><p>导入到另外两台机器，key_file保持一致</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl rand <span class="token parameter variable">-base64</span> <span class="token number">756</span> <span class="token operator">></span> key_file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h2><h3 id="单机备份"><a href="#单机备份" class="headerlink" title="单机备份"></a>单机备份</h3><p>如果单机版直接修改成集群配置，需要备份数据</p><ol><li>备份<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -d 库名</span><span class="token comment"># -o 指定备份的目录</span>./mongodump <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3717</span> <span class="token parameter variable">--username</span><span class="token operator">=</span>roxn_user <span class="token parameter variable">-d</span> roxn <span class="token parameter variable">-o</span> ./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>恢复<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --host 指定要连接的主机和端口</span><span class="token comment"># -d 库名</span>./mongorestore <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.0.128:3717 <span class="token parameter variable">-u</span> roxn_user <span class="token parameter variable">--authenticationDatabase</span> <span class="token parameter variable">-d</span> roxn ./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><p>在192.168.0.128主机执行以下命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 连接数据库</span><span class="token punctuation">[</span>root@mongodb2 mongodb<span class="token punctuation">]</span><span class="token comment"># ./bin/mongo --host 192.168.0.128:3717 -u root -p --authenticationDatabase admin</span><span class="token comment"># 进入admin库</span><span class="token operator">></span> use admin<span class="token comment"># conf=配置集群</span><span class="token operator">></span> <span class="token assign-left variable">conf</span><span class="token operator">=</span><span class="token punctuation">&#123;</span> _id:<span class="token string">"rs"</span>, members:<span class="token punctuation">[</span> <span class="token punctuation">&#123;</span>_id:0,host:<span class="token string">'192.168.0.128:3717'</span><span class="token punctuation">&#125;</span>, <span class="token punctuation">&#123;</span>_id:1,host:<span class="token string">'192.168.0.129:3717'</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span>_id:2,host:<span class="token string">'192.168.0.130:3717'</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token comment"># 正常会打印conf=的内容</span><span class="token comment"># 初始化集群</span><span class="token operator">></span> rs.initiate<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看集群状态，没有报错即可。全部打印信息如下，没必要和你的一一对照。</span>rs:SECONDARY<span class="token operator">></span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token string">"set"</span> <span class="token builtin class-name">:</span> <span class="token string">"rs"</span>,    <span class="token string">"date"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:42.034Z"</span><span class="token punctuation">)</span>,    <span class="token string">"myState"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"term"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,    <span class="token string">"syncingTo"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,    <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,    <span class="token string">"optimes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">"lastCommittedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>,        <span class="token string">"readConcernMajorityOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>,        <span class="token string">"appliedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>,        <span class="token string">"durableOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>,    <span class="token string">"lastStableCheckpointTimestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984425</span>, <span class="token number">1</span><span class="token punctuation">)</span>,    <span class="token string">"electionCandidateMetrics"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">"lastElectionReason"</span> <span class="token builtin class-name">:</span> <span class="token string">"electionTimeout"</span>,        <span class="token string">"lastElectionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:08:45.725Z"</span><span class="token punctuation">)</span>,        <span class="token string">"electionTerm"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,        <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>,        <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984114</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>,        <span class="token string">"numVotesNeeded"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,        <span class="token string">"priorityAtElection"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,        <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,        <span class="token string">"numCatchUpOps"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,        <span class="token string">"newTermStartDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:08:45.738Z"</span><span class="token punctuation">)</span>,        <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:08:46.320Z"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>,    <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,            <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.128:3717"</span>,            <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRIMARY"</span>,            <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">1181</span>,            <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>,            <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:35Z"</span><span class="token punctuation">)</span>,            <span class="token string">"syncingTo"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,            <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"electionTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984125</span>, <span class="token number">1</span><span class="token punctuation">)</span>,            <span class="token string">"electionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:08:45Z"</span><span class="token punctuation">)</span>,            <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"self"</span> <span class="token builtin class-name">:</span> true,            <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>        <span class="token punctuation">&#125;</span>,        <span class="token punctuation">&#123;</span>            <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.129:3717"</span>,            <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,            <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"SECONDARY"</span>,            <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">367</span>,            <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>,            <span class="token string">"optimeDurable"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>,            <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:35Z"</span><span class="token punctuation">)</span>,            <span class="token string">"optimeDurableDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:35Z"</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeat"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:41.844Z"</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeatRecv"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:40.469Z"</span><span class="token punctuation">)</span>,            <span class="token string">"pingMs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"syncingTo"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.128:3717"</span>,            <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.128:3717"</span>,            <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,            <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>        <span class="token punctuation">&#125;</span>,        <span class="token punctuation">&#123;</span>            <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,            <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.130:3717"</span>,            <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,            <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,            <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"SECONDARY"</span>,            <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">367</span>,            <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>,            <span class="token string">"optimeDurable"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>,            <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:35Z"</span><span class="token punctuation">)</span>,            <span class="token string">"optimeDurableDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:35Z"</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeat"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:41.844Z"</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeatRecv"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2021-09-07T03:14:40.933Z"</span><span class="token punctuation">)</span>,            <span class="token string">"pingMs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,            <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"syncingTo"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.128:3717"</span>,            <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.0.128:3717"</span>,            <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,            <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,            <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span>,    <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,    <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1630984475</span>, <span class="token number">1</span><span class="token punctuation">)</span>,        <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"l+ba8+37Nug/0RnocqpCJDmws0o="</span><span class="token punctuation">)</span>,            <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"7005023477170176002"</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="本机验证"><a href="#本机验证" class="headerlink" title="本机验证"></a>本机验证</h2><p>验证普通用户读写</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用普通用户登录</span><span class="token punctuation">[</span>root@mongodb2 mongodb<span class="token punctuation">]</span><span class="token comment"># ./bin/mongo --host 192.168.0.128:3717 -u roxn_user -p --authenticationDatabase roxn</span><span class="token comment"># 进入roxn数据库</span>rs:PRIMARY<span class="token operator">></span> use roxn<span class="token comment"># 创建几条数据，save，insert均可</span>rs:PRIMARY<span class="token operator">></span> db.table_1.save<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'Uid'</span><span class="token builtin class-name">:</span><span class="token string">'mail@roxn.com'</span>,<span class="token string">'Al'</span>:<span class="token punctuation">[</span><span class="token string">'test1@roxn.com'</span>,<span class="token string">'test2@roxn.com'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>rs:PRIMARY<span class="token operator">></span> db.table_1.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'Uid'</span><span class="token builtin class-name">:</span><span class="token string">'mail@roxn.com'</span>,<span class="token string">'Al'</span>:<span class="token punctuation">[</span><span class="token string">'test1@roxn.com'</span>,<span class="token string">'test2@roxn.com'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>rs:PRIMARY<span class="token operator">></span> db.table_1.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'Uid'</span><span class="token builtin class-name">:</span><span class="token string">'mail@roxn.com'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># 数据查询</span>rs:PRIMARY<span class="token operator">></span> db.table_1.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'Uid'</span><span class="token builtin class-name">:</span><span class="token string">'mail@roxn.com'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.<span class="token function-name function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136dac50f666835e21eee73"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span>,    <span class="token string">"Al"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"test1@roxn.com"</span>,        <span class="token string">"test2@roxn.com"</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136db920f666835e21eee74"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span>,    <span class="token string">"Al"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"test1@roxn.com"</span>,        <span class="token string">"test2@roxn.com"</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136dbdb0f666835e21eee75"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="备份机验证"><a href="#备份机验证" class="headerlink" title="备份机验证"></a>备份机验证</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 登录</span><span class="token punctuation">[</span>root@mongodb3 mongodb<span class="token punctuation">]</span><span class="token comment"># ./bin/mongo --host 192.168.0.129:3717</span><span class="token comment"># 默认备份机器没有读写权限，非要读写，使用rs.slaveOk()</span>rs:SECONDARY<span class="token operator">></span> rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 进入库</span>rs:SECONDARY<span class="token operator">></span> use adminswitched to db admin<span class="token comment"># 认证</span>rs:SECONDARY<span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"root"</span>,<span class="token string">"654321"</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token comment"># 查看集群状态</span>rs:SECONDARY<span class="token operator">></span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 查看数据</span>rs:SECONDARY<span class="token operator">></span> show dbsadmin     <span class="token number">0</span>.000GBconfig    <span class="token number">0</span>.000GB<span class="token builtin class-name">local</span>     <span class="token number">0</span>.000GBroxn      <span class="token number">0</span>.006GB<span class="token comment"># 进入数据库</span>rs:SECONDARY<span class="token operator">></span> use roxnswitched to db roxn<span class="token comment"># 查询验证</span>rs:SECONDARY<span class="token operator">></span> db.table_1.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'Uid'</span><span class="token builtin class-name">:</span><span class="token string">'mail@roxn.com'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.<span class="token function-name function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136dac50f666835e21eee73"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span>,    <span class="token string">"Al"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"test1@roxn.com"</span>,        <span class="token string">"test2@roxn.com"</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136db920f666835e21eee74"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span>,    <span class="token string">"Al"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"test1@roxn.com"</span>,        <span class="token string">"test2@roxn.com"</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>    <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"6136dbdb0f666835e21eee75"</span><span class="token punctuation">)</span>,    <span class="token string">"Uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"mail@roxn.com"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="713dc437.html">参考</a></p>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mongo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>limits</title>
      <link href="/posts/f6090456.html"/>
      <url>/posts/f6090456.html</url>
      
        <content type="html"><![CDATA[<p>linux中<code>/etc/security/limits.conf</code>配置文件说明</p><p>linux资源限制配置文件是<code>/etc/security/limits.conf</code>；限制用户进程的数量对于linux系统的稳定性非常重要。</p><p>limits.conf文件限制着用户可以使用的最大文件数，最大线程，最大内存等资源使用量。</p><pre class="line-numbers language-none"><code class="language-none">* soft nofile 655350  # 任何用户可以打开的最大的文件描述符数量，默认1024，这里的数值会限制tcp连接* hard nofile 655350* soft nproc  655350  # 任何用户可以打开的最大进程数* hard nproc  650000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">@student hard nofile 65535@student soft nofile 4096@student hard nproc 50  # 学生组中的任何人不能拥有超过50个进程，并且会在拥有30个进程时发出警告@student soft nproc 30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>hard和soft两个值都代表什么意思呢？</p><p>soft是一个警告值，而hard则是一个真正意义的阀值，超过就会报错</p><p>所有用户创建的进程数：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ps</span> h <span class="token parameter variable">-Led</span> <span class="token parameter variable">-o</span> user <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-n</span>      <span class="token number">1</span> chrony      <span class="token number">1</span> dbus      <span class="token number">1</span> rpc      <span class="token number">2</span> postfix      <span class="token number">7</span> polkitd     <span class="token number">36</span> rabbitmq    <span class="token number">175</span> root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>系统最大打开文件描述符数：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /proc/sys/fs/file-max<span class="token number">100000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>设置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/sysctl.conffs.file-max <span class="token operator">=</span> <span class="token number">100000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>进程最大打开文件描述符数</p><p><code>ulimit -n</code>默认查看的是soft limit</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span><span class="token number">65536</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看hard limit</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-Hn</span><span class="token number">131072</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>临时设置</p><p>通过<code>ulimit -Sn</code>设置最大打开文件描述符数的soft limit，注意soft limit必须小于hard limit</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-Sn</span> <span class="token number">160000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同时设置soft limit和hard limit。对于非root用户只能设置比原来小的hard limit。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">180000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>永久设置</p><p>root权限下，在<code>/etc/security/limits.conf</code>中添加如下两行，表示所有用户最大打开文件描述符数的soft limit为102400，hard limit为104800。重启生效</p><pre class="line-numbers language-none"><code class="language-none">* soft nofile 102400* hard nofile 104800<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意：设置nofile的hard limit还有一点要注意的就是hard limit不能大于<code>/proc/sys/fs/nr_open</code>，假如hard limit大于nr_open，注销后将无法正常登录。</p><p>查看当前系统使用的打开文件描述符数</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /proc/sys/fs/file-nr<span class="token number">1248</span>    <span class="token number">0</span>    <span class="token number">100000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中第一个数表示当前系统已分配使用的打开文件描述符数，第二个数为分配后已释放的（目前已不再使用），第三个数等于file-max。</p><p>知道了<code>/etc/security/limits.conf</code>中的参数含义之后，那么如何配置nofile，确定nofile的最大值呢。</p><p>解答：使用<code>ulimt -n</code>命令进行测试，如果小于系统允许的最大值，设置成功，大于最大值，系统会报错提示。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1100000</span>-bash: ulimit: <span class="token function">open</span> files: cannot modify limit: Operation not permitted$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1048576</span>$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1048577</span>-bash: ulimit: <span class="token function">open</span> files: cannot modify limit: Operation not permitted$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1048575</span>$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1048576</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ulimit -a/n/H/S</code>都有什么含义</p><pre class="line-numbers language-none"><code class="language-none">ulimit -a   显示当前所有的资源限制ulimit -H   设置硬件资源限制ulimit -S   设置软件资源限制ulimit -n   设置进程最大打开文件描述符数ulimit -u   &lt;程序数目&gt; 　用户最多可开启的程序数目<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结</p><ul><li>所有进程打开的文件描述符数不能超过<code>/proc/sys/fs/file-max</code></li><li>单个进程打开的文件描述符数不能超过user limit中nofile的soft limit</li><li>nofile的soft limit不能超过其hard limit</li><li>nofile的hard limit不能超过<code>/proc/sys/fs/nr_open</code></li></ul><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/ulimit">ulimit</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> limits </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rabbitmq</title>
      <link href="/posts/1ba9caba.html"/>
      <url>/posts/1ba9caba.html</url>
      
        <content type="html"><![CDATA[<h2 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h2><p><a href="https://www.rabbitmq.com/which-erlang.html">rabbitmq和erlang版本对应关系</a><br><img src="/medias/img/rabbitmq/0.png"></p><p>这里选择了rabbitmq3.8.22和erlang24.0.5</p><p>大部分不能启动或者其它报错都是版本不合引起的</p><p>如上图所示，我原本选择的rabbitmq3.8.9和erlang22.3.4，导致rabbitmq无法启动</p><h2 id="安装rabbitmq"><a href="#安装rabbitmq" class="headerlink" title="安装rabbitmq"></a>安装rabbitmq</h2><p>在hosts文件中写上3台机器的IP和主机名对应关系</p><pre class="line-numbers language-none"><code class="language-none">192.168.1.1 rabbitmq-01192.168.1.2 rabbitmq-02192.168.1.3 rabbitmq-03<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>修改系统配置：<code>vi /etc/sysctl.conf</code></p><pre class="line-numbers language-none"><code class="language-none">fs.file-max &#x3D; 100000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使设置生效：<code>sysctl -p</code></p><p>查看系统限制：<code>sysctl fs.file-max</code></p><p>调整用户限制：<code>vi /etc/security/limits.conf</code></p><pre class="line-numbers language-none"><code class="language-none">*              soft     nofile          65536*              hard     nofile          65536<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>重启系统使之生效，检查用户限制是否生效：<code>ulimit -n</code></p><p><a href="4af9.html">详细ulimit配置文件修改参阅</a></p><p>RabbitMQ相关端口</p><pre class="line-numbers language-none"><code class="language-none">4369 (epmd), 25672 (Erlang distribution) 5672, 5671 (AMQP 0-9-1 without and with TLS) 15672 (if management plugin is enabled) 61613, 61614 (if STOMP is enabled) 1883, 8883 (if MQTT is enabled)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>三台机器分别执行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加EPEL源</span><span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm<span class="token comment"># 添加Erlang源</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">wget</span><span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpm<span class="token comment"># 安装Java</span>yum makecacheyum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">java</span> java-devel<span class="token comment"># 安装RabbitMQ</span><span class="token function">wget</span> https://github.91chifun.workers.dev/https://github.com//rabbitmq/rabbitmq-server/releases/download/v3.8.22/rabbitmq-server-3.8.22-1.el7.noarch.rpm<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://www.rabbitmq.com/rabbitmq-signing-key-public.ascyum <span class="token function">install</span> <span class="token parameter variable">-y</span> rabbitmq-server-3.8.22-1.el7.noarch.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建目录、用户</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/rabbitmq/<span class="token punctuation">&#123;</span>mnesia,log<span class="token punctuation">&#125;</span><span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /etc/rabbitmq<span class="token function">useradd</span> rabbitmq<span class="token function">chown</span> <span class="token parameter variable">-R</span> rabbitmq. /etc/rabbitmq/<span class="token function">chown</span> <span class="token parameter variable">-R</span> rabbitmq. /home/rabbitmq/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改数据目录</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/rabbitmq/rabbitmq-env.conf <span class="token assign-left variable">RABBITMQ_MNESIA_BASE</span><span class="token operator">=</span>/home/rabbitmq/mnesia<span class="token assign-left variable">RABBITMQ_LOG_BASE</span><span class="token operator">=</span>/home/rabbitmq/log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>设置每个节点Cookie</p><p>Rabbitmq的集群是依赖于erlang的集群来工作的，所以必须先构建起erlang的集群环境。</p><p>Erlang的集群中各节点是通过一个magic cookie来实现的，这个cookie存放在<code>/var/lib/rabbitmq/.erlang.cookie</code>中，文件是400的权限。</p><p>所以必须保证各节点cookie保持一致，否则节点之间就无法通信</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">700</span> /var/lib/rabbitmq/.erlang.cookie<span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"CGOEQMSYVLWHJPTBDRN"</span> <span class="token operator">></span> /var/lib/rabbitmq/.erlang.cookie<span class="token function">chmod</span> <span class="token number">400</span> /var/lib/rabbitmq/.erlang.cookie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>建议在RabbitMQ服务启动前修改过cookie</strong>，如果RabbitMQ服务已经启动，修改cookie值后，必须重启RabbitMQ服务，这步很关键</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart rabbitmq-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动、查看运行状态</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl daemon-reloadsystemctl start rabbitmq-serversystemctl status rabbitmq-serversystemctl <span class="token builtin class-name">enable</span> rabbitmq-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><p>将 rabbitmq-01、rabbitmq-02、rabbitmq-03 组成集群：</p><p>默认是磁盘节点，如果是内存节点的话，需要加<code>--ram</code>参数</p><p>在<strong>rabbitmq-02、rabbitmq-03</strong>上分别运行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rabbitmqctl stop_apprabbitmqctl join_cluster rabbit@rabbitmq-01rabbitmqctl start_app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h2 id="集群用户、插件"><a href="#集群用户、插件" class="headerlink" title="集群用户、插件"></a>集群用户、插件</h2><p>在rabbitmq-01设置镜像策略、安装插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rabbitmqctl set_policy ha-all <span class="token string">"^"</span> <span class="token string">'&#123;"ha-mode":"all","ha-sync-mode":"automatic"&#125;'</span>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_management<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>账号设置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rabbitmqctl add_user admin vJSV9EMgZzunrabbitmqctl set_user_tags admin administratorrabbitmqctl set_permissions <span class="token parameter variable">-p</span> / admin <span class="token string">".*"</span> <span class="token string">".*"</span> <span class="token string">".*"</span>rabbitmqctl add_user rabbitmq Q4prKB6aGhqkrabbitmqctl set_user_tags rabbitmq monitoringrabbitmq-server <span class="token parameter variable">-detached</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>集群搭建完毕</p><h2 id="web访问"><a href="#web访问" class="headerlink" title="web访问"></a>web访问</h2><p>nginx配置</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">server &#123;    listen       80;    server_name  rabbitmq01.roxn.cn;    charset utf-8;    access_log &#x2F;home&#x2F;nginx&#x2F;logs&#x2F;rabbitmq_access.log  main;    error_log &#x2F;home&#x2F;nginx&#x2F;logs&#x2F;rabbitmq_error.log;     listen 443 ssl;    ssl_certificate &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.pem;     ssl_certificate_key &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.key;     location &#x2F; &#123;        proxy_set_header Host      $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_pass http:&#x2F;&#x2F;192.168.1.1:15672;        client_max_body_size 100m;    &#125;    error_page   404  &#x2F;manuscript-404.html;    location &#x3D; &#x2F;manuscript-404.html &#123;        root &#x2F;mnt&#x2F;share&#x2F;pgcr&#x2F;root&#x2F;www&#x2F;html&#x2F;404&#x2F;;   &#125;&#125;server &#123;    listen       80;    server_name  rabbitmq02.roxn.cn;    charset utf-8;    access_log &#x2F;home&#x2F;nginx&#x2F;logs&#x2F;rabbitmq_access.log  main;    listen 443 ssl;    ssl_certificate &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.pem;     ssl_certificate_key &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.key;     location &#x2F; &#123;        proxy_set_header Host      $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_pass http:&#x2F;&#x2F;192.168.1.2:15672;        client_max_body_size 100m;    &#125;    error_page   404  &#x2F;manuscript-404.html;    location &#x3D; &#x2F;manuscript-404.html &#123;        root &#x2F;mnt&#x2F;share&#x2F;pgcr&#x2F;root&#x2F;www&#x2F;html&#x2F;404&#x2F;;   &#125;&#125;server &#123;    listen       80;    server_name  rabbitmq03.roxn.cn;    charset utf-8;    access_log &#x2F;home&#x2F;nginx&#x2F;logs&#x2F;rabbitmq_access.log  main;    listen 443 ssl;    ssl_certificate &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.pem;     ssl_certificate_key &#x2F;home&#x2F;nginx&#x2F;ca&#x2F;roxn.cn.key;     location &#x2F; &#123;        proxy_set_header Host      $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_pass http:&#x2F;&#x2F;192.168.1.3:15672;        client_max_body_size 100m;    &#125;    error_page   404  &#x2F;manuscript-404.html;    location &#x3D; &#x2F;manuscript-404.html &#123;        root &#x2F;mnt&#x2F;share&#x2F;pgcr&#x2F;root&#x2F;www&#x2F;html&#x2F;404&#x2F;;   &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新加载nginx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ./sbin/nginx <span class="token parameter variable">-s</span> reload$ systemctl reload nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在浏览器输入<code>rabbitmq01.roxn.cn</code></p><p>使用创建的账号密码，登录查看：版本信息、集群信息、用户信息<br><img src="/medias/img/rabbitmq/1.png"></p><hr><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>一些命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加用户；</span>add_user <span class="token operator">&lt;</span>username<span class="token operator">></span> <span class="token operator">&lt;</span>password<span class="token operator">></span><span class="token comment"># 删除一个用户；</span>delete_user <span class="token operator">&lt;</span>username<span class="token operator">></span><span class="token comment"># 改变用户密码（也是改变web管理登陆密码）；</span>change_password <span class="token operator">&lt;</span>username<span class="token operator">></span> <span class="token operator">&lt;</span>newpassword<span class="token operator">></span><span class="token comment"># 清除用户的密码，该用户将不能使用密码登陆，但是可以通过SASL登陆如果配置了SASL认证；</span>clear_password <span class="token operator">&lt;</span>username<span class="token operator">></span><span class="token comment"># 设置用户tags，管理员、普通用户等；</span>set_user_tags <span class="token operator">&lt;</span>username<span class="token operator">></span> <span class="token operator">&lt;</span>tag<span class="token operator">></span> <span class="token punctuation">..</span>.<span class="token comment"># 列出用户；</span>list_users<span class="token comment"># 创建一个vhosts；</span>add_vhost <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token comment"># 删除一个vhosts；</span>delete_vhost <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token comment"># 列出vhosts；</span>list_vhosts <span class="token punctuation">[</span><span class="token operator">&lt;</span>vhostinfoitem<span class="token operator">></span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token comment"># 针对一个vhosts给用户赋予相关权限；</span>set_permissions <span class="token punctuation">[</span>-p <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>user<span class="token operator">></span> <span class="token operator">&lt;</span>conf<span class="token operator">></span> <span class="token operator">&lt;</span>write<span class="token operator">></span> <span class="token operator">&lt;</span>read<span class="token operator">></span><span class="token comment"># 清除一个用户对vhosts的权限；</span>clear_permissions <span class="token punctuation">[</span>-p <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>username<span class="token operator">></span><span class="token comment"># 列出哪些用户可以访问该vhosts；</span>list_permissions <span class="token punctuation">[</span>-p <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token punctuation">]</span><span class="token comment"># 列出该用户的访问权限；</span>list_user_permissions <span class="token operator">&lt;</span>username<span class="token operator">></span><span class="token comment"># 其它</span>set_parameter （设置一个虚拟主机的运行时参数）list_parameters <span class="token punctuation">(</span>列出一个虚拟主机上的所有运行时参数<span class="token punctuation">)</span>clear_parameter <span class="token punctuation">(</span>清除一个虚拟主机主机上的一个运行时参数<span class="token punctuation">)</span>set_global_parameter （设置一个全局的运行时参数）list_global_paramters <span class="token punctuation">(</span>列出全局的运行时参数<span class="token punctuation">)</span>clear_global_paramter <span class="token punctuation">(</span>清除一个全局的运行时参数<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>rabbitmq-env.conf</code>中的每项都以RABBITMQ_为前缀，常用参数如下：</p><pre class="line-numbers language-none"><code class="language-none">RABBITMQ_NODENAME&#x3D;FZTEC-240088 &#x2F;&#x2F;节点名称RABBITMQ_NODE_IP_ADDRESS&#x3D;127.0.0.1 &#x2F;&#x2F;IP地址，空串bind所有地址，指定地址bind指定网络接口RABBITMQ_NODE_PORT&#x3D;5672 &#x2F;&#x2F;TCP端口号，默认是5672RABBITMQ_LOG_BASE&#x3D;&#x2F;data&#x2F;rabbitmq&#x2F;log &#x2F;&#x2F;日志所在路径RABBITMQ_PLUGINS_DIR&#x3D;&#x2F;data&#x2F;rabbitmq&#x2F;plugins &#x2F;&#x2F;插件所在路径RABBITMQ_MNESIA_BASE&#x3D;&#x2F;data&#x2F;rabbitmq&#x2F;mnesia &#x2F;&#x2F;mnesia所在路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第二章YUM安装rabbitmq"><a href="#第二章YUM安装rabbitmq" class="headerlink" title="第二章YUM安装rabbitmq"></a>第二章YUM安装rabbitmq</h2><p>centos7 rabbitmq已停止维护：<a href="https://blog.rabbitmq.com/posts/2022/04/centos-7-support-discontinued/">地址</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认epel库安装rabbitmq-server-3.3.5 如果够用可以安装epel源后安装rabbitmq-server</span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span><span class="token comment"># centos7安装高版本</span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># https://github.com/rabbitmq/erlang-rpm/releases/download/v23.3.4.18/erlang-23.3.4.18-1.el7.x86_64.rpm</span><span class="token comment"># centos8+ 可以使用这种方法安装</span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># curl -1sLf 'https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/setup.rpm.sh' | bash</span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | bash</span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install erlang rabbitmq-server</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> erlang </tag>
            
            <tag> rabbitmq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mycat使用</title>
      <link href="/posts/da0d44e1.html"/>
      <url>/posts/da0d44e1.html</url>
      
        <content type="html"><![CDATA[<h1 id="Mycat安装测试使用"><a href="#Mycat安装测试使用" class="headerlink" title="Mycat安装测试使用"></a>Mycat安装测试使用</h1><h2 id="Mycat简介："><a href="#Mycat简介：" class="headerlink" title="Mycat简介："></a>Mycat简介：</h2><p><code>MyCAT</code> 是一款开源的<code>Mysql</code>企业级集群应用，它是基于阿里的开源产品<code>Cobar</code>发展出来的。<code>MyCAT</code>提供了类似<code>Mysql</code>的接口，可以平滑的将单机<code>Mysql</code>迁移到<code>Mysql</code>集群上，解决数据存储和业务规模迅速增长情况下的数据瓶颈问题。</p><h2 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h2><p>环境需要JDK1.8，mysql5.5-5.7版本之间（稳定版）</p><p><img src="/medias/img/mycat/0.png"></p><p>下载安装mycat安装包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz<span class="token function">wget</span>  http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>tar 解压mycat安装包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> xvf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz <span class="token parameter variable">-C</span> /usr/local/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/mycat/1.png"><br><img src="/medias/img/mycat/2.png"></p><p>安装完成</p><h1 id="测试修改配置文件"><a href="#测试修改配置文件" class="headerlink" title="测试修改配置文件"></a>测试修改配置文件</h1><h2 id="主要配置文件："><a href="#主要配置文件：" class="headerlink" title="主要配置文件："></a>主要配置文件：</h2><p><code>schema.xml</code>中定义逻辑库，表、分片节点等内容；</p><p><code>rule.xml</code>中定义分片规则；</p><p><code>server.xml</code>中定义用户以及系统相关变量，如端口等</p><p><img src="/medias/img/mycat/3.png"></p><p><code>wrapper.conf</code>是控制mycat jvm的一些启动参数。</p><p><code>server.xml</code>是Mycat服务器参数调整和用户授权的配置文件。</p><p><code>schema.xml</code>是逻辑库定义和表以及分片定义的配置文件。</p><p><code>rule.xml</code>是分片规则的配置文件，分片规则的具体一些参数信息单独存放为文件，也在这个目录下，配置文件修改需要重启Mycat。</p><p><code>server.xml</code>是MyCAT对外的”虚拟数据库”配置文件。所谓的”虚拟数据库”是说，MyCAT将多个Mysql集群整合起来对外提供服务，提供服务的接口仍然采用Mysql的形式，因此，通过仿造Mysql接口，让调用程序以为自己是在访问Mysql数据库，就是所谓的”虚拟数据库”。</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mycat:server</span> <span class="token name">SYSTEM</span> <span class="token string">"server.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mycat:</span>server</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>mycat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://io.mycat/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useSqlStat<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 1为开启实时统计、0为关闭 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useGlobleTableCheck<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 1为开启全加班一致性检测、0为关闭 --></span>    <span class="token comment">&lt;!--配置id(序列)的生成方式--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sequnceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--  &lt;property name="useCompression">1&lt;/property>--></span> <span class="token comment">&lt;!--1为开启mysql压缩协议--></span>    <span class="token comment">&lt;!-- &lt;property name="fakeMySQLVersion">5.6.20&lt;/property>--></span> <span class="token comment">&lt;!--设置模拟的MySQL版本号--></span>    <span class="token comment">&lt;!-- &lt;property name="processorBufferChunk">40960&lt;/property> --></span>    <span class="token comment">&lt;!-- &lt;property name="processors">1&lt;/property> --></span>    <span class="token comment">&lt;!--&lt;property name="processorExecutor">32&lt;/property>  --></span>    <span class="token comment">&lt;!--默认为type 0: DirectByteBufferPool | type 1 ByteBufferArena--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>processorBufferPoolType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--默认是65535 64K 用于sql解析时最大文本长度 --></span>    <span class="token comment">&lt;!--&lt;property name="maxStringLiteralLength">65535&lt;/property>--></span>    <span class="token comment">&lt;!--&lt;property name="sequnceHandlerType">0&lt;/property>--></span>    <span class="token comment">&lt;!--&lt;property name="backSocketNoDelay">1&lt;/property>--></span>    <span class="token comment">&lt;!--&lt;property name="frontSocketNoDelay">1&lt;/property>--></span>    <span class="token comment">&lt;!--&lt;property name="processorExecutor">16&lt;/property>--></span>    <span class="token comment">&lt;!--&lt;property name="serverPort">8066&lt;/property> &lt;property name="managerPort">9066&lt;/property> --></span>    <span class="token comment">&lt;!--&lt;property name="idleTimeout">300000&lt;/property> &lt;property name="bindIp">0.0.0.0&lt;/property> --></span>    <span class="token comment">&lt;!--&lt;property name="frontWriteQueueSize">4096&lt;/property> &lt;property name="processors">32&lt;/property> --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handleDistributedTransactions<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useOffHeapForMerge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--单位为m--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>memoryPageSize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--单位为k--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spillsFileBufferSize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1k<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useStreamOutput<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--单位为m--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>systemReserveMemorySize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>384m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--是否采用zookeeper协调切换  --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useZKSwitch<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 全局SQL防火墙设置 --></span>  <span class="token comment">&lt;!--     &lt;firewall>     &lt;whitehost>        &lt;host host="127.0.0.1" user="mycat"/>        &lt;host host="127.0.0.2" user="mycat"/>    &lt;/whitehost>    &lt;blacklist check="false">    &lt;/blacklist>    &lt;/firewall>  --></span>  <span class="token comment">&lt;!-- 配置mycat服务连接用户名密码 ,在项目中的数据源的用户名密码则使用这个，不再直连mysql--></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schemas<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>TESTDB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 表级 DML 权限设置 --></span>    <span class="token comment">&lt;!--    &lt;privileges check="false">      &lt;schema name="TESTDB" dml="0110" >        &lt;table name="tb01" dml="0000">&lt;/table>        &lt;table name="tb02" dml="1111">&lt;/table>      &lt;/schema>    &lt;/privileges>       --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--  &lt;user name="user">    &lt;property name="password">user&lt;/property>    &lt;property name="schemas">TESTDB&lt;/property>    &lt;property name="readOnly">true&lt;/property>  &lt;/user>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mycat:</span>server</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>表明该虚拟数据库有一个<code>schema</code>，<code>TESTDB</code>；</p><p>有2个用户<code>test</code>和<code>user</code>，密码分别是<code>root</code>和<code>user</code>，</p><p><code>user</code>用户是只读的，<code>root</code>用户未设置只读,有增删改查权限；</p><p>默认的SQL解析器是<code>druidparser</code>。</p><p><code>schema.xml</code>逻辑库定义和表以及分片定义的配置文件</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mycat:schema</span> <span class="token name">SYSTEM</span> <span class="token string">"schema.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mycat:</span>schema</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>mycat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://io.mycat/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- TESTDB为mycat的逻辑表,在server.xml中的指定,并与mycat的登录账户绑定在一起 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TESTDB<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--    配置物理表在mycat中的逻辑关系,这里指定了mycat中有一张逻辑表名为user,这张表的实际数据分散在dn1,dn2,dn3中对应的不同数>据库里面,且分片规则采用了mod-long，当然可以指定不同的分片规则，分片规则在rile.xml配置    --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>users<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rule1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--    userInfo表是user表的关联表,用于关联查询的情况下,mycat的分片采用er模型,joinKey="userId"为userInfo表的字段，联user表的id,当然也不定非得是id,通过parentKey="xx"可以指定关联user表的字段    --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>childTable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInfo<span class="token punctuation">"</span></span>  <span class="token attr-name">joinKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userId<span class="token punctuation">"</span></span> <span class="token attr-name">parentKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 配置3个节点，该节点的三个属性依次为:节点的名称,服务器ip,数据库实例(MySQL真正的实例) --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bogon<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn2<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bogon<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn3<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bogon<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token comment">&lt;!-- 配置连接的数据库,需配置好连接数据库的用户名和密码及ip,这个可以配置多个地址,且可分为读数据库和写数据库 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bogon<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>  <span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 心跳,mycat服务每隔一段时间会发出该sql语句,验证该服务器是否被停掉 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 指定自己mysql的地址及用户名密码 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bogon<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.10.142:3306<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>writeHost</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mycat:</span>schema</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Schema</code>中主要配置<code>Mycat数据库</code>，<code>MySQL表</code>，<code>分片规则</code>，<code>分片类型</code>。</p><h2 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h2><p>第1块是<code>schema</code>块，主要描述了虚拟数据库的<code>schemaTESTDB</code>中有哪些表，每个表分布在哪些数据节点上，分布的方法采用哪种算法。例如<code>&lt;table name=&quot;users&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;rule1&quot; /&gt;</code>，表示<code>user</code>表分布在<code>dn1</code>,<code>dn2</code>,<code>dn3</code>这3个节点上，分布的方法采用<code>rule1</code>算法（<code>rule.xml</code>文件中的配置）。</p><h2 id="dataNode"><a href="#dataNode" class="headerlink" title="dataNode"></a>dataNode</h2><p>第2块是<code>dataNode</code>，表示该数据库有哪些数据节点，以及这些数据节点实际对应的数据服务器和数据库名，这里配置了3个节点<code>dn1</code>,<code>dn2</code>,<code>dn3</code>，都是在<code>bogon</code>服务器上，数据库名分别是<code>db0</code>,<code>db1</code>,<code>db2</code>，其实，这也正是前面<code>schema</code>块中用到的。</p><h2 id="dataHost"><a href="#dataHost" class="headerlink" title="dataHost"></a>dataHost</h2><p>第3块是<code>dataHost</code>，这部分是实际的数据库服务器配置，这里测试配置了本地<code>Mysql</code>数据库，地址在<code>192.168.10.142:3306</code>，用户名都是<code>root</code>，密码是<code>123456</code>，并且指定了心跳是<code>select user()</code>。</p><p>这里面有两个参数需要注意，<code>balance</code>和<code>switchType</code>。</p><p><code>balance</code>指的负载均衡类型，目前的取值有4种：</p><p><code>balance=&quot;0&quot;</code>, 不开启读写分离机制，所有读操作都发送到当前可用的<code>writeHost</code>上。</p><p><code>balance=&quot;1&quot;</code>，全部的<code>readHost</code>与<code>stand by writeHost</code>参与<code>select</code>语句的负载均衡，简单的说，当双主双从模式<code>(M1-&gt;S1，M2-&gt;S2，并且M1与 M2互为主备)</code>，正常情况下，<code>M2</code>,<code>S1</code>,<code>S2</code>都参与<code>select</code>语句的负载均衡。</p><p><code>balance=&quot;2&quot;</code>，所有读操作都随机的在<code>writeHost</code>、<code>readhost</code>上分发。</p><p><code>balance=&quot;3&quot;</code>，所有读请求随机的分发到<code>wiriterHost</code>对应的<code>readhost</code>执行，<code>writerHost</code>不负担读压力</p><p><code>switchType</code>指的是切换的模式，目前的取值也有4种：</p><p><code>switchType=&#39;-1&#39;</code> 表示不自动切换</p><p><code>switchType=&#39;1&#39;</code> 默认值，表示自动切换</p><p><code>switchType=&#39;2&#39;</code> 基于<code>MySQL主从同步</code>的状态决定是否切换,心跳语句为<code>show slave status</code></p><p><code>switchType=&#39;3&#39;</code> 基于<code>MySQL galary cluster</code>的切换机制（适合集群）（1.4.1），心跳语句为<code>show status like &#39;wsrep%&#39;</code>。</p><p><code>rule.xml</code>定义分片规则的配置文件，分片规则的具体一些参数信息单独存放为文件。</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mycat:rule</span> <span class="token name">SYSTEM</span> <span class="token string">"rule.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mycat:</span>rule</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>mycat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://io.mycat/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rule1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- how many data nodes --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mycat:</span>rule</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据切分中作为表切分规则中最重要的配置，表的切分方式决定了数据切分后的性能好坏，因此也是最重要的配置。</p><p>如上面例子配置了一个切分规则，名为<code>rule1</code>对应的切分方式（<code>function</code>）是按日期切分，该配置中： </p><h2 id="tableRule"><a href="#tableRule" class="headerlink" title="tableRule"></a>tableRule</h2><p><code>name</code> 为<code>schema.xml</code>中<code>table</code>标签中对应的<code>rule=&quot;rule1&quot;</code>,也就是配置表的分片规则，<br><code>columns</code> 是表的切分字段：<code>id</code>。</p><p><code>algorithm</code> 是规则对应的切分规则：<code>映射到function的name</code>。 </p><h2 id="function"><a href="#function" class="headerlink" title="function"></a>function</h2><p><code>function</code> 配置是分片规则的配置。<br><code>name</code> 为切分规则的名称，名字人员取，但是需要与<code>tableRule</code>中匹配。<br><code>class</code> 是切分规则对应的切分类，写死，需要哪种规则则配置哪种，例如本例是求模法：<code>io.mycat.route.function.PartitionByMod</code></p><p>（上面<code>columns</code>标识将要分片的表字段，<code>algorithm</code>分片函数，</p><p>此种配置非常明确即根据<code>id</code>与<code>count</code>（你的结点数）进行求模预算，相比方式1，此种在批量插入时需要切换数据源，<code>id不连续</code>）。</p><p><code>property</code> 标签是切分规则对应的不同属性，不同的切分规则配置不同。 </p><h1 id="登录演示mycat"><a href="#登录演示mycat" class="headerlink" title="登录演示mycat"></a>登录演示mycat</h1><p>登录方式类似于<code>mysql</code>的服务端登陆，目前<code>mycat</code>有两个端口，<code>8066</code>数据端口，<code>9066</code>管理端口。</p><p><code>mysql -h192.168.10.142 -uroot -p -P8066</code></p><p><code>-h</code> 后面是主机，即当前<code>mycat</code>按照的主机地址，本地可用<code>127.0.0.1</code>远程需要远程<code>ip</code></p><p><code>-u</code> <code>Mycat server.xml</code>中配置的逻辑库用户</p><p><code>-p</code> <code>Mycat server.xml</code>中配置的逻辑库密码</p><p><code>-P</code> 后面是端口默认<code>9066</code>，注意<code>P</code>是大写</p><p><code>-d</code> <code>Mycat server.xml</code>中配置的逻辑库</p><p>数据端口与管理端口的配置端口修改：</p><p>数据端口默认<code>8066</code>，管理端口默认<code>9066</code>，如果需要修改需要配置<code>serve.xml</code><br><img src="/medias/img/mycat/4.png"><br><img src="/medias/img/mycat/5.png"><br><img src="/medias/img/mycat/6.png"></p><p>登录查看真实数据库查看内容是否在<code>db0</code>,<code>db1</code>,<code>db2</code>库的<code>users</code>表中</p><p><img src="/medias/img/mycat/7.png"><br><img src="/medias/img/mycat/8.png"><br>成功！！！</p><h1 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h1><p>启动<code>MyCAT</code>之前，需要先检查一些配置： </p><ol><li><p><code>java</code>的版本需要是<code>1.7</code>或以上；</p></li><li><p><code>Mysql</code>的配置文件需要加一行<code>lower_case_table_names = 1</code>在<code>[mysqld]</code>栏目中，这个设置为<code>Mysql</code>大小写不敏感，否则可能会发生表找不到的问题； </p></li><li><p><code>ERROR 3009 (HY000): java.lang.IllegalArgumentException: Invalid DataSource:1</code><br>这个有可能是<code>Mycat</code>和<code>MySQL</code>部署在同一台机器上，而在<code>schema.xml</code>是使用了<code>IP</code>的，但是账号只能使用<code>localhost</code>登陆，所以会出现本地的<code>Mycat</code>无法连接<code>MySQL</code> </p></li><li><p>添加<code>MYCAT_HOME</code>环境变量指向解压的<code>mycat</code>目录，主要是为了一些<code>bin</code>目录下的脚本的使用。 </p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mycat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ntp服务器</title>
      <link href="/posts/45695bdd.html"/>
      <url>/posts/45695bdd.html</url>
      
        <content type="html"><![CDATA[<p><strong>中国 | 域名：<font color=Blue>cn.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">120.25.115.20（深圳）</td><td>阿里云</td></tr><tr><td align="left">2</td><td align="center">182.92.12.11（北京）</td><td>阿里云</td></tr><tr><td align="left">3</td><td align="center">203.107.6.88（青岛）</td><td>阿里云</td></tr><tr><td align="left">4</td><td align="center">120.25.108.11（深圳）</td><td>阿里云</td></tr></tbody></table><p><strong>中国教科网 | 域名：<font color=Blue>edu.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">202.118.1.81（沈阳）</td><td>东北大学</td></tr><tr><td align="left">2</td><td align="center">202.118.1.130（沈阳）</td><td>东北大学</td></tr><tr><td align="left">3</td><td align="center">202.112.29.82（沈阳）</td><td>东北大学</td></tr><tr><td align="left">4</td><td align="center">202.112.31.197（沈阳）</td><td>东北大学</td></tr></tbody></table><p><strong>中国台湾 | 域名：<font color=Blue>tw.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">103.18.128.60（台北）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">123.204.45.116（高雄）</td><td>NtpPod</td></tr></tbody></table><p><strong>中国香港 | 域名：<font color=Blue>hk.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">118.193.151.223（香港）</td><td>NtpPod</td></tr></tbody></table><p><strong>日本 | 域名：<font color=Blue>jp.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">133.100.11.8（福冈）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">129.250.35.251（美国）</td><td>NtpPod</td></tr><tr><td align="left">3</td><td align="center">106.187.100.179（东京）</td><td>NtpPod</td></tr><tr><td align="left">4</td><td align="center">106.186.122.232（东京KDDI）</td><td>NtpPod</td></tr></tbody></table><p><strong>韩国 | 域名：<font color=Blue>kr.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">106.247.248.106（京畿道）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">211.233.40.78（韩国）</td><td>NtpPod</td></tr></tbody></table><p><strong>新加坡 | 域名：<font color=Blue>sgp.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">218.186.3.36（新加坡）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">128.199.134.40（新加坡）</td><td>NtpPod</td></tr><tr><td align="left">3</td><td align="center">188.166.245.58（新加坡）</td><td>NtpPod</td></tr><tr><td align="left">4</td><td align="center">202.73.57.107（新加坡）</td><td>NtpPod</td></tr><tr><td align="left">5</td><td align="center">103.11.143.248（新加坡）</td><td>NtpPod</td></tr></tbody></table><p><strong>美国 | 域名：<font color=Blue>us.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">208.53.158.34（芝加哥）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">66.228.42.59（新泽西）</td><td>NtpPod</td></tr><tr><td align="left">3</td><td align="center">158.69.48.97（加拿大魁北克）</td><td>NtpPod</td></tr><tr><td align="left">4</td><td align="center">216.218.254.202（加利福尼亚）</td><td>NtpPod</td></tr></tbody></table><p><strong>德国 | 域名：<font color=Blue>de.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">131.188.3.220（巴伐利亚）</td><td>NtpPod</td></tr><tr><td align="left">2</td><td align="center">131.188.3.223（巴伐利亚）</td><td>NtpPod</td></tr></tbody></table><p><strong>印度尼西亚 | 域名：<font color=Blue>ina.ntppod.com</font></strong></p><table><thead><tr><th align="left">序号</th><th align="center">服务器IP地址</th><th>提供者</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">203.114.74.17（雅加达）</td><td>NtpPod</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ntp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix</title>
      <link href="/posts/7dc34759.html"/>
      <url>/posts/7dc34759.html</url>
      
        <content type="html"><![CDATA[<h2 id="环境配置-server端和agent端"><a href="#环境配置-server端和agent端" class="headerlink" title="环境配置(server端和agent端)"></a>环境配置(server端和agent端)</h2><p>升级系统组件到最新的版本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  yum <span class="token parameter variable">-y</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>关闭selinux</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">setenforce <span class="token number">0</span>       <span class="token comment">#临时关闭命令</span><span class="token function">vi</span> /etc/selinux/config    <span class="token comment">#将SELINUX=enforcing改为SELINUX=disabled 设置后需要重启才能生效</span>getenforce         <span class="token comment">#检测selinux是否关闭，Disabled 为关闭</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>关闭防火墙</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--state</span>    <span class="token comment">#查看默认防火墙状态，关闭后显示not running，开启后显示running</span>systemctl stop firewalld.service    <span class="token comment">#临时关闭firewal</span>systemctl disable firewalld.service <span class="token comment">#禁止firewall开机启动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="zabbix服务端配置-server端"><a href="#zabbix服务端配置-server端" class="headerlink" title="zabbix服务端配置(server端)"></a>zabbix服务端配置(server端)</h2><p>zabbix需要借助LAMP或者LNMP环境,LAMP比较方便配置所以先搭建LAMP环境</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装软件包和其他工具包</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> httpd mariadb-server mariadb php php-mysql php-gd libjpeg* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mhash <span class="token function">rpm</span> <span class="token parameter variable">-qa</span> httpd php   mariadb  <span class="token comment"># 或者</span> <span class="token function">rpm</span> <span class="token parameter variable">-qa</span> httpd php mysql-community-server <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加首页支持格式　</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span>  /etc/httpd/conf/httpd.conf     DirectoryIndex index.html index.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置时区</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/php.ini      date.timezone <span class="token operator">=</span> PRC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>启动并加入开启自启动</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start httpd   <span class="token comment">#启动并加入开机自启动httpd</span>systemctl <span class="token builtin class-name">enable</span> httpdsystemctl start mysqld  <span class="token comment">#启动并加入开机自启动mysqld</span>systemctl <span class="token builtin class-name">enable</span> mysqldss <span class="token parameter variable">-anplt</span> <span class="token operator">|</span> <span class="token function">grep</span> httpd   <span class="token comment">#查看httpd启动情况，80端口监控表示httpd已启动</span>ss <span class="token parameter variable">-naplt</span> <span class="token operator">|</span> <span class="token function">grep</span> mysqld  <span class="token comment">#查看mysqld启动情况，3306端口监控表示mysqld已启动　</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建一个测试页测试</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">'echo "&lt;?php echo phpinfo();?>"  > index.php '</span><span class="token comment"># 直接使用sudo echo 会提示权限不足   例如：sudo echo "&lt;?php echo phpinfo();?>"  > index.php </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/zabbix/1.png"></p><h2 id="数据库配置-server端"><a href="#数据库配置-server端" class="headerlink" title="数据库配置(server端)"></a>数据库配置(server端)</h2><p>初始化数据库设置数据库root密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> mysqladmin <span class="token parameter variable">-u</span> root password <span class="token number">123456</span><span class="token comment">#root用户登陆数据库</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p123456</span>     <span class="token comment">#创建zabbix数据库（中文编码格式）</span>CREATE DATABASE zabbix character <span class="token builtin class-name">set</span> utf8 collate utf8_bin<span class="token punctuation">;</span> <span class="token comment">#授予zabbix用户zabbix数据库的所有权限，密码admin123</span>GRANT all ON zabbix.* TO <span class="token string">'zabbix'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'admin123'</span><span class="token punctuation">;</span><span class="token comment">#刷新权限</span>flush privileges<span class="token punctuation">;</span> <span class="token comment">#退出数据库 </span>quit              <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/zabbix/2.png"></p><p>数据库连接测试页</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /var/www/html/index.php     <span class="token operator">&lt;</span>?php    <span class="token variable">$link</span><span class="token operator">=</span>mysql_connect<span class="token punctuation">(</span><span class="token string">'172.18.20.224'</span>,<span class="token string">'zabbix'</span>,<span class="token string">'admin123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     if<span class="token punctuation">(</span><span class="token variable">$link</span><span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"&lt;h1>Success!!&lt;/h1>"</span><span class="token punctuation">;</span>   <span class="token comment">#显示Success表示连接数据库成功</span>    <span class="token keyword">else</span> <span class="token builtin class-name">echo</span> <span class="token string">"Fail!!"</span><span class="token punctuation">;</span>    mysql_close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ?<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/zabbix/3.png"></p><h2 id="安装zabbix-server端"><a href="#安装zabbix-server端" class="headerlink" title="安装zabbix(server端)"></a>安装zabbix(server端)</h2><p>安装依赖包和组件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  yum <span class="token parameter variable">-y</span> <span class="token function">install</span> net-snmp net-snmp-devel <span class="token function">curl</span> curl-devel libxml2 libxml2-devel libevent-devel.x86_64 javacc.noarch  javacc-javadoc.noarch javacc-maven-plugin.noarch javacc*<span class="token comment"># 安装php支持zabbix组件</span><span class="token function">sudo</span>  yum <span class="token function">install</span> php-bcmath php-mbstring <span class="token parameter variable">-y</span> <span class="token comment"># 会自动生成yum源文件，保证系统可以上网</span><span class="token function">sudo</span>  <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm<span class="token comment"># 清理yum缓存</span><span class="token function">sudo</span> yum clean all <span class="token comment"># 安装zabbix组件</span><span class="token function">sudo</span>  yum <span class="token function">install</span> zabbix-server-mysql zabbix-web-mysql <span class="token parameter variable">-y</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安装zabbix后会有一个数据库文件,需要把这个文件恢复到数据库中</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span>   /usr/share/doc/zabbix-server-mysql-4.0.21/<span class="token comment">#导入数据到数据库zabbix中(最后一个zabbix是数据库zabbix)，且因为用户zabbix是%(任意主机)，所以登录时需要加上当前主机ip(-h 192.168.1.122),密码是用户zabbix登陆密码admin123</span><span class="token function">sudo</span>  zcat  create.sql.gz <span class="token operator">|</span> mysql <span class="token parameter variable">-uzabbix</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.1.122 zabbix <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在配置文件中配置数据库用户及密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span>  /etc/zabbix/zabbix_server.conf     <span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">192.168</span>.1.122    <span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix    <span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix    <span class="token assign-left variable">DBPassword</span><span class="token operator">=</span>admin123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>确定数据库用户及密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token parameter variable">-n</span> <span class="token string">'^'</span><span class="token punctuation">[</span>a-Z<span class="token punctuation">]</span> /etc/zabbix/zabbix_server.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改时区</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">vim</span> /etc/httpd/conf.d/zabbix.conf<span class="token comment"># 将# php_value date.timezone Europe/Riga 变更成php_value date.timezone Asia/Shanghai</span>php_value date.timezone Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>启动并加入开机自启动zabbix-server</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> zabbix-serversystemctl start zabbix-server<span class="token comment">#   监听在10051端口上,如果没监听成功，可重启zabbix-server服务试试</span><span class="token function">netstat</span> <span class="token parameter variable">-anpt</span> <span class="token operator">|</span> <span class="token function">grep</span> zabbix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>默认用户和密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">默认账号Admin默认密码为zabbix  密码经过MD5加密后为5fce1b3e34b520afeffb37ce08c7cd66<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="welcom-zabbix-后台"><a href="#welcom-zabbix-后台" class="headerlink" title="welcom zabbix(后台)"></a>welcom zabbix(后台)</h2><p>如果以上步骤无误，现在可以使用web打开 </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://192.168.1.122/zabbix   <span class="token comment"># 注意这里IE浏览器打不开,使用其他浏览器</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/img/zabbix/5.png"><br>这里必须全部都是OK<br><img src="/medias/img/zabbix/6.png"><br><img src="/medias/img/zabbix/7.png"><br><img src="/medias/img/zabbix/8.png"><br><img src="/medias/img/zabbix/9.png"><br>安装成功<br><img src="/medias/img/zabbix/10.png"><br>进入界面后设置语言<br><img src="/medias/img/zabbix/11.png"><br>选择Chinese<br><img src="/medias/img/zabbix/12.png"></p><h2 id="Agent端配置-agent端"><a href="#Agent端配置-agent端" class="headerlink" title="Agent端配置(agent端)"></a>Agent端配置(agent端)</h2><p>安装依赖包和组件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> net-snmp net-snmp-devel <span class="token function">curl</span> curl-devel libxml2 libxml2-devel libevent-devel.x86_64 javacc.noarch  javacc-javadoc.noarch javacc-maven-plugin.noarch javacc*<span class="token comment"># 安装php支持zabbix组件</span>sudoyum <span class="token function">install</span> php-bcmath php-mbstring <span class="token parameter variable">-y</span><span class="token comment"># 会自动生成yum源文件，保证系统可以上网</span><span class="token function">sudo</span>  <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm<span class="token comment"># 清理yum缓存</span><span class="token function">sudo</span> yum clean all<span class="token comment"># 安装zabbix-agent </span><span class="token function">sudo</span> yum <span class="token function">install</span> zabbix-agent <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改zabbix-agent的配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/zabbix/zabbix_agentd.conf<span class="token comment"># 指定zabbix服务器的IP</span><span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">192.168</span>.1.122  <span class="token comment"># 指定zabbix服务器的IP</span><span class="token assign-left variable">ServerActive</span><span class="token operator">=</span><span class="token number">192.168</span>.1.122<span class="token comment"># 指定后台显示名称</span><span class="token assign-left variable">Hostname</span><span class="token operator">=</span>test   <span class="token comment"># 是否支持自定义key  默认为 0 不支持</span><span class="token assign-left variable">UnsafeUserParameters</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment"># 自定义key监控项</span><span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>prod.redis,ps <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'redis'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'grep'</span><span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>   <span class="token comment"># 自定义key监控项</span><span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>prod.mongo,ps <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'mongo'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'grep'</span><span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span> <span class="token comment"># 自定义key监控项</span><span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>prod.node,ps <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'node'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'grep'</span><span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动agent端</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/sbin/zabbix_agentd <span class="token parameter variable">-c</span> /etc/zabbix/zabbix_agentd.conf   <span class="token comment"># 启动agent端</span>systemctl restart zabbix-agent   <span class="token comment"># 重启</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="zabbix服务器上测试-server端"><a href="#zabbix服务器上测试-server端" class="headerlink" title="zabbix服务器上测试(server端)"></a>zabbix服务器上测试(server端)</h2><p>需要下载 zabbix-get</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> zabbix-get <span class="token parameter variable">-y</span>zabbix_get <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.1.220 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> prod.redis   <span class="token comment"># 显示数值 代表成功  </span><span class="token number">1</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="zabbix后台配置监控项-后台"><a href="#zabbix后台配置监控项-后台" class="headerlink" title="zabbix后台配置监控项(后台)"></a>zabbix后台配置监控项(后台)</h2><p>创建群组<br><img src="/medias/img/zabbix/13.png"><br>设置组名<br><img src="/medias/img/zabbix/14.png"><br><img src="/medias/img/zabbix/15.png"><br>创建主机<br><img src="/medias/img/zabbix/16.png"><br><img src="/medias/img/zabbix/18.png"><br><img src="/medias/img/zabbix/19.png"><br><img src="/medias/img/zabbix/20.png"><br><img src="/medias/img/zabbix/21.png"><br>创建监控项<br><img src="/medias/img/zabbix/22.png"><br><img src="/medias/img/zabbix/23.png"><br><img src="/medias/img/zabbix/24.png"><br>创建触发器<br><img src="/medias/img/zabbix/25.png"><br><img src="/medias/img/zabbix/26.png"><br><img src="/medias/img/zabbix/27.png"><br><img src="/medias/img/zabbix/28.png"><br>可以在最新数据查看当前值<br><img src="/medias/img/zabbix/29.png"><br><img src="/medias/img/zabbix/30.png"><br>修改状态测试<br><img src="/medias/img/zabbix/31.png"><br><img src="/medias/img/zabbix/32.png"><br><img src="/medias/img/zabbix/33.png"><br><img src="/medias/img/zabbix/34.png"><br>至此监控配置完成,下面需要配置邮件服务,当有服务宕机发邮件告警</p><h2 id="配置媒介邮件-server端"><a href="#配置媒介邮件-server端" class="headerlink" title="配置媒介邮件(server端)"></a>配置媒介邮件(server端)</h2><p>首先需要在邮件获取授权码<br><img src="/medias/img/zabbix/40.png"><br><img src="/medias/img/zabbix/41.png"><br><img src="/medias/img/zabbix/42.png"></p><p>本次测试使用mailx服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 关闭当前postfix邮件</span><span class="token function">sudo</span>  systemctl stop postfix<span class="token function">chkconfig</span>  postfix  off<span class="token comment"># 安装mailx</span><span class="token function">sudo</span> yum <span class="token function">install</span> mailx  <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置邮件服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">vim</span> /etc/mail.rc    <span class="token comment"># 发件人地址</span>    <span class="token builtin class-name">set</span> <span class="token assign-left variable">from</span><span class="token operator">=</span>xxxxxx@qq.com <span class="token assign-left variable">smtp</span><span class="token operator">=</span>smtp.qq.com      <span class="token comment"># 收件人地址                       授权码(邮箱IMAP/SMTP服务的授权码)</span>    <span class="token builtin class-name">set</span> smtp-auth-user<span class="token operator">=</span>xxxxxx@qq.com smtp-auth-password<span class="token operator">=</span>xxxxxx        <span class="token builtin class-name">set</span> smtp-auth<span class="token operator">=</span>login<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试发送邮件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"zabbix test mail"</span> <span class="token operator">|</span>mail <span class="token parameter variable">-s</span> <span class="token string">"zabbix"</span> xxxxxx@qq.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="配置发送邮件-后台"><a href="#配置发送邮件-后台" class="headerlink" title="配置发送邮件(后台)"></a>配置发送邮件(后台)</h2><p>管理—示警介类型—创建媒体类型<br>创建报警媒介类型 (脚本参数分别对应：收件人地址、主题、详细内容)<br><img src="/medias/img/zabbix/50.png"><br>配置用户 选择admin用户<br><img src="/medias/img/zabbix/51.png"><br>添加报警媒介<br><img src="/medias/img/zabbix/52.png"><br>创建报警动作 配置-动作-创建动作,新建动作<br><img src="/medias/img/zabbix/53.png"><br>新建操作<br><img src="/medias/img/zabbix/54.png"><br><img src="/medias/img/zabbix/55.png"><br>添加恢复操作<br><img src="/medias/img/zabbix/56.png"></p><p>配置完成后测试(修改触发器或者关闭进程)<br><img src="/medias/img/zabbix/57.png"><br><img src="/medias/img/zabbix/58.png"><br><img src="/medias/img/zabbix/59.png"><br><img src="/medias/img/zabbix/60.png"><br><img src="/medias/img/zabbix/61.png"><br><img src="/medias/img/zabbix/62.png"><br>邮件内容以及在动作日志中查看发送记录<br><img src="/medias/img/zabbix/63.png"></p><hr><h2 id="首先需要申请一个企业号"><a href="#首先需要申请一个企业号" class="headerlink" title="首先需要申请一个企业号"></a>首先需要申请一个企业号</h2><p>申请企业号，需要一个绑定你本人开户银行卡的微信号。<br>申请网址 <a href="https://qy.weixin.qq.com/">https://qy.weixin.qq.com/</a><br>点击“立即注册”。<br>根据提示注册企业号，到“选择类型”时，选择最右边的企业号。<br>注意：企业描述中：“报警”是敏感词不能使用。<br>登录之后，可以看到如下页面<br><img src="/medias/img/zabbix/1/1.png"><br>按照下图依次点击。<br><img src="/medias/img/zabbix/1/2.png"><br><img src="/medias/img/zabbix/1/3.png"><br><img src="/medias/img/zabbix/1/4.png"></p><h2 id="关注企业号的方法"><a href="#关注企业号的方法" class="headerlink" title="关注企业号的方法"></a>关注企业号的方法</h2><p>点击左侧的“设置”-二维码，使用微信扫一扫扫描二维码<br><img src="/medias/img/zabbix/1/5.png"><br>点击左侧列的“应用中心”，点击“我的应用”下面的加号<br><img src="/medias/img/zabbix/1/6.png"><br>填写应用名称，描述。一切正常的话，点击进入刚才创建的应用<br><img src="/medias/img/zabbix/1/7.png"><br>这里的应用 id 号需要记住。后面需要填写</p><h2 id="设置管理员"><a href="#设置管理员" class="headerlink" title="设置管理员"></a>设置管理员</h2><p>设置-功能设置-权限管理-新建管理组<br><img src="/medias/img/zabbix/1/8.png"><br><img src="/medias/img/zabbix/1/9.png"><br><img src="/medias/img/zabbix/1/10.png"><br>注意：这里要记录下来下面的 CorpID 和 Secret。</p><h2 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h2><p>在/usr/lib/zabbix/alertscripts目录(配置文件定义)下新建一个名为 wechat.sh 的脚本文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">CropID</span><span class="token operator">=</span><span class="token string">'ww13d3c1c55e5d3414'</span>   <span class="token comment"># 企业id-在网页应用管理可以查到</span><span class="token assign-left variable">Secret</span><span class="token operator">=</span><span class="token string">'-qo7YckISjsL11u8kI5PF0gGJrjYKlk0ISF2ftAPuzQ'</span>   <span class="token comment"># SecretID-在网页应用管理可以查到</span><span class="token assign-left variable">GURL</span><span class="token operator">=</span><span class="token string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=<span class="token variable">$CropID</span>&amp;corpsecret=<span class="token variable">$Secret</span>"</span><span class="token assign-left variable">Gtoken</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>/usr/bin/curl <span class="token parameter variable">-s</span> <span class="token parameter variable">-G</span> $GURL <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">'access_token":"'</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'"'</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token variable">`</span></span><span class="token assign-left variable">PURL</span><span class="token operator">=</span><span class="token string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=<span class="token variable">$Gtoken</span>"</span><span class="token keyword">function</span> <span class="token function-name function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token builtin class-name">local</span> int <span class="token assign-left variable">AppID</span><span class="token operator">=</span><span class="token number">1000002</span>  <span class="token comment"># 应用id-在网页应用管理可以查到</span><span class="token builtin class-name">local</span> <span class="token assign-left variable">UserID</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token builtin class-name">local</span> <span class="token assign-left variable">PartyID</span><span class="token operator">=</span><span class="token number">1</span><span class="token builtin class-name">local</span> <span class="token assign-left variable">Msg</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$@</span>"</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">" "</span> -f3-<span class="token variable">)</span></span><span class="token builtin class-name">printf</span> <span class="token string">'&#123;\n'</span><span class="token builtin class-name">printf</span> <span class="token string">'\t"touser": "'</span>"<span class="token variable">$User</span><span class="token string">"<span class="token entity" title="\&quot;">\"</span>"</span>,<span class="token punctuation">\</span>n<span class="token string">"printf '<span class="token entity" title="\t">\t</span>"</span>toparty<span class="token string">": "</span><span class="token string">'"$PartyID"\"",\n"printf '</span><span class="token punctuation">\</span>t<span class="token string">"msgtype"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,<span class="token punctuation">\</span>n<span class="token string">'printf '</span><span class="token punctuation">\</span>t<span class="token string">"agentid"</span><span class="token builtin class-name">:</span> <span class="token string">"'"</span> <span class="token variable">$AppID</span> <span class="token string">"<span class="token entity" title="\&quot;">\"</span>"</span>,<span class="token punctuation">\</span>n<span class="token string">"printf '<span class="token entity" title="\t">\t</span>"</span>text<span class="token string">": &#123;<span class="token entity" title="\n">\n</span>'printf '<span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>"</span>content<span class="token string">": "</span><span class="token string">'"$Msg"\""\n"printf '</span><span class="token punctuation">\</span>t<span class="token punctuation">&#125;</span>,<span class="token punctuation">\</span>n<span class="token string">'printf '</span><span class="token punctuation">\</span>t<span class="token string">"safe"</span><span class="token builtin class-name">:</span><span class="token string">"0"</span><span class="token punctuation">\</span>n<span class="token string">'printf '</span><span class="token punctuation">&#125;</span><span class="token punctuation">\</span>n'<span class="token punctuation">&#125;</span>/usr/bin/curl --data-ascii <span class="token string">"<span class="token variable"><span class="token variable">$(</span>body $1 $2 $3<span class="token variable">)</span></span>"</span> <span class="token variable">$PURL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要设置权限不然调用的时候会报错没有权限</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">chown</span> zabbix:zabbix   wechat.sh  <span class="token parameter variable">-R</span> <span class="token function">sudo</span>  <span class="token function">chmod</span> +x     wechat.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>执行./wechat.sh 1 1 test 看自己微信是否能收到信息，如果能的话，继续下一步。反之检查上面有什么问题。</p><h2 id="zabbix后台配置"><a href="#zabbix后台配置" class="headerlink" title="zabbix后台配置"></a>zabbix后台配置</h2><p>管理—示警介类型—创建媒体类型<br>创建报警媒介类型 (脚本参数分别对应：收件人地址、主题、详细内容)<br><img src="/medias/img/zabbix/1/21.png"><br>配置用户 选择admin用户<br><img src="/medias/img/zabbix/1/22.png"><br>添加报警媒介<br><img src="/medias/img/zabbix/1/23.png"><br>创建报警动作 配置-动作-创建动作,新建动作<br><img src="/medias/img/zabbix/1/24.png"><br>新建操作<br><img src="/medias/img/zabbix/1/25.png"><br><img src="/medias/img/zabbix/1/26.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">操作    故障<span class="token punctuation">&#123;</span>TRIGGER.STATUS<span class="token punctuation">&#125;</span>,服务器:<span class="token punctuation">&#123;</span>HOSTNAME1<span class="token punctuation">&#125;</span>发生: <span class="token punctuation">&#123;</span>TRIGGER.NAME<span class="token punctuation">&#125;</span>故障<span class="token operator">!</span>      告警主机:<span class="token punctuation">&#123;</span>HOSTNAME1<span class="token punctuation">&#125;</span>    告警时间:<span class="token punctuation">&#123;</span>EVENT.DATE<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>EVENT.TIME<span class="token punctuation">&#125;</span>    告警等级:<span class="token punctuation">&#123;</span>TRIGGER.SEVERITY<span class="token punctuation">&#125;</span>    告警信息: <span class="token punctuation">&#123;</span>TRIGGER.NAME<span class="token punctuation">&#125;</span>    告警项目:<span class="token punctuation">&#123;</span>TRIGGER.KEY1<span class="token punctuation">&#125;</span>    问题详情:<span class="token punctuation">&#123;</span>ITEM.NAME<span class="token punctuation">&#125;</span>:<span class="token punctuation">&#123;</span>ITEM.VALUE<span class="token punctuation">&#125;</span>    当前状态:<span class="token punctuation">&#123;</span>TRIGGER.STATUS<span class="token punctuation">&#125;</span>:<span class="token punctuation">&#123;</span>ITEM.VALUE1<span class="token punctuation">&#125;</span>    事件 ID:<span class="token punctuation">&#123;</span>EVENT.ID<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加恢复操作<br><img src="/medias/img/zabbix/1/27.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">恢复操作    恢复<span class="token punctuation">&#123;</span>TRIGGER.STATUS<span class="token punctuation">&#125;</span>, 服务器:<span class="token punctuation">&#123;</span>HOSTNAME1<span class="token punctuation">&#125;</span>: <span class="token punctuation">&#123;</span>TRIGGER.NAME<span class="token punctuation">&#125;</span>已恢复<span class="token operator">!</span>      告警主机:<span class="token punctuation">&#123;</span>HOSTNAME1<span class="token punctuation">&#125;</span>    告警时间:<span class="token punctuation">&#123;</span>EVENT.DATE<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>EVENT.TIME<span class="token punctuation">&#125;</span>    告警等级:<span class="token punctuation">&#123;</span>TRIGGER.SEVERITY<span class="token punctuation">&#125;</span>    告警信息: <span class="token punctuation">&#123;</span>TRIGGER.NAME<span class="token punctuation">&#125;</span>    告警项目:<span class="token punctuation">&#123;</span>TRIGGER.KEY1<span class="token punctuation">&#125;</span>    问题详情:<span class="token punctuation">&#123;</span>ITEM.NAME<span class="token punctuation">&#125;</span>:<span class="token punctuation">&#123;</span>ITEM.VALUE<span class="token punctuation">&#125;</span>    当前状态:<span class="token punctuation">&#123;</span>TRIGGER.STATUS<span class="token punctuation">&#125;</span>:<span class="token punctuation">&#123;</span>ITEM.VALUE1<span class="token punctuation">&#125;</span>    事件 ID:<span class="token punctuation">&#123;</span>EVENT.ID<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置完成后测试(修改触发器或者关闭进程)<br><img src="/medias/img/zabbix/1/28.png"><br><img src="/medias/img/zabbix/1/29.png"><br><img src="/medias/img/zabbix/1/30.png"></p><h2 id="邮件内容以及在动作日志中查看发送记录"><a href="#邮件内容以及在动作日志中查看发送记录" class="headerlink" title="邮件内容以及在动作日志中查看发送记录"></a>邮件内容以及在动作日志中查看发送记录</h2><p><img src="/medias/img/zabbix/1/35.png"></p><hr><h2 id="下载yum源报错"><a href="#下载yum源报错" class="headerlink" title="下载yum源报错"></a>下载yum源报错</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>sgsm@localhost yum.repos.d<span class="token punctuation">]</span>$ <span class="token function">sudo</span>  <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm     获取http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm    准备中<span class="token punctuation">..</span>.                          <span class="token comment">################################# [100%]</span>        <span class="token function">file</span> /etc/yum.repos.d/zabbix.repo from <span class="token function">install</span> of zabbix-release-4.0-1.el7.noarch conflicts with <span class="token function">file</span> from package zabbix-release-3.2-1.el7.noarch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这是因为服务器上已经部署了zabbix,卸载原来的zabbix就可以了 </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum  remove   zabbix-release-3.2-1.el7.noarch   <span class="token parameter variable">-y</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="后台登录密码忘记"><a href="#后台登录密码忘记" class="headerlink" title="后台登录密码忘记"></a>后台登录密码忘记</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> use zabbix    Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names    You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>    Database changedmysql<span class="token operator">></span> update <span class="token function">users</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token string">'5fce1b3e34b520afeffb37ce08c7cd66'</span> where <span class="token assign-left variable">userid</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>    Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>    Rows matched: <span class="token number">1</span>  Changed: <span class="token number">1</span>  Warnings: <span class="token number">0</span>      <span class="token comment"># 由于密码是md5加密的，我们可以查看默认的zabbix密码的md5</span>mysql<span class="token operator">></span> use zabbix<span class="token punctuation">;</span>mysql<span class="token operator">></span> update <span class="token function">users</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token string">'5fce1b3e34b520afeffb37ce08c7cd66'</span> where <span class="token assign-left variable">userid</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新设置密码为zabbix,然后重新登陆 用户：Admin   密码：zabbix</p><h2 id="zabbix设置中文出现乱码"><a href="#zabbix设置中文出现乱码" class="headerlink" title="zabbix设置中文出现乱码"></a>zabbix设置中文出现乱码</h2><p>zabbix语言设置为中文后,有乱码如下：<br><img src="/medias/img/zabbix/2/1.png"></p><p>1.从 windows 下控制面板-&gt;字体-&gt;选择一种中文字库例如“楷体”<br><img src="/medias/img/zabbix/2/2.png"><br><img src="/medias/img/zabbix/2/3.png"></p><p>2.将字体上传至/usr/share/zabbix/assets/fonts (根据zabbix的安装位置 可以使用find查找一下路径) 目录下<br><img src="/medias/img/zabbix/2/99.png"><br>注意：查找到zabbix有两个fonts目录 就去配置文件看下使用的那个目录(版本不同 路径就不同)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>sgsm@localhost fonts<span class="token punctuation">]</span>$ <span class="token function">cat</span> /usr/share/zabbix/include/defines.inc.php <span class="token operator">|</span> <span class="token function">grep</span> pathdefine<span class="token punctuation">(</span><span class="token string">'ZBX_FONTPATH'</span>,                          realpath<span class="token punctuation">(</span><span class="token string">'assets/fonts'</span><span class="token punctuation">))</span><span class="token punctuation">;</span> // where to search <span class="token keyword">for</span> font <span class="token punctuation">(</span>GD <span class="token operator">></span> <span class="token number">2.0</span>.18<span class="token punctuation">)</span><span class="token punctuation">[</span>sgsm@localhost fonts<span class="token punctuation">]</span>$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用rz 拉取到服务器<br><img src="/medias/img/zabbix/2/7.png"></p><p>3.修改 zabbix 页面管理的中文字体设置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server zabbix-2.4.5<span class="token punctuation">]</span><span class="token comment"># vim /usr/share/zabbix/include/defines.inc.php</span><span class="token comment">#修改如下 2 行</span>define<span class="token punctuation">(</span><span class="token string">'ZBX_FONT_NAME'</span>, <span class="token string">'simkai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>define<span class="token punctuation">(</span><span class="token string">'ZBX_GRAPH_FONT_NAME'</span>, <span class="token string">'simkai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>修改后的 zabbix 界面<br><img src="/medias/img/zabbix/2/5.png"><br>如果还不行就给字体权限</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">chmod</span>   <span class="token number">777</span>    simkai.ttf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Devops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>测试页面</title>
      <link href="/posts/af935060.html"/>
      <url>/posts/af935060.html</url>
      
        <content type="html"><![CDATA[<p><font color=red>测试jsdelivr加速GitHub图片，受jsdelivr服务器影响，可能会造成图片显示异常</font></p><p>这篇文章的标签是：<code>测试页</code>、<code>Markdown</code></p><p>这篇文章的分类是：<code>Markdown</code></p><p>这是一张图片：<br><img src="/medias/img/readme/0.jpg" alt="Hello Kitty?" title="😸😺😹😻😼😽🙀😿😾"><br>标题是：<strong>Hello Kitty?</strong></p><p>图片上注释为：”😸😺😹😻😼😽🙀😿😾”</p><p>这是几段代码高亮测试</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># shell 代码高亮测试</span><span class="token builtin class-name">echo</span> <span class="token string">"Hello World !"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span><span class="token comment"># python 代码高亮测试</span>a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">while</span> b <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>    a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// java 代码高亮测试</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><code>---</code>分割线上下空行即可</p><p><a href="https://www.runoob.com/markdown/md-tutorial.html" title="超链接title">md小技巧</a></p><p><code>[md小技巧](https://www.runoob.com/markdown/md-tutorial.html &quot;超链接title&quot;)</code>设置超链接文本</p><p><code>&quot;超链接title&quot;</code>可以不加</p><p>&emsp;&emsp;缩进、空白格</p><p><code>&amp;emsp;</code>全角空白格，用于中文段落首行缩进</p><p>换行使用行尾<code>两个空格</code>或者<code>空行</code>，均可以表示换行。有<code>图片链接</code>、<code>标题</code>、<code>表格</code>、<code>代码块</code>的上下行可以省略空格或空行，会自动换行。</p><hr><h1 id="一级标题"><a href="#一级标题" class="headerlink" title="一级标题"></a>一级标题</h1><h2 id="二级标题"><a href="#二级标题" class="headerlink" title="二级标题"></a>二级标题</h2><h3 id="三级标题"><a href="#三级标题" class="headerlink" title="三级标题"></a>三级标题</h3><h4 id="四级标题"><a href="#四级标题" class="headerlink" title="四级标题"></a>四级标题</h4><pre class="line-numbers language-none"><code class="language-none"># 一级标题## 二级标题### 三级标题#### 四级标题<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><p><em>斜体文本</em>  <strong>粗体文本</strong>  <del>删除线</del>  __init__  显示本体 不转义</p><p><code>*斜体文本*  **粗体文本**  ~~删除线~~  \_\_init__  </code>显示本体 不转义</p><blockquote><p>这是引用的内容 — 一级</p><blockquote><p>这是引用的内容 — 二级</p></blockquote></blockquote><pre class="line-numbers language-none"><code class="language-none">&gt;这是引用的内容 --- 一级&gt;&gt;这是引用的内容 --- 二级*注意这里没有空行*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下载地址书写：<a href="https://gitee.com/roxnc/download/raw/master/%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95.zip" title="类和方法.zip">download</a></p><p><code>下载地址书写：[download](https://gitee.com/roxnc/download/raw/master/类和方法.zip &quot;类和方法.zip&quot;)</code></p><hr><p>✅ Markdown<br>◻️ JavaScript</p><pre class="line-numbers language-none"><code class="language-none">复选框三种写法：* [x] Markdown* [ ] JavaScriptor+ [x] Markdown+ [ ] JavaScriptor- [x] Markdown- [ ] JavaScript<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>无序列表用 - + * 任何一种都可以</p><p>注意: - + * 跟内容之间都要有一个空格 </p><pre class="line-numbers language-none"><code class="language-none">- 列表内容- 列表内容- 列表内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>列表内容</li><li>列表内容</li><li>列表内容</li></ul><hr><p>有序列表</p><p>注意: 序号跟内容之间要有空格 </p><pre class="line-numbers language-none"><code class="language-none">1. 列表内容2. 列表内容3. 列表内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol><li>列表内容</li><li>列表内容</li><li>列表内容</li></ol><p>列表嵌套 </p><p>上一级和下一级之间敲三个空格即可 </p><pre class="line-numbers language-none"><code class="language-none">1. 列表12. 列表2   * 嵌套1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol><li><p>列表1</p></li><li><p>列表2</p><ul><li>嵌套1</li></ul></li></ol><hr><p>表格对齐方式</p><blockquote><p>-: 设置内容和标题栏居右对齐。</p><p>:- 设置内容和标题栏居左对齐。</p><p>:-: 设置内容和标题栏居中对齐。</p></blockquote><p>实例如下：</p><table><thead><tr><th align="left">左</th><th align="center">居中</th><th align="right">右</th></tr></thead><tbody><tr><td align="left">abc</td><td align="center">bcd</td><td align="right">cde</td></tr><tr><td align="left">abc</td><td align="center">bcd</td><td align="right">cde</td></tr><tr><td align="left">abc</td><td align="center">bcd</td><td align="right">cde</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>font <span class="token assign-left variable">face</span><span class="token operator">=</span><span class="token string">"黑体"</span><span class="token operator">></span>我是黑体字<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">face</span><span class="token operator">=</span><span class="token string">"微软雅黑"</span><span class="token operator">></span>我是微软雅黑<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">face</span><span class="token operator">=</span><span class="token string">"STCAIYUN"</span><span class="token operator">></span>我是华文彩云<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span>red<span class="token operator">></span>我是红色<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token comment">#008000>我是绿色&lt;/font></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span>Blue<span class="token operator">></span>我是蓝色<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token operator"><span class="token file-descriptor important">5</span>></span>我是尺寸<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">face</span><span class="token operator">=</span><span class="token string">"黑体"</span> <span class="token assign-left variable">color</span><span class="token operator">=</span>green <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token operator"><span class="token file-descriptor important">5</span>></span>我是黑体, 绿色, 尺寸为<span class="token operator"><span class="token file-descriptor important">5</span>&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>center<span class="token operator">></span>居中<span class="token operator">&lt;</span>/center<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><font face="黑体">我是黑体字</font></p><p><font face="微软雅黑">我是微软雅黑</font></p><p><font face="STCAIYUN">我是华文彩云</font></p><p><font color=red>我是红色</font></p><p><font color=#008000>我是绿色</font></p><p><font color=Blue>我是蓝色</font></p><p><font size=5>我是尺寸</font></p><center>居中</center><p><font face="黑体" color=green size=5>我是黑体, 绿色, 尺寸为5</font></p><hr><p>参考<a href="https://blog.csdn.net/heimu24/article/details/81189700">链接</a></p><p>脚注是对文本的补充说明。</p><p>[^要注明的文本]</p><p>创建脚注格式类似这样 [^RUNOOB]。</p><p>[^RUNOOB]: 菜鸟教程 – 学的不仅是技术, 更是梦想！！！</p><p>TODO 待完成</p><p>FIXME 代码需要修正和原因说明</p><p>XXX 虽然实现功能，但是代码需要改进和说明</p><p>HACK 补锅踩雷填坑</p><p>BUG 丢锅埋雷挖坑</p><p><code>Ctrl+G</code>快速去某一行</p><h2 id="Have-a-nice-day"><a href="#Have-a-nice-day" class="headerlink" title="Have a nice day "></a><font size=5><strong>Have a nice day</strong> </font></h2>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo使用手册</title>
      <link href="/posts/6600e9a1.html"/>
      <url>/posts/6600e9a1.html</url>
      
        <content type="html"><![CDATA[<h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><p>安装前提：先安装<code>nodejs</code>和<code>git</code>，<code>win10</code>和<code>Linux</code>安装建议使用安装包，安装到默认位置即可，省的配置环境变量。</p><p><a href="https://nodejs.org/zh-cn/">Node.js</a></p><p><a href="http://git-scm.com/">Git</a></p><p>进入你的<code>hexo</code>目录，建议使用<code>vscode</code>或者<code>typora</code>打开目录</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo hexo-clihexo init<span class="token function">npm</span> i<span class="token comment"># 新建完成后，指定文件夹的目录如下：</span><span class="token builtin class-name">.</span>├── node_modules├── _config.yml├── package.json├── scaffolds├── <span class="token builtin class-name">source</span><span class="token operator">|</span>   ├── _drafts<span class="token operator">|</span>   └── _posts└── themes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在win10系统，如果使用<code>hexo s</code>报错，配置win10的环境变量：</p><p>打开<code>设置</code>，搜索<code>高级系统设置</code>，找到<code>环境变量</code>，在<code>用户变量</code>和<code>系统变量</code>里面找到<code>Path</code>，分别点击<code>编辑</code></p><p><img src="/medias/img/readme/0.png"></p><p>新建一行，这一行是你的<code>hexo目录</code>下面的<code>node_modules</code>下的<code>.bin</code>目录</p><p><img src="/medias/img/readme/1.png"></p><p>直接在<code>文件资源管理器</code>打开<code>.bin</code>目录，复制地址栏的地址即可。</p><p><img src="/medias/img/readme/2.png"></p><p>配置完成后需要打开新的<code>编辑器</code>或<code>cmd</code>执行命令</p><p>win10其他问题<code>无法加载文件...禁止运行脚本</code>，在设置中搜索<code>允许本地</code>，勾选应用<code>允许powershell较笨在不签名的情况下运行</code>：</p><p><img src="/medias/img/readme/3.png"></p><h2 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h2><p>进入到<code>themes</code>目录，克隆主题，并修改文件夹名称为<code>matery</code>，删除如果你需要将主题自定义美化，并上传到git仓库，需要将clone下来的仓库中的<code>.git</code>目录删除，在hexo目录创建<code>.git</code>，上传到自己的代码库统一管理。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/blinkfox/hexo-theme-matery.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在<code>hexo</code>目录将<code>_config.landscape.yml</code>修改为<code>_config.matery.yml</code></p><h2 id="统一配置文件"><a href="#统一配置文件" class="headerlink" title="统一配置文件"></a>统一配置文件</h2><p>将主题文件夹下的<code>_config.yml</code>文件中的内容复制到hexo根目录下的<code>_config.matery.yml</code>文件中，并删除主题文件夹下的<code>_config.yml</code>文件</p><p>以后主题配置文件就是<code>_config.matery.yml</code>，hexo配置文件是<code>_config.yml</code></p><h2 id="写作技巧"><a href="#写作技巧" class="headerlink" title="写作技巧"></a>写作技巧</h2><p>写草稿，不会被发布：</p><p><code>hexo n draft 文章草稿</code></p><p>这样会在<code>source/_draft</code>中新建一个<strong>文章草稿.md</strong>，预览草稿：</p><p><code>hexo s -p 80 --draft</code></p><p>不预览草稿，正式发布预览：</p><p><code>hexo s -p 80</code></p><p>写完的草稿，正式发布：</p><p><code>hexo p draft 文章草稿</code></p><p>这样会自动把<strong>文章草稿.md</strong>发布到<code>_posts</code>目录下。</p><p>写作请使用</p><p><code>hexo n post --path 分类名/文章名 &quot;title信息&quot;</code></p><p>hexo简写命令：</p><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">hexo n <span class="token string">"文章名"</span> == hexo new <span class="token string">"文章名"</span>hexo p == hexo publishhexo g == hexo generatehexo s == hexo serverhexo d == hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">hexo s   <span class="token comment"># Hexo会监视文件变动并自动更新，您无须重启服务器。</span>hexo s <span class="token operator">-</span>s   <span class="token comment"># 静态模式</span>hexo s <span class="token operator">-</span>p 5000   <span class="token comment"># 更改端口</span>hexo s <span class="token operator">-</span>i 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>1<span class="token punctuation">.</span>10   <span class="token comment"># 自定义 IP</span>hexo clean   <span class="token comment"># 清除缓存,网页正常情况下可以忽略此条命令</span>hexo g   <span class="token comment"># 生成静态网页</span>hexo d   <span class="token comment"># 开始部署</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PXE批量装机</title>
      <link href="/posts/c9503579.html"/>
      <url>/posts/c9503579.html</url>
      
        <content type="html"><![CDATA[<h1 id="PXE批量装机"><a href="#PXE批量装机" class="headerlink" title="PXE批量装机"></a>PXE批量装机</h1><h2 id="PXE的工作过程"><a href="#PXE的工作过程" class="headerlink" title="PXE的工作过程"></a>PXE的工作过程</h2><ol><li><p>客户机从自己的PXE网卡启动，向本网络中的DHCP服务器索取IP</p></li><li><p>DHCP服务器返回分给客户机IP以及bootstrap文件的放置位置(该文件一 般是放在一台TFTP服务器上)</p></li><li><p>客户机向本网络中的TFTP服务器索取bootstrap文件</p></li><li><p>客户机取得bootstrap文件后之执行该文件</p></li><li><p>根据bootstrap的执行结果，通过TFTP服务器加载内核和文件系统</p></li><li><p>进入安装画面, 此时可以通过选择FTP,HTTP,NFS方式之一进行安装</p></li></ol><h2 id="PXE：预启动执行环境"><a href="#PXE：预启动执行环境" class="headerlink" title="PXE：预启动执行环境"></a>PXE：预启动执行环境</h2><p>PXE是由Intel公司开发的网络引导技术，工作在C/S架构，允许客户机通 过网络从远程服务器下载引导镜像，并加载安装文件或者整个操作系统。</p><p>若要搭建PXE网络体系，必须满足一下几个前提条件：</p><ol><li><p>客户机的网卡支持pxe协议（集成BOOTROM芯片），且主板支持网 络引导，目前绝大多数服务器和大多数PC都能够提供此功能，只需要在BIOS设 置中允许从network或LAN启动即可。</p></li><li><p>网络中有一台DHCP服务器以便为客户机自动分配地址，指定引导文 件位置（因为客户机没有操作系统无法配置ip，所以架设DHCP）。</p></li><li><p>服务器通过TFTP（简单文件传输协议）提供引导镜像文件的下载 （为什么用TFTP呢？ 因为TFTP客户端工具比较小集成在了网卡上）。</p></li></ol><h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><p>准备centos6安装源</p><p><code>mount /dev/se0 /media</code></p><p>安装并启用TFTP（启动xinetd）、ftp（启动vsftpd）服务，</p><p><code>yum -y install tftp-server ftp*</code></p><p><img src="/medias/img/pxe/0.png"></p><p><code>vim /etc/xinetd.d/tftp</code></p><p>修改<code>wait</code>为<code>no</code>，修改<code>disable</code>为<code>no</code></p><p><img src="/medias/img/pxe/1.png"></p><p>启动<code>xinetd.d</code>，使用<code>netstat -nupl</code>查看<code>xinetd.d</code>的端口是否启动</p><p><img src="/medias/img/pxe/2.png"></p><p>挂载光盘，复制<code>initrd.img</code>和<code>vmlinz</code>到<code>/var/lib/tftpboot/</code>目录下</p><p><img src="/medias/img/pxe/3.png"></p><p>安装<code>syslinux</code></p><p><img src="/medias/img/pxe/4.png"></p><p>复制<code>pxelinux.0</code>到<code>/var/lib/tftpboot/</code>目录下</p><p><img src="/medias/img/pxe/5.png"></p><p>复制菜单文件<code>isolinux.cfg</code>到<code>/var/lib/tftpboot/pxelinux.cfg/default</code>修改权限为<code>644</code></p><p><img src="/medias/img/pxe/6.png"></p><p>安装<code>DHCP</code></p><p><img src="/medias/img/pxe/7.png"></p><p>复制并配置<code>DHCP</code></p><p><img src="/medias/img/pxe/8.png"></p><p>在配置文件最后添加（<code>DHCP</code>配置和下载文件的主机、文件名）</p><p><img src="/medias/img/pxe/9.png"></p><p>注：网卡配置为<code>192.168.0.33</code>静态；虚拟机里面调整<code>vmnet</code></p><p>将光盘挂载到<code>/var/ftp/pub/</code></p><p><img src="/medias/img/pxe/10.png"></p><p>装机客户端：</p><p>进入<code>BIOS</code>将<code>Network</code>调整到第一个，<code>F10</code>回车，保存退出，等待开机。</p><p><img src="/medias/img/pxe/11.png"><br>（下面按图，选择回车）</p><p><img src="/medias/img/pxe/12.png"><br><img src="/medias/img/pxe/13.png"><br><img src="/medias/img/pxe/14.png"></p><p>在红色光标处按 <code>空格</code> 按<code>↓</code> 选择<code>OK</code> 回车下一步，等待一会。</p><p><img src="/medias/img/pxe/15.png"></p><p>在最上面一行输入：<code>ftp://192.168.0.33/pub</code>，选择<code>OK</code></p><p><img src="/medias/img/pxe/16.png"></p><p>出现以下界面就行啦</p><p><img src="/medias/img/pxe/17.png"></p><p>读条完成出现以下界面：（熟悉的配方）</p><p><img src="/medias/img/pxe/18.png"></p><hr><h1 id="无人值守安装"><a href="#无人值守安装" class="headerlink" title="无人值守安装"></a>无人值守安装</h1><h2 id="kickstart无人值守技术"><a href="#kickstart无人值守技术" class="headerlink" title="kickstart无人值守技术"></a>kickstart无人值守技术</h2><ol><li><p>创建应答文件，预先定义好各种安装设置</p></li><li><p>免去交互设置过程，从而实现全自动化安装</p></li><li><p>通过添加%post脚本，完成安装后的各种配置操作</p></li></ol><h2 id="准备安装应答文件"><a href="#准备安装应答文件" class="headerlink" title="准备安装应答文件"></a>准备安装应答文件</h2><ol><li><p>配置安全应答参数</p></li><li><p>保存自动应答文件</p></li></ol><h2 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a>具体步骤：</h2><p>安装应答文件需要<code>system-config-kickstart</code>这个软件包</p><p>挂载光盘到<code>/media/</code>，<code>cd /media/Packages/</code>，使用<code>localinstall</code>解决<code>yum</code>安装依赖包</p><p><code>yum –y localinstall system-config-kickstart-2.8.6.6-el6.noarch.rpm</code></p><p><img src="/medias/img/pxe/19.png"></p><p>输入<code>system-config-kickstart</code>回车，等待一会</p><p><img src="/medias/img/pxe/20.png"></p><p>弹出以下界面</p><p><img src="/medias/img/pxe/21.png"><br><img src="/medias/img/pxe/22.png"><br><img src="/medias/img/pxe/23.png"></p><p>在 布局 选项下面，设置分区信息（不能超过客户机磁盘容量！）</p><p><code>/boot：200M</code></p><p><code>/swap：1200M</code></p><p><code>/：10000M</code></p><p><img src="/medias/img/pxe/24.png"><br><img src="/medias/img/pxe/25.png"><br><img src="/medias/img/pxe/26.png"><br><img src="/medias/img/pxe/27.png"><br><img src="/medias/img/pxe/28.png"></p><p>保存之后关闭窗口即可</p><p><img src="/medias/img/pxe/29.png"></p><p>复制光盘里的内容到<code>/var/ftp/pub</code>，复制<code>ks.cfg</code>到<code>pub</code>目录下</p><p><img src="/medias/img/pxe/30.png"></p><p>编辑<code>default</code>文件</p><p><img src="/medias/img/pxe/31.png"><br><img src="/medias/img/pxe/32.png"></p><p>客户机开机进入<code>BIOS</code>，在<code>boot</code>项下，将<code>Network</code>调整到第一位，<code>F10</code>保存退出</p><p><img src="/medias/img/pxe/33.png"><br><img src="/medias/img/pxe/34.png"><br>（报错：无法下载文件，重启服务端<code>xinetd</code>，<code>vsftpd</code>等服务）</p><p><img src="/medias/img/pxe/35.png"><br><img src="/medias/img/pxe/36.png"><br><img src="/medias/img/pxe/37.png"><br>输入<code>root</code>用户，密码是上面设置的<code>123456</code></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pxe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>防火墙</title>
      <link href="/posts/9c75190f.html"/>
      <url>/posts/9c75190f.html</url>
      
        <content type="html"><![CDATA[<h1 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h1><p>防火墙，其实说白了讲，就是用于实现Linux下访问控制的功能的，它分为<font color=red>硬件的或者软件的防火墙两种</font>。无论是在哪个网络中，防火墙工作的地方一定是在网络的边缘。而我们的任务就是需要去定义到底防火墙如何工作，这就是防火墙的策略/规则，以达到让它对出入网络的IP、数据进行检测。</p><p>目前市面上比较常见的有3、4层的防火墙，叫网络层的防火墙，还有7层的防火墙，其实是代理层的网关。</p><p>对于TCP/IP的七层模型来讲，我们知道第三层是网络层，三层的防火墙会在这层对源地址和目标地址进行检测。但是对于七层的防火墙，不管你源端口或者目标端口，源地址或者目标地址是什么，都将对你所有的东西进行检查。所以，对于设计原理来讲，七层防火墙更加安全，但是这却带来了效率更低。所以市面上通常的防火墙方案，都是两者结合的。而又由于我们都需要从防火墙所控制的这个口来访问，所以防火墙的工作效率就成了用户能够访问数据多少的一个最重要的控制，配置的不好甚至有可能成为流量的瓶颈。</p><h1 id="iptables的历史以及工作原理"><a href="#iptables的历史以及工作原理" class="headerlink" title="iptables的历史以及工作原理"></a>iptables的历史以及工作原理</h1><h2 id="iptables的发展"><a href="#iptables的发展" class="headerlink" title="iptables的发展"></a>iptables的发展</h2><p><code>iptables</code>的前身叫<code>ipfirewall</code>（内核1.x时代）,这是一个作者从<code>freeBSD</code>上移植过来的，能够工作在内核当中的，对数据包进行检测的一款简易访问控制工具。但是<code>ipfirewall</code>工作功能极其有限(它需要将所有的规则都放进内核当中，这样规则才能够运行起来，而放进内核，这个做法一般是极其困难的)。当内核发展到2.x系列的时候，软件更名为<code>ipchains</code>，它可以定义多条规则，将他们串起来，共同发挥作用，而现在，它叫做<code>iptables</code>，可以将规则组成一个列表，实现绝对详细的访问控制功能。</p><p>他们都是工作在用户空间中，定义规则的工具，本身并不算是防火墙。它们定义的规则，可以让在内核空间当中的<code>netfilter</code>来读取，并且实现让防火墙工作。而放入内核的地方必须要是特定的位置，必须是<code>tcp/ip</code>的协议栈经过的地方。而这个<code>tcp/ip</code>协议栈必须经过的地方，可以实现读取规则的地方就叫做<code>netfilter</code>。(网络过滤器)</p><p>作者一共在内核空间中选择了5个位置，</p><ol><li>内核空间中：从一个网络接口进来，到另一个网络接口去的</li></ol><p><code>FORWARD</code>：转发</p><ol start="2"><li>数据包从内核流入用户空间的</li></ol><p><code>INPUT</code>：进站</p><ol start="3"><li>数据包从用户空间流出的</li></ol><p><code>OUTPUT</code>：出站</p><ol start="4"><li>进入/离开本机的外网接口</li></ol><p><code>POSTROUTING</code>：路由后</p><ol start="5"><li>进入/离开本机的内网接口</li></ol><p><code>PREROUTEING</code>：路由前</p><h2 id="iptables的工作机制"><a href="#iptables的工作机制" class="headerlink" title="iptables的工作机制"></a>iptables的工作机制</h2><p>从上面的发展我们知道了作者选择了5个位置，来作为控制的地方，但是你有没有发现，其实前三个位置已经基本上能将路径彻底封锁了，但是为什么已经在进出的口设置了关卡之后还要在内部卡呢？由于数据包尚未进行路由决策，还不知道数据要走向哪里，所以在进出口是没办法实现数据过滤的。所以要在内核空间里设置转发的关卡，进入用户空间的关卡，从用户空间出去的关卡。那么，既然他们没什么用，那我们为什么还要放置他们呢？因为我们在做NAT和DNAT的时候，目标地址转换必须在路由之前转换。所以我们必须在外网而后内网的接口处进行设置关卡。</p><p>这五个位置也被称为五个钩子函数（hook functions）,也叫五个规则链。</p><ol><li><p><code>PREROUTING</code> (路由前)</p></li><li><p><code>INPUT</code> (数据包流入口)</p></li><li><p><code>FORWARD</code> (转发管卡)</p></li><li><p><code>OUTPUT</code> (数据包出口)</p></li><li><p><code>POSTROUTING</code> (路由后)</p></li></ol><p>这是<code>NetFilter</code>规定的五个规则链，任何一个数据包，只要经过本机，必将经过这五个链中的其中一个链。 </p><h2 id="防火墙的策略"><a href="#防火墙的策略" class="headerlink" title="防火墙的策略"></a>防火墙的策略</h2><p>防火墙策略一般分为两种，一种叫“通”策略，一种叫“堵”策略，通策略，默认门是关着的，必须要定义谁能进。堵策略则是，大门是洞开的，但是你必须有身份认证，否则不能进。所以我们要定义，让进来的进来，让出去的出去，所以通，是要全通，而堵，则是要选择。当我们定义的策略的时候，要分别定义多条功能，其中：定义数据包中允许或者不允许的策略，filter过滤的功能，而定义地址转换的功能的则是nat选项。为了让这些功能交替工作，我们制定出了“表”这个定义，来定义、区分各种不同的工作功能和处理方式。</p><p>我们现在用的比较多个功能有3个：</p><ol><li><p><code>filter</code> 定义允许或者不允许的</p></li><li><p><code>nat</code> 定义地址转换的</p></li><li><p><code>mangle</code>功能:修改报文原数据</p></li></ol><p>我们修改报文原数据就是来修改TTL的。能够实现将数据包的元数据拆开，在里面做标记/修改内容的。而防火墙标记，其实就是靠mangle来实现的。</p><p>小扩展:</p><p>对于<code>filter</code>来讲一般只能做在3个链上：<code>INPUT</code> ，<code>FORWARD</code> ，<code>OUTPUT</code></p><p>对于<code>nat</code>来讲一般也只能做在3个链上：<code>PREROUTING</code> ，<code>OUTPUT</code> ，<code>POSTROUTING</code></p><p>而<code>mangle</code>则是5个链都可以做：<code>PREROUTING</code>，<code>INPUT</code>，<code>FORWARD</code>，<code>OUTPUT</code>，<code>POSTROUTING</code></p><p><code>iptables/netfilter</code>（这款软件）是工作在用户空间的，它可以让规则进行生效的，本身不是一种服务，而且规则是立即生效的。而我们<code>iptables</code>现在被做成了一个服务，可以进行启动，停止的。启动，则将规则直接生效，停止，则将规则撤销。</p><p><code>iptables</code>还支持自己定义链。但是自己定义的链，必须是跟某种特定的链关联起来的。在一个关卡设定，指定当有数据的时候专门去找某个特定的链来处理，当那个链处理完之后，再返回。接着在特定的链中继续检查。</p><p>注意：规则的次序非常关键，谁的规则越严格，应该放的越靠前，而检查规则的时候，是按照从上往下的方式进行检查的。</p><h1 id="规则的写法"><a href="#规则的写法" class="headerlink" title="规则的写法:"></a>规则的写法:</h1><p><code>iptables</code>定义规则的方式比较复杂：格式：<code>iptables [-t table] COMMAND chain CRETIRIA -j ACTION</code></p><p><code>-t table</code>：3个filter nat mangle</p><p><code>COMMAND</code>：定义如何对规则进行管理</p><p><code>chain</code>：指定你接下来的规则到底是在哪个链上操作的，当定义策略的时候，是可以省略的</p><p><code>CRETIRIA</code>：指定匹配标准</p><p><code>-j ACTION</code>：指定如何进行处理</p><p>比如：不允许<code>172.16.0.0/24</code>的进行访问。</p><p><code>iptables -t filter -A INPUT -s 172.16.0.0/16 -p udp --dport 53 -j DROP</code></p><p>当然你如果想拒绝的更彻底：</p><p><code>iptables -t filter -R INPUT 1 -s 172.16.0.0/16 -p udp --dport 53 -j REJECT</code></p><p>查看定义规则的详细信息</p><p><code>iptables -L -n -v</code></p><h1 id="详解COMMAND"><a href="#详解COMMAND" class="headerlink" title="详解COMMAND:"></a>详解COMMAND:</h1><h2 id="链管理命令（这都是立即生效的）"><a href="#链管理命令（这都是立即生效的）" class="headerlink" title="链管理命令（这都是立即生效的）"></a>链管理命令（这都是立即生效的）</h2><p><code>-P</code>：设置默认策略的（设定默认门是关着的还是开着的）默认策略一般只有两种</p><p><code>iptables -P INPUT (DROP|ACCEPT)</code>  默认是关的/默认是开的</p><p>比如：<code>iptables -P INPUT DROP</code> 这就把默认规则给拒绝了。并且没有定义哪个动作，所以关于外界连接的所有规则包括Xshell连接之类的，远程连接都被拒绝了。</p><p><code>-F</code>：FLASH，清空规则链的(注意每个链的管理权限)</p><p><code>iptables -t nat -F PREROUTING</code></p><p><code>iptables -t nat -F</code> 清空nat表的所有链</p><p><code>-N</code>：NEW 支持用户新建一个链</p><p><code>iptables -N inbound_tcp_web</code> 表示附在tcp表上用于检查web的。</p><p><code>-X</code>：用于删除用户自定义的空链，使用方法跟-N相同，但是在删除之前必须要将里面的链给清空昂了</p><p><code>-E</code>：用来Rename chain主要是用来给用户自定义的链重命名</p><p><code>-E oldname newname</code></p><p><code>-Z</code>：清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）</p><p><code>iptables -Z</code>:清空</p><h2 id="规则管理命令"><a href="#规则管理命令" class="headerlink" title="规则管理命令"></a>规则管理命令</h2><p><code>-A</code>：追加，在当前链的最后新增一个规则</p><p><code>-I num</code>：插入，把当前规则插入为第几条。</p><p><code>-I 3</code>：插入为第三条</p><p><code>-R num</code>：Replays替换/修改第几条规则，格式：<code>iptables -R 3 ...</code></p><p><code>-D num</code>：删除，明确指定删除第几条规则</p><h2 id="查看管理命令-“-L”"><a href="#查看管理命令-“-L”" class="headerlink" title="查看管理命令 “-L”"></a>查看管理命令 “-L”</h2><p>附加子命令</p><p><code>-n</code>：以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名。</p><p><code>-v</code>：显示详细信息</p><p><code>-vv</code>，<code>-vvv</code>:越多越详细</p><p><code>-x</code>：在计数器上显示精确值，不做单位换算</p><p><code>--line-numbers</code>：显示规则的行号</p><p><code>-t nat</code>：显示所有的关卡的信息</p><h1 id="详解匹配标准"><a href="#详解匹配标准" class="headerlink" title="详解匹配标准"></a>详解匹配标准</h1><h2 id="通用匹配：源地址目标地址的匹配"><a href="#通用匹配：源地址目标地址的匹配" class="headerlink" title="通用匹配：源地址目标地址的匹配"></a>通用匹配：源地址目标地址的匹配</h2><p><code>-s</code>：指定作为源地址匹配，这里不能指定主机名称，必须是IP</p><p><code>IP</code> <code>IP/MASK</code> <code>0.0.0.0/0.0.0.0</code>，而且地址可以取反，加一个”!”表示除了哪个IP之外</p><p><code>-d</code>：表示匹配目标地址</p><p><code>-p</code>：用于匹配协议的（这里的协议通常有3种，<code>TCP</code>/<code>UDP</code>/<code>ICMP</code>）</p><p><code>-i eth0</code>：从这块网卡流入的数据，流入一般用在<code>INPUT</code>和<code>PREROUTING</code>上</p><p><code>-o eth0</code>：从这块网卡流出的数据，流出一般在<code>OUTPUT</code>和<code>POSTROUTING</code>上</p><h2 id="扩展匹配"><a href="#扩展匹配" class="headerlink" title="扩展匹配"></a>扩展匹配</h2><h3 id="隐含扩展：对协议的扩展"><a href="#隐含扩展：对协议的扩展" class="headerlink" title="隐含扩展：对协议的扩展"></a>隐含扩展：对协议的扩展</h3><p><code>-p tcp</code>：TCP协议的扩展。一般有三种扩展</p><p><code>--dport XX-XX</code>：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如</p><p><code>--dport 21</code> 或者 <code>--dport 21-23</code> (此时表示21,22,23)</p><p><code>--sport</code>：指定源端口</p><p><code>--tcp-flags</code>：TCP的标志位（<code>SYN</code>,<code>ACK</code>，<code>FIN</code>,<code>PSH</code>，<code>RST</code>,<code>URG</code>）</p><p>对于它，一般要跟两个参数：<code>检查的标志位</code>/<code>必须为1的标志位</code></p><p><code>--tcp-flags syn,ack,fin,rst</code>=<code>--syn</code></p><p>表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的<code>SYN</code>为1的包，还有一种简写方式，叫做<code>--syn</code></p><p><code>-p udp</code>：<code>UDP</code>协议的扩展</p><p><code>--dport</code></p><p><code>--sport</code></p><p><code>-p icmp</code>：<code>icmp</code>数据报文的扩展</p><p><code>--icmp-type</code>：</p><p><code>echo-request</code>(请求回显)，一般用8 来表示，所以 <code>--icmp-type 8</code> 匹配请求回显数据包</p><p><code>echo-reply</code> （响应的数据包）一般用0来表示</p><h3 id="显式扩展（-m）"><a href="#显式扩展（-m）" class="headerlink" title="显式扩展（-m）"></a>显式扩展（-m）</h3><p>扩展各种模块</p><p><code>-m multiport</code>：表示启用多端口扩展</p><p>之后我们就可以启用比如<code>--dports 21,23,80</code></p><h1 id="详解-j-ACTION"><a href="#详解-j-ACTION" class="headerlink" title="详解-j ACTION"></a>详解-j ACTION</h1><p>常用的<code>ACTION</code>：</p><p><code>DROP</code>：悄悄丢弃，一般我们多用DROP来隐藏我们的身份，以及隐藏我们的链表</p><p><code>REJECT</code>：明示拒绝</p><p><code>ACCEPT</code>：接受</p><p><code>custom_chain</code>：转向一个自定义的链</p><p><code>DNAT</code></p><p><code>SNAT</code></p><p><code>MASQUERADE</code>：源地址伪装</p><p><code>REDIRECT</code>：重定向：主要用于实现端口重定向</p><p><code>MARK</code>：打防火墙标记的</p><p><code>RETURN</code>：返回</p><p>在自定义链执行完毕后使用返回，来返回原规则链。</p><p>Q1：只要是来自于<code>172.16.0.0/16</code>网段的都允许访问我本机的<code>172.16.100.1</code>的<code>SSHD</code>服务</p><p>A1：首先肯定是在允许表中定义的。因为不需要做NAT地址转换之类的，然后查看我们<code>SSHD</code>服务，在22号端口上，处理机制是接受，对于这个表，需要有一来一回两个规则，如果我们允许也好，拒绝也好，对于访问本机服务，我们最好是定义在INPUT链上，而OUTPUT再予以定义就好。(会话的初始端先定义)，所以加规则就是：</p><p>定义进来的： <code>iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.1 -p tcp --dport 22 -j ACCEPT</code></p><p>定义出去的： <code>iptables -t filter -A OUTPUT -s 172.16.100.1 -d 172.16.0.0/16 -p tcp --dport 22 -j ACCEPT</code></p><p>将默认策略改成DROP:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-P</span> INPUT DROPiptables <span class="token parameter variable">-P</span> OUTPUT DROPiptables <span class="token parameter variable">-P</span> FORWARD DROP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="状态检测："><a href="#状态检测：" class="headerlink" title="状态检测："></a>状态检测：</h1><p>什么是状态检测？对于整个TCP协议来讲，它是一个有连接的协议，三次握手中，第一次握手，我们就叫NEW连接，而从第二次握手以后的，ack都为1，这是正常的数据传输，和tcp的第二次第三次握手，叫做已建立的连接（<code>ESTABLISHED</code>）,还有一种状态，比较诡异的，比如：<code>SYN=1 ACK=1 RST=1</code>,对于这种我们无法识别的，我们都称之为<code>INVALID</code>无法识别的。还有第四种，FTP这种古老的拥有的特征，每个端口都是独立的，21号和20号端口都是一去一回，他们之间是有关系的，这种关系我们称之为<code>RELATED</code>。</p><p>所以我们的状态一共有四种：</p><p><code>NEW</code></p><p><code>ESTABLISHED</code></p><p><code>RELATED</code></p><p><code>INVALID</code></p><p>所以我们对于刚才的QA1，可以增加状态检测。比如进来的只允许状态为<code>NEW</code>和<code>ESTABLISHED</code>的进来，出去只允许<code>ESTABLISHED</code>的状态出去，这就可以将比较常见的反弹式木马有很好的控制机制。</p><p>对于QA1的扩展：</p><p>进来的拒绝出去的允许，进来的只允许ESTABLISHED进来，出去只允许ESTABLISHED出去。默认规则都使用拒绝</p><p><code>iptables -L -n --line-number</code>：查看之前的规则位于第几行</p><p>改写INPUT</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-R</span> INPUT <span class="token number">2</span> <span class="token parameter variable">-s</span> <span class="token number">172.16</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">172.16</span>.100.1 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">22</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPTiptables <span class="token parameter variable">-R</span> OUTPUT <span class="token number">1</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>此时如果想再放行一个80端口如何放行呢？</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-d</span> <span class="token number">172.16</span>.100.1 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPTiptables <span class="token parameter variable">-R</span> INPUT <span class="token number">1</span> <span class="token parameter variable">-d</span> <span class="token number">172.16</span>.100.1 <span class="token parameter variable">-p</span> udp <span class="token parameter variable">--dport</span> <span class="token number">53</span> <span class="token parameter variable">-j</span> ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Q2：假如我们允许自己ping别人，但是别人ping自己ping不通如何实现呢？</p><p>A2：对于ping这个协议，进来的为<code>8</code>（ping），出去的为<code>0</code>(响应).我们为了达到目的，需要8出去,允许<code>0</code>进来</p><p>在出去的端口上：<code>iptables -A OUTPUT -p icmp --icmp-type 8 -j ACCEPT</code></p><p>在进来的端口上：<code>iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT</code></p><p>小扩展：对于<code>127.0.0.1</code>比较特殊，我们需要明确定义它</p><p><code>iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</code></p><p><code>iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</code></p><h1 id="SNAT和DNAT的实现"><a href="#SNAT和DNAT的实现" class="headerlink" title="SNAT和DNAT的实现"></a>SNAT和DNAT的实现</h1><p>由于我们现在IP地址十分紧俏，已经分配完了，这就导致我们必须要进行地址转换，来节约我们仅剩的一点IP资源。那么通过iptables如何实现NAT的地址转换呢？</p><h2 id="SNAT基于原地址的转换"><a href="#SNAT基于原地址的转换" class="headerlink" title="SNAT基于原地址的转换"></a>SNAT基于原地址的转换</h2><p>基于原地址的转换一般用在我们的许多内网用户通过一个外网的口上网的时候，这时我们将我们内网的地址转换为一个外网的IP，我们就可以实现连接其他外网IP的功能。</p><p>所以我们在iptables中就要定义到底如何转换：</p><p>定义的样式：</p><p>比如我们现在要将所有<code>192.168.10.0</code>网段的IP在经过的时候全都转换成<code>172.16.100.1</code>这个假设出来的外网地址：</p><p><code>iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.1</code></p><p>这样，只要是来自本地网络的试图通过网卡访问网络的，都会被统统转换成172.16.100.1这个IP，那么，如果<code>172.16.100.1</code>不是固定的怎么办？</p><p>我们都知道当我们使用联通或者电信上网的时候，一般它都会在每次你开机的时候随机生成一个外网的IP，意思就是外网地址是动态变换的。这时我们就要将外网地址换成 MASQUERADE(动态伪装):它可以实现自动寻找到外网地址，而自动将其改为正确的外网地址。所以，我们就需要这样设置：</p><p><code>iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j MASQUERADE</code></p><p>这里要注意：地址伪装并不适用于所有的地方。</p><h2 id="DNAT目标地址转换"><a href="#DNAT目标地址转换" class="headerlink" title="DNAT目标地址转换"></a>DNAT目标地址转换</h2><p>对于目标地址转换，数据流向是从外向内的，外面的是客户端，里面的是服务器端通过目标地址转换，我们可以让外面的ip通过我们对外的外网ip来访问我们服务器不同的服务器，而我们的服务却放在内网服务器的不同的服务器上。</p><p>如何做目标地址转换呢？：</p><p><code>iptables -t nat -A PREROUTING -d 192.168.10.18 -p tcp --dport 80 -j DNAT --todestination 172.16.100.2</code></p><p>目标地址转换要做在到达网卡之前进行转换,所以要做在PREROUTING这个位置上</p><h1 id="控制规则的存放以及开启"><a href="#控制规则的存放以及开启" class="headerlink" title="控制规则的存放以及开启"></a>控制规则的存放以及开启</h1><p>注意：你所定义的所有内容，当你重启的时候都会失效，要想我们能够生效，需要使用一个命令将它保存起来</p><ol><li><code>service iptables save</code>命令</li></ol><p>它会保存在<code>/etc/sysconfig/iptables</code>这个文件中</p><ol start="2"><li><code>iptables-save</code>命令</li></ol><p><code>iptables-save &gt; /etc/sysconfig/iptables</code></p><ol start="3"><li><code>iptables-restore</code>命令</li></ol><p>开机的时候，它会自动加载<code>/etc/sysconfig/iptabels</code></p><p>如果开机不能加载或者没有加载，而你想让一个自己写的配置文件（假设为iptables.2）手动生效的话：</p><p><code>iptables-restore &lt; /etc/sysconfig/iptables.2</code></p><p>则完成了将iptables中定义的规则手动生效</p><hr><h1 id="防火墙firewall的基本概述"><a href="#防火墙firewall的基本概述" class="headerlink" title="防火墙firewall的基本概述"></a>防火墙firewall的基本概述</h1><p>现在的RedHat/CentOS7版本默认都使用firewall防火墙了，firewall的配方法大致可以分为图形化和命令行。firewalld跟iptables比起来，不好的地方是每个服务都需要去设置才能放行，因为默认是拒绝。而iptables里默认是每个服务是允许，需要拒绝的才去限制。</p><p>firewalld自身并不具备防火墙的功能，而是和iptables一样需要通过内核的netfilter来实现，也就是说firewalld和 iptables一样，他们的作用都是用于维护规则，而真正使用规则干活的是内核的netfilter，只不过firewalld和iptables的结构以及使用方法不一样罢了。</p><h1 id="防火墙使用区域管理"><a href="#防火墙使用区域管理" class="headerlink" title="防火墙使用区域管理"></a>防火墙使用区域管理</h1><p><img src="/medias/img/others/2.jpg"></p><pre class="line-numbers language-none"><code class="language-none">阻塞区域（block）：任何传入的网络数据包都将被阻止。工作区域（work）：相信网络上的其他计算机，不会损害你的计算机。家庭区域（home）：相信网络上的其他计算机，不会损害你的计算机。公共区域（public）：不相信网络上的任何计算机，只有选择接受传入的网络连接。隔离区域（DMZ）：隔离区域也称为非军事区域，内外网络之间增加的一层网络，起到缓冲作用。对于隔离区域，只有选择接受传入的网络连接。信任区域（trusted）：所有的网络连接都可以接受。丢弃区域（drop）：任何传入的网络连接都被拒绝。内部区域（internal）：信任网络上的其他计算机，不会损害你的计算机。只有选择接受传入的网络连接。外部区域（external）：不相信网络上的其他计算机，不会损害你的计算机。只有选择接受传入的网络连接。注：FirewallD的默认区域是public。firewalld默认提供了九个zone配置文件：block.xml、dmz.xml、drop.xml、external.xml、 home.xml、internal.xml、public.xml、trusted.xml、work.xml，他们都保存在&quot;&#x2F;usr&#x2F;lib &#x2F;firewalld&#x2F;zones&#x2F;&quot;目录下。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/others/3.jpg"></p><h1 id="防火墙基本指令参数"><a href="#防火墙基本指令参数" class="headerlink" title="防火墙基本指令参数"></a>防火墙基本指令参数</h1><p><code>firewall-cmd</code> #是命令行配置</p><p><code>firewall-config</code> #是图形化配置 默认中文不支持福规则的动作设置需要<code>LANG=C</code>转一下英文ASCII环境</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall <span class="token parameter variable">-cmd</span><span class="token comment"># 域zone相关的命令</span>--get-default-zone  查询默认的区域名称--set-default-zone<span class="token operator">=</span><span class="token operator">&lt;</span>区域名称<span class="token operator">></span>   设置默认的区域--get-active-zones  显示当前正在使用的区域与网卡名称--get-zones 显示总共可用的区域--new-zone<span class="token operator">=</span> 新增区域<span class="token comment"># services管理的命令</span>--get-services  显示预先定义的服务--add-service<span class="token operator">=</span><span class="token operator">&lt;</span>服务名<span class="token operator">></span> 设置默认区域允许该服务的流量--remove-service<span class="token operator">=</span><span class="token operator">&lt;</span>服务名<span class="token operator">></span>  设置默认区域不再允许该服务的流量<span class="token comment"># Port相关命令</span>--add-port<span class="token operator">=</span><span class="token operator">&lt;</span>端口号/协议<span class="token operator">></span> 设置默认区域允许该端口的流量--remove-port<span class="token operator">=</span><span class="token operator">&lt;</span>端口号/协议<span class="token operator">></span>  设置默认区域不再允许该端口的流量<span class="token comment"># 网卡相关的命令</span>--add-interface<span class="token operator">=</span><span class="token operator">&lt;</span>网卡名称<span class="token operator">></span>  将源自该网卡的所有流量都导向某个指定区域--change-interface<span class="token operator">=</span><span class="token operator">&lt;</span>网卡名称<span class="token operator">></span>   将某个网卡与区域进行关联<span class="token comment"># 查看所有规则的命令</span>--list-all  显示当前区域的网卡配置参数、资源、端口以及服务等信息加上--permanent 查看永久生效的配置参数、资源、端口以及服务等信息<span class="token comment"># 重载防火墙的策略</span><span class="token parameter variable">--reload</span>    让“永久生效”的配置规则立即生效，并覆盖当前的配置规则<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙区域配置策略"><a href="#防火墙区域配置策略" class="headerlink" title="防火墙区域配置策略"></a>防火墙区域配置策略</h1><p><img src="/medias/img/others/4.jpg"></p><p>开始之前确认防火墙是开启的状态</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zone区域相关指令</span>//查看当前默认区域<span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --get-default-zone </span>public//查看当前活跃的区域<span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --get-active-zone</span>publicinterfaces: eth0 eth1 //将当前默认区域修改为dropfirewall-cmd --set-default-zone<span class="token operator">=</span>drop//将网络接口关联至drop区域firewall-cmd <span class="token parameter variable">--permanent</span>  --change-interface<span class="token operator">=</span>eth0 <span class="token parameter variable">--zone</span><span class="token operator">=</span>drop//将192.168.122.0/24网段加入trusted白名单firewall-cmd <span class="token parameter variable">--permanent</span> --add-source<span class="token operator">=</span><span class="token number">192.168</span>.122.0/24 <span class="token parameter variable">--zone</span><span class="token operator">=</span>trusted//重载防火墙firewall-cmd <span class="token parameter variable">--reload</span>success//查看当前处于活动的区域firewall-cmd --get-active-zonesdrop    <span class="token comment"># 默认区域, eth0接口流量都由drop区域过滤</span>interfaces: eth0trusted <span class="token comment"># 数据包的源IP是192.168.122.0/24网段走trusted区域</span>sources: <span class="token number">192.168</span>.122.0/24<span class="token comment"># 使用firewalld中各个区域的应用</span>//允许10.0.0.1IP地址能访问sshfirewall-cmd --add-source<span class="token operator">=</span><span class="token number">10.0</span>.0.0/24 <span class="token parameter variable">--permanent</span> <span class="token parameter variable">--zone</span><span class="token operator">=</span>public <span class="token comment">#默认zone在public</span>firewall-cmd <span class="token parameter variable">--reload</span>//将192.168.20.0网段加入白名单firewall-cmd --add-source<span class="token operator">=</span><span class="token number">192.168</span>.20.0/24 <span class="token parameter variable">--permanent</span> <span class="token parameter variable">--zone</span><span class="token operator">=</span>trustedfirewall-cmd <span class="token parameter variable">--reload</span>//查看设置项firewall-cmd --get-active-zonedropinterfaces: eth0 eth1publicsources: <span class="token number">10.0</span>.0.1/32trustedsources: <span class="token number">192.168</span>.20.0/24<span class="token comment"># 查询firewald指定区域的明细</span>firewall-cmd  --list-all <span class="token parameter variable">--zone</span><span class="token operator">=</span>drop <span class="token comment">#指明要查的zone 加上--permanent查看永久生效的区域的明细</span>drop <span class="token punctuation">(</span>active<span class="token punctuation">)</span>target: DROPicmp-block-inversion: nointerfaces: eth0 eth1sources:services:ports:protocols:masquerade: noforward-ports:source-ports:icmp-blocks:rich rules:<span class="token comment"># 查询public区域是否允许请求SSH协议的流量 #对应服务对应状态</span>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --query-service<span class="token operator">=</span>ssh<span class="token function">yes</span><span class="token comment"># 恢复默认规则操作</span>firewall-cmd --set-default-zone<span class="token operator">=</span>publicfirewall-cmd --remove-source<span class="token operator">=</span><span class="token number">192.168</span>.1.0/24 <span class="token parameter variable">--zone</span><span class="token operator">=</span>public <span class="token parameter variable">--permanent</span>firewall-cmd --remove-source<span class="token operator">=</span><span class="token number">192.168</span>.1.0/24 <span class="token parameter variable">--zone</span><span class="token operator">=</span>trusted <span class="token parameter variable">--permanent</span>firewall-cmd <span class="token parameter variable">--reload</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙端口访问策略"><a href="#防火墙端口访问策略" class="headerlink" title="防火墙端口访问策略"></a>防火墙端口访问策略</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开放80端口</span>firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">80</span>/udp --add-port<span class="token operator">=</span><span class="token number">80</span>/tcpfirewall-cmd <span class="token parameter variable">--reload</span> <span class="token comment">#重载配置生效</span>firewall-cmd --list-ports <span class="token comment">#检查开放的端口</span><span class="token comment"># 配置防火墙, 访问80udp的端口流量设置为永久拒绝，并立即生效</span>firewall-cmd <span class="token parameter variable">--permanent</span> --remove-port<span class="token operator">=</span><span class="token number">80</span>/udpfirewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --list-ports <span class="token comment">#重载并查看</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙服务访问策略"><a href="#防火墙服务访问策略" class="headerlink" title="防火墙服务访问策略"></a>防火墙服务访问策略</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开放httpd服务</span>firewall-cmd <span class="token parameter variable">--permanent</span> --add-service<span class="token operator">=</span>http --add-service<span class="token operator">=</span>httpsfirewall-cmd <span class="token parameter variable">--reload</span> <span class="token punctuation">;</span> firewall-cmd --list-services <span class="token comment"># 重载生效并查看</span><span class="token comment"># 配置防火墙, 请求https协议的流量设置为永久拒绝，并立即生效</span>firewall-cmd <span class="token parameter variable">--permanent</span> --remove-service<span class="token operator">=</span>https firewall-cmd <span class="token parameter variable">--reload</span> <span class="token punctuation">;</span> firewall-cmd --list-services <span class="token comment"># 重载生效并查看</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙端口转发策略"><a href="#防火墙端口转发策略" class="headerlink" title="防火墙端口转发策略"></a>防火墙端口转发策略</h1><p>端口转发需要用到<code>forward-port</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">转发本机80/tcp端口的流量至8080/tcp端口，要求当前和长期有效firewall-cmd <span class="token parameter variable">--permanent</span> <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-forward-port<span class="token operator">=</span>port<span class="token operator">=</span><span class="token number">80</span>:proto<span class="token operator">=</span>tcp:to <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">8080</span>:toaddr<span class="token operator">=</span><span class="token number">10.0</span>.0.61移除转发firewall-cmd --remove-forward-port<span class="token operator">=</span>port<span class="token operator">=</span><span class="token number">80</span>:proto<span class="token operator">=</span>tcp:toport<span class="token operator">=</span><span class="token number">8080</span>:toaddr<span class="token operator">=</span><span class="token number">10.0</span>.0.61开启IP伪装firewall-cmd --add-masquerade <span class="token parameter variable">--permanent</span> <span class="token comment">#IP地址转换</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙富规则策略"><a href="#防火墙富规则策略" class="headerlink" title="防火墙富规则策略"></a>防火墙富规则策略</h1><p>到重点了，这里上面的条目富规则都可实现</p><p>具体配置案例查询<code>firewalld.richlanguage</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//区里的富规则按先后顺序匹配，按先匹配到的规则生效。<span class="token comment">#firewall-cmd ↓</span>--add-rich-rule<span class="token operator">=</span><span class="token string">'&lt;RULE>'</span>    //在指定的区添加一条富规则--remove-rich-rule<span class="token operator">=</span><span class="token string">'&lt;RULE>'</span> //在指定的区删除一条富规则--query-rich-rule<span class="token operator">=</span><span class="token string">'&lt;RULE>'</span>  //找到规则返回0 ，找不到返回1--list-rich-rules       //列出指定区里的所有富规则--list-all 和 --list-all-zones 也能列出存在的富规则//在192.168.0.0/24这个段里可以访问tftp服务rule <span class="token assign-left variable">family</span><span class="token operator">=</span><span class="token string">"ipv4"</span> <span class="token builtin class-name">source</span> <span class="token assign-left variable">address</span><span class="token operator">=</span><span class="token string">"192.168.0.0/24"</span> <span class="token function">service</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tftp"</span> log <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"tftp"</span> accept//来自192.168.0.0/24这个段的8080端口数据转发到本地的80端口rule <span class="token assign-left variable">family</span><span class="token operator">=</span><span class="token string">"ipv4"</span> <span class="token builtin class-name">source</span> <span class="token assign-left variable">address</span><span class="token operator">=</span><span class="token string">"192.168.0.0/24"</span> forward-port to-addr<span class="token operator">=</span><span class="token string">"local"</span> to-port<span class="token operator">=</span><span class="token string">"8080"</span> <span class="token assign-left variable">protocol</span><span class="token operator">=</span><span class="token string">"tcp"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"80"</span>//拒绝192.168.2.4这个ip访问rule <span class="token assign-left variable">family</span><span class="token operator">=</span><span class="token string">"ipv4"</span> <span class="token builtin class-name">source</span> <span class="token assign-left variable">address</span><span class="token operator">=</span><span class="token string">"192.168.2.4"</span> drop<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="防火墙开启内部上网"><a href="#防火墙开启内部上网" class="headerlink" title="防火墙开启内部上网"></a>防火墙开启内部上网</h1><p>firewalld防火墙开启ip伪装</p><ol><li>网卡默认是在public的zones内，也是默认zones。永久添加源地址转换功能</li></ol><p><code>firewall-cmd --add-masquerade --permanent</code></p><p><code>firewall-cmd --reload</code></p><ol start="2"><li>共享上网</li></ol><p>开启的ip转发后，相当了一台本地的nat服务器。</p><p>将client的网关指向你配置的ip转发服务器的IP。</p><p>只要你的ip转发服务器可以正常解析公网IP(dns可解析公网地址)。</p><p>Clent服务器就可以借助IP转发服务器实现上网（前提是中间路由可达）。</p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/iptables">iptables防火墙软件</a><br><a href="../linux-command-1.16.0/firewall-cmd">firewall-cmd管理工具</a><br><a href="../linux-command-1.16.0/ip6tables-restore">ip6tables-restore还原ip6table表</a><br><a href="../linux-command-1.16.0/ip6tables-save">ip6tables-save保存ip6table表</a><br><a href="../linux-command-1.16.0/ip6tables">ip6tables防火墙软件IPv6</a><br><a href="../linux-command-1.16.0/iptables-restore">iptables-restore还原iptables表</a><br><a href="../linux-command-1.16.0/iptables-save">iptables-save保存iptables表</a><br><a href="../linux-command-1.16.0/iptstate">iptstate查看防火墙状态</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iptables </tag>
            
            <tag> firewall </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS域名解析</title>
      <link href="/posts/f59edf24.html"/>
      <url>/posts/f59edf24.html</url>
      
        <content type="html"><![CDATA[<h1 id="DNS域名解析服务"><a href="#DNS域名解析服务" class="headerlink" title="DNS域名解析服务"></a>DNS域名解析服务</h1><h2 id="了解域名"><a href="#了解域名" class="headerlink" title="了解域名"></a>了解域名</h2><p>IP地址是Internet主机的作为路由寻址用的数字型标识，人不容易记忆。因而产生了域名，这一字符型标识。</p><p>域名，是由一串用”点”分割的字符组成的Internet上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位。域名的目的是便于记忆和沟通的一组服务器的地址（网站，电子邮件，FTP等）。</p><p>域名组成：</p><p>顶级域：</p><p>组织域：<code>.com</code> <code>.net</code> <code>.org</code> <code>.edu</code></p><p>国家域：<code>.cn</code> <code>.jp</code> <code>.iq</code></p><p>二级域：就是个人申请的域名</p><p>三级域或主机名：自己添加的三级域名或标识此主机的主机名</p><p>DNS的命名方式：主机名.二级域名.顶级域名.</p><p>例如：<code>www.baidu.com.</code></p><p><code>www.baidu.com</code>：被称为：<code>FQDN</code>（完全合格域名）</p><h2 id="客户端访问站点的步骤："><a href="#客户端访问站点的步骤：" class="headerlink" title="客户端访问站点的步骤："></a>客户端访问站点的步骤：</h2><p>客户机先访问本地的hosts文件（<code>/etc/hosts</code>）,如果没有，则访问本地的缓存，缓存再没有，就去网络中DNS服务器，然后DNS服务器返回结果以后，客户机拿到结果以后，首先将结果在自己的缓存中保存，然后在进行真正的访问。这里缓存起到了加速的作用。</p><p>在DNS整个查询解析过程中，其实分为两段，一段是用户指向的DNS服务器，第二阶段是指定的DNS服务器在网络上分布式查找的过程。这种对于用户来说，找自己指定的DNS服务器的查询方式就叫做递归查询。</p><p>DNS查询类型：</p><p><code>递归查询</code>：第一段都是递归查询</p><p><code>迭代查询</code>：第二段就是迭代查询（迭代也不是绝对的，只是大多数是迭代的）</p><h1 id="DNS系统的作用"><a href="#DNS系统的作用" class="headerlink" title="DNS系统的作用"></a>DNS系统的作用</h1><p>整个Internet大家庭中，连接了数以亿计的服务器，个人主机，其中大部分的网站、邮件等服务器都使用了域名形式的地址，例如：<code>www.google.com</code>、<code>mail.163.com</code>等，很显然这种地址形式要比使用<code>64.233.189.147</code>、<code>202.108.33.74</code>的IP地址形式更加直观，而且更容易被用户记住。</p><p>DNS系统在网络中的作用就是维护着一个”地址数据库”，其中记录了各种主机域名与ip地址的对应关系，以便为客户程序提供正式或反向的地址查询服务，即正向解析与反向解析。</p><p>正向解析：根据域名查ip地址，即将指定的域名解析为相对应的ip地址，域名的正向解析是DNS服务器最基本的功能，也是最常用的功能。</p><p>反向解析：根据ip地址查询域名，即将指定的ip地址解析为相对应的域名，域名的反向解析不是很常用，只在一些特殊场合才会用到，如可用于反垃圾邮件的验证。</p><p>每一台DNS服务器都只负责管理一个有限范围（一个或几个域）内的主机域名和ip地址的对应关系，这些特定的DNS域或ip地址段称为<code>zone</code>(区域)。</p><p>根据地址解析的方向不同，DNS区域响应地分为正向区域（包含域名到ip地址的解析记录）和反向区域（包含IP地址到域名的解析记录）。</p><p>根据所管理的区域地址数据的来源不同，DNS系统可分为不同的类型</p><p>常见的DNS类型如下：</p><p>缓存域名服务器：只提供域名解析结构的缓存功能，目地在于提高查询速度和效率，但是没有自己控制的区域地址数据，构建缓存域名服务器时，必须设置根域或指定其他DNS服务器作为解析来源。</p><p>主域名服务器：维护某一个特定DNS区域的地址数据库，对其中的解析记录具有主控制权，是指定区域中唯一存在的权威服务器、官方服务器。构建主域名服务器时，需要自行建立所负责的地址数据文件。</p><p>从域名服务器：与主域名服务器提供完全相同的DNS解析服务，通常用于DNS服务器的热备份，对客户机来说，无论使用主域名服务器还是从域名服务器，查询结果都是一样的。</p><p>以上所述主、从服务器的角色只是针对某一个特定的DNS区域来说的，例如，同一台DNS服务器，可以是<code>exp.com</code>区域的主域名服务器，同时也可以是<code>itwangluo.com</code>区域的从域名服务器。</p><h1 id="BIND的安装、配置"><a href="#BIND的安装、配置" class="headerlink" title="BIND的安装、配置"></a>BIND的安装、配置</h1><p>BIND不是唯一能够提供域名服务的DNS服务程序，但它却是应用最为广泛的，BIND可以运行在大多数Linux/Unix主机中，其官方站点位于<code>https://www.isc.org/</code></p><p>安装BIND软件系统光盘自带了BIND服务的安装文件，主要包括以下几个软件包：</p><p><code>bind-9.8.2-0.62.rc1.el6.x86_64</code></p><p><code>bind-utils-9.8.2-0.62.rc1.el6.x86_64</code></p><p><code>bind-libs-9.8.2-0.62.rc1.el6.x86_64</code></p><p><code>bind-chroot-9.8.2-0.62.rc1.el6.x86_64</code></p><p>各软件包的作用如下：</p><p><code>bind</code>：提供了域名服务的主要程序及相关文件</p><p><code>bind-utils</code>：提供了对<code>DNS</code>服务器的测试工具程序，如<code>nslookup</code>等</p><p><code>bind-libs</code>：提供了<code>bind</code>、<code>bind-utils</code>需要使用的库函数</p><p><code>bind-chroot</code>：为<code>BIND</code>服务提供一个伪装的根目录（将<code>/var/named/chroot/</code>文件夹作为<code>BIND</code>的根目录），以提供高安全性。</p><p><code>BIND</code>安装以后，会自动增加一个名为<code>named</code>的系统服务。</p><h1 id="DNS服务器的类型（缓存服务器、主服务器、从服务器、分离解析服务器）"><a href="#DNS服务器的类型（缓存服务器、主服务器、从服务器、分离解析服务器）" class="headerlink" title="DNS服务器的类型（缓存服务器、主服务器、从服务器、分离解析服务器）"></a>DNS服务器的类型（缓存服务器、主服务器、从服务器、分离解析服务器）</h1><p>配置文件<code>/etc/named.conf</code></p><h2 id="缓存服务器配置"><a href="#缓存服务器配置" class="headerlink" title="缓存服务器配置"></a>缓存服务器配置</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/named.confoptions <span class="token punctuation">&#123;</span>  listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.5<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment"># 监听的地址和端口，也可以不指定 某一个，填写"any"表示监听所有接口的UDP 53端口。</span>  directory <span class="token string">"/var/named"</span><span class="token punctuation">;</span>  <span class="token comment"># 区域数据文件的默认存放位置。</span>  dump-file <span class="token string">"/var/named/data/cacke_dump.db"</span><span class="token punctuation">;</span>  <span class="token comment"># 设置域名缓存数 据库文件位置。</span>  memstatistics-file <span class="token string">"/var/named/data/named_mem_stats.txt"</span><span class="token punctuation">;</span>  <span class="token comment"># DNS 服务器输出的内存使用统计文件</span>  query-source port <span class="token number">53</span><span class="token punctuation">;</span>  <span class="token comment"># 指定客户端在提交DNS查询必须使用的 源端口</span>  allow-query <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.0/24<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment"># 为哪些客户端提供解析服务， 可指定一些，也可以写"any"表示所有的客户端。</span>  recursion <span class="token function">yes</span><span class="token punctuation">;</span>  <span class="token comment"># 定义递归式DNS，若不启用递归改为no</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>zone <span class="token string">"."</span> IN <span class="token punctuation">&#123;</span>   <span class="token comment"># 正向"."根区域</span>  <span class="token builtin class-name">type</span> hint<span class="token punctuation">;</span>   <span class="token comment"># 类型为根区域</span>  <span class="token function">file</span> <span class="token string">"named.ca"</span><span class="token punctuation">;</span>   <span class="token comment"># 区域数据文件命名为named.ca</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有时候为了提高解析效率，也可以不向根域查询，而是将来自客户端的查询请求转发给国内电信运营商的DNS服务器（如北京的<code>202.106.0.20/202.106.148.1</code>），缓存服务器收到返回的查询结果后再传递给客户端，只要去掉<code>zone &quot;.&quot; IN &#123;……&#125;; </code>的设置，并在全局配置中正确设置<code>forwarders</code>参数即可实现该功能</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">vim &#x2F;etc&#x2F;named.confoptions &#123;# …… 省略部分内容forwarders &#123; 202.106.0.20; 202.106.148.1; &#125;;&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>确认根域的区域数据文件<code>named.ca</code></li></ol><p>根区域的区域数据文件默认位于文件<code>/var/named/named.ca</code>中，该文件记录了Internet中全球13台根域服务器的域名和ip地址等相关信息，要保证这个文件有读取的权限，如果没有此文件，可以从网上下载然后偶重命名成和配置文件中file后一样的名字即可。</p><p>用<code>named-checkzone</code>工具检查语法</p><p>格式：<code>named-checkzone . named-ca</code></p><ol start="3"><li>启动named服务</li></ol><p><code>service named start</code> 启动named服务</p><p><code>netstat -unpl</code> 通过netstat命令查看监听的UDP的53号端口是否开启</p><ol start="4"><li>验证缓存域名服务器</li></ol><p>在局域网内的客户机中，将首选DNS服务器的地址设置为<code>192.168.0.5</code>，生效后，执行<code>nslookup www.baidu.com</code>命令对其进行解析，验证其是否能够获得该域名对应的ip地址信息。</p><p>一下操作在客户机中：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/resolv.confnameserver <span class="token number">192.168</span>.0.5  <span class="token comment"># 添加DNS服务器地址</span><span class="token function">nslookup</span> www.baidu.com  <span class="token comment"># 验证</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>模拟排查错误</li></ol><p>在<code>/etc/named.conf</code>文件中随便修改一处，制造错误，然后启动，报错后，去查看<code>/var/log/message</code>日志文件</p><p>练习：</p><ol><li>编辑<code>named.conf</code></li></ol><p><img src="/medias/img/dns/0.png"></p><ol start="2"><li>编辑<code>resolv.conf</code></li></ol><p><img src="/medias/img/dns/1.png"></p><ol start="3"><li>使用<code>nslookup</code>验证</li></ol><p><img src="/medias/img/dns/2.png"></p><p><img src="/medias/img/dns/3.png"></p><h2 id="主服务器的配置"><a href="#主服务器的配置" class="headerlink" title="主服务器的配置"></a>主服务器的配置</h2><h3 id="确认本机的网络地址、主机映射、默认DNS服务器地址"><a href="#确认本机的网络地址、主机映射、默认DNS服务器地址" class="headerlink" title="确认本机的网络地址、主机映射、默认DNS服务器地址"></a>确认本机的网络地址、主机映射、默认DNS服务器地址</h3><p>将主域名服务器的ip地址设为<code>192.168.0.123</code>，主机名设为<code>www.exp.com</code>，通过修改网络配置文件的方式进行，具体操作过程略。另外，为了提高域名解析效率，建议两台DNS服务器的地址映射直接写入到<code>/etc/hosts</code>文件中，并在<code>/etc/resolv.conf</code>文件中指定两个DNS服务器的地址。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/hosts<span class="token number">192.168</span>.0.123 www.exp.com<span class="token number">192.168</span>.0.33 wap.exp.com<span class="token function">vim</span> /etc/resolv.confnameserver <span class="token number">192.168</span>.0.123nameserver <span class="token number">192.168</span>.0.33<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="建立主配置文件named-conf"><a href="#建立主配置文件named-conf" class="headerlink" title="建立主配置文件named.conf"></a>建立主配置文件<code>named.conf</code></h3><p>新建的<code>named.conf</code>主配置文件，由于只需要提供<code>exp.com</code>域的正向解析和<code>192.168.0.0/24</code>网段的反向解析，因此相应地添加这两个区域即可，根区域，会环宇等其他配置内容可以省略。</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">vim &#x2F;etc&#x2F;named.confoptions &#123;  listen-on port 53 &#123; any ;&#125;;   # 也可写成192.168.0.123  directory &quot;&#x2F;var&#x2F;named&quot;;  allow-query &#123; 192.168.0.0&#x2F;24; &#125;; 也可以写&quot;any&quot; &#125;;zone &quot;exp.com&quot; IN &#123;  type master;   # 类型为主区域  file &quot;exp.com.zone&quot;;   # 区域数据文件为exp.com.zone  allow-transfer &#123; 192.168.0.33; &#125;;   # 允许从服务器下载正向区域数据 &#125;;zone &quot;0.168.192.in-addr.arpa&quot; IN &#123;  type master;  file &quot;192.168.0.arpa&quot;;   # 区域数据文件为192.168.0.arpa  allow-transfer &#123; 192.168.0.33; &#125;;   # 允许从服务器下载反向区域数据 &#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当不需要建立从域名服务器时，上述配置内容中的<code>allow-transfer……</code>部分可以不添加，当不需要提供反向解析时，<code>zone &quot;0.168.192.in-addr.arpa&quot;……</code>部分也可以去掉。</p><p>对配置文件进行语法检查用<code>named-checkconf</code>命令。</p><h3 id="建立正、反向区域数据文件"><a href="#建立正、反向区域数据文件" class="headerlink" title="建立正、反向区域数据文件"></a>建立正、反向区域数据文件</h3><p>根据<code>named.conf</code>中的zone区域设置，分别建立正向区域数据文件<code>exp.com.zone</code>、反向区域数据文件<code>192.168.0.arpa</code>，并且修改两个文件的属组为<code>named</code>，配置内容可以参考区域数据文件<code>/var/named/named.localhost</code>。（建立完区域数据文件后要语法检查）。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /var/named/<span class="token function">vim</span> exp.com.zone   <span class="token comment"># 打开文件进行修改（正向文件）</span><span class="token variable">$TTL</span> <span class="token number">86400</span>@ SOA exp.com. admin.exp.com. <span class="token punctuation">(</span>  <span class="token number">2017110822</span>  4H  30M  12H  1D <span class="token punctuation">)</span>@ IN NS www.exp.com.  IN NS wap.exp.com.  IN MX <span class="token number">10</span> mail.exp.com.www IN A <span class="token number">192.168</span>.0.123wap IN A <span class="token number">192.168</span>.0.33mail IN A <span class="token number">192.168</span>.0.35* IN A <span class="token number">192.168</span>.0.123<span class="token function">vim</span> <span class="token number">192.168</span>.0.arpa   <span class="token comment"># 打开文件进行修改</span><span class="token variable">$TTL</span> <span class="token number">86400</span>@ SOA exp.com. admin.exp.com. <span class="token punctuation">(</span>  <span class="token number">2017110823</span>  4H  30M  12H  1D <span class="token punctuation">)</span>  IN NS www.exp.com.  IN NS wap.exp.com.<span class="token number">123</span> IN PTR www.exp.com.<span class="token number">35</span> IN PTR mail.exp.com.<span class="token number">33</span> IN PTR wap.exp.com.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动named服务或重载配置"><a href="#启动named服务或重载配置" class="headerlink" title="启动named服务或重载配置"></a>启动named服务或重载配置</h3><p><code>service named reload/restart</code></p><h3 id="验证主域名服务器"><a href="#验证主域名服务器" class="headerlink" title="验证主域名服务器"></a>验证主域名服务器</h3><p>在客户端将DNS服务器指向<code>192.168.0.123</code>（主域名服务器的IP地址）</p><p>使用<code>nslookup</code>命令验证DNS查询结果</p><p>例如，在Linux客户机中验证，把<code>/etc/resolv.conf</code>文件中的首选DNS改为<code>192.168.0.123</code>就可以验证了</p><p><code>nslookup wap.exp.com</code> 验证正向解析</p><p>server: 192.168.0.123</p><p>Address:</p><p><code>nslookup x.exp.com</code> 验证泛域名解析</p><p>server: 192.168.0.123</p><p>Address:</p><p><code>nslookup 192.168.0.35</code> 验证反向解析</p><p>练习：</p><ol><li>编辑<code>named.conf</code>在缓存服务器的基础上添加：</li></ol><p><img src="/medias/img/dns/4.png"></p><ol start="2"><li><code>cd /var/named/</code></li></ol><ol><li>编辑<code>exp.com.zone</code>（正向解析文件）</li></ol><p><img src="/medias/img/dns/6.png"></p><ol start="2"><li>编辑<code>192.168.0.arpa</code>（反向解析文件）</li></ol><p><img src="/medias/img/dns/5.png"></p><ol start="3"><li>验证：<code>nslookup wap.exp.com</code></li></ol><p><img src="/medias/img/dns/7.png"></p><p><code>nslookup x.exp.com</code></p><p><img src="/medias/img/dns/8.png"></p><p><code>nalookup 192.168.0.35</code></p><p><img src="/medias/img/dns/9.png"></p><h2 id="从服务器配置"><a href="#从服务器配置" class="headerlink" title="从服务器配置"></a>从服务器配置</h2><h3 id="确认本机的网络地址、主机映射、默认DNS服务器地址-1"><a href="#确认本机的网络地址、主机映射、默认DNS服务器地址-1" class="headerlink" title="确认本机的网络地址、主机映射、默认DNS服务器地址"></a>确认本机的网络地址、主机映射、默认DNS服务器地址</h3><p>将从域名服务器的ip地址设为<code>192.168.0.10</code>，主机名设为<code>wap.exp.com</code>，通过修改网络配置文件的方式进行，具体操作过程略，另外主机映射文件<code>/etc/hosts</code>和<code>DNS</code>解析文件<code>/etc/resolv.conf</code>的内容与主服务器中的内容相同。</p><h3 id="建立主配置文件named-conf-1"><a href="#建立主配置文件named-conf-1" class="headerlink" title="建立主配置文件named.conf"></a>建立主配置文件named.conf</h3><p>在从域名服务器中，<code>named.conf</code>文件的内容与主服务器的内容大部分相同，只是不需要再设置<code>allow-transfer……</code>;更关键的一点是，zone部分的区域类型应设置为<code>slave</code>，并添加<code>masters &#123;&#125;;</code>语句来指定主域名服务器的地址。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/named.confoptions <span class="token punctuation">&#123;</span>  listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.33<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  directory <span class="token string">"/var/named"</span><span class="token punctuation">;</span>  allow-query <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.0/24<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token comment"># 也可以写成"any"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>zone <span class="token string">"exp.com"</span> IN <span class="token punctuation">&#123;</span>  <span class="token builtin class-name">type</span> slave<span class="token punctuation">;</span>   <span class="token comment"># 类型为从区域</span>  masters <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.123<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token comment"># 指定主服务器的IP地址</span>  <span class="token function">file</span> <span class="token string">"slaves/exp.com.zone"</span><span class="token punctuation">;</span>   <span class="token comment"># 下载的区域数据文件保存到slaves/ 目录中</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>zone <span class="token string">"0.168.192.in-addr.arpa"</span> IN <span class="token punctuation">&#123;</span>  <span class="token builtin class-name">type</span> slave<span class="token punctuation">;</span>  masters <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.123<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function">file</span> <span class="token string">"slaves/192.168.0.arpa"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于从服务器的区域数据文件是从主服务器中下载而来，因此，该文件保存的名称可以自行定义，不用非得与主域名服务器中的一致，但需要注意的是，named服务器默认以名为<code>named</code>的用户身份运行，因此要确认named用户对存放目录有写入权限。</p><p>建立完配置文件后用<code>named-checkconf</code>命令进行语法检查。</p><h3 id="启动named服务，查看区域数据文件是否下载成功"><a href="#启动named服务，查看区域数据文件是否下载成功" class="headerlink" title="启动named服务，查看区域数据文件是否下载成功"></a>启动named服务，查看区域数据文件是否下载成功</h3><p>在从域名服务器中启动named服务，若配置无误，则named将会从主域名服务器中自行下载指定的区域数据文件，并保存到<code>slaves/</code>目录下，另外，通过系统日志文件<code>/var/log/messages</code>也可以观察到下载区域数据化文件的过程。</p><p><code>service named start</code> 启动服务</p><h3 id="验证从域名服务器"><a href="#验证从域名服务器" class="headerlink" title="验证从域名服务器"></a>验证从域名服务器</h3><p>对于客户机来说，从域名服务器与主域名服务器并没有什么区别，通过主服务器能够查询到的信息的，通过从服务器也同样能够查询到，验证从域名服务器时，只需要将客户端的首选DNS服务器地址设为<code>192.168.0.10</code>（从域名服务器的ip地址），使用<code>nslookup</code>命令进行正常测试即可。</p><h3 id="测试主、从同步"><a href="#测试主、从同步" class="headerlink" title="测试主、从同步"></a>测试主、从同步</h3><p>在主服务器添加或删除主机名、ip对应条目，修改序列号（每次修改都要加1），从服务器等到更新的时间就会对比序列号，如果不同就会更新。</p><p>也可以在主服务器的配置文中添加全局配置项：</p><p><code>also-notify &#123; 192.168.0.33; &#125;;</code> 主服务器更新完后通知<code>192.168.0.33</code>从服务器更新</p><p>添加完此项后，每当主服务器更新一次，就会通知从服务器更新。</p><p>在区域配置文件中（反向、正向都要加）加上一项主机与ip对应该关系（主域名服务器中添加）</p><p>正向解析：<code>ftp IN a 192.168.0.6</code></p><p>反向解析：<code>6 IN PRT ftp.exp.com.</code></p><p>添加完之后用客户机去测试从域名服务器。</p><p>主服务器增加地址解析记录，修改序列号</p><p>配置<code>also-notify &#123; 192.168.0.33; &#125;;</code>此项的意思是主服务器每次更新完就会通知指定的从服务器。</p><p>练习：</p><ol><li>搭建从服务器，编辑配置文件（使用主机33）</li></ol><p><img src="/medias/img/dns/10.png"></p><p><img src="/medias/img/dns/11.png"></p><ol start="2"><li>重启named服务，<code>cd /var/named/slaves/</code></li></ol><p><img src="/medias/img/dns/12.png"></p><p>从服务器生效会下载主服务器的配置文件！</p><ol start="3"><li>验证</li></ol><p><img src="/medias/img/dns/13.png"></p><p><img src="/medias/img/dns/14.png"></p><p><img src="/medias/img/dns/15.png"></p><h1 id="构建分离解析服务器"><a href="#构建分离解析服务器" class="headerlink" title="构建分离解析服务器"></a>构建分离解析服务器</h1><p>分离解析的域名服务器实际上还是主域名服务器，这里所说的分离解析主要是指根据不同的客户端提供不同的域名解析记录，来自不同地址的客户机请求解析同一域名时为其提供不同的解析结果。</p><p>例如，当DNS服务器面向Internet和企业内部局域网络提供服务时，可能需要将局域网用户访问公司域名的数据直接发往位于内网中的网站、邮件服务器，以减轻网关服务器的地址转换负担。</p><p>架设好分离解析域名服务器后，当公司内部的客户机访问公司的网站/邮件服务器时，直接访问就可以了，解析的结果是这两台服务器的IP地址。当外网的客户机访问公司的网站/域名服务器时，域名解析的结果是网关服务器外网的IP地址（这里会有地址解析技术，使得外网客户机也可能访问这两台服务器）</p><p>这就是分离解析服务器的作用，使得访问同一个用户得到不同的结果</p><p>基本配置步骤：</p><ol><li><p>在named.conf主配置文件中为不同的客户机地址启用不同的zone区域设置，各自 使用独立的数据文件。</p></li><li><p>分别建立不同的区域数据文件</p></li><li><p>启动或重新加载named服务程序</p></li><li><p>验证分离解析域名服务器</p></li></ol><p>具体的操作步骤：</p><ol><li>为不同的客户机分别设立<code>view</code>视图</li></ol><p>在<code>named.conf</code>主配置文件中添加</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/named.conf……view <span class="token string">"LAN"</span> <span class="token punctuation">&#123;</span> 添加view视图，名称为<span class="token string">"LAN"</span>  match-clients <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.33<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token comment"># 这个视图对哪些客户端有效，可以写多个</span>  zone <span class="token string">"exp.com"</span> IN <span class="token punctuation">&#123;</span>  <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>  <span class="token function">file</span> <span class="token string">"exp.com.zone.lan"</span><span class="token punctuation">;</span>   <span class="token comment"># 针对来自局域网客户机的区域 数据文件</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>view <span class="token string">"WAN"</span> <span class="token punctuation">&#123;</span>  match-clients <span class="token punctuation">&#123;</span> any<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token string">"any"</span>   <span class="token comment"># 表示任意，这里表示除了上面那个网 段以外的任意地址</span>  zone <span class="token string">"exp.com"</span> IN <span class="token punctuation">&#123;</span>  <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>  <span class="token function">file</span> <span class="token string">"exp.com.zone.wan"</span><span class="token punctuation">;</span>   <span class="token comment"># 针对来自任意地址客户机的 区域数据文件</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>// include <span class="token string">"/etc/named.rfc1912.zones"</span><span class="token punctuation">;</span>   <span class="token comment"># 注释掉这行，不让其生效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置文件修改完后使用<code>named-checkconf</code>命令检查语法</p><p>在配置文件中主要需要修改的地方是：</p><p>更改监听的端口<code>listen-on port 53 &#123; any; &#125;;</code>为<code>any</code></p><p>更改允许查询的<code>allow-query &#123; any; &#125;;</code>为<code>any</code></p><p>添加视图<code>view</code></p><p>注释掉<code>include &quot;/etc/named.rfc1912.zones&quot;;</code>这行</p><ol start="2"><li>分别建立不同的区域数据文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /var/named/exp.com.zone.lan<span class="token punctuation">..</span>.  NS www.exp.com.  MX <span class="token number">10</span> mail.exp.com.www A <span class="token number">192.168</span>.0.123wap A <span class="token number">192.168</span>.0.33mail A <span class="token number">192.168</span>.0.35<span class="token function">vim</span> /var/named/exp.com.zone.wan<span class="token punctuation">..</span>.  NS www.exp.com.  MX <span class="token number">10</span> mail.exp.com.www A <span class="token number">192.168</span>.0.124wap A <span class="token number">192.168</span>.0.34mail A <span class="token number">192.168</span>.0.36<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>建立好两个文件后可使用<code>named-checkzone</code>命令进行语法检查</p><ol><li>启动或重载named服务程序</li></ol><p><code>service named reload</code></p><ol start="4"><li>验证分离解析的域名服务器</li></ol><p>使用<code>192.168.0.33</code>的客户机将默认DNS指向<code>192.168.0.123</code>解析<code>www.exp.com</code>，结果应该为<code>192.168.0.123</code></p><p>使用其他ip地址的客户机，将默认<code>DNS</code>指向<code>??</code>，解析<code>www.exp.com</code>，结果应该为<code>192.168.0.124</code></p><p><code>named</code>服务一般情况下都是用UDP的53端口，但是有时也会用tcp的53端口</p><p>注意：不管是主、从域名服务器还是分离解析域名服务器，架设时都要关闭<code>selinux</code>和<code>iptables</code>（等学习了iptables后就可以不用关闭了），还要把建立的区域数据文件的属组设为<code>named</code>（因为系统默认会以<code>named</code>用户读取文件内容）。</p><p>可以为不同运营商的用户解析不同的ip地址，从而加快访问速度</p><p>例如：联通用户与其他用户（都是外网用户）都访问同一台分离解析服务器，返回的结果却不一样。</p><p>练习：搭建分离解析服务器</p><ol><li>分离解析服务器配置两块网卡（不同网段）</li></ol><p><img src="/medias/img/dns/16.png"></p><ol start="2"><li>编辑配置文件<code>named.conf</code></li></ol><p><img src="/medias/img/dns/17.png"></p><p><img src="/medias/img/dns/18.png"></p><p><img src="/medias/img/dns/19.png"></p><ol><li><code>cd /var/named</code>创建文件<code>exp.com.zone.lan &amp; exp.com.zone.wan</code></li></ol><p><img src="/medias/img/dns/20.png"></p><p><img src="/medias/img/dns/21.png"></p><p><img src="/medias/img/dns/22.png"></p><ol start="4"><li><p>重载named服务<code>service named restart</code></p></li><li><p>在客户机设置成网段为<code>192.168.1.</code></p></li></ol><p><img src="/medias/img/dns/23.png"></p><p>注：若<code>ping</code>不通分离解析服务器端的<code>1</code>网段<code>IP</code></p><p>1)在网卡中添加<code>GETWAY</code>指向分离解析服务器同网段<code>IP</code></p><p>2)添加默认路由指向 分离解析服务器端的<code>1</code>网段<code>IP</code></p><p>3)将<code>客户机</code>和<code>服务端</code>的<code>wmnet</code>调成同一个</p><p><img src="/medias/img/dns/24.png"></p><p>ping通 即可</p><ol start="6"><li>验证</li></ol><p>1)在客户机的<code>resolv.conf</code>配置文件中填入<code>192.168.0.39</code>DNS服务器IP</p><p><img src="/medias/img/dns/25.png"></p><p><img src="/medias/img/dns/26.png"></p><p>2)在客户机的<code>resolv.conf</code>配置文件中填入<code>192.168.1.123</code>NDS服务器IP</p><p><img src="/medias/img/dns/27.png"></p><p><img src="/medias/img/dns/28.png"></p><h1 id="DNSPod-修改记录"><a href="#DNSPod-修改记录" class="headerlink" title="DNSPod 修改记录"></a>DNSPod 修改记录</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json<span class="token keyword">from</span> tencentcloud<span class="token punctuation">.</span>common <span class="token keyword">import</span> credential<span class="token keyword">from</span> tencentcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>profile<span class="token punctuation">.</span>client_profile <span class="token keyword">import</span> ClientProfile<span class="token keyword">from</span> tencentcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>profile<span class="token punctuation">.</span>http_profile <span class="token keyword">import</span> HttpProfile<span class="token keyword">from</span> tencentcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>tencent_cloud_sdk_exception <span class="token keyword">import</span> TencentCloudSDKException<span class="token keyword">from</span> tencentcloud<span class="token punctuation">.</span>dnspod<span class="token punctuation">.</span>v20210323 <span class="token keyword">import</span> dnspod_client<span class="token punctuation">,</span> models<span class="token keyword">try</span><span class="token punctuation">:</span>    <span class="token comment"># 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span>    <span class="token comment"># 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span>    <span class="token comment"># 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span>    cred <span class="token operator">=</span> credential<span class="token punctuation">.</span>Credential<span class="token punctuation">(</span><span class="token string">"SecretId"</span><span class="token punctuation">,</span> <span class="token string">"SecretKey"</span><span class="token punctuation">)</span>    <span class="token comment"># 实例化一个http选项，可选的，没有特殊需求可以跳过</span>    httpProfile <span class="token operator">=</span> HttpProfile<span class="token punctuation">(</span><span class="token punctuation">)</span>    httpProfile<span class="token punctuation">.</span>endpoint <span class="token operator">=</span> <span class="token string">"dnspod.tencentcloudapi.com"</span>    <span class="token comment"># 实例化一个client选项，可选的，没有特殊需求可以跳过</span>    clientProfile <span class="token operator">=</span> ClientProfile<span class="token punctuation">(</span><span class="token punctuation">)</span>    clientProfile<span class="token punctuation">.</span>httpProfile <span class="token operator">=</span> httpProfile    <span class="token comment"># 实例化要请求产品的client对象,clientProfile是可选的</span>    client <span class="token operator">=</span> dnspod_client<span class="token punctuation">.</span>DnspodClient<span class="token punctuation">(</span>cred<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> clientProfile<span class="token punctuation">)</span>    <span class="token comment"># 实例化一个请求对象,每个接口都会对应一个request对象</span>    req <span class="token operator">=</span> models<span class="token punctuation">.</span>CreateRecordRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>    params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"Domain"</span><span class="token punctuation">:</span> <span class="token string">"wujiops.cn"</span><span class="token punctuation">,</span>        <span class="token string">"SubDomain"</span><span class="token punctuation">:</span> <span class="token string">"_acme-challenge"</span><span class="token punctuation">,</span>        <span class="token string">"RecordType"</span><span class="token punctuation">:</span> <span class="token string">"TXT"</span><span class="token punctuation">,</span>        <span class="token string">"RecordLine"</span><span class="token punctuation">:</span> <span class="token string">"默认"</span><span class="token punctuation">,</span>        <span class="token string">"Value"</span><span class="token punctuation">:</span> <span class="token string">"HKYoajv6MXuqw7BHEdtxyz0BHp1hWOSGLx7aeyXcGeA"</span>    <span class="token punctuation">&#125;</span>    req<span class="token punctuation">.</span>from_json_string<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 返回的resp是一个CreateRecordResponse的实例，与请求对象对应</span>    resp <span class="token operator">=</span> client<span class="token punctuation">.</span>CreateRecord<span class="token punctuation">(</span>req<span class="token punctuation">)</span>    <span class="token comment"># 输出json格式的字符串回包</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>to_json_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">except</span> TencentCloudSDKException <span class="token keyword">as</span> err<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/getent">getent</a><br><a href="../linux-command-1.16.0/host">host</a><br><a href="../linux-command-1.16.0/hostname">hostname</a><br><a href="../linux-command-1.16.0/nslookup">nslookup</a><br><a href="../linux-command-1.16.0/dnsdomainname">dnsdomainname</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dns </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rsync</title>
      <link href="/posts/485f6ed4.html"/>
      <url>/posts/485f6ed4.html</url>
      
        <content type="html"><![CDATA[<h1 id="rsync-inotify实时同步"><a href="#rsync-inotify实时同步" class="headerlink" title="rsync+inotify实时同步"></a>rsync+inotify实时同步</h1><h1 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h1><p>rsync是Linux系统下的文件同步和数据传输工具，它采用”rsync算法”使客户机和服务器之间实现文件同步，可以执行完整备份或增量备份。</p><h2 id="功能特性："><a href="#功能特性：" class="headerlink" title="功能特性："></a>功能特性：</h2><p>可以镜像保存整个目录树和文件系统</p><p>可以增量同步数据，文件传输效率高，因而同步时间短</p><p>可以保持原有文件的权限、时间等属性</p><p>加密传输数据，保证了数据的安全性</p><p>可以使用rcp、ssh等方式来传输文件，当然也可以直接通过socket连接传输文件</p><p>支持匿名传输</p><h2 id="rsync的优点与不足"><a href="#rsync的优点与不足" class="headerlink" title="rsync的优点与不足"></a>rsync的优点与不足</h2><p>与传统的cp、tar备份方式相比，rsync具有安全性高、备份迅速、支持增量备份等优点，通过rsync可以解决对实时性要求不高的数据备份需求，例如，定期地备份文件服务器数据到远程服务器，对本地磁盘定期进行数据镜像等。</p><p>随着应用系统规模的不断扩大，对数据的安全性和可靠性提出了更高的要求，rsync在高端业务系统中暴露出很多不足，rsync同步数据时要扫描所有文件，然后再进行差量传输。如果文件数量达到百万或千万级，是非常耗时的，而且发生变化的往往是其中很少的一部分，因此rsync是非常低效的方式，其次rsync不能实时监测同步数据，虽然它可以通过Linux守护进程的方式触发同步，但两次触发动作一定会有时间差，可能导致服务器和客户端数据出现不一致，基于以上原因rsync+inotify组合就出现了</p><h1 id="初识inotify"><a href="#初识inotify" class="headerlink" title="初识inotify"></a>初识inotify</h1><p>inotify是一种强大的、细粒度的、异步的文件系统时间监控机制，Linux内核从2.6.13版本起，加入了对inotify的支持。通过inotify可以监控文件系统中添加、删除、修改、移动等各种细微事件，利用这个内核接口，第三方软件可以监控文件系统下文件的各种变化情况，inotify-tools就是这样的一个第三方软件。</p><p>rsync可以实时触发式的文件同步，但是通过crontab守护进程进行触发，同步数据和实际数据会有差异，而inotify可以监控文件系统的各种变化，当文件有任何变动时，会触发rsync同步，这样刚好解决了同步数据的实时</p><p>准备：</p><p>发布端：安装<code>inotify-tools</code>(epel)、<code>rsync</code>、<code>xinetd</code></p><p><code>ssh-keygen -t rsa -b 2048</code>(一路回车)</p><p><img src="/medias/img/rsync/0.png"></p><p><code>ssh-copy-id -i .ssh/id_rsa.pub 192.168.0.123</code>(发送给同步端)</p><p><img src="/medias/img/rsync/1.png"></p><p><code>ssh 192.168.0.123</code>(验证)</p><p><img src="/medias/img/rsync/2.png"></p><p><code>vim /etc/rsync.pass</code>(标记1、写入密码)(600)</p><p><img src="/medias/img/rsync/3.png"></p><p><code>mkdir -p /test/dir</code>(创建同步目录)</p><p><code>vim rsync.sh</code>(755)</p><p><img src="/medias/img/rsync/4.png"></p><p>（src指定发布出去的同步目录）</p><p><code>bash rsync.sh &amp;</code>(放入后台运行)</p><p><img src="/medias/img/rsync/5.png"></p><p>同步端：安装<code>rsync</code>、<code>xinetd</code>(启动服务)</p><p><code>vim /etc/xinetd.d/rsync</code>(no)</p><p><img src="/medias/img/rsync/6.png"></p><p><code>vim /etc/rsync.pass</code>(user:密码、同标记1对应)(600)</p><p><img src="/medias/img/rsync/7.png"></p><p><code>vim /etc/rsyncd.conf</code>（path指定从发布端目录 同步过来的内容 的存放目录）</p><p><img src="/medias/img/rsync/8.png"></p><p>验证：</p><p><img src="/medias/img/rsync/9.png"></p><p><img src="/medias/img/rsync/10.png"></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/rsync">rsync</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> inotify </tag>
            
            <tag> rsync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FTP</title>
      <link href="/posts/3eeae1c4.html"/>
      <url>/posts/3eeae1c4.html</url>
      
        <content type="html"><![CDATA[<h1 id="FTP文件传输服务"><a href="#FTP文件传输服务" class="headerlink" title="FTP文件传输服务"></a>FTP文件传输服务</h1><p>概述：FTP（文件传输协议）是典型的C/S架构的应用层协议，需要由服务端软件、客户端软件两部分共同实现文件传输功能</p><p>FTP连接及传输模式</p><p>FTP的两个端口：</p><p>控制连接：TCP的21号端口，用于控制连接，发送FTP命令信息。</p><p>数据连接：TCP的20号端口，用于上传、下载数据</p><p>一般观测FTP时，只观测21号端口即可，存在说明服务正在运行。</p><p>数据连接的建立类型：主动模式、被动模式（以服务器的角度）</p><ol><li>主动模式：服务器主动发起数据连接</li></ol><p>首先由客户机向服务端的21号端口建立FTP控制连接，当需要数据连接时，客户端以PORT命令告知服务器，”客户端打开了某个端口，请求服务端过来连接”，于是服务器从20号端口向客户端的该端口发送请求并建立数据连接。这其中的”某端口”是客户端任意挑选的一个未被使用的随机端口。</p><ol start="2"><li>被动模式：服务器被动等待数据连接</li></ol><p>如果客户机所在网络的防火墙禁止主动模式连接，通常会使用被动模式，首先由客户端向服务端的21号端口建立FTP控制连接，当需要数据连接时，服务器以PASV命令告知客户端”服务端打开了某端口，请求客户端来连接”，于是客户端向服务器的该端口（非20号端口）发送请求并建立数据连接。</p><p>这其中的”某端口”是服务端任意的一个未被使用的随机端口</p><p>客户端与服务端建立好数据连接之后就可以根据控制连接中发送的FTP命令上传或下载文件了。</p><p>在传输文件时，根据是否进行字符转换，分为文本模式和二进制模式。使用二进制模式比文本模式更有效率，大多数FTP客户端工具可以根据文本类型自动选项文件传输模式，而无需用户手工指定</p><h2 id="FTP用户类型分三类："><a href="#FTP用户类型分三类：" class="headerlink" title="FTP用户类型分三类："></a>FTP用户类型分三类：</h2><ol><li>使用FTP客户端软件访问服务器时，通常要用到一类特殊的用户账号，其用户名为ftp或anonymous，提供任意密码（包括空密码）都可以通过FTP服务器的验证，这样的用户成为”匿名用户”</li></ol><p>匿名用户一般用于提供公共文件的下载，如，提供一些免费软件、学习资料下载的站点。</p><ol start="2"><li><p>除了不需要密码验证的匿名用户以外，FTP服务器还可以直接使用本机的系统用户账号进行验证，这些用户通常被称为”本地用户”</p></li><li><p>有些FTP服务器软件还可以维护一份独立的用户数据库文件，而不是直接使用系统用户账号，这些位于独立数据库文件中的FTP用户账号，通常被称为”虚拟用户”，通过使用虚拟用户将FTP账户与Linux系统账户的关联性将至最低，增加了系统的安全性。</p></li></ol><h2 id="FTP服务器软件的种类"><a href="#FTP服务器软件的种类" class="headerlink" title="FTP服务器软件的种类"></a>FTP服务器软件的种类</h2><p>在windows系统中，常见的FTP服务器软件包括File zilla service、serv-U等</p><p>在Linux系统中，vsftpd是目前在Linux/Unix领域应用十分广泛的一款FTP服务软件。</p><p>vsftpd服务的全名来源于”Very Secure FTP Daemon”，该软件针对安全方面做了大量的设计，除了安全性外，vsftpd在速度和稳定性方面的表现也相当突出。</p><h2 id="FTP客户端工具的种类"><a href="#FTP客户端工具的种类" class="headerlink" title="FTP客户端工具的种类"></a>FTP客户端工具的种类</h2><p>最简单的FTP客户端工具莫过于”ftp”命令程序了，除此之外还有大量的图形化FTP客户端工具，Windows中比较常用的包括”Cuter FTP”、”FlashFXP”、”LeapFTP”、”Filezilla”等等。</p><p>还有一些下载工具软件，如”Flash Get”、”wget”等，包括大多数网页浏览器程序，都支持通过FTP协议下载文件，但因不具备FTP上传等管理功能，通常不称为FTP客户端工具。</p><h1 id="vsftpd服务基础"><a href="#vsftpd服务基础" class="headerlink" title="vsftpd服务基础"></a>vsftpd服务基础</h1><h2 id="vsftpd的配置文件"><a href="#vsftpd的配置文件" class="headerlink" title="vsftpd的配置文件"></a>vsftpd的配置文件</h2><ol><li>用户列表文件<code>ftpusers</code>和<code>user_list</code></li></ol><p>在<code>ftpusers</code>、<code>user_list</code>文件中，各自记录了若干个FTP用户的账号名称，两个文件都用于<code>FTP</code>登录控制，但是控制方式存在一些差别。</p><p><code>ftpusers</code>文件：此文件中列出的用户将禁止登录<code>vsftpd</code>服务器，不管该用户是否在<code>user_list</code>文件中出现，默认已经包括<code>root</code>、<code>bin</code>、<code>daemon</code>等用于系统运行的特殊用户（就如同黑名单）。</p><p><code>user_list</code>文件：此文件中包含的用户可能被禁止登录，也可能被允许登录，具体取决去主配置文件<code>vsftpd.conf</code>中的设置，当存在<code>userlist_enable=YES</code>的配置项时，<code>user_list</code>列表文件方可生效；若指定<code>userlist_deny=YES</code>则仅禁止此文件列表中的用户等录；若指定<code>userlist_deny=NO</code>，则仅允许此文件列表中的用户等录。</p><ol start="2"><li>主配置文件<code>vsftpd.conf</code></li></ol><p>在vsftpd的主配置文件中，配置行采用”配置项=参数”的形式，例：</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf"># 用于匿名用户配置项：anonymous_enable&#x3D;YES   # 设置是否允许匿名访问anon_umask&#x3D;022   # 设置匿名用户所上传文件的默认umask值anon_mkdir_write_enable&#x3D;YES   # 是否允许匿名用户有创建目录的写入权限。anon_other_write_enable&#x3D;YES   # 是否允许匿名用户对文件改名、覆盖及删除文件等操作。# 用于本地用户验证配置项：local_enable&#x3D;YES   # 是否允许本地系统用户访问local_umask&#x3D;022   # 设置本地用户所上传文件的默认umask值chroot_local_user&#x3D;YES   # 是否将FTP本地用户禁锢在家目录中# 全局配置项：listen&#x3D;YES   # 是否以独立运行的方式监听服务listen_sddress&#x3D;0.0.0.0   # 设置监听FTP服务的IP地址listen_port&#x3D;21   # 设置监听FTP服务的端口号write_enable&#x3D;YES   # 启用任何形式的写入权限，如上传、删除文件等download_enable&#x3D;YES   # 是否允许下载文件（建立仅限于浏览、上传的FTP服务器时可将其设置为&quot;NO&quot;）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vsftpd服务可以使用Linux主机中的系统用户账号作为登录FTP的账号，包括匿名访问和用户验证两种形式。</p><p>匿名访问的FTP服务器时，不需要密码，任何人都可以使用，非常方便，当需要提供公开访问的文件下载资源或者让用户上传一些不需要保密的数据资料时，可以选择搭建匿名FTP服务器</p><h1 id="匿名访问的FTP服务"><a href="#匿名访问的FTP服务" class="headerlink" title="匿名访问的FTP服务"></a>匿名访问的FTP服务</h1><p>设置匿名访问的FTP服务器需要三步：</p><ol><li><p>准备匿名FTP访问的目录</p></li><li><p>开放匿名用户配置并启动vsftpd服务</p></li><li><p>测试匿名FTP访问</p></li></ol><h2 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a>具体步骤：</h2><p>准备匿名访问的目录默认<code>/var/ftp</code></p><p><code>/var/ftp/</code>目录下默认设置了一个名为<code>pub</code>的子目录，可以给匿名访问FTP时提供上传文件使用。</p><p>将<code>/var/ftp/pub</code>目录赋予匿名用户<code>ftp</code>写入权限</p><p><code>chown ftp /var/ftp/pub</code></p><h2 id="开放匿名用户配置并启动vsftpd服务"><a href="#开放匿名用户配置并启动vsftpd服务" class="headerlink" title="开放匿名用户配置并启动vsftpd服务"></a>开放匿名用户配置并启动vsftpd服务</h2><p>配置vsftpd服务时，是否开放匿名FTP访问取决于配置项”anonymous_enable”，只要将其设置为”YES”即可</p><p>启用此项后默认只有读取权限，只能查看和下载文件，若要允许匿名用户有上传文件的权限，就需要开放更多的配置，主要有以下几项：</p><blockquote><p>write_enable=YES</p></blockquote><blockquote><p>anon_upload_enable=YES</p></blockquote><blockquote><p>anon_mkdir_write_enable=YES</p></blockquote><blockquote><p>anon_other_write_enable=YES</p></blockquote><p>这些配置项应根据实际需要选择设置</p><p>例如：若要设置vsftpd服务提供匿名访问、允许匿名用户上传、下载，但禁止删除操作，可以如下设置：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/vsftpd/vsftpd.conf<span class="token assign-left variable">anonymous_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">write_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">anon_umask</span><span class="token operator">=</span>022<span class="token assign-left variable">anon_upload_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">anon_mkdir_write_enable</span><span class="token operator">=</span>YES<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/ftp/0.png"><br><img src="/medias/img/ftp/1.png"><br>重启vsftpd服务</p><p><code>service vsftpd restart</code></p><p><img src="/medias/img/ftp/2.png"></p><h2 id="测试匿名FTP访问"><a href="#测试匿名FTP访问" class="headerlink" title="测试匿名FTP访问"></a>测试匿名FTP访问</h2><p>在Windows主机中可以直接在”我的电脑”地址栏中输入URL地址访问，如<a href="ftp://192.168.0.123/">ftp://192.168.0.123</a></p><p><img src="/medias/img/ftp/3.png"></p><p>在Linux的字符界面中，可以使用ftp命令进行测试</p><p>安装ftp命令：<code>yum -y install ftp</code></p><p>例如：执行以下操作可以匿名登录到FTP服务器192.168.0.123</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ftp</span> <span class="token number">192.168</span>.0.123……name<span class="token punctuation">(</span><span class="token number">192.168</span>.0.123:root<span class="token punctuation">)</span>:用户名passwd:密码……ftp<span class="token operator">></span>登录成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/img/ftp/4.png"><br><img src="/medias/img/ftp/5.png"><br><img src="/medias/img/ftp/6.png"><br>登录成功后执行”?”或者”help”会显示出很多类似于samba登录环境中的命令可用</p><p>常用的命令：ls、cd、</p><p><code>cd</code>：切换本地目录</p><p><code>get</code> <code>wget</code>：将文件下载到本地</p><p><img src="/medias/img/ftp/7.png"><br><code>put</code> <code>mput</code>：将本地文件上传到服务器</p><p><img src="/medias/img/ftp/8.png"><br><img src="/medias/img/ftp/9.png"><br><code>quit</code> <code>exit</code>：断开ftp连续连接并退出</p><p>在已经知道要下载文件的完整URL地址的情况下，用户也可以使用wget工具直接下载文件。</p><p>例如：要下载<code>/var/ftp/pub/testfile</code>文件</p><p>执行：<code>wget ftp://192.168.0.123/pub/testfile</code></p><p>lftp命令：lftp支持tab键补全，显示内容带有颜色</p><p>用法：<code>lftp 用户名：密码@ip：端口</code>（默认21）</p><p>例如：<code>lftp 192.168.0.123</code></p><p><img src="/medias/img/ftp/10.png"></p><h1 id="用户验证的FTP服务"><a href="#用户验证的FTP服务" class="headerlink" title="用户验证的FTP服务"></a>用户验证的FTP服务</h1><p>vsftpd可以直接使用Linux主机的系统用户作为FTP账号，提供基于用户名，密码的登录验证。用户使用系统用户账号登录FTP服务器后将默认位于自己家的家目录中，且在家目录中拥有读写权限</p><ol><li>基于本地用户验证（修改<code>anonymous_enable=NO</code>）</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/vsftpd/vsftpd.conf添加<span class="token assign-left variable">local_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">write_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">local_umask</span><span class="token operator">=</span>077<span class="token assign-left variable">chroot_local_user</span><span class="token operator">=</span>YESreload重载<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Windows访问 输入<code>ftp://用户:密码@192.168.0.123</code> 直接进入共享</p><p><img src="/medias/img/ftp/11.png"></p><p>Linux系统访问共享 输入<code>ftp 192.168.0.123</code></p><p><img src="/medias/img/ftp/12.png"><br><img src="/medias/img/ftp/13.png"></p><h2 id="设置用户”白名单”"><a href="#设置用户”白名单”" class="headerlink" title="设置用户”白名单”"></a>设置用户”白名单”</h2><p>只要一些用户登录</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/vsftpd/user_list 添加：queenkingwang<span class="token function">vim</span> /etc/vsftpd/vsftpd.conf 添加：<span class="token assign-left variable">userlist_enable</span><span class="token operator">=</span>YES开启user_list用户列表<span class="token assign-left variable">userlist_deny</span><span class="token operator">=</span>NO禁用user_list列表中的用户<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="设置”虚拟用户”"><a href="#设置”虚拟用户”" class="headerlink" title="设置”虚拟用户”"></a>设置”虚拟用户”</h2><p>vsftpd服务的其它常用配置</p><ol><li>修改vsftpd服务的监听地址、端口</li></ol><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">listen&#x3D;YES   # 允许独立监听服务，也可以使用xinetd服务进行管控vsftpd服务，若使用修改YES为NOlisten_address&#x3D;192.168.0.123listen_port&#x3D;2121# 重载生效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>允许使用FTP服务的被动模式</li></ol><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">pasv_enable&#x3D;YESpasv_min_port&#x3D;24500pasv_max_port&#x3D;24600   # 重启生效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>限制FTP的并发连接数、传输速率</li></ol><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">vim &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.confmax_clients&#x3D;20   # 限制最多连接20个用户max_per_ip&#x3D;2   # 限制每个ip最多连接2个anon_max_rate&#x3D;50000   # 限制匿名用户传输速率为50KB&#x2F;slocal_max_rate&#x3D;200000   # 限制本地用户传输速率为200KB&#x2F;s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>建立虚拟用户步骤：</p><ol><li>创建文本格式的用户名和密码表（格式：奇数行写假的用户名；偶数行写用户名对应的密码）</li></ol><p>例如：<code>vim /etc/vsftpd/xnyh_list</code>(文件名随意)</p><pre class="line-numbers language-none"><code class="language-none">abc123xyz456<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>建立DB数据库，安装<code>db4-utils</code>包</li></ol><p>执行：<code>db_load -T -t hash -f xnyh_list xnyh.db</code></p><p><code>db_load</code>命令选项意义：</p><p><code>-T</code>：制作数据库（允许将文本文件转译载入数据库）</p><p><code>-t</code>：指定转译载入的数据库类型，hash为使用hash码加密</p><p><code>-f</code>：指定要转译的文件</p><p><code>file xnyh.db</code>查看文件的文件类型</p><p><img src="/medias/img/ftp/14.png"></p><ol start="3"><li>添加虚拟用户映射账号，创建<code>FTP</code>根目录</li></ol><p><code>useradd -s /sbin/nologin xnyh</code></p><p><code>mkdir /etc/vsftpd/xnyh_dir</code></p><ol start="4"><li>为虚拟用户建立<code>PAM</code>认证文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/pam.d/vsftpd_xnyh<span class="token comment">#%PAM-1.0</span>auth required pam_userdb.so <span class="token assign-left variable">db</span><span class="token operator">=</span>/etc/vsftpd/xnyh   <span class="token comment"># （指向为创建的虚拟用户数据库，省略.db）</span>account required pam_userdb.so <span class="token assign-left variable">db</span><span class="token operator">=</span>/etc/vsftpd/xnyh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>修改vsftpd配置、添加虚拟用户支持</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/vsftpd/vsftpd.conf<span class="token assign-left variable">local_enable</span><span class="token operator">=</span>YES   <span class="token comment"># 需要映射本地用户，所有启用此项</span><span class="token assign-left variable">write_enable</span><span class="token operator">=</span>YES<span class="token assign-left variable">anon_umask</span><span class="token operator">=</span>022<span class="token assign-left variable">guest_enable</span><span class="token operator">=</span>YES   <span class="token comment"># 启用用户映射功能</span><span class="token assign-left variable">guest_username</span><span class="token operator">=</span>xnyh   <span class="token comment"># 指定映射的系统用户</span><span class="token assign-left variable">pam_service_name</span><span class="token operator">=</span>vsftpd_xnyh   <span class="token comment"># 指定新的PAM认证文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>为不同的虚拟用户建立独立的配置文件</li></ol><p><code>vim /etc/vsftpd/vsftpd.conf</code></p><p>添加：<code>user_config_dir=/etc/vsftpd/xnyh_dir</code></p><p><code>cd /etc/vsftpd/xnyh_dir</code></p><p><code>vim abc</code></p><p><code>anon_upload_enable=YES</code></p><p><code>anon_mkdir_write_enable=YES</code></p><p><code>touch xyz</code></p><p>(<code>abc</code>虚拟用户可以上传，读写；<code>xyz</code>虚拟用户只能读、下载)</p><p>重载<code>vsftpd</code>服务</p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/ftp">ftp</a><br><a href="../linux-command-1.16.0/ftpcount">ftpcount显示登录人数</a><br><a href="../linux-command-1.16.0/ftpshut">ftpshut关闭ftp</a><br><a href="../linux-command-1.16.0/ftpwho">ftpwho查看会话信息</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ftp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>samba共享</title>
      <link href="/posts/4bc5b436.html"/>
      <url>/posts/4bc5b436.html</url>
      
        <content type="html"><![CDATA[<h1 id="samba"><a href="#samba" class="headerlink" title="samba"></a>samba</h1><p><code>samba</code>：指<code>Linux</code>系统中的一种文件共享程序</p><p>在window网络环境中，主机之间进行文件和打印机共享是通过微软公司自己的SMB/CIFS网络协议实现的，是微软的私有协议，在samba项目出现之前，并不能直接与Linux/Unix系统进行通信，samba在Linux/Unix系统中实现了微软的SMB/CIFS网络协议，从而使得跨平台的文件共享变的更加容易，在部署Windows，Linux/Unix混合平台的企业环境时，选用samba可以很好地解决不同系统之间的文件互访问题。</p><h2 id="samba软件构成"><a href="#samba软件构成" class="headerlink" title="samba软件构成"></a>samba软件构成</h2><ol><li>samba软件包的构成</li></ol><p>在光盘的安装包中，可以找到与samba相关的几个软件包，主要包括服务端软件<code>samba</code>，客户端软件<code>samba-client</code>，用于提供服务端和客户端程序的公共组件<code>samba-common</code></p><p><img src="/medias/img/samba/0.png"></p><ol start="2"><li>samba服务的程序组件</li></ol><p><code>samba</code>服务器提供<code>smbd</code>、<code>nmbd</code>两个服务程序</p><p>smbd负责为客户机提供服务器中共享资源的访问（目录文件等）</p><p><code>nmbd</code>负责提供基于NetBIOS协议的名字解析、浏览服务</p><p>NetBIOS协议：由IBM公司开发，使用户软件能使用局域网的资源，自从诞生，NetBIOS成为许多其他网络应用程序的基础，严格意义上，NetBIOS是接入网络服务的接口标准</p><ol start="3"><li>使用<code>netstat</code>查看状态（<code>-atunp</code>）（-a可以查看所有连线中的socket）</li></ol><p><code>smbd</code>：负责监听TCP协议的139（SMB协议）和445（CIFS协议）端口</p><p><code>nmbd</code>：负责监听UDP协议的137和138（NetBIOS协议）端口</p><h1 id="samba服务基础"><a href="#samba服务基础" class="headerlink" title="samba服务基础"></a>samba服务基础</h1><p>启动服务</p><p><code>service smb restart</code></p><p>启动服务时，只要启动smbd程序就可以了，因为默认也会把nmbd程序启动起来，但是如果nmbd程序没有跟着启动起来，那就再启动一下nmbd</p><p><code>service nmb restart</code></p><p>samba配置</p><p>日志文件<code>/var/log/samba/</code>目录中</p><p>主配置文件<code>/etc/samba/smb.conf</code></p><p>配置文件中<code>#</code>开头的表示注释信息，<code>;</code>开头的表示配置样例</p><p>samba的主配置文件分为三个部分：</p><p><code>[global]</code>全局配置，对整个samba配置文件都生效</p><p><code>[homes]</code>宿主目录共享设置，设置Linux用户的默认共享，对应用户的宿主目录，这部分很少设置、默认就可以</p><p><code>[printers]</code>打印机共享设置</p><p>若需要在<code>smb.conf</code>文件中设置新的共享文件夹，只需要增加一段：</p><p><code>[samba]</code>自定义共享名，新的共享文件夹设置可以参考<code>[homes]</code>和<code>[printers]</code>部分的内容</p><p>samba服务器的常见配置项及含义说明：</p><p><code>workgroup</code>：设置服务器所在的工作组名称</p><p><code>service string</code>：设置服务器的说明文字，用于描述samba服务器</p><p><code>security</code>：设置服务器的安全级别，可设为：share（可匿名，任何人都可以访问）；user需要本服务器验证用户名及密码；server需要指定另一台服务器来验证用户名及密码；domain由windows域控制器验证用户名及密码</p><p><code>log file</code>：设置samba服务器的日志文件，默认设置为/var/log/samba/log.%m表示将日志文件保存到/var/log/samba/目录中，按每个客户机建立一个目录文件，其中”%m”变量表示客户端主机名或ip地址</p><p><code>max log size</code>：日志文件的最大容量，单位为KB（默认50KB，超过会产生一个新的文件），若网络内拥有LDAP目录认证，这里可以改用ldapsam数据库文件；另外，若要兼容旧版的samba密码文件也可以将类型设为smbpasswd</p><p>对某个共享目录的配置项（对这些目录控制一些特性、属性）</p><p><code>comment</code>：设置对应共享目录的注释、说明信息</p><p><code>path</code>：设置对应共享目录在服务器中的文件夹路径（绝对路径）</p><p><code>browseable</code>：设置该共享目录在”网上邻居”中是否看的到，设置为no时相当于隐藏共享目录</p><p><code>guest ok</code>：设置是否所有人都可以访问共享目录，与”public”配置项作用相同</p><p><code>writable</code>：设置该共享目录是否可写，samba服务设置的读取、写入权限，优先级要低于文件系统中设置的权限</p><p><code>read only</code>：设置是否只读</p><p><code>valid users</code>：指定有效用户</p><p><code>write list</code>：指定用户可写</p><p>语法检查：<code>samba</code>服务器提供了一个配置文件检查工具</p><p><code>testparm</code>程序，使用<code>testparm</code>工具可以对<code>smb.conf</code>配置文件的正确性进行检查，如果发现有错误将会进行提醒</p><h1 id="设置可匿名访问共享"><a href="#设置可匿名访问共享" class="headerlink" title="设置可匿名访问共享"></a>设置可匿名访问共享</h1><p>可匿名访问的共享适用于公开的资源分享，一般只建议提供只读访问</p><p>设置可匿名共享文件夹时，在主配置文件<code>samba.conf</code>中主要调整两个地方即可</p><p>1.将默认安全级别修改为share</p><p>2.添加一段共享目录配置</p><p>例如：将本地目录<code>/testdir/dir</code>发布为共享文件夹，共享名为<code>samba</code></p><ol><li>修改配置文件<code>/etc/samba/smb.conf</code></li></ol><p>把安全级别<code>security=user</code>改为<code>security=share</code></p><p><img src="/medias/img/samba/1.png"><br>添加配置</p><p><img src="/medias/img/samba/2.png"><br><code>comment</code>注释，<code>path</code>共享目录的绝对路径，<code>guest ok</code>允许所有人访问，<code>read only</code>只读，<code>writable</code>写入</p><ol start="2"><li>开启samba共享服务</li></ol><p><code>service smb start</code></p><p><img src="/medias/img/samba/3.png"></p><ol start="3"><li>用<code>testparm</code>工具检查一下语法</li></ol><p>直接执行<code>testparm</code>即可，显示<code>ok</code>字样表示没有错误</p><p>也可以再回车一下查看刚添加的共享文件</p><p><img src="/medias/img/samba/4.png"><br>用Windows访问共享文件</p><p><img src="/medias/img/samba/5.png"><br>打开计算机，在输入框输入：<code>\\共享服务器ip地址</code></p><p>用Linux访问共享文件</p><p>安装<code>samba-client</code>工具</p><p>匿名访问 ：<code>smbclient //IP地址/共享名</code>（一路回车）</p><p><img src="/medias/img/samba/6.png"></p><h1 id="设置需要用户验证的共享"><a href="#设置需要用户验证的共享" class="headerlink" title="设置需要用户验证的共享"></a>设置需要用户验证的共享</h1><p>匿名共享虽然用起来非常方便，但因为任何人都可以访问到共享的文件数据，在某些时候可能会导致信息的泄露</p><p>用户验证的共享实现步骤</p><ol><li>建立samba用户数据库</li></ol><p>使用pdbedit工具可以对共享用户进行管理</p><p>执行<code>pdbedit -a -u 用户名</code></p><p>可以添加一个用户为<code>samba</code>共享用户</p><p>选项</p><p><code>-a</code>：添加</p><p><code>-u</code>：指定用户名</p><p><code>-L</code>：列出所有samba共享用户</p><p><code>-v</code>：输出详细信息</p><p><code>-x</code>：删除samba用户，指定用户名即可</p><p><code>-vL user</code>：只列出某个用户的详细信息</p><p><code>-xu user</code>：删除指定samba用户</p><p>为了区别于Linux主机中的系统用户，通常将用于访问samba共享资源的用户称为<code>共享用户</code>samba服务器使用独立的共享账号数据库文件，其中的账号名称必须有与它同名的系统用户相对应，以便主机对共享访问的读写权限进行控制，但共享用户的密码是额外设置的，可以与系统用户的密码不一样</p><p>samba共享用户的账号数据库文件默认位于<code>/var/lib/samba/private/passdb.tdb</code>是一个经过加密的文件，其中保存了samba用户的账号名称、登录密码、账号可用状态等信息。</p><ol start="2"><li>设置用户访问授权</li></ol><p>若使用用户验证的samba共享，应将security安全级别提升为<code>user</code>，共享用户授权主要由<code>valid users(指定有效用户)</code>，<code>write list(指定用户可写)</code></p><p>配置项指定，当需要授权多个共享用户时，以逗号或空格进行分割，如果需要授权一个用户组，可以使用<code>@组名</code>的形式，但需要为组内的每个系统用户都创建对应的samba共享用户</p><p>例如：</p><p>将本地目录<code>/testdir</code>发布为共享文件夹，共享名为<code>date</code>，要求只有共享用户<code>queen</code>和<code>king</code>能够访问，其中<code>queen</code>用户具有写入权限</p><p>1)创建共享用户<code>queen</code>和<code>king</code></p><p><code>pdbedit -a -u queen;pdbedit -a -u king</code></p><p><img src="/medias/img/samba/7.png"><br><img src="/medias/img/samba/8.png"></p><p>2)创建共享目录</p><p><code>mkdir /testdir;chmod 777 /testdir</code></p><p><img src="/medias/img/samba/9.png"></p><ol start="3"><li>修改<code>/tec/samba/smb.conf</code>配置文件</li></ol><p>其中<code>security=user</code></p><p><img src="/medias/img/samba/10.png"><br>添加名为<code>samba</code>的共享目录配置段</p><p><img src="/medias/img/samba/11.png"></p><ol start="4"><li>重新加载<code>/etc/samba/smb.conf</code>配置文件，或重启smb服务</li></ol><p><img src="/medias/img/samba/12.png"><br>（可能需要重启nmb服务）</p><p>确定目录访问授权</p><p>通过samba服务器共享文件夹时，用户最终是否拥有读取、写入权限除了需要设置用户授权以外，还要满足一个前提条件那就是在服务器中与共享用户同名的系统用户对发布为共享本地文件夹必须有相应的读取、写入权限</p><p>另，当通过共享目录上传文档时，对于共享用户所上传的文件、创建的子目录的默认权限可以分别使用配置项<code>create mask</code> <code>directory mask</code>进行指定</p><p>编辑<code>/etc/samba/smb.conf</code></p><p><img src="/medias/img/samba/13.png"><br>查看是否成功</p><p><img src="/medias/img/samba/14.png"><br><img src="/medias/img/samba/15.png"><br><img src="/medias/img/samba/16.png"><br><img src="/medias/img/samba/17.png"></p><h1 id="用户映射及访问地址限制"><a href="#用户映射及访问地址限制" class="headerlink" title="用户映射及访问地址限制"></a>用户映射及访问地址限制</h1><p>用户映射及访问地址限制</p><p>为了进一步提高samba共享服务的安全性，除了可以对指定的共享目录设置用户授权以外，可以采用用户映射、访问地址限制等措施</p><p>1.共享账号映射（别名）</p><p>在使用samba共享账号时，通常情况下，一个共享用户账号都有一个同名的系统用户账号，一些人可能会使用网络中泄露的共享用户账号作为samba服务的系统用户登录，对Linux主机带来了安全隐患</p><p>鉴于此，samba服务为我们提供了<code>用户名称映射</code>机制，可以将一个共享用户映射为多个不同的名称（别名），这样一来，只需要通过共享用户的别名和密码就可以访问授权的资源了，而不需要知道真实的共享用户（系统用户）名称</p><p>samba共享账号的映射文件默认为<code>/etc/samba/smbusers</code>，文件中的配置记录使用<code>共享用户名 = 别名1 别名2 ...</code>的格式，在该文件中默认已经添加了两条兼容Windows客户机的别名映射</p><p>具体操作</p><p><code>vim /etc/samba/smbusers</code></p><p>添加 <code>queen = abc xyz</code> 保存退出即可</p><p><img src="/medias/img/samba/18.png"><br>以后就可以使用abc或xyz用户来代替queen用户登录了，密码还是queen的密码配置文件<code>/etc/samba/smb.conf</code>添加全局配置项（global）</p><p><code>username map = /etc/samba/smbusers</code></p><p>然后重新加载配置使其生效</p><p>2.访问地址限制</p><p>针对访问samba服务的客户机，可以通过（黑 白名单，二者选其一）</p><p><code>hosts allow</code>（白名单）允许访问共享客户机的ip地址</p><p><code>hosts deny</code>（黑名单）拒绝访问共享客户机的ip地址</p><p>访问地址限制一般用于<code>[global]</code>全局配置部分，也可以应用于某个具体的配置部分，限制的对象可以是主机名、ip地址或者网段地址（省去主机部分），多个地址之间以逗号或空格进行分割</p><p>例如：<code>vim /etc/samba/smb.conf</code></p><p><code>[global]</code></p><p>增加<code>hosts allow = 192.168.0.  192.168.1.</code>（允须192.168的1网段和2网段访问）</p><p>保存退出，重载服务即可</p><p><img src="/medias/img/samba/19.png"><br>注意：添加地址显示时的格式，如果是<code>192.168.1.0/24</code>网段，要写成<code>192.168.1.</code>这种格式，<code>172.16.0.0/24</code>网段，要写成<code>173.16.</code>这种格式</p><h1 id="访问共享文件夹"><a href="#访问共享文件夹" class="headerlink" title="访问共享文件夹"></a>访问共享文件夹</h1><ol><li>使用<code>smbclient</code>访问共享文件夹</li></ol><p>安装<code>samba-client</code>这个包</p><p>查询目标主机的共享资源列表</p><p>使用<code>smbclient</code>命令查询</p><p>选项：</p><p><code>-U</code>：指定目标主机ip或主机名</p><p><code>-L</code>：指定以某用户账号列表查看</p><p>格式：<code>smbclient -L ip/主机名 -U 用户名/别名</code></p><p>查询共享资源时，一般不需要用户验证，提示输入密码时直接回车即可。</p><p>例如：匿名查询samba服务器<code>192.168.0.123</code>中提供共享资源列表，使用queen用户</p><p><code>smbclient -L 192.168.0.123 -U queen</code></p><p><img src="/medias/img/samba/20.png"></p><ol start="2"><li>登录并访问共享文件夹</li></ol><p>匿名访问共享文件夹时提示输入密码时直接回车即可</p><p>匿名登录访问格式</p><p><code>smbclient //主机地址/共享名</code></p><p>例如：以下操作可以连接到samba服务器192.168.0.123中名为test的匿名共享目录</p><p><code>smbclient //192.168.0.123/test</code></p><p>若访问需要用户验证的共享文件夹，则必须结合-U选项指定经过授权的共享用户名称（或映射的别名）并输入正确的密码进行验证</p><p>用户验证登录格式</p><p><code>smbclient -U 用户名/别名 //主机地址/共享名 [-U 用户名/别名]</code></p><p>例如：对于上面讲到的date共享，使用queen或其别名都可以进行访问</p><p><code>smbclient -U queen //192.168.0.123/date</code></p><p>通过<code>smbclient</code>工具成功登录samba服务器以后，会出现<code>smb:\&gt;</code>提示符，提供了一个命令程序的环境，在<code>smb:\&gt;</code>环境中使用特定的命令可以对共享目录进行列表、上传、下载等操作</p><p>例如：<code>ls</code>、<code>cd</code>、<code>pwd</code>、</p><p><code>get</code>、<code>wget</code>：下载文件</p><p><code>put</code>、<code>mput</code>：用于上传文件</p><p><code>？</code>、<code>help</code>：查看帮助信息</p><p><code>exit</code>、<code>quit</code>：退出共享目录</p><ol start="3"><li>使用mount挂载共享文件夹</li></ol><p>smbclient客户端工具可以非常方便地登录到samba服务器中，但只有将文件下载到本地以后才能查看文件内容，若使用mount命令将共享文件夹挂载到本地，则通过本地的挂载点目录即可直接使用共享文件夹的内容，使文件共享更加方便。</p><p>使用mount命令挂载共享资源时，只需要通过”//主机地址/共享名”的形式指定共享文件夹的位置（视为设备资源），并指定本地的挂载点即可，如果要以某个共享用户进行验证，就要用到-o选项指定”username=用户名”的形式指定</p><p>格式：</p><p><code>mount -o username=共享用户名 //主机地址/共享名 /挂载点</code></p><p>如果不能挂载查看<code>cifs-utils</code>工具是否安装</p><p>例如：（对客户端来说）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /media/date<span class="token function">mount</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">username</span><span class="token operator">=</span>queen //192.168.0.123/test /media/date<span class="token function">mount</span>   <span class="token comment"># 查看结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>挂载成功后可以对samba服务器设置权限进行测试（mkdir;touch）</p><p><img src="/medias/img/samba/21.png"></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/smbclient">smbclient交互访问</a><br><a href="../linux-command-1.16.0/smbpasswd">smbpasswd用户管理</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> samba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NFS</title>
      <link href="/posts/d1049115.html"/>
      <url>/posts/d1049115.html</url>
      
        <content type="html"><![CDATA[<h1 id="NFS共享服务"><a href="#NFS共享服务" class="headerlink" title="NFS共享服务"></a>NFS共享服务</h1><p>NFS简介：</p><p>NFS：Network FileSystem（网络文件系统）是一种基于TCP/IP传输的网络文件系统协议，最初由SUN公司开发</p><p>作用：通过使用NFS协议，客户机可以挂载NFS共享出来的目录，然后像访问本地目录一样访问远程服务器中的共享资源</p><p>特点及适用范围：NFS没有客户端认证机制，而且数据在网络上明文传输，所以安全性很差，一般只能在局域网中使用</p><p>NFS服务的实现依赖于RPC机制（远程过程调用），以完成远程到本地的映射过程<br>由于nfs各项功能都必须向RPC服务注册一个合法的端口用来给客户端提供服务，所以启动nfs服务时，要先保证RPC服务已经启动，否则nfs服务不能正常提供服务；</p><ol><li><p>客户端会向服务器端的RPC（port 111）发出NFS服务请求</p></li><li><p>服务器端找到对应的已注册的NFS daemon端口后，会回报给客户端</p></li><li><p>客户端知道正确的端口后，就可以直接与NFS daemon服务连线（daemon守护进程）</p></li></ol><p>在CentOS6系统中，需要安装nfs-utils,rpcbind软件包来提供NFS共享服务，前者用于NFS共享发布和访问，后者用于RPC支持</p><h2 id="使用NFS发布共享资源："><a href="#使用NFS发布共享资源：" class="headerlink" title="使用NFS发布共享资源："></a>使用NFS发布共享资源：</h2><h3 id="安装nfs-utils、rpcbind软件包"><a href="#安装nfs-utils、rpcbind软件包" class="headerlink" title="安装nfs-utils、rpcbind软件包"></a>安装nfs-utils、rpcbind软件包</h3><p><code>yum -y install nfs-utils rpcbind</code><br>手动加载NFS共享服务时，应该先启动rpcbind 再启动nfs</p><h3 id="设置共享目录"><a href="#设置共享目录" class="headerlink" title="设置共享目录"></a>设置共享目录</h3><p>NFS的配置文件为<code>/etc/exports</code><br>在exports文件中设置共享资源时，记录格式为：</p><p><code>目录路径（绝对路径）  客户机地址（权限选项）</code><br>（客户机地址可以是主机名、IP地址、网段地址、可以使用”通配符”）</p><p>例如：</p><p><code>/testdir/dir   192.168.0.0/24(rw,sync,no_root_squash)</code> </p><p>权限选项的含义：</p><p><code>rw</code>：读写</p><p><code>ro</code>：只读</p><p><code>sync</code>：同步写进内存和磁盘</p><p><code>async</code>：先写进内存再写进磁盘</p><p><code>no_root_squash</code>：表示当客户机以<code>root</code>身份访问时赋予本地<code>root</code>权限</p><p>（默认是<code>root_squash</code>，将作为<code>nfsnobody</code>用户降权对待）</p><p>当需要将同一个目录共享给不同的客户机，且分配不同的特权时，只要以空格分割指定多个”客户机（特权选项）”即可</p><h3 id="启动NFS服务程序"><a href="#启动NFS服务程序" class="headerlink" title="启动NFS服务程序"></a>启动NFS服务程序</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start rpcbindsystemctl start nfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="查看NFS的启动状况"><a href="#查看NFS的启动状况" class="headerlink" title="查看NFS的启动状况"></a>查看NFS的启动状况</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rpcinfo  <span class="token parameter variable">-p</span>  localhost <span class="token operator">|</span> <span class="token function">grep</span> nfsss -anptl<span class="token operator">|</span><span class="token function">grep</span> rpcind<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/img/nfs/0.gif"><br>NFS服务使用的111和2049端口是固定的，mountd端口是动态的，需要固定，然后在防火墙放行。</p><p><em>防火墙关闭就不必执行了</em></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 固定端口</span><span class="token function">tee</span> <span class="token operator">>></span> /etc/sysconfig/nfs <span class="token operator">&lt;&lt;</span> <span class="token string">EOFRQUOTAD_PORT=30001LOCKD_TCPPORT=30002LOCKD_UDPPORT=30002MOUNTD_PORT=30003STATD_PORT=30004EOF</span><span class="token comment"># 重启nfs和rpcbind：</span>systemctl restart rpcbindsystemctl restart nfs<span class="token comment"># （端口并未修改，reboot系统后才修改）</span><span class="token comment"># 防火墙放行端口</span><span class="token comment"># 查看防火墙是否开启：</span>firewall-cmd <span class="token parameter variable">--state</span><span class="token comment"># 设置防火墙</span>firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">2049</span>/tcpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">2049</span>/udpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">111</span>/tcpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">111</span>/udpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token string">"30001-30004"</span>/udpfirewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token string">"30001-30004"</span>/tcpfirewall-cmd <span class="token parameter variable">--reload</span>   <span class="token comment"># 加载规则生效</span>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --list-ports   <span class="token comment"># 列出所有规则</span><span class="token comment"># 2049/tcp 2049/udp 111/tcp 111/udp 30001-30004/udp 30001-30004/tcp</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看本机发布的NFS共享目录"><a href="#查看本机发布的NFS共享目录" class="headerlink" title="查看本机发布的NFS共享目录"></a>查看本机发布的NFS共享目录</h3><p><code>showmount -e IP地址（localhost）</code></p><p>exportfs如果修改了<code>/etc/exports</code>文件后，不需要重新启动nfs服务，只需要重新扫描一次<code>/etc/exports</code>文件夹，并重新加载即可</p><blockquote><p>exportfs命令</p></blockquote><blockquote><blockquote><p>-a加载exportfs文件中的设置</p></blockquote></blockquote><blockquote><blockquote><p>-r重新挂载文件中的设置</p></blockquote></blockquote><blockquote><blockquote><p>-u卸载某一目录</p></blockquote></blockquote><blockquote><blockquote><p>-v详细信息</p></blockquote></blockquote><h2 id="在客户机中访问NFS共享资源"><a href="#在客户机中访问NFS共享资源" class="headerlink" title="在客户机中访问NFS共享资源"></a>在客户机中访问NFS共享资源</h2><h3 id="安装rpcbind软件包，并启动rpcbind服务"><a href="#安装rpcbind软件包，并启动rpcbind服务" class="headerlink" title="安装rpcbind软件包，并启动rpcbind服务"></a>安装rpcbind软件包，并启动rpcbind服务</h3><p>如果已经安装了<code>nfs-utils</code>软件包，则客户机也可以使用<code>showmount</code>查看NFS服务器共享了哪些目录，查看格式为：</p><p><code>showmount -e 服务器ip地址</code> </p><h3 id="手动挂载NFS共享目录"><a href="#手动挂载NFS共享目录" class="headerlink" title="手动挂载NFS共享目录"></a>手动挂载NFS共享目录</h3><p>将NFS服务器共享的 目录 挂载到本地 目录</p><p>查看：</p><p><code>mount 或 tail -1 /etc/mtab</code><br><img src="/medias/img/nfs/1.gif"></p><h3 id="fstab自动挂载设置"><a href="#fstab自动挂载设置" class="headerlink" title="fstab自动挂载设置"></a>fstab自动挂载设置</h3><p>注意将文件系统类型设置为nfs，挂载参数建议添加<code>_netdev</code>（设备需要网络）</p><p><code>vi /etc/fstab</code><br>添加：</p><p><code>192.168.0.123:/共享目录 /挂载点 nfs default,_netdev 0 0</code> </p><p>多台客户机都可以访问同一个挂载目录，但不允许修改同一文件</p><h1 id="附录："><a href="#附录：" class="headerlink" title="附录："></a>附录：</h1><p><code>/etc/fstab</code>是用来存放文件系统的静态信息的文件。<code>less /etc/fstab</code>查看，<code>vi /etc/fstab</code>修改。</p><p>当系统启动的时候，系统会自动地从这个文件读取信息，并且会自动将此文件中指定的文件系统挂载到指定的目录。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># &lt;file system>        &lt;dir>         &lt;type>    &lt;options>             &lt;dump> &lt;pass></span>tmpfs                  /tmp          tmpfs     nodev,nosuid          <span class="token number">0</span>      <span class="token number">0</span>/dev/sda1              /             ext4      defaults,noatime      <span class="token number">0</span>      <span class="token number">1</span>/dev/sda2              none          swap      defaults              <span class="token number">0</span>      <span class="token number">0</span>/dev/sda3              /home         ext4      defaults,noatime      <span class="token number">0</span>      <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段定义</p><p><code>&lt;file system&gt;    &lt;dir&gt;    &lt;type&gt;    &lt;options&gt;    &lt;dump&gt;    &lt;pass&gt;</code><br><code>&lt;file systems&gt;</code>：要挂载的分区或存储设备.</p><p><code>&lt;dir&gt;</code>：<code>&lt;file systems&gt;</code>的挂载位置。</p><p><code>&lt;type&gt;</code>：要挂载设备或是分区的文件系统类型，支持许多种不同的文件系统：<code>ext2</code>,<code>ext3</code>,<code>ext4</code>,<code>reiserfs</code>,<code>xfs</code>,<code>jfs</code>,<code>smbfs</code>,<code>iso9660</code>,<code>vfat</code>,<code>ntfs</code>,<code>swap</code>及<code>auto</code>。 设置成<code>auto</code>类型，<code>mount</code>命令会猜测使用的文件系统类型，对<code>CDROM</code>和<code>DVD</code>等移动设备是非常有用的。</p><p><code>&lt;options&gt;</code>：挂载时使用的参数，注意有些<code>mount</code>参数是特定文件系统才有的。一些比较常用的参数有：</p><p>-<code>auto</code>：在启动时或键入了<code>mount -a</code>命令时自动挂载。</p><p>-<code>noauto</code>：只在你的命令下被挂载。</p><p>-<code>exec</code>：允许执行此分区的二进制文件。</p><p>-<code>noexec</code>：不允许执行此文件系统上的二进制文件。</p><p>-<code>ro</code>：以只读模式挂载文件系统。</p><p>-<code>rw</code>：以读写模式挂载文件系统。</p><p>-<code>user</code>：允许任意用户挂载此文件系统，若无显示定义，隐含启用<code>noexec</code>,<code>nosuid</code>,<code>nodev</code>参数。</p><p>-<code>users</code>：允许所有<code>users</code>组中的用户挂载文件系统.</p><p>-<code>nouser</code>：只能被<code>root</code>挂载。</p><p>-<code>owner</code>：允许设备所有者挂载.</p><p>-<code>sync</code>：I/O 同步进行。</p><p>-<code>async</code>：I/O 异步进行。</p><p>-<code>dev</code>：解析文件系统上的块特殊设备。</p><p>-<code>nodev</code>：不解析文件系统上的块特殊设备。</p><p>-<code>suid</code>：允许<code>suid</code>操作和设定<code>sgid</code>位。这一参数通常用于一些特殊任务，使一般用户运行程序时临时提升权限。</p><p>-<code>nosuid</code>：禁止<code>suid</code>操作和设定<code>sgid</code>位。</p><p>-<code>noatime</code>：不更新文件系统上<code>inode</code>访问记录，可以提升性能(参见<code>atime</code>参数)。</p><p>-<code>nodiratime</code>：不更新文件系统上的目录<code>inode</code>访问记录，可以提升性能(参见<code>atime</code>参数)。</p><p>-<code>relatime</code>：实时更新<code>inode</code> <code>access</code>记录。只有在记录中的访问时间早于当前访问才会被更新。（与<code>noatime</code>相似，但不会打断如<code>mutt</code>或其它程序探测文件在上次访问后是否被修改的进程。），可以提升性能(参见<code>atime</code>参数)。</p><p>-<code>flush</code>：<code>vfat</code>的选项，更频繁的刷新数据，复制对话框或进度条在全部数据都写入后才消失。</p><p>-<code>defaults</code>：使用文件系统的默认挂载参数，例如<code>ext4</code>的默认参数为:<code>rw</code>,<code>suid</code>,<code>dev</code>,<code>exec</code>,<code>auto</code>,<code>nouser</code>,<code>async</code>.</p><p><code>&lt;dump&gt;</code>：<code>dump</code>工具通过它决定何时作备份.<code>dump</code>会检查其内容，并用数字来决定是否对这个文件系统进行备份。 允许的数字是<code>0</code>和<code>1</code>。<code>0</code>表示忽略，<code>1</code>则进行备份。大部分的用户是没有安装<code>dump</code>的，对他们而言<code>&lt;dump&gt;</code>应设为<code>0</code>。</p><p><code>&lt;pass&gt;</code>：<code>fsck</code>读取<code>&lt;pass&gt;</code>的数值来决定需要检查的文件系统的检查顺序。允许的数字是<code>0</code>,<code>1</code>,和<code>2</code>。根目录应当获得最高的优先权<code>1</code>,其它所有需要被检查的设备设置为<code>2</code>.<code>0</code>表示设备不会被<code>fsck</code>所检查。</p><p>文件系统标识</p><p>在<code>/etc/fstab</code>配置文件中你可以以三种不同的方法表示文件系统：内核名称、<code>UUID</code>或者<code>label</code>。使用<code>UUID</code>或是<code>label</code>的好处在于它们与磁盘顺序无关。如果你在<code>BIOS</code>中改变了你的存储设备顺序，或是重新拔插了存储设备，或是因为一些<code>BIOS</code>可能会随机地改变存储设备的顺序，那么用<code>UUID</code>或是<code>label</code>来表示将更有效。参见 持久化块设备名称 。</p><p>要显示分区的基本信息请运行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ lsblk <span class="token parameter variable">-f</span>NAME   FSTYPE LABEL      UUID                                 MOUNTPOINTsda                                                       ├─sda1 ext4   Arch_Linux 978e3e81-8048-4ae1-8a06-aa727458e8ff /├─sda2 ntfs   Windows    6C1093E61093B594                   └─sda3 ext4   Storage    f838b24e-3a66-4d02-86f4-a2e73e454336 /media/Storagesdb                                                         ├─sdb1 ntfs   Games      9E68F00568EFD9D3                   └─sdb2 ext4   Backup     14d50a6c-e083-42f2-b9c4-bc8bae38d274 /media/Backupsdc                                                         └─sdc1 vfat   Camera     47FA-4071                            /media/Camera<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>内核名称</p><p>你可以使用<code>fdisk -l</code>来获得内核名称，前缀是<code>dev</code>.</p><p>标签</p><p>注意: 使用这一方法，每一个标签必须是唯一的.</p><p>要显示所有设备的标签，可以使用<code>lsblk -f</code>命令。在<code>/etc/fstab</code>中使用<code>LABEL=</code>作为设备名的开头:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># &lt;file system>        &lt;dir>         &lt;type>    &lt;options>             &lt;dump> &lt;pass></span>tmpfs                  /tmp          tmpfs     nodev,nosuid   <span class="token number">0</span>      <span class="token number">0</span><span class="token assign-left variable">LABEL</span><span class="token operator">=</span>Arch_Linux       /             ext4      defaults,noatime      <span class="token number">0</span>      <span class="token number">1</span><span class="token assign-left variable">LABEL</span><span class="token operator">=</span>Arch_Swap        none          swap      defaults              <span class="token number">0</span>      <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>UUID</p><p>所有分区和设备都有唯一的 UUID。它们由文件系统生成工具<code>(mkfs.*)</code>在创建文件系统时生成。</p><p><code>lsblk -f</code>命令将显示所有设备的 UUID 值。<code>/etc/fstab</code>中使用<code>UUID=</code>前缀:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># &lt;file system>                           &lt;dir>         &lt;type>    &lt;options>             &lt;dump> &lt;pass></span>tmpfs                                     /tmp          tmpfs     nodev,nosuid          <span class="token number">0</span>      <span class="token number">0</span><span class="token assign-left variable">UUID</span><span class="token operator">=</span>24f28fc6-717e-4bcd-a5f7-32b959024e26 /     ext4              defaults,noatime      <span class="token number">0</span>      <span class="token number">1</span><span class="token assign-left variable">UUID</span><span class="token operator">=</span>03ec5dd3-45c0-4f95-a363-61ff321a09ff /home ext4              defaults,noatime      <span class="token number">0</span>      <span class="token number">2</span><span class="token assign-left variable">UUID</span><span class="token operator">=</span>4209c845-f495-4c43-8a03-5363dd433153 none  swap              defaults              <span class="token number">0</span>      <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自动挂载</p><p>如果<code>/home</code>分区较大，可以让不依赖<code>/home</code>分区的服务先启动。把下面的参数添加到<code>/etc/fstab</code>文件中<code>/home</code>项目的参数部分即可：</p><p><code>noauto,x-systemd.automount</code><br>这样<code>/home</code>分区只有需要访问时才会被挂载。内核会缓存所有的文件操作，直到<code>/home</code>分区准备完成。</p><p>注意: 这样做会使<code>/home</code>的文件系统类型被识别为<code>autofs</code>，造成<code>mlocate</code>查询时忽略该目录。实际加速效果因配置而异，所以请自己权衡是否需要。</p><p>挂载远程文件系统也是同理。如果你仅想在需要的时候才挂载，也可以添加<code>noauto,x-systemd.automount</code>参数。另外，可以设置<code>x-systemd.device-timeout=#</code>参数，设置超时时间，以防止网络资源不能访问的时候浪费时间。</p><p>如果你的加密文件系统需要密钥，则需要添加<code>noauto</code>参数到<code>/etc/crypttab</code>文件中的对应位置。systemd 开机的时候就不会打开这个加密设备，会一直等待到设备被访问时再使用密钥文件挂载。比如在使用加密RAID设备的时候可以节省一定的时间，因为 systemd 不必等到设备可用后才能访问。例如：<code>/etc/crypttab</code><br><code>data /dev/md0 /root/key noauto</code> </p><p>交换分区 UUID</p><p>如果交换分区没有 UUID，可以手动加入。如果使用<code>lsblk -f</code>命令没有列出交换分区的 UUID 就说明发生了这种情况。下面是为交换分区指定 UUID 的步骤：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 确定交换分区：</span><span class="token function">swapon</span> <span class="token parameter variable">-s</span><span class="token comment"># 禁用交换分区：</span>swapoff /dev/sda7<span class="token comment"># 用新 UUID 重新创建交换分区：</span><span class="token function">mkswap</span> <span class="token parameter variable">-U</span> random /dev/sda7<span class="token comment"># 激活交换分区:</span><span class="token function">swapon</span> /dev/sda7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>路径名有空格</p><p>如果挂载的路径中有空格，可以使用<code>\040</code>转义字符来表示空格（以三位八进制数来进行表示）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab<span class="token assign-left variable">UUID</span><span class="token operator">=</span>47FA-4071     /home/username/Camera<span class="token punctuation">\</span>040Pictures   vfat  defaults,noatime      <span class="token number">0</span>  <span class="token number">2</span>/dev/sda7          /media/100<span class="token punctuation">\</span>040GB<span class="token punctuation">\</span>040<span class="token punctuation">(</span>Storage<span class="token punctuation">)</span>       ext4  defaults,noatime,user  <span class="token number">0</span>  <span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token operator">&lt;</span>/nowiki<span class="token operator">></span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>外部设备</p><p>外部设备在插入时挂载，在未插入时忽略。这需要 nofail 选项，可以在启动时若设备不存在直接忽略它而不报错.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab /dev/sdg1    /media/backup    jfs    defaults,nofail    <span class="token number">0</span>  <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>atime</code>参数</p><p>使用<code>noatime</code>,<code>nodiratime</code>或<code>relatime</code>可以提升<code>ext2</code>，<code>ext3</code>及<code>ext4</code>格式磁盘的性能。<code>Linux</code>在默认情况下使用<code>atime</code>选项，每次在磁盘上读取（或写入）数据时都会产生一个记录。这是为服务器设计的，在桌面使用中意义不大。默认的<code>atime</code>选项最大的问题在于即使从页面缓存读取文件(从内存而不是磁盘读取)，也会产生磁盘写操作！</p><p>使用<code>noatime</code>选项阻止了读文件时的写操作。大部分应用程序都能很好工作。只有少数程序如<code>Mutt</code>需要这些信息。<code>Mutt</code>的用户应该使用<code>relatime</code>选项。使用<code>relatime</code>选项后，只有文件被修改时才会产生文件访问时间写操作。<code>nodiratime</code>选项仅对目录禁用了文件访问时间。<code>relatime</code>是比较好的折衷，<code>Mutt</code>等程序还能工作，但是仍然能够通过减少访问时间更新提升系统性能。</p><p>注意:<code>noatime</code>已经包含了<code>nodiratime</code>。不需要同时指定。</p><p><code>tmpfs</code><br><code>tmpfs</code>是一个临时文件系统，驻留于你的交换分区或是内存中（取决于你的使用情况）。使用它可以提高文件访问速度，并能保证重启时会自动清除这些文件。</p><p>经常使用<code>tmpfs</code>的目录有<code>/tmp</code>,<code>/var/lock</code>and<code>/var/run</code>. 不要将之使用于<code>/var/tmp</code>, 因为这一目录中的临时文件在重启过程中需要被保留。使用<code>tmpfs</code> <code>/run</code>目录，<code>/var/run</code>和<code>/var/lock</code>是为了兼容老版本建立的链接。默认<code>/etc/fstab</code>中的的<code>/tmp</code>也是<code>tmpfs</code>.</p><p>默认情况下，<code>tmpfs</code>分区被设置为你总的内存的一半，当然你可以自由设定这一值。注意实际中内存和交换分区的使用情况取决于你的使用情况，而<code>tmpfs</code>分区在其真正使用前是不会占用存储空间的。</p><p>要将<code>/tmp</code>放到<code>tmpfs</code>，将下行加入<code>/etc/fstab</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab<span class="token punctuation">..</span><span class="token punctuation">..</span>.tmpfs /tmp      tmpfs nodev,nosuid                 <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以指定大小，但不要修改<code>mode</code>选项，以保证文件具有正确的访问权限<code>1777</code>。在上例中<code>/tmp</code>将最多使用一半内存，要指定最大空间，使用<code>size</code>挂载选项：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab<span class="token punctuation">..</span><span class="token punctuation">..</span>.tmpfs /tmp      tmpfs nodev,nosuid,size<span class="token operator">=</span>2G          <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这里有一个更高级的例子，展示如何为用户添加<code>tmpfs</code>挂载。这对于网站、<code>mysql</code>临时文件,<code>~/.vim/</code>, 和其他情况很有用。尝试并获得理想的挂载选项来完成目标是很重要的。目标是尽量采用安全的策略来防止滥用。限制大小，同时指定<code>uid</code>和<code>gid</code>加上<code>mode</code>是非常安全的。更多信息.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /etc/fstab</span>tmpfs /www/cache tmpfs rw,size<span class="token operator">=</span>1G,nr_inodes<span class="token operator">=</span>5k,noexec,nodev,nosuid,uid<span class="token operator">=</span><span class="token number">648</span>,gid<span class="token operator">=</span><span class="token number">648</span>,mode<span class="token operator">=</span><span class="token number">1700</span> <span class="token number">0</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>重启后方能生效。注意不要直接执行<code>mount -a</code>命令，因为可能造成无法访问当前目录中的文件（比如你应该保证<code>lockfiles</code>的正常存在）。然而，如果它们都是空的，那么就可以直接执行<code>mount -a</code>而不必重启电脑。</p><p>应用更改后，可以通过<code>findmnt</code>检查是否生效：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ findmnt <span class="token parameter variable">--target</span> /tmpTARGET SOURCE FSTYPE OPTIONS/tmp   tmpfs  tmpfs  rw,nosuid,nodev,relatime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用</p><p>一般需要大量读写操作的程序在使用<code>tmpfs</code>时都会提升性能。有些程序把共享内存放到<code>tmpfs</code>上时性能会大幅提升，例如将 Firefox Profile 文件夹放到内存后，Firefox 性能大幅提升。</p><p><code>Note</code>:<code>tmpfs</code>目录<code>/tmp</code>挂载时需要去掉<code>noexec</code>参数，否则有些编译程序无法执行，此外，<code>tmpfs</code>的默认大小是内存的一般，可能会产生空间不够的问题。</p><p>下面命令可以让<code>makepkg</code>在<code>tmpfs</code>目录进行编辑，也可以在在<code>/etc/makepkg.conf</code>中进行设置:<code>BUILDDIR=/tmp/makepkg makepkg</code> </p><p>普通用户读写<code>FAT32</code><br>为了取得对<code>FAT32</code>分区的写权限，你必须修改<code>/etc/fstab</code>文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab/dev/sdxY    /mnt/some_folder  vfat   user,rw,umask<span class="token operator">=</span>000              <span class="token number">0</span>  <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>users</code>标签的意思是任何用户（甚至非 root 用户）都可以挂载或卸载分区<code>/dev/sdX</code>。”rw”标签则分配读写的使用权。<code>umask</code>是权限掩码命令<code>umask=000</code>指任何人没有特权，且权限为<code>777</code>，即所有人都可以读、写、执行。</p><p>比如你的<code>FAT32</code>分区在<code>/dev/sda9</code>，你想将其挂载到<code>/mnt/fat32</code>，那么你需要输入并运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/fstab/dev/sda9    /mnt/fat32        vfat   user,rw,umask<span class="token operator">=</span><span class="token number">111</span>,dmask<span class="token operator">=</span>000    <span class="token number">0</span>  <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/nfsstat">nfsstat查看状态</a><br><a href="../linux-command-1.16.0/showmount">showmount显示信息</a><br><a href="../linux-command-1.16.0/exportfs">exportfs管理工具</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DHCP</title>
      <link href="/posts/cd116c88.html"/>
      <url>/posts/cd116c88.html</url>
      
        <content type="html"><![CDATA[<h1 id="理解DHCP原理"><a href="#理解DHCP原理" class="headerlink" title="理解DHCP原理"></a>理解DHCP原理</h1><p>DHCP（动态主机配置协议）是由Internet工作任务小组设计开发的，专门用于为TCP/IP网络中的计算机在自动分配TCP/IP参数的协议</p><p>简单来说，DHCP就是一个不需要账号密码登录的、自动给内网机器分配IP地址等信息的协议</p><p>使用DHCP的好处：</p><ol><li><p>减少管理员的工作量</p></li><li><p>避免ip地址冲突</p></li><li><p>当网络更改ip地址段时，不需要再重新配置每个用户的ip地址</p></li><li><p>提高了ip地址的利用率</p></li><li><p>方便客户端的配置</p></li></ol><p>可分配的地址信息主要包括：</p><blockquote><p>网卡的IP地址、子网掩码</p></blockquote><blockquote><p>对应的网络地址、广播地址</p></blockquote><blockquote><p>默认网关地址</p></blockquote><blockquote><p>DNS服务器地址</p></blockquote><p>DHCP服务的端口：UDP的67、68</p><h2 id="DHCP的分配方式："><a href="#DHCP的分配方式：" class="headerlink" title="DHCP的分配方式："></a>DHCP的分配方式：</h2><p>自动分配：分配到一个ip地址后永久使用</p><p>手动分配：由DHCP服务器管理员专门指定ip地址</p><p>动态分配：使用完后释放该ip，供其它客户机使用</p><h2 id="DHCP的租约过程"><a href="#DHCP的租约过程" class="headerlink" title="DHCP的租约过程"></a>DHCP的租约过程</h2><p>客户机从DHCP服务器获得ip地址的过程称为DHCP的租约过程</p><p>租约过程分为四个步骤：</p><ol><li>客户机请求ip（客户机发DHCP Discover）（四步均为广播发送）</li></ol><p>客户端在网络中搜索服务器</p><ol start="2"><li>服务器响应（服务器发DHCP Offer）</li></ol><p>服务器向客户端响应服务</p><ol start="3"><li>客户机选择ip（客户机发DHCP Request）</li></ol><p>客户端向目标服务器发送服务请求</p><ol start="4"><li>服务器确定租约（服务器发DHCP ACK广播包）</li></ol><p>服务器向客户端提供服务</p><hr><ol><li>客户机请求ip地址</li></ol><p>当一个DHCP客户机启动时，客户机还没有ip地址，所以客户机要通过DHCP获取一个合法的地址</p><p>此时，DHCP客户机以广播的方式（原因是DHCP服务器的ip地址对客户机来说是未知的），通过UDP的67端口发送DHCP Discover发现信息来寻找DHCP服务器，广播信息中包含DHCP客户机的MAC地址和计算机名，以便DHCP服务器确定哪个客户机发送的请求</p><p><img src="/medias/img/dhcp/0.png">            </p><ol start="2"><li>服务器响应</li></ol><p>当DHCP服务器接收到来自客户机请求ip地址的信息时，它就在自己的ip地址池中查找是否有合法的ip地址提供给客户机，如果有，DHCP服务器就将此ip地址做上标记，加入到DHCP Offer的消息中，然后DHCP服务器就通过UDP的68端口广播一则包含下列信息的DHCP Offer消息</p><p>DHCP客户机的MAC地址、DHCP服务器提供的合法ip地址、子网掩码、默认网关、租约的期限、DHCP服务器的ip地址</p><p><img src="/medias/img/dhcp/1.png">            </p><ol start="3"><li>客户机选择ip地址</li></ol><p>DHCP客户机从接收到的第一个DHCP Offer消息中提取ip地址，发出ip地址的DHCP服务器将该地址保留，这样该地址就不能再分配给其它客户机</p><p>客户机从第一个DHCP服务器接收DHCP Offer消息并提取了ip地址后，客户机将DHCP Request消息广播到所有的DHCP服务器，表明它接收提供的内容</p><p>DHCP Request消息包括为客户机提供ip配置的服务器的服务标识（服务器ip地址）DHCP服务器查看服务器标识字段，以确定提供的ip地址是否被接收，如果DHCP Offer被拒绝，则DHCP服务取消并保留其ip地址以提供给下一个客户机的租约请求</p><p><img src="/medias/img/dhcp/2.png">            </p><ol start="4"><li>服务器确定租约</li></ol><p>DHCP服务器接收到DHCP Request消息后，以DHCP Ack消息的形式向客户机广播成功确认，该消息包含有ip地址的有效租约和其它可配置的信息</p><p>当客户机收到DHCP Ack消息时，它就配置了ip地址，完成TCP/IP的初始化</p><p><img src="/medias/img/dhcp/3.png"></p><h2 id="重新登录"><a href="#重新登录" class="headerlink" title="重新登录"></a>重新登录</h2><h3 id="可以继续使用："><a href="#可以继续使用：" class="headerlink" title="可以继续使用："></a>可以继续使用：</h3><p>DHCP客户机每次重新登录网络时，不需要再发送DHCP Discover消息，而是直接发送包含前一次所分配的ip地址的DHCP Request请求信息</p><p>当DHCP服务器接收到这一信息后，它会尝试让DHCP客户机继续使用原来的ip地址，并回答一个DHCP Ack确认信息</p><h3 id="不可继续使用："><a href="#不可继续使用：" class="headerlink" title="不可继续使用："></a>不可继续使用：</h3><p>如果此ip地址无法再分配给原来的DHCP客户机使用（如，ip地址已经分配给其它的DHCP客户机使用），DHCP服务器给DHCP客户机回答一个DHCP Noack否认信息</p><p>当原来的DHCP客户机收到此DHCP Noack否认信息后，它就必须重新发送DHCP Discover发现信息来请求新的ip地址</p><h3 id="更新租约："><a href="#更新租约：" class="headerlink" title="更新租约："></a>更新租约：</h3><p>当DHCP服务器向客户机出租的ip地址租期达到50%时，就需要更新地址租约，当租约时间达到87.5%时还没能找到DHCP服务器更新新租约，客户机就需要重新发送DHCP Discover包</p><p>如果客户端发送Discover包后，没有DHCP回应，客户端会启用一个169.254.0.0/16的B类地址作为临时通讯地址</p><h1 id="配置DHCP服务"><a href="#配置DHCP服务" class="headerlink" title="配置DHCP服务"></a>配置DHCP服务</h1><h2 id="DHCP配置与使用"><a href="#DHCP配置与使用" class="headerlink" title="DHCP配置与使用"></a>DHCP配置与使用</h2><p>关闭虚拟机DHCP服务（任务管理器—-&gt;服务）</p><p><img src="/medias/img/dhcp/4.png"></p><h3 id="DHCP服务器的配置"><a href="#DHCP服务器的配置" class="headerlink" title="DHCP服务器的配置"></a>DHCP服务器的配置</h3><p>安装DHCP包：<code>dhcp</code>（yum安装即可）</p><p>主配置文件：</p><p><code>/etc/dhcp/dhcpd.conf</code></p><p><img src="/medias/img/dhcp/5.png">  </p><p>默认此文件中没有配置内容，只有提示，需要到<code>/usr/share/doc/dhcp-版本/dhcpd.conf.sample</code>文件复制 </p><h3 id="执行程序："><a href="#执行程序：" class="headerlink" title="执行程序："></a>执行程序：</h3><p>主程序：<code>/usr/sbin/dhcp/dhcpd</code></p><p>服务脚本：<code>/etc/init.d/dhcpd</code></p><p>指定配置参数：<code>/etc/sysconfig/dhcpd</code>（dhcp启动时要读取的参数）</p><p>中继主程序：<code>dhcrelay</code></p><p>中继服务脚本：<code>/etc/init.d/dhcrelay</code></p><p>DHCP中继配置：<code>/etc/sysconfig/dhcrelay</code></p><p><img src="/medias/img/dhcp/6.png"></p><p>声明：用来描述dhcpd服务器中对网络布局的划分，其中subnet声明用来约束一个网段，host声明用来约束一台特定的主机</p><p>参数：由配置关键字和对应的值组成，总是以 ；结束，一般位于指定的声明范围之内，用来设置所在范围的运行特性（如，默认租约时间、最大租约时间等）</p><p>选项：由option引导，后面跟具体的配置关键字和对应的值，也是以分号 ；结束，用于指定分配给客户机的各种地址参数（如，默认网关地址、子网掩码、DNS服务器地址等）</p><p>确定DHCP服务的全局配置，作用与整个DHCP服务器，为了使配置文件的结果更加清晰，全局配置通常会放在配置文件dhcpd.conf的开头部分，可以是配置参数，也可以是配置选项</p><h3 id="subnet网段声明"><a href="#subnet网段声明" class="headerlink" title="subnet网段声明"></a>subnet网段声明</h3><p>作用于整个子网段（subnet必须要有，且可有多个）</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">subnet 192.168.0.0 netmask 255.255.255.0 &#123;   # 声明网段地址    range 192.168.0.10 192.168.0.100;   # 设置地址池    option subnet-mask 255.255.255.0;   # 设置子网掩码    option routers 192.168.0.1;   # 指定默认网关&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="host主机声明"><a href="#host主机声明" class="headerlink" title="host主机声明"></a>host主机声明</h3><p>作用于单个主机（为个别服务器分配固定的ip地址）</p><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">host test&#123;    hardware ethernet 00:00:00:00:00:00;   # 指定mac地址    fixed-address 192.168.0.45;   # 指定ip地址&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动DHCP服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> dhcpd start<span class="token function">netstat</span> -anpu<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">":67"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>启动失败，查看/var/log/messages中的报错信息，根据提示进行排错。</p><p>注意：在启动dhcpd服务之前，应确定提供DHCP服务器的网络接口具有静态指定的固定ip地址，并至少有一个网络接口的ip地址与DHCP服务器中的一个subnet网段相对应，否则将无法正常启动dhcpd服务</p><h3 id="DHCP客户端获取IP："><a href="#DHCP客户端获取IP：" class="headerlink" title="DHCP客户端获取IP："></a>DHCP客户端获取IP：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> network restartdhclient <span class="token parameter variable">-d</span> eth0   <span class="token comment"># dhclient -r 释放获取的ip地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>/var/lib/dhcpd/dhcpd.leases</code>中记录了服务器的ip地址分配情况</p><h1 id="配置DHCP中继"><a href="#配置DHCP中继" class="headerlink" title="配置DHCP中继"></a>配置DHCP中继</h1><p>在实际应用中可能会遇到一个比较大的物理网络中存在多个ip子网，而每个ip子网的主机都需要DHCP服务器来动态分配ip地址：</p><ol><li><p>在每个子网设置DHCP服务器，将其分别为每个子网分配ip地址，但此方法会增加开销，浪费资源</p></li><li><p>在一个子网内设置DHCP服务器，通过这台DHCP服务器来为所有的子网分配ip地址</p></li></ol><h2 id="DHCP中继配置"><a href="#DHCP中继配置" class="headerlink" title="DHCP中继配置"></a>DHCP中继配置</h2><p>中继主程序：<code>dhcrelay</code></p><p>中继服务脚本：<code>/etc/init.d/dhcrelay</code></p><p>DHCP中继配置文件：<code>/etc/sysconfig/dhcrelay</code></p><ol><li>开启路由转发功能</li></ol><p>永久启用：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/sysctl.conf<span class="token assign-left variable">net.ipv4.ip_forword</span><span class="token operator">=</span><span class="token number">1</span>   <span class="token comment"># 修改</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>sysctl -p</code> 让配置文件生效</p><ol start="2"><li>指定dhcpserver及监听的网卡到配置文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/sysconfig/dhcrelay<span class="token assign-left variable">INTERFACES</span><span class="token operator">=</span><span class="token string">"eth0 eth1 eth2…"</span>   <span class="token comment"># 监听的网卡</span><span class="token assign-left variable">DHCPSERVERS</span><span class="token operator">=</span><span class="token string">"192.168.0.10"</span>   <span class="token comment"># dhcp服务器ip</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>启动中继服务</li></ol><p><code>service dhcrelay restart</code></p><p>添加路由：</p><p>dhcp服务器中添加默认路由指定中继ip</p><p>dhcp客户机中添加默认路由指定中继ip</p><p>示例：</p><p>DHCP服务器端</p><p>关闭SELinux和iptables</p><p><img src="/medias/img/dhcp/7.png"></p><p>安装<code>dhcp</code></p><p>配置<code>/etc/dhcp/dhcpd.conf</code>（subnet 对全局生效）</p><p><img src="/medias/img/dhcp/8.png"></p><p>如果host中有指定ip则subnet对此host不生效</p><p><img src="/medias/img/dhcp/9.png"></p><p>客户端：</p><p><code>dhclient -d eth#</code> 获取动态ip</p><p>带中继：</p><p>HDCP服务器增加</p><p><img src="/medias/img/dhcp/10.png"></p><p>配置中继服务器：</p><p>配置<code>/etc/sysctl.conf</code></p><p><img src="/medias/img/dhcp/11.png"></p><p>生效<code>sysctl -p</code></p><p><img src="/medias/img/dhcp/12.png"></p><p>配置/etc/sysconfig/dhcrelay</p><p><img src="/medias/img/dhcp/13.png"></p><p>启动中继服务：</p><p><code>service dhcrelay restart</code></p><p>在dhcp服务器中添加默认路由下一跳为中继ip（和dhcp服务器同网段）</p><p>在dhcp客户端中添加默认路由下一跳为中继ip（和dhcp服务器分配的网段一致）</p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="../linux-command-1.16.0/dhcpd">DHCP补充</a><br><a href="../linux-command-1.16.0/route">ROUTE</a><br><a href="../linux-command-1.16.0/dhcrelay">dhcrelay</a><br><a href="../linux-command-1.16.0/traceroute">traceroute</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dhcp </tag>
            
            <tag> route </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
